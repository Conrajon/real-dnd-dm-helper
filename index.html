<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real DND DM Helper</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Layering: title bar always on top, then modals, then start screen, then app UI */
            --z-title-bar: 30000;
            --z-below-title: 29999;
            --z-modals: 29500;
            --z-start-screen: 100000;
            --z-toast: 29600;
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --paper: #f4e4bc;
            --paper-dark: #e8dcc5;
            --paper-border: #d4c49c;
            --red: #8b0000;
            --red-bright: #dc143c;
            --red-dark: #5a0000;
            --gold: #b8860b;
            --gold-light: #daa520;
            --ink: #1a1a1a;
            --stat-box: #e8dcc5;
            --success: #2ecc71;
            --danger: #e74c3c;
            --shadow: rgba(0,0,0,0.4);
            --boss-gold: #ffd700;
            --boss-purple: #4a0080;
            --rarity-common: #9d9d9d;
            --rarity-uncommon: #1eff00;
            --rarity-rare: #0070dd;
            --rarity-epic: #a335ee;
            --rarity-legendary: #ff8000;
            --rarity-mythic: #ff3333;
            --spell-slot: #3498db;
            --spell-used: #2c3e50;
        }

        * { box-sizing: border-box; }

        /* Global scrollbar – right-side / viewport scroll – themed for D&D DM Helper */
        html {
            scrollbar-width: thin;
            scrollbar-color: var(--gold) var(--bg-panel);
        }
        html::-webkit-scrollbar {
            width: 12px;
        }
        html::-webkit-scrollbar-track {
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-panel) 100%);
            border-left: 1px solid rgba(184, 134, 11, 0.2);
        }
        html::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--gold-light) 0%, var(--gold) 50%, #966f0a 100%);
            border-radius: 6px;
            border: 2px solid var(--bg-panel);
            min-height: 48px;
        }
        html::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #e8c040 0%, var(--gold-light) 50%, var(--gold) 100%);
        }
        html::-webkit-scrollbar-thumb:active {
            background: var(--gold);
        }
        html::-webkit-scrollbar-corner {
            background: var(--bg-dark);
        }

        body {
            font-family: 'Crimson Text', serif;
            background: 
                radial-gradient(circle at 20% 50%, rgba(139, 0, 0, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(184, 134, 11, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-panel) 100%);
            background-attachment: fixed;
            color: var(--ink);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            transition: background 0.5s ease;
        }

        .dm-reduced-motion *,
        .dm-reduced-motion *::before,
        .dm-reduced-motion *::after { animation: none !important; transition: none !important; }
        .dm-reduced-motion #loading-screen,
        .dm-reduced-motion .loader-rune-wrapper { animation: none !important; }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 25px;
        }

        h1 { 
            color: var(--gold-light); 
            text-align: center; 
            text-transform: uppercase; 
            letter-spacing: 4px; 
            grid-column: 1 / -1; 
            border-bottom: 3px double var(--gold);
            padding-bottom: 15px; 
            font-family: 'Cinzel', serif;
            font-weight: 700;
            text-shadow: 2px 2px 4px var(--shadow);
            margin-bottom: 10px;
            position: relative;
        }

        h1::after { display: none; }

        /* NPC TABS */
        .npc-tabs-container {
            grid-column: 2;
            background: linear-gradient(145deg, var(--paper) 0%, var(--paper-dark) 100%);
            border: 2px solid var(--gold);
            border-radius: 8px;
            padding: 15px;
            display: none;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 15px;
        }

        .npc-tabs-container.active {
            display: block;
        }

        .npc-tabs-header {
            font-family: 'Cinzel', serif;
            color: var(--red);
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .npc-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .npc-tab-group-bracket {
            flex-basis: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .npc-tab-group-header {
            padding: 5px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .npc-tab-group-members {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
        }

        .npc-tab {
            background: white;
            border: 2px solid var(--gold);
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
            min-width: 150px;
        }

        .npc-tab:hover {
            background: var(--gold);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .npc-tab.active {
            background: var(--red);
            border-color: var(--red);
            color: white;
            box-shadow: 0 4px 10px rgba(139, 0, 0, 0.4);
        }

        .npc-tab.boss {
            border-color: var(--boss-gold);
            background: linear-gradient(145deg, #fff8dc 0%, #f0e68c 100%);
        }

        .npc-tab.boss.active {
            background: var(--boss-purple);
            border-color: var(--boss-gold);
            color: var(--boss-gold);
        }

        .tab-name {
            font-weight: 700;
            font-size: 1em;
        }

        .tab-info {
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 3px;
        }

        .controls {
            background: linear-gradient(145deg, var(--paper) 0%, var(--paper-dark) 100%);
            padding: 25px;
            border: 3px double var(--gold);
            border-radius: 8px;
            box-shadow: 0 10px 30px var(--shadow), inset 0 1px 0 rgba(255,255,255,0.3);
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: var(--gold) var(--paper-dark);
        }
        .controls::-webkit-scrollbar { width: 6px; }
        .controls::-webkit-scrollbar-track { background: var(--paper-dark); border-radius: 3px; }
        .controls::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 3px; }
        .controls::-webkit-scrollbar-thumb:hover { background: var(--gold-light); }

        .controls h3 {
            font-family: 'Cinzel', serif;
            color: var(--red);
            margin-top: 0;
            border-bottom: 2px solid var(--gold);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group { margin-bottom: 18px; position: relative; }
        
        label { 
            font-weight: 600; 
            display: block; 
            margin-bottom: 6px; 
            color: var(--red);
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        
        select, input { 
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid var(--gold); 
            background: #fffdf0; 
            font-family: 'Crimson Text', serif;
            font-size: 1em;
            border-radius: 4px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        select:hover, input:hover {
            border-color: var(--red);
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.1);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--red-bright);
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(139, 0, 0, 0.05);
            border-radius: 4px;
            border: 1px solid var(--gold);
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: var(--red-dark);
        }

        .relative-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(139, 0, 0, 0.05);
            border: 2px dashed var(--gold);
            border-radius: 8px;
        }

        .relative-section h4 {
            margin: 0 0 10px 0;
            color: var(--red);
            font-family: 'Cinzel', serif;
            font-size: 0.95em;
        }

        .relative-select {
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-small {
            width: 100%;
            padding: 8px;
            background: var(--gold);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: var(--gold-light);
            transform: translateY(-1px);
        }
        
        button.btn-gen {
            width: 100%; 
            background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%); 
            color: white; 
            padding: 14px; 
            border: none;
            border-radius: 6px;
            cursor: pointer; 
            font-weight: 700; 
            text-transform: uppercase;
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }

        button.btn-gen::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        button.btn-gen:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 0, 0, 0.6);
        }

        button.btn-gen:hover::before { left: 100%; }
        button.btn-gen:active { transform: translateY(0); }

        .saved-list { 
            margin-top: 20px; 
            max-height: 300px; 
            overflow-y: auto; 
            border-top: 2px solid var(--gold); 
            padding-top: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--gold) var(--paper-dark);
        }

        .saved-list::-webkit-scrollbar { width: 8px; }
        .saved-list::-webkit-scrollbar-track { background: var(--paper-dark); border-radius: 4px; }
        .saved-list::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 4px; }
        
        .saved-item { 
            background: rgba(0,0,0,0.05); 
            border: 1px solid var(--gold); 
            padding: 10px; 
            margin-bottom: 8px; 
            border-radius: 4px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 0.95em;
            transition: all 0.2s ease;
        }

        .saved-item:hover {
            background: rgba(139, 0, 0, 0.05);
            transform: translateX(3px);
            border-color: var(--red);
        }

        .saved-item .relative-indicator {
            font-size: 0.75em;
            color: var(--gold);
            display: block;
            margin-top: 2px;
        }
        
        .btn-mini { 
            padding: 4px 8px; 
            font-size: 0.85em; 
            cursor: pointer; 
            margin-left: 4px;
            border: none;
            border-radius: 3px;
            font-family: 'Cinzel', serif;
            transition: all 0.2s;
        }

        .btn-load { background: var(--gold); color: white; }
        .btn-load:hover { background: var(--gold-light); transform: scale(1.05); }
        .btn-delete { background: var(--red); color: white; }
        .btn-delete:hover { background: var(--red-bright); transform: scale(1.05); }
        .btn-relative { background: var(--boss-purple); color: white; font-size: 0.75em; padding: 2px 6px; }
        .btn-relative:hover { background: #6a0080; }

        .display-area { 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
        }

        .empty-state {
            color: var(--gold-light);
            text-align: center;
            padding: 80px 50px;
            opacity: 0.6;
            font-style: italic;
            font-size: 1.2em;
            border: 2px dashed var(--gold);
            border-radius: 10px;
            background: rgba(0,0,0,0.2);
        }

        /* NPC CARD STYLES */
        .npc-card {
            background: linear-gradient(145deg, var(--paper) 0%, var(--paper-dark) 100%);
            border: 1px solid #999;
            box-shadow: 0 10px 30px var(--shadow), 0 1px 3px rgba(0,0,0,0.2);
            padding: 30px;
            position: relative;
            border-radius: 4px;
            animation: cardEnter 0.5s ease-out;
            transition: all 0.3s ease;
            display: none;
        }

        .npc-card.active {
            display: block;
        }

        .npc-card.boss-card {
            border: 3px solid var(--boss-gold);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3), 0 10px 40px rgba(74, 0, 128, 0.4);
            background: linear-gradient(145deg, #fff8dc 0%, #f0e68c 100%);
        }

        .npc-card.boss-card::before {
            background: linear-gradient(90deg, var(--boss-purple) 0%, var(--boss-gold) 50%, var(--boss-purple) 100%);
            height: 8px;
        }

        .npc-card.relative-card {
            border: 3px solid #9b59b6;
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.3);
        }

        .npc-card.relative-card::before {
            background: linear-gradient(90deg, #9b59b6 0%, #e74c3c 50%, #9b59b6 100%);
        }

        .boss-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: linear-gradient(145deg, var(--boss-gold) 0%, #b8860b 100%);
            color: var(--boss-purple);
            padding: 5px 15px;
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 0.9em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: bossPulse 2s infinite;
        }

        .relative-badge {
            position: absolute;
            top: -10px;
            left: 20px;
            background: linear-gradient(145deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 0.85em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 10;
        }

        @keyframes bossPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }

        @keyframes cardEnter {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .npc-card::before {
            content: ""; 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 6px; 
            background: linear-gradient(90deg, var(--red) 0%, var(--red-bright) 50%, var(--red) 100%);
            border-radius: 4px 4px 0 0;
        }

        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            border-bottom: 3px double var(--red); 
            padding-bottom: 15px; 
            margin-bottom: 20px; 
        }

        .boss-card .card-header { border-bottom-color: var(--boss-purple); }
        .relative-card .card-header { border-bottom-color: #9b59b6; }
        
        .npc-name { 
            margin: 0; 
            font-size: 2em; 
            color: var(--red);
            font-family: 'Cinzel', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .boss-card .npc-name {
            color: var(--boss-purple);
            font-size: 2.3em;
            text-shadow: 2px 2px 4px rgba(255, 215, 0, 0.3);
        }

        .relative-card .npc-name {
            color: #9b59b6;
        }
        
        .npc-sub { 
            font-style: italic; 
            color: #555;
            font-size: 1.1em;
            margin-top: 5px;
        }

        .quick-stats {
            text-align: right;
            background: rgba(139, 0, 0, 0.05);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--gold);
        }

        .boss-card .quick-stats { background: rgba(74, 0, 128, 0.1); border-color: var(--boss-gold); }
        .relative-card .quick-stats { background: rgba(155, 89, 182, 0.1); border-color: #9b59b6; }

        .quick-stats div { margin: 3px 0; font-weight: 600; }
        .quick-stats strong { color: var(--red); font-family: 'Cinzel', serif; }
        .boss-card .quick-stats strong { color: var(--boss-purple); }
        .relative-card .quick-stats strong { color: #9b59b6; }

        /* Character Flavor */
        .character-flavor {
            background: rgba(255,255,255,0.5);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .boss-card .character-flavor { background: rgba(255, 215, 0, 0.1); border-color: var(--boss-gold); }
        .relative-card .character-flavor { background: rgba(155, 89, 182, 0.1); border-color: #9b59b6; }

        .flavor-section h4 {
            margin: 0 0 10px 0;
            color: var(--red);
            font-family: 'Cinzel', serif;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .boss-card .flavor-section h4 { color: var(--boss-purple); }
        .relative-card .flavor-section h4 { color: #9b59b6; }

        .flavor-content {
            font-style: italic;
            line-height: 1.6;
            color: #444;
            padding: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            border-left: 3px solid var(--gold);
        }

        .personality-traits {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .trait-tag {
            background: rgba(139, 0, 0, 0.1);
            color: var(--red-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            border: 1px solid rgba(139, 0, 0, 0.2);
        }

        .boss-card .trait-tag { background: rgba(74, 0, 128, 0.2); color: var(--boss-purple); border-color: var(--boss-gold); }
        .relative-card .trait-tag { background: rgba(155, 89, 182, 0.2); color: #9b59b6; border-color: #9b59b6; }

        /* Quest Section */
        .quest-section {
            background: linear-gradient(145deg, rgba(139, 0, 0, 0.05) 0%, rgba(184, 134, 11, 0.05) 100%);
            border: 2px solid var(--gold);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            position: relative;
        }

        .boss-card .quest-section { background: linear-gradient(145deg, rgba(74, 0, 128, 0.1) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--boss-purple); }

        .quest-header {
            font-family: 'Cinzel', serif;
            color: var(--red);
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
        }

        .boss-card .quest-header { color: var(--boss-purple); }

        .quest-type {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .quest-hostile { background: var(--danger); color: white; }
        .quest-side { background: var(--success); color: white; }
        .quest-none { background: #95a5a6; color: white; }
        .quest-boss { background: var(--boss-purple); color: var(--boss-gold); }

        .quest-details { font-size: 0.95em; line-height: 1.6; color: #444; }

        /* Stats Grid with Roll Buttons */
        .stats-row { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            gap: 5px; 
            margin-bottom: 12px; 
            background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%); 
            padding: 3px; 
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .boss-card .stats-row { background: linear-gradient(145deg, var(--boss-purple) 0%, #2d0050 100%); }
        .relative-card .stats-row { background: linear-gradient(145deg, #9b59b6 0%, #6c3483 100%); }
        
        .stat-box { 
            background: var(--stat-box); 
            text-align: center; 
            padding: 4px 3px; 
            border-radius: 5px;
            transition: transform 0.2s;
            border: 1px solid var(--gold);
            position: relative;
        }

        .stat-box:hover {
            transform: translateY(-3px);
            background: #fff;
        }

        .stat-roll-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: var(--gold);
            color: white;
            font-size: 0.7em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .stat-box:hover .stat-roll-btn { opacity: 1; }
        .stat-roll-btn:hover { background: var(--red); transform: scale(1.1); }
        
        .stat-label { 
            font-size: 0.65em; 
            font-weight: 700; 
            text-transform: uppercase;
            color: var(--red);
            letter-spacing: 0.3px;
        }

        .boss-card .stat-label { color: var(--boss-purple); }
        .relative-card .stat-label { color: #9b59b6; }
        
        .stat-val { 
            font-size: 1.1em; 
            font-weight: 700;
            color: var(--ink);
            margin: 1px 0;
        }
        
        .stat-mod { 
            font-size: 0.78em; 
            color: var(--red);
            font-weight: 600;
        }

        .boss-card .stat-mod { color: var(--boss-purple); }
        .relative-card .stat-mod { color: #9b59b6; }

        .stat-roll-result {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--ink);
            color: var(--gold-light);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 100;
            animation: fadeInUp 0.3s;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Info Grid */
        .info-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 25px; 
        }
        
        .section-header { 
            border-bottom: 2px solid var(--gold); 
            color: var(--red); 
            font-weight: 700; 
            margin: 15px 0 10px; 
            text-transform: uppercase; 
            font-size: 0.95em;
            font-family: 'Cinzel', serif;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 5px;
        }

        .boss-card .section-header { color: var(--boss-purple); border-color: var(--boss-gold); }
        .relative-card .section-header { color: #9b59b6; border-color: #9b59b6; }
        
        .action-entry { 
            margin-bottom: 12px; 
            padding: 10px 12px;
            border-left: 4px solid var(--gold); 
            background: rgba(212, 196, 156, 0.2);
            border-radius: 0 4px 4px 0;
            transition: all 0.2s;
        }

        .action-entry:hover {
            background: rgba(212, 196, 156, 0.4);
            transform: translateX(3px);
        }
        
        .action-name { 
            font-weight: 700; 
            color: var(--ink);
            font-family: 'Cinzel', serif;
            font-size: 1.05em;
        }
        
        .action-detail { 
            font-style: italic; 
            font-size: 0.95em; 
            color: #555;
            margin-top: 3px;
        }

        .action-meta { margin-top: 5px; font-size: 0.9em; }
        .action-meta strong { color: var(--red); }
        .boss-card .action-meta strong { color: var(--boss-purple); }
        .relative-card .action-meta strong { color: #9b59b6; }

        .feature-list { list-style: none; padding: 0; margin: 0; }
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px dashed rgba(139, 0, 0, 0.2);
            font-size: 0.95em;
        }
        .feature-list li:last-child { border-bottom: none; }
        .feature-list strong { color: var(--red); font-family: 'Cinzel', serif; }
        .boss-card .feature-list strong { color: var(--boss-purple); }
        .relative-card .feature-list strong { color: #9b59b6; }

        /* Spell Slots System */
        .spell-slots-section {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid var(--spell-slot);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .spell-slots-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-family: 'Cinzel', serif;
            color: var(--spell-slot);
            font-weight: 700;
        }

        .spell-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
        }

        .slot-level {
            text-align: center;
        }

        .slot-level-label {
            font-size: 0.8em;
            font-weight: 700;
            color: #666;
            margin-bottom: 5px;
        }

        .slot-circles {
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .spell-slot {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--spell-slot);
            background: var(--spell-slot);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .spell-slot.used {
            background: transparent;
            border-color: var(--spell-used);
        }

        .spell-slot:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--spell-slot);
        }

        .spell-slot.used:hover {
            box-shadow: 0 0 10px var(--spell-used);
        }

        .spell-slot::after {
            content: attr(data-level);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7em;
            color: white;
            font-weight: 700;
        }

        .spell-slot.used::after { color: var(--spell-used); }

        .spell-grid { 
            display: grid; 
            gap: 8px; 
        }

        /* Enhanced Spell Card */
        .spell-card {
            background: linear-gradient(145deg, rgba(52, 152, 219, 0.15) 0%, rgba(41, 128, 185, 0.1) 100%);
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid var(--spell-slot);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .spell-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .spell-card:hover::before {
            left: 100%;
        }

        .spell-card:hover {
            background: linear-gradient(145deg, rgba(52, 152, 219, 0.25) 0%, rgba(41, 128, 185, 0.2) 100%);
            transform: translateX(5px) translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
            border-left-width: 6px;
        }

        .spell-card.castable {
            border-left-color: var(--success);
            background: linear-gradient(145deg, rgba(46, 204, 113, 0.15) 0%, rgba(39, 174, 96, 0.1) 100%);
        }

        .spell-card.castable:hover {
            background: linear-gradient(145deg, rgba(46, 204, 113, 0.25) 0%, rgba(39, 174, 96, 0.2) 100%);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .spell-card.uncastable {
            opacity: 0.5;
            cursor: not-allowed;
            border-left-color: #95a5a6;
        }

        .spell-card.uncastable:hover {
            transform: none;
            box-shadow: none;
        }

        .spell-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .spell-level-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 700;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.5px;
        }

        .spell-cantrip { background: #95a5a6; color: white; }
        .spell-l1 { background: #1eff00; color: black; }
        .spell-l2 { background: #0070dd; color: white; }
        .spell-l3 { background: #a335ee; color: white; }
        .spell-l4 { background: #ff8000; color: black; }
        .spell-l5 { background: #e74c3c; color: white; }
        .spell-l6 { background: #c0392b; color: white; }
        .spell-l7 { background: #8e44ad; color: white; }
        .spell-l8 { background: #2c3e50; color: white; }
        .spell-l9 { background: #000; color: var(--boss-gold); }

        .spell-card-name {
            font-weight: 700;
            font-family: 'Cinzel', serif;
            font-size: 1.05em;
            color: var(--ink);
        }

        .spell-card-details {
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
        }

        .spell-card-click-hint {
            font-size: 0.75em;
            color: var(--spell-slot);
            font-style: italic;
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .spell-card.castable:hover .spell-card-click-hint {
            opacity: 1;
        }

        /* Spell Modal */
        .spell-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }

        .spell-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .spell-modal-content {
            background: linear-gradient(145deg, var(--paper) 0%, var(--paper-dark) 100%);
            padding: 0;
            border-radius: 12px;
            border: 3px double var(--gold);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s;
            overflow: hidden;
        }

        .spell-modal.active .spell-modal-content {
            transform: scale(1) translateY(0);
        }

        .spell-modal-header {
            background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 3px solid var(--gold);
        }

        .spell-modal-close {
            border: 1px solid rgba(255,255,255,0.45);
            background: rgba(0,0,0,0.22);
            color: #fff8dc;
            border-radius: 6px;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 0.78em;
            font-weight: 700;
            margin-left: auto;
        }

        .spell-modal-close:hover {
            background: rgba(0,0,0,0.34);
        }

        .spell-modal-icon {
            font-size: 2em;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .spell-modal-title {
            flex: 1;
        }

        .spell-modal-title h3 {
            margin: 0;
            font-family: 'Cinzel', serif;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .spell-modal-title .spell-type {
            font-size: 0.85em;
            opacity: 0.9;
            font-style: italic;
        }

        .spell-modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(90vh - 96px);
        }

        .spell-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(139, 0, 0, 0.05);
            border-radius: 8px;
            border: 1px solid var(--gold);
        }

        .spell-detail-item {
            display: flex;
            flex-direction: column;
        }

        .spell-detail-label {
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--red);
            font-family: 'Cinzel', serif;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .spell-detail-value {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--ink);
        }

        .spell-description {
            background: rgba(255,255,255,0.5);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--gold);
            margin-bottom: 20px;
            line-height: 1.6;
            color: #444;
        }

        .spell-level-selector {
            margin-bottom: 20px;
        }

        .spell-level-selector-label {
            font-family: 'Cinzel', serif;
            color: var(--red);
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spell-level-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .spell-level-option {
            padding: 10px 20px;
            border: 2px solid var(--gold);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            flex: 1;
            min-width: 80px;
            text-align: center;
        }

        .spell-level-option:hover {
            background: var(--gold);
            color: white;
            transform: translateY(-2px);
        }

        .spell-level-option.selected {
            background: var(--success);
            border-color: var(--success);
            color: white;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.4);
        }

        .spell-level-option.unavailable {
            opacity: 0.4;
            cursor: not-allowed;
            background: #eee;
        }

        .spell-level-option.unavailable:hover {
            transform: none;
            background: #eee;
            color: inherit;
        }

        .spell-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .spell-modal button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 1em;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-cast {
            background: linear-gradient(145deg, var(--success) 0%, #27ae60 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-cast:hover {
            background: linear-gradient(145deg, #27ae60 0%, #229954 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5);
        }

        .btn-cast:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-cancel {
            background: linear-gradient(145deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .btn-cancel:hover {
            background: linear-gradient(145deg, #7f8c8d 0%, #6c7a7b 100%);
            transform: translateY(-2px);
        }

        /* Loot Section */
        .loot-section {
            background: rgba(255,255,255,0.3);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .loot-list { list-style: none; padding: 0; margin: 0; }

        .loot-item {
            padding: 8px 0;
            border-bottom: 1px dashed rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .loot-item:last-child { border-bottom: none; }

        .rarity-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 5px currentColor;
        }

        .rarity-common { color: var(--rarity-common); }
        .rarity-uncommon { color: var(--rarity-uncommon); }
        .rarity-rare { color: var(--rarity-rare); }
        .rarity-epic { color: var(--rarity-epic); }
        .rarity-legendary { color: var(--rarity-legendary); }
        .rarity-mythic { color: var(--rarity-mythic); text-shadow: 0 0 10px var(--rarity-mythic); }

        .drop-chance {
            font-size: 0.8em;
            color: #666;
            margin-left: auto;
            font-style: italic;
        }
        
        /* DM Notes */
        .dm-notes { 
            background: #fffef0; 
            padding: 15px; 
            border: 2px dashed #ccc; 
            margin-top: 15px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.95em;
            border-radius: 4px;
            position: relative;
        }

        .dm-notes::before {
            content: "DM NOTES - Write your observations here";
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--paper);
            padding: 0 8px;
            font-size: 0.7em;
            color: #999;
            font-weight: bold;
            font-family: 'Cinzel', serif;
        }
        
        .dm-notes textarea { 
            width: 100%; 
            background: transparent; 
            border: none; 
            resize: vertical; 
            font-family: inherit;
            min-height: 100px;
            line-height: 1.5;
        }

        .dm-notes textarea:focus { outline: none; }

        /* Toolbar */
        .card-toolbar { 
            display: flex; 
            gap: 12px; 
            justify-content: flex-end; 
            margin-top: 20px; 
            border-top: 2px solid var(--gold); 
            padding-top: 15px; 
        }

        .boss-card .card-toolbar { border-color: var(--boss-gold); }
        .relative-card .card-toolbar { border-color: #9b59b6; }
        
        .btn-tool { 
            background: #333; 
            color: white; 
            border: none; 
            padding: 10px 16px; 
            cursor: pointer; 
            border-radius: 4px;
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-tool:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn-save { 
            background: linear-gradient(145deg, var(--gold) 0%, #966f0a 100%);
            color: white;
        }
        
        .btn-save:hover { 
            background: linear-gradient(145deg, var(--gold-light) 0%, var(--gold) 100%);
        }

        .btn-combat { 
            background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%);
        }

        .btn-combat:hover {
            background: linear-gradient(145deg, var(--red-bright) 0%, var(--red) 100%);
        }

        .btn-danger {
            background: linear-gradient(145deg, #666 0%, #333 100%);
        }

        .btn-danger:hover {
            background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%);
        }

        /* Combat Mode */
        .combat-active { 
            border: 4px solid var(--red-bright);
            box-shadow: 0 0 20px rgba(220, 20, 60, 0.3);
            animation: pulseCombat 2s infinite;
        }

        .boss-card.combat-active {
            border-color: var(--boss-gold);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: bossPulseCombat 2s infinite;
        }

        .relative-card.combat-active {
            border-color: #9b59b6;
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.5);
        }

        @keyframes pulseCombat {
            0%, 100% { box-shadow: 0 0 20px rgba(220, 20, 60, 0.3); }
            50% { box-shadow: 0 0 30px rgba(220, 20, 60, 0.5); }
        }

        @keyframes bossPulseCombat {
            0%, 100% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 0 50px rgba(255, 215, 0, 0.7); }
        }
        
        .combat-ui { 
            display: none; 
            background: linear-gradient(145deg, #2a2a3e 0%, #1a1a2e 100%);
            color: white; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 8px;
            border: 2px solid var(--red-bright);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        .boss-card .combat-ui {
            border-color: var(--boss-gold);
            background: linear-gradient(145deg, #2d0050 0%, #1a0030 100%);
        }

        .relative-card .combat-ui {
            border-color: #9b59b6;
            background: linear-gradient(145deg, #4a235a 0%, #2e1433 100%);
        }
        
        .combat-active .combat-ui { 
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .combat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .combat-title {
            font-family: 'Cinzel', serif;
            color: var(--red-bright);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .boss-card .combat-title { color: var(--boss-gold); }
        .relative-card .combat-title { color: #e74c3c; }

        .initiative-display {
            background: rgba(0,0,0,0.3);
            padding: 5px 12px;
            border-radius: 4px;
            font-family: 'Cinzel', serif;
            font-size: 1.1em;
        }

        .initiative-display.rolled {
            color: var(--gold-light);
            border: 1px solid var(--gold);
        }
        
        .hp-control { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            justify-content: center;
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        
        .hp-bar-bg { 
            flex-grow: 1; 
            background: rgba(0,0,0,0.4); 
            height: 28px; 
            border-radius: 14px; 
            overflow: hidden; 
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .hp-bar-fill { 
            background: linear-gradient(90deg, var(--success) 0%, #27ae60 100%);
            height: 100%; 
            width: 100%; 
            transition: width 0.4s ease, background-color 0.3s;
            position: relative;
        }

        .hp-bar-fill.low {
            background: linear-gradient(90deg, var(--danger) 0%, #c0392b 100%);
        }

        .hp-bar-fill.critical {
            background: linear-gradient(90deg, #c0392b 0%, #8b0000 100%);
            animation: pulseCritical 1s infinite;
        }

        @keyframes pulseCritical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .hp-text { 
            position: absolute; 
            width: 100%; 
            text-align: center; 
            top: 0;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-family: 'Cinzel', serif;
            font-size: 16px;
            line-height: 28px;
            letter-spacing: 1px;
        }
        
        .hp-btn { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            border: none; 
            font-weight: 700;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .hp-btn:hover { transform: scale(1.1); }
        .hp-btn:active { transform: scale(0.95); }
        
        .hp-minus { 
            background: linear-gradient(145deg, var(--danger) 0%, #c0392b 100%); 
            color: white; 
        }
        
        .hp-plus { 
            background: linear-gradient(145deg, var(--success) 0%, #27ae60 100%); 
            color: white; 
        }

        .condition-tracker {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .condition-input {
            flex: 1;
            min-width: 150px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
        }

        .condition-input::placeholder { color: rgba(255,255,255,0.5); }

        .condition-tag {
            background: rgba(220, 20, 60, 0.3);
            border: 1px solid var(--red-bright);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: tagPop 0.3s ease-out;
        }

        @keyframes tagPop {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .condition-tag button {
            background: none;
            border: none;
            color: var(--red-bright);
            cursor: pointer;
            font-size: 1.1em;
            line-height: 1;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-roll {
            background: linear-gradient(145deg, var(--gold) 0%, #966f0a 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-roll:hover {
            background: linear-gradient(145deg, var(--gold-light) 0%, var(--gold) 100%);
            transform: translateY(-1px);
        }

        /* Combat Spells Section */
        .combat-spells {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .combat-spells .section-header {
            color: white;
            border-color: rgba(255,255,255,0.2);
            margin-top: 0;
        }

        /* ── Spell cards on dark combat background ── */
        .combat-spells .spell-card {
            background: rgba(52,152,219,0.18);
            border: 1px solid rgba(52,152,219,0.4);
            border-left: 4px solid #3498db;
        }
        .combat-spells .spell-card.castable {
            background: rgba(46,204,113,0.18);
            border: 1px solid rgba(46,204,113,0.4);
            border-left: 4px solid #2ecc71;
        }
        .combat-spells .spell-card.uncastable {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 4px solid #555;
        }
        .combat-spells .spell-card-name {
            color: #fff;
            font-size: 1em;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .combat-spells .spell-card-details {
            color: rgba(255,255,255,0.8);
            font-size: 0.85em;
        }
        .combat-spells .spell-card-click-hint {
            color: #7ee8a2;
            opacity: 1;
        }
        .combat-spells .spell-card.castable:hover {
            background: rgba(46,204,113,0.3);
            box-shadow: 0 4px 14px rgba(46,204,113,0.35);
        }
        .combat-spells .spell-card:hover .spell-card-click-hint { opacity: 1; }

        /* Spell slots on dark bg */
        .combat-spells .spell-slots-section {
            background: rgba(52,152,219,0.12);
            border-color: rgba(52,152,219,0.6);
        }
        .combat-spells .spell-slots-header {
            color: #7ec8f7;
        }
        .combat-spells .slot-level-label {
            color: rgba(255,255,255,0.75);
        }
        .combat-spells .spell-slot {
            border-color: #5dade2;
            background: #3498db;
        }
        .combat-spells .spell-slot.used {
            background: transparent;
            border-color: rgba(255,255,255,0.2);
        }
        /* Spell section header */
        .combat-spells .section-header.spells-header {
            color: #7ec8f7;
            border-color: rgba(52,152,219,0.5);
            font-size: 1em;
        }

        /* Relative Info Box */
        .relative-info {
            background: linear-gradient(145deg, rgba(155, 89, 182, 0.15) 0%, rgba(231, 76, 60, 0.1) 100%);
            border: 2px solid #9b59b6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .relative-info::before {
            content: "👥 FAMILY TIES";
            position: absolute;
            top: -10px;
            left: 15px;
            background: var(--paper);
            padding: 0 10px;
            font-family: 'Cinzel', serif;
            font-size: 0.75em;
            color: #9b59b6;
            font-weight: 700;
        }

        .relative-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .relative-block {
            background: rgba(255,255,255,0.5);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #e74c3c;
        }

        .relative-block h5 {
            margin: 0 0 5px 0;
            color: #e74c3c;
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
        }

        .relationship-bar {
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .relationship-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .relationship-positive { background: var(--success); }
        .relationship-negative { background: var(--danger); }
        .relationship-neutral { background: #f39c12; }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container { grid-template-columns: 1fr; }
            .controls { position: static; }
            .info-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(3, 1fr); }
            .character-flavor { grid-template-columns: 1fr; }
            .relative-details { grid-template-columns: 1fr; }
        }

        @media (max-width: 600px) {
            .card-header { flex-direction: column; gap: 15px; }
            .quick-stats { text-align: left; width: 100%; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .spell-slots-grid { grid-template-columns: repeat(4, 1fr); }
            .spell-details-grid { grid-template-columns: 1fr; }
            .npc-tabs { flex-direction: column; }
        }

        /* Toast Notification — above modals so user always sees feedback */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(145deg, var(--gold) 0%, #966f0a 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 6px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            font-family: 'Cinzel', serif;
            font-weight: 600;
            z-index: var(--z-toast);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease-in forwards;
        }

        @keyframes slideOut {
            to { transform: translateX(400px); opacity: 0; }
        }

        .toast.boss-toast {
            background: linear-gradient(145deg, var(--boss-purple) 0%, #2d0050 100%);
            border: 2px solid var(--boss-gold);
            color: var(--boss-gold);
        }

        .toast.relative-toast {
            background: linear-gradient(145deg, #9b59b6 0%, #6c3483 100%);
            border: 2px solid #e74c3c;
            color: white;
        }

        /* Vault Actions */
        .vault-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .vault-actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.85em;
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            transition: all 0.2s;
        }

        .vault-actions button:hover { background: var(--red); }

        /* Batch Combat Controls */
        .batch-controls {
            display: flex;
            gap: 12px;
            background: linear-gradient(145deg, var(--paper) 0%, var(--paper-dark) 100%);
            padding: 15px;
            border: 2px solid var(--gold);
            border-radius: 8px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        .btn-batch {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 0.95em;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-combat-all {
            background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
        }

        .btn-combat-all:hover {
            background: linear-gradient(145deg, var(--red-bright) 0%, var(--red) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 0, 0, 0.5);
        }

        .btn-init-all {
            background: linear-gradient(145deg, var(--gold) 0%, #966f0a 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(184, 134, 11, 0.3);
        }

        .btn-init-all:hover {
            background: linear-gradient(145deg, var(--gold-light) 0%, var(--gold) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(184, 134, 11, 0.5);
        }

        /* Compact Spell Cards */
        .spell-card {
            padding: 8px 12px;
        }

        .spell-card-header {
            gap: 8px;
            margin-bottom: 4px;
        }

        .spell-level-badge {
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            font-size: 0.7em;
        }

        .spell-card-name {
            font-size: 0.95em;
        }

        .spell-card-details {
            font-size: 0.85em;
            line-height: 1.3;
        }

        .spell-card-click-hint {
            font-size: 0.7em;
            margin-top: 2px;
        }

        /* Condition Select */
        .condition-select {
            flex: 1;
            min-width: 150px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
            cursor: pointer;
        }

        .condition-select option {
            background: var(--bg-dark);
            color: white;
        }

        /* Card Toolbar at Top */
        .card-toolbar-top {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gold);
        }

        .boss-card .card-toolbar-top { border-color: var(--boss-gold); }
        .relative-card .card-toolbar-top { border-color: #9b59b6; }

        .btn-top {
            background: #333;
            color: white;
            border: none;
            padding: 8px 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn-top.btn-combat-top {
            background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%);
        }

        .btn-top.btn-save-top {
            background: linear-gradient(145deg, var(--gold) 0%, #966f0a 100%);
        }

        .btn-top.btn-restall-top {
            background: linear-gradient(145deg, #1a6b5a 0%, #144d40 100%);
        }
        .btn-top.btn-restall-top:hover {
            background: linear-gradient(145deg, #27ae60 0%, #1e8449 100%);
        }
        .btn-top.btn-rest-top {
            background: linear-gradient(145deg, #3498db 0%, #2980b9 100%);
        }

        .btn-top.btn-delete-top {
            background: linear-gradient(145deg, #666 0%, #333 100%);
        }

        .btn-top.btn-delete-top:hover {
            background: linear-gradient(145deg, var(--danger) 0%, #c0392b 100%);
        }

        /* Starting Condition Badge */
        .starting-condition {
            display: inline-block;
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 700;
            margin-left: 8px;
        }

        
        /* Enhanced Features CSS */
        .npc-tab.leader {
            background: linear-gradient(145deg, #ff6b00 0%, #ff8c00 100%) !important;
            border: 4px solid #8b0000 !important;
            font-weight: 900 !important;
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.8) !important;
            color: white !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8) !important;
        }
        
        .npc-tab.leader .tab-name {
            color: white !important;
            font-size: 1.1em !important;
        }
        
        .npc-tab.leader .tab-info {
            color: rgba(255,255,255,0.95) !important;
        }
        
        .loot-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .clickable-item {
            position: relative;
            border-radius: 5px;
            padding: 9px 8px;
            margin: 1px 0;
            transition: background 0.18s, transform 0.15s;
        }
        .clickable-item:hover {
            background: linear-gradient(90deg, rgba(184,134,11,0.12), rgba(184,134,11,0.04));
            transform: translateX(4px);
        }
        .clickable-item:active {
            transform: translateX(2px) scale(0.99);
        }
        
        .condition-tag {
            cursor: pointer;
        }
        
        .condition-tag:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(220, 20, 60, 0.5);
        }
        
        .starting-condition {
            cursor: pointer;
        }
        
        .starting-condition:hover {
            opacity: 0.8;
        }

        /* ===== INITIATIVE ORDER PANEL ===== */
        .initiative-order-panel {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid var(--gold);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: none;
        }
        .initiative-order-panel.active { display: block; }
        .initiative-order-header {
            font-family: 'Cinzel', serif;
            color: var(--gold-light);
            font-weight: 700;
            font-size: 0.95em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .initiative-order-list {
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            gap: 6px;
        }
        .initiative-order-entry {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(184,134,11,0.4);
            border-radius: 5px;
            padding: 5px 10px;
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .initiative-order-entry:hover { background: rgba(184,134,11,0.2); border-color: var(--gold); transform: translateY(-1px); }
        .initiative-order-entry.first-place { background: linear-gradient(145deg, rgba(255,215,0,0.25) 0%, rgba(184,134,11,0.15) 100%); border-color: var(--gold-light); color: var(--gold-light); }
        .initiative-order-entry.active-tab { background: rgba(220,20,60,0.25); border-color: var(--red-bright); }
        .init-rank-badge {
            background: var(--gold);
            color: #1a1a2e;
            border-radius: 6px;
            min-width: 24px;
            height: 22px;
            padding: 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: 900;
            flex-shrink: 0;
        }
        .init-rank-badge.first { background: var(--gold-light); }
        .init-rank-badge.pending { background: #555; color: #999; }
        .init-name { font-weight: 700; }
        .init-score { background: var(--gold); color: #1a1a2e; padding: 1px 6px; border-radius: 3px; font-size: 0.8em; font-weight: 900; }
        .init-score.pending { background: #555; color: #aaa; }

        /* ===== ITEM SKILL CARD MODAL ===== */
        .item-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.88);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(6px);
        }
        .item-modal.active { opacity: 1; pointer-events: all; }
        .item-modal-content {
            background: linear-gradient(145deg, var(--paper) 0%, var(--paper-dark) 100%);
            border-radius: 12px;
            border: 3px double var(--gold);
            max-width: 480px;
            width: 92%;
            box-shadow: 0 25px 70px rgba(0,0,0,0.6);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s;
            overflow: hidden;
        }
        .item-modal.active .item-modal-content { transform: scale(1) translateY(0); }
        .item-modal-rarity-bar { height: 5px; width: 100%; }
        .item-modal-header {
            padding: 18px 22px;
            border-bottom: 3px solid var(--gold);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .item-modal-icon { font-size: 2em; }
        .item-modal-title-wrap { flex: 1; }
        .item-modal-title { font-family: 'Cinzel', serif; font-size: 1.4em; font-weight: 700; margin: 0 0 4px 0; }
        .item-modal-sub { font-size: 0.88em; opacity: 0.7; font-style: italic; }
        .item-modal-body { padding: 20px 22px; }
        .item-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
            background: rgba(139,0,0,0.06);
            padding: 14px;
            border-radius: 8px;
            border: 1px solid var(--gold);
        }
        .item-stat-item { display: flex; flex-direction: column; }
        .item-stat-label { font-size: 0.72em; font-weight: 700; text-transform: uppercase; color: var(--red); font-family: 'Cinzel', serif; letter-spacing: 0.5px; margin-bottom: 3px; }
        .item-stat-value { font-size: 1.05em; font-weight: 700; color: var(--ink); }
        .item-description-box { background: rgba(255,255,255,0.5); padding: 14px; border-radius: 8px; border-left: 3px solid var(--gold); margin-bottom: 16px; line-height: 1.6; color: #444; font-size: 0.95em; }
        .item-rarity-badge { display: inline-block; padding: 3px 12px; border-radius: 12px; font-size: 0.8em; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .item-modal-close { padding: 10px 28px; border: none; border-radius: 6px; cursor: pointer; font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.95em; letter-spacing: 0.5px; background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%); color: white; transition: all 0.2s; width: 100%; margin-top: 4px; }
        .item-modal-close:hover { background: linear-gradient(145deg, var(--red-bright) 0%, var(--red) 100%); transform: translateY(-1px); }

        /* ===== RACE FEATS ===== */
        .race-feats-section { background: linear-gradient(145deg, rgba(184,134,11,0.08) 0%, rgba(139,0,0,0.05) 100%); border: 2px solid var(--gold); border-radius: 8px; padding: 14px; margin-bottom: 18px; }
        .race-feat-list { list-style: none; padding: 0; margin: 0; }
        .race-feat-list li { padding: 7px 0; border-bottom: 1px dashed rgba(139,0,0,0.15); font-size: 0.92em; line-height: 1.5; }
        .race-feat-list li:last-child { border-bottom: none; }
        .race-feat-list strong { color: var(--red); font-family: 'Cinzel', serif; }

        /* ===== ENHANCED APPEARANCE CHIPS ===== */
        .appearance-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .appearance-chip { background: rgba(184,134,11,0.1); border: 1px solid rgba(184,134,11,0.3); border-radius: 5px; padding: 5px 10px; font-size: 0.85em; line-height: 1.4; }
        .appearance-chip-label { font-size: 0.7em; font-weight: 700; text-transform: uppercase; color: var(--red); font-family: 'Cinzel', serif; letter-spacing: 0.4px; margin-bottom: 2px; }

        /* ===== COMBAT NAME HEADER ===== */
        .combat-npc-name-header { text-align: center; padding: 10px 15px 8px; border-bottom: 2px solid rgba(220,20,60,0.3); margin-bottom: 12px; }
        .combat-npc-name-text { font-family: 'Cinzel', serif; font-size: 1.35em; font-weight: 700; color: var(--gold-light); text-shadow: 0 0 15px rgba(218,165,32,0.4); letter-spacing: 1px; }
        .combat-npc-class-text { font-size: 0.82em; color: rgba(255,255,255,0.6); margin-top: 3px; font-style: italic; }

        /* ===== COMBAT WEAPON QUICK-ROLL ===== */
        .combat-weapons-section { margin-bottom: 14px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; border: 1px solid rgba(184,134,11,0.3); }
        .combat-weapon-entry { background: rgba(255,255,255,0.04); border: 1px solid rgba(184,134,11,0.25); border-radius: 5px; padding: 9px; margin-bottom: 6px; }
        .combat-weapon-entry:last-child { margin-bottom: 0; }
        .combat-weapon-name { font-family: 'Cinzel', serif; font-weight: 700; color: var(--gold-light); font-size: 0.9em; margin-bottom: 3px; }
        .combat-weapon-stats { font-size: 0.8em; color: rgba(255,255,255,0.65); margin-bottom: 7px; }
        .combat-weapon-btns { display: flex; gap: 6px; }
        .btn-combat-attack { flex: 1; padding: 6px 8px; background: linear-gradient(145deg, var(--gold) 0%, #966f0a 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700; transition: all 0.2s; }
        .btn-combat-attack:hover { background: linear-gradient(145deg, var(--gold-light) 0%, var(--gold) 100%); transform: translateY(-1px); }
        .btn-combat-damage { flex: 1; padding: 6px 8px; background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700; transition: all 0.2s; }
        .btn-combat-damage:hover { background: linear-gradient(145deg, var(--red-bright) 0%, var(--red) 100%); transform: translateY(-1px); }

        /* ===== D&D SKILLS PANEL ===== */
        .skills-panel {
            background: rgba(255,255,255,0.35);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 12px 14px;
            margin-top: 15px;
        }
        .skills-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px 10px;
        }
        .skill-row {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 0;
            font-size: 0.88em;
            border-bottom: 1px dashed rgba(0,0,0,0.07);
            cursor: default;
        }
        .skill-row:last-child { border-bottom: none; }
        .skill-rollable {
            cursor: pointer;
            border-radius: 4px;
            padding: 3px 4px;
            transition: background 0.15s, transform 0.1s;
        }
        .skill-rollable:hover {
            background: rgba(139,0,0,0.07);
            transform: translateX(2px);
        }
        .skill-rollable:active { transform: scale(0.97); }
        .skill-roll-icon {
            font-size: 0.8em;
            opacity: 0;
            transition: opacity 0.15s;
            margin-left: 2px;
        }
        .skill-rollable:hover .skill-roll-icon { opacity: 1; }
        .skill-proficiency {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .skill-proficiency.proficient {
            background: var(--red);
            border-color: var(--red);
        }
        .skill-proficiency.expertise {
            background: var(--gold);
            border-color: var(--gold);
        }
        .skill-proficiency.half {
            background: rgba(184,134,11,0.4);
            border-color: var(--gold);
        }
        .skill-proficiency.proficient::after { content: "★"; color: white; font-size: 8px; }
        .skill-proficiency.expertise::after { content: "★★"; color: white; font-size: 6px; letter-spacing: -1px; }
        .skill-modifier {
            font-weight: 700;
            min-width: 26px;
            text-align: right;
            font-family: 'Cinzel', serif;
            font-size: 0.95em;
        }
        .skill-modifier.proficient { color: var(--red); }
        .skill-modifier.expertise { color: var(--gold); }
        .skill-name {
            color: var(--ink);
            flex: 1;
        }
        .skill-name.proficient { color: var(--red-dark); font-weight: 600; }
        .skill-name.expertise { color: #966f0a; font-weight: 700; }
        .skill-stat-label {
            font-size: 0.72em;
            color: #888;
            font-style: italic;
            margin-left: auto;
        }

        /* ===== GENERATE MODE DIALOG ===== */
        .gen-mode-dialog {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s;
            backdrop-filter: blur(4px);
        }
        .gen-mode-dialog.active { opacity: 1; pointer-events: all; }
        .gen-mode-box {
            background: linear-gradient(145deg, var(--paper) 0%, var(--paper-dark) 100%);
            border: 3px double var(--gold);
            border-radius: 12px;
            padding: 30px 35px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.25s;
            text-align: center;
        }
        .gen-mode-dialog.active .gen-mode-box { transform: scale(1) translateY(0); }
        .gen-mode-title {
            font-family: 'Cinzel', serif;
            color: var(--red);
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .gen-mode-subtitle {
            color: #555;
            font-style: italic;
            margin-bottom: 22px;
            font-size: 0.95em;
        }
        .gen-mode-btns {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .gen-mode-btn {
            padding: 13px 20px;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 0.95em;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .gen-mode-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .gen-mode-replace { background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%); color: white; }
        .gen-mode-add { background: linear-gradient(145deg, var(--gold) 0%, #966f0a 100%); color: white; }
        .gen-mode-cancel { background: linear-gradient(145deg, #666 0%, #444 100%); color: white; }

        /* ===== ENHANCED VAULT ITEMS ===== */
        .vault-group-item {
            background: linear-gradient(145deg, rgba(184,134,11,0.1) 0%, rgba(139,0,0,0.05) 100%);
            border: 2px solid var(--gold);
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .vault-group-item:hover { border-color: var(--red); background: rgba(139,0,0,0.05); }
        .vault-group-name {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: var(--red);
            font-size: 0.95em;
        }
        .vault-group-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }
        .vault-group-btns {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        /* ===== ENHANCED CARD TOOLBAR ===== */
        .btn-top.btn-saveall-top {
            background: linear-gradient(145deg, #27ae60 0%, #1e8449 100%);
        }
        .btn-top.btn-deleteall-top {
            background: linear-gradient(145deg, #2c3e50 0%, #1a252f 100%);
        }
        .btn-top.btn-deleteall-top:hover {
            background: linear-gradient(145deg, var(--danger) 0%, #c0392b 100%);
        }
        /* ===== NPC PORTRAIT ===== */
        .portrait-section {
            margin-top: 14px;
            border-top: 1px dashed var(--gold);
            padding-top: 14px;
        }
        .portrait-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .portrait-canvas {
            width: 100%;
            max-width: 380px;
            border-radius: 6px;
            display: block;
        }

        /* AI Portrait Styles */
        .portrait-ai-img {
            width: 100%;
            max-width: 380px;
            border-radius: 8px;
            display: block;
            border: 3px solid var(--gold);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4), 0 0 30px rgba(184,134,11,0.2);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .portrait-ai-img:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 40px rgba(184,134,11,0.35);
        }

        .ai-portrait-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 30px 20px;
            background: linear-gradient(145deg, rgba(74,0,128,0.12), rgba(123,0,200,0.06));
            border: 2px dashed #7b00c8;
            border-radius: 8px;
            width: 100%;
            max-width: 380px;
            color: #7b00c8;
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
        }
        .ai-spinner {
            width: 36px;
            height: 36px;
            border: 4px solid rgba(123,0,200,0.2);
            border-top: 4px solid #7b00c8;
            border-radius: 50%;
            animation: aiSpin 0.9s linear infinite;
        }
        @keyframes aiSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ai-portrait-error {
            padding: 12px 16px;
            background: rgba(139,0,0,0.1);
            border: 1px solid var(--red);
            border-radius: 6px;
            color: var(--red);
            font-size: 0.82em;
            text-align: center;
            font-family: 'Cinzel', serif;
            max-width: 380px;
            width: 100%;
        }
        .portrait-mode-label {
            font-size: 0.72em;
            opacity: 0.65;
            font-family: 'Cinzel', serif;
            text-align: center;
            margin-top: 2px;
            color: var(--gold);
        }

        /* ============================================================
           LOADING SCREEN
           ============================================================ */
        #loading-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at 50% 40%,
                #1a0a2e 0%, #0d0d1a 60%, #000005 100%);
            z-index: 999999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0;
            transition: opacity 0.85s cubic-bezier(0.22, 1, 0.36, 1), transform 0.85s cubic-bezier(0.22, 1, 0.36, 1);
            overflow: hidden;
            opacity: 1;
            animation: loaderScreenEnter 0.5s cubic-bezier(0.22, 1, 0.36, 1) both;
        }
        @keyframes loaderScreenEnter {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #loading-screen.fade-out {
            opacity: 0;
            transform: scale(1.02);
            pointer-events: none;
        }

        /* Particle canvas behind everything */
        #loading-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        /* Animated rune circle */
        .loader-rune-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 30px;
            animation: loaderRuneEnter 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.1s both;
        }
        @keyframes loaderRuneEnter {
            from { opacity: 0; transform: scale(0.92); }
            to { opacity: 1; transform: scale(1); }
        }
        .loader-rune-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 2px solid transparent;
            animation: runeRotate 3s linear infinite;
            will-change: transform;
        }
        .loader-rune-ring.ring1 {
            border-top-color: #daa520;
            border-right-color: rgba(218,165,32,0.4);
            animation-duration: 2.8s;
        }
        .loader-rune-ring.ring2 {
            inset: 14px;
            border-bottom-color: #8b0000;
            border-left-color: rgba(139,0,0,0.4);
            animation-duration: 3.5s;
            animation-direction: reverse;
        }
        .loader-rune-ring.ring3 {
            inset: 28px;
            border-top-color: rgba(218,165,32,0.6);
            border-right-color: rgba(139,0,0,0.6);
            animation-duration: 4.2s;
        }
        .loader-rune-center {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loader-d20 {
            font-size: 72px;
            animation: d20Pulse 2s ease-in-out infinite;
            filter: drop-shadow(0 0 18px #daa520) drop-shadow(0 0 40px rgba(139,0,0,0.5));
            line-height: 1;
            will-change: transform;
        }
        /* Orbiting dots */
        .loader-orbit {
            position: absolute;
            inset: 0;
            animation: runeRotate 4s linear infinite;
            will-change: transform;
        }
        .loader-orbit-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #daa520;
            box-shadow: 0 0 10px #daa520;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
        }
        .loader-orbit.b {
            animation-direction: reverse;
            animation-duration: 6s;
        }
        .loader-orbit.b .loader-orbit-dot {
            background: #8b0000;
            box-shadow: 0 0 10px #dc143c;
            top: auto;
            bottom: 6px;
        }

        @keyframes runeRotate {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }
        @keyframes d20Pulse {
            0%, 100% { transform: scale(1);    filter: drop-shadow(0 0 18px #daa520) drop-shadow(0 0 40px rgba(139,0,0,0.5)); }
            50%       { transform: scale(1.08); filter: drop-shadow(0 0 30px #ffd700) drop-shadow(0 0 60px rgba(220,20,60,0.7)); }
        }

        /* Loading title */
        .loader-title {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.8em, 4vw, 2.8em);
            font-weight: 700;
            letter-spacing: 8px;
            text-transform: uppercase;
            color: #daa520;
            text-shadow: 0 0 30px rgba(218,165,32,0.6), 0 0 60px rgba(218,165,32,0.2);
            margin-bottom: 6px;
            animation: titleGlow 3s ease-in-out infinite;
        }
        .loader-subtitle {
            font-family: 'Crimson Text', serif;
            font-style: italic;
            color: rgba(218,165,32,0.6);
            font-size: 1.1em;
            letter-spacing: 4px;
            margin-bottom: 40px;
        }
        @keyframes titleGlow {
            0%,100% { text-shadow: 0 0 30px rgba(218,165,32,0.6), 0 0 60px rgba(218,165,32,0.2); }
            50%      { text-shadow: 0 0 50px rgba(218,165,32,0.9), 0 0 100px rgba(139,0,0,0.4); }
        }

        /* Progress bar */
        .loader-bar-wrap {
            width: min(380px, 70vw);
            height: 4px;
            background: rgba(218,165,32,0.15);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 14px;
            border: 1px solid rgba(218,165,32,0.2);
        }
        .loader-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #8b0000, #daa520, #ffd700);
            border-radius: 2px;
            transition: width 0.35s cubic-bezier(0.22, 1, 0.36, 1);
            box-shadow: 0 0 10px #daa520;
        }
        .loader-status {
            font-family: 'Cinzel', serif;
            font-size: 0.78em;
            color: rgba(218,165,32,0.55);
            letter-spacing: 3px;
            text-transform: uppercase;
            min-height: 20px;
            transition: opacity 0.3s;
            margin-bottom: 50px;
        }
        .loader-status .loader-dots {
            display: inline-block;
            min-width: 1.2em;
            animation: loaderDotsPulse 0.8s ease-in-out infinite;
        }
        @keyframes loaderDotsPulse {
            0%, 100% { opacity: 0.5; }
            50%      { opacity: 1; }
        }

        /* Decorative divider */
        .loader-divider {
            width: min(340px, 65vw);
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(218,165,32,0.5), rgba(139,0,0,0.5), rgba(218,165,32,0.5), transparent);
            margin: 20px 0 18px;
        }

        /* Made by Conrajon */
        .loader-credit {
            font-family: 'Cinzel', serif;
            font-size: 0.82em;
            color: rgba(218,165,32,0.4);
            letter-spacing: 3px;
            text-transform: uppercase;
            position: absolute;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            transition: color 0.3s;
        }
        .loader-credit:hover { color: rgba(218,165,32,0.8); }
        .loader-credit span { color: rgba(220,20,60,0.6); }

        /* ============================================================
           BACKGROUND PARTICLE CANVAS (main app)
           ============================================================ */
        #bg-particles {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            opacity: 0.55;
        }
        .main-container { position: relative; z-index: 1; }

        /* ============================================================
           ENHANCED BUTTON RIPPLE
           ============================================================ */
        .btn-ripple-overlay {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: scale(0);
            animation: btnRipple 0.6s linear;
            pointer-events: none;
        }
        @keyframes btnRipple {
            to { transform: scale(4); opacity: 0; }
        }

        /* ============================================================
           ENHANCED CARD ENTRANCE
           ============================================================ */
        @keyframes cardEnterPro {
            0%   { opacity: 0; transform: translateY(30px) scale(0.97); filter: blur(4px); }
            60%  { filter: blur(0); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .npc-card {
            animation: cardEnterPro 0.55s cubic-bezier(0.22, 1, 0.36, 1) both;
        }

        /* Stat box number roll animation */
        @keyframes statRollIn {
            from { transform: translateY(-8px); opacity: 0; }
            to   { transform: translateY(0);    opacity: 1; }
        }
        .stat-val { animation: statRollIn 0.4s ease both; }

        /* Boss card shimmer */
        .npc-card.boss-card::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 4px;
            background: linear-gradient(135deg,
                transparent 0%, rgba(255,215,0,0.04) 50%, transparent 100%);
            animation: bossShimmer 4s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes bossShimmer {
            0%,100% { opacity: 0; }
            50%      { opacity: 1; }
        }

        /* Portrait glow on hover */
        .portrait-canvas, .portrait-ai-img {
            transition: box-shadow 0.35s ease, transform 0.35s ease;
        }
        .portrait-canvas:hover, .portrait-ai-img:hover {
            box-shadow: 0 0 28px rgba(218,165,32,0.55), 0 8px 30px rgba(0,0,0,0.5);
            transform: scale(1.015);
        }

        /* Smooth scroll reveal for sections */
        .section-reveal {
            animation: sectionReveal 0.4s ease both;
        }
        @keyframes sectionReveal {
            from { opacity: 0; transform: translateX(-10px); }
            to   { opacity: 1; transform: translateX(0); }
        }

        /* Toast enhanced */
        .toast {
            animation: toastIn 0.4s cubic-bezier(0.22,1,0.36,1) both !important;
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* ============================================================
           D&D ADVENTURE BOOK STYLES
           ============================================================ */
        .dnd-book { background: linear-gradient(180deg, #1a0e0a 0%, #0f0a08 100%); border: 2px solid #8b4513; border-radius: 4px; overflow: hidden; font-family: 'Crimson Text', 'Palatino', Georgia, serif; color: #f4e4c1; }
        .dnd-book-cover { background: linear-gradient(160deg, #2a0a0a 0%, #4a1a1a 40%, #2a0a0a 100%); border-bottom: 3px solid #8b4513; padding: 32px 24px 24px; text-align: center; position: relative; }
        .dnd-book-cover::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30Z' fill='none' stroke='%238b451320' stroke-width='1'/%3E%3C/svg%3E") repeat; pointer-events: none; }
        .dnd-book-title { font-family: 'Cinzel', serif; font-size: 1.6em; font-weight: 900; color: #daa520; letter-spacing: 3px; text-shadow: 0 2px 8px rgba(0,0,0,0.8), 0 0 30px rgba(218,165,32,0.15); margin-bottom: 8px; position: relative; }
        .dnd-book-subtitle { font-size: 0.85em; color: #c4a882; letter-spacing: 2px; font-family: 'Cinzel', serif; font-weight: 400; margin-bottom: 12px; position: relative; }
        .dnd-book-tags { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; position: relative; }
        .dnd-book-tag { background: rgba(139,69,19,0.3); color: #daa520; padding: 3px 14px; border-radius: 2px; font-size: 0.7em; font-family: 'Cinzel', serif; font-weight: 700; border: 1px solid rgba(218,165,32,0.4); letter-spacing: 1px; text-transform: uppercase; }
        .dnd-book-divider { height: 3px; background: linear-gradient(90deg, transparent, #8b4513, #daa520, #8b4513, transparent); margin: 0; border: none; }
        .dnd-book-body { padding: 20px 24px; }
        .dnd-chapter { margin-bottom: 24px; }
        .dnd-chapter-header { font-family: 'Cinzel', serif; color: #8b0000; font-size: 0.68em; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 2px; }
        .dnd-chapter-title { font-family: 'Cinzel', serif; color: #daa520; font-size: 1.15em; font-weight: 900; letter-spacing: 1.5px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid rgba(139,69,19,0.5); }
        .dnd-chapter-text { font-size: 0.95em; line-height: 1.85; color: #e8d8c0; }
        .dnd-read-aloud { background: linear-gradient(135deg, #2a1f14 0%, #1f1710 100%); border-left: 4px solid #daa520; border-right: 1px solid rgba(139,69,19,0.3); border-top: 1px solid rgba(139,69,19,0.3); border-bottom: 1px solid rgba(139,69,19,0.3); padding: 16px 18px; margin: 12px 0; border-radius: 0 4px 4px 0; position: relative; }
        .dnd-read-aloud::before { content: 'READ ALOUD'; position: absolute; top: -9px; left: 12px; background: #1f1710; color: #daa520; font-family: 'Cinzel', serif; font-size: 0.55em; font-weight: 700; letter-spacing: 2px; padding: 0 8px; }
        .dnd-read-aloud p { font-style: italic; color: #f0e0c8; font-size: 1.02em; line-height: 1.9; margin: 0; }
        .dnd-sidebar { background: rgba(40,30,20,0.6); border: 1px solid rgba(139,69,19,0.5); border-radius: 4px; padding: 12px 14px; margin: 12px 0; }
        .dnd-sidebar-title { font-family: 'Cinzel', serif; font-size: 0.65em; color: #daa520; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; font-weight: 700; }
        .dnd-sidebar p, .dnd-sidebar div { font-size: 0.9em; line-height: 1.7; color: #d4c4a8; }
        .dnd-npc-block { background: rgba(30,20,15,0.7); border: 1px solid rgba(139,69,19,0.4); border-radius: 4px; padding: 12px 14px; margin-bottom: 10px; }
        .dnd-npc-name { font-family: 'Cinzel', serif; font-size: 0.85em; font-weight: 700; color: #daa520; margin-bottom: 4px; }
        .dnd-npc-desc { font-size: 0.9em; line-height: 1.7; color: #d4c4a8; font-style: italic; }
        .dnd-section-rule { height: 1px; background: linear-gradient(90deg, transparent, rgba(139,69,19,0.5), transparent); border: none; margin: 16px 0; }
        .dnd-appendix-header { font-family: 'Cinzel', serif; color: #8b0000; font-size: 0.6em; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 2px; }
        .dnd-appendix-title { font-family: 'Cinzel', serif; color: #daa520; font-size: 1em; font-weight: 900; letter-spacing: 1.5px; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid rgba(139,69,19,0.5); }
        .dnd-encounter-box { background: rgba(80,0,0,0.2); border: 1px solid rgba(139,0,0,0.4); border-radius: 4px; padding: 12px 14px; margin: 10px 0; }
        .dnd-encounter-title { font-family: 'Cinzel', serif; font-size: 0.7em; color: #ff6060; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 6px; font-weight: 700; }
        .dnd-treasure-box { background: rgba(100,80,0,0.15); border: 1px solid rgba(218,165,32,0.4); border-radius: 4px; padding: 10px 14px; margin: 8px 0; }
        .dnd-treasure-title { font-family: 'Cinzel', serif; font-size: 0.65em; color: #daa520; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 4px; font-weight: 700; }

        /* ============================================================
           FOOTER CREDIT (app bottom)
           ============================================================ */

        /* DM Assistant popout – pops up from bottom where the button is; size persisted */
        #dmAIPopout {
            position: fixed;
            left: 12px;
            bottom: 52px;
            width: var(--dm-ai-width, 360px);
            height: var(--dm-ai-height, 420px);
            min-width: 280px;
            max-width: min(520px, 95vw);
            min-height: 280px;
            max-height: 85vh;
            z-index: 5010;
            transition: transform 0.3s ease;
            display: flex;
            align-items: stretch;
        }
        #dmAIPopout.dm-ai-collapsed {
            transform: translateY(100%);
            pointer-events: none;
            display: none !important;
            visibility: hidden;
        }
        #dmAIPopout.dm-ai-open { transform: translateY(0); pointer-events: auto; display: flex !important; visibility: visible; }
        #dmAIPopout .dm-ai-resize-handle {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            z-index: 2;
            background: linear-gradient(135deg, transparent 0%, transparent 45%, rgba(160,100,255,0.4) 45%, rgba(160,100,255,0.4) 100%);
            border-radius: 0 0 6px 0;
        }
        #dmAIPopout .dm-ai-resize-handle:hover { background: linear-gradient(135deg, transparent 0%, transparent 45%, rgba(160,100,255,0.7) 45%, rgba(160,100,255,0.7) 100%); }
        #dmAIChatMessages {
            scrollbar-width: thin;
            scrollbar-color: var(--gold) var(--paper-dark);
        }
        #dmAIChatMessages::-webkit-scrollbar { width: 6px; }
        #dmAIChatMessages::-webkit-scrollbar-track { background: var(--paper-dark); border-radius: 3px; }
        #dmAIChatMessages::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 3px; }
        #dmAIChatMessages::-webkit-scrollbar-thumb:hover { background: var(--gold-light); }

        /* Sound Board popout (LEFT side, just below Session Notes) */
        #soundBoardPopout {
            position: fixed;
            left: 0;
            right: auto;
            top: 220px;
            z-index: 5001;
            transition: transform 0.3s ease;
        }
        #soundBoardPopout.sb-collapsed { transform: translateX(calc(-100% + 36px)); pointer-events: none; }
        #soundBoardPopout.sb-collapsed .sb-tab { pointer-events: auto; }
        #soundBoardPopout.sb-open { transform: translateX(0); pointer-events: auto; }
        .sb-tab {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            background: linear-gradient(180deg,#2d5a27,#4a8c42);
            color: #d0ffc8;
            padding: 12px 8px;
            cursor: pointer;
            font-family: 'Cinzel',serif;
            font-size: 0.72em;
            font-weight: 700;
            letter-spacing: 1px;
            border-radius: 0 8px 8px 0;
            min-height: 100px;
            user-select: none;
            border: 1px solid rgba(80,160,80,0.6);
            border-left: none;
            box-shadow: 4px 0 16px rgba(0,0,0,0.6);
        }
        /* Session Notes popout positioning (LEFT side, top area near header/title) */
        #sessionNotesPopout {
            position: fixed;
            left: 0;
            right: auto;
            top: 60px;
            z-index: 5002;
            transition: transform 0.3s ease;
        }
        /* Collapsed: leave only a narrow tab visible on the LEFT edge (mirror of Spell List) */
        #sessionNotesPopout.sn-collapsed {
            transform: translateX(calc(-100% + 36px));
            pointer-events: none;
        }
        #sessionNotesPopout.sn-collapsed .sn-tab {
            pointer-events: auto;
        }
        #sessionNotesPopout.sn-open {
            transform: translateX(0);
            pointer-events: auto;
        }

        /* Session Notes vertical tab styling (similar to Spell List, but purple and on left) */
        .sn-tab {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            background: linear-gradient(180deg,#4a2060,#7a30a0);
            color: #e8d8ff;
            padding: 12px 8px;
            cursor: pointer;
            font-family: 'Cinzel',serif;
            font-size: 0.72em;
            font-weight: 700;
            letter-spacing: 1px;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            min-height: 130px;
            user-select: none;
            border: 1px solid rgba(160,80,255,0.6);
            border-left: none;
            box-shadow: 4px 0 16px rgba(0,0,0,0.7);
        }

        /* ══ CAMPAIGN START SCREEN ══ */
        #campaignStartScreen {
            position: fixed; inset: 0; z-index: var(--z-start-screen);
            background: radial-gradient(ellipse at center, #1a0a00 0%, #0d0d1a 60%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Cinzel', serif;
            transition: opacity 0.8s ease;
            padding-bottom: 72px;
            box-sizing: border-box;
            pointer-events: auto;
        }
        #campaignStartScreen.hidden { opacity: 0; pointer-events: none; }
        #campaignStartScreen.gone { display: none; }
        /* Only show loading screen first, then only start screen — no app UI flash */
        body.loading > *:not(#loading-screen) { display: none !important; }
        body.start-screen-only > *:not(#campaignStartScreen) { display: none !important; }
        .cs-rune {
            font-size: 5em; margin-bottom: 10px;
            animation: csRune 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px #b8860b);
        }
        @keyframes csRune { 0%,100%{transform:rotate(-3deg) scale(1);} 50%{transform:rotate(3deg) scale(1.05);} }
        .cs-title {
            font-size: 2.8em; font-weight: 700; color: var(--gold-light);
            text-transform: uppercase; letter-spacing: 6px;
            text-shadow: 0 0 30px rgba(184,134,11,0.6), 2px 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 6px; text-align: center;
        }
        .cs-subtitle {
            font-size: 1em; color: rgba(184,134,11,0.55); letter-spacing: 3px;
            text-transform: uppercase; margin-bottom: 50px; font-family: 'Crimson Text', serif;
            font-style: italic;
        }
        .cs-divider {
            width: 320px; height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            margin-bottom: 40px;
        }
        .cs-options { display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; margin-bottom: 40px; }
        .cs-card {
            background: linear-gradient(145deg, rgba(244,228,188,0.07) 0%, rgba(184,134,11,0.04) 100%);
            border: 2px solid rgba(184,134,11,0.4); border-radius: 12px;
            padding: 36px 32px; width: 260px; text-align: center; cursor: pointer;
            transition: all 0.3s ease; position: relative; overflow: hidden;
            font: inherit; color: inherit;
        }
        button.cs-card {
            display: block; appearance: none; -webkit-appearance: none;
            margin: 0; outline: none;
        }
        .cs-card::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(145deg, rgba(184,134,11,0.15), transparent);
            opacity: 0; transition: opacity 0.3s;
            pointer-events: none;
        }
        .cs-card:hover { border-color: var(--gold-light); transform: translateY(-4px); box-shadow: 0 12px 40px rgba(184,134,11,0.3); }
        .cs-card:hover::before { opacity: 1; }
        .cs-card-icon { font-size: 2.8em; margin-bottom: 14px; display: block; line-height: 1; visibility: visible; }
        .cs-card.cs-options-card .cs-card-icon { color: rgba(218,165,32,0.95); }
        .cs-card-title { display: block; color: var(--gold-light); font-size: 1.2em; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .cs-card-desc { display: block; color: rgba(255,255,255,0.5); font-family: 'Crimson Text', serif; font-size: 0.95em; line-height: 1.5; font-style: italic; }
        .cs-card.cs-new .cs-card-title { color: #daa520; }
        .cs-card.cs-open .cs-card-title { color: #7ec8a0; }
        .cs-card.cs-new { border-color: rgba(220,163,0,0.5); }
        .cs-card.cs-open { border-color: rgba(100,200,150,0.4); }
        .cs-card.cs-new:hover { border-color: #daa520; box-shadow: 0 12px 40px rgba(220,163,0,0.3); }
        .cs-card.cs-open:hover { border-color: #7ec8a0; box-shadow: 0 12px 40px rgba(100,200,150,0.3); }
        /* New Campaign Panel */
        #csNewPanel, #csOpenPanel, #csChoicePanel {
            display: none; flex-direction: column; align-items: center; gap: 14px;
            width: 100%; max-width: 580px;
        }
        #csNewPanel.active, #csOpenPanel.active, #csChoicePanel.active { display: flex; }

        /* Campaign choice cards (after creating a new campaign) */
        .cs-choice-row { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; width: 100%; }
        .cs-choice-card {
            background: linear-gradient(145deg, rgba(244,228,188,0.07) 0%, rgba(184,134,11,0.04) 100%);
            border: 2px solid rgba(184,134,11,0.4); border-radius: 10px;
            padding: 26px 22px; width: 200px; text-align: center; cursor: pointer;
            transition: all 0.3s ease; position: relative; overflow: hidden;
            flex: 1; min-width: 160px; max-width: 220px;
        }
        .cs-choice-card:hover { border-color: var(--gold-light); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(184,134,11,0.3); }
        .cs-choice-card-icon { font-size: 2.4em; margin-bottom: 10px; display: block; }
        .cs-choice-card-title { color: var(--gold-light); font-size: 1.05em; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 7px; }
        .cs-choice-card-desc { color: rgba(255,255,255,0.45); font-family: 'Crimson Text', serif; font-size: 0.88em; line-height: 1.5; font-style: italic; }
        .cs-choice-card.cs-npcs { border-color: rgba(220,163,0,0.5); }
        .cs-choice-card.cs-npcs:hover { border-color: #daa520; box-shadow: 0 10px 30px rgba(220,163,0,0.3); }
        .cs-choice-card.cs-npcs .cs-choice-card-title { color: #daa520; }
        .cs-choice-card.cs-quests { border-color: rgba(139,0,0,0.5); }
        .cs-choice-card.cs-quests:hover { border-color: #dc143c; box-shadow: 0 10px 30px rgba(139,0,0,0.3); }
        .cs-choice-card.cs-quests .cs-choice-card-title { color: #f08080; }
        .cs-choice-card.cs-both { border-color: rgba(100,200,150,0.4); }
        .cs-choice-card.cs-both:hover { border-color: #7ec8a0; box-shadow: 0 10px 30px rgba(100,200,150,0.3); }
        .cs-choice-card.cs-both .cs-choice-card-title { color: #7ec8a0; }
        .cs-choice-new-campaign-name {
            font-family: 'Cinzel', serif; color: var(--gold-light); font-size: 1.3em;
            font-weight: 700; text-align: center; margin-bottom: 6px;
            text-shadow: 0 0 20px rgba(184,134,11,0.4);
        }
        .cs-choice-subtitle { color: rgba(255,255,255,0.45); font-family: 'Crimson Text', serif; font-style: italic; font-size: 0.95em; margin-bottom: 6px; }
        .cs-input {
            width: 100%; padding: 14px 18px; border: 2px solid var(--gold);
            background: rgba(244,228,188,0.07); color: var(--gold-light);
            font-family: 'Cinzel', serif; font-size: 1em; border-radius: 8px;
            text-align: center; letter-spacing: 1px;
        }
        .cs-input::placeholder { color: rgba(184,134,11,0.4); }
        .cs-input:focus { outline: none; border-color: var(--gold-light); background: rgba(244,228,188,0.1); }
        .cs-btn {
            padding: 14px 32px; border: none; border-radius: 8px; cursor: pointer;
            font-family: 'Cinzel', serif; font-size: 1em; font-weight: 700;
            text-transform: uppercase; letter-spacing: 2px; transition: all 0.2s;
        }
        .cs-btn-primary {
            background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%);
            color: #fff8dc; box-shadow: 0 4px 20px rgba(139,0,0,0.5);
        }
        .cs-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(139,0,0,0.7); }
        .cs-btn-secondary { background: rgba(184,134,11,0.15); color: var(--gold-light); border: 1px solid var(--gold); }
        .cs-btn-secondary:hover { background: rgba(184,134,11,0.25); }
        /* Saved Campaigns List */
        .cs-campaign-list { width: 100%; max-height: 240px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .cs-campaign-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 18px; border: 1px solid rgba(184,134,11,0.3);
            border-radius: 8px; cursor: pointer; transition: all 0.2s;
            background: rgba(244,228,188,0.04);
        }
        .cs-campaign-item:hover { border-color: var(--gold); background: rgba(184,134,11,0.1); }
        .cs-campaign-name { color: var(--gold-light); font-size: 1em; font-weight: 700; }
        .cs-campaign-meta { color: rgba(255,255,255,0.4); font-size: 0.8em; font-family: 'Crimson Text', serif; margin-top: 3px; }
        .cs-campaign-del { background: none; border: 1px solid rgba(139,0,0,0.5); color: rgba(220,20,60,0.6); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em; transition: all 0.2s; }
        .cs-campaign-del:hover { border-color: var(--red); color: var(--red); }
        .cs-back { color: rgba(184,134,11,0.5); font-size: 0.85em; cursor: pointer; margin-top: 4px; font-family: 'Crimson Text', serif; font-style: italic; transition: color 0.2s; text-decoration: underline; }
        .cs-back:hover { color: var(--gold-light); }

        /* ── Hunted player badge ── */
        .hunted-badge {
            display: inline-flex; align-items: center; gap: 5px;
            background: linear-gradient(145deg, rgba(139,0,0,0.3), rgba(90,0,0,0.2));
            border: 1px solid rgba(220,20,60,0.5); color: #f08080;
            padding: 2px 8px; border-radius: 10px; font-size: 0.72em;
            font-family: 'Cinzel', serif; font-weight: 700; margin-top: 3px;
            animation: huntedPulse 2s ease-in-out infinite;
        }
        @keyframes huntedPulse { 0%,100%{border-color:rgba(220,20,60,0.5);} 50%{border-color:rgba(220,20,60,0.9);box-shadow:0 0 8px rgba(220,20,60,0.3);} }

        /* ── Hostile NPC indicator ── */
        .npc-hostile-banner {
            background: linear-gradient(145deg, rgba(139,0,0,0.15), rgba(90,0,0,0.08));
            border: 1px solid rgba(220,20,60,0.4); border-radius: 6px;
            padding: 8px 12px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
            font-family: 'Cinzel', serif; font-size: 0.82em; font-weight: 700;
            color: #dc143c; animation: huntedPulse 2.5s ease-in-out infinite;
        }

        /* ── Kill confirmation box on NPC cards ── */
        .npc-killed-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(20,0,0,0.55); border-radius: 4px; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none; backdrop-filter: blur(1px);
        }
        .npc-killed-stamp {
            border: 4px solid #8b0000; color: #8b0000; padding: 8px 24px;
            font-family: 'Cinzel', serif; font-size: 2em; font-weight: 900;
            text-transform: uppercase; letter-spacing: 4px; transform: rotate(-12deg);
            opacity: 0.85; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        /* Current campaign badge in header */
        #campaignBadge {
            font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700;
            color: var(--gold-light); background: rgba(184,134,11,0.12);
            border: 1px solid rgba(184,134,11,0.3); border-radius: 4px;
            padding: 3px 10px; display: none; align-items: center; gap: 6px;
        }
        #campaignBadge.visible { display: inline-flex; }
        #campaignBadgeSaveBtn {
            border: 1px solid rgba(46,204,113,0.45);
            background: rgba(46,204,113,0.14);
            color: #a0ffc0;
            border-radius: 4px;
            padding: 2px 7px;
            font-family: 'Cinzel', serif;
            font-size: 0.72em;
            font-weight: 900;
            cursor: pointer;
            line-height: 1.2;
        }
        #campaignBadgeSaveBtn:hover { background: rgba(46,204,113,0.25); }
        /* ══ QUEST POPUP MODAL ══ */
        #questPopupModal {
            display: none; position: fixed; inset: 0; z-index: 5000;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            align-items: flex-start; justify-content: center; padding: 30px 20px;
            overflow-y: auto;
        }
        #questPopupModal.active { display: flex; }
        #questPopupModal .qpm-inner {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid var(--gold); border-radius: 12px;
            width: 100%; max-width: 820px; position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from{opacity:0;transform:translateY(-20px);} to{opacity:1;transform:translateY(0);} }
        .qpm-header {
            background: linear-gradient(145deg, var(--red) 0%, var(--red-dark) 100%);
            padding: 18px 24px; border-radius: 10px 10px 0 0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .qpm-title { font-family: 'Cinzel', serif; font-size: 1.2em; font-weight: 700; color: #fff8dc; text-transform: uppercase; letter-spacing: 2px; }
        .qpm-close { background: none; border: 1px solid rgba(255,248,220,0.3); color: #fff8dc; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
        .qpm-close:hover { background: rgba(255,255,255,0.1); }
        .qpm-body { padding: 24px; }
        /* Kill → Quest styles */
        #killQuestModal {
            display: none; position: fixed; inset: 0; z-index: 6000;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(4px);
            align-items: center; justify-content: center;
        }
        #killQuestModal.active { display: flex; }
        .kqm-inner {
            background: linear-gradient(145deg, #180000 0%, #2a0a0a 100%);
            border: 3px double var(--red); border-radius: 12px;
            padding: 28px; max-width: 520px; width: 95%;
            box-shadow: 0 0 60px rgba(139,0,0,0.5);
            animation: slideDown 0.3s ease-out;
        }
        .kqm-title { font-family: 'Cinzel', serif; font-size: 1.1em; font-weight: 700; color: #dc143c; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .kqm-npc-box { background: rgba(139,0,0,0.15); border: 1px solid rgba(220,20,60,0.3); border-radius: 8px; padding: 14px; margin-bottom: 18px; }
        .kqm-npc-name { font-family: 'Cinzel', serif; font-size: 1.2em; font-weight: 700; color: #f0a0a0; }
        .kqm-npc-sub { color: rgba(255,255,255,0.5); font-size: 0.85em; margin-top: 3px; }
        .kqm-section-label { font-family: 'Cinzel', serif; font-size: 0.8em; color: #dc143c; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .kqm-player-btns { display: flex; flex-direction: column; gap: 6px; max-height: 160px; overflow-y: auto; margin-bottom: 16px; }
        .kqm-player-btn {
            padding: 8px 14px; border: 1px solid rgba(139,0,0,0.4);
            background: rgba(139,0,0,0.08); color: #f0d0d0; border-radius: 6px;
            cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; text-align: left; transition: all 0.2s;
        }
        .kqm-player-btn:hover, .kqm-player-btn.selected { background: rgba(139,0,0,0.5); border-color: #dc143c; }
        .kqm-result { background: rgba(139,0,0,0.12); border: 1px solid rgba(220,20,60,0.25); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.88em; line-height: 1.6; color: #f0d0d0; display: none; }
        .kqm-result.visible { display: block; }
        /* Quest sidebar button in NPC mode */
        .quest-popup-trigger {
            width: 100%; padding: 10px 14px; border: 2px solid var(--gold);
            background: linear-gradient(145deg, rgba(184,134,11,0.12), rgba(184,134,11,0.05));
            color: var(--gold-light); font-family: 'Cinzel', serif; font-size: 0.85em; font-weight: 700;
            border-radius: 6px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .quest-popup-trigger:hover { background: rgba(184,134,11,0.25); border-color: var(--gold-light); transform: translateY(-1px); }
        /* Kill button on NPC card */
        .btn-top.btn-kill-top {
            background: linear-gradient(145deg, #8b0000, #5a0000);
            border: 1px solid #dc143c; color: #fff8dc;
        }
        .btn-top.btn-kill-top:hover { background: linear-gradient(145deg, #dc143c, #8b0000); }

        .app-footer {
            grid-column: 1 / -1;
            text-align: center;
            padding: 16px 10px;
            border-top: 1px solid rgba(184,134,11,0.35);
            margin-top: 30px;
            font-family: 'Cinzel', serif;
            font-size: 0.82em;
            letter-spacing: 3px;
            text-transform: uppercase;
            background: linear-gradient(90deg, transparent, rgba(184,134,11,0.06), transparent);
        }
        .app-footer span { color: var(--red); }
        .app-footer .footer-main { color: var(--gold); }
        .app-footer .footer-sub { color: rgba(184,134,11,0.45); font-size: 0.78em; margin-top: 4px; letter-spacing: 2px; }

        /* ══════════════════════════════════════════════════
           NEW FEATURES CSS
           ══════════════════════════════════════════════════ */

        /* ── NPC Inline Edit Buttons ── */
        .npc-edit-btn {
            display:inline-flex;align-items:center;gap:3px;
            padding:2px 7px;font-size:0.68em;font-family:'Cinzel',serif;font-weight:700;
            background:rgba(184,134,11,0.12);border:1px solid rgba(184,134,11,0.4);
            color:var(--gold);border-radius:4px;cursor:pointer;
            vertical-align:middle;margin-left:6px;white-space:nowrap;
            transition:all 0.15s;
        }
        .npc-edit-btn:hover { background:rgba(184,134,11,0.3);color:var(--gold-light); }

        /* ── NPC Field Edit Modal ── */
        #npcFieldEditModal {
            display:none;position:fixed;inset:0;z-index:29500;
            background:rgba(0,0,0,0.88);backdrop-filter:blur(6px);
            align-items:center;justify-content:center;
        }
        #npcFieldEditModal.active { display:flex; }
        .nfe-inner {
            background:linear-gradient(145deg,#1a1a2e,#16213e);
            border:2px solid var(--gold);border-radius:12px;padding:26px;
            width:520px;max-width:95%;max-height:85vh;overflow-y:auto;
            box-shadow:0 20px 60px rgba(0,0,0,0.8);
        }
        .nfe-title { font-family:'Cinzel',serif;font-size:1em;font-weight:700;color:var(--gold-light);margin-bottom:14px;border-bottom:1px solid rgba(184,134,11,0.3);padding-bottom:8px; }
        .nfe-label { font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px; }
        .nfe-input, .nfe-textarea {
            width:100%;padding:9px 12px;border:2px solid rgba(184,134,11,0.4);
            background:rgba(255,255,255,0.06);color:#e8d5a0;
            border-radius:6px;font-family:'Crimson Text',serif;font-size:1em;
            line-height:1.5;box-sizing:border-box;
        }
        .nfe-textarea { resize:vertical;min-height:90px; }
        .nfe-input:focus, .nfe-textarea:focus { outline:none;border-color:var(--gold);background:rgba(255,255,255,0.09); }

        /* ── Spell Management ── */
        #spellManagerModal {
            display:none;position:fixed;inset:0;z-index:99500;
            background:rgba(0,0,0,0.88);backdrop-filter:blur(5px);
            align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;
        }
        #spellManagerModal.active { display:flex; }
        .spm-inner {
            background:linear-gradient(145deg,#1a1a2e,#16213e);
            border:2px solid #3498db;border-radius:12px;
            width:100%;max-width:820px;margin:auto;
            box-shadow:0 20px 60px rgba(0,0,0,0.8);
        }
        .spm-header {
            background:linear-gradient(145deg,#1a3a6a,#2a4a8a);
            padding:16px 22px;border-radius:10px 10px 0 0;
            display:flex;align-items:center;justify-content:space-between;
        }
        .spm-title { font-family:'Cinzel',serif;font-size:1.1em;font-weight:700;color:#d0e8ff;text-transform:uppercase;letter-spacing:2px; }
        .spm-body { padding:20px; }
        .spm-section { margin-bottom:18px; }
        .spm-section-title {
            font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:#3498db;
            text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;
            border-bottom:1px solid rgba(52,152,219,0.25);padding-bottom:5px;
        }
        .spm-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px; }
        .spm-field label { display:block;font-family:'Cinzel',serif;font-size:0.72em;color:rgba(255,255,255,0.55);margin-bottom:3px; }
        .spm-input,.spm-select {
            width:100%;padding:7px 10px;border:1px solid rgba(52,152,219,0.35);
            background:rgba(255,255,255,0.06);color:#c8e0ff;
            border-radius:5px;font-family:'Crimson Text',serif;font-size:0.93em;box-sizing:border-box;
        }
        .spm-select { cursor:pointer; }
        .spm-slot-grid { display:grid;grid-template-columns:repeat(3,1fr);gap:8px; }
        .spm-slot-box {
            background:rgba(52,152,219,0.08);border:1px solid rgba(52,152,219,0.3);
            border-radius:6px;padding:8px 10px;text-align:center;
        }
        .spm-slot-label { font-family:'Cinzel',serif;font-size:0.68em;color:#3498db;font-weight:700;text-transform:uppercase;margin-bottom:4px; }
        .spm-slot-inputs { display:flex;align-items:center;gap:4px;justify-content:center; }
        .spm-slot-inputs input { width:44px;padding:4px;text-align:center;border:1px solid rgba(52,152,219,0.4);background:rgba(0,0,0,0.3);color:#a0c8ff;border-radius:4px;font-size:0.9em; }
        .spm-slot-inputs span { color:rgba(255,255,255,0.3);font-size:0.85em; }
        .spm-spell-search { width:100%;padding:8px 12px;border:1px solid rgba(52,152,219,0.4);background:rgba(0,0,0,0.3);color:#c8e0ff;border-radius:6px;font-size:0.9em;margin-bottom:10px;box-sizing:border-box; }
        .spm-spell-list { max-height:220px;overflow-y:auto;border:1px solid rgba(52,152,219,0.2);border-radius:6px; }
        .spm-spell-item {
            display:flex;align-items:center;justify-content:space-between;gap:8px;
            padding:7px 12px;border-bottom:1px solid rgba(52,152,219,0.1);cursor:pointer;
            transition:background 0.15s;
        }
        .spm-spell-item:hover { background:rgba(52,152,219,0.1); }
        .spm-spell-item.selected { background:rgba(52,152,219,0.18);border-left:3px solid #3498db; }
        .spm-spell-name { font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;color:#c8e0ff; }
        .spm-spell-meta { font-size:0.72em;color:rgba(255,255,255,0.4); }
        .spm-spell-badge { font-size:0.68em;padding:1px 7px;border-radius:8px;font-weight:700;white-space:nowrap; }
        .spm-known-spells { display:flex;flex-wrap:wrap;gap:6px;min-height:40px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;border:1px solid rgba(52,152,219,0.2); }
        .spm-known-spell-tag {
            display:inline-flex;align-items:center;gap:5px;padding:3px 10px;
            background:rgba(52,152,219,0.18);border:1px solid rgba(52,152,219,0.4);
            border-radius:10px;font-size:0.78em;color:#a0d0ff;cursor:default;
        }
        .spm-known-spell-tag button { background:none;border:none;color:#f08080;cursor:pointer;padding:0;font-size:0.9em;line-height:1; }

        /* ── Changelog Panel ── */
        #changelogPanel {
            position:fixed;bottom:10px;right:10px;z-index:4000;
        }
        #changelogToggleBtn {
            background:linear-gradient(145deg,rgba(26,26,46,0.92),rgba(22,33,62,0.92));
            border:1px solid rgba(184,134,11,0.3);border-radius:20px;
            padding:5px 12px;color:rgba(184,134,11,0.55);
            font-family:'Cinzel',serif;font-size:0.7em;font-weight:700;
            cursor:pointer;letter-spacing:0.5px;
            backdrop-filter:blur(4px);transition:all 0.2s;white-space:nowrap;
        }
        #changelogToggleBtn:hover { color:var(--gold);border-color:rgba(184,134,11,0.6); }
        #changelogBody {
            display:none;
            background:linear-gradient(145deg,#1a1a2e,#16213e);
            border:1px solid rgba(184,134,11,0.4);border-radius:10px;
            padding:14px;width:320px;max-height:360px;overflow-y:auto;
            margin-bottom:6px;box-shadow:0 8px 30px rgba(0,0,0,0.6);
        }
        .cl-entry {
            border-left:3px solid var(--gold);padding:6px 10px;margin-bottom:7px;
            background:rgba(184,134,11,0.05);border-radius:0 5px 5px 0;
        }
        .cl-date { font-size:0.68em;color:rgba(184,134,11,0.5);font-family:'Cinzel',serif;margin-bottom:2px; }
        .cl-text { font-size:0.82em;color:rgba(255,255,255,0.7);line-height:1.4; }


        /* Header party health strip */
        #headerPartyHealth {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            max-width: 600px;
            overflow: visible;
        }
        .player-health-tab {
            background: linear-gradient(145deg, rgba(139,0,0,0.15), rgba(90,0,0,0.1));
            border: 2px solid var(--gold);
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            min-width: 100px;
            max-width: 140px;
            transition: all 0.2s;
            position: relative;
        }
        .player-health-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(184,134,11,0.4);
            border-color: var(--gold-light);
        }
        .player-health-tab .player-name {
            font-family: 'Cinzel', serif;
            font-size: 0.7em;
            font-weight: 700;
            color: #fff8dc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .player-health-tab .health-bar-container {
            background: rgba(0,0,0,0.4);
            border-radius: 3px;
            height: 6px;
            margin: 4px 0;
            overflow: hidden;
            position: relative;
        }
        .player-health-tab .health-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s, background 0.3s;
        }
        .player-health-tab .health-text {
            font-size: 0.65em;
            font-weight: 700;
            text-align: center;
            margin-top: 2px;
        }
        .player-health-tab.health-critical .health-bar-fill { background: #c0392b; }
        .player-health-tab.health-low .health-bar-fill { background: #e67e22; }
        .player-health-tab.health-good .health-bar-fill { background: #27ae60; }
        .player-health-tab.health-critical .health-text { color: #ff6b6b; }
        .player-health-tab.health-low .health-text { color: #ffa500; }
        .player-health-tab.health-good .health-text { color: #51cf66; }

        body.light-mode {
            --bg-dark: #e8e0d0;
            --bg-panel: #f0e8d8;
            --paper: #fff8f0;
            --paper-dark: #f5ece0;
            background: linear-gradient(135deg, #e8e0d0 0%, #f0e8d8 100%) !important;
        }
        body.light-mode .controls { background: linear-gradient(145deg, #fff8f0, #f5ece0); }
        body.light-mode .npc-card { background: linear-gradient(145deg, #fff8f0, #f5ece0); }
        body.light-mode .npc-tabs-container { background: linear-gradient(145deg, #fff8f0, #f5ece0); }
        #darkModeToggle { position:fixed; top:12px; right:16px; z-index:5000; background:var(--bg-panel); border:2px solid var(--gold); color:var(--gold-light); padding:6px 12px; border-radius:20px; cursor:pointer; font-family:'Cinzel',serif; font-size:0.8em; font-weight:700; letter-spacing:0.5px; transition:all 0.2s; }
        #darkModeToggle:hover { background:var(--gold); color:var(--bg-dark); }

        /* ── Right stacked panels order ───────────────────────────────
           TOP: Spell List
           BOTTOM: Session Notes (popout)
           VERY BOTTOM: Roll Log
        */

        /* ── Roll History Log Panel (bottom-most) ── */
        #rollLogPanel {
            position: fixed;
            right: 0;
            bottom: 18px;
            top: auto;
            transform: none;
            width: 280px;
            max-height: 40vh;
            background: var(--bg-panel);
            border: 2px solid var(--gold);
            border-right: none;
            border-radius: 8px 0 0 8px;
            z-index: 4500;
            transition: transform 0.3s ease;
            box-shadow: -4px 0 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
        }
        #rollLogPanel.collapsed { transform: translateX(248px); }
        
        /* ── Spell List Panel (top-most) ── */
        #spellListPanel {
            position: fixed;
            right: 0;
            top: 88px;
            bottom: auto;
            transform: none;
            width: 280px;
            max-height: 46vh;
            background: var(--bg-panel);
            border: 2px solid var(--spell-slot);
            border-right: none;
            border-radius: 8px 0 0 8px;
            z-index: 4499;
            transition: transform 0.3s ease;
            box-shadow: -4px 0 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
        }
        /* leave enough visible area to read "Spell List" when collapsed */
        #spellListPanel.collapsed { transform: translateX(210px); }
        .spell-list-header {
            background: linear-gradient(135deg, var(--spell-slot), #2980b9);
            color: #fff8dc; font-family: 'Cinzel', serif; font-size: 0.85em; font-weight: 700;
            padding: 10px 14px; border-radius: 6px 0 0 0; display: flex; align-items: center;
            justify-content: space-between; cursor: pointer; letter-spacing: 1px; flex-shrink: 0;
        }
        .spell-list-toggle-btn { background: none; border: none; color: #fff8dc; cursor: pointer; font-size: 1em; padding: 0; }
        #spellListSearch { width: 100%; padding: 8px; border: 1px solid rgba(52,152,219,0.4); background: rgba(0,0,0,0.3); color: #c8e0ff; border-radius: 4px; font-size: 0.85em; margin: 8px; box-sizing: border-box; }
        #spellListLevelFilter { width: 100%; padding: 6px; border: 1px solid rgba(52,152,219,0.4); background: rgba(0,0,0,0.3); color: #c8e0ff; border-radius: 4px; font-size: 0.8em; margin: 0 8px 8px; box-sizing: border-box; }
        #spellListContent { flex: 1; overflow-y: auto; padding: 8px; scrollbar-width: thin; scrollbar-color: var(--spell-slot) var(--bg-panel); }
        #spellListContent::-webkit-scrollbar { width: 4px; }
        #spellListContent::-webkit-scrollbar-thumb { background: var(--spell-slot); border-radius: 2px; }
        .spell-list-item {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(52,152,219,0.2);
            border-radius: 5px; padding: 8px; margin-bottom: 6px; cursor: pointer;
            transition: all 0.2s; font-size: 0.85em;
        }
        .spell-list-item:hover {
            background: rgba(52,152,219,0.15); border-color: var(--spell-slot);
            transform: translateX(-2px);
        }
        .spell-list-item-name { font-family: 'Cinzel', serif; font-weight: 700; color: #c8e0ff; margin-bottom: 2px; }
        .spell-list-item-meta { font-size: 0.75em; color: rgba(255,255,255,0.5); }
        .spell-list-favorites { border-top: 1px solid rgba(52,152,219,0.2); padding-top: 8px; margin-top: 8px; }
        .spell-list-fav-header { font-family: 'Cinzel', serif; font-size: 0.75em; color: var(--gold-light); font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; }
        .spell-modal-favorite { background: none; border: none; color: var(--gold-light); cursor: pointer; font-size: 1.2em; padding: 0; margin-left: 8px; }
        .spell-modal-favorite.active { color: var(--gold); }
        /* locationsPanel migrated to inline dropdown — CSS no longer needed */
        .roll-log-header {
            background: linear-gradient(135deg, var(--red-dark), var(--red));
            color: #fff8dc; font-family: 'Cinzel', serif; font-size: 0.85em; font-weight: 700;
            padding: 10px 14px; border-radius: 6px 0 0 0; display: flex; align-items: center;
            justify-content: space-between; cursor: pointer; letter-spacing: 1px; flex-shrink: 0;
        }
        .roll-log-toggle-btn { background: none; border: none; color: #fff8dc; cursor: pointer; font-size: 1em; padding: 0; }
        #rollLogList { flex: 1; overflow-y: auto; padding: 8px; scrollbar-width: thin; scrollbar-color: var(--gold) var(--bg-panel); }
        #rollLogList::-webkit-scrollbar { width: 4px; }
        #rollLogList::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 2px; }
        .roll-log-entry {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(184,134,11,0.2);
            border-radius: 5px; padding: 6px 9px; margin-bottom: 5px; font-size: 0.82em;
            line-height: 1.4; border-left: 3px solid var(--gold);
        }
        .roll-log-entry.crit { border-left-color: #2ecc71; }
        .roll-log-entry.fumble { border-left-color: var(--red-bright); }
        .roll-log-name { font-family: 'Cinzel', serif; font-size: 0.85em; color: var(--gold-light); font-weight: 700; }
        .roll-log-result { font-size: 1.05em; font-weight: 700; color: #fff; }
        .roll-log-time { font-size: 0.75em; color: rgba(255,255,255,0.4); margin-top: 2px; }
        .roll-log-clear { padding: 6px; text-align: center; border-top: 1px solid rgba(184,134,11,0.2); flex-shrink: 0; }
        .roll-log-clear button { background: none; border: 1px solid rgba(184,134,11,0.3); color: rgba(184,134,11,0.6); border-radius: 4px; padding: 3px 10px; cursor: pointer; font-size: 0.78em; font-family: 'Cinzel', serif; }
        .roll-log-clear button:hover { color: var(--gold); border-color: var(--gold); }

        /* ── NPC STAT STRIP (matches screenshot style) ── */
        .npc-stat-strip {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 12px 0 14px;
            padding: 10px;
            background: linear-gradient(145deg, rgba(244,228,188,0.75), rgba(232,220,197,0.7));
            border: 2px solid rgba(139,0,0,0.35);
            border-radius: 10px;
        }
        .npc-stat-tile {
            text-align: center;
            background: rgba(244,228,188,0.92);
            border: 3px solid rgba(139,0,0,0.75);
            border-radius: 10px;
            padding: 10px 8px 8px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
            position: relative;
        }
        .npc-stat-tile .npc-stat-label {
            font-family: 'Cinzel', serif;
            font-weight: 800;
            letter-spacing: 1px;
            font-size: 0.72em;
            color: rgba(90,0,0,0.85);
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .npc-stat-tile .npc-stat-score {
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 1.25em;
            color: #2a1a00;
            line-height: 1.1;
        }
        .npc-stat-tile .npc-stat-mod {
            margin-top: 4px;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 0.86em;
            color: rgba(90,0,0,0.85);
        }
        .npc-stat-tile .npc-stat-roll {
            position: absolute;
            right: 6px;
            top: 6px;
            background: rgba(139,0,0,0.12);
            border: 1px solid rgba(139,0,0,0.35);
            border-radius: 7px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.8em;
            opacity: 0.0;
            transition: opacity 0.15s;
        }
        .npc-stat-tile:hover .npc-stat-roll { opacity: 1; }

        /* ══════════════════════════════════════════════════════════════
           LEFT SLIDING PANELS (Party, NPC Generator, Quest Generator)
           Same style as Roll Log but on left side, stacked vertically
           ══════════════════════════════════════════════════════════════ */
        .left-panel {
            position: fixed;
            left: 0;
            width: 300px;
            background: var(--bg-panel);
            border: 2px solid var(--gold);
            border-left: none;
            border-radius: 0 8px 8px 0;
            z-index: 4400;
            transition: transform 0.3s ease;
            box-shadow: 4px 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            max-height: 70vh;
        }
        /* Each panel collapses so only the header-tab peeks out (32px visible) */
        #panelParty  { top: 30%;  }
        #panelNPC    { top: calc(30% + 46px); }
        #panelQuest  { top: calc(30% + 92px); }

        /* Collapsed = slide all but 32px (the header tab width) off screen */
        .left-panel.lp-collapsed { transform: translateX(calc(-100% + 32px)); }
        /* When expanded, slide fully in but don't visually overlap main content by using semi-transparent overlay */
        .left-panel:not(.lp-collapsed) { box-shadow: 4px 0 30px rgba(0,0,0,0.7), 0 0 0 9999px rgba(0,0,0,0.3); }

        .lp-header {
            background: linear-gradient(135deg, var(--red-dark), var(--red));
            color: #fff8dc;
            font-family: 'Cinzel', serif;
            font-size: 0.82em;
            font-weight: 700;
            padding: 10px 10px 10px 14px;
            border-radius: 0 6px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            letter-spacing: 1px;
            flex-shrink: 0;
            user-select: none;
            white-space: nowrap;
            min-height: 42px;
        }
        .lp-header:hover { background: linear-gradient(135deg, var(--red), var(--red-bright)); }

        /* The little arrow tab that peeks out when collapsed */
        .lp-toggle-btn {
            background: rgba(255,255,255,0.15);
            border: none; color: #fff8dc; cursor: pointer;
            font-size: 0.85em; padding: 3px 6px; border-radius: 4px;
            flex-shrink: 0; margin-left: 8px;
            min-width: 22px; text-align: center;
            transition: background 0.2s;
        }
        .lp-toggle-btn:hover { background: rgba(255,255,255,0.3); }

        /* When collapsed, only the toggle-btn portion peeks out, rotate icon */
        .lp-collapsed .lp-toggle-btn { background: rgba(255,255,255,0.25); }

        .lp-body {
            flex: 1; overflow-y: auto; padding: 10px 12px;
            scrollbar-width: thin; scrollbar-color: var(--gold) var(--bg-panel);
            color: var(--paper);
        }
        .lp-body::-webkit-scrollbar { width: 4px; }
        .lp-body::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 2px; }
        .lp-footer {
            padding: 6px 10px;
            border-top: 1px solid rgba(184,134,11,0.2);
            flex-shrink: 0;
        }

        /* Panel NPC has gold header */
        #panelNPC .lp-header {
            background: linear-gradient(135deg, #7a5800, var(--gold));
        }
        #panelNPC .lp-header:hover { background: linear-gradient(135deg, var(--gold), var(--gold-light)); }

        /* Panel Quest has purple/dark header */
        #panelQuest .lp-header {
            background: linear-gradient(135deg, #2a0050, #5a0080);
        }
        #panelQuest .lp-header:hover { background: linear-gradient(135deg, #5a0080, #8a00c0); }

        /* Mini form elements inside panels */
        .lp-body select, .lp-body input[type="number"], .lp-body input[type="text"] {
            width: 100%; padding: 6px 8px; border: 1px solid rgba(184,134,11,0.5);
            background: rgba(0,0,0,0.3); color: var(--paper); border-radius: 4px;
            font-family: 'Crimson Text', serif; font-size: 0.9em; margin-bottom: 6px;
        }
        .lp-body select option { background: #1a1a2e; color: var(--paper); }
        .lp-body label {
            font-family: 'Cinzel', serif; font-size: 0.72em; color: var(--gold-light);
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            display: block; margin-bottom: 3px;
        }
        .lp-btn {
            width: 100%; padding: 8px 10px; border: none; border-radius: 5px;
            cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.8em;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            transition: all 0.2s; margin-bottom: 5px;
        }
        .lp-btn-red  { background: linear-gradient(145deg, var(--red), var(--red-dark)); color: #fff8dc; }
        .lp-btn-gold { background: linear-gradient(145deg, var(--gold), #7a5800); color: white; }
        .lp-btn-purple { background: linear-gradient(145deg, #5a0080, #2a0050); color: #e8c8ff; }
        .lp-btn-green { background: linear-gradient(145deg, #1a5a28, #27ae60); color: #c8ffd8; }
        .lp-btn:hover { transform: translateY(-1px); filter: brightness(1.15); }
        .lp-section-title {
            font-family: 'Cinzel', serif; font-size: 0.7em; font-weight: 700;
            color: var(--gold-light); text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 1px solid rgba(184,134,11,0.3); padding-bottom: 4px;
            margin: 10px 0 6px;
        }
        .lp-checkbox-row {
            display: flex; align-items: center; gap: 8px; padding: 5px 0;
        }
        .lp-checkbox-row input[type="checkbox"] { width: auto; cursor: pointer; accent-color: var(--red); }
        .lp-checkbox-row label { margin: 0; font-size: 0.8em; cursor: pointer; color: rgba(255,255,255,0.75); font-family: 'Crimson Text', serif; text-transform: none; letter-spacing: 0; }

        /* Saved quests in quest panel */
        .lp-quest-item {
            padding: 7px 8px; border: 1px solid rgba(184,134,11,0.3); border-radius: 5px;
            margin-bottom: 5px; background: rgba(184,134,11,0.05);
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: space-between; gap: 6px;
        }
        .lp-quest-item:hover { background: rgba(184,134,11,0.15); border-color: var(--gold); }
        .lp-quest-name { font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700; color: var(--gold-light); }
        .lp-quest-meta { font-size: 0.7em; color: rgba(255,255,255,0.4); margin-top: 1px; }
        .lp-quest-del { background: none; border: 1px solid rgba(139,0,0,0.4); color: rgba(220,20,60,0.6); padding: 2px 5px; border-radius: 3px; cursor: pointer; font-size: 0.7em; flex-shrink: 0; }
        .lp-quest-del:hover { color: var(--red); border-color: var(--red); }

        /* Party rows inside lp-body */
        .lp-party-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px 8px; background: rgba(255,255,255,0.05); border-radius: 5px;
            border: 1px solid rgba(184,134,11,0.2); margin-bottom: 5px; cursor: pointer;
            transition: all 0.2s;
        }
        .lp-party-row:hover { background: rgba(255,255,255,0.1); border-color: var(--gold); }
        .lp-party-name { font-family: 'Cinzel', serif; font-size: 0.8em; font-weight: 700; color: var(--gold-light); }
        .lp-party-hp { font-size: 0.72em; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .lp-hp-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 3px; overflow: hidden; }
        .lp-hp-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

        /* One-shot card on start screen */
        .cs-card.cs-oneshot { border-color: rgba(74,0,128,0.5); }
        .cs-card.cs-oneshot .cs-card-title { color: #c080ff; }
        .cs-card.cs-oneshot:hover { border-color: #c080ff; box-shadow: 0 12px 40px rgba(100,0,200,0.3); }
        .cs-card.cs-homebrew .cs-card-title { color: #fff; }

        .lp-header {
            background: linear-gradient(135deg, var(--red-dark), var(--red));
            color: #fff8dc;
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
            font-weight: 700;
            padding: 10px 10px 10px 14px;
            border-radius: 0 6px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            letter-spacing: 1px;
            flex-shrink: 0;
            user-select: none;
            white-space: nowrap;
        }
        .lp-header:hover { background: linear-gradient(135deg, var(--red), var(--red-bright)); }
        .lp-toggle-btn {
            background: rgba(255,255,255,0.15);
            border: none; color: #fff8dc; cursor: pointer;
            font-size: 0.9em; padding: 2px 7px; border-radius: 4px;
            flex-shrink: 0; margin-left: 8px;
            transition: background 0.2s;
        }
        .lp-toggle-btn:hover { background: rgba(255,255,255,0.3); }
        .lp-body {
            flex: 1; overflow-y: auto; padding: 10px 12px;
            scrollbar-width: thin; scrollbar-color: var(--gold) var(--bg-panel);
            color: var(--paper);
        }
        .lp-body::-webkit-scrollbar { width: 4px; }
        .lp-body::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 2px; }
        .lp-footer {
            padding: 6px 10px;
            border-top: 1px solid rgba(184,134,11,0.2);
            flex-shrink: 0;
        }

        /* Panel NPC has gold header */
        #panelNPC .lp-header {
            background: linear-gradient(135deg, #7a5800, var(--gold));
        }
        #panelNPC .lp-header:hover { background: linear-gradient(135deg, var(--gold), var(--gold-light)); }

        /* Panel Quest has purple/dark header */
        #panelQuest .lp-header {
            background: linear-gradient(135deg, #2a0050, #5a0080);
        }
        #panelQuest .lp-header:hover { background: linear-gradient(135deg, #5a0080, #8a00c0); }

        /* Mini form elements inside panels */
        .lp-body select, .lp-body input[type="number"], .lp-body input[type="text"] {
            width: 100%; padding: 6px 8px; border: 1px solid rgba(184,134,11,0.5);
            background: rgba(0,0,0,0.3); color: var(--paper); border-radius: 4px;
            font-family: 'Crimson Text', serif; font-size: 0.9em; margin-bottom: 6px;
        }
        .lp-body select option { background: #1a1a2e; color: var(--paper); }
        .lp-body label {
            font-family: 'Cinzel', serif; font-size: 0.72em; color: var(--gold-light);
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            display: block; margin-bottom: 3px;
        }
        .lp-btn {
            width: 100%; padding: 8px 10px; border: none; border-radius: 5px;
            cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.8em;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            transition: all 0.2s; margin-bottom: 5px;
        }
        .lp-btn-red  { background: linear-gradient(145deg, var(--red), var(--red-dark)); color: #fff8dc; }
        .lp-btn-gold { background: linear-gradient(145deg, var(--gold), #7a5800); color: white; }
        .lp-btn-purple { background: linear-gradient(145deg, #5a0080, #2a0050); color: #e8c8ff; }
        .lp-btn-green { background: linear-gradient(145deg, #1a5a28, #27ae60); color: #c8ffd8; }
        .lp-btn:hover { transform: translateY(-1px); filter: brightness(1.15); }
        .lp-section-title {
            font-family: 'Cinzel', serif; font-size: 0.7em; font-weight: 700;
            color: var(--gold-light); text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 1px solid rgba(184,134,11,0.3); padding-bottom: 4px;
            margin: 10px 0 6px;
        }
        .lp-checkbox-row {
            display: flex; align-items: center; gap: 8px; padding: 5px 0;
        }
        .lp-checkbox-row input[type="checkbox"] { width: auto; cursor: pointer; accent-color: var(--red); }
        .lp-checkbox-row label { margin: 0; font-size: 0.8em; cursor: pointer; color: rgba(255,255,255,0.75); font-family: 'Crimson Text', serif; text-transform: none; letter-spacing: 0; }

        /* Saved quests in quest panel */
        .lp-quest-item {
            padding: 7px 8px; border: 1px solid rgba(184,134,11,0.3); border-radius: 5px;
            margin-bottom: 5px; background: rgba(184,134,11,0.05);
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: space-between; gap: 6px;
        }
        .lp-quest-item:hover { background: rgba(184,134,11,0.15); border-color: var(--gold); }
        .lp-quest-name { font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700; color: var(--gold-light); }
        .lp-quest-meta { font-size: 0.7em; color: rgba(255,255,255,0.4); margin-top: 1px; }
        .lp-quest-del { background: none; border: 1px solid rgba(139,0,0,0.4); color: rgba(220,20,60,0.6); padding: 2px 5px; border-radius: 3px; cursor: pointer; font-size: 0.7em; flex-shrink: 0; }
        .lp-quest-del:hover { color: var(--red); border-color: var(--red); }

        /* Party rows inside lp-body */
        .lp-party-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px 8px; background: rgba(255,255,255,0.05); border-radius: 5px;
            border: 1px solid rgba(184,134,11,0.2); margin-bottom: 5px; cursor: pointer;
            transition: all 0.2s;
        }
        .lp-party-row:hover { background: rgba(255,255,255,0.1); border-color: var(--gold); }
        .lp-party-name { font-family: 'Cinzel', serif; font-size: 0.8em; font-weight: 700; color: var(--gold-light); }
        .lp-party-hp { font-size: 0.72em; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .lp-hp-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 3px; overflow: hidden; }
        .lp-hp-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

        /* One-shot card on start screen */
        .cs-card.cs-oneshot { border-color: rgba(74,0,128,0.5); }
        .cs-card.cs-oneshot .cs-card-title { color: #c080ff; }
        .cs-card.cs-oneshot:hover { border-color: #c080ff; box-shadow: 0 12px 40px rgba(100,0,200,0.3); }

        /* ── NPC Search/Filter Bar ── */
        #npcSearchBar {
            display: none; grid-column: 2; background: linear-gradient(145deg, var(--paper), var(--paper-dark));
            border: 2px solid var(--gold); border-radius: 8px; padding: 10px 14px;
            box-shadow: 0 3px 10px var(--shadow);
        }
        #npcSearchBar.visible { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #npcSearchInput { flex: 1; min-width: 150px; padding: 7px 10px; border: 2px solid var(--gold); border-radius: 5px; background: #fffdf0; font-family: 'Crimson Text', serif; font-size: 1em; }
        .npc-filter-btn { padding: 6px 12px; border: 2px solid var(--gold); background: #fffdf0; border-radius: 5px; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700; color: var(--red); transition: all 0.2s; }
        .npc-filter-btn.active { background: var(--red); color: white; border-color: var(--red); }
        .npc-filter-btn:hover { background: var(--gold); color: white; border-color: var(--gold); }
        .npc-card.search-hidden { display: none !important; }

        /* ── Party Tracker ── */
        .party-tracker-section { margin-top: 15px; }
        .party-member-row {
            display: grid; grid-template-columns: 1fr auto auto; gap: 6px; align-items: center;
            padding: 6px 8px; background: rgba(255,255,255,0.4); border-radius: 5px;
            border: 1px solid var(--gold); margin-bottom: 5px;
        }
        .party-member-name { font-family: 'Cinzel', serif; font-size: 0.82em; font-weight: 700; color: var(--red); }
        .party-hp-bar { height: 6px; background: #ddd; border-radius: 3px; margin-top: 3px; overflow: hidden; }
        .party-hp-fill { height: 100%; background: #2ecc71; border-radius: 3px; transition: width 0.3s; }
        .party-hp-fill.hurt { background: #e67e22; }
        .party-hp-fill.critical { background: var(--red); }
        .party-hp-controls { display: flex; gap: 3px; }
        .party-hp-btn { width: 22px; height: 22px; border: none; border-radius: 3px; cursor: pointer; font-weight: 700; font-size: 0.8em; }
        .party-hp-btn.minus { background: var(--red); color: white; }
        .party-hp-btn.plus { background: #2ecc71; color: white; }
        .party-inspiration { width: 22px; height: 22px; border: 2px solid var(--gold); background: none; border-radius: 50%; cursor: pointer; font-size: 0.75em; transition: all 0.2s; }
        .party-inspiration.active { background: var(--gold); color: var(--bg-dark); }

        /* ── Encounter Calculator Modal ── */
        #encounterCalcModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 99999;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        #encounterCalcModal.active { display: flex; }
        .encounter-calc-panel {
            background: linear-gradient(145deg, var(--paper), var(--paper-dark));
            border: 3px double var(--gold); border-radius: 10px; padding: 24px; width: 520px;
            max-width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .encounter-calc-panel h3 { font-family: 'Cinzel', serif; color: var(--red); margin-bottom: 16px; font-size: 1.1em; border-bottom: 2px solid var(--gold); padding-bottom: 8px; }
        .enc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
        .enc-field label { font-family: 'Cinzel', serif; font-size: 0.8em; color: var(--red); font-weight: 700; display: block; margin-bottom: 4px; }
        .enc-field input, .enc-field select { width: 100%; padding: 8px 10px; border: 2px solid var(--gold); border-radius: 4px; background: #fffdf0; font-family: 'Crimson Text', serif; font-size: 1em; }
        .difficulty-result { border-radius: 8px; padding: 16px; text-align: center; margin-top: 14px; border: 2px solid; }
        .difficulty-easy { background: rgba(46,204,113,0.1); border-color: #2ecc71; color: #1a7a40; }
        .difficulty-medium { background: rgba(241,196,15,0.1); border-color: #f1c40f; color: #7a6010; }
        .difficulty-hard { background: rgba(230,126,34,0.1); border-color: #e67e22; color: #7a4010; }
        .difficulty-deadly { background: rgba(231,76,60,0.1); border-color: var(--red); color: var(--red-dark); }
        .difficulty-label { font-family: 'Cinzel', serif; font-size: 1.5em; font-weight: 900; letter-spacing: 3px; }
        .difficulty-detail { font-size: 0.9em; margin-top: 6px; opacity: 0.85; }

        /* ── Session Notes / Campaign Log ── */
        #sessionNotesPanel {
            background: linear-gradient(145deg, var(--paper), var(--paper-dark));
            border: 2px solid var(--gold); border-radius: 8px; padding: 16px;
            margin-bottom: 14px; display: none;
        }
        #sessionNotesPanel.visible { display: block; }
        #sessionNotesPanel h4 { font-family: 'Cinzel', serif; color: var(--red); margin-bottom: 10px; font-size: 0.95em; }
        #sessionNotesArea { width: 100%; min-height: 80px; padding: 8px; border: 2px solid var(--gold); border-radius: 4px; background: #fffdf0; font-family: 'Crimson Text', serif; font-size: 0.95em; resize: vertical; }
        .session-tag { display: inline-block; background: var(--red); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-family: 'Cinzel', serif; margin: 2px; cursor: pointer; }
        .session-tag:hover { background: var(--red-dark); }

        /* ── Alignment badge on NPC card ── */
        .alignment-badge {
            display: inline-block; padding: 2px 9px; border-radius: 10px; font-size: 0.75em;
            font-family: 'Cinzel', serif; font-weight: 700; border: 1px solid;
            margin-left: 6px; vertical-align: middle;
        }
        .alignment-LG { background: rgba(46,204,113,0.12); border-color: #2ecc71; color: #1a7a40; }
        .alignment-NG { background: rgba(46,204,113,0.08); border-color: #27ae60; color: #27ae60; }
        .alignment-CG { background: rgba(52,152,219,0.1); border-color: #3498db; color: #2471a3; }
        .alignment-LN { background: rgba(127,140,141,0.1); border-color: #7f8c8d; color: #555; }
        .alignment-TN { background: rgba(127,140,141,0.08); border-color: #95a5a6; color: #7f8c8d; }
        .alignment-CN { background: rgba(230,126,34,0.1); border-color: #e67e22; color: #a04010; }
        .alignment-LE { background: rgba(231,76,60,0.1); border-color: #e74c3c; color: #922b21; }
        .alignment-NE { background: rgba(155,89,182,0.1); border-color: #9b59b6; color: #6c3483; }
        .alignment-CE { background: rgba(139,0,0,0.15); border-color: var(--red); color: var(--red-dark); }

        /* ── Legendary / Boss Tracker ── */
        .legendary-tracker {
            background: linear-gradient(145deg, rgba(74,0,128,0.1), rgba(139,0,0,0.08));
            border: 1px solid var(--boss-gold); border-radius: 6px; padding: 10px 14px; margin-bottom: 10px;
        }
        .legendary-tracker-title { font-family: 'Cinzel', serif; font-size: 0.8em; color: var(--boss-gold); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 7px; }
        .leg-uses { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
        .leg-pip { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--boss-gold); cursor: pointer; transition: all 0.2s; background: var(--boss-gold); }
        .leg-pip.used { background: transparent; }
        .leg-pip:hover { transform: scale(1.2); }

        /* ── NPC Edit Modal ── */
        #npcEditModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 5200;
            display: none; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;
        }
        #npcEditModal.active { display: flex; }
        .npc-edit-panel {
            background: linear-gradient(145deg, var(--paper), var(--paper-dark));
            border: 3px double var(--gold); border-radius: 10px; padding: 24px; width: 560px;
            max-width: 100%; max-height: 92vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .npc-edit-panel h3 { font-family: 'Cinzel', serif; color: var(--red); margin-bottom: 16px; font-size: 1.1em; border-bottom: 2px solid var(--gold); padding-bottom: 8px; }
        .edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .edit-field label { font-family: 'Cinzel', serif; font-size: 0.78em; color: var(--red); font-weight: 700; display: block; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
        .edit-field input, .edit-field select, .edit-field textarea { width: 100%; padding: 7px 9px; border: 2px solid var(--gold); border-radius: 4px; background: #fffdf0; font-family: 'Crimson Text', serif; font-size: 1em; }
        .edit-stats-grid { display: grid; grid-template-columns: repeat(6,1fr); gap: 6px; margin-bottom: 12px; }
        .edit-stat-box { text-align: center; }
        .edit-stat-box label { font-family: 'Cinzel', serif; font-size: 0.7em; color: var(--red); font-weight: 700; }
        .edit-stat-box input { text-align: center; padding: 5px 2px; font-size: 1.1em; font-weight: 700; }

        /* ── Random Encounter Generator ── */
        #encounterGenModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 5100;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        #encounterGenModal.active { display: flex; }
        .encounter-gen-panel {
            background: linear-gradient(145deg, var(--paper), var(--paper-dark));
            border: 3px double var(--gold); border-radius: 10px; padding: 24px; width: 540px;
            max-width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .encounter-card { background: rgba(255,255,255,0.5); border: 2px solid var(--gold); border-radius: 8px; padding: 14px; margin-bottom: 10px; }
        .encounter-type-badge { display: inline-block; padding: 3px 12px; border-radius: 12px; font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700; margin-bottom: 8px; }
        .enc-type-combat { background: var(--red); color: white; }
        .enc-type-social { background: #2980b9; color: white; }
        .enc-type-trap { background: #8b5e00; color: #fff8dc; }
        .enc-type-mystery { background: #5a0080; color: #f0c0ff; }
        .enc-type-travel { background: #2c6b3a; color: #c0ffd0; }

        /* ═══════════════════════════════════════════════════════
           QUEST GENERATOR STYLES
           ═══════════════════════════════════════════════════════ */
        #questGeneratorPanel {
            max-width: 1400px; margin: 24px auto 0;
            background: linear-gradient(145deg, var(--paper), var(--paper-dark));
            border: 3px double var(--gold); border-radius: 12px;
            overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .quest-gen-header {
            background: linear-gradient(135deg, #3a0000 0%, var(--red-dark) 40%, var(--red) 100%);
            padding: 16px 24px; display: flex; align-items: center;
            justify-content: space-between; cursor: pointer; user-select: none;
        }
        .quest-gen-header h2 {
            font-family: 'Cinzel', serif; color: #fff8dc; font-size: 1.2em;
            font-weight: 900; letter-spacing: 3px; margin: 0;
        }
        .quest-gen-toggle { color: #fff8dc; font-size: 1.3em; transition: transform 0.3s; }
        .quest-gen-toggle.open { transform: rotate(180deg); }
        .quest-gen-body { padding: 24px; display: none; }
        .quest-gen-body.open { display: block; }
        .quest-ctrl-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 16px; }
        .quest-ctrl { display: flex; flex-direction: column; gap: 4px; }
        .quest-ctrl label { font-family: 'Cinzel', serif; font-size: 0.77em; color: var(--red); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .quest-ctrl select { padding: 8px 10px; border: 2px solid var(--gold); border-radius: 5px; background: #fffdf0; font-family: 'Crimson Text', serif; font-size: 0.95em; min-width: 150px; }
        .quest-btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 24px; }
        .btn-qgen { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.88em; letter-spacing: 0.5px; transition: all 0.2s; }
        .btn-qgen:hover { transform: translateY(-2px); filter: brightness(1.12); }
        .btn-qgen-main  { background: linear-gradient(145deg, #6a0000, var(--red)); color: #fff8dc; box-shadow: 0 4px 14px rgba(139,0,0,0.45); }
        .btn-qgen-side  { background: linear-gradient(145deg, #1a3a6a, #2a5aaa); color: #d8eeff; box-shadow: 0 4px 14px rgba(26,58,106,0.5); }
        .btn-qgen-rand  { background: linear-gradient(145deg, #1a4a28, #2a7a3a); color: #c8ffdc; box-shadow: 0 4px 14px rgba(26,74,40,0.5); }
        .quest-area { display: flex; flex-direction: column; gap: 20px; }
        .quest-area.is-revenge {
            background: linear-gradient(145deg, rgba(60,0,0,0.18), rgba(30,0,0,0.12));
            border: 2px solid rgba(139,0,0,0.7);
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 0 24px rgba(139,0,0,0.2), inset 0 0 40px rgba(139,0,0,0.06);
        }
        .quest-card {
            border-radius: 8px; overflow: hidden;
            border: 3px solid var(--gold); box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            background: linear-gradient(145deg, var(--paper), var(--paper-dark));
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .quest-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.35);
        }
        .quest-card-head {
            padding: 14px 18px; display: flex; align-items: flex-start;
            justify-content: space-between; gap: 12px;
        }
        .quest-card-head-left { flex: 1; }
        .quest-card-title { font-family: 'Cinzel', serif; font-size: 1.2em; font-weight: 800; color: #0a0000; margin-bottom: 6px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .quest-card-sub { font-size: 0.95em; color: #444; font-weight: 600; }
        .quest-badges { display: flex; gap: 6px; flex-wrap: wrap; flex-shrink: 0; }
        .q-badge { padding: 3px 11px; border-radius: 11px; font-family: 'Cinzel', serif; font-size: 0.72em; font-weight: 700; white-space: nowrap; }
        .q-main-badge { background: var(--red); color: #fff8dc; }
        .q-side-badge { background: #1a3a6a; color: #d8eeff; }
        .q-rand-badge { background: #1a4a28; color: #c8ffdc; }
        .q-diff-easy     { background: #1a5a1a; color: #c8ffc8; }
        .q-diff-medium   { background: #5a4a00; color: #ffe8a0; }
        .q-diff-hard     { background: #5a1a00; color: #ffb08a; }
        .q-diff-deadly   { background: #4a0000; color: #ffa0a0; }
        .q-diff-legendary{ background: #2a0060; color: #d0b8ff; }
        .quest-card-body { padding: 4px 18px 18px; }
        .q-section { margin-bottom: 13px; }
        .q-label { font-family: 'Cinzel', serif; font-size: 0.85em; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--red); border-bottom: 2px solid rgba(139,0,0,0.25); padding-bottom: 5px; margin-bottom: 8px; }
        .q-text { font-size: 1.05em; line-height: 1.8; color: #1a1a1a; font-weight: 500; }
        .q-npc-actions { display: flex; gap: 7px; flex-wrap: wrap; padding-top: 12px; border-top: 1px dashed rgba(184,134,11,0.35); margin-top: 12px; }
        .q-npc-btn { padding: 6px 13px; border: 1px solid var(--gold); background: rgba(184,134,11,0.07); color: var(--red-dark); border-radius: 5px; cursor: pointer; font-size: 0.8em; font-family: 'Cinzel', serif; font-weight: 700; transition: all 0.2s; }
        .q-npc-btn:hover { background: var(--gold); color: #1a0000; transform: translateY(-1px); }
        /* Colour coding for quest types */
        .quest-card.qtype-main   { border-color: var(--red); }
        .quest-card.qtype-main .quest-card-head { background: linear-gradient(145deg, #fff0e8, #ffe0d0); }
        .quest-card.qtype-side   { border-color: #2a5aaa; }
        .quest-card.qtype-side .quest-card-head { background: linear-gradient(145deg, #e8f0ff, #d8e8ff); }
        .quest-card.qtype-rand   { border-color: #2a7a3a; }
        .quest-card.qtype-rand .quest-card-head { background: linear-gradient(145deg, #e8f8ec, #d8f0e0); }
        /* ── Player Sheet Modal ── */
        #playerSheetModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.92);
            z-index: 100000; display: none; align-items: flex-start;
            justify-content: center; padding: 20px; overflow-y: auto;
        }
        #playerSheetModal.active { display: flex; }
        .player-sheet-panel {
            background: linear-gradient(145deg, var(--paper), var(--paper-dark));
            border: 3px double var(--gold); border-radius: 10px; padding: 24px;
            width: 580px; max-width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.6); margin: auto;
        }
        .ps-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .ps-field label { font-family: 'Cinzel', serif; font-size: 0.77em; color: var(--red); font-weight: 700; display: block; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.3px; }
        .ps-field input, .ps-field select, .ps-field textarea {
            width: 100%; padding: 7px 9px; border: 2px solid var(--gold);
            border-radius: 4px; background: #fffdf0; font-family: 'Crimson Text', serif; font-size: 0.95em;
        }
        .ps-stat-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-bottom: 12px; }
        .ps-stat-box { text-align: center; }
        .ps-stat-box label { font-family: 'Cinzel', serif; font-size: 0.72em; color: var(--red); font-weight: 700; display: block; }
        .ps-stat-box input { text-align: center; padding: 5px 2px; font-size: 1.1em; font-weight: 700; }
        /* ── Nemesis system ── */
        #nemesisModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 5500; display: none; align-items: center; justify-content: center; padding: 20px;
        }
        #nemesisModal.active { display: flex; }
        .nemesis-badge-inline {
            display: inline-block; background: #8b0000; color: #fff8dc;
            padding: 2px 8px; border-radius: 9px; font-size: 0.72em;
            font-family: 'Cinzel', serif; font-weight: 700; margin-left: 5px; vertical-align: middle;
        }
        .nemesis-warning-box {
            background: rgba(139,0,0,0.08); border: 1px solid rgba(139,0,0,0.3);
            border-radius: 6px; padding: 8px 12px; margin-top: 8px; font-size: 0.88em; color: var(--red-dark);
        }


        /* ══════════════════════════════════════════════
           NOTES SYSTEM
           ══════════════════════════════════════════════ */
        .notes-system { margin-top: 12px; }
        .notes-list-dropdown {
            width: 100%; padding: 8px 10px; border: 2px solid var(--gold);
            background: #fffdf0; font-family: 'Crimson Text', serif;
            font-size: 0.95em; border-radius: 4px; cursor: pointer;
            margin-bottom: 6px;
        }
        .notes-title-input {
            width: 100%; padding: 8px 10px; border: 2px solid var(--gold);
            background: #fffdf0; font-family: 'Cinzel', serif;
            font-size: 0.88em; border-radius: 4px; margin-bottom: 6px;
        }
        .notes-textarea {
            width: 100%; padding: 8px 10px; border: 2px solid var(--gold);
            background: #fffdf0; font-family: 'Crimson Text', serif;
            font-size: 0.92em; border-radius: 4px; resize: vertical;
            min-height: 90px; line-height: 1.5;
        }
        .notes-npc-tag {
            display: inline-block; background: rgba(139,0,0,0.12);
            border: 1px solid var(--red); color: var(--red-dark);
            padding: 2px 9px; border-radius: 10px; font-size: 0.78em;
            margin: 2px; cursor: pointer; font-family: 'Cinzel', serif;
            transition: all 0.2s;
        }
        .notes-npc-tag:hover { background: var(--red); color: white; }
        .notes-btn-row { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 6px; }
        .notes-btn {
            flex: 1; padding: 7px 6px; border: none; border-radius: 4px;
            cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.8em;
            font-weight: 700; transition: all 0.2s;
        }
        .notes-btn-save { background: linear-gradient(145deg, var(--gold), #966f0a); color: white; }
        .notes-btn-new  { background: linear-gradient(145deg, #444, #222); color: white; }
        .notes-btn-del  { background: linear-gradient(145deg, var(--red), var(--red-dark)); color: white; }
        .notes-btn:hover { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,0.3); }

        /* ══════════════════════════════════════════════
           NPC DIALOG PANEL
           ══════════════════════════════════════════════ */
        .dialog-section {
            background: linear-gradient(145deg, rgba(52,152,219,0.08) 0%, rgba(41,128,185,0.05) 100%);
            border: 2px solid #3498db; border-radius: 8px; padding: 14px;
            margin-top: 16px;
        }
        .dialog-section-header {
            font-family: 'Cinzel', serif; color: #2980b9; font-weight: 700;
            font-size: 0.95em; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 10px; border-bottom: 1px solid rgba(52,152,219,0.3);
            padding-bottom: 6px;
        }
        .dialog-option {
            background: rgba(255,255,255,0.5); border: 1px solid rgba(52,152,219,0.3);
            border-radius: 6px; padding: 10px 12px; margin-bottom: 8px;
            transition: all 0.2s; cursor: pointer;
        }
        .dialog-option:hover {
            background: rgba(52,152,219,0.12); border-color: #3498db;
            transform: translateX(4px);
        }
        .dialog-option:last-child { margin-bottom: 0; }
        .dialog-label {
            font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700;
            color: #2980b9; text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .dialog-text { font-style: italic; color: #333; font-size: 0.92em; line-height: 1.5; }

        /* ══════════════════════════════════════════════
           BATTLE MAP PANEL
           ══════════════════════════════════════════════ */
        .battlemap-section {
            background: linear-gradient(145deg, rgba(46,204,113,0.07) 0%, rgba(39,174,96,0.04) 100%);
            border: 2px solid #27ae60; border-radius: 8px; padding: 14px;
            margin-top: 16px;
        }
        .battlemap-header {
            font-family: 'Cinzel', serif; color: #27ae60; font-weight: 700;
            font-size: 0.95em; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .battlemap-canvas-wrap {
            width: 100%; border-radius: 8px; overflow: hidden;
            border: 3px solid #27ae60; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            margin-bottom: 8px;
        }
        .battlemap-canvas { display: block; width: 100%; height: auto; }
        .battlemap-legend {
            display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;
            font-size: 0.8em;
        }
        .battlemap-legend-item {
            display: flex; align-items: center; gap: 5px;
            background: rgba(255,255,255,0.3); padding: 3px 8px;
            border-radius: 4px; border: 1px solid rgba(0,0,0,0.1);
        }
        .battlemap-legend-swatch {
            width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0;
        }
        .battlemap-btn {
            width: 100%; padding: 9px; border: none; border-radius: 5px;
            cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em;
            font-weight: 700; background: linear-gradient(145deg, #27ae60, #1e8449);
            color: white; transition: all 0.2s; margin-bottom: 5px;
        }
        .battlemap-btn:hover { background: linear-gradient(145deg, #2ecc71, #27ae60); transform: translateY(-1px); }
        .battlemap-btn.boss-map-btn {
            background: linear-gradient(145deg, var(--boss-purple), #2d0050);
            color: var(--boss-gold); border: 1px solid var(--boss-gold);
        }
        .battlemap-btn.boss-map-btn:hover { background: linear-gradient(145deg, #6a0080, var(--boss-purple)); }
        
        /* ══════════════════════════════════════════════
           QUEST SAVE / PRINT
           ══════════════════════════════════════════════ */
        .quest-action-bar {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;
            padding: 10px; background: rgba(184,134,11,0.06);
            border: 1px solid rgba(184,134,11,0.3); border-radius: 6px;
        }
        .quest-act-btn {
            padding: 7px 14px; border: none; border-radius: 5px; cursor: pointer;
            font-family: 'Cinzel', serif; font-size: 0.82em; font-weight: 700;
            transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .quest-act-btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.25); }
        .qab-save { background: linear-gradient(145deg, var(--gold), #966f0a); color: white; }
        .qab-print { background: linear-gradient(145deg, #2c3e50, #1a252f); color: white; }
        .qab-map  { background: linear-gradient(145deg, #27ae60, #1e8449); color: white; }
        .saved-quests-list {
            max-height: 200px; overflow-y: auto; margin-top: 8px;
            scrollbar-width: thin; scrollbar-color: var(--gold) var(--paper-dark);
        }
        .saved-quest-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 7px 10px; border: 1px solid var(--gold); border-radius: 5px;
            margin-bottom: 5px; background: rgba(184,134,11,0.05);
            transition: all 0.2s; cursor: pointer; font-size: 0.88em;
        }
        .saved-quest-item:hover { background: rgba(184,134,11,0.12); border-color: var(--red); }
        .saved-quest-name { font-family: 'Cinzel', serif; font-weight: 700; color: var(--red-dark); font-size: 0.9em; }
        .saved-quest-meta { font-size: 0.75em; color: #888; margin-top: 1px; }

        /* ══════════════════════════════════════════════
           INITIATIVE - PLAYER INPUT ROW
           ══════════════════════════════════════════════ */
        .player-init-row {
            display: flex; align-items: center; gap: 6px; padding: 5px 8px;
            background: rgba(255,255,255,0.06); border: 1px solid rgba(184,134,11,0.2);
            border-radius: 5px; margin-bottom: 4px;
        }
        .player-init-name { flex: 1; font-family: 'Cinzel', serif; font-size: 0.82em; color: var(--gold-light); font-weight: 700; }
        .player-init-input {
            width: 54px; padding: 4px 6px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(184,134,11,0.4); color: white;
            border-radius: 4px; font-family: 'Cinzel', serif; font-size: 0.85em;
            text-align: center;
        }
        .player-init-input:focus { outline: none; border-color: var(--gold); }
        .btn-add-to-init {
            padding: 5px 10px; background: linear-gradient(145deg, var(--gold), #966f0a);
            color: white; border: none; border-radius: 4px; cursor: pointer;
            font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700;
            transition: all 0.2s;
        }
        .btn-add-to-init:hover { background: var(--gold-light); }

        /* ══════════════════════════════════════════════
           BOUNTY BOARD QUEST SECTION MOVE
           ══════════════════════════════════════════════ */
        .bounty-in-quest {
            margin-top: 14px; padding: 12px;
            background: rgba(184,134,11,0.06);
            border: 2px solid var(--gold); border-radius: 8px;
        }
        .bounty-in-quest-header {
            font-family: 'Cinzel', serif; color: var(--gold); font-weight: 700;
            font-size: 0.9em; margin-bottom: 8px;
        }

        /* Quest panel full-width under NPC area */
        #questGeneratorPanel {
            grid-column: 1 / -1;
        }

        /* ══════════════════════════════════════════════
           CUSTOM TITLE BAR (Electron: minimise, fullscreen, close)
           Always on top; nothing may overlap the window controls.
           ══════════════════════════════════════════════ */
        .electron-title-bar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: var(--z-title-bar);
            height: 36px;
            min-height: 36px;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(180deg, #1a1525 0%, #0f0d18 100%);
            border-bottom: 2px solid rgba(184, 134, 11, 0.5);
            padding: 0 0 0 12px;
            -webkit-app-region: drag;
            user-select: none;
            isolation: isolate;
            pointer-events: auto;
        }
        /* Native OS title bar used; custom title bar hidden */
        body.electron .electron-title-bar { display: none !important; }
        /* All overlays (modals) sit below title bar, above start screen */
        .app-modal { z-index: var(--z-modals); }
        .electron-title-bar .title-bar-drag {
            flex: 1;
            -webkit-app-region: drag;
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
            font-weight: 700;
            color: rgba(218, 165, 32, 0.9);
            letter-spacing: 2px;
        }
        .electron-title-bar .title-bar-controls {
            display: flex;
            align-items: stretch;
            -webkit-app-region: no-drag;
            flex-shrink: 0;
            min-width: 138px;
            visibility: visible;
            pointer-events: auto;
        }
        .electron-title-bar .title-bar-btn {
            width: 46px;
            min-width: 46px;
            height: 36px;
            min-height: 36px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.85);
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s, color 0.15s;
            visibility: visible;
            pointer-events: auto;
            flex-shrink: 0;
        }
        .electron-title-bar .title-bar-btn:hover {
            background: rgba(184, 134, 11, 0.2);
            color: var(--gold-light);
        }
        .electron-title-bar .title-bar-btn.close-btn:hover {
            background: rgba(139, 0, 0, 0.6);
            color: #fff;
        }
        .electron-title-bar .title-bar-btn svg {
            width: 12px;
            height: 12px;
            fill: currentColor;
            flex-shrink: 0;
            display: block;
        }
        .electron-title-bar .title-bar-btn svg[stroke] {
            fill: none;
        }
        /* ══════════════════════════════════════════════
           DM HEADER & MODE TABS
           ══════════════════════════════════════════════ */
        .main-wrapper { max-width: 1440px; margin: 0 auto; padding: 0 20px; }
        .dm-header {
            display: flex; align-items: center; gap: 12px; padding: 16px 0 14px;
            border-bottom: 3px double var(--gold); margin-bottom: 20px; flex-wrap: wrap;
        }
        .dm-header-title {
            font-family: 'Cinzel', serif; font-weight: 900; font-size: 1.5em;
            color: var(--gold-light); letter-spacing: 3px; text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); white-space: nowrap; flex-shrink: 0;
        }
        .left-panel { display: none !important; }
        .dm-mode-tabs {
            display: flex; gap: 8px; flex-shrink: 0;
        }
        .dm-mode-tab {
            display: flex; flex-direction: column; align-items: center; gap: 1px;
            padding: 10px 22px; border: 2px solid rgba(184,134,11,0.4);
            border-radius: 8px; cursor: pointer; font-family: 'Cinzel', serif;
            background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.5);
            transition: all 0.25s; min-width: 160px;
        }
        .dm-mode-tab:hover {
            border-color: var(--gold); color: var(--gold-light);
            background: rgba(184,134,11,0.1);
        }
        .dm-mode-tab.active {
            border-color: var(--gold); background: linear-gradient(145deg, rgba(184,134,11,0.25), rgba(184,134,11,0.1));
            color: var(--gold-light); box-shadow: 0 4px 16px rgba(184,134,11,0.25);
        }
        .dm-mode-icon { font-size: 1.4em; line-height: 1; }
        .dm-mode-label { font-size: 0.9em; font-weight: 700; letter-spacing: 0.5px; }
        .dm-mode-hint { font-size: 0.7em; opacity: 0.7; font-family: 'Crimson Text', serif; font-style: italic; }
        .dm-header-quick { display: flex; gap: 6px; margin-left: auto; flex-shrink: 0; }
        .dm-quick-btn {
            width: 38px; height: 38px; border-radius: 8px; border: 1px solid rgba(184,134,11,0.35);
            background: rgba(255,255,255,0.05); cursor: pointer; font-size: 1.1em;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .dm-quick-btn:hover { background: rgba(184,134,11,0.2); border-color: var(--gold); }

        /* Adjust main-container to use full wrapper width */
        .main-container { max-width: 100%; margin: 0; padding: 0; }
        body { padding: 0; }
        .main-wrapper { padding: 16px 24px 30px; }

        /* Quest mode sidebar helper panel */
        .quest-mode-wrapper { display: grid; grid-template-columns: 300px 1fr; gap: 20px; align-items: start; }
        .quest-sidebar {
            background: linear-gradient(145deg, var(--paper), var(--paper-dark));
            border: 3px double var(--gold); border-radius: 8px; padding: 18px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3); position: sticky; top: 20px; max-height: calc(100vh - 40px);
            overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--gold) var(--paper-dark);
        }
        .quest-sidebar::-webkit-scrollbar { width: 5px; }
        .quest-sidebar::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 3px; }
        .quest-sidebar-title {
            font-family: 'Cinzel', serif; color: var(--red); font-weight: 700; font-size: 0.95em;
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
            border-bottom: 2px solid var(--gold); padding-bottom: 6px;
        }
        .quest-sidebar-btn {
            width: 100%; padding: 9px 12px; margin-bottom: 6px; border: 2px solid rgba(184,134,11,0.4);
            border-radius: 6px; background: rgba(184,134,11,0.06); cursor: pointer;
            font-family: 'Cinzel', serif; font-size: 0.82em; font-weight: 700; color: var(--red-dark);
            text-align: left; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .quest-sidebar-btn:hover { background: rgba(184,134,11,0.15); border-color: var(--gold); color: var(--red); }
        .quest-sidebar-btn-icon { font-size: 1.1em; }

        /* Override quest panel grid-column when in quest mode layout */
        .quest-mode-wrapper #questGeneratorPanel { grid-column: auto; }

        /* Party member grouping */
        .party-group-header {
            font-family: 'Cinzel', serif; font-size: 0.78em; font-weight: 700;
            color: var(--gold); text-transform: uppercase; letter-spacing: 1px;
            background: rgba(184,134,11,0.12); border: 1px solid rgba(184,134,11,0.3);
            border-radius: 4px; padding: 3px 8px; margin: 8px 0 4px;
        }
        .party-member-row { cursor: pointer; }
        .party-member-row:hover { background: rgba(255,255,255,0.6) !important; border-color: var(--gold); }

        /* ══════════════════════════════════════════════════════════════
           GLOBAL ENHANCEMENT LAYER (quality + motion + polish)
           ══════════════════════════════════════════════════════════════ */
        :root {
            --fx-ease-out: cubic-bezier(0.22, 1, 0.36, 1);
            --fx-ease-soft: cubic-bezier(0.4, 0, 0.2, 1);
            --fx-shadow-soft: 0 10px 28px rgba(0,0,0,0.28);
            --fx-shadow-strong: 0 16px 42px rgba(0,0,0,0.4);
        }

        html { scroll-behavior: smooth; }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: -1;
            background:
                radial-gradient(750px 460px at 12% 8%, rgba(184,134,11,0.06), transparent 70%),
                radial-gradient(680px 380px at 88% 92%, rgba(139,0,0,0.08), transparent 72%);
            animation: dmAtmosDrift 16s var(--fx-ease-soft) infinite alternate;
        }

        .dm-header,
        .controls,
        .quest-sidebar,
        .npc-tabs-container,
        .npc-card,
        .left-panel,
        #playerQuickInfoModal > div {
            will-change: transform, box-shadow;
            transition: transform 280ms var(--fx-ease-out), box-shadow 280ms var(--fx-ease-out), border-color 220ms var(--fx-ease-soft);
        }

        .controls:hover,
        .quest-sidebar:hover,
        .npc-card:hover {
            box-shadow: var(--fx-shadow-strong);
            transform: translateY(-1px);
        }

        button,
        .dm-mode-tab,
        .dm-quick-btn,
        .lp-btn,
        .quest-sidebar-btn,
        .party-hp-btn,
        .spell-level-option,
        .player-health-tab {
            transition:
                transform 180ms var(--fx-ease-out),
                box-shadow 220ms var(--fx-ease-soft),
                filter 200ms var(--fx-ease-soft),
                border-color 200ms var(--fx-ease-soft),
                background-color 200ms var(--fx-ease-soft);
            will-change: transform;
        }

        button:hover,
        .dm-mode-tab:hover,
        .dm-quick-btn:hover,
        .lp-btn:hover,
        .quest-sidebar-btn:hover,
        .party-hp-btn:hover,
        .spell-level-option:hover,
        .player-health-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--fx-shadow-soft);
        }

        button:active,
        .dm-mode-tab:active,
        .dm-quick-btn:active,
        .lp-btn:active,
        .quest-sidebar-btn:active,
        .party-hp-btn:active,
        .spell-level-option:active,
        .player-health-tab:active {
            transform: translateY(0);
            filter: brightness(0.96);
        }

        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        .dm-mode-tab:focus-visible,
        .dm-quick-btn:focus-visible,
        .lp-btn:focus-visible,
        .quest-sidebar-btn:focus-visible {
            outline: 2px solid rgba(218,165,32,0.95);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(218,165,32,0.22);
        }

        /* Shared reveal classes for dynamic sections */
        .dm-reveal-item {
            animation: dmRevealUp 420ms var(--fx-ease-out) both;
            transform-origin: center bottom;
        }

        #playerQuickInfoModal,
        #partyModal,
        #liveDMToolsModal,
        #homebrewModal {
            backdrop-filter: blur(6px);
        }

        @keyframes dmRevealUp {
            from { opacity: 0; transform: translateY(10px) scale(0.992); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes dmAtmosDrift {
            0% { transform: translate3d(0, 0, 0); opacity: 0.85; }
            100% { transform: translate3d(0, -10px, 0); opacity: 1; }
        }

        @media (prefers-reduced-motion: reduce) {
            html { scroll-behavior: auto; }
            *, *::before, *::after {
                animation-duration: 0.001ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.001ms !important;
                scroll-behavior: auto !important;
            }
            body::before { animation: none !important; }
        }

        </style>
</head>
<body>
<script>document.body.classList.add('loading');</script>
<!-- ══════════════════════════════════════════════════════════════
     PROFESSIONAL LOADING SCREEN — must be FIRST in body for instant render
     ══════════════════════════════════════════════════════════════ -->
<div id="loading-screen" role="progressbar" aria-label="Loading NPC Generator">
    <canvas id="loading-particles"></canvas>

    <div class="loader-rune-wrapper">
        <div class="loader-rune-ring ring1"></div>

        <div class="loader-rune-ring ring2"></div>
        <div class="loader-rune-ring ring3"></div>
        <div class="loader-orbit"><div class="loader-orbit-dot"></div></div>
        <div class="loader-orbit b"><div class="loader-orbit-dot"></div></div>
        <div class="loader-rune-center">
            <div class="loader-d20">⚄</div>
        </div>
    </div>

    <div class="loader-title">DND DM Helper</div>
    <div class="loader-subtitle">Forge Your Story</div>

    <div class="loader-bar-wrap">
        <div class="loader-bar-fill" id="loader-bar"></div>
    </div>
    <div class="loader-status" id="loader-status">Initialising Realms<span class="loader-dots"></span></div>

    <div class="loader-divider"></div>

    <div class="loader-credit">Made by <span>Conrajon</span></div>
</div>
<script>
(function(){
  var el = document.getElementById('loading-screen');
  var bar = document.getElementById('loader-bar');
  var statusEl = document.getElementById('loader-status');
  var canvas = document.getElementById('loading-particles');
  if (!el) return;
  var steps = [
    { pct: 10,  msg: 'Summoning Race Lore…' },
    { pct: 22,  msg: 'Forging Class Abilities…' },
    { pct: 35,  msg: 'Rolling Ability Scores…' },
    { pct: 48,  msg: 'Equipping Adventurers…' },
    { pct: 60,  msg: 'Scribing Spell Scrolls…' },
    { pct: 72,  msg: 'Binding the Tome…' },
    { pct: 82,  msg: 'Painting Portraits…' },
    { pct: 91,  msg: 'Opening the Gateway…' },
    { pct: 100, msg: 'Ready!' }
  ];
  var step = 0;
  var start = Date.now();
  var minShow = 2600;
  var dots = 0;

  function dismiss() {
    if (!el || !el.parentNode) return;
    document.body.classList.remove('loading');
    document.body.classList.add('start-screen-only');
    el.style.transition = 'opacity 0.7s ease, transform 0.7s ease';
    el.style.opacity = '0';
    el.style.transform = 'scale(1.03)';
    el.style.pointerEvents = 'none';
    setTimeout(function(){ if (el && el.parentNode) el.parentNode.removeChild(el); }, 750);
  }
  function tryDismiss() {
    var elapsed = Date.now() - start;
    var wait = Math.max(0, minShow - elapsed);
    setTimeout(dismiss, wait > 0 ? wait : 200);
  }

  function advanceStep() {
    if (step >= steps.length) return;
    var s = steps[step++];
    if (bar) bar.style.width = s.pct + '%';
    if (statusEl) statusEl.textContent = s.msg;
  }
  advanceStep();
  setInterval(advanceStep, 280);

  setInterval(function(){
    if (step > 0 || !statusEl || !document.getElementById('loading-screen')) return;
    dots = (dots % 3) + 1;
    statusEl.innerHTML = 'Initialising Realms<span class="loader-dots">' + '.'.repeat(dots) + '</span>';
  }, 400);

  if (document.readyState === 'complete') tryDismiss();
  else window.addEventListener('load', tryDismiss);
  setTimeout(function(){ if (document.getElementById('loading-screen')) tryDismiss(); }, 4200);
  setTimeout(function(){ if (el && el.parentNode) dismiss(); }, 7000);

  if (canvas) {
    var ctx = canvas.getContext('2d');
    var w = canvas.width = window.innerWidth;
    var h = canvas.height = window.innerHeight;
    window.addEventListener('resize', function(){ w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; });
    var parts = [];
    for (var i = 0; i < 70; i++) parts.push({
      x: Math.random()*w, y: Math.random()*h, r: Math.random()*2+0.5,
      vx: (Math.random()-0.5)*0.4, vy: -(Math.random()*0.5+0.1),
      a: Math.random()*0.6+0.2, c: Math.random()>0.5?'#daa520':'#8b0000',
      life: 1, d: Math.random()*0.004+0.001
    });
    function draw(){
      if (!document.getElementById('loading-screen')) return;
      ctx.clearRect(0,0,w,h);
      for (var i = 0; i < parts.length; i++) {
        var p = parts[i];
        p.x += p.vx; p.y += p.vy; p.life -= p.d;
        if (p.life <= 0 || p.y < -5) {
          p.x = Math.random()*w; p.y = h+5; p.life = 1; p.d = Math.random()*0.004+0.001;
        }
        ctx.globalAlpha = p.a * p.life;
        ctx.fillStyle = p.c;
        ctx.shadowColor = p.c;
        ctx.shadowBlur = 8;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;
      }
      requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);
  }
})();
</script>

<!-- Sound Board Pop-out (LEFT side, bottom) -->
<div id="soundBoardPopout" class="sb-collapsed">
    <div style="display:flex;align-items:stretch;height:100%;">
        <div style="background:linear-gradient(145deg,#1a2e1a,#16213e);border:2px solid rgba(80,160,80,0.5);border-right:none;border-radius:0 8px 8px 0;padding:12px;width:300px;max-height:380px;display:flex;flex-direction:column;box-shadow:4px 0 20px rgba(0,0,0,0.5);">
            <div style="font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;color:#90ee90;margin-bottom:8px;border-bottom:1px solid rgba(80,160,80,0.3);padding-bottom:6px;">🔊 Sound Board</div>
            <div style="margin-bottom:6px;"><label style="font-size:0.75em;color:rgba(255,255,255,0.7);">Volume </label><input type="range" id="soundBoardMasterVol" min="0" max="100" value="80" style="width:100%;accent-color:var(--gold);" oninput="soundBoardSetMasterVolume(this.value)"></div>
            <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px;">
                <select id="soundBoardCategory" style="flex:1;min-width:0;padding:4px;font-size:0.78em;border:1px solid rgba(80,160,80,0.4);background:#0d0d1a;color:#90ee90;border-radius:4px;" onchange="soundBoardRenderList()">
                    <option value="tavern">Tavern</option>
                    <option value="forest">Forest</option>
                    <option value="combat">Combat</option>
                    <option value="town">Town</option>
                    <option value="dungeon">Dungeon</option>
                    <option value="custom">My Sounds</option>
                </select>
                <label style="cursor:pointer;margin:0;font-size:0.78em;color:#90ee90;"><input type="file" accept="audio/*" id="soundBoardUploadInput" style="display:none;" onchange="soundBoardHandleUpload(event)">➕ Upload</label>
            </div>
            <div id="soundBoardList" style="flex:1;overflow-y:auto;max-height:240px;display:flex;flex-direction:column;gap:4px;"></div>
        </div>
        <div class="sb-tab" onclick="toggleSoundBoardPopout()">🔊 SOUND BOARD</div>
    </div>
</div>

<!-- Session Notes Pop-out Panel (LEFT side, near bottom) -->
<div id="sessionNotesPopout" class="sn-collapsed">
    <div style="display:flex;align-items:stretch;height:100%;">
        <!-- Panel -->
        <div style="background:linear-gradient(145deg,#1a1a2e,#16213e);border:2px solid rgba(160,80,255,0.5);border-right:none;border-radius:0 8px 8px 0;padding:14px;width:320px;max-height:420px;display:flex;flex-direction:column;box-shadow:4px 0 20px rgba(0,0,0,0.5);">
            <div style="font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;color:#c080ff;margin-bottom:10px;border-bottom:1px solid rgba(160,80,255,0.3);padding-bottom:6px;display:flex;justify-content:space-between;align-items:center;">
                📝 Session Notes
                <select id="notesDropdownPopout" style="font-family:'Cinzel',serif;font-size:0.7em;padding:3px;border:1px solid rgba(160,80,255,0.4);background:#0d0d1a;color:#c080ff;border-radius:4px;" onchange="loadNotePopout()">
                    <option value="">-- New Note --</option>
                </select>
            </div>
            <input id="notesTitlePopout" placeholder="Note title..." style="padding:6px 8px;border:1px solid rgba(160,80,255,0.4);background:rgba(255,255,255,0.05);color:#e0d0ff;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;margin-bottom:8px;">
            <textarea id="notesTextareaPopout" placeholder="Session notes, plot hooks, important events..." style="flex:1;padding:8px;border:1px solid rgba(160,80,255,0.4);background:rgba(255,255,255,0.05);color:#e0d0ff;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;resize:none;min-height:180px;line-height:1.5;"></textarea>
            <div style="display:flex;gap:6px;margin-top:8px;">
                <button onclick="saveNotePopout()" style="flex:1;padding:7px;background:linear-gradient(145deg,#4a2060,#7a30a0);color:#e8d8ff;border:none;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;">💾 Save</button>
                <button onclick="newNotePopout()" style="padding:7px 12px;background:rgba(160,80,255,0.15);color:#c080ff;border:1px solid rgba(160,80,255,0.3);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">+ New</button>
                <button onclick="deleteNotePopout()" style="padding:7px 12px;background:rgba(139,0,0,0.2);color:#f08080;border:1px solid rgba(139,0,0,0.3);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">Del</button>
            </div>
        </div>
        <!-- Tab (now on the right edge of the notes panel) -->
        <div class="sn-tab" onclick="toggleSessionNotesPopout()">
            📝 SESSION NOTES
        </div>
    </div>
</div>

<!-- Roll History Log Panel (RIGHT side, bottom) -->
<div id="rollLogPanel" style="position:fixed;right:0;bottom:18px;z-index:4500;transition:transform 0.3s ease;transform:translateX(calc(100% - 36px));">
    <div style="display:flex;align-items:stretch;height:100%;">
        <!-- Tab -->
        <div onclick="toggleRollLog()" style="writing-mode:vertical-rl;text-orientation:mixed;background:linear-gradient(180deg,#7a4a20,#b8860b);color:#fff3c0;padding:12px 8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.72em;font-weight:700;letter-spacing:1px;border-radius:8px 0 0 8px;display:flex;align-items:center;gap:6px;white-space:nowrap;min-height:110px;user-select:none;border:1px solid rgba(218,165,32,0.5);border-right:none;box-shadow:-4px 0 16px rgba(0,0,0,0.6);">
            🎲 Roll Log
        </div>
        <!-- Panel -->
        <div style="background:linear-gradient(145deg,#1a1a2e,#101522);border:2px solid rgba(218,165,32,0.55);border-right:none;border-radius:8px 0 0 8px;padding:10px 12px;width:280px;max-height:260px;display:flex;flex-direction:column;box-shadow:-4px 0 20px rgba(0,0,0,0.7);">
            <div style="font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;color:#f5deb3;margin-bottom:6px;border-bottom:1px solid rgba(218,165,32,0.4);padding-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
                <span>🎲 Roll Log</span>
                <button onclick="clearRollLog()" style="padding:4px 8px;font-size:0.7em;border-radius:4px;border:1px solid rgba(218,165,32,0.4);background:rgba(0,0,0,0.4);color:#f5deb3;cursor:pointer;">Clear</button>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">
                <button type="button" onclick="dmRollDice(4)" style="padding:4px 8px;font-size:0.72em;border-radius:4px;border:1px solid rgba(218,165,32,0.5);background:rgba(218,165,32,0.15);color:#f5deb3;cursor:pointer;font-weight:700;">d4</button>
                <button type="button" onclick="dmRollDice(6)" style="padding:4px 8px;font-size:0.72em;border-radius:4px;border:1px solid rgba(218,165,32,0.5);background:rgba(218,165,32,0.15);color:#f5deb3;cursor:pointer;font-weight:700;">d6</button>
                <button type="button" onclick="dmRollDice(8)" style="padding:4px 8px;font-size:0.72em;border-radius:4px;border:1px solid rgba(218,165,32,0.5);background:rgba(218,165,32,0.15);color:#f5deb3;cursor:pointer;font-weight:700;">d8</button>
                <button type="button" onclick="dmRollDice(10)" style="padding:4px 8px;font-size:0.72em;border-radius:4px;border:1px solid rgba(218,165,32,0.5);background:rgba(218,165,32,0.15);color:#f5deb3;cursor:pointer;font-weight:700;">d10</button>
                <button type="button" onclick="dmRollDice(12)" style="padding:4px 8px;font-size:0.72em;border-radius:4px;border:1px solid rgba(218,165,32,0.5);background:rgba(218,165,32,0.15);color:#f5deb3;cursor:pointer;font-weight:700;">d12</button>
                <button type="button" onclick="dmRollDice(20)" style="padding:4px 8px;font-size:0.72em;border-radius:4px;border:1px solid rgba(218,165,32,0.5);background:rgba(218,165,32,0.15);color:#f5deb3;cursor:pointer;font-weight:700;">d20</button>
            </div>
            <div style="display:flex;gap:4px;margin-bottom:6px;">
                <input type="text" id="dmDiceFormulaInput" placeholder="e.g. 2d6+3" style="flex:1;min-width:0;padding:4px 8px;font-size:0.8em;border-radius:4px;border:1px solid rgba(218,165,32,0.4);background:rgba(0,0,0,0.35);color:#f5deb3;">
                <button type="button" onclick="dmRollDiceFormula()" style="padding:4px 8px;font-size:0.72em;border-radius:4px;border:1px solid rgba(218,165,32,0.5);background:rgba(218,165,32,0.2);color:#f5deb3;cursor:pointer;font-weight:700;">Roll</button>
            </div>
            <div id="rollLogList" style="flex:1;overflow-y:auto;max-height:200px;"></div>
        </div>
    </div>
</div>

<!-- Spell List Panel (RIGHT side, upper) -->
<div id="spellListPanel" style="position:fixed;right:0;top:88px;z-index:4499;transition:transform 0.3s ease;transform:translateX(calc(100% - 36px));">
    <div style="display:flex;align-items:stretch;height:100%;">
        <!-- Tab -->
        <div onclick="toggleSpellList()" style="writing-mode:vertical-rl;text-orientation:mixed;background:linear-gradient(180deg,#1b4f72,#2980b9);color:#e0f4ff;padding:12px 8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.72em;font-weight:700;letter-spacing:1px;border-radius:8px 0 0 8px;display:flex;align-items:center;gap:6px;white-space:nowrap;min-height:130px;user-select:none;border:1px solid rgba(52,152,219,0.6);border-right:none;box-shadow:-4px 0 16px rgba(0,0,0,0.6);">
            ✨ Spell List
        </div>
        <!-- Panel -->
        <div style="background:linear-gradient(145deg,#0b1b2e,#0a2238);border:2px solid rgba(52,152,219,0.65);border-right:none;border-radius:8px 0 0 8px;padding:10px 12px;width:320px;max-height:420px;display:flex;flex-direction:column;box-shadow:-4px 0 22px rgba(0,0,0,0.7);">
            <div class="spell-list-header" style="cursor:default;">
                <span>✨ Spell List</span>
            </div>
            <input type="text" id="spellListSearch" placeholder="Search spells..." oninput="filterSpellList(false)">
            <select id="spellListLevelFilter" onchange="filterSpellList(true)">
                <option value="">All Levels</option>
                <option value="cantrip">Cantrip</option>
                <option value="1">Level 1</option>
                <option value="2">Level 2</option>
                <option value="3">Level 3</option>
                <option value="4">Level 4</option>
                <option value="5">Level 5</option>
                <option value="6">Level 6</option>
                <option value="7">Level 7</option>
                <option value="8">Level 8</option>
                <option value="9">Level 9</option>
            </select>
            <div id="spellListContent"></div>
            <div class="spell-list-favorites">
                <div class="spell-list-fav-header">⭐ Favorites</div>
                <div id="spellListFavorites"></div>
            </div>
        </div>
    </div>
</div>

<!-- Locations Panel -->
<!-- ══ LEFT SLIDING PANEL: Party Tracker ══ -->
<div class="left-panel lp-collapsed" id="panelParty">
    <div class="lp-header" onclick="toggleLeftPanel('panelParty')">
        <span>👥 Players</span>
        <button class="lp-toggle-btn" id="panelPartyIcon">▶</button>
    </div>
    <div class="lp-body" id="panelPartyBody">
        <div style="display:flex;gap:4px;margin-bottom:8px;">
            <button class="lp-btn lp-btn-red" style="flex:1;" onclick="addPartyMember()">+ Add Player</button>
            <button class="lp-btn" style="background:rgba(139,0,0,0.4);color:#f08080;flex:0 0 auto;width:auto;padding:8px 10px;" onclick="clearAllPartyMembers()" title="Clear All">✕</button>
        </div>
        <div id="lpPartyList"><div style="color:rgba(184,134,11,0.45);font-size:0.8em;text-align:center;padding:10px;">No players added.</div></div>
    </div>
</div>

<!-- ══ LEFT SLIDING PANEL: NPC Generator ══ -->
<div class="left-panel lp-collapsed" id="panelNPC">
    <div class="lp-header" onclick="toggleLeftPanel('panelNPC')">
        <span>🧙 NPC Generator</span>
        <button class="lp-toggle-btn" id="panelNPCIcon">▶</button>
    </div>
    <div class="lp-body" id="panelNPCBody">
        <div class="lp-section-title">Generate Settings</div>
        <label>Race</label>
        <select id="lpRaceSel" onchange="document.getElementById('raceSel').value=this.value"><option value="">Random</option></select>
        <label>Class</label>
        <select id="lpClassSel" onchange="document.getElementById('classSel').value=this.value"><option value="">Random</option></select>
        <label>Level</label>
        <select id="lpLvlSel" onchange="document.getElementById('lvlSel').value=this.value">
            <option value="">Random</option>
            <script>for(let i=1;i<=20;i++) document.write(`<option value="${i}">Level ${i}</option>`);</script>
        </select>
        <label>Quantity</label>
        <input type="number" id="lpQtyInput" value="1" min="1" max="10" onchange="document.getElementById('qtyInput').value=this.value">
        <div class="lp-checkbox-row" style="margin-bottom:8px;">
            <input type="checkbox" id="lpBossMode" onchange="document.getElementById('bossMode').checked=this.checked">
            <label for="lpBossMode">Boss Mode (Legendary)</label>
        </div>
        <div style="margin:6px 0 4px;">
            <button type="button" onclick="var b=document.getElementById('lpNpcAdvOpts');var a=this;if(b.style.display==='none'){b.style.display='block';a.innerHTML='▼ Advanced';}else{b.style.display='none';a.innerHTML='▶ Advanced';}" style="background:none;border:none;color:#daa520;font-family:'Cinzel',serif;font-size:0.72em;font-weight:700;cursor:pointer;padding:0;letter-spacing:0.5px;">▶ Advanced</button>
        </div>
        <div id="lpNpcAdvOpts" style="display:none;background:rgba(30,20,10,0.5);border:1px solid rgba(139,69,19,0.35);border-radius:5px;padding:8px 10px;margin-bottom:8px;font-size:0.85em;">
            <label style="color:#daa520;font-size:0.8em;margin-bottom:2px;">Source</label>
            <select id="lpContentSource" onchange="document.getElementById('npcContentSource').value=this.value" style="width:100%;margin-bottom:6px;">
                <option value="all">All Content</option>
                <option value="official">Official Only</option>
                <option value="homebrew">Homebrew Only</option>
            </select>
            <label style="color:#daa520;font-size:0.8em;margin-bottom:2px;">Gender</label>
            <select id="lpGenderPref" onchange="document.getElementById('npcGenderPref').value=this.value" style="width:100%;margin-bottom:6px;">
                <option value="">Random</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
            </select>
            <label style="color:#daa520;font-size:0.8em;margin-bottom:2px;">Alignment</label>
            <select id="lpAlignmentPref" onchange="document.getElementById('npcAlignmentPref').value=this.value" style="width:100%;margin-bottom:6px;">
                <option value="">Random</option>
                <option value="lawful good">Lawful Good</option>
                <option value="neutral good">Neutral Good</option>
                <option value="chaotic good">Chaotic Good</option>
                <option value="lawful neutral">Lawful Neutral</option>
                <option value="true neutral">True Neutral</option>
                <option value="chaotic neutral">Chaotic Neutral</option>
                <option value="lawful evil">Lawful Evil</option>
                <option value="neutral evil">Neutral Evil</option>
                <option value="chaotic evil">Chaotic Evil</option>
            </select>
            <div class="lp-checkbox-row" style="margin-bottom:4px;">
                <input type="checkbox" id="lpForceSpellcaster" onchange="document.getElementById('npcForceSpellcaster').checked=this.checked;if(this.checked)document.getElementById('lpForceMartial').checked=false;document.getElementById('npcForceMartial').checked=false;">
                <label for="lpForceSpellcaster" style="font-size:0.82em;">Spellcaster Only</label>
            </div>
            <div class="lp-checkbox-row">
                <input type="checkbox" id="lpForceMartial" onchange="document.getElementById('npcForceMartial').checked=this.checked;if(this.checked)document.getElementById('lpForceSpellcaster').checked=false;document.getElementById('npcForceSpellcaster').checked=false;">
                <label for="lpForceMartial" style="font-size:0.82em;">Martial Only</label>
            </div>
        </div>
        <button class="lp-btn lp-btn-red" onclick="lpGenerateNPCs()">⚔ Generate NPCs</button>
        <div class="lp-section-title">Quick Generate</div>
        <button class="lp-btn lp-btn-gold" onclick="generateGroup()">Generate Group</button>
        <button class="lp-btn lp-btn-gold" onclick="generateStorefront()">Generate Shopkeeper</button>
        <div class="lp-section-title" style="margin-top:10px;">🐉 Monster Generator</div>
        <button class="lp-btn" style="background:linear-gradient(145deg,#8b0000,#5a0000);color:#fff8dc;border:1px solid rgba(184,134,11,0.5);" onclick="switchGenMode('monster');if(typeof generateMonsterBatch==='function')generateMonsterBatch();">🐉 Random Monster</button>
        <button class="lp-btn" style="background:linear-gradient(145deg,#4a0000,#2a0000);color:#ff8a8a;border:1px solid rgba(255,100,100,0.3);" onclick="switchGenMode('monster');document.getElementById('monBoss').checked=true;if(typeof generateMonsterBatch==='function')generateMonsterBatch();">👹 Random Boss</button>
    </div>
</div>


<!-- ── Encounter Difficulty Calculator Modal ── -->
<div id="encounterCalcModal">
    <div class="encounter-calc-panel">
        <h3>⚔️ Encounter Difficulty Calculator</h3>
        <div class="enc-grid">
            <div class="enc-field"><label>Party Size</label><input type="number" id="encPartySize" value="4" min="1" max="10"></div>
            <div class="enc-field"><label>Party Level</label><input type="number" id="encPartyLevel" value="5" min="1" max="20"></div>
            <div class="enc-field"><label>Number of Enemies</label><input type="number" id="encEnemyCount" value="1" min="1" max="20"></div>
            <div class="enc-field"><label>Enemy CR / Level</label><input type="number" id="encEnemyCR" value="3" min="0" max="30" step="0.25"></div>
        </div>
        <div style="margin-bottom:10px;">
            <label style="font-family:'Cinzel',serif;font-size:0.8em;color:var(--red);font-weight:700;display:block;margin-bottom:4px;">Use Generated NPCs?</label>
            <button onclick="loadGeneratedNPCsIntoCalc()" style="padding:7px 14px;background:var(--red);color:white;border:none;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;">Load Current NPCs as Enemies</button>
        </div>
        <button onclick="calculateEncounterDifficulty()" style="width:100%;padding:11px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:1em;font-weight:700;letter-spacing:1px;margin-bottom:10px;">Calculate Difficulty</button>
        <div id="encounterResult" style="display:none;"></div>
        <div style="text-align:center;margin-top:12px;"><button onclick="closeEncounterCalc()" style="padding:8px 24px;background:#555;color:white;border:none;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;">Close</button></div>
    </div>
</div>

<!-- ── NPC Edit Modal ── -->
<div id="npcEditModal">
    <div class="npc-edit-panel">
        <h3>✏️ Edit NPC</h3>
        <input type="hidden" id="editNpcId">
        <div class="edit-grid">
            <div class="edit-field" style="grid-column:1/-1;"><label>Name</label><input type="text" id="editName"></div>
            <div class="edit-field"><label>Race</label><select id="editRace"></select></div>
            <div class="edit-field"><label>Class</label><select id="editClass"></select></div>
            <div class="edit-field"><label>Level</label><input type="number" id="editLevel" min="1" max="20"></div>
            <div class="edit-field"><label>Max HP</label><input type="number" id="editHPMax" min="1"></div>
            <div class="edit-field"><label>AC</label><input type="number" id="editAC" min="1"></div>
            <div class="edit-field"><label>Speed (ft)</label><input type="number" id="editSpeed" min="0"></div>
            <div class="edit-field"><label>Alignment</label><select id="editAlignment">
                <option value="LG">Lawful Good</option><option value="NG">Neutral Good</option>
                <option value="CG">Chaotic Good</option><option value="LN">Lawful Neutral</option>
                <option value="TN">True Neutral</option><option value="CN">Chaotic Neutral</option>
                <option value="LE">Lawful Evil</option><option value="NE">Neutral Evil</option>
                <option value="CE">Chaotic Evil</option>
            </select></div>
            <div class="edit-field"><label>Gold (gp)</label><input type="number" id="editGold" min="0" value="0"></div>
        </div>
        <div style="font-family:'Cinzel',serif;font-size:0.8em;color:var(--red);font-weight:700;margin-bottom:7px;text-transform:uppercase;letter-spacing:0.5px;">Ability Scores</div>
        <div class="edit-stats-grid" id="editStatsGrid"></div>
        <div class="edit-field" style="margin-bottom:12px;"><label>DM Notes</label><textarea id="editDmNotes" rows="3"></textarea></div>
        <div style="display:flex;gap:10px;">
            <button onclick="saveNPCEdit()" style="flex:1;padding:11px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.95em;font-weight:700;">Save Changes</button>
            <button onclick="closeNPCEdit()" style="padding:11px 20px;background:#555;color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;">Cancel</button>
        </div>
    </div>
</div>

<!-- Background particle canvas (main app) -->
<canvas id="bg-particles"></canvas>

<!-- ══ CAMPAIGN START SCREEN ══ -->
<div id="campaignStartScreen">
    <div class="cs-rune">⚔️</div>
    <div class="cs-title">DND DM Helper</div>
    <div class="cs-subtitle">Dungeon Master's Companion</div>
    <div class="cs-divider"></div>

    <!-- Main options: native buttons so clicks always work (Electron-safe) -->
    <div class="cs-options" id="csMainOptions">
        <button type="button" class="cs-card cs-new" id="csBtnNew" onclick="if(typeof csShowNew==='function') csShowNew();">
            <span class="cs-card-icon">✨</span>
            <span class="cs-card-title">New Campaign</span>
            <span class="cs-card-desc">Begin a fresh adventure. Name your campaign, then choose to generate NPCs, quests, or dive straight in.</span>
        </button>
        <button type="button" class="cs-card cs-open" id="csBtnOpen" onclick="if(typeof csShowOpen==='function') csShowOpen();">
            <span class="cs-card-icon">📖</span>
            <span class="cs-card-title">Open Campaign</span>
            <span class="cs-card-desc">Return to an existing campaign. Load your saved NPCs, quests, and party.</span>
        </button>
        <button type="button" class="cs-card cs-oneshot" id="csBtnOneshot" onclick="if(typeof csStartOneShot==='function') csStartOneShot();">
            <span class="cs-card-icon">⚡</span>
            <span class="cs-card-title">One Shot</span>
            <span class="cs-card-desc">Quick session — no name, no saves. Jump straight in and play without leaving a trace.</span>
        </button>
        <button type="button" class="cs-card cs-homebrew" id="csBtnHomebrew" onclick="if(typeof csOpenHomebrewImport==='function') csOpenHomebrewImport();">
            <span class="cs-card-icon">🧪</span>
            <span class="cs-card-title">Import Homebrew</span>
            <span class="cs-card-desc">Load classes, races, spells, items, and other custom content before you start the session.</span>
        </button>
        <button type="button" class="cs-card cs-options-card" id="csBtnOptions" onclick="if(typeof openOptionsModal==='function') openOptionsModal();" style="border-color:rgba(218,165,32,0.5);">
            <span class="cs-card-icon" aria-hidden="true">⚙️</span>
            <span class="cs-card-title">Options</span>
            <span class="cs-card-desc">Display (dark/light theme), AI settings, and more.</span>
        </button>
    </div>

    <!-- New Campaign Panel -->
    <div id="csNewPanel">
        <div style="color:var(--gold-light);font-size:1em;margin-bottom:6px;text-align:center;font-family:'Crimson Text',serif;font-style:italic;">Name your campaign</div>
        <input id="csNewCampaignName" class="cs-input" placeholder="e.g. Curse of Strahd, Homebrew Chronicles..." maxlength="60">
        <div style="display:flex;gap:12px;">
            <button class="cs-btn cs-btn-primary" onclick="csCreateNewCampaignAndLaunch()">Begin Campaign →</button>
            <button class="cs-btn cs-btn-secondary" onclick="csBack()">Back</button>
        </div>
    </div>

    <!-- Post-creation choice panel hidden / not used anymore -->
    <div id="csChoicePanel" style="display:none !important;"></div>

    <!-- Open Campaign Panel -->
    <div id="csOpenPanel">
        <div style="font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;text-align:center;">Saved Campaigns</div>
        <div style="color:rgba(255,255,255,0.55);font-size:0.9em;margin-bottom:8px;text-align:center;font-family:'Crimson Text',serif;font-style:italic;">Select a campaign to load — each campaign's data is kept separate.</div>
        <div class="cs-campaign-list" id="csCampaignList"></div>
        <div id="csNoCampaigns" style="display:none;color:rgba(255,255,255,0.35);font-family:'Crimson Text',serif;font-style:italic;text-align:center;padding:20px;">No saved campaigns found.</div>
        <button class="cs-btn cs-btn-secondary" onclick="csBack()">Back</button>
    </div>

    <div class="cs-back" onclick="csBack()" id="csBackLink" style="display:none;">← Back to options</div>
    <div style="position:absolute;top:16px;right:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div id="csOllamaStatus" style="padding:6px 12px;border-radius:8px;font-family:'Cinzel',serif;font-size:0.72em;font-weight:700;background:rgba(0,0,0,0.35);border:1px solid rgba(184,134,11,0.35);color:rgba(255,255,255,0.7);">Ollama: checking…</div>
      <button type="button" onclick="openOptionsModal('ai')" id="csOllamaInstallBtn" style="display:none;padding:6px 12px;background:rgba(184,134,11,0.3);border:1px solid rgba(218,165,32,0.6);color:#fff3c0;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.72em;font-weight:700;">Install Ollama</button>
    </div>
    <div id="csCreditFooter" style="position:absolute;bottom:0;left:0;right:0;height:44px;display:flex;align-items:center;justify-content:center;color:rgba(184,134,11,0.35);font-size:0.75em;font-family:'Crimson Text',serif;pointer-events:none;">Made by Conrajon · All Rights Reserved</div>
</div>
<script>
(function(){
  function wireStartMenu() {
    var b = document.getElementById('csBtnNew');
    if (b) b.onclick = function() { try { if (typeof csShowNew === 'function') csShowNew(); } catch(e) { console.error('csShowNew', e); } };
    b = document.getElementById('csBtnOpen');
    if (b) b.onclick = function() { try { if (typeof csShowOpen === 'function') csShowOpen(); } catch(e) { console.error('csShowOpen', e); } };
    b = document.getElementById('csBtnOneshot');
    if (b) b.onclick = function() { try { if (typeof csStartOneShot === 'function') csStartOneShot(); } catch(e) { console.error('csStartOneShot', e); } };
    b = document.getElementById('csBtnHomebrew');
    if (b) b.onclick = function() { try { if (typeof csOpenHomebrewImport === 'function') csOpenHomebrewImport(); } catch(e) { console.error('csOpenHomebrewImport', e); } };
    b = document.getElementById('csBtnOptions');
    if (b) b.onclick = function() { try { if (typeof openOptionsModal === 'function') openOptionsModal(); } catch(e) { console.error('openOptionsModal', e); } };
  }
  if (document.readyState === 'complete') wireStartMenu();
  else window.addEventListener('load', wireStartMenu);
})();
</script>

<!-- ══ PLAYER PARTY MODAL ══ -->
<div id="partyModal" class="app-modal" style="display:none;position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.85);backdrop-filter:blur(5px);align-items:flex-start;justify-content:center;padding:30px 20px;overflow-y:auto;">
    <div style="background:linear-gradient(145deg,#1a1a2e,#16213e);border:2px solid var(--gold);border-radius:12px;width:100%;max-width:680px;margin:auto;box-shadow:0 20px 60px rgba(0,0,0,0.9);">
        <div style="background:linear-gradient(145deg,var(--red),var(--red-dark));padding:16px 22px;border-radius:10px 10px 0 0;display:flex;align-items:center;justify-content:space-between;">
            <div style="font-family:'Cinzel',serif;font-size:1.1em;font-weight:700;color:#fff8dc;text-transform:uppercase;letter-spacing:2px;">👥 Players</div>
            <button onclick="closePartyModal()" style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,248,220,0.3);color:#fff8dc;padding:5px 14px;border-radius:4px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;">✕ Close</button>
        </div>
        <!-- Health Overview Strip -->
        <div id="partyHealthStrip" style="background:rgba(0,0,0,0.4);padding:12px 18px;border-bottom:1px solid rgba(184,134,11,0.2);">
            <div style="font-family:'Cinzel',serif;font-size:0.7em;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">⚔ Party Health Overview</div>
            <div id="partyHealthOverview" style="display:flex;flex-wrap:wrap;gap:8px;">
                <div style="color:rgba(184,134,11,0.4);font-size:0.8em;font-style:italic;">No players added yet.</div>
            </div>
        </div>
        <div style="padding:18px 20px;">
            <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
                <button style="flex:1;padding:9px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff8dc;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;" onclick="addPartyMember()">+ Add Player</button>
                <button style="padding:9px 14px;background:rgba(139,0,0,0.3);color:#f08080;border:1px solid rgba(139,0,0,0.4);border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;" onclick="clearAllPartyMembers()">Clear All</button>
            </div>
            <div id="lpPartyList"><div style="color:rgba(184,134,11,0.45);font-size:0.85em;text-align:center;padding:20px 10px;">No players added yet.</div></div>
        </div>
        <!-- Party Tracker Section (merged) -->
        <div style="border-top:1px solid rgba(184,134,11,0.2);padding:14px 20px 18px;">
            <div style="font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">📋 Party Tracker</div>
            <div id="partyTrackerMerged"></div>
        </div>
    </div>
</div>

<script>
(function() {
  if (window.desktopApp) {
    document.body.classList.add('electron');
    if (typeof window.desktopApp.getVersion !== 'function') {
      console.error('Real DND DM Helper: desktopApp is present but incomplete. Restart the app from the installer or npm run start.');
    }
  }
  try {
    localStorage.setItem('_dm_probe', '1');
    localStorage.removeItem('_dm_probe');
  } catch (e) {
    console.error('Real DND DM Helper: localStorage is not available.', e);
  }
})();
</script>
<!-- Title bar outside main-wrapper so it is never clipped and all three buttons stay visible -->
<div id="electronTitleBar" class="electron-title-bar">
    <span class="title-bar-drag">Real DND DM Helper</span>
    <div class="title-bar-controls">
        <button type="button" class="title-bar-btn" id="titleBarMinimize" title="Minimise" aria-label="Minimise">
            <svg viewBox="0 0 12 12" fill="currentColor"><rect x="0" y="5" width="12" height="1" rx="0.5"/></svg>
        </button>
        <button type="button" class="title-bar-btn" id="titleBarMaximize" title="Fullscreen / Restore" aria-label="Maximise">
            <svg viewBox="0 0 12 12" id="titleBarMaximizeIcon" fill="currentColor"><path d="M0 0v12h12V0H0zm1 1h10v10H1V1z"/></svg>
            <svg viewBox="0 0 12 12" id="titleBarRestoreIcon" style="display:none;" fill="currentColor"><path d="M2 0v2H0v10h8v-2h2V0H2zm6 8H2V4h6v4zm2-6H8V2h2v2zM4 6v4h4V6H4z"/></svg>
        </button>
        <button type="button" class="title-bar-btn close-btn" id="titleBarClose" title="Close" aria-label="Close">
            <svg viewBox="0 0 12 12"><path d="M1 1l10 10M11 1L1 11" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        </button>
    </div>
</div>
<script>
(function() {
    if (!window.desktopApp) return;
    function wireTitleBar() {
        var minBtn = document.getElementById('titleBarMinimize');
        var maxBtn = document.getElementById('titleBarMaximize');
        var closeBtn = document.getElementById('titleBarClose');
        var maxIcon = document.getElementById('titleBarMaximizeIcon');
        var restIcon = document.getElementById('titleBarRestoreIcon');
        if (minBtn) minBtn.addEventListener('click', function() { window.desktopApp.minimizeWindow(); });
        if (closeBtn) closeBtn.addEventListener('click', function() { window.desktopApp.closeWindow(); });
        if (maxBtn) {
            maxBtn.addEventListener('click', function() {
                window.desktopApp.maximizeWindow();
                setTimeout(function() {
                    if (window.desktopApp.isWindowMaximized) window.desktopApp.isWindowMaximized().then(function(m) {
                        if (maxIcon && restIcon) { maxIcon.style.display = m ? 'none' : 'block'; restIcon.style.display = m ? 'block' : 'none'; }
                    });
                }, 150);
            });
            if (window.desktopApp.isWindowMaximized) window.desktopApp.isWindowMaximized().then(function(m) {
                if (maxIcon && restIcon) { maxIcon.style.display = m ? 'none' : 'block'; restIcon.style.display = m ? 'block' : 'none'; }
            });
        }
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wireTitleBar); else wireTitleBar();
})();
</script>
<div class="main-wrapper">
<header class="dm-header">
    <div style="display:flex;flex-direction:column;align-items:flex-start;flex-shrink:0;">
        <div class="dm-header-title" style="margin-bottom:2px;">DND DM Helper <span id="dmHeaderVersion" style="font-size:0.48em;opacity:0.75;font-weight:400;letter-spacing:1px;"></span></div>
        <div id="sessionTimerWrap" style="display:flex;align-items:center;gap:5px;padding:3px 8px;background:linear-gradient(145deg,rgba(30,25,45,0.85),rgba(20,18,35,0.85));border:1px solid rgba(184,134,11,0.35);border-radius:6px;flex-shrink:0;">
        <span id="sessionTimerDisplay" style="font-family:'Cinzel',serif;font-size:0.9em;font-weight:700;color:var(--gold-light);min-width:52px;">0:00</span>
        <input type="number" id="sessionTimerMinutes" min="0" max="599" placeholder="M" title="Minutes" style="width:32px;padding:3px 4px;background:rgba(0,0,0,0.4);border:1px solid rgba(184,134,11,0.35);border-radius:4px;color:#fff3c0;font-size:0.72em;text-align:center;">
        <span style="color:rgba(255,255,255,0.4);font-size:0.7em;">:</span>
        <input type="number" id="sessionTimerSeconds" min="0" max="59" placeholder="S" title="Seconds" style="width:32px;padding:3px 4px;background:rgba(0,0,0,0.4);border:1px solid rgba(184,134,11,0.35);border-radius:4px;color:#fff3c0;font-size:0.72em;text-align:center;">
        <button type="button" onclick="sessionTimerSet()" title="Set timer" style="padding:3px 6px;background:rgba(184,134,11,0.25);border:1px solid rgba(218,165,32,0.5);border-radius:4px;color:#ffe8a0;font-family:'Cinzel',serif;font-size:0.6em;font-weight:700;cursor:pointer;">Set</button>
        <button type="button" id="sessionTimerStart" onclick="sessionTimerStartStop()" title="Start / Pause" style="padding:3px 6px;background:rgba(80,120,60,0.5);border:1px solid rgba(100,180,80,0.5);border-radius:4px;color:#b8f0a0;font-family:'Cinzel',serif;font-size:0.6em;font-weight:700;cursor:pointer;">Start</button>
        <button type="button" onclick="sessionTimerStop()" title="Stop timer" style="padding:3px 6px;background:rgba(139,0,0,0.4);border:1px solid rgba(220,80,80,0.5);border-radius:4px;color:#ffb0b0;font-family:'Cinzel',serif;font-size:0.6em;font-weight:700;cursor:pointer;">Stop</button>
        <button type="button" onclick="sessionTimerReset()" title="Reset" style="padding:3px 6px;background:rgba(80,60,80,0.4);border:1px solid rgba(160,100,160,0.4);border-radius:4px;color:#e0c0e0;font-family:'Cinzel',serif;font-size:0.6em;font-weight:700;cursor:pointer;">Reset</button>
    </div>
    </div>
    <div id="campaignBadge">📖 <span id="campaignBadgeName">Campaign</span> <button id="campaignBadgeSaveBtn" onclick="saveCurrentCampaign()" title="Save Campaign">💾 Save</button></div>
    <div class="dm-mode-tabs" style="display:flex;align-items:center;flex-wrap:wrap;gap:6px;">
        <button class="dm-mode-tab" id="modeTabParty" onclick="openPartyModal()">
            <span class="dm-mode-icon">👥</span>
            <span class="dm-mode-label">Players</span>
        </button>
        <!-- Player mini cards shown inline right next to the Players button — arrow area -->
        <div id="headerPlayerCards" style="display:flex;flex-wrap:wrap;gap:5px;align-items:center;"></div>
        <!-- Player Health Bars with Tabs -->
        <div id="headerPartyHealth" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;max-width:600px;"></div>
    </div>
    <div class="dm-header-right" style="display:flex;align-items:center;gap:8px;margin-left:auto;flex-shrink:0;flex-wrap:wrap;">
        <button class="dm-quick-btn" onclick="openGlobalSearchModal()" title="Search NPCs, locations, quests, notes" style="width:auto;padding:6px 10px;font-family:'Cinzel',serif;font-size:0.72em;font-weight:800;letter-spacing:1px;color:#fff;">🔍 Search</button>
        <button class="dm-quick-btn" onclick="openLiveDMTools()" title="Live DM Tools" style="width:auto;padding:6px 10px;font-family:'Cinzel',serif;font-size:0.72em;font-weight:800;letter-spacing:1px;color:#fff;">Live DM Tools</button>
        <button class="dm-quick-btn" onclick="openMinigamesModal()" title="Mini games for tavern, town, campfire" style="width:auto;padding:6px 10px;font-family:'Cinzel',serif;font-size:0.72em;font-weight:800;letter-spacing:1px;color:#fff;">Minigames</button>
        <button class="dm-quick-btn" onclick="hbOpenManager()" title="Import Homebrew" style="width:auto;padding:6px 10px;font-family:'Cinzel',serif;font-size:0.72em;font-weight:800;letter-spacing:1px;color:#fff;">Import Homebrew</button>
        <button class="dm-quick-btn" onclick="openOptionsModal()" title="Display (dark/light), AI, and other settings" style="width:auto;padding:6px 10px;font-family:'Cinzel',serif;font-size:0.72em;font-weight:800;letter-spacing:1px;color:#fff;">Options</button>
        <button class="dm-quick-btn" onclick="confirmMainMenu()" title="Main Menu" style="width:auto;padding:6px 10px;font-family:'Cinzel',serif;font-size:0.72em;font-weight:800;letter-spacing:1px;color:#fff;">Main Menu</button>
    </div>
</header>

<!-- DM Assistant – pops out from bottom-left button (no tab; open via "🤖 DM Assistant" button below). Ctrl+Shift+D toggles. -->
<div id="dmAIPopout" class="dm-ai-collapsed">
  <div style="position:relative;background:linear-gradient(145deg,#1a1a2e,#16213e);border:2px solid rgba(160,100,255,0.5);border-radius:8px 8px 0 0;width:100%;height:100%;display:flex;flex-direction:column;box-shadow:4px 4px 24px rgba(0,0,0,0.5);overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:linear-gradient(145deg,rgba(80,40,140,0.4),rgba(60,20,100,0.35));border-bottom:1px solid rgba(160,100,255,0.3);flex-shrink:0;">
      <div style="font-family:'Cinzel',serif;font-weight:900;letter-spacing:1px;color:#e0c0ff;font-size:0.95em;">🤖 DM Assistant</div>
      <button onclick="closeDMAIChat()" style="padding:5px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.8);border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;">✕</button>
    </div>
    <div id="dmAIChatMessages" style="flex:1;overflow-y:auto;padding:12px;min-height:100px;font-family:'Crimson Text',serif;font-size:0.9em;line-height:1.5;">
      <div id="dmAIChatWelcome" style="color:rgba(255,255,255,0.55);font-style:italic;">Ask for help while you run the game: rules, rulings, quick ideas, or how to handle a situation. Type below and press Enter or Send.</div>
    </div>
    <div style="padding:6px 10px 4px;border-top:1px solid rgba(255,255,255,0.06);display:flex;gap:6px;flex-wrap:wrap;flex-shrink:0;background:rgba(0,0,0,0.15);">
      <button type="button" onclick="dmAIOracle('yesno')" style="padding:5px 10px;font-size:0.75em;border-radius:6px;border:1px solid rgba(160,100,255,0.5);background:rgba(80,60,120,0.4);color:#c0a0ff;cursor:pointer;" title="Get a Yes or No answer">Yes/No</button>
      <button type="button" onclick="dmAIOracle('complication')" style="padding:5px 10px;font-size:0.75em;border-radius:6px;border:1px solid rgba(160,100,255,0.5);background:rgba(80,60,120,0.4);color:#c0a0ff;cursor:pointer;" title="One short complication">Complication</button>
      <button type="button" onclick="dmAIOracle('name')" style="padding:5px 10px;font-size:0.75em;border-radius:6px;border:1px solid rgba(160,100,255,0.5);background:rgba(80,60,120,0.4);color:#c0a0ff;cursor:pointer;" title="Random fantasy name">Random name</button>
    </div>
    <div style="padding:8px 10px;border-top:1px solid rgba(255,255,255,0.08);display:flex;gap:6px;align-items:center;flex-shrink:0;background:rgba(0,0,0,0.2);">
      <input type="text" id="dmAIChatInput" placeholder="Type your question here…" autocomplete="off" style="flex:1;min-width:0;padding:8px 10px;background:rgba(0,0,0,0.35);border:1px solid rgba(160,100,255,0.4);border-radius:6px;color:#efe4ff;font-family:'Crimson Text',serif;font-size:0.88em;" onkeydown="if(event.key==='Enter'){ event.preventDefault(); sendDMAIChatMessage(); }">
      <button type="button" onclick="sendDMAIChatMessage()" id="dmAIChatSendBtn" style="padding:8px 14px;background:linear-gradient(145deg,#4a0080,#6a00b0);color:#e0c0ff;border:1px solid rgba(160,100,255,0.6);border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;flex-shrink:0;">Send</button>
    </div>
    <div id="dmAIChatStatusWrap" style="flex-shrink:0;">
      <div id="dmAIChatProgressBar" style="display:none;height:4px;background:rgba(0,0,0,0.3);border-radius:2px;overflow:hidden;margin:0 10px 2px;">
        <div id="dmAIChatProgressFill" style="height:100%;width:0%;background:linear-gradient(90deg,#4a0080,#a060ff);transition:width 0.25s ease;"></div>
      </div>
      <div id="dmAIChatStatus" style="padding:4px 10px;font-size:0.72em;color:rgba(255,255,255,0.45);"></div>
    </div>
    <div class="dm-ai-resize-handle" id="dmAIResizeHandle" title="Drag to resize"></div>
  </div>
</div>

<!-- ══ GLOBAL SEARCH MODAL ══ -->
<div id="globalSearchModal" class="app-modal" style="display:none;position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.85);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:20px;">
    <div style="background:linear-gradient(145deg,#1a1a2e,#16213e);border:2px solid rgba(218,165,32,0.5);border-radius:12px;width:100%;max-width:520px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.8);">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(218,165,32,0.3);">
            <div style="font-family:'Cinzel',serif;font-weight:900;color:#fff3c0;font-size:1em;">🔍 Search</div>
            <button onclick="closeGlobalSearchModal()" style="padding:5px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.8);border-radius:6px;cursor:pointer;font-size:0.8em;">✕</button>
        </div>
        <input type="text" id="globalSearchInput" placeholder="Search NPCs, locations, quests, notes…" style="margin:12px;padding:10px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.4);background:rgba(0,0,0,0.35);color:#fff;font-size:0.95em;" oninput="runGlobalSearch(this.value)">
        <div id="globalSearchResults" style="flex:1;overflow-y:auto;padding:0 12px 12px;font-family:'Crimson Text',serif;font-size:0.9em;color:rgba(255,255,255,0.85);"></div>
    </div>
</div>

<!-- ══ MAIN MENU WARNING MODAL ══ -->
<div id="mainMenuWarningModal" class="app-modal" style="display:none;position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.88);backdrop-filter:blur(6px);align-items:center;justify-content:center;">
    <div style="background:linear-gradient(145deg,#1a1a2e,#16213e);border:2px solid var(--gold);border-radius:12px;padding:32px;max-width:440px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.8);text-align:center;">
        <div style="font-size:2.5em;margin-bottom:12px;">⚠️</div>
        <div style="font-family:'Cinzel',serif;font-size:1.2em;font-weight:900;color:var(--gold-light);margin-bottom:10px;">Return to Main Menu?</div>
        <div style="color:rgba(255,255,255,0.6);font-family:'Crimson Text',serif;font-size:0.95em;line-height:1.6;margin-bottom:16px;">This will clear the current screen. Make sure you save your campaign if you want to keep it.</div>
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
            <button onclick="if(typeof saveCurrentCampaign==='function')saveCurrentCampaign(); goToMainMenu(); closeMainMenuWarning();" style="padding:10px 18px;background:linear-gradient(145deg,#2e7d32,#1b5e20);color:white;border:none;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;" title="Save campaign then return to main menu">💾 Save & Main Menu</button>
            <button onclick="goToMainMenu()" style="padding:10px 18px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:white;border:none;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;">Main Menu (don’t save)</button>
            <button onclick="closeMainMenuWarning()" style="padding:10px 18px;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.75);border:1px solid rgba(255,255,255,0.15);border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-weight:700;">Cancel</button>
        </div>
    </div>
</div>

<!-- ══ OPTIONS MODAL (Display + AI) ══ -->
<div id="optionsModal" class="app-modal" onclick="if(event.target===this)closeOptionsModal()" style="display:none;position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.88);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:20px;">
  <div style="background:linear-gradient(145deg,#1a1a2e,#16213e);border:2px solid rgba(218,165,32,0.5);border-radius:14px;width:100%;max-width:520px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.8);">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(145deg,rgba(80,40,140,0.3),rgba(60,20,100,0.25));border-bottom:1px solid rgba(218,165,32,0.3);">
      <div style="font-family:'Cinzel',serif;font-weight:900;letter-spacing:1px;color:#fff3c0;font-size:1.05em;">⚙ Options</div>
      <button onclick="closeOptionsModal()" style="padding:6px 12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.8);border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">✕ Close</button>
    </div>
    <div style="display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,0.08);">
      <button id="optTabDisplay" onclick="optionsSwitchTab('display')" style="flex:1;padding:10px;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;background:rgba(218,165,32,0.2);border:1px solid rgba(218,165,32,0.35);color:#fff3c0;cursor:pointer;">Display</button>
      <button id="optTabAI" onclick="optionsSwitchTab('ai')" style="flex:1;padding:10px;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.7);cursor:pointer;">AI</button>
      <button id="optTabAbout" onclick="optionsSwitchTab('about')" style="flex:1;padding:10px;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.7);cursor:pointer;">About</button>
    </div>
    <div id="optionsContent" style="flex:1;overflow-y:auto;padding:20px;">
      <div id="optionsDisplayPanel" style="display:block;">
        <div style="font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:var(--gold);margin-bottom:14px;text-transform:uppercase;letter-spacing:1.2px;">Appearance</div>
        <div style="background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:16px;margin-bottom:18px;">
          <div style="font-family:'Cinzel',serif;font-size:0.72em;font-weight:700;color:rgba(255,255,255,0.7);margin-bottom:12px;text-transform:uppercase;">Theme</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <label class="opt-theme-card" id="optThemeCardDark" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(145deg,rgba(25,22,40,0.95),rgba(35,30,55,0.95));border:2px solid rgba(160,100,255,0.4);border-radius:10px;cursor:pointer;transition:all 0.2s;">
              <input type="radio" name="optTheme" value="dark" onchange="optionsApplyTheme('dark')" style="accent-color:#a060ff;">
              <span style="font-size:1.6em;">🌙</span>
              <div>
                <div style="font-family:'Cinzel',serif;font-weight:700;color:#c0a0ff;font-size:0.95em;">Dark</div>
                <div style="font-size:0.78em;color:rgba(255,255,255,0.55);">Default, easy on the eyes</div>
              </div>
            </label>
            <label class="opt-theme-card" id="optThemeCardLight" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(145deg,rgba(45,42,60,0.9),rgba(55,50,75,0.9));border:2px solid rgba(255,255,255,0.15);border-radius:10px;cursor:pointer;transition:all 0.2s;">
              <input type="radio" name="optTheme" value="light" onchange="optionsApplyTheme('light')" style="accent-color:#a060ff;">
              <span style="font-size:1.6em;">☀️</span>
              <div>
                <div style="font-family:'Cinzel',serif;font-weight:700;color:rgba(255,255,255,0.9);font-size:0.95em;">Light</div>
                <div style="font-size:0.78em;color:rgba(255,255,255,0.5);">Brighter workspace</div>
              </div>
            </label>
          </div>
        </div>
      </div>
      <div id="optionsAIPanel" style="display:none;">
        <button type="button" onclick="openAISetupWizard()" style="width:100%;padding:12px 16px;margin-bottom:18px;background:linear-gradient(145deg,#3a1060,#5a20a0);border:1px solid rgba(160,100,255,0.6);color:#c0a0ff;border-radius:10px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.9em;font-weight:700;">Set up AI (Ollama + llama2)</button>
        <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);margin-bottom:8px;text-transform:uppercase;">Ollama status</div>
        <div id="optionsOllamaStatusText" style="margin-bottom:14px;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;font-size:0.9em;color:rgba(255,255,255,0.85);">Checking…</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
          <button type="button" onclick="optionsRunOllamaInstall()" style="padding:8px 14px;background:rgba(80,140,40,0.35);border:1px solid rgba(100,200,80,0.5);color:#a8e8a8;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;">Install Ollama (bundled)</button>
          <button type="button" onclick="optionsOpenOllamaDownload()" style="padding:8px 14px;background:rgba(60,80,120,0.35);border:1px solid rgba(100,140,200,0.5);color:#a0c8ff;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;">Download Ollama (web)</button>
        </div>
        <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);margin-bottom:8px;text-transform:uppercase;">Story &amp; DM Assistant endpoint</div>
        <input type="text" id="optionsAIUrl" placeholder="http://127.0.0.1:11434" style="width:100%;padding:8px 12px;margin-bottom:8px;background:rgba(0,0,0,0.4);border:1px solid rgba(160,120,255,0.4);color:#efe4ff;border-radius:6px;font-size:0.9em;">
        <div style="font-size:0.8em;color:rgba(255,255,255,0.5);margin-bottom:12px;">Used for DM Assistant chat and Story generation with AI. Default: Ollama on this PC.</div>
        <div style="font-size:0.78em;color:rgba(218,165,32,0.85);margin-bottom:12px;padding:8px 10px;background:rgba(0,0,0,0.2);border-radius:6px;border-left:3px solid var(--gold);">💡 <strong>Live play:</strong> Pull a model once (e.g. <em>ollama pull llama2</em> or use the button below) so AI is ready during the session. Enable &quot;Faster AI&quot; for quick rules lookups at the table.</div>
        <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);margin-bottom:6px;">Model name</div>
        <input type="text" id="optionsAIModel" placeholder="llama2" style="width:100%;padding:8px 12px;margin-bottom:12px;background:rgba(0,0,0,0.4);border:1px solid rgba(160,120,255,0.4);color:#efe4ff;border-radius:6px;font-size:0.9em;">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:14px;">
          <input type="checkbox" id="optionsStoryAIEnabled" onchange="optionsSaveAISettings()">
          <span style="color:rgba(255,255,255,0.9);">Use local AI for Story generation</span>
        </label>
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:14px;">
          <input type="checkbox" id="optionsAIFaster" onchange="optionsSaveAISettings()">
          <span style="color:rgba(255,255,255,0.9);">Faster AI (shorter replies) — recommended for live play</span>
        </label>
        <div style="font-size:0.78em;color:rgba(255,255,255,0.5);margin-top:-8px;margin-bottom:12px;margin-left:24px;">Keeps replies short so the DM Assistant responds in seconds. Best for rules lookups and quick ideas at the table.</div>
        <button type="button" onclick="optionsSaveAISettings();optionsTestAI();" style="padding:8px 16px;background:rgba(160,100,255,0.35);border:1px solid rgba(160,100,255,0.6);color:#c0a0ff;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;">Test connection</button>
        <div id="optionsAITestResult" style="margin-top:10px;font-size:0.85em;min-height:1.4em;"></div>
      </div>
      <div id="optionsAboutPanel" style="display:none;">
        <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);margin-bottom:8px;text-transform:uppercase;">App version</div>
        <div id="optionsVersionText" style="margin-bottom:16px;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;font-size:0.9em;color:rgba(255,255,255,0.9);">—</div>
        <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);margin-bottom:8px;text-transform:uppercase;">Updates</div>
        <p style="font-size:0.85em;color:rgba(255,255,255,0.7);margin-bottom:12px;line-height:1.5;">The app downloads and installs updates for you. Click <strong>Check for updates</strong>; if a new version is available you can download it here and then restart to install.</p>
        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px;">
          <button type="button" id="optionsCheckUpdatesBtn" onclick="optionsCheckForUpdates()" style="padding:10px 18px;background:rgba(46,204,113,0.25);border:1px solid rgba(46,204,113,0.5);color:#a0e8a0;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;">Check for updates</button>
          <button type="button" id="optionsDownloadUpdateBtn" onclick="optionsDownloadUpdate()" style="display:none;padding:10px 18px;background:rgba(46,120,200,0.3);border:1px solid rgba(100,160,255,0.5);color:#a0c8ff;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;">Download update</button>
          <button type="button" id="optionsRestartInstallBtn" onclick="optionsRestartToInstall()" style="display:none;padding:10px 18px;background:rgba(46,204,113,0.35);border:1px solid rgba(80,220,120,0.6);color:#b8ffc0;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;">Restart to install</button>
        </div>
        <div id="optionsUpdateProgressWrap" style="display:none;margin-bottom:10px;">
          <div style="height:8px;background:rgba(0,0,0,0.4);border-radius:4px;overflow:hidden;"><div id="optionsUpdateProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#2e8b57,#3cb371);border-radius:4px;transition:width 0.2s;"></div></div>
          <div id="optionsUpdateProgressText" style="font-size:0.8em;color:rgba(255,255,255,0.65);margin-top:4px;"></div>
        </div>
        <div id="optionsUpdateResult" style="margin-top:6px;font-size:0.85em;min-height:1.4em;color:rgba(255,255,255,0.8);"></div>
      </div>
    </div>
  </div>
</div>

<!-- ══ AI SETUP WIZARD (Ollama + llama2, no cmd) ══ -->
<div id="aiSetupWizardModal" class="app-modal" style="display:none;position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.9);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:24px;">
  <div style="background:linear-gradient(160deg,#1a1a2e 0%,#16213e 50%,#0f0f1f 100%);border:2px solid rgba(160,100,255,0.5);border-radius:16px;width:100%;max-width:480px;box-shadow:0 24px 64px rgba(0,0,0,0.7),0 0 0 1px rgba(255,255,255,0.04);overflow:hidden;">
    <div style="padding:24px 28px;border-bottom:1px solid rgba(160,100,255,0.25);">
      <div style="font-family:'Cinzel',serif;font-weight:900;font-size:1.25em;color:#e0c0ff;letter-spacing:1px;">Set up DM Assistant</div>
      <div style="font-size:0.88em;color:rgba(255,255,255,0.55);margin-top:6px;font-family:'Crimson Text',serif;">Install Ollama and the llama2 model so you can use the AI assistant.</div>
    </div>
    <div style="padding:24px 28px;">
      <div style="margin-bottom:24px;">
        <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">Step 1 — Install Ollama</div>
        <div id="aiSetupStep1Status" style="font-size:0.85em;color:rgba(255,255,255,0.7);margin-bottom:10px;">Run the installer to add Ollama to your PC.</div>
        <button type="button" id="aiSetupInstallOllamaBtn" onclick="aiSetupRunOllamaInstaller()" style="padding:12px 20px;background:linear-gradient(145deg,#2d5016,#3d7020);border:1px solid rgba(120,200,80,0.6);color:#b8f0a0;border-radius:10px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.9em;font-weight:700;">Install Ollama</button>
      </div>
      <div>
        <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">Step 2 — Download llama2</div>
        <div id="aiSetupStep2Status" style="font-size:0.85em;color:rgba(255,255,255,0.7);margin-bottom:10px;">Download the AI model (~4 GB). This runs in the app — no command prompt.</div>
        <div id="aiSetupProgressWrap" style="display:none;margin-bottom:10px;">
          <div style="height:8px;background:rgba(0,0,0,0.4);border-radius:4px;overflow:hidden;"><div id="aiSetupProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#4a0080,#8a00c0);border-radius:4px;transition:width 0.2s;"></div></div>
          <div id="aiSetupProgressText" style="font-size:0.8em;color:rgba(255,255,255,0.6);margin-top:4px;"></div>
        </div>
        <button type="button" id="aiSetupPullLlamaBtn" onclick="aiSetupPullLlama2()" style="padding:12px 20px;background:linear-gradient(145deg,#4a0080,#6a00b0);border:1px solid rgba(160,100,255,0.6);color:#c0a0ff;border-radius:10px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.9em;font-weight:700;">Download llama2</button>
      </div>
    </div>
    <div style="padding:16px 28px;border-top:1px solid rgba(255,255,255,0.06);display:flex;justify-content:flex-end;">
      <button type="button" onclick="closeAISetupWizard()" style="padding:10px 20px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.85);border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;">Close</button>
    </div>
  </div>
</div>

<!-- ══ LIVE DM TOOLS MODAL ══ -->
<div id="liveDMToolsModal" class="app-modal" style="display:none;position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.88);backdrop-filter:blur(6px);align-items:flex-start;justify-content:center;padding:22px 16px;overflow-y:auto;">
  <div style="background:linear-gradient(145deg,#141426,#16213e);border:2px solid rgba(218,165,32,0.65);border-radius:14px;width:100%;max-width:980px;box-shadow:0 20px 70px rgba(0,0,0,0.85);overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 18px;background:linear-gradient(145deg,rgba(184,134,11,0.26),rgba(139,0,0,0.22));border-bottom:1px solid rgba(218,165,32,0.25);">
      <div>
        <div style="font-family:'Cinzel',serif;font-weight:900;letter-spacing:2px;color:#fff3c0;text-transform:uppercase;font-size:1.05em;">🎛 Live DM Tools</div>
        <div style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.55);font-size:0.92em;">Run combat rounds, quick rules, and backups without leaving the table.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button onclick="dmBackupExport()" style="padding:7px 12px;background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.45);color:#fff3c0;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:900;">⬇ Export</button>
        <button onclick="closeLiveDMTools()" style="padding:7px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.75);border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:800;">✕ Close</button>
      </div>
    </div>

    <div style="display:flex;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.08);flex-wrap:wrap;">
      <button id="dmToolTabBtn_round" onclick="dmToolSwitch('round')" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.35);background:rgba(218,165,32,0.18);color:#fff3c0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.78em;">⏱ Round / Turn</button>
      <button id="dmToolTabBtn_encounter" onclick="dmToolSwitch('encounter')" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.75);cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.78em;">⚔ Encounter</button>
      <button id="dmToolTabBtn_rules" onclick="dmToolSwitch('rules')" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.75);cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.78em;">📖 Quick Reference</button>
      <button id="dmToolTabBtn_backup" onclick="dmToolSwitch('backup')" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.75);cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.78em;">🧰 Backup</button>
    </div>

    <div style="padding:14px 16px;">
      <div id="dmToolTab_round">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start;">
          <div style="background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.22);border-radius:12px;padding:14px;">
            <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:0.8em;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Combat Clock</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
              <div style="flex:1;min-width:180px;">
                <div style="font-family:'Cinzel',serif;color:rgba(255,255,255,0.55);font-size:0.7em;text-transform:uppercase;letter-spacing:1px;">Round</div>
                <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:1.8em;" id="dmRoundDisplay">1</div>
              </div>
              <div style="flex:1;min-width:220px;">
                <div style="font-family:'Cinzel',serif;color:rgba(255,255,255,0.55);font-size:0.7em;text-transform:uppercase;letter-spacing:1px;">Turn</div>
                <div style="font-family:'Cinzel',serif;color:#a0ffc0;font-weight:900;font-size:1.05em;" id="dmTurnDisplay">—</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button onclick="dmRoundReset()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.8);cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">Reset</button>
              <button onclick="dmPrevTurn()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.35);background:rgba(0,0,0,0.2);color:#fff3c0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">◀ Prev</button>
              <button onclick="dmNextTurn()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(46,204,113,0.45);background:linear-gradient(145deg,rgba(46,204,113,0.22),rgba(0,0,0,0.2));color:#a0ffc0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">Next ▶</button>
              <button onclick="dmRoundAdvance()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(52,152,219,0.45);background:linear-gradient(145deg,rgba(52,152,219,0.18),rgba(0,0,0,0.2));color:#a0c8ff;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">+ Round</button>
            </div>
          </div>

          <div style="background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.22);border-radius:12px;padding:14px;">
            <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:0.8em;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Turn Order (Quick)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
              <button onclick="if(typeof addPartyToInitiative==='function'){addPartyToInitiative();}if(typeof dmBuildTurnOrderFromInitiative==='function')dmBuildTurnOrderFromInitiative();" style="padding:7px 10px;border-radius:8px;border:1px solid rgba(46,204,113,0.5);background:rgba(46,204,113,0.18);color:#a0ffc0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.72em;" title="Add all party members to initiative order, then build turn list">Add Players to Initiative</button>
              <button onclick="dmBuildTurnOrderFromInitiative()" style="padding:7px 10px;border-radius:8px;border:1px solid rgba(218,165,32,0.35);background:rgba(218,165,32,0.14);color:#fff3c0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.72em;">Use Initiative Panel</button>
              <button onclick="dmBuildTurnOrderFromPartyAndNPCs()" style="padding:7px 10px;border-radius:8px;border:1px solid rgba(218,165,32,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.8);cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.72em;">Use Party + NPCs</button>
              <button onclick="dmClearTurnOrder()" style="padding:7px 10px;border-radius:8px;border:1px solid rgba(139,0,0,0.4);background:rgba(139,0,0,0.15);color:#f0a0a0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.72em;">Clear</button>
            </div>
            <div id="dmTurnOrderList" style="display:flex;flex-direction:column;gap:6px;max-height:260px;overflow-y:auto;"></div>
            <div style="margin-top:10px;">
              <div style="font-family:'Cinzel',serif;color:rgba(255,255,255,0.55);font-size:0.7em;text-transform:uppercase;letter-spacing:1px;">Round Notes</div>
              <textarea id="dmRoundNotes" placeholder="Concentration, lair actions, timers, reminders..." style="width:100%;min-height:72px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.88);font-family:'Crimson Text',serif;font-size:0.95em;resize:vertical;line-height:1.5;"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end;">
                <button onclick="dmSaveRoundNotes()" style="padding:7px 12px;border-radius:8px;border:1px solid rgba(46,204,113,0.45);background:rgba(46,204,113,0.14);color:#a0ffc0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">Save Notes</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="dmToolTab_encounter" style="display:none;">
        <div style="display:grid;grid-template-columns:1fr;gap:14px;align-items:start;">
          <div style="background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.22);border-radius:12px;padding:14px;">
            <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:0.8em;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Encounter Difficulty</div>
            <div style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.72);line-height:1.6;margin-bottom:12px;">Open the full encounter calculator with party scaling, enemy XP budget checks, and generated-NPC loading.</div>
            <button onclick="openEncounterCalc()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.45);background:rgba(218,165,32,0.14);color:#fff3c0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">⚔ Open Encounter Calculator</button>
          </div>
        </div>
      </div>

      <div id="dmToolTab_rules" style="display:none;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start;">
          <div style="background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.22);border-radius:12px;padding:14px;">
            <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:0.8em;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Concentration</div>
            <div style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.78);line-height:1.65;">
              <div><strong>When you take damage:</strong> CON save DC 10 or half damage (whichever is higher).</div>
              <div style="margin-top:6px;"><strong>Multiple hits:</strong> save for each source of damage.</div>
              <div style="margin-top:6px;"><strong>Incapacitated:</strong> concentration ends.</div>
              <div style="margin-top:6px;"><strong>Only one:</strong> casting a new concentration spell ends the old one.</div>
            </div>
          </div>
          <div style="background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.22);border-radius:12px;padding:14px;">
            <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:0.8em;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Exhaustion (5e)</div>
            <div style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.78);line-height:1.6;">
              <div><strong>1</strong> Disadvantage on ability checks</div>
              <div><strong>2</strong> Speed halved</div>
              <div><strong>3</strong> Disadvantage on attacks & saves</div>
              <div><strong>4</strong> HP maximum halved</div>
              <div><strong>5</strong> Speed reduced to 0</div>
              <div><strong>6</strong> Death</div>
            </div>
          </div>
          <div style="grid-column:1/-1;background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.22);border-radius:12px;padding:14px;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px;">
              <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:0.8em;letter-spacing:1px;text-transform:uppercase;">Skills Reference (Click a Skill)</div>
              <div style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.56);font-size:0.9em;">Shows what each skill is useful for at the table.</div>
            </div>
            <div id="dmSkillPromptList" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;"></div>
            <div id="dmSkillGuideOutput" style="margin-top:8px;padding:10px 12px;border-radius:8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);color:rgba(220,235,255,0.85);font-family:'Crimson Text',serif;line-height:1.65;">Click a skill above to view table-use guidance.</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
              <span style="padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);font-size:0.8em;color:rgba(255,255,255,0.76);">Very Easy 5</span>
              <span style="padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);font-size:0.8em;color:rgba(255,255,255,0.76);">Easy 10</span>
              <span style="padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);font-size:0.8em;color:rgba(255,255,255,0.76);">Medium 15</span>
              <span style="padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);font-size:0.8em;color:rgba(255,255,255,0.76);">Hard 20</span>
              <span style="padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);font-size:0.8em;color:rgba(255,255,255,0.76);">Very Hard 25</span>
              <span style="padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);font-size:0.8em;color:rgba(255,255,255,0.76);">Nearly Impossible 30</span>
            </div>
          </div>
          <div style="grid-column:1/-1;background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.22);border-radius:12px;padding:14px;">
            <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:0.8em;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Conditions (Tap to copy)</div>
            <div id="dmQuickConditions" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
            <div style="margin-top:10px;color:rgba(255,255,255,0.5);font-family:'Crimson Text',serif;font-size:0.9em;">Tip: click a condition to copy its name, then paste into an NPC/Player condition list.</div>
          </div>
        </div>
      </div>

      <div id="dmToolTab_backup" style="display:none;">
        <div style="background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.22);border-radius:12px;padding:14px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
            <div>
              <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:0.8em;letter-spacing:1px;text-transform:uppercase;">Campaign Backup</div>
              <div style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.55);font-size:0.92em;">Export/import local data in case the browser refreshes or you move to another PC.</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button onclick="saveCurrentCampaign()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(46,204,113,0.45);background:rgba(46,204,113,0.14);color:#a0ffc0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">💾 Save Campaign</button>
              <button onclick="dmExportFullCampaignToFile()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(46,204,113,0.5);background:rgba(46,204,113,0.18);color:#a0ffc0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">📤 Export to File</button>
              <button onclick="document.getElementById('dmFullCampaignFileInput').click()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,180,100,0.5);background:rgba(255,180,100,0.18);color:#ffd8a0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">📥 Load from File</button>
              <input type="file" id="dmFullCampaignFileInput" accept=".json" style="display:none;" onchange="dmImportFullCampaignFromFile(this)">
              <button onclick="dmUndoLastAction()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(120,180,255,0.45);background:rgba(120,180,255,0.14);color:#cfe8ff;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">↶ Undo Last</button>
              <button onclick="dmWorkflowKickoff()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(200,160,255,0.45);background:rgba(200,160,255,0.14);color:#ead8ff;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">🧭 DM Workflow</button>
              <button onclick="dmBackupExport()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(52,152,219,0.45);background:rgba(52,152,219,0.14);color:#a0c8ff;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">⬇ Export JSON</button>
              <button onclick="dmBackupImport()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(46,204,113,0.45);background:rgba(46,204,113,0.14);color:#a0ffc0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">⬆ Import JSON</button>
              <button onclick="dmRunReadinessCheck()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.45);background:rgba(218,165,32,0.14);color:#fff3c0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">🧪 Readiness Check</button>
              <button onclick="dmExportDiagnostics()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.85);cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">🧾 Export Diagnostics</button>
            </div>
            <div style="margin-top:12px;padding:12px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid rgba(218,165,32,0.2);">
              <div style="font-family:'Cinzel',serif;color:#fff3c0;font-weight:900;font-size:0.78em;letter-spacing:1px;margin-bottom:8px;">Session start checklist</div>
              <div id="dmSessionChecklist" style="display:flex;flex-direction:column;gap:6px;"></div>
              <button type="button" onclick="dmSessionChecklistReset()" style="margin-top:8px;padding:6px 10px;font-size:0.78em;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.8);cursor:pointer;">Reset checklist</button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,minmax(160px,1fr));gap:8px;width:100%;margin-top:8px;">
              <label style="display:flex;flex-direction:column;gap:4px;font-family:'Crimson Text',serif;color:rgba(255,255,255,0.78);font-size:0.88em;">Performance Mode
                <select id="dmPerfModeSel" onchange="dmSetPerformanceMode(this.value)" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);color:#fff;">
                  <option value="low">Low (max fps)</option><option value="balanced" selected>Balanced</option><option value="high">High quality</option>
                </select>
              </label>
              <label style="display:flex;flex-direction:column;gap:4px;font-family:'Crimson Text',serif;color:rgba(255,255,255,0.78);font-size:0.88em;">Portrait Quality
                <select id="dmPortraitQualitySel" onchange="dmSetPortraitQuality(this.value)" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);color:#fff;">
                  <option value="low">Low</option><option value="balanced" selected>Balanced</option><option value="high">High</option>
                </select>
              </label>
              <label style="display:flex;flex-direction:column;gap:4px;font-family:'Crimson Text',serif;color:rgba(255,255,255,0.78);font-size:0.88em;">Battlemap Detail
                <select id="dmMapDetailSel" onchange="dmSetMapDetail(this.value)" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);color:#fff;">
                  <option value="low">Low</option><option value="balanced" selected>Balanced</option><option value="high">High</option>
                </select>
              </label>
            </div>
          </div>
          <textarea id="dmBackupText" spellcheck="false" placeholder="Exported JSON will appear here…" style="width:100%;min-height:280px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.88);font-family:Consolas,monospace;font-size:12px;line-height:1.45;resize:vertical;"></textarea>
          <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end;flex-wrap:wrap;">
            <button onclick="dmBackupDownload()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.45);background:rgba(218,165,32,0.14);color:#fff3c0;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">💾 Download File</button>
            <button onclick="dmBackupCopy()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.8);cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;">Copy</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══ MINIGAMES MODAL ══ -->
<div id="minigamesModal" class="app-modal" style="display:none;position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.88);backdrop-filter:blur(6px);align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;">
  <div style="background:linear-gradient(145deg,#1a1a2e,#16213e);border:2px solid rgba(160,100,255,0.5);border-radius:14px;width:100%;max-width:720px;box-shadow:0 20px 60px rgba(0,0,0,0.8);overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(145deg,rgba(100,50,160,0.3),rgba(74,0,128,0.25));border-bottom:1px solid rgba(160,100,255,0.3);">
      <div style="font-family:'Cinzel',serif;font-weight:900;letter-spacing:2px;color:#e0c0ff;text-transform:uppercase;font-size:1.05em;">🎲 Minigames</div>
      <button onclick="closeMinigamesModal()" style="padding:7px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.18);color:rgba(255,255,255,0.8);border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">✕ Close</button>
    </div>
    <div style="display:flex;gap:8px;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.08);flex-wrap:wrap;">
      <button id="minigameTab_tavern" onclick="minigameTab('tavern')" style="padding:8px 14px;border-radius:8px;border:1px solid rgba(160,100,255,0.4);background:rgba(160,100,255,0.2);color:#e0c0ff;cursor:pointer;font-family:'Cinzel',serif;font-weight:900;font-size:0.78em;">🍺 Tavern</button>
      <button id="minigameTab_town" onclick="minigameTab('town')" style="padding:8px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.75);cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">🏘 Town</button>
      <button id="minigameTab_campfire" onclick="minigameTab('campfire')" style="padding:8px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.75);cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">🔥 Campfire</button>
      <button id="minigameTab_festival" onclick="minigameTab('festival')" style="padding:8px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.75);cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">🎪 Festival</button>
      <button id="minigameTab_gambling" onclick="minigameTab('gambling')" style="padding:8px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.75);cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">🎰 Gambling</button>
    </div>
    <div style="padding:16px;max-height:70vh;overflow-y:auto;">
      <div id="minigameContent_tavern" class="minigame-panel">
        <div style="font-family:'Cinzel',serif;color:#daa520;font-weight:700;margin-bottom:10px;">Tavern minigames</div>
        <div id="minigameTavernList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </div>
      <div id="minigameContent_town" style="display:none;" class="minigame-panel">
        <div style="font-family:'Cinzel',serif;color:#90ee90;font-weight:700;margin-bottom:10px;">Town minigames</div>
        <div id="minigameTownList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </div>
      <div id="minigameContent_campfire" style="display:none;" class="minigame-panel">
        <div style="font-family:'Cinzel',serif;color:#ffa060;font-weight:700;margin-bottom:10px;">Campfire minigames</div>
        <div id="minigameCampfireList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </div>
      <div id="minigameContent_festival" style="display:none;" class="minigame-panel">
        <div style="font-family:'Cinzel',serif;color:#f0c060;font-weight:700;margin-bottom:10px;">Festival minigames</div>
        <div id="minigameFestivalList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </div>
      <div id="minigameContent_gambling" style="display:none;" class="minigame-panel">
        <div style="font-family:'Cinzel',serif;color:#ff80a0;font-weight:700;margin-bottom:10px;">Gambling minigames</div>
        <div id="minigameGamblingList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ══ HOMEBREW MANAGER MODAL ══ -->
<div id="homebrewModal" class="app-modal" style="display:none;position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.9);backdrop-filter:blur(6px);align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;">
  <div style="background:linear-gradient(145deg,#101624,#16213e);border:2px solid rgba(218,165,32,0.6);border-radius:12px;width:100%;max-width:1060px;box-shadow:0 20px 70px rgba(0,0,0,0.85);overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(145deg,rgba(184,134,11,0.25),rgba(139,0,0,0.2));border-bottom:1px solid rgba(218,165,32,0.25);gap:10px;">
      <div>
        <div style="font-family:'Cinzel',serif;font-size:1.05em;font-weight:900;letter-spacing:1.5px;color:#fff3c0;text-transform:uppercase;">🧪 Import Homebrew</div>
        <div style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.62);font-size:0.92em;">Import, manually add, review, activate, and remove homebrew content used by NPC generators.</div>
      </div>
      <button onclick="hbCloseManager()" style="padding:7px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.18);color:rgba(255,255,255,0.8);border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-weight:800;font-size:0.78em;">✕ Close</button>
    </div>

    <div style="display:flex;gap:8px;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.08);flex-wrap:wrap;">
      <button id="hbTabBtn_import" onclick="hbSwitchTab('import')" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.35);background:rgba(218,165,32,0.18);color:#fff3c0;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:900;">Import / Parse</button>
      <button id="hbTabBtn_manual" onclick="hbSwitchTab('manual')" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.75);cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:900;">Manual Entry</button>
      <button id="hbTabBtn_active" onclick="hbSwitchTab('active')" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(218,165,32,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.75);cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:900;">Active Homebrew</button>
      <button onclick="hbRunIntegrationCheck()" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(46,204,113,0.45);background:rgba(46,204,113,0.14);color:#a0ffc0;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:900;">✅ Verify Integration</button>
      <span id="hbActiveCounts" style="margin-left:auto;font-family:'Crimson Text',serif;color:rgba(255,255,255,0.6);font-size:0.9em;"></span>
    </div>

    <div style="padding:14px 16px;">
      <div id="hbTab_import">
        <div style="background:rgba(0,0,0,0.22);border:1px solid rgba(218,165,32,0.22);border-radius:10px;padding:12px 14px;margin-bottom:10px;">
          <div style="font-family:'Cinzel',serif;font-size:0.8em;color:#fff3c0;font-weight:900;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">What this parser understands</div>
          <div style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.78);line-height:1.6;">
            It can import <strong>JSON packages</strong> with keys like <em>classes, subclasses, races, items, weapons, armor, spells, features, skills</em>.<br>
            <strong>PDF / Homebrewery:</strong> Select a PDF file, then copy text from your PDF viewer and paste in the box below (items, weapons, armor, spells, stories, anything D&D).<br>
            It can also parse <strong>plain text</strong> if grouped by headings like <em>classes:</em>, <em>spells:</em>, etc. If fields are missing, it uses safe defaults. You can review/disable/remove packages at any time.
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
          <input id="hbPackageName" placeholder="Package name (optional)" style="flex:1;min-width:220px;padding:8px;border:1px solid rgba(218,165,32,0.35);border-radius:6px;background:rgba(255,255,255,0.06);color:#fff3c0;font-family:'Crimson Text',serif;">
          <button onclick="hbImportFromFileClick()" style="padding:8px 12px;border-radius:6px;border:1px solid rgba(52,152,219,0.5);background:rgba(52,152,219,0.15);color:#a0c8ff;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:900;">📁 Import File</button>
          <button onclick="hbPreviewImportFromText()" style="padding:8px 12px;border-radius:6px;border:1px solid rgba(46,204,113,0.5);background:rgba(46,204,113,0.16);color:#a0ffc0;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:900;">Preview Import</button>
          <button onclick="hbApplyPreviewImport()" style="padding:8px 12px;border-radius:6px;border:1px solid rgba(218,165,32,0.45);background:rgba(218,165,32,0.16);color:#fff3c0;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:900;">Apply Preview</button>
        </div>
        <textarea id="hbImportText" spellcheck="false" placeholder="Paste JSON or text here.
\n\nExample JSON:\n{"classes":[{"name":"Blood Hunter","hd":10,"save":["STR","INT"],"weps":["Longsword"],"armor":"Medium Armor","skills":["Survival"],"features":[{"name":"Crimson Rite","desc":"Imbue weapon with elemental rite."}]}],"spells":[{"name":"Hemocraft Bolt","level":1,"school":"Necromancy","desc":"A bolt of blood magic."}]}" style="width:100%;min-height:240px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.9);font-family:Consolas,monospace;font-size:12px;line-height:1.45;"></textarea>
        <div id="hbPreviewPanel" style="display:none;margin-top:10px;background:rgba(0,0,0,0.25);border:1px solid rgba(218,165,32,0.28);border-radius:10px;padding:10px 12px;">
          <div style="font-family:'Cinzel',serif;font-size:0.74em;color:#fff3c0;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:6px;">Dry-Run Diagnostics</div>
          <div id="hbPreviewSummary" style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.8);font-size:0.92em;"></div>
          <div id="hbPreviewWarnings" style="margin-top:6px;font-family:'Crimson Text',serif;color:rgba(255,190,150,0.86);font-size:0.9em;line-height:1.55;"></div>
        </div>
        <input id="hbFileInput" type="file" accept=".json,.txt,.pdf" style="display:none;" onchange="hbHandleFileImport(event)">
      </div>

      <div id="hbTab_manual" style="display:none;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
<!-- ... -->
          <div>
            <label style="display:block;font-family:'Cinzel',serif;font-size:0.72em;color:#fff3c0;margin-bottom:5px;">Type</label>
            <select id="hbManualType" style="width:100%;padding:8px;border:1px solid rgba(218,165,32,0.35);border-radius:6px;background:rgba(255,255,255,0.06);color:#fff3c0;font-family:'Crimson Text',serif;">
              <option value="classes">Class</option>
              <option value="subclasses">Subclass</option>
              <option value="races">Race</option>
              <option value="items">Item</option>
              <option value="weapons">Weapon</option>
              <option value="armor">Armor</option>
              <option value="spells">Spell</option>
              <option value="features">Feature</option>
              <option value="skills">Skill</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-family:'Cinzel',serif;font-size:0.72em;color:#fff3c0;margin-bottom:5px;">Name</label>
            <input id="hbManualName" placeholder="Entry name" style="width:100%;padding:8px;border:1px solid rgba(218,165,32,0.35);border-radius:6px;background:rgba(255,255,255,0.06);color:#fff3c0;font-family:'Crimson Text',serif;">
          </div>
        </div>
        <div style="margin-top:8px;">
          <label style="display:block;font-family:'Cinzel',serif;font-size:0.72em;color:#fff3c0;margin-bottom:5px;">Extra details (JSON object, optional)</label>
          <textarea id="hbManualDetails" spellcheck="false" placeholder='Example for subclass:\n{"className":"Wizard","unlockLevel":2,"features":[{"level":2,"name":"Graviturgy Adept","desc":"You can alter gravity around targets."}],"grantsSpellcasting":true}' style="width:100%;min-height:170px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.9);font-family:Consolas,monospace;font-size:12px;line-height:1.45;"></textarea>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
          <button onclick="hbAddManualEntry()" style="padding:8px 12px;border-radius:6px;border:1px solid rgba(46,204,113,0.5);background:rgba(46,204,113,0.16);color:#a0ffc0;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:900;">+ Add Manual Entry</button>
        </div>
      </div>

      <div id="hbTab_active" style="display:none;">
        <div id="hbPackagesList" style="display:flex;flex-direction:column;gap:8px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="main-container" id="modeNPC">
  <h1 style="display:none;">DND DM Helper</h1>

  <div class="controls">
    <!-- NPC / Monster Tab Switch -->
    <div id="genModeTabBar" style="display:flex;gap:0;margin-bottom:12px;border-radius:8px;overflow:hidden;border:2px solid var(--gold);">
        <button id="genModeTab_npc" onclick="switchGenMode('npc')" style="flex:1;padding:9px 8px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff8dc;border:none;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all 0.2s;">🧙 NPC</button>
        <button id="genModeTab_monster" onclick="switchGenMode('monster')" style="flex:1;padding:9px 8px;background:rgba(255,255,255,0.05);color:rgba(255,248,220,0.5);border:none;border-left:1px solid var(--gold);font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all 0.2s;">🐉 Monster</button>
    </div>

    <!-- ═══ NPC SETTINGS PANEL ═══ -->
    <div id="genPanel_npc">
    <h3>NPC Settings<span id="storyLinkBadgeNPC" style="display:none;margin-left:10px;padding:3px 10px;background:rgba(160,100,255,0.2);border:1px solid rgba(160,100,255,0.55);border-radius:10px;font-family:'Cinzel',serif;font-size:0.62em;color:#c8a8ff;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;">🔗 Story Link Enabled ✓</span></h3>
    <div class="control-group">
      <label>Race</label>
      <select id="raceSel"><option value="">Random</option></select>
        </div>
        <div class="control-group">
            <label>Class</label>
            <select id="classSel"><option value="">Random</option></select>
        </div>
        <div class="control-group">
            <label>Level</label>
            <select id="lvlSel">
                <option value="">Random</option>
                <script>for(let i=1; i<=20; i++) document.write(`<option value="${i}">Level ${i}</option>`);</script>
            </select>
        </div>
        <div class="control-group">
            <label>Quantity</label>
            <input type="number" id="qtyInput" value="1" min="1" max="10">
        </div>
        <div class="control-group checkbox-group">
            <input type="checkbox" id="bossMode">
            <label for="bossMode" style="margin:0; cursor:pointer;">Boss Mode (Legendary)</label>
        </div>

        <!-- ═══ ADVANCED OPTIONS ═══ -->
        <div style="margin:10px 0 8px;">
            <button type="button" onclick="var b=document.getElementById('npcAdvancedOpts');var a=this;if(b.style.display==='none'){b.style.display='block';a.innerHTML='▼ Advanced Options';}else{b.style.display='none';a.innerHTML='▶ Advanced Options';}" style="background:none;border:none;color:#daa520;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;cursor:pointer;padding:0;letter-spacing:0.5px;">▶ Advanced Options</button>
        </div>
        <div id="npcAdvancedOpts" style="display:none;background:rgba(30,20,10,0.5);border:1px solid rgba(139,69,19,0.4);border-radius:6px;padding:12px 14px;margin-bottom:10px;">
            <div class="control-group">
                <label style="color:#daa520;font-size:0.85em;">Content Source</label>
                <select id="npcContentSource" style="width:100%;">
                    <option value="all">All Content</option>
                    <option value="official">Official Only (PHB / SRD)</option>
                    <option value="homebrew">Homebrew Only</option>
                </select>
            </div>
            <div class="control-group">
                <label style="color:#daa520;font-size:0.85em;">Gender</label>
                <select id="npcGenderPref" style="width:100%;">
                    <option value="">Random</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="control-group">
                <label style="color:#daa520;font-size:0.85em;">Alignment</label>
                <select id="npcAlignmentPref" style="width:100%;">
                    <option value="">Random</option>
                    <option value="lawful good">Lawful Good</option>
                    <option value="neutral good">Neutral Good</option>
                    <option value="chaotic good">Chaotic Good</option>
                    <option value="lawful neutral">Lawful Neutral</option>
                    <option value="true neutral">True Neutral</option>
                    <option value="chaotic neutral">Chaotic Neutral</option>
                    <option value="lawful evil">Lawful Evil</option>
                    <option value="neutral evil">Neutral Evil</option>
                    <option value="chaotic evil">Chaotic Evil</option>
                </select>
            </div>
            <div class="control-group checkbox-group">
                <input type="checkbox" id="npcForceSpellcaster" onchange="if(this.checked){document.getElementById('npcForceMartial').checked=false;document.getElementById('lpForceMartial').checked=false;}document.getElementById('lpForceSpellcaster').checked=this.checked;">
                <label for="npcForceSpellcaster" style="margin:0;cursor:pointer;font-size:0.85em;">Spellcaster Only</label>
            </div>
            <div class="control-group checkbox-group">
                <input type="checkbox" id="npcForceMartial" onchange="if(this.checked){document.getElementById('npcForceSpellcaster').checked=false;document.getElementById('lpForceSpellcaster').checked=false;}document.getElementById('lpForceMartial').checked=this.checked;">
                <label for="npcForceMartial" style="margin:0;cursor:pointer;font-size:0.85em;">Martial Only (No Magic)</label>
            </div>
        </div>

        <button class="btn-gen" onclick="generateBatch()">Generate NPCs</button>
    </div>

    <!-- ═══ MONSTER GENERATOR PANEL ═══ -->
    <div id="genPanel_monster" style="display:none;">
        <h3 style="color:#c0392b;">🐉 Monster Generator</h3>
        <div class="control-group">
            <label>Creature Type</label>
            <select id="monCreatureType">
                <option value="">Random</option>
                <option value="Aberration">Aberration</option>
                <option value="Beast">Beast</option>
                <option value="Celestial">Celestial</option>
                <option value="Construct">Construct</option>
                <option value="Dragon">Dragon</option>
                <option value="Elemental">Elemental</option>
                <option value="Fey">Fey</option>
                <option value="Fiend">Fiend</option>
                <option value="Giant">Giant</option>
                <option value="Humanoid">Humanoid</option>
                <option value="Monstrosity">Monstrosity</option>
                <option value="Ooze">Ooze</option>
                <option value="Plant">Plant</option>
                <option value="Undead">Undead</option>
            </select>
        </div>
        <div class="control-group">
            <label>Challenge Rating</label>
            <select id="monCR">
                <option value="">Random</option>
                <option value="0">CR 0</option>
                <option value="0.125">CR 1/8</option>
                <option value="0.25">CR 1/4</option>
                <option value="0.5">CR 1/2</option>
                <script>for(let i=1;i<=30;i++) document.write('<option value="'+i+'">CR '+i+'</option>');</script>
            </select>
        </div>
        <div class="control-group">
            <label>Size</label>
            <select id="monSize">
                <option value="">Random</option>
                <option value="Tiny">Tiny</option>
                <option value="Small">Small</option>
                <option value="Medium">Medium</option>
                <option value="Large">Large</option>
                <option value="Huge">Huge</option>
                <option value="Gargantuan">Gargantuan</option>
            </select>
        </div>
        <div class="control-group">
            <label>Environment</label>
            <select id="monEnvironment">
                <option value="">Random</option>
                <option value="Arctic">Arctic</option>
                <option value="Coastal">Coastal</option>
                <option value="Desert">Desert</option>
                <option value="Forest">Forest</option>
                <option value="Grassland">Grassland</option>
                <option value="Hill">Hill</option>
                <option value="Mountain">Mountain</option>
                <option value="Swamp">Swamp</option>
                <option value="Underdark">Underdark</option>
                <option value="Underwater">Underwater</option>
                <option value="Urban">Urban</option>
            </select>
        </div>
        <div class="control-group">
            <label>Specific Creature <span style="font-size:0.75em;color:rgba(139,69,19,0.6);">(overrides above)</span></label>
            <select id="monSpecific" style="max-width:100%;">
                <option value="">— Random (use filters above) —</option>
            </select>
        </div>
        <div class="control-group">
            <label>Quantity</label>
            <input type="number" id="monQty" value="1" min="1" max="10">
        </div>
        <div class="control-group checkbox-group">
            <input type="checkbox" id="monBoss">
            <label for="monBoss" style="margin:0;cursor:pointer;">Boss Monster (Legendary)</label>
        </div>
        <button class="btn-gen" onclick="generateMonsterBatch()" style="background:linear-gradient(145deg,#8b0000,#5a0000);">🐉 Generate Monsters</button>
    </div>


        <div class="relative-section">
            <h4>Generate Storefront</h4>
            <select id="shopSelect" class="relative-select">
                <option value="">Select shop type...</option>
                <option value="Blacksmith">Blacksmith</option>
                <option value="General Store">General Store</option>
                <option value="Magic Shop">Magic Shop</option>
                <option value="Apothecary">Apothecary</option>
                <option value="Tavern/Inn">Tavern/Inn</option>
                <option value="Fletcher/Bowyer">Fletcher/Bowyer</option>
                <option value="Alchemist">Alchemist</option>
                <option value="Jeweler">Jeweler</option>
                <option value="Leatherworker">Leatherworker</option>
                <option value="Tailor/Weaver">Tailor/Weaver</option>
                <option value="Temple/Shrine">Temple/Shrine</option>
                <option value="Scribe/Library">Scribe/Library</option>
                <option value="Stable">Stable</option>
                <option value="Herbalist">Herbalist</option>
                <option value="Cartographer">Cartographer</option>
                <option value="Tinker">Tinker</option>
                <option value="Black Market">Black Market</option>
                <option value="Enchanted Armoury">Enchanted Armoury</option>
                <option value="The Shadow Dispensary">Shadow Dispensary</option>
                <option value="Travelling Merchant">Travelling Merchant</option>
            </select>
            <button class="btn-small" onclick="generateStorefront()">Generate Shopkeeper</button>
        </div>

        <div class="relative-section">
            <h4>Generate Relative</h4>
            <select id="relativeSelect" class="relative-select">
                <option value="">Select saved NPC...</option>
            </select>
            <button class="btn-small" onclick="generateRelative()">Generate Relative</button>
        </div>

        <div class="relative-section" style="margin-top:15px;">
            <h4>Generate Group</h4>
            <select id="groupType" class="relative-select">
                <option value="">Random Group</option>
                <option value="Adventuring Party">Adventuring Party</option>
                <option value="Bandit Gang">Bandit Gang</option>
                <option value="Master & Disciples">Master & Disciples</option>
                <option value="Mercenary Company">Mercenary Company</option>
                <option value="Cult">Cult</option>
                <option value="Noble House Retinue">Noble House</option>
                <option value="Thieves' Guild">Thieves' Guild</option>
                <option value="Monster Hunters">Monster Hunters</option>
                <option value="Bodyguards">Bodyguards</option>
            </select>
            <button class="btn-small" onclick="generateGroup()">Generate Group</button>
        </div>

        <!-- Bounty Board moved to Quest Generator section -->
        
        <!-- ── NPC Search ── -->
        <div class="relative-section" style="margin-top:15px;">
            <h4 style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                Search / Filter NPCs
                <button class="btn-small" onclick="toggleNPCSearch()" style="padding:3px 8px;font-size:0.8em;">Show/Hide</button>
            </h4>
            <div id="npcSearchBar" style="display:none;flex-direction:column;gap:6px;">
                <input id="npcSearchInput" placeholder="Search by name, race, class..." oninput="filterNPCs()" style="padding:7px 10px;border:2px solid var(--gold);border-radius:5px;background:#fffdf0;font-family:'Crimson Text',serif;font-size:0.95em;width:100%;">
                <div style="display:flex;gap:4px;flex-wrap:wrap;">
                    <button class="npc-filter-btn active" data-filter="all" onclick="setNPCFilter('all',this)">All</button>
                    <button class="npc-filter-btn" data-filter="boss" onclick="setNPCFilter('boss',this)">Boss</button>
                    <button class="npc-filter-btn" data-filter="bounty" onclick="setNPCFilter('bounty',this)">Bounty</button>
                    <button class="npc-filter-btn" data-filter="combat" onclick="setNPCFilter('combat',this)">In Combat</button>
                </div>
            </div>
        </div>

        <h3>Saved NPCs</h3>
        <div id="savedList" class="saved-list"></div>
        <div class="vault-actions" style="margin-top:8px;">
            <button onclick="exportVault()">Export</button>
            <button onclick="document.getElementById('importFile').click()">Import</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importVault(this)">
            <button onclick="clearStorage()">Clear All</button>
        </div>

        <!-- ══ FALLEN NPCs LOG ══ -->
        <div style="margin-top:10px;">
            <div onclick="toggleKilledLog()" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:8px 10px;background:linear-gradient(145deg,#2a0000,#3a0000);border:1px solid rgba(139,0,0,0.5);border-radius:6px;user-select:none;">
                <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:#f08080;text-transform:uppercase;letter-spacing:1px;">☠ Fallen NPCs Log</div>
                <span id="killedLogToggleIcon" style="color:#f08080;font-size:0.85em;">▼</span>
            </div>
            <div id="killedNPCsLogList" style="display:none;margin-top:6px;max-height:260px;overflow-y:auto;">
                <div style="color:rgba(255,255,255,0.25);font-style:italic;text-align:center;padding:10px;font-size:0.82em;">No fallen NPCs yet.</div>
            </div>
        </div>
    </div>

    <div style="grid-column: 2; display: flex; flex-direction: column; gap: 15px;">

        <!-- ══ STORY & WORLD GENERATOR — UNIFIED TABBED CONTAINER ══ -->
        <!-- ══ STORY & WORLD GENERATOR — UNIFIED TABBED CONTAINER ══ -->
        <div id="storyWorldContainer" style="background:linear-gradient(145deg,#0d0d1a,#16213e);border:2px solid var(--gold);border-radius:10px;overflow:hidden;">
            <!-- Header with Collapse Toggle -->
            <div style="background:linear-gradient(135deg,#1a0a2e,#2d0a4e,#3a0000);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
                <div style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="toggleStoryWorldContainer()">
                    <div style="font-family:'Cinzel',serif;font-weight:700;color:#fff8dc;font-size:1.05em;letter-spacing:2px;text-transform:uppercase;">✦ Story &amp; World Generator</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <!-- Active Story dropdown trigger -->
                    <div id="activeStoryBtnWrap" style="position:relative;">
                        <button id="activeStoryTriggerBtn" onclick="toggleActiveStoryDropdown()" title="View active story" style="background:linear-gradient(145deg,rgba(60,0,120,0.7),rgba(40,0,80,0.8));border:1px solid rgba(160,100,255,0.8);border-radius:8px;padding:5px 12px;display:flex;align-items:center;gap:7px;font-family:'Cinzel',serif;font-size:0.7em;font-weight:700;color:#e0c8ff;cursor:pointer;letter-spacing:0.8px;text-transform:uppercase;box-shadow:0 2px 8px rgba(100,0,200,0.25);transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(200,140,255,1)';this.style.boxShadow='0 3px 12px rgba(120,0,255,0.4)'" onmouseout="this.style.borderColor='rgba(160,100,255,0.8)';this.style.boxShadow='0 2px 8px rgba(100,0,200,0.25)'">
                            <span style="font-size:1em;">📖</span>
                            <span id="activeStoryHeaderLabel">Active Story</span>
                            <span style="font-size:0.8em;opacity:0.6;">▼</span>
                        </button>
                    </div>
                    <!-- Active Quest dropdown trigger -->
                    <div id="activeQuestBtnWrap" style="position:relative;display:block;">
                        <button id="activeQuestTriggerBtn" onclick="toggleActiveQuestDropdown()" title="View active quests" style="background:linear-gradient(145deg,rgba(0,40,100,0.7),rgba(0,20,60,0.8));border:1px solid rgba(100,160,255,0.8);border-radius:8px;padding:5px 12px;display:flex;align-items:center;gap:7px;font-family:'Cinzel',serif;font-size:0.7em;font-weight:700;color:#d0e8ff;cursor:pointer;letter-spacing:0.8px;text-transform:uppercase;box-shadow:0 2px 8px rgba(0,80,200,0.25);transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(140,200,255,1)';this.style.boxShadow='0 3px 12px rgba(0,100,255,0.4)'" onmouseout="this.style.borderColor='rgba(100,160,255,0.8)';this.style.boxShadow='0 2px 8px rgba(0,80,200,0.25)'">
                            <span id="activeQuestIndicator" style="color:#80c0ff;font-size:1em;"></span>
                            <span>⚡ Active Quests</span>
                            <span style="font-size:0.8em;opacity:0.6;">▼</span>
                        </button>
                    </div>
                    <!-- Active Bounties dropdown trigger -->
                    <div id="activeBountyBtnWrap" style="position:relative;display:block;">
                        <button id="activeBountyTriggerBtn" onclick="toggleActiveBountyDropdown()" title="View active bounties" style="background:linear-gradient(145deg,rgba(100,55,0,0.7),rgba(70,35,0,0.8));border:1px solid rgba(218,165,32,0.8);border-radius:8px;padding:5px 12px;display:flex;align-items:center;gap:7px;font-family:'Cinzel',serif;font-size:0.7em;font-weight:700;color:#ffe8a0;cursor:pointer;letter-spacing:0.8px;text-transform:uppercase;box-shadow:0 2px 8px rgba(180,100,0,0.25);transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,210,80,1)';this.style.boxShadow='0 3px 12px rgba(200,130,0,0.4)'" onmouseout="this.style.borderColor='rgba(218,165,32,0.8)';this.style.boxShadow='0 2px 8px rgba(180,100,0,0.25)'">
                            <span id="activeBountyIndicator" style="color:#daa520;font-size:1em;"></span>
                            <span>📌 Active Bounties</span>
                            <span style="font-size:0.8em;opacity:0.6;">▼</span>
                        </button>
                    </div>
                    <!-- Active Locations dropdown trigger -->
                    <div id="activeLocationBtnWrap" style="position:relative;display:block;">
                        <button id="activeLocationTriggerBtn" onclick="toggleActiveLocationDropdown()" title="View active locations" style="background:linear-gradient(145deg,rgba(0,60,20,0.7),rgba(0,40,10,0.8));border:1px solid rgba(100,200,100,0.8);border-radius:8px;padding:5px 12px;display:flex;align-items:center;gap:7px;font-family:'Cinzel',serif;font-size:0.7em;font-weight:700;color:#c8ffc8;cursor:pointer;letter-spacing:0.8px;text-transform:uppercase;box-shadow:0 2px 8px rgba(0,150,50,0.25);transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(140,255,140,1)';this.style.boxShadow='0 3px 12px rgba(0,180,60,0.4)'" onmouseout="this.style.borderColor='rgba(100,200,100,0.8)';this.style.boxShadow='0 2px 8px rgba(0,150,50,0.25)'">
                            <span id="activeLocationIndicator" style="color:#80e880;font-size:1em;"></span>
                            <span>📍 Active Locations</span>
                            <span style="font-size:0.8em;opacity:0.6;">▼</span>
                        </button>
                    </div>
                    <!-- Active Revenge dropdown trigger -->
                    <div id="activeRevengeBtnWrap" style="position:relative;display:block;">
                        <button id="activeRevengeTriggerBtn" onclick="toggleActiveRevengeDropdown()" title="View active revenge quests" style="background:linear-gradient(145deg,rgba(100,0,0,0.7),rgba(60,0,0,0.8));border:1px solid rgba(255,100,100,0.8);border-radius:8px;padding:5px 12px;display:flex;align-items:center;gap:7px;font-family:'Cinzel',serif;font-size:0.7em;font-weight:700;color:#ffdddd;cursor:pointer;letter-spacing:0.8px;text-transform:uppercase;box-shadow:0 2px 8px rgba(139,0,0,0.25);transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,150,150,1)';this.style.boxShadow='0 3px 12px rgba(139,0,0,0.4)'" onmouseout="this.style.borderColor='rgba(255,100,100,0.8)';this.style.boxShadow='0 2px 8px rgba(139,0,0,0.25)'">
                            <span id="activeRevengeIndicator" style="color:#ff8080;font-size:1em;"></span>
                            <span>☠ Active Revenge</span>
                            <span style="font-size:0.8em;opacity:0.6;">▼</span>
                        </button>
                    </div>
                    <div id="storyLinkBadge" style="display:none;padding:3px 10px;background:rgba(160,100,255,0.25);border:1px solid rgba(160,100,255,0.6);border-radius:10px;font-family:'Cinzel',serif;font-size:0.68em;color:#d0a0ff;font-weight:700;letter-spacing:1px;">🔗 STORY LINKED</div>
                    <div id="swQuickTimeWrap" style="position:relative;display:flex;align-items:center;">
                        <button id="swQTEBtn" onclick="swGenerateQuickTimeEvent()" title="Generate one quick-time event from 100 possibilities" style="padding:5px 10px;background:linear-gradient(145deg,rgba(180,60,30,0.65),rgba(130,30,20,0.8));border:1px solid rgba(255,130,90,0.65);border-radius:8px;color:#ffd9c8;font-family:'Cinzel',serif;font-size:0.66em;font-weight:700;cursor:pointer;letter-spacing:0.8px;text-transform:uppercase;">⚡ QTE x100</button>
                        <div id="swQTEOutput" style="display:none;position:fixed;left:50%;top:124px;transform:translateX(-50%);z-index:17000;width:min(620px,92vw);background:linear-gradient(145deg,#160b08,#1f0f0a);border:1px solid rgba(255,130,90,0.55);border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,0.58);overflow:hidden;">
                            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding:9px 12px;background:rgba(0,0,0,0.3);border-bottom:1px solid rgba(255,130,90,0.28);">
                                <div style="font-family:'Cinzel',serif;color:#ffd7c3;font-size:0.72em;font-weight:700;letter-spacing:1px;text-transform:uppercase;">⚡ Quick Time Event</div>
                                <div style="display:flex;align-items:center;gap:6px;">
                                    <button id="swQTECollapseBtn" onclick="swToggleQTEPopupCollapse()" style="padding:4px 9px;background:rgba(255,130,90,0.15);border:1px solid rgba(255,130,90,0.45);border-radius:6px;color:#ffd7c3;font-family:'Cinzel',serif;font-size:0.64em;cursor:pointer;font-weight:700;">Collapse</button>
                                    <button onclick="swCloseQTEPopup()" style="padding:4px 9px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#e8d8cf;font-family:'Cinzel',serif;font-size:0.64em;cursor:pointer;font-weight:700;">Close</button>
                                </div>
                            </div>
                            <div id="swQTEBody" style="padding:10px 12px;max-height:min(60vh,430px);overflow-y:auto;"></div>
                        </div>
                    </div>
                    <button id="swToggleIcon" onclick="toggleStoryWorldContainer()" style="background:none;border:none;color:#fff8dc;font-size:1.2em;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;">▼</button>
                </div>
            </div>
            <!-- Collapsible Content -->
            <div id="storyWorldContent" style="display:block;">
            <!-- Tabs -->
            <div id="swTabBar" style="display:flex;border-bottom:2px solid rgba(184,134,11,0.3);background:rgba(0,0,0,0.3);">
                <button id="swTab_story"    onclick="swSwitchTab('story')"    style="flex:1;padding:10px 8px;background:linear-gradient(145deg,rgba(100,0,180,0.6),rgba(60,0,120,0.6));border:none;border-bottom:3px solid #a060ff;color:#d0a0ff;font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all 0.2s;">📖 Story</button>
                <button id="swTab_quest"    onclick="swSwitchTab('quest')"    style="flex:1;padding:10px 8px;background:transparent;border:none;border-bottom:3px solid transparent;color:rgba(255,248,220,0.5);font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all 0.2s;">📜 Quests</button>
                <button id="swTab_bounty"   onclick="swSwitchTab('bounty')"   style="flex:1;padding:10px 8px;background:transparent;border:none;border-bottom:3px solid transparent;color:rgba(255,200,100,0.5);font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all 0.2s;">📌 Bounties</button>
                <button id="swTab_revenge"  onclick="swSwitchTab('revenge')"  style="flex:1;padding:10px 8px;background:rgba(139,0,0,0.2);border:none;border-bottom:3px solid rgba(255,120,120,0.6);color:#ffb0b0;font-family:'Cinzel',serif;font-size:0.82em;font-weight:800;cursor:pointer;letter-spacing:1.2px;transition:all 0.2s;box-shadow:0 0 12px rgba(139,0,0,0.2);" title="Revenge quests — from killed NPCs">☠ Revenge Quest</button>
                <button id="swTab_location" onclick="swSwitchTab('location')" style="flex:1;padding:10px 8px;background:transparent;border:none;border-bottom:3px solid transparent;color:rgba(200,255,200,0.5);font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all 0.2s;">🏘 Locations</button>
                <button id="swTab_questnpcs" onclick="swSwitchTab('questnpcs')" style="flex:1;padding:10px 8px;background:transparent;border:none;border-bottom:3px solid transparent;color:rgba(255,180,80,0.5);font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all 0.2s;" title="NPCs generated from quests, bounties & stories">👥 Quest NPCs</button>
            </div>

            <!-- ── TAB: STORY ── -->
            <div id="swPanel_story" style="padding:20px;display:block;">

                <!-- One-shot toggle (simple checkbox) -->
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;padding:10px 16px;background:linear-gradient(145deg,rgba(30,25,50,0.7),rgba(40,30,60,0.7));border:1px solid rgba(160,100,255,0.3);border-radius:10px;">
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;flex:1;">
                        <input type="checkbox" id="storyOneshotToggle" checked style="width:18px;height:18px;accent-color:#a060ff;cursor:pointer;">
                        <span style="font-family:'Cinzel',serif;font-weight:700;color:#c0a0ff;font-size:0.9em;letter-spacing:0.5px;">One-Shot</span>
                    </label>
                    <span style="font-family:'Crimson Text',serif;font-size:0.82em;color:rgba(255,255,255,0.5);line-height:1.4;">Generate a self-contained session. If you like it, uncheck to continue the story.</span>
                    <input type="radio" name="storyScope" id="storyScope_oneshot" value="oneshot" checked style="display:none;">
                    <input type="radio" name="storyScope" id="storyScope_campaign" value="campaign" style="display:none;">
                </div>

                <!-- Generate Story: dropdowns + button -->
                <div style="background:linear-gradient(145deg,rgba(20,15,40,0.55),rgba(30,22,50,0.55));border:1px solid rgba(160,100,255,0.3);border-radius:12px;padding:18px;margin-bottom:18px;">
                    <div style="font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;color:#b090e8;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">Generate Story</div>
                    <p style="font-family:'Crimson Text',serif;font-size:0.88em;color:rgba(255,255,255,0.55);margin-bottom:14px;">Pick a genre and tone, then generate a full session-ready story.</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
                        <div>
                            <label style="font-family:'Cinzel',serif;font-size:0.68em;color:var(--gold);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Genre</label>
                            <select id="storyGenre" style="width:100%;padding:9px 10px;border:2px solid rgba(160,100,255,0.35);background:rgba(15,10,25,0.9);color:#efe4ff;border-radius:8px;font-family:'Crimson Text',serif;font-size:0.9em;">
                                <optgroup label="Fantasy"><option value="epic_fantasy">Epic Fantasy</option><option value="dark_fantasy">Dark Fantasy</option><option value="sword_and_sorcery">Sword &amp; Sorcery</option><option value="fairy_tale">Fairy Tale</option><option value="urban_fantasy">Urban Fantasy</option></optgroup>
                                <optgroup label="Style"><option value="high_magic">High Magic</option><option value="low_magic">Low Magic</option><option value="political">Political Intrigue</option><option value="war">War &amp; Conflict</option><option value="heist">Heist &amp; Cunning</option><option value="mystery">Mystery</option><option value="horror">Horror</option><option value="naval">Naval / Sea</option><option value="dungeon_crawl">Dungeon Crawl</option></optgroup>
                            </select>
                        </div>
                        <div>
                            <label style="font-family:'Cinzel',serif;font-size:0.68em;color:var(--gold);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Tone</label>
                            <select id="storyTone" style="width:100%;padding:9px 10px;border:2px solid rgba(160,100,255,0.35);background:rgba(15,10,25,0.9);color:#efe4ff;border-radius:8px;font-family:'Crimson Text',serif;font-size:0.9em;">
                                <option value="grim">Grim &amp; Serious</option><option value="heroic">Heroic &amp; Hopeful</option><option value="hopeful">Bright &amp; Optimistic</option><option value="mysterious">Mysterious</option><option value="tense">Tense &amp; Urgent</option><option value="action">Action-Packed</option><option value="epic">Epic &amp; Grand</option><option value="gritty">Gritty &amp; Grounded</option><option value="pulp">Pulp &amp; Swashbuckling</option><option value="whimsical">Whimsical</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                        <div><label style="font-family:'Cinzel',serif;font-size:0.68em;color:rgba(200,180,255,0.9);display:block;margin-bottom:4px;">Magic Level</label><select id="storyMagicLevel" style="width:100%;padding:8px 10px;border:1px solid rgba(160,100,255,0.35);background:rgba(15,10,25,0.9);color:#efe4ff;border-radius:8px;font-size:0.88em;"><option value="">Any</option><option value="high_magic">High</option><option value="low_magic">Low</option><option value="no_magic">No Magic</option></select></div>
                        <div><label style="font-family:'Cinzel',serif;font-size:0.68em;color:rgba(200,180,255,0.9);display:block;margin-bottom:4px;">Conflict Style</label><select id="storyConflictStyle" style="width:100%;padding:8px 10px;border:1px solid rgba(160,100,255,0.35);background:rgba(15,10,25,0.9);color:#efe4ff;border-radius:8px;font-size:0.88em;"><option value="">Any</option><option value="martial">Martial</option><option value="military">Military</option><option value="heist">Heist</option><option value="social">Social</option></select></div>
                    </div>
                    <!-- Hidden selects to keep JS references working -->
                    <select id="storySessionLength" style="display:none;"><option value="240" selected>4 hrs</option></select>
                    <select id="storyPartyTier" style="display:none;"><option value="1" selected>1 (1-4)</option></select>
                    <button type="button" onclick="swGenerateStory()" style="width:100%;padding:13px 20px;background:linear-gradient(145deg,#4a0080,#6a00b0);color:#e0c0ff;border:2px solid rgba(160,100,255,0.5);border-radius:10px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.95em;font-weight:700;letter-spacing:0.5px;transition:all 0.2s;">✨ Generate Story</button>
                </div>

                <!-- Generate Story with AI: prompt + button -->
                <div style="background:linear-gradient(145deg,rgba(25,15,50,0.65),rgba(40,25,70,0.65));border:1px solid rgba(160,100,255,0.35);border-radius:12px;padding:18px;margin-bottom:18px;">
                    <div style="font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;color:#c0a0ff;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">Generate Story with AI</div>
                    <p style="font-family:'Crimson Text',serif;font-size:0.88em;color:rgba(255,255,255,0.55);margin-bottom:10px;">Describe the story you want, or leave blank for a random story based on your settings above.</p>
                    <p style="font-size:0.76em;color:rgba(200,180,255,0.55);margin-bottom:12px;">⏱ Usually 1–3 min. Use <strong>Cancel</strong> if it takes too long, then check Options → AI.</p>
                    <textarea id="swStoryAIPrompt" rows="3" placeholder="e.g. A party of adventurers discovers a hidden temple beneath a bustling city…" style="width:100%;padding:10px 12px;border:2px solid rgba(160,100,255,0.35);background:rgba(10,8,20,0.9);color:#efe4ff;border-radius:8px;font-size:0.9em;font-family:'Crimson Text',serif;resize:vertical;margin-bottom:12px;box-sizing:border-box;"></textarea>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <button type="button" id="swGenerateStoryWithAIBtn" onclick="swGenerateStoryWithAI()" style="padding:12px 20px;background:linear-gradient(145deg,#3a0060,#5a0088);color:#e0c0ff;border:2px solid rgba(160,100,255,0.6);border-radius:10px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.9em;font-weight:700;transition:all 0.2s;">🤖 Generate with AI</button>
                        <button type="button" id="swCancelStoryAIBtn" onclick="swCancelStoryAIGeneration()" style="display:none;padding:12px 18px;background:rgba(120,40,40,0.8);color:#ffb0b0;border:2px solid rgba(200,80,80,0.6);border-radius:10px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.88em;font-weight:700;">Cancel</button>
                        <span id="swStoryAIConnectionStatus" style="font-size:0.78em;color:rgba(200,180,255,0.8);"></span>
                    </div>
                    <div id="swStoryAIFileWarning" style="display:none;margin-top:10px;padding:10px 12px;background:rgba(200,160,0,0.2);border:1px solid rgba(220,180,0,0.6);border-radius:6px;font-size:0.8em;color:#ffeca0;"><strong>⚠ You opened the HTML file — AI won&apos;t work here.</strong> Close this page, install <strong>DND DM Helper</strong> with the installer in this folder, then open the app from the Start Menu. In the app, go to <strong>Options → AI</strong> to set up Ollama.</div>
                </div>

                <!-- Custom Story (import or paste your own) — moved under Generate Story with AI -->
                <div style="background:linear-gradient(145deg,rgba(30,20,50,0.45),rgba(40,28,60,0.45));border:1px solid rgba(160,100,255,0.25);border-radius:12px;padding:18px;margin-bottom:18px;">
                    <div style="font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;color:#d7b3ff;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">📄 Custom Story</div>
                    <p style="font-family:'Crimson Text',serif;font-size:0.85em;color:rgba(255,255,255,0.5);margin-bottom:10px;">Import or paste your own story. AI can adapt quests and locations from it, or finish a half-done story.</p>
                    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
                        <label style="cursor:pointer;padding:7px 14px;background:rgba(160,100,255,0.15);border:1px solid rgba(160,100,255,0.35);border-radius:8px;color:#e0c0ff;font-size:0.82em;font-family:'Cinzel',serif;font-weight:600;transition:all 0.2s;">📁 Import <input type="file" accept=".txt,.json,.pdf" id="campaignImportFileInput" style="display:none;" onchange="campaignImportFromFile(event)"></label>
                        <button type="button" onclick="campaignAIAdaptContent()" style="padding:7px 14px;background:linear-gradient(145deg,#3a0060,#5a0088);color:#e0c0ff;border:1px solid rgba(160,100,255,0.4);border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.8em;font-weight:600;transition:all 0.2s;">🤖 AI Adapt Content</button>
                        <button type="button" onclick="campaignAIFinishStory()" style="padding:7px 14px;background:rgba(139,0,0,0.25);color:#ffc0c0;border:1px solid rgba(220,80,80,0.4);border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.8em;font-weight:600;transition:all 0.2s;">✏ AI Finish Story</button>
                    </div>
                    <textarea id="campaignImportText" placeholder="Paste your campaign doc or story so far…" style="width:100%;min-height:90px;padding:10px;border:1px solid rgba(160,100,255,0.3);background:rgba(10,8,20,0.85);color:#efe4ff;border-radius:8px;font-family:'Crimson Text',serif;font-size:0.9em;resize:vertical;box-sizing:border-box;"></textarea>
                </div>

                <!-- Advanced / Story link / Seed (collapsible) -->
                <div id="swStoryAIPanelWrap" style="margin-bottom:12px;">
                    <button type="button" id="swStoryAIToggle" onclick="swToggleStoryAIPanel()" style="width:100%;text-align:left;padding:8px 12px;background:rgba(60,40,100,0.3);border:1px solid rgba(160,100,255,0.3);border-radius:6px;color:#a090d0;font-family:'Cinzel',serif;font-size:0.76em;font-weight:700;cursor:pointer;">▸ Advanced: Story link, seed, AI endpoint</button>
                    <div id="swStoryAIPanel" style="display:none;padding:12px;background:rgba(15,10,30,0.85);border:1px solid rgba(160,100,255,0.25);border-radius:6px;border-top:none;margin-top:-2px;">
                        <div id="storyModeBar" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;padding:8px 10px;background:rgba(40,30,70,0.4);border-radius:6px;">
                            <span style="font-family:'Crimson Text',serif;font-size:0.88em;color:rgba(220,200,255,0.8);">Story link: when active, quests &amp; locations tie to your story.</span>
                            <button id="storyLinkToggleBtn" type="button" onclick="swToggleStoryLink()" style="padding:6px 12px;background:rgba(80,40,140,0.5);color:#c0a0ff;border:1px solid rgba(160,100,255,0.4);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.7em;font-weight:700;">Enable Story Link</button>
                        </div>
                        <div id="swSeedBar" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px;"><span style="font-family:'Cinzel',serif;font-size:0.66em;color:#c7adff;font-weight:700;">Seed</span><input id="swSeedInput" placeholder="Optional seed" style="flex:1;min-width:140px;padding:6px 8px;border:1px solid rgba(160,120,255,0.4);background:rgba(10,10,20,0.8);color:#efe4ff;border-radius:5px;font-size:0.88em;" onkeydown="if(event.key==='Enter')swApplySeedFromInput();"><button type="button" onclick="swApplySeedFromInput()" style="padding:5px 10px;background:rgba(80,50,140,0.5);color:#e0c0ff;border-radius:5px;cursor:pointer;font-size:0.75em;font-weight:700;">Apply</button><button type="button" onclick="swClearSeed()" style="padding:5px 10px;background:rgba(100,40,60,0.4);color:#ffb0c0;border-radius:5px;cursor:pointer;font-size:0.75em;">Clear</button><span id="swSeedStatus" style="font-size:0.8em;color:rgba(200,180,255,0.7);">Random</span></div>
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;"><input type="checkbox" id="swStoryAIEnabled" onchange="swSaveStoryAISettings()"><span style="font-size:0.8em;color:#c7adff;">Use local AI (Ollama)</span></label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;"><div><label style="font-size:0.64em;color:rgba(200,180,255,0.8);">AI URL</label><input type="text" id="swStoryAIUrl" placeholder="http://127.0.0.1:11434" onchange="swSaveStoryAISettings()" style="width:100%;padding:5px 8px;border:1px solid rgba(160,120,255,0.4);background:rgba(10,10,20,0.8);color:#efe4ff;border-radius:4px;font-size:0.85em;"></div><div><label style="font-size:0.64em;color:rgba(200,180,255,0.8);">Model</label><input type="text" id="swStoryAIModel" placeholder="llama2" onchange="swSaveStoryAISettings()" style="width:100%;padding:5px 8px;border:1px solid rgba(160,120,255,0.4);background:rgba(10,10,20,0.8);color:#efe4ff;border-radius:4px;font-size:0.85em;"></div></div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;"><input id="storyCampaignFrame" placeholder="Campaign context (optional)" style="padding:5px 8px;border:1px solid rgba(160,120,255,0.4);background:rgba(10,10,20,0.8);color:#efe4ff;border-radius:4px;font-size:0.85em;"><input id="storyPlayerGoal" placeholder="Player goal (optional)" style="padding:5px 8px;border:1px solid rgba(160,120,255,0.4);background:rgba(10,10,20,0.8);color:#efe4ff;border-radius:4px;font-size:0.85em;"></div>
                        <div style="margin-bottom:8px;"><textarea id="storyOpeningPrompt" rows="2" placeholder="Opening scene prompt (optional)" style="width:100%;padding:5px 8px;border:1px solid rgba(160,120,255,0.4);background:rgba(10,10,20,0.8);color:#efe4ff;border-radius:4px;font-size:0.85em;resize:vertical;"></textarea></div>
                        <div id="swStoryAIHowItWorks" style="font-size:0.72em;color:rgba(180,160,255,0.6);margin-bottom:8px;"></div>
                        <button type="button" onclick="swOpenOllamaDownload()" style="padding:6px 12px;background:rgba(50,100,50,0.4);border:1px solid rgba(100,200,100,0.5);color:#a8e8a8;border-radius:5px;cursor:pointer;font-size:0.78em;font-weight:700;">⬇ Install Ollama</button>
                        <button type="button" onclick="swTestStoryAIConnection()" style="margin-left:8px;padding:6px 12px;background:rgba(60,80,120,0.4);border:1px solid rgba(100,140,200,0.5);color:#a0c8ff;border-radius:5px;cursor:pointer;font-size:0.78em;">Test connection</button>
                        <button type="button" id="swBuildOnStoryAIBtn" onclick="swBuildOnStoryWithAI()" style="display:none;margin-left:8px;padding:6px 12px;background:rgba(80,50,140,0.4);color:#c0a0ff;border-radius:5px;cursor:pointer;font-size:0.78em;font-weight:700;">📖 Build on story</button>
                    </div>
                </div>

                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
                    <button onclick="swEvolveStory()" id="swEvolveBtn" style="flex:1;padding:10px;background:rgba(100,50,180,0.3);border:1px solid rgba(160,100,255,0.4);color:#c0a0ff;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;min-width:130px;display:none;">📖 Evolve Story</button>
                    <button onclick="swAddScene()" id="swAddSceneBtn" style="flex:1;padding:10px;background:rgba(80,40,140,0.3);border:1px solid rgba(160,100,255,0.3);color:#b090e8;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;min-width:130px;display:none;">🎭 Add Scene</button>
                    <button onclick="swClearStory()" id="swClearStoryBtn" style="flex:1;padding:10px;background:rgba(139,0,0,0.3);border:1px solid rgba(220,20,60,0.4);color:#ff9090;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;min-width:130px;display:none;">🗑 Clear Story</button>
                </div>
                <div id="swStoryActionRow2" style="display:none;"></div>
                <div id="swStoryOutput" style="display:none;max-height:68vh;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#a060ff #0d0d1a;"></div>
                <div id="swSavedStoriesSection" style="margin-top:12px;display:none;">
                    <div style="font-family:'Cinzel',serif;font-size:0.68em;color:rgba(160,100,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">📚 Saved Stories</div>
                    <div id="swSavedStoriesList" style="max-height:120px;overflow-y:auto;"></div>
                </div>
            </div>

            <!-- ── TAB: QUESTS ── -->
            <div id="swPanel_quest" style="padding:16px;display:none;">
                <div id="questStoryLinkBar" style="display:none;background:rgba(100,50,180,0.2);border:1px solid rgba(160,100,255,0.4);border-radius:6px;padding:7px 12px;margin-bottom:12px;font-family:'Cinzel',serif;font-size:0.72em;color:#c0a0ff;font-weight:700;">🔗 Quests will relate to your active story</div>
                <div id="swQuestNormalControls">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
                    <div>
                        <label style="font-family:'Cinzel',serif;font-size:0.72em;color:var(--gold);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Quest Type</label>
                        <select id="swQuestType" style="width:100%;padding:7px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;">
                            <option value="">Random</option>
                            <option value="assassination">Assassination</option>
                            <option value="retrieve">Retrieve / Heist</option>
                            <option value="escort">Escort / Protect</option>
                            <option value="investigate">Investigate / Mystery</option>
                            <option value="rescue">Rescue</option>
                            <option value="explore">Explore / Clear</option>
                            <option value="defend">Defend / Siege</option>
                            <option value="political">Political Intrigue</option>
                            <option value="curse">Curse / Corruption</option>
                            <option value="war">War / Conflict</option>
                            <option value="divine">Divine / Religious</option>
                            <option value="criminal">Criminal Underworld</option>
                            <option value="infiltration">Infiltration / Spycraft</option>
                            <option value="diplomacy">Diplomacy / Negotiation</option>
                            <option value="ritual">Ritual / Arcane Crisis</option>
                            <option value="horror_hunt">Horror Hunt</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-family:'Cinzel',serif;font-size:0.72em;color:var(--gold);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Difficulty</label>
                        <select id="swQuestDiff" style="width:100%;padding:7px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;">
                            <option value="">Random</option>
                            <option value="easy">Easy (Lvl 1-4)</option>
                            <option value="medium">Medium (Lvl 5-8)</option>
                            <option value="hard">Hard (Lvl 9-12)</option>
                            <option value="deadly">Deadly (Lvl 13-16)</option>
                            <option value="legendary">Legendary (Lvl 17+)</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-family:'Cinzel',serif;font-size:0.72em;color:var(--gold);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Setting</label>
                        <select id="swQuestSetting" style="width:100%;padding:7px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;">
                            <option value="">Random</option>
                            <option value="city">City / Urban</option>
                            <option value="dungeon">Dungeon / Underground</option>
                            <option value="wilderness">Wilderness</option>
                            <option value="sea">Sea / Coast</option>
                            <option value="mountain">Mountain / Highlands</option>
                            <option value="war">Warzone</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-family:'Cinzel',serif;font-size:0.72em;color:var(--gold);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Side Quests</label>
                        <select id="swQuestSideCount" style="width:100%;padding:7px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;">
                            <option value="0">None</option>
                            <option value="1">1 Side Quest</option>
                            <option value="2" selected>2 Side Quests</option>
                            <option value="3">3 Side Quests</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;">
                    <button onclick="swGenerateQuest('main')" style="flex:1;padding:9px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff8dc;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;min-width:110px;">⚔ Quest</button>
                    <button onclick="swGenerateQuest('side')" style="flex:1;padding:9px;background:linear-gradient(145deg,#1a6b5a,#104840);color:#a0e8d0;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;min-width:110px;">📋 Side Quest</button>
                    <button onclick="swGenerateQuest('random')" style="flex:1;padding:9px;background:linear-gradient(145deg,#1a4a28,#2a7a3a);color:#c8ffdc;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;min-width:110px;">🎲 Random</button>
                </div>
                </div>
                <div id="swRevengeTabControls" style="display:none;margin-bottom:14px;">
                    <div style="background:rgba(139,0,0,0.12);border:1px solid rgba(220,80,80,0.4);border-radius:8px;padding:12px 16px;margin-bottom:12px;">
                        <div style="font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:#ffcccc;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">☠ Revenge Quests</div>
                        <div style="font-family:'Crimson Text',serif;font-size:0.88em;color:rgba(255,220,220,0.85);line-height:1.5;">Revenge quests are tied to fallen NPCs. Mark an NPC as <strong>☠ Killed</strong> on their card to create a revenge quest, or generate one below from your Fallen NPCs log (or a random template if none are recorded).</div>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button onclick="generateRevengeQuestFromKilled()" style="flex:1;padding:10px 16px;background:linear-gradient(145deg,#6a0000,#8b0000);color:#fff8dc;border:1px solid rgba(255,150,150,0.5);border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;min-width:180px;">☠ Generate Revenge Quest</button>
                    </div>
                </div>
                <div id="swQuestOutput" style="display:none;background:linear-gradient(145deg,#0d0a18,#13102a);border:2px solid rgba(184,134,11,0.45);border-radius:8px;overflow:hidden;max-height:420px;overflow-y:auto;color:#e8dfc8;font-family:'Crimson Text',serif;scrollbar-width:thin;scrollbar-color:rgba(184,134,11,0.5) transparent;"></div>
                <div id="swQuestActions" style="display:none;margin-top:10px;gap:8px;flex-wrap:wrap;align-items:center;">
                    <button onclick="swSaveQuest()" style="padding:8px 16px;background:var(--gold);color:white;border:none;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;">💾 Save Quest</button>
                    <button id="swQuestActBtnSaveRevenge" onclick="saveRevengeQuest()" style="display:none;padding:8px 16px;background:linear-gradient(145deg,#5a0000,#7a0000);color:#ffcccc;border:1px solid rgba(255,150,150,0.5);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;">💾 Save Revenge Quest</button>
                    <button id="swQuestActBtnSetActiveRevenge" onclick="setActiveRevengeFromCurrent()" style="display:none;padding:8px 16px;background:linear-gradient(145deg,#6a0000,#8b0000);color:#fff8dc;border:1px solid rgba(255,200,100,0.5);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;">⚡ Set as Active Revenge</button>
                    <button id="swQuestActBtnRevengeNPCs" onclick="generateRevengeQuestNPCs()" style="display:none;padding:8px 16px;background:linear-gradient(145deg,#6a0000,#8b0000);color:#fff8dc;border:1px solid rgba(255,248,220,0.5);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;">👥 Generate NPCs for Quest</button>
                    <button onclick="swClearQuest()" style="padding:8px 16px;background:rgba(139,0,0,0.6);color:#ff9090;border:1px solid rgba(220,20,60,0.4);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;">🗑 Clear</button>
                </div>
                <div id="swSavedQuestsSection" style="margin-top:12px;display:none;">
                    <div style="font-family:'Cinzel',serif;font-size:0.68em;color:rgba(184,134,11,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">📋 Saved Quests</div>
                    <div id="swSavedQuestsList" style="max-height:120px;overflow-y:auto;"></div>
                </div>
            </div>

            <!-- ── TAB: BOUNTIES ── -->
            <div id="swPanel_bounty" style="padding:16px;display:none;">
                <div style="background:rgba(180,100,0,0.12);border:1px solid rgba(218,165,32,0.4);border-radius:8px;padding:10px 14px;margin-bottom:14px;">
                    <div style="font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:#daa520;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;">📌 Bounty Generator</div>
                    <div style="font-family:'Crimson Text',serif;font-size:0.82em;color:rgba(255,255,255,0.5);">Generate wanted posters &amp; bounties by CR or roll random. Set quantity for your board.</div>
                </div>

                <!-- Controls row -->
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px;">
                    <div>
                        <label style="font-family:'Cinzel',serif;font-size:0.72em;color:var(--gold);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">CR Rating</label>
                        <select id="swBountyCR" style="width:100%;padding:7px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;">
                            <option value="">🎲 Random</option>
                            <option value="0">CR 0</option>
                            <option value="0.125">CR 1/8</option>
                            <option value="0.25">CR 1/4</option>
                            <option value="0.5">CR 1/2</option>
                            <option value="1">CR 1</option>
                            <option value="2">CR 2</option>
                            <option value="3">CR 3</option>
                            <option value="4">CR 4</option>
                            <option value="5">CR 5</option>
                            <option value="6">CR 6</option>
                            <option value="7">CR 7</option>
                            <option value="8">CR 8</option>
                            <option value="9">CR 9</option>
                            <option value="10">CR 10</option>
                            <option value="11">CR 11</option>
                            <option value="12">CR 12</option>
                            <option value="13">CR 13</option>
                            <option value="14">CR 14</option>
                            <option value="15">CR 15</option>
                            <option value="16">CR 16</option>
                            <option value="17">CR 17</option>
                            <option value="18">CR 18</option>
                            <option value="19">CR 19</option>
                            <option value="20">CR 20</option>
                            <option value="21">CR 21 (Legendary)</option>
                            <option value="22">CR 22 (Legendary)</option>
                            <option value="23">CR 23 (Legendary)</option>
                            <option value="24">CR 24 (Legendary)</option>
                            <option value="25">CR 25 (Legendary)</option>
                            <option value="boss">Boss / Epic</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-family:'Cinzel',serif;font-size:0.72em;color:var(--gold);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Quantity</label>
                        <select id="swBountyQty" style="width:100%;padding:7px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;">
                            <option value="">🎲 Random</option>
                            <option value="1">1 Bounty</option>
                            <option value="2">2 Bounties</option>
                            <option value="3">3 Bounties</option>
                            <option value="4">4 Bounties</option>
                            <option value="5">5 Bounties</option>
                            <option value="6">6 Bounties</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-family:'Cinzel',serif;font-size:0.72em;color:var(--gold);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Bounty Type</label>
                        <select id="swBountyType" style="width:100%;padding:7px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;">
                            <option value="">🎲 Random</option>
                            <option value="capture">Capture Alive</option>
                            <option value="kill">Kill Order</option>
                            <option value="dead_or_alive">Dead or Alive</option>
                            <option value="capture_or_kill">Capture or Kill</option>
                            <option value="retrieve">Retrieve Item</option>
                            <option value="escort">Escort / Protect</option>
                            <option value="investigation">Investigation</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;">
                    <button onclick="swGenerateBounties()" style="flex:2;padding:9px;background:linear-gradient(145deg,#5a3500,#8a5500);color:#ffd700;border:1px solid #b8860b;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;min-width:140px;">📌 Generate Bounties</button>
                    <button onclick="swGenerateBounties('boss')" style="flex:1;padding:9px;background:linear-gradient(145deg,#4a0080,#6a00b0);color:#e0c0ff;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;min-width:110px;">💀 Boss Bounties</button>
                </div>

                <div id="swBountyOutput" style="display:none;flex-direction:column;gap:14px;"></div>
                <div id="swSavedBountiesSection" style="margin-top:12px;display:none;">
                    <div style="font-family:'Cinzel',serif;font-size:0.68em;color:rgba(218,165,32,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">📌 Saved Bounties</div>
                    <div id="swSavedBountiesList" style="max-height:120px;overflow-y:auto;"></div>
                </div>
            </div>

            <!-- ── TAB: LOCATIONS ── -->
            <div id="swPanel_location" style="padding:16px;display:none;">
                <div id="locationStoryLinkBar" style="display:none;background:rgba(100,50,180,0.2);border:1px solid rgba(160,100,255,0.4);border-radius:6px;padding:7px 12px;margin-bottom:12px;font-family:'Cinzel',serif;font-size:0.72em;color:#c0a0ff;font-weight:700;">🔗 Locations will relate to your active story</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
                    <div>
                        <label style="font-family:'Cinzel',serif;font-size:0.72em;color:rgba(100,180,100,0.9);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Location Type</label>
                        <select id="swLocType" style="width:100%;padding:7px;border:2px solid rgba(100,180,100,0.6);background:#0d1a0d;color:#c8ffc8;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;">
                            <option value="">Random Location</option>
                            <option value="tavern">🍺 Tavern / Inn</option>
                            <option value="blacksmith">⚒ Blacksmith</option>
                            <option value="general_store">🛒 General Store</option>
                            <option value="temple">⛪ Temple / Shrine</option>
                            <option value="guild_hall">🏛 Guild Hall</option>
                            <option value="market">🏪 Market Square</option>
                            <option value="library">📚 Library / Archive</option>
                            <option value="dungeon_entrance">⚔ Dungeon Entrance</option>
                            <option value="noble_manor">🏰 Noble Manor</option>
                            <option value="thieves_den">🗡 Thieves Den</option>
                            <option value="barracks">⚔ Barracks / Garrison</option>
                            <option value="magic_shop">✨ Magic Shop</option>
                            <option value="docks">⚓ Docks / Harbour</option>
                            <option value="graveyard">💀 Graveyard</option>
                            <option value="forest_clearing">🌲 Forest Clearing</option>
                            <option value="cave">🕳 Cave / Cavern</option>
                            <option value="ruins">🏚 Ancient Ruins</option>
                            <option value="adventuring_guild">⚔ Adventuring Guild</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-family:'Cinzel',serif;font-size:0.72em;color:rgba(100,180,100,0.9);font-weight:700;display:block;margin-bottom:4px;text-transform:uppercase;">Setting</label>
                        <select id="swLocSetting" style="width:100%;padding:7px;border:2px solid rgba(100,180,100,0.6);background:#0d1a0d;color:#c8ffc8;border-radius:4px;font-family:'Crimson Text',serif;font-size:0.9em;">
                            <option value="">Any Setting</option>
                            <option value="city">City / Urban</option>
                            <option value="town">Small Town</option>
                            <option value="village">Remote Village</option>
                            <option value="dungeon">Underground</option>
                            <option value="port">Port City</option>
                            <option value="frontier">Frontier / Wilderness</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;">
                    <button onclick="swGenerateLocation()" style="flex:1;padding:9px;background:linear-gradient(145deg,#1a4a1a,#2a6a2a);color:#c8ffc8;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;min-width:140px;">🏘 Generate Location</button>
                </div>
                <div id="swLocOutput" style="display:none;max-height:380px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#60c860 #0d0d1a;"></div>
                <div id="encounterGenResult" style="display:none;"></div>
                <div style="margin-top:10px;">
                    <div style="font-family:'Cinzel',serif;font-size:0.68em;color:rgba(100,180,100,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">📌 Saved Locations</div>
                    <div id="swSavedLocsList" style="max-height:100px;overflow-y:auto;"></div>
                </div>
            </div>

            <!-- ── TAB: QUEST GENERATED NPCs ── -->
            <div id="swPanel_questnpcs" style="padding:16px;display:none;">
                <div style="background:rgba(180,100,0,0.12);border:1px solid rgba(218,165,32,0.4);border-radius:8px;padding:10px 14px;margin-bottom:14px;">
                    <div style="font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:#ffcc66;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;">👥 Quest Generated NPCs</div>
                    <div style="font-family:'Crimson Text',serif;font-size:0.82em;color:rgba(255,255,255,0.5);">All NPCs generated from quests, bounties, stories & locations — with context about their role in the narrative.</div>
                </div>
                <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
                    <button onclick="swQuestNPCsFilter('all')" id="swQNFilter_all" style="padding:5px 12px;background:linear-gradient(145deg,#5a3500,#8a5500);color:#ffd700;border:1px solid #b8860b;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;">All</button>
                    <button onclick="swQuestNPCsFilter('quest')" id="swQNFilter_quest" style="padding:5px 12px;background:rgba(139,0,0,0.2);color:rgba(255,200,200,0.7);border:1px solid rgba(139,0,0,0.4);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;">⚔ Quest</button>
                    <button onclick="swQuestNPCsFilter('bounty')" id="swQNFilter_bounty" style="padding:5px 12px;background:rgba(180,100,0,0.2);color:rgba(255,200,100,0.7);border:1px solid rgba(218,165,32,0.4);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;">📌 Bounty</button>
                    <button onclick="swQuestNPCsFilter('story')" id="swQNFilter_story" style="padding:5px 12px;background:rgba(100,0,180,0.2);color:rgba(200,150,255,0.7);border:1px solid rgba(160,100,255,0.4);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;">📖 Story</button>
                    <button onclick="swQuestNPCsFilter('location')" id="swQNFilter_location" style="padding:5px 12px;background:rgba(20,80,20,0.2);color:rgba(150,255,150,0.7);border:1px solid rgba(100,180,100,0.4);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;">🏘 Location</button>
                    <button onclick="swClearQuestNPCLog()" style="padding:5px 12px;background:rgba(80,0,0,0.3);color:rgba(255,100,100,0.7);border:1px solid rgba(139,0,0,0.4);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;margin-left:auto;">🗑 Clear All</button>
                </div>
                <div id="swQuestNPCsPanel" style="display:flex;flex-direction:column;gap:10px;max-height:480px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(184,134,11,0.5) transparent;">
                    <div style="color:rgba(255,255,255,0.25);font-style:italic;text-align:center;padding:30px;font-size:0.85em;">No quest NPCs generated yet.<br><small>Generate NPCs from a Quest, Bounty, Story or Location to see them here.</small></div>
                </div>
            </div>

            </div><!-- End storyWorldContent -->
        </div><!-- End storyWorldContainer -->

        <div id="npcTabsContainer" class="npc-tabs-container">
            <div class="npc-tabs-header">Generated NPCs</div>
            <!-- Initiative Order Panel -->
            <div id="initiativeOrderPanel" class="initiative-order-panel">
                <div class="initiative-order-header">⚡ Initiative Order</div>
                <div style="font-size:0.72em;color:rgba(255,248,220,0.7);margin-bottom:8px;">Turn order: <strong>1st → last</strong> (highest roll first). Add players below, then click &quot;Add Players to Initiative&quot;.</div>
                <!-- Player initiative inputs -->
                <div id="playerInitInputs" style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                    <div style="font-family:'Cinzel',serif;font-size:0.75em;color:var(--gold-light);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">Player initiative (enter roll, then add)</div>
                    <div id="partyInitRows"></div>
                    <button class="btn-add-to-init" onclick="addPartyToInitiative()" style="margin-top:6px;width:100%;">Add Players to Initiative</button>
                </div>
                <div style="font-family:'Cinzel',serif;font-size:0.78em;color:var(--gold-light);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">↳ Turn order (1st → last)</div>
                <div id="initiativeOrderList" class="initiative-order-list"></div>
            </div>
            <div id="npcTabs" class="npc-tabs"></div>
        </div>

        <!-- Batch Combat Controls -->
        <div id="batchControls" class="batch-controls" style="display: none;">
            <button id="combatAllBtn" class="btn-batch btn-combat-all" onclick="toggleAllCombat()">Combat Mode (All)</button>
            <button class="btn-batch btn-add-players-init" onclick="addPartyToInitiative(); if(typeof updateInitiativeOrderPanel==='function')updateInitiativeOrderPanel();" style="background:linear-gradient(145deg,rgba(46,120,80,0.7),rgba(30,80,50,0.85));border:1px solid rgba(100,220,140,0.6);color:#b8ffd0;" title="Add all party members to initiative order">Add Players to Initiative</button>
            <button class="btn-batch btn-init-all" onclick="rollAllInitiative()">Roll All Initiative</button>
        </div>

        <div id="displayArea" class="display-area">
            <div class="empty-state">
                <div style="font-size: 3em; margin-bottom: 20px;">🎲</div>
                Ready to generate legendary NPCs.<br>
                Select your parameters and forge your characters.
            </div>
        </div>
    </div>
</div>


<!-- ══ Player Sheet Modal ══ -->
<div id="playerSheetModal">
    <div class="player-sheet-panel">
        <div style="font-family:'Cinzel',serif;font-size:1.1em;font-weight:700;color:var(--red);border-bottom:2px solid var(--gold);padding-bottom:8px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;">
            <span id="psModalTitle">Player Character</span>
            <div style="display:flex;gap:8px;">
                <button onclick="removePartyMember(document.getElementById('psId').value)" style="background:none;border:1px solid var(--red);color:var(--red);padding:3px 9px;border-radius:4px;cursor:pointer;font-size:0.75em;font-family:'Cinzel',serif;">Remove</button>
                <button onclick="closePlayerSheet()" style="background:none;border:1px solid #888;color:#888;padding:3px 9px;border-radius:4px;cursor:pointer;font-size:0.75em;">X</button>
            </div>
        </div>
        <input type="hidden" id="psId">
        <div class="ps-grid">
            <div class="ps-field" style="grid-column:1/-1;"><label>Character Name</label><input id="psName" placeholder="e.g. Elara Moonshadow"></div>
            <div class="ps-field"><label>Class</label>
                <select id="psClass" onchange="psUpdateSubclasses()">
                    <option>Fighter</option><option>Wizard</option><option>Cleric</option><option>Rogue</option>
                    <option>Ranger</option><option>Paladin</option><option>Barbarian</option><option>Bard</option>
                    <option>Druid</option><option>Monk</option><option>Sorcerer</option><option>Warlock</option><option>Artificer</option>
                    <option value="custom">✦ Custom Class...</option>
                </select>
            </div>
            <div class="ps-field" id="psCustomClassField" style="display:none;"><label>Custom Class Name</label><input id="psCustomClass" placeholder="Enter class name..."></div>
            <div class="ps-field"><label>Subclass</label>
                <select id="psSubclass" onchange="psCheckCustomSubclass()">
                    <option value="">None</option>
                </select>
            </div>
            <div class="ps-field" id="psCustomSubclassField" style="display:none;"><label>Custom Subclass Name</label><input id="psCustomSubclass" placeholder="Enter subclass name..."></div>
            <div class="ps-field"><label>Race</label>
                <select id="psRace" onchange="psCheckCustomRace()">
                    <optgroup label="── Common Races ──">
                        <option>Human</option>
                        <option>Variant Human</option>
                    </optgroup>
                    <optgroup label="── Elf ──">
                        <option>High Elf</option>
                        <option>Wood Elf</option>
                        <option>Dark Elf (Drow)</option>
                        <option>Eladrin</option>
                        <option>Sea Elf</option>
                        <option>Shadar-kai</option>
                    </optgroup>
                    <optgroup label="── Dwarf ──">
                        <option>Hill Dwarf</option>
                        <option>Mountain Dwarf</option>
                        <option>Duergar</option>
                    </optgroup>
                    <optgroup label="── Halfling ──">
                        <option>Lightfoot Halfling</option>
                        <option>Stout Halfling</option>
                        <option>Ghostwise Halfling</option>
                        <option>Lotusden Halfling</option>
                    </optgroup>
                    <optgroup label="── Gnome ──">
                        <option>Forest Gnome</option>
                        <option>Rock Gnome</option>
                        <option>Deep Gnome (Svirfneblin)</option>
                    </optgroup>
                    <optgroup label="── Half-Races ──">
                        <option>Half-Elf</option>
                        <option>Half-Orc</option>
                    </optgroup>
                    <optgroup label="── Tiefling ──">
                        <option>Tiefling (Asmodeus)</option>
                        <option>Tiefling (Dispater)</option>
                        <option>Tiefling (Glasya)</option>
                        <option>Tiefling (Levistus)</option>
                        <option>Tiefling (Mammon)</option>
                        <option>Tiefling (Mephistopheles)</option>
                        <option>Tiefling (Zariel)</option>
                    </optgroup>
                    <optgroup label="── Dragonborn ──">
                        <option>Dragonborn (Black)</option>
                        <option>Dragonborn (Blue)</option>
                        <option>Dragonborn (Brass)</option>
                        <option>Dragonborn (Bronze)</option>
                        <option>Dragonborn (Copper)</option>
                        <option>Dragonborn (Gold)</option>
                        <option>Dragonborn (Green)</option>
                        <option>Dragonborn (Red)</option>
                        <option>Dragonborn (Silver)</option>
                        <option>Dragonborn (White)</option>
                        <option>Chromatic Dragonborn</option>
                        <option>Gem Dragonborn</option>
                        <option>Metallic Dragonborn</option>
                    </optgroup>
                    <optgroup label="── Aasimar ──">
                        <option>Aasimar (Protector)</option>
                        <option>Aasimar (Scourge)</option>
                        <option>Aasimar (Fallen)</option>
                    </optgroup>
                    <optgroup label="── Genasi ──">
                        <option>Air Genasi</option>
                        <option>Earth Genasi</option>
                        <option>Fire Genasi</option>
                        <option>Water Genasi</option>
                    </optgroup>
                    <optgroup label="── Exotic Races ──">
                        <option>Tabaxi</option>
                        <option>Goliath</option>
                        <option>Kenku</option>
                        <option>Lizardfolk</option>
                        <option>Aarakocra</option>
                        <option>Firbolg</option>
                        <option>Bugbear</option>
                        <option>Goblin</option>
                        <option>Hobgoblin</option>
                        <option>Kobold</option>
                        <option>Orc</option>
                        <option>Yuan-ti Pureblood</option>
                        <option>Changeling</option>
                        <option>Kalashtar</option>
                        <option>Shifter</option>
                        <option>Warforged</option>
                        <option>Tortle</option>
                        <option>Triton</option>
                        <option>Loxodon</option>
                        <option>Simic Hybrid</option>
                        <option>Vedalken</option>
                        <option>Centaur</option>
                        <option>Minotaur</option>
                        <option>Leonin</option>
                        <option>Satyr</option>
                        <option>Fairy</option>
                        <option>Harengon</option>
                        <option>Owlin</option>
                        <option>Astral Elf</option>
                        <option>Autognome</option>
                        <option>Giff</option>
                        <option>Hadozee</option>
                        <option>Plasmoid</option>
                        <option>Thri-kreen</option>
                        <option>Aetherborn</option>
                        <option>Grung</option>
                        <option>Locathah</option>
                    </optgroup>
                    <option value="custom">✦ Custom Race...</option>
                </select>
            </div>
            <div class="ps-field" id="psCustomRaceField" style="display:none;"><label>Custom Race Name</label><input id="psCustomRace" placeholder="e.g. Kenku, Lizardfolk..."></div>
            <div class="ps-field" id="psCustomRaceDetailsField" style="display:none;grid-column:1/-1;"><label>Custom Race Traits / Abilities</label><textarea id="psCustomRaceDetails" rows="2" placeholder="Racial traits, special abilities, resistances..."></textarea></div>
            <div class="ps-field"><label>Level</label><input id="psLevel" type="number" min="1" max="20" value="1"></div>
            <div class="ps-field"><label>Background</label><input id="psBackground" placeholder="e.g. Soldier, Sage..."></div>
            <div class="ps-field"><label>Alignment</label>
                <select id="psAlignment">
                    <option value="LG">Lawful Good</option><option value="NG">Neutral Good</option><option value="CG">Chaotic Good</option>
                    <option value="LN">Lawful Neutral</option><option value="TN">True Neutral</option><option value="CN">Chaotic Neutral</option>
                    <option value="LE">Lawful Evil</option><option value="NE">Neutral Evil</option><option value="CE">Chaotic Evil</option>
                </select>
            </div>
            <div class="ps-field"><label>Current HP</label><input id="psHpCurr" type="number" min="0" value="20"></div>
            <div class="ps-field"><label>Max HP</label><input id="psHpMax" type="number" min="1" value="20"></div>
            <div class="ps-field"><label>Armour Class</label><input id="psAC" type="number" min="1" value="10"></div>
            <div class="ps-field"><label>Speed (ft)</label><input id="psSpeed" type="number" min="0" value="30"></div>
        </div>

        <div style="font-family:'Cinzel',serif;font-size:0.77em;color:var(--red);font-weight:700;margin-bottom:6px;text-transform:uppercase;">Ability Scores</div>
        <div class="ps-stat-grid">
            <div class="ps-stat-box"><label>STR</label><input class="ps-field input" id="psstat_STR" type="number" min="1" max="30" value="10" style="width:100%;text-align:center;padding:5px 2px;border:2px solid var(--gold);border-radius:4px;background:#fffdf0;font-size:1.1em;font-weight:700;"></div>
            <div class="ps-stat-box"><label>DEX</label><input class="ps-field input" id="psstat_DEX" type="number" min="1" max="30" value="10" style="width:100%;text-align:center;padding:5px 2px;border:2px solid var(--gold);border-radius:4px;background:#fffdf0;font-size:1.1em;font-weight:700;"></div>
            <div class="ps-stat-box"><label>CON</label><input class="ps-field input" id="psstat_CON" type="number" min="1" max="30" value="10" style="width:100%;text-align:center;padding:5px 2px;border:2px solid var(--gold);border-radius:4px;background:#fffdf0;font-size:1.1em;font-weight:700;"></div>
            <div class="ps-stat-box"><label>INT</label><input class="ps-field input" id="psstat_INT" type="number" min="1" max="30" value="10" style="width:100%;text-align:center;padding:5px 2px;border:2px solid var(--gold);border-radius:4px;background:#fffdf0;font-size:1.1em;font-weight:700;"></div>
            <div class="ps-stat-box"><label>WIS</label><input class="ps-field input" id="psstat_WIS" type="number" min="1" max="30" value="10" style="width:100%;text-align:center;padding:5px 2px;border:2px solid var(--gold);border-radius:4px;background:#fffdf0;font-size:1.1em;font-weight:700;"></div>
            <div class="ps-stat-box"><label>CHA</label><input class="ps-field input" id="psstat_CHA" type="number" min="1" max="30" value="10" style="width:100%;text-align:center;padding:5px 2px;border:2px solid var(--gold);border-radius:4px;background:#fffdf0;font-size:1.1em;font-weight:700;"></div>
        </div>
        <div style="margin-bottom:10px;">
            <div style="font-family:'Cinzel',serif;font-size:0.77em;color:var(--red);font-weight:700;margin-bottom:5px;text-transform:uppercase;">Conditions</div>
            <div id="psConditionsList" style="line-height:2;"></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <input type="checkbox" id="psInsp" style="width:15px;height:15px;">
            <label for="psInsp" style="font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;color:var(--gold-light);cursor:pointer;">Inspiration</label>
        </div>

        <!-- 📖 Known Spells Picker -->
        <div style="margin-bottom:14px;border:2px solid rgba(52,152,219,0.5);border-radius:8px;padding:12px;background:rgba(52,152,219,0.06);">
            <div style="font-family:'Cinzel',serif;font-size:0.77em;color:#3498db;font-weight:700;margin-bottom:8px;text-transform:uppercase;display:flex;align-items:center;gap:10px;">
                📖 Known Spells
                <span style="font-family:'Crimson Text',serif;font-size:0.85em;font-weight:400;color:rgba(52,152,219,0.7);text-transform:none;letter-spacing:0;">Pick from the spell list</span>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                <input id="psSpellSearch" placeholder="Search spells…" oninput="psFilterSpellDropdown()" onfocus="psEnsureSpellPickerReady()" style="flex:1;min-width:220px;padding:8px;border:2px solid rgba(52,152,219,0.4);border-radius:5px;background:#f0f8ff;font-family:'Crimson Text',serif;font-size:0.95em;">
                <button onclick="psAddPickedSpell()" style="padding:8px 12px;background:linear-gradient(145deg,#1a3a6a,#2a4a8a);color:#d0e8ff;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:800;">Add</button>
                <button onclick="psClearKnownSpells()" style="padding:8px 12px;background:rgba(139,0,0,0.15);color:#f08080;border:1px solid rgba(139,0,0,0.35);border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:800;">Clear</button>
            </div>
            <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px;">
                <select id="psSpellSelect" onchange="psShowSelectedSpellDetails()" onclick="psEnsureSpellPickerReady()" style="width:100%;padding:9px 10px;border:2px solid rgba(52,152,219,0.35);border-radius:6px;background:#f0f8ff;font-family:'Crimson Text',serif;font-size:0.95em;">
                    <option value="">— Select a spell —</option>
                </select>
                <div id="psSpellDetails" style="display:none;background:rgba(0,0,0,0.18);border:1px solid rgba(52,152,219,0.25);border-radius:8px;padding:10px 12px;">
                    <div id="psSpellDetailsName" style="font-family:'Cinzel',serif;color:#d0e8ff;font-weight:900;letter-spacing:1px;margin-bottom:4px;"></div>
                    <div id="psSpellDetailsMeta" style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.7);font-size:0.92em;line-height:1.5;"></div>
                    <div id="psSpellDetailsDesc" style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.75);font-size:0.95em;line-height:1.65;margin-top:8px;"></div>
                </div>
            </div>
            <div id="psKnownSpellsTags" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;"></div>
            <input type="hidden" id="psKnownSpellsJson" value="[]">
        </div>

        <div class="ps-field" style="margin-bottom:14px;"><label>Player Notes / Backstory</label><textarea id="psNotes" rows="3" placeholder="Bonds, flaws, ideals, goals, backstory..."></textarea></div>
        <div style="display:flex;gap:10px;">
            <button onclick="savePlayerSheet()" style="flex:1;padding:11px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.95em;font-weight:700;">💾 Save Character</button>
            <button onclick="closePlayerSheet()" style="padding:11px 18px;background:#555;color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;">Cancel</button>
        </div>
    </div>
</div>

<!-- ══ Nemesis Modal ══ -->
<div id="nemesisModal">
    <div style="background:linear-gradient(145deg,#180000,#2a0a0a);border:3px double #8b0000;border-radius:10px;padding:24px;width:480px;max-width:100%;box-shadow:0 10px 40px rgba(139,0,0,0.6);">
        <div style="font-family:'Cinzel',serif;font-size:1.05em;font-weight:700;color:#dc143c;border-bottom:2px solid #8b0000;padding-bottom:8px;margin-bottom:14px;">Mark Nemesis Relationship</div>
        <div id="nemesisContent" style="color:#f0d0d0;margin-bottom:14px;font-size:0.93em;line-height:1.55;"></div>
        <div style="font-family:'Cinzel',serif;font-size:0.82em;color:#dc143c;font-weight:700;margin-bottom:6px;">What happened?</div>
        <div id="nemesisReasonBtns" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;"></div>
        <div style="font-family:'Cinzel',serif;font-size:0.82em;color:#dc143c;font-weight:700;margin-bottom:6px;">Which player?</div>
        <div id="nemesisPlayerList" style="display:flex;flex-direction:column;gap:5px;margin-bottom:14px;max-height:150px;overflow-y:auto;"></div>
        <input type="hidden" id="nemesisNpcId">
        <input type="hidden" id="nemesisSelectedReason" value="">
        <input type="hidden" id="nemesisSelectedPlayer" value="">
        <div style="display:flex;gap:10px;">
            <button onclick="confirmNemesis()" style="flex:1;padding:10px;background:linear-gradient(145deg,#8b0000,#5a0000);color:#fff8dc;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-weight:700;">Confirm</button>
            <button onclick="closeNemesisModal()" style="padding:10px 16px;background:#333;color:#bbb;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;">Cancel</button>
        </div>
    </div>
</div>


</div><!-- /#modeNPC -->

<div id="modeQuest" style="display:none;max-width:1440px;margin:0 auto;padding:0 0 30px;">
<div class="quest-mode-wrapper">

<!-- Quest Sidebar -->
<div class="quest-sidebar">
    <div class="quest-sidebar-title">Quest Tools</div>

    <button class="quest-sidebar-btn" onclick="document.getElementById('questGenBody').classList.add('open');document.getElementById('questGenToggle').classList.add('open');">
        <span class="quest-sidebar-btn-icon">📜</span> Quest Generator
    </button>
    <button class="quest-sidebar-btn" onclick="openEncounterGen()">
        <span class="quest-sidebar-btn-icon">🎲</span> Random Encounter
    </button>
    <button class="quest-sidebar-btn" onclick="openBountyBoard()">
        <span class="quest-sidebar-btn-icon">📌</span> Bounty Board
    </button>

    <div class="quest-sidebar-title" style="margin-top:16px;">Saved Quests</div>
    <div id="savedQuestsSidebar" style="max-height:200px;overflow-y:auto;"></div>

    <div class="quest-sidebar-title" style="margin-top:16px;">Quick Notes</div>
    <textarea id="questQuickNotes" style="width:100%;min-height:80px;padding:8px;border:2px solid var(--gold);border-radius:5px;background:#fffdf0;font-family:'Crimson Text',serif;font-size:0.9em;resize:vertical;" placeholder="Quick session notes..."></textarea>

    <div class="quest-sidebar-title" style="margin-top:16px;">Bounty Board</div>
    <div style="display:flex;flex-direction:column;gap:6px;">
        <select id="bountyLevelSel" class="relative-select" style="width:100%;margin-bottom:0;">
            <option value="">Any Level</option>
            <option value="1-4">Levels 1–4 (Novice)</option>
            <option value="5-8">Levels 5–8 (Seasoned)</option>
            <option value="9-12">Levels 9–12 (Veteran)</option>
            <option value="13-16">Levels 13–16 (Elite)</option>
            <option value="17-20">Levels 17–20 (Legendary)</option>
        </select>
        <button class="btn-small" onclick="openBountyBoard()" style="width:100%;">Open Bounty Board</button>
    </div>

    <div class="quest-sidebar-title" style="margin-top:16px;">Switch to NPCs</div>
    <button class="quest-sidebar-btn" onclick="switchMode('npc')" style="background:rgba(139,0,0,0.1);border-color:var(--red);color:var(--red);">
        <span class="quest-sidebar-btn-icon">⚔️</span> NPC Generator
    </button>
</div>

<!-- Quest Main Area -->
<div>
<!-- ══════════════════════════════════════════════════════════════
     QUEST GENERATOR PANEL
     ══════════════════════════════════════════════════════════════ -->
<div id="questGeneratorPanel">
    <div class="quest-gen-header" onclick="toggleQuestGen()">
        <h2>QUEST GENERATOR</h2>
        <span class="quest-gen-toggle" id="questGenToggle">▼</span>
    </div>
    <div class="quest-gen-body" id="questGenBody">
        <div class="quest-ctrl-row">
            <div class="quest-ctrl">
                <label>Quest Type</label>
                <select id="questType">
                    <option value="">Random</option>
                    <option value="assassination">Assassination</option>
                    <option value="retrieve">Retrieve / Heist</option>
                    <option value="escort">Escort / Protect</option>
                    <option value="investigate">Investigate / Mystery</option>
                    <option value="rescue">Rescue</option>
                    <option value="explore">Explore / Clear</option>
                    <option value="defend">Defend / Siege</option>
                    <option value="political">Political Intrigue</option>
                    <option value="nemesis">Nemesis Quest</option>
                    <option value="curse">Curse / Corruption</option>
                    <option value="war">War / Conflict</option>
                    <option value="divine">Divine / Religious</option>
                    <option value="criminal">Criminal Underworld</option>
                </select>
            </div>
            <div class="quest-ctrl">
                <label>Difficulty</label>
                <select id="questDiff">
                    <option value="">Random</option>
                    <option value="easy">Easy (Lvl 1-4)</option>
                    <option value="medium">Medium (Lvl 5-8)</option>
                    <option value="hard">Hard (Lvl 9-12)</option>
                    <option value="deadly">Deadly (Lvl 13-16)</option>
                    <option value="legendary">Legendary (Lvl 17+)</option>
                </select>
            </div>
            <div class="quest-ctrl">
                <label>Setting</label>
                <select id="questSetting">
                    <option value="">Random</option>
                    <option value="city">City / Urban</option>
                    <option value="dungeon">Dungeon / Ruins</option>
                    <option value="wilderness">Wilderness</option>
                    <option value="sea">Sea / Islands</option>
                    <option value="underdark">Underdark</option>
                    <option value="planar">Planar / Otherworldly</option>
                </select>
            </div>
            <div class="quest-ctrl">
                <label>Side Quests</label>
                <select id="questSideCount">
                    <option value="0">None</option>
                    <option value="1">1 Side Quest</option>
                    <option value="2" selected>2 Side Quests</option>
                    <option value="3">3 Side Quests</option>
                </select>
            </div>
        </div>
        <div class="quest-btn-row">
            <button class="btn-qgen btn-qgen-main" onclick="generateFullQuest()">Generate Main Quest</button>
            <button class="btn-qgen btn-qgen-side" onclick="generateSideQuestsOnly()">Generate Side Quests</button>
            <button class="btn-qgen btn-qgen-rand" onclick="generateRandomSideQuests()">Random Side Quests</button>
            <button class="btn-qgen" onclick="openEncounterGen()" style="background:linear-gradient(145deg,#4a2060,#7a30a0);color:#e8d8ff;box-shadow:0 4px 14px rgba(74,32,96,0.5);">Random Encounter</button>
            <button class="btn-qgen" onclick="generateNemesisQuest()" style="background:linear-gradient(145deg,#6a0000,#8b0000);color:#fff8dc;box-shadow:0 4px 14px rgba(139,0,0,0.5);">☠ Nemesis Quest</button>
            <button class="btn-qgen" onclick="if(typeof swSwitchTab==='function')swSwitchTab('revenge');" style="background:linear-gradient(145deg,#5a0000,#7a0000);color:#ffcccc;box-shadow:0 4px 14px rgba(90,0,0,0.6);border:1px solid rgba(255,80,80,0.3);" title="Open Story & World Revenge tab to generate revenge quests">☠ Revenge Quest</button>
            <button class="btn-qgen" onclick="openSavedQuestsViewer()" style="background:linear-gradient(145deg,#1a3a6a,#2a4a8a);color:#d0e8ff;box-shadow:0 4px 14px rgba(26,58,106,0.5);">📖 Saved Quests</button>
        </div>
        <div id="questArea" class="quest-area"></div>

        <!-- Quest Action Bar -->
        <div class="quest-action-bar" id="questActionBar" style="display:none;">
            <button class="quest-act-btn qab-save" onclick="saveCurrentQuest()">Save Quest</button>
            <button class="quest-act-btn qab-save-revenge" id="questActBtnSaveRevenge" onclick="saveRevengeQuest()" style="display:none;background:linear-gradient(145deg,#5a0000,#7a0000);color:#ffcccc;border:1px solid rgba(255,150,150,0.5);" title="Save this revenge quest to Active Revenge list">💾 Save Revenge Quest</button>
            <button class="quest-act-btn qab-set-active-revenge" id="questActBtnSetActiveRevenge" onclick="setActiveRevengeFromCurrent()" style="display:none;background:linear-gradient(145deg,#6a0000,#8b0000);color:#fff8dc;border:1px solid rgba(255,200,100,0.5);" title="Set as active revenge (show in Active Revenge dropdown)">⚡ Set as Active Revenge</button>
            <button class="quest-act-btn qab-print" onclick="printCurrentQuest()">Print Quest</button>
            <button class="quest-act-btn qab-map" onclick="generateQuestBattleMap()">Generate Battle Map</button>
            <button class="quest-act-btn qab-revenge-npcs" id="questActBtnRevengeNPCs" onclick="generateRevengeQuestNPCs()" style="display:none;background:linear-gradient(145deg,#6a0000,#8b0000);color:#fff8dc;border-color:rgba(255,248,220,0.5);" title="Generate NPCs for this revenge quest (relation + hunters, using same logic as Generate Relative)">👥 Generate NPCs for Quest</button>
            <button class="quest-act-btn" onclick="clearCurrentQuest()" style="background:rgba(139,0,0,0.35);border-color:rgba(220,20,60,0.6);color:#ffb0b0;">🗑 Clear Quest</button>
        </div>

        <!-- Saved Quests -->
        <div id="savedQuestsSection" style="display:none;margin-top:10px;">
            <div style="font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;color:var(--red);margin-bottom:6px;text-transform:uppercase;">Saved Quests</div>
            <div id="savedQuestsList" class="saved-quests-list"></div>
        </div>

        <!-- Quest Battle Map Canvas -->
        <div id="questBattleMapArea" style="display:none;margin-top:14px;">
            <div class="battlemap-section">
                <div class="battlemap-header">Quest Battle Map</div>
                <div class="battlemap-canvas-wrap">
                    <canvas id="questMapCanvas" class="battlemap-canvas" width="640" height="480"></canvas>
                </div>
                <div id="questMapLegend" class="battlemap-legend"></div>
                <button class="battlemap-btn" onclick="generateQuestBattleMap()">Regenerate Map</button>
            </div>
        </div>

        <!-- Bounty Board in Quest Section -->
    </div>
</div>
</div><!-- quest main area -->
</div><!-- quest-mode-wrapper -->
</div><!-- /#modeQuest -->


<!-- Generate Mode Dialog -->
<div id="genModeDialog" class="gen-mode-dialog">
    <div class="gen-mode-box">
        <div class="gen-mode-title">Generate New NPCs</div>
        <div class="gen-mode-subtitle" id="genModeSubtitle">You have NPCs on screen. What would you like to do?</div>
        <div class="gen-mode-btns">
            <button class="gen-mode-btn gen-mode-replace" onclick="confirmGenerate(true)">Remove Current & Generate New</button>
            <button class="gen-mode-btn gen-mode-add" onclick="confirmGenerate(false)">Add to Current NPCs</button>
            <button class="gen-mode-btn gen-mode-cancel" onclick="closeGenDialog()">Cancel</button>
        </div>
    </div>
</div>

<!-- Item Detail Modal -->
<div id="itemModal" class="item-modal" onclick="if(event.target===this)closeItemModal()">
    <div class="item-modal-content">
        <div id="itemModalRarityBar" class="item-modal-rarity-bar"></div>
        <div class="item-modal-header">
            <div class="item-modal-icon" id="itemModalIcon">⚔️</div>
            <div class="item-modal-title-wrap">
                <div class="item-modal-title" id="itemModalTitle">Item Name</div>
                <div class="item-modal-sub" id="itemModalSub">Type · Rarity</div>
            </div>
        </div>
        <div class="item-modal-body">
            <div id="itemRarityBadge" class="item-rarity-badge"></div>
            <div id="itemStatGrid" class="item-stat-grid"></div>
            <div id="itemDescription" class="item-description-box"></div>
            <button class="item-modal-close" onclick="closeItemModal()">Close</button>
        </div>
    </div>
</div>

<!-- Bounty Board Modal -->
<div id="bountyBoardModal" class="app-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.88);display:none;align-items:center;justify-content:center;z-index:29500;overflow-y:auto;padding:20px;">
    <div style="background:linear-gradient(145deg,#f4e4bc,#e8dcc5);border-radius:12px;border:3px double #b8860b;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 70px rgba(0,0,0,0.7);position:relative;">
        <div style="background:linear-gradient(135deg,#5a0000,#8b0000);padding:18px 24px;border-radius:9px 9px 0 0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
            <div>
                <div style="font-family:'Cinzel',serif;font-weight:700;font-size:1.4em;color:#ffd700;letter-spacing:2px;">BOUNTY BOARD</div>
                <div style="font-size:0.85em;color:rgba(255,220,100,0.8);margin-top:3px;">Posted by Order of the City Guard &amp; Merchants' Guild</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button onclick="refreshBountyBoard()" style="background:rgba(184,134,11,0.4);border:1px solid #daa520;color:#ffd700;border-radius:6px;padding:6px 14px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;transition:all 0.2s;" onmouseover="this.style.background='rgba(184,134,11,0.7)'" onmouseout="this.style.background='rgba(184,134,11,0.4)'">Refresh Board</button>
                <button onclick="closeBountyBoard()" style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:6px;padding:6px 14px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.9em;">Close</button>
            </div>
        </div>
        <div id="bountyBoardList" style="padding:20px;display:flex;flex-direction:column;gap:14px;"></div>
    </div>
</div>

<!-- Spell Modal -->
<div id="spellModal" class="spell-modal" onclick="if(event.target===this)closeSpellModal()">
    <div class="spell-modal-content">
        <div class="spell-modal-header">
            <div class="spell-modal-icon">✨</div>
            <div class="spell-modal-title">
                <h3 id="modalSpellName">Fireball</h3>
                <div class="spell-type" id="modalSpellType">Evocation</div>
            </div>
            <button class="spell-modal-close" onclick="closeSpellModal()" title="Close spell details">✕ Close</button>
        </div>
        <div class="spell-modal-body">
            <div class="spell-details-grid" id="spellDetailsGrid">
            </div>
            <div class="spell-description" id="modalSpellDescription">
            </div>
            <div class="spell-level-selector" id="spellLevelSelector" style="display:none;">
                <div class="spell-level-selector-label">
                    🎯 Select Casting Level
                </div>
                <div class="spell-level-options" id="spellLevelOptions">
                </div>
            </div>
            <div class="spell-modal-buttons">
                <button class="btn-cast" id="btnCastSpell" onclick="confirmCastSpell()">Cast Spell</button>
                <button class="btn-cancel" onclick="closeSpellModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- External Spell Database (keep this file next to the HTML) -->
<script src="srd-spells.js"></script>

<!-- Monster Generator Data & Logic -->
<script src="monster-data.js"></script>
<script src="monster-gen.js"></script>

<script>
/* =========================================
   D&D 5E DM COMMAND CENTER - ENHANCED
   Features: Fixed spell slots, better descriptions, 
   legendary boss items, combat UI with spells, NPC tabs
   ========================================= */

function psBuildSpellSlotEditor(p) {
    var grid = document.getElementById('psSpellSlotEditorGrid');
    if (!grid) return;
    var ord = ['1st','2nd','3rd','4th','5th','6th','7th','8th','9th'];
    var slots = (p && p.spellSlots && typeof p.spellSlots === 'object') ? p.spellSlots : {};
    grid.innerHTML = ord.map(function(o,i){
        var lvl = i+1;
        var s = slots[lvl] || { curr:0, max:0 };
        return ''
            + '<div style="background:rgba(52,152,219,0.06);border:1px solid rgba(52,152,219,0.22);border-radius:6px;padding:8px 10px;">'
            +   '<div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px;">'
            +     '<span style="font-family:\'Cinzel\',serif;font-size:0.67em;color:#3498db;font-weight:700;">' + o + '</span>'
            +     '<span style="font-size:0.62em;color:rgba(255,255,255,0.45);">curr / max</span>'
            +   '</div>'
            +   '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">'
            +     '<input id="psSlot' + lvl + 'c" type="number" min="0" value="' + (s.curr||0) + '" style="width:100%;padding:6px;border:1px solid rgba(52,152,219,0.35);border-radius:5px;background:#f0f8ff;font-family:\'Cinzel\',serif;font-weight:700;text-align:center;">'
            +     '<input id="psSlot' + lvl + 'm" type="number" min="0" value="' + (s.max||0) + '" style="width:100%;padding:6px;border:1px solid rgba(52,152,219,0.35);border-radius:5px;background:#f0f8ff;font-family:\'Cinzel\',serif;font-weight:700;text-align:center;">'
            +   '</div>'
            + '</div>';
    }).join('');
}

// Global state
let currentSpellCast = null;
let generatedNPCs = [];
let activeNPCId = null;

/* =========================================
   ENHANCED DATA LIBRARY
   ========================================= */
const DB = {
    races: {
        "Human": { mod: {all:1}, speed:30, desc: "Versatile and ambitious.", look: ["weathered traveler's cloak", "calloused hands from labor", "bright, curious eyes", "simple but practical clothes", "confident posture"] },
        "Elf": { mod: {DEX:2, WIS:1}, speed:30, desc: "Fey ancestry, darkvision.", look: ["elegant pointed ears", "flowing silver-blonde hair", "graceful, fluid movements", "ancient, knowing eyes", "a lean, willowy frame"] },
        "Dwarf": { mod: {CON:2, STR:1}, speed:25, desc: "Resilient, darkvision.", look: ["thick braided beard with metal rings", "smells of forge smoke", "heavy steel-toed boots", "stone-like, stoic expression", "barrel-chested build"] },
        "Halfling": { mod: {DEX:2, CHA:1}, speed:25, desc: "Lucky, brave.", look: ["bare, hairy feet", "wild curly hair", "perpetual friendly smile", "always carrying snacks", "childlike wonder in eyes"] },
        "Orc": { mod: {STR:2, CON:1}, speed:30, desc: "Aggressive, darkvision.", look: ["jutting lower tusks", "tribal war paint and tattoos", "numerous battle scars", "green-grey weathered skin", "intimidating musculature"] },
        "Tiefling": { mod: {CHA:2, INT:1}, speed:30, desc: "Infernal legacy, resistance.", look: ["curved demonic horns", "crimson or purple skin", "long, prehensile tail", "faint sulfurous smell", "burning, amber eyes"] },
        "Dragonborn": { mod: {STR:2, CHA:1}, speed:30, desc: "Draconic ancestry, breath weapon.", look: ["shimmering scale-covered skin", "pronounced draconic facial features", "vertical-slit reptilian eyes", "imposing 6'5\" stature", "speaks with hissing accent"] },
        "Gnome": { mod: {INT:2, DEX:1}, speed:25, desc: "Clever, illusion magic.", look: ["oversized pointed hat", "mischievous, twinkling eyes", "colorful, patched robes", "constantly tinkering with gadgets", "quick, fidgety movements"] }
    },

    names: {
        Human: {
            male: ["Aldric", "Bram", "Cedric", "Dane", "Edmund", "Felix", "Godric", "Harlan", "Ivan", "Jasper", "Kade", "Leander", "Maddox", "Nikolai", "Orion", "Pierce", "Quentin", "Roderick", "Silas", "Theron", "Ulric", "Victor", "Wesley", "Xander", "York", "Zane"],
            female: ["Aria", "Beatrice", "Celeste", "Diana", "Elena", "Fiona", "Gwen", "Helena", "Iris", "Julia", "Kira", "Lyra", "Mara", "Nora", "Ophelia", "Petra", "Quinn", "Rosa", "Seraphina", "Thalia", "Una", "Vera", "Willow", "Xena", "Yara", "Zara"]
        },
        Elf: {
            male: ["Aelar", "Birel", "Caelynn", "Druindar", "Erevan", "Faelar", "Galinndan", "Horith", "Ivellios", "Jorildyn", "Kellam", "Luthais", "Mindartis", "Naeris", "Orist", "Peren", "Quarion", "Riardon", "Soveliss", "Thamior", "Uthilin", "Varis", "Wraithel", "Xaladin", "Ylyndar", "Zephir"],
            female: ["Adrie", "Birel", "Caelynn", "Drusilia", "Enna", "Felosial", "Gwethil", "Hatae", "Ielenia", "Jelenneth", "Keyleth", "Leshanna", "Meriele", "Naivara", "Oloniara", "Quillathe", "Rhistel", "Silaqui", "Theirastra", "Vadania", "Whisperwind", "Xiloscient", "Yathlanae", "Zindra"]
        },
        Dwarf: {
            male: ["Bruenor", "Dagnal", "Eberk", "Fargrim", "Gardain", "Harbek", "Kildrak", "Morgran", "Orsik", "Rurik", "Taklinn", "Thoradin", "Thorgrim", "Ulfgar", "Vondal", "Baern", "Dain", "Gimgen", "Harbek", "Thorin", "Barendd", "Dorn", "Haldric", "Oskar", "Rangrim", "Thradal"],
            female: ["Amber", "Bardryn", "Dagnal", "Diesa", "Eldeth", "Falkrunn", "Gurdis", "Helja", "Ilde", "Jarana", "Kathra", "Liftrasa", "Mardred", "Nareen", "Ovina", "Riswynn", "Sannl", "Therlin", "Torbera", "Vistra", "Artin", "Audhild", "Gunnloda", "Kristryd", "Oda", "Torgga"]
        },
        Halfling: {
            male: ["Alton", "Beau", "Cade", "Eldon", "Finnan", "Garret", "Lyle", "Milo", "Osborn", "Perrin", "Reed", "Shardon", "Ulmo", "Wellby", "Merric", "Carp", "Eldon", "Errich", "Fildo", "Garret", "Lindal", "Milo", "Nevil", "Osborn", "Ostran", "Perrin"],
            female: ["Andry", "Bree", "Callie", "Euphemia", "Kithri", "Lavinia", "Lidda", "Merla", "Nedda", "Paela", "Portia", "Seraphina", "Shaena", "Trym", "Vani", "Verna", "Amaryllis", "Charmaine", "Cora", "Donnala", "Jillian", "Lavinia", "Merla", "Nedda", "Paela", "Shaena"]
        },
        Orc: {
            male: ["Bagrat", "Durbul", "Ghash", "Grutok", "Korgul", "Lortar", "Mauhulakh", "Nargulg", "Rolfik", "Shagrol", "Ugdumph", "Yambul", "Dench", "Feng", "Gell", "Henk", "Holg", "Imsh", "Keth", "Krusk", "Mhurren", "Ront", "Shump", "Thokk", "Ugreth", "Vurg"],
            female: ["Baggi", "Emen", "Engong", "Kansif", "Myev", "Neega", "Ovak", "Ownka", "Shautha", "Sutha", "Vola", "Volen", "Yevelda", "Arha", "Bendoo", "Duna", "Grima", "Keth", "Ovak", "Shautha", "Sutha", "Tagga", "Uta", "Vola", "Yevelda", "Zhor"]
        },
        Tiefling: {
            male: ["Akmenos", "Barakas", "Damakos", "Ekemon", "Iados", "Kairon", "Leucis", "Melech", "Mordai", "Morthos", "Pelaios", "Skamos", "Therai", "Azazel", "Beleth", "Caim", "Forcas", "Glasya", "Leraje", "Moloch", "Naberius", "Rimmon", "Seere", "Valafar", "Zaebos", "Zagan"],
            female: ["Akta", "Bryseis", "Criella", "Damaia", "Ea", "Kallista", "Lerissa", "Makaria", "Nemeia", "Orianna", "Phelaia", "Rieta", "Lilith", "Mazikeen", "Naamah", "Proserpine", "Ardat", "Astarte", "Bellatrix", "Galatea", "Jezebel", "Lavinia", "Morgana", "Pherusa", "Sekhmet", "Vassago"]
        },
        Dragonborn: {
            male: ["Arjhan", "Balasar", "Bharash", "Donaar", "Ghesh", "Heskan", "Kriv", "Medrash", "Nadarr", "Pandjed", "Patrin", "Rhogar", "Shamash", "Shedinn", "Tarhun", "Torinn", "Balthazar", "Dhramir", "Drakon", "Ghrendir", "Jarhren", "Krothak", "Nithragg", "Pyrrhus", "Thandral", "Vorugal"],
            female: ["Akra", "Biri", "Daar", "Farideh", "Harann", "Havilar", "Jheri", "Kava", "Korinn", "Mishann", "Nala", "Perra", "Raiann", "Sora", "Surina", "Thava", "Uadjit", "Drakaina", "Embrath", "Greethen", "Kelitar", "Misvyre", "Quiavarra", "Sethrekar", "Uvanathi", "Zilvith"]
        },
        Gnome: {
            male: ["Alston", "Boddynock", "Brocc", "Burgell", "Dimble", "Eldon", "Erky", "Fonkin", "Frug", "Gerbo", "Gimble", "Glim", "Jebeddo", "Kellen", "Namfoodle", "Orryn", "Roondar", "Seebo", "Sindri", "Warryn", "Wrenn", "Zook", "Bimpnottin", "Brysco", "Delebean", "Fizzlebang"],
            female: ["Bimpnottin", "Breena", "Caramip", "Carlin", "Donella", "Duvamil", "Ella", "Ellywick", "Ellyjobell", "Fimble", "Lilli", "Loopmottin", "Lorilla", "Mardnab", "Nissa", "Nyx", "Oda", "Orla", "Roywyn", "Shamil", "Tana", "Waywocket", "Zanna", "Callybon", "Delebean", "Fizzlebottom"]
        }
    },

    titles: ["the Brave", "Swiftfoot", "Ironhand", "the Wise", "Shadow-walker", "Stormborn", "the Merciful", "Doombringer", "the Cunning", "Lightbringer", "the Silent", "the Wanderer", "Dragonslayer", "Oathkeeper", "Nightblade", "the Unyielding", "Flameheart", "Frostborne", "the Mystic", "Truthseeker", "the Scarred", "Moonwhisper", "the Lucky", "Doomhammer", "Bloodraven"],

    conditions: [
        "Blinded",
        "Charmed", 
        "Deafened",
        "Exhausted (Level 1)",
        "Exhausted (Level 2)",
        "Exhausted (Level 3)",
        "Frightened",
        "Grappled",
        "Incapacitated",
        "Invisible",
        "Paralyzed",
        "Petrified",
        "Poisoned",
        "Prone",
        "Restrained",
        "Stunned",
        "Unconscious"
    ],

    startingConditions: [
        "Blinded (one eye)",
        "Deafened (one ear)",
        "Missing left hand",
        "Missing right hand", 
        "Limp (reduced speed)",
        "Chronic pain",
        "Battle fatigue"
    ],

    occupations: [
        "Blacksmith", "Innkeeper", "Merchant", "Farmer", "Guard", "Soldier", "Sailor", "Fisher",
        "Hunter", "Trapper", "Miner", "Carpenter", "Mason", "Baker", "Brewer", "Tailor",
        "Cobbler", "Leatherworker", "Jeweler", "Scribe", "Librarian", "Scholar", "Teacher",
        "Priest", "Acolyte", "Healer", "Herbalist", "Alchemist", "Wizard's Apprentice",
        "Performer", "Bard", "Artist", "Sculptor", "Street Performer", "Acrobat",
        "Thief", "Smuggler", "Fence", "Spy", "Assassin", "Bounty Hunter",
        "Noble", "Courtier", "Diplomat", "Lawyer", "Judge", "Tax Collector",
        "Explorer", "Cartographer", "Guide", "Scout", "Courier", "Messenger",
        "Dock Worker", "Stable Hand", "Servant", "Cook", "Butler", "Maid",
        "Gladiator", "Arena Fighter", "Mercenary", "Bodyguard", "Caravan Guard",
        "Hermit", "Wanderer", "Pilgrim", "Refugee", "Outcast", "Exile",
        "Retired Adventurer", "Former Soldier", "Ex-Criminal", "Fallen Noble"
    ],

    physicalTraits: [
        "missing their left eye, covered with a leather patch",
        "an intricate dragon tattoo snaking up their neck",
        "walks with a pronounced limp from an old war wound",
        "always smells faintly of lavender and pipe smoke",
        "has a distinctive, booming laugh that echoes",
        "wears an eyepatch adorned with a small gemstone",
        "silver-white hair despite appearing young",
        "numerous crossing battle scars across their forearms",
        "wears expensive jewelry on every finger",
        "missing the ring and pinky finger on their left hand",
        "unusual heterochromia - one blue eye, one brown",
        "constantly chews on dried herbs or jerky",
        "speaks with a slight lisp due to a chipped tooth",
        "unusually tall, standing at least 6'6\"",
        "surprisingly short for their race, barely 5 feet",
        "heavily muscled build, barrel-chested and powerful",
        "wears foreign clothing from distant lands",
        "accompanied by a loyal pet raven or cat",
        "constantly fidgets with a coin or trinket",
        "intense, unblinking stare that makes others uncomfortable",
        "a prominent nose, bent from being broken multiple times",
        "speaks in a melodic accent from a faraway kingdom",
        "has calloused, work-worn hands",
        "wears a distinctive signet ring",
        "moves with the grace of a trained dancer or acrobat"
    ],

    personalities: [
        "Gruff but deeply honorable", "Cheerfully optimistic despite hardships", "Suspicious and paranoid of strangers", "Greedy and selfish to a fault",
        "Wise and contemplative, speaks in riddles", "Hot-headed and impulsive, acts before thinking", "Kind and nurturing, motherly", "Sarcastic and cynical, world-weary",
        "Fearful and timid, easily startled", "Arrogant and proud, boastful", "Curious and naive, asks too many questions", "Stoic and silent, rarely speaks",
        "Charismatic and manipulative", "Loyal to a fault, never abandons friends", "Rebellious and free-spirited", "Perfectionist and obsessively orderly",
        "Melancholic and brooding, haunted by past", "Jovial and hedonistic, lives for pleasure", "Ruthless and pragmatic, ends justify means", "Dreamy and artistic, head in clouds",
        "Vengeful and bitter", "Compassionate and empathetic", "Cowardly but clever", "Brave and reckless", "Calculating and strategic"
    ],

    flaws: [
        "Has a severe gambling addiction",
        "Cannot resist a pretty face",
        "Secretly terrified of the dark",
        "Drinks heavily to forget their past",
        "Compulsive liar, even about trivial things",
        "Coward who flees at first sign of danger",
        "Kleptomaniac who steals without thinking",
        "Paranoid, sees enemies everywhere",
        "Arrogant to the point of stupidity",
        "Cannot resist a challenge or dare",
        "Haunted by nightmares, sleeps poorly",
        "Has a price on their head",
        "Owes a dangerous crime lord a fortune",
        "Betrayed their former companions",
        "Addicted to a rare magical substance",
        "Quick to anger, violence-prone",
        "Pathological need to be liked by everyone",
        "Cannot keep a secret",
        "Believes they're destined for greatness",
        "Desperate to prove themselves"
    ],

    classes: {
        "Fighter": { 
            hd: 10, save: ["STR","CON"], 
            weps: ["Longsword", "Greataxe", "Shield", "Greatsword", "Battleaxe", "Lance", "Warhammer"], 
            armor: "Chain Mail",
            skills: ["Athletics", "Survival", "Perception", "Intimidation", "Acrobatics", "Animal Handling"],
            features: [
                {name: "Second Wind", desc: "Bonus Action: Regain 1d10 + Lvl HP (1/Short Rest)"},
                {name: "Action Surge", desc: "Take one additional action on your turn (1/Short Rest)"},
                {name: "Extra Attack", desc: "Attack twice per Attack action (Lvl 5+)"},
                {name: "Indomitable", desc: "Reroll a failed save (1/Long Rest, Lvl 9+)"}
            ],
            spellcasting: false
        },
        "Wizard": { 
            hd: 6, save: ["INT","WIS"], 
            weps: ["Quarterstaff", "Dagger", "Light Crossbow", "Arcane Focus"], 
            armor: "Robes",
            skills: ["Arcana", "History", "Investigation", "Insight", "Medicine", "Religion"],
            features: [
                {name: "Arcane Recovery", desc: "Regain spell slots on short rest (up to half wizard level)"},
                {name: "Spellcasting", desc: "INT-based caster with spellbook"},
                {name: "Ritual Casting", desc: "Cast ritual spells without preparing them"},
                {name: "Arcane Tradition", desc: "Choose school of magic specialization"}
            ],
            spellcasting: true,
            spellAbility: "INT"
        },
        "Rogue": { 
            hd: 8, save: ["DEX","INT"], 
            weps: ["Shortsword", "Dagger", "Shortbow", "Rapier", "Hand Crossbow"], 
            armor: "Leather Armor",
            skills: ["Stealth", "Sleight of Hand", "Perception", "Acrobatics", "Deception", "Insight", "Investigation"],
            features: [
                {name: "Sneak Attack", desc: "Deal extra damage if you have advantage or ally nearby"},
                {name: "Cunning Action", desc: "Bonus Action: Dash, Disengage, or Hide"},
                {name: "Evasion", desc: "Take no damage on successful DEX saves (Lvl 7+)"},
                {name: "Uncanny Dodge", desc: "Halve damage from one attack you see (Lvl 5+)"}
            ],
            spellcasting: false
        },
        "Cleric": { 
            hd: 8, save: ["WIS","CHA"], 
            weps: ["Mace", "Warhammer", "Light Crossbow", "Shield"], 
            armor: "Scale Mail",
            skills: ["Religion", "Insight", "Medicine", "Persuasion", "History"],
            features: [
                {name: "Divine Domain", desc: "Choose a domain (Life, War, Tempest, etc)"},
                {name: "Channel Divinity", desc: "Fuel magical effects (1/Short Rest, more at higher levels)"},
                {name: "Destroy Undead", desc: "Destroy undead below certain CR"},
                {name: "Divine Intervention", desc: "Call upon deity for aid (Lvl 10+)"}
            ],
            spellcasting: true,
            spellAbility: "WIS"
        },
        "Barbarian": {
            hd: 12, save: ["STR", "CON"],
            weps: ["Greataxe", "Javelins", "Greatsword", "Maul", "Handaxe"], 
            armor: "Unarmored",
            skills: ["Athletics", "Intimidation", "Survival", "Perception", "Nature", "Animal Handling"],
            features: [
                {name: "Rage", desc: "Bonus Action: Adv on STR checks/saves, Resistance to physical, +Rage damage"},
                {name: "Reckless Attack", desc: "Advantage on attacks, but enemies have advantage against you"},
                {name: "Danger Sense", desc: "Advantage on DEX saves vs visible effects"},
                {name: "Extra Attack", desc: "Attack twice per Attack action (Lvl 5+)"}
            ],
            spellcasting: false
        },
        "Paladin": {
            hd: 10, save: ["WIS", "CHA"],
            weps: ["Longsword", "Warhammer", "Greatsword", "Shield", "Javelin"],
            armor: "Plate Mail",
            skills: ["Religion", "Insight", "Athletics", "Intimidation", "Medicine", "Persuasion"],
            features: [
                {name: "Divine Smite", desc: "Expend spell slot for extra radiant damage (2d8 + 1d8/slot level)"},
                {name: "Lay on Hands", desc: "Healing pool equal to 5x Paladin level"},
                {name: "Aura of Protection", desc: "You and allies within 10ft add CHA mod to saves"},
                {name: "Sacred Oath", desc: "Devotion, Ancients, Vengeance, etc"}
            ],
            spellcasting: true,
            spellAbility: "CHA"
        },
        "Ranger": {
            hd: 10, save: ["STR", "DEX"],
            weps: ["Longbow", "Shortsword", "Dual Scimitars", "Longsword"],
            armor: "Leather Armor",
            skills: ["Survival", "Nature", "Perception", "Stealth", "Animal Handling", "Athletics", "Investigation"],
            features: [
                {name: "Favored Enemy", desc: "Bonus to track and recall info about chosen foe types"},
                {name: "Natural Explorer", desc: "Advantages in chosen terrain types"},
                {name: "Primeval Awareness", desc: "Sense favored enemies within 5 miles"},
                {name: "Extra Attack", desc: "Attack twice per Attack action (Lvl 5+)"}
            ],
            spellcasting: true,
            spellAbility: "WIS"
        },
        "Sorcerer": {
            hd: 6, save: ["CON", "CHA"],
            weps: ["Quarterstaff", "Dagger", "Light Crossbow", "Arcane Focus"],
            armor: "Robes",
            skills: ["Arcana", "Deception", "Insight", "Persuasion", "Intimidation", "Religion"],
            features: [
                {name: "Sorcerous Origin", desc: "Draconic bloodline, wild magic, divine soul, etc"},
                {name: "Font of Magic", desc: "Convert spell slots to sorcery points and vice versa"},
                {name: "Metamagic", desc: "Modify spells: Twinned, Quickened, Empowered, etc"},
                {name: "Flexible Casting", desc: "Create spell slots or sorcery points"}
            ],
            spellcasting: true,
            spellAbility: "CHA"
        },
        "Warlock": {
            hd: 8, save: ["WIS", "CHA"],
            weps: ["Quarterstaff", "Dagger", "Light Crossbow", "Arcane Focus"],
            armor: "Leather Armor",
            skills: ["Arcana", "Deception", "History", "Intimidation", "Investigation", "Nature", "Religion"],
            features: [
                {name: "Eldritch Invocations", desc: "Magical abilities granted by patron"},
                {name: "Pact Magic", desc: "Regain ALL spell slots on short rest"},
                {name: "Otherworldly Patron", desc: "Fiend, Fey, Great Old One, Celestial, etc"},
                {name: "Pact Boon", desc: "Pact of Chain, Blade, or Tome (Lvl 3)"}
            ],
            spellcasting: true,
            spellAbility: "CHA"
        },
        "Bard": {
            hd: 8, save: ["DEX", "CHA"],
            weps: ["Rapier", "Shortsword", "Hand Crossbow", "Lute"],
            armor: "Leather Armor",
            skills: ["Performance", "Persuasion", "Deception", "Acrobatics", "Sleight of Hand", "Stealth", "Insight"],
            features: [
                {name: "Bardic Inspiration", desc: "Grant d6-d12 bonus to ally's roll (CHA mod times/day)"},
                {name: "Jack of All Trades", desc: "Add half proficiency to all non-proficient checks"},
                {name: "Song of Rest", desc: "Extra healing during short rests"},
                {name: "Expertise", desc: "Double proficiency bonus for two skills"}
            ],
            spellcasting: true,
            spellAbility: "CHA"
        },
        "Monk": {
            hd: 8, save: ["STR", "DEX"],
            weps: ["Unarmed Strike", "Shortsword", "Quarterstaff", "Darts"],
            armor: "Unarmored",
            skills: ["Acrobatics", "Athletics", "History", "Insight", "Religion", "Stealth"],
            features: [
                {name: "Martial Arts", desc: "Use DEX for unarmed strikes, d4-d10 damage"},
                {name: "Ki Points", desc: "Fuel special abilities: Flurry, Patient Defense, Step of Wind"},
                {name: "Unarmored Defense", desc: "AC = 10 + DEX + WIS when not wearing armor"},
                {name: "Stunning Strike", desc: "Spend Ki to potentially stun on hit"}
            ],
            spellcasting: false
        },
        "Druid": {
            hd: 8, save: ["INT", "WIS"],
            weps: ["Quarterstaff", "Scimitar", "Sickle", "Spear"],
            armor: "Leather Armor",
            skills: ["Nature", "Animal Handling", "Survival", "Perception", "Insight", "Medicine", "Religion"],
            features: [
                {name: "Wild Shape", desc: "Transform into beasts (2/Short Rest)"},
                {name: "Druidic", desc: "Secret language of druids"},
                {name: "Druid Circle", desc: "Land, Moon, Dreams, etc"},
                {name: "Timeless Body", desc: "Age slowly (Lvl 18)"}
            ],
            spellcasting: true,
            spellAbility: "WIS"
        }
    },

    // ══════════════════════════════════════════════════════════════════════
    // SUBCLASSES — full D&D 5e subclass list with unlock levels & features
    // ══════════════════════════════════════════════════════════════════════
    subclasses: {
        "Barbarian": {
            unlockLevel: 3,
            options: [
                {
                    name: "Path of the Berserker",
                    features: [
                        { level: 3,  name: "Frenzy",           desc: "Frenzied Rage: bonus action extra melee attack each turn while raging. Suffer 1 level of Exhaustion after rage ends." },
                        { level: 6,  name: "Mindless Rage",    desc: "Can't be charmed or frightened while raging. Effects suspend during rage." },
                        { level: 10, name: "Intimidating Presence", desc: "Action: frighten one creature in 30ft (WIS save vs DC 8+prof+CHA mod). Repeat each turn as bonus action." },
                        { level: 14, name: "Retaliation",      desc: "Reaction: make one melee attack against creature that damages you." }
                    ]
                },
                {
                    name: "Path of the Totem Warrior",
                    features: [
                        { level: 3,  name: "Spirit Seeker",    desc: "Cast Beast Sense and Speak with Animals as rituals. Choose Bear, Eagle, or Wolf totem." },
                        { level: 3,  name: "Totem Spirit",     desc: "Bear: Resistance to all damage while raging (not psychic). Eagle: Dash as bonus action. Wolf: Allies have advantage on melee attacks." },
                        { level: 6,  name: "Aspect of the Beast", desc: "Bear: Carry weight doubled, STR checks advantage. Eagle: Dim light darkvision 60ft. Wolf: Track at fast pace." },
                        { level: 10, name: "Spirit Walker",    desc: "Cast Commune with Nature as ritual." },
                        { level: 14, name: "Totemic Attunement", desc: "Bear: While raging, enemies must attack you. Eagle: Fly at walking speed while raging. Wolf: Knock large/smaller foe prone on hit while raging." }
                    ]
                },
                {
                    name: "Path of the Ancestral Guardian",
                    features: [
                        { level: 3,  name: "Ancestral Protectors", desc: "First creature hit with rage attack: disadvantage attacking others, resistance to others' attacks until next turn." },
                        { level: 6,  name: "Spirit Shield",    desc: "Reaction while raging: reduce damage to ally you see within 30ft by 2d6 (scales with level)." },
                        { level: 10, name: "Consult the Spirits", desc: "Cast Clairvoyance without expending a spell slot (1/short rest)." },
                        { level: 14, name: "Vengeful Ancestors", desc: "Spirit Shield now reflects half the prevented damage back as force damage." }
                    ]
                },
                {
                    name: "Path of the Storm Herald",
                    features: [
                        { level: 3,  name: "Storm Aura",       desc: "While raging, 10ft aura activates. Desert: 1d6 fire to enemies. Sea: 1d6 lightning to one enemy. Tundra: 2 temp HP to all allies." },
                        { level: 6,  name: "Storm Soul",       desc: "Desert: Resist fire, work in extreme heat. Sea: Resist lightning, breathe water, swim speed 30ft. Tundra: Resist cold, work in extreme cold." },
                        { level: 10, name: "Shielding Storm",  desc: "Allies in your storm aura gain the Storm Soul resistance." },
                        { level: 14, name: "Raging Storm",     desc: "Desert: On hit, target DEX save or be blinded. Sea: Knockback 20ft. Tundra: Target STR save or be restrained." }
                    ]
                },
                {
                    name: "Path of the Zealot",
                    features: [
                        { level: 3,  name: "Divine Fury",      desc: "First creature hit each rage: extra 1d6 + half barbarian level necrotic or radiant damage." },
                        { level: 3,  name: "Warrior of the Gods", desc: "Spells that revive you need no material components; you can be revived regardless of death state." },
                        { level: 6,  name: "Fanatical Focus",  desc: "Once per rage: reroll a failed saving throw." },
                        { level: 10, name: "Zealous Presence", desc: "Bonus action: Allies within 60ft get advantage on attacks and saves for 1 round (1/long rest)." },
                        { level: 14, name: "Rage Beyond Death", desc: "While raging, dropping to 0 HP doesn't knock you unconscious; you die only when rage ends or you stop raging." }
                    ]
                },
                {
                    name: "Path of the Beast",
                    features: [
                        { level: 3,  name: "Form of the Beast", desc: "While raging: Bite (1d8 + heal on crit), Claws (1d6 + extra attack), or Tail (1d8 reaction, +1 AC)." },
                        { level: 6,  name: "Bestial Soul",     desc: "Swimming, climbing, or jumping speed equal to walk speed. Breathe underwater. Speak with beasts." },
                        { level: 10, name: "Infectious Fury",  desc: "On hit during rage: WIS save (DC 8+prof+CON) or target attacks nearest ally or takes 2d12 psychic." },
                        { level: 14, name: "Call the Hunt",    desc: "Up to 5 willing creatures within 30ft gain 5 temp HP when you rage. On rage hit, they deal +1d6 (CHA mod/long rest)." }
                    ]
                },
                {
                    name: "Path of Wild Magic",
                    features: [
                        { level: 3,  name: "Magic Awareness",  desc: "Action: Know locations of spells/magic items within 60ft (prof/long rest)." },
                        { level: 3,  name: "Wild Surge",       desc: "Each rage, roll d8 for random magical effect (teleport, fireball burst, spectral shields, etc.)." },
                        { level: 6,  name: "Bolstering Magic", desc: "Touch creature: give 1d3 bonus to attacks/checks (1 min), or restore one expended 1st/2nd level spell slot." },
                        { level: 10, name: "Unstable Backlash", desc: "Reaction on damage/fail save: immediately roll another Wild Surge." },
                        { level: 14, name: "Controlled Surge", desc: "Roll Wild Surge twice, choose which result to use." }
                    ]
                }
            ]
        },

        "Bard": {
            unlockLevel: 3,
            options: [
                {
                    name: "College of Lore",
                    features: [
                        { level: 3,  name: "Bonus Proficiencies", desc: "Gain 3 skill proficiencies of your choice." },
                        { level: 3,  name: "Cutting Words",    desc: "Reaction: expend Bardic Inspiration die to subtract it from creature's attack, save, or ability check." },
                        { level: 6,  name: "Additional Magical Secrets", desc: "Learn 2 spells from any class list (not only at Lvl 10 like other bards)." },
                        { level: 14, name: "Peerless Skill",   desc: "Add Bardic Inspiration die to own ability checks." }
                    ]
                },
                {
                    name: "College of Valor",
                    features: [
                        { level: 3,  name: "Bonus Proficiencies", desc: "Gain medium armor, shields, and martial weapons." },
                        { level: 3,  name: "Combat Inspiration", desc: "Bardic Inspiration can add die to weapon damage or AC vs attack." },
                        { level: 6,  name: "Extra Attack",     desc: "Attack twice per Attack action." },
                        { level: 14, name: "Battle Magic",     desc: "Casting a bard spell lets you make one weapon attack as a bonus action." }
                    ]
                },
                {
                    name: "College of Glamour",
                    features: [
                        { level: 3,  name: "Mantle of Inspiration", desc: "Expend Bardic Inspiration: give up to 5 creatures within 60ft temp HP (Insp die + CHA mod) and move without opportunity attacks." },
                        { level: 3,  name: "Enthralling Performance", desc: "Perform 1 min: up to 5 humanoids charmed for 1 hr (WIS save DC 8+prof+CHA)." },
                        { level: 6,  name: "Mantle of Majesty",desc: "Bonus action: appear majestically. Cast Command as bonus action each turn (1 min, 1/long rest)." },
                        { level: 14, name: "Unbreakable Majesty", desc: "Appear supernaturally majestic; creatures must make CHA save to attack you or take psychic damage." }
                    ]
                },
                {
                    name: "College of Whispers",
                    features: [
                        { level: 3,  name: "Psychic Blades",   desc: "Expend Bardic Inspiration: +2d6 psychic weapon damage (scale up to 8d6 at Lvl 15)." },
                        { level: 3,  name: "Words of Terror",   desc: "After speaking privately 1 min: target WIS save or frightened of you 1 hour (1/short rest)." },
                        { level: 6,  name: "Mantle of Whispers", desc: "When humanoid dies nearby: capture shadow. Use to disguise as them perfectly until caught." },
                        { level: 14, name: "Shadow Lore",       desc: "Whisper secret to creature within 30ft: WIS save or charmed 8 hrs, follows commands, forgets at dawn." }
                    ]
                },
                {
                    name: "College of Swords",
                    features: [
                        { level: 3,  name: "Bonus Proficiencies", desc: "Gain medium armor and scimitar proficiency." },
                        { level: 3,  name: "Fighting Style",   desc: "Choose Dueling or Two-Weapon Fighting." },
                        { level: 3,  name: "Blade Flourish",   desc: "When you attack: move up to speed (no opp. attacks). Defensive Flourish: +Insp die to AC; Slashing Flourish: hit extra nearby creature; Mobile Flourish: push target + teleport." },
                        { level: 6,  name: "Extra Attack",     desc: "Attack twice per Attack action." },
                        { level: 14, name: "Master's Flourish", desc: "Roll Bardic Inspiration die at will; use a d6 instead if you roll lower." }
                    ]
                },
                {
                    name: "College of Creation",
                    features: [
                        { level: 3,  name: "Mote of Potential", desc: "Bardic Inspiration recipients gain bonus effects: attack damage, temp HP, or reroll skill check." },
                        { level: 3,  name: "Performance of Creation", desc: "Create Medium-or-smaller non-magical object out of thin air (1/long rest, scales to Large at Lvl 6+)." },
                        { level: 6,  name: "Animating Performance", desc: "Animate Large/smaller non-magical object as Dancing Item (prof/long rest)." },
                        { level: 14, name: "Creative Crescendo", desc: "Performance of Creation becomes free and creates multiple objects." }
                    ]
                },
                {
                    name: "College of Eloquence",
                    features: [
                        { level: 3,  name: "Silver Tongue",    desc: "Minimum roll of 10 on Persuasion and Deception checks." },
                        { level: 3,  name: "Unsettling Words",  desc: "Expend Bardic Inspiration: target subtracts the die from next saving throw." },
                        { level: 6,  name: "Unfailing Inspiration", desc: "Allies keep Bardic Inspiration die even on failed rolls." },
                        { level: 6,  name: "Universal Speech", desc: "Speak and be understood by all creatures for 1 hour (prof/long rest)." },
                        { level: 14, name: "Infectious Inspiration", desc: "Reaction: when ally uses Bardic Inspiration and succeeds, give another ally a die for free." }
                    ]
                }
            ]
        },

        "Cleric": {
            unlockLevel: 1,
            options: [
                {
                    name: "Life Domain",
                    features: [
                        { level: 1,  name: "Bonus Proficiency", desc: "Heavy armor proficiency." },
                        { level: 1,  name: "Disciple of Life",  desc: "Healing spells restore additional 2 + spell level HP." },
                        { level: 2,  name: "Preserve Life",     desc: "Channel Divinity: Restore HP equal to 5x cleric level, split among creatures within 30ft (up to half HP max)." },
                        { level: 6,  name: "Blessed Healer",    desc: "Healing others also heals you 2 + spell level HP." },
                        { level: 8,  name: "Divine Strike",     desc: "Once per turn: +1d8 radiant damage on weapon hit (2d8 at Lvl 14)." },
                        { level: 17, name: "Supreme Healing",   desc: "Healing dice treated as maximum result." }
                    ]
                },
                {
                    name: "War Domain",
                    features: [
                        { level: 1,  name: "Bonus Proficiencies", desc: "Heavy armor and martial weapons." },
                        { level: 1,  name: "War Priest",        desc: "Make weapon attack as bonus action (WIS mod/long rest)." },
                        { level: 2,  name: "Guided Strike",     desc: "Channel Divinity: +10 to attack roll." },
                        { level: 2,  name: "War God's Blessing", desc: "Reaction: grant +10 to ally's attack roll within 30ft." },
                        { level: 6,  name: "Channel Divinity: War God's Blessing", desc: "Give +10 attack bonus as reaction to any creature within 30ft." },
                        { level: 8,  name: "Divine Strike",     desc: "Once per turn: +1d8 weapon damage type (2d8 at Lvl 14)." },
                        { level: 17, name: "Avatar of Battle",  desc: "Resistance to bludgeoning, piercing, slashing from non-magical weapons." }
                    ]
                },
                {
                    name: "Tempest Domain",
                    features: [
                        { level: 1,  name: "Bonus Proficiencies", desc: "Heavy armor and martial weapons." },
                        { level: 1,  name: "Wrath of the Storm", desc: "Reaction on hit: 2d8 lightning or thunder (DEX save, WIS mod/long rest)." },
                        { level: 2,  name: "Destructive Wrath", desc: "Channel Divinity: Maximize lightning/thunder damage." },
                        { level: 6,  name: "Thunderbolt Strike", desc: "Dealing lightning damage to Large/smaller creature: push 10ft." },
                        { level: 8,  name: "Divine Strike",     desc: "Once per turn: +1d8 thunder damage (2d8 at Lvl 14)." },
                        { level: 17, name: "Stormborn",         desc: "Fly speed equals walk speed outdoors." }
                    ]
                },
                {
                    name: "Light Domain",
                    features: [
                        { level: 1,  name: "Bonus Cantrip",     desc: "Gain the Light cantrip." },
                        { level: 1,  name: "Warding Flare",     desc: "Reaction: impose disadvantage on attacker's roll (WIS mod/long rest)." },
                        { level: 2,  name: "Radiance of the Dawn", desc: "Channel Divinity: Dispel magical darkness, 2d10 + cleric level radiant (CON save)." },
                        { level: 6,  name: "Improved Flare",    desc: "Warding Flare now protects nearby allies as well." },
                        { level: 8,  name: "Potent Spellcasting", desc: "Add WIS modifier to cleric cantrip damage." },
                        { level: 17, name: "Corona of Light",   desc: "Action: activate 60ft aura of light for 1 min; fire and radiant spells treat targets in aura as if you rolled max damage." }
                    ]
                },
                {
                    name: "Trickery Domain",
                    features: [
                        { level: 1,  name: "Blessing of the Trickster", desc: "Touch creature: advantage on Stealth for 1 hour (1/long rest)." },
                        { level: 2,  name: "Invoke Duplicity",  desc: "Channel Divinity: Create illusion duplicate. Attack with advantage when adjacent to original and duplicate." },
                        { level: 6,  name: "Cloak of Shadows",  desc: "Channel Divinity: Go invisible until end of next turn." },
                        { level: 8,  name: "Divine Strike",     desc: "Once per turn: +1d8 poison damage (2d8 at Lvl 14)." },
                        { level: 17, name: "Improved Duplicity", desc: "Create four illusion duplicates instead of one." }
                    ]
                },
                {
                    name: "Knowledge Domain",
                    features: [
                        { level: 1,  name: "Blessings of Knowledge", desc: "Gain 2 more languages and proficiency in 2 INT-based skills." },
                        { level: 2,  name: "Knowledge of the Ages", desc: "Channel Divinity: Gain proficiency in any skill or tool for 10 min." },
                        { level: 2,  name: "Read Thoughts",    desc: "Channel Divinity: Read target's surface thoughts (WIS save)." },
                        { level: 6,  name: "Channel Divinity: Read Thoughts", desc: "Cast Suggestion on creature whose thoughts you read." },
                        { level: 8,  name: "Potent Spellcasting", desc: "Add WIS modifier to cleric cantrip damage." },
                        { level: 17, name: "Visions of the Past", desc: "Action: See echoes of recent past about object or area." }
                    ]
                },
                {
                    name: "Nature Domain",
                    features: [
                        { level: 1,  name: "Acolyte of Nature", desc: "Gain one druid cantrip + proficiency in one skill (Animal Handling, Nature, or Survival)." },
                        { level: 1,  name: "Bonus Proficiency", desc: "Heavy armor proficiency." },
                        { level: 2,  name: "Charm Animals & Plants", desc: "Channel Divinity: Charm beasts and plant creatures within 30ft (WIS save)." },
                        { level: 6,  name: "Dampen Elements",  desc: "Reaction: grant resistance to acid, cold, fire, lightning, or thunder to nearby creature." },
                        { level: 8,  name: "Divine Strike",     desc: "Once per turn: +1d8 cold/fire/lightning damage (2d8 at Lvl 14)." },
                        { level: 17, name: "Master of Nature",  desc: "Command charmed animals and plants." }
                    ]
                },
                {
                    name: "Death Domain",
                    features: [
                        { level: 1,  name: "Bonus Proficiency", desc: "Martial weapons." },
                        { level: 1,  name: "Reaper",           desc: "Cleric cantrips that target one creature can target two within 5ft." },
                        { level: 2,  name: "Touch of Death",    desc: "Channel Divinity: Touch creature to deal 5 + twice cleric level necrotic damage." },
                        { level: 6,  name: "Inescapable Destruction", desc: "Necrotic damage ignores resistance." },
                        { level: 8,  name: "Divine Strike",     desc: "Once per turn: +1d8 necrotic damage (2d8 at Lvl 14)." },
                        { level: 17, name: "Improved Reaper",   desc: "Spells that target one creature can target two within 5ft." }
                    ]
                },
                {
                    name: "Arcana Domain",
                    features: [
                        { level: 1,  name: "Arcane Initiate",  desc: "Gain 2 wizard cantrips and add them to cleric spell list." },
                        { level: 2,  name: "Arcane Abjuration", desc: "Channel Divinity: Turn or banish celestials, elementals, fey, or fiends." },
                        { level: 6,  name: "Spell Breaker",    desc: "Heal spell simultaneously dispels a spell on target of your choice." },
                        { level: 8,  name: "Potent Spellcasting", desc: "Add WIS modifier to cleric cantrip damage." },
                        { level: 17, name: "Arcane Mastery",   desc: "Add one 6th, 7th, 8th, and 9th level wizard spell to domain spell list." }
                    ]
                },
                {
                    name: "Forge Domain",
                    features: [
                        { level: 1,  name: "Bonus Proficiency", desc: "Heavy armor and smith's tools." },
                        { level: 1,  name: "Blessing of the Forge", desc: "Imbue non-magical weapon or armor with +1 (1/long rest)." },
                        { level: 2,  name: "Artisan's Blessing", desc: "Channel Divinity: Create metal object worth up to 100gp over a short rest." },
                        { level: 6,  name: "Soul of the Forge",  desc: "+1 AC wearing heavy armor. Resistance to fire." },
                        { level: 8,  name: "Divine Strike",     desc: "Once per turn: +1d8 fire damage (2d8 at Lvl 14)." },
                        { level: 17, name: "Saint of Forge and Fire", desc: "Immunity to fire. Resistance to bludgeoning, piercing, slashing from non-magical weapons while in heavy armor." }
                    ]
                },
                {
                    name: "Grave Domain",
                    features: [
                        { level: 1,  name: "Circle of Mortality", desc: "Healing a dying (0 HP) creature: maximize healing dice." },
                        { level: 1,  name: "Eyes of the Grave",  desc: "Detect undead within 60ft (WIS mod/long rest)." },
                        { level: 2,  name: "Path to the Grave",  desc: "Channel Divinity: Curse creature so next hit treats it as vulnerable to all damage." },
                        { level: 6,  name: "Sentinel at Death's Door", desc: "Reaction: cancel crit against self or ally within 30ft (WIS mod/long rest)." },
                        { level: 8,  name: "Potent Spellcasting", desc: "Add WIS modifier to cleric cantrip damage." },
                        { level: 17, name: "Keeper of Souls",   desc: "Dying creature within 60ft gives you or ally within 60ft HP equal to half max HP." }
                    ]
                },
                {
                    name: "Order Domain",
                    features: [
                        { level: 1,  name: "Bonus Proficiencies", desc: "Heavy armor and either Intimidation or Persuasion." },
                        { level: 1,  name: "Voice of Authority", desc: "When you cast spell on ally, they can use reaction to make one weapon attack." },
                        { level: 2,  name: "Order's Demand",    desc: "Channel Divinity: Charm creatures in 30ft (WIS save). Charmed creatures drop what they hold." },
                        { level: 6,  name: "Embodiment of the Law", desc: "Cast Enchantment spell of 5th level or less as a bonus action (WIS mod/long rest)." },
                        { level: 8,  name: "Divine Strike",     desc: "Once per turn: +1d8 psychic damage (2d8 at Lvl 14)." },
                        { level: 17, name: "Order's Wrath",     desc: "Divine Strike target is cursed: next ally who attacks it deals +2d8 psychic." }
                    ]
                }
            ]
        },

        "Druid": {
            unlockLevel: 2,
            options: [
                {
                    name: "Circle of the Land",
                    features: [
                        { level: 2,  name: "Bonus Cantrip",     desc: "Gain one additional druid cantrip." },
                        { level: 2,  name: "Natural Recovery",  desc: "Short rest: recover spell slots totalling up to half druid level (1/long rest)." },
                        { level: 2,  name: "Circle Spells",     desc: "Gain extra spells based on chosen land (Arctic, Coast, Desert, Forest, Grassland, Mountain, Swamp, Underdark)." },
                        { level: 6,  name: "Land's Stride",     desc: "Ignore difficult terrain from nonmagical plants. Advantage vs magically created plants." },
                        { level: 10, name: "Nature's Ward",     desc: "Immune to poison/disease. Can't be charmed or frightened by elementals/fey." },
                        { level: 14, name: "Nature's Sanctuary", desc: "Beasts and plants must succeed on WIS save to attack you." }
                    ]
                },
                {
                    name: "Circle of the Moon",
                    features: [
                        { level: 2,  name: "Combat Wild Shape", desc: "Wild Shape as bonus action. Use spell slots while transformed to heal 1d8/slot level." },
                        { level: 2,  name: "Combat Wild Shape", desc: "Wild Shape into beasts up to CR 1 (increases by 1 each two levels, up to CR 6 at Lvl 10)." },
                        { level: 6,  name: "Primal Strike",    desc: "Wild Shape attacks count as magical for overcoming resistance." },
                        { level: 10, name: "Elemental Wild Shape", desc: "Expend two Wild Shape uses to transform into air, earth, fire, or water elemental." },
                        { level: 14, name: "Thousand Forms",   desc: "Cast Alter Self at will." }
                    ]
                },
                {
                    name: "Circle of Spores",
                    features: [
                        { level: 2,  name: "Halo of Spores",   desc: "Reaction on creature entering 10ft: 1d4 necrotic (WIS save). Scales to 1d8/1d12/2d8." },
                        { level: 2,  name: "Symbiotic Entity",  desc: "Wild Shape: 4xDruid level temp HP, double Halo of Spores damage, melee deals +1d6 necrotic." },
                        { level: 6,  name: "Fungal Infestation", desc: "Halo of Spores kills a Small/Medium humanoid: animates as zombie under your control for 1 hour." },
                        { level: 10, name: "Spreading Spores",  desc: "Bonus action: create 10ft cube of spores lasting 1 min; Halo applies to all entering." },
                        { level: 14, name: "Fungal Body",       desc: "Immune to blinded, deafened, frightened, poisoned. Critical hits treated as normal hits." }
                    ]
                },
                {
                    name: "Circle of Stars",
                    features: [
                        { level: 2,  name: "Star Map",          desc: "Gain Guidance cantrip. Cast Guiding Bolt (prof/long rest). Guided by celestial knowledge." },
                        { level: 2,  name: "Starry Form",       desc: "Wild Shape as starry body: Archer (bonus action 1d8+WIS radiant), Chalice (heals nearby on spell cast), Dragon (CON save pass: minimum 10 on concentration)." },
                        { level: 6,  name: "Cosmic Omen",       desc: "Roll d6 on long rest: Weal (d6) or Woe (d6). Reaction to add/subtract that die from attack/save/check." },
                        { level: 10, name: "Twinkling Constellations", desc: "Starry Form improves: Archer fires twice, Chalice heals 1d8+WIS, Dragon flight 20ft." },
                        { level: 14, name: "Full of Stars",     desc: "While in Starry Form: resistant to bludgeoning, piercing, slashing damage." }
                    ]
                },
                {
                    name: "Circle of Dreams",
                    features: [
                        { level: 2,  name: "Balm of the Summer Court", desc: "Pool of d6s equal to druid level. Bonus action: touch creature, restore 1d6+WIS HP." },
                        { level: 6,  name: "Hearth of Moonlight and Shadow", desc: "Short/long rest: 60ft magical radius — intruders must pass WIS save or be noticed." },
                        { level: 10, name: "Hidden Paths",      desc: "Teleport up to 60ft to visible unoccupied space (WIS mod/long rest). Or teleport a touched willing creature." },
                        { level: 14, name: "Walker in Dreams",   desc: "Short rest: cast Dream, Scrying, or Teleportation Circle without expending a spell slot." }
                    ]
                },
                {
                    name: "Circle of Wildfire",
                    features: [
                        { level: 2,  name: "Summon Wildfire Spirit", desc: "Wild Shape: summon Wildfire Spirit instead (can use both). Spirit attacks and heals using bonus action." },
                        { level: 6,  name: "Enhanced Bond",     desc: "Wildfire Spirit present: spells that deal fire or restore HP roll one extra die." },
                        { level: 10, name: "Cauterizing Flames", desc: "When Small/Medium creature dies near you: spectral flame. Reaction: it heals or burns (2d10)." },
                        { level: 14, name: "Blazing Revival",   desc: "Wildfire Spirit explodes when you drop to 0 HP: regain half max HP and destroy the spirit." }
                    ]
                }
            ]
        },

        "Fighter": {
            unlockLevel: 3,
            options: [
                {
                    name: "Champion",
                    features: [
                        { level: 3,  name: "Improved Critical", desc: "Weapon attacks score critical hits on 19 or 20." },
                        { level: 7,  name: "Remarkable Athlete", desc: "Add half proficiency (rounded up) to STR/DEX/CON checks not already proficient." },
                        { level: 10, name: "Additional Fighting Style", desc: "Choose a second Fighting Style." },
                        { level: 15, name: "Superior Critical",  desc: "Weapon attacks score critical hits on 18, 19, or 20." },
                        { level: 18, name: "Survivor",          desc: "Regain HP equal to 5 + CON mod at start of your turn if below half HP and not at 0." }
                    ]
                },
                {
                    name: "Battle Master",
                    features: [
                        { level: 3,  name: "Maneuvers",         desc: "Learn 3 maneuvers using Superiority Dice (d8). Pool: 4 dice (increase with level). DC = 8+prof+STR/DEX mod." },
                        { level: 3,  name: "Student of War",    desc: "Gain one artisan's tool proficiency." },
                        { level: 7,  name: "Know Your Enemy",   desc: "Spend 1 min observing creature: learn comparison of 2 stats vs your own." },
                        { level: 10, name: "Improved Maneuvers", desc: "Superiority Dice become d10. Learn 2 more maneuvers." },
                        { level: 15, name: "Relentless",        desc: "If no Superiority Dice remain on initiative, regain 1 die." },
                        { level: 18, name: "Superior Maneuvers", desc: "Superiority Dice become d12." }
                    ]
                },
                {
                    name: "Eldritch Knight",
                    features: [
                        { level: 3,  name: "Spellcasting",      desc: "Cast wizard spells (INT-based). Limited selection focused on abjuration and evocation." },
                        { level: 3,  name: "Weapon Bond",       desc: "Ritual bond with up to 2 weapons: can't be disarmed; summon to hand as bonus action." },
                        { level: 7,  name: "War Magic",         desc: "Cast cantrip as action: make one weapon attack as bonus action." },
                        { level: 10, name: "Eldritch Strike",   desc: "On weapon hit: target has disadvantage on next saving throw against a spell you cast before end of next turn." },
                        { level: 15, name: "Arcane Charge",     desc: "Action Surge: also teleport up to 30ft to unoccupied space you can see." },
                        { level: 18, name: "Improved War Magic", desc: "Cast spell of 1st or 2nd level as action: make one weapon attack as bonus action." }
                    ]
                },
                {
                    name: "Arcane Archer",
                    features: [
                        { level: 3,  name: "Arcane Archer Lore", desc: "Gain Prestidigitation or Druidcraft cantrip. Proficiency in Arcana or Nature." },
                        { level: 3,  name: "Arcane Shot",       desc: "2 uses/short rest. 12 options: Banishing, Beguiling, Bursting, Enfeebling, Grasping, Insight, Penetrating, Seeking, Shadow, Slowing, Staggering, Twin Shot arrows." },
                        { level: 7,  name: "Magic Arrow",       desc: "Arrows count as magical." },
                        { level: 7,  name: "Curving Shot",      desc: "Miss with Arcane Shot: use bonus action to reroll against different target in 60ft." },
                        { level: 15, name: "Ever-Ready Shot",   desc: "Regain 1 Arcane Shot on initiative if you have none." }
                    ]
                },
                {
                    name: "Cavalier",
                    features: [
                        { level: 3,  name: "Bonus Proficiency", desc: "Animal Handling, History, Insight, Performance, or Persuasion. Also one extra language." },
                        { level: 3,  name: "Born to the Saddle", desc: "Advantage on saves to avoid falling off mount. Mounting/dismounting costs 5ft movement. Mount can Dash/Disengage as reaction." },
                        { level: 3,  name: "Unwavering Mark",  desc: "Melee attack: mark target until end of your next turn. Marked creature has disadvantage vs others; you can use bonus action to attack marked creature that attacked an ally." },
                        { level: 7,  name: "Warding Maneuver",  desc: "Reaction: add 1d8 to ally or mount within 5ft, possibly negate attack." },
                        { level: 10, name: "Hold the Line",     desc: "Opportunity attacks against you cause creature to stop moving (STR save)." },
                        { level: 15, name: "Ferocious Charger", desc: "Charge: knock prone (STR save). Mark: make one extra attack on marked creature." },
                        { level: 18, name: "Vigilant Defender", desc: "Can make opportunity attacks every turn (not just once per round)." }
                    ]
                },
                {
                    name: "Echo Knight",
                    features: [
                        { level: 3,  name: "Manifest Echo",     desc: "Bonus action: summon spectral echo within 15ft. Attacks can originate from echo. Echo has 1 HP and your AC." },
                        { level: 3,  name: "Unleash Incarnation", desc: "Attack action: echo makes one melee attack. (CON mod/long rest)" },
                        { level: 7,  name: "Echo Avatar",       desc: "Action: see/hear through echo for up to 10 min (blind/deafen self)." },
                        { level: 10, name: "Shadow Martyr",     desc: "Reaction: redirect attack targeting ally to hit your echo instead." },
                        { level: 15, name: "Reclaim Potential", desc: "Echo destroyed: gain 2d6 + CON mod temp HP." },
                        { level: 18, name: "Legion of One",     desc: "Two echoes simultaneously. Both attacks during Unleash Incarnation." }
                    ]
                },
                {
                    name: "Psi Warrior",
                    features: [
                        { level: 3,  name: "Psionic Power",     desc: "Pool of Psionic Energy Dice (d6 at start, more at later levels). Replenish 1 die as bonus action (1/long rest)." },
                        { level: 3,  name: "Protective Field",  desc: "Reaction: when self or ally takes damage, spend die to reduce by roll + INT mod." },
                        { level: 3,  name: "Psionic Strike",    desc: "After hit: spend die to deal extra force damage (roll + INT mod)." },
                        { level: 3,  name: "Telekinetic Movement", desc: "Move Large/smaller creature or object up to 30ft (1/long rest or spend die)." },
                        { level: 7,  name: "Telekinetic Adept", desc: "Psi-Powered Leap (60ft jump) and Telekinetic Thrust (large objects, knock prone)." },
                        { level: 10, name: "Guarded Mind",      desc: "Resistance to psychic. Action: end charmed/frightened by spending a die." },
                        { level: 15, name: "Bulwark of Force",  desc: "Bonus action: allies within 30ft get half-cover until next turn (proficiency/long rest)." },
                        { level: 18, name: "Telekinetic Master", desc: "Cast Telekinesis at will (1/long rest free). Bonus action: attack while concentrating on it." }
                    ]
                },
                {
                    name: "Samurai",
                    features: [
                        { level: 3,  name: "Bonus Proficiency", desc: "History, Insight, Performance, or Persuasion. Also one extra language." },
                        { level: 3,  name: "Fighting Spirit",   desc: "Bonus action: advantage on weapon attacks and gain 5 temp HP this turn (3/long rest, temp HP increases at higher levels)." },
                        { level: 7,  name: "Elegant Courtier",  desc: "Add WIS modifier to Persuasion. Advantage on WIS saves." },
                        { level: 10, name: "Tireless Spirit",   desc: "Roll initiative with 0 Fighting Spirit uses: regain 1." },
                        { level: 15, name: "Rapid Strike",      desc: "Forgo advantage on first attack this turn: make another attack as bonus action." },
                        { level: 18, name: "Strength Before Death", desc: "Drop to 0 HP: interrupt before going unconscious, immediately take a bonus turn. Stabilize if alive after." }
                    ]
                }
            ]
        },

        "Monk": {
            unlockLevel: 3,
            options: [
                {
                    name: "Way of the Open Hand",
                    features: [
                        { level: 3,  name: "Open Hand Technique", desc: "Flurry of Blows hit: push 15ft (STR save), knock prone (DEX save), or deny reactions until your next turn." },
                        { level: 6,  name: "Wholeness of Body",desc: "Action: Restore HP equal to 3x monk level (1/long rest)." },
                        { level: 11, name: "Tranquility",      desc: "After long rest: effect like Sanctuary until you attack/cast (WIS save DC 8+prof+WIS)." },
                        { level: 17, name: "Quivering Palm",   desc: "On hit: set invisible vibrations. Later, action: reduce to 0 HP (CON save or take 10d10 necrotic)." }
                    ]
                },
                {
                    name: "Way of Shadow",
                    features: [
                        { level: 3,  name: "Shadow Arts",      desc: "Spend 2 ki: Darkness, Darkvision, Pass Without Trace, or Silence (no concentration for Darkness/Silence)." },
                        { level: 6,  name: "Shadow Step",      desc: "Dim light/dark: teleport 60ft to another dim/dark spot. Advantage on first melee attack." },
                        { level: 11, name: "Cloak of Shadows", desc: "Action in dim/dark: become invisible until attack, cast, or bright light." },
                        { level: 17, name: "Opportunist",      desc: "Reaction: attack creature another creature just hit." }
                    ]
                },
                {
                    name: "Way of the Four Elements",
                    features: [
                        { level: 3,  name: "Disciple of the Elements", desc: "Know 2 elemental disciplines (spend ki to cast elemental spells or make elemental attacks)." },
                        { level: 6,  name: "Elemental Attunement",     desc: "Minor elemental effect (gust, spark, drip, etc.)." },
                        { level: 11, name: "Additional Disciplines",   desc: "Know total of 5 elemental disciplines." },
                        { level: 17, name: "Master Disciplines",       desc: "Know total of 7 disciplines. Higher-level elemental spells available." }
                    ]
                },
                {
                    name: "Way of the Drunken Master",
                    features: [
                        { level: 3,  name: "Bonus Proficiency",        desc: "Proficiency in Performance and brewer's supplies." },
                        { level: 3,  name: "Drunken Technique",        desc: "Flurry of Blows: Dodge and move 10ft without provoking opportunity attacks." },
                        { level: 6,  name: "Tipsy Sway",               desc: "Redirect melee miss to another creature within 5ft. Spend 1 ki: stand up without using movement." },
                        { level: 11, name: "Drunkard's Luck",          desc: "Spend 2 ki: Cancel disadvantage on attack/check/save." },
                        { level: 17, name: "Intoxicated Frenzy",       desc: "Flurry of Blows: 3 bonus attacks, each against a different target." }
                    ]
                },
                {
                    name: "Way of the Kensei",
                    features: [
                        { level: 3,  name: "Path of the Kensei",       desc: "2 weapons become monk weapons. Ranged kensei weapon: +2 to attack on ranged attack. Melee kensei: bonus action +1d4 damage." },
                        { level: 6,  name: "One with the Blade",       desc: "Kensei attacks count as magical. Spend 1 ki: +1d4 to kensei damage roll." },
                        { level: 11, name: "Sharpen the Blade",        desc: "Spend 1-3 ki: kensei weapon gains +1/+2/+3 to attack and damage for 1 min." },
                        { level: 17, name: "Unerring Accuracy",        desc: "Once per turn: reroll missed monk weapon attack." }
                    ]
                },
                {
                    name: "Way of the Sun Soul",
                    features: [
                        { level: 3,  name: "Radiant Sun Bolt",         desc: "Ranged spell attack (30ft): 1d4+DEX fire/radiant as bonus action after attack action." },
                        { level: 6,  name: "Searing Arc Strike",       desc: "After attack action: spend 2+ ki to cast Burning Hands (level = ki spent - 1)." },
                        { level: 11, name: "Searing Sunburst",         desc: "Action: 30ft radius sphere of light. CON save or 2d6 radiant; spend ki for extra d6." },
                        { level: 17, name: "Sun Shield",               desc: "Shed bright light 30ft. Reaction on hit: 5 + WIS fire damage to attacker." }
                    ]
                },
                {
                    name: "Way of the Mercy",
                    features: [
                        { level: 3,  name: "Implements of Mercy",      desc: "Proficiency in Insight, Medicine, and herbalism kit. Wear a mask of mercy." },
                        { level: 3,  name: "Hand of Healing",          desc: "Spend 1 ki: touch creature to restore 1d6 + WIS HP (can use with Flurry)." },
                        { level: 3,  name: "Hand of Harm",             desc: "Once per turn: spend 1 ki on hit: +1d6 + WIS necrotic. Also poison." },
                        { level: 6,  name: "Physician's Touch",        desc: "Hand of Healing: cure disease or end poison. Hand of Harm: also poison condition." },
                        { level: 11, name: "Flurry of Healing and Harm", desc: "Flurry of Blows: Hand of Healing without ki cost." },
                        { level: 17, name: "Hand of Ultimate Mercy",   desc: "Spend 5 ki: Revivify a creature dead no longer than 1 minute." }
                    ]
                },
                {
                    name: "Way of the Astral Self",
                    features: [
                        { level: 3,  name: "Arms of the Astral Self",  desc: "Spend 1 ki: spectral arms appear. WIS for unarmed strikes, d6/d8 damage, 10ft reach." },
                        { level: 6,  name: "Visage of the Astral Self", desc: "Spend 1 ki: astral visage appears. Advantage on Insight/Intimidation. Darkvision 120ft." },
                        { level: 11, name: "Body of the Astral Self",  desc: "Arms + Visage active: astral body appears. Deflect Energy (reduce damage by 1d10+WIS), Empowered Arms (+2d6 force on attacks)." },
                        { level: 17, name: "Awakened Astral Self",     desc: "Spend 5 ki: full astral form. Bonus attack with Arms, 10ft reach, +2d6 force all hits, -40ft fly speed." }
                    ]
                }
            ]
        },

        "Paladin": {
            unlockLevel: 3,
            options: [
                {
                    name: "Oath of Devotion",
                    features: [
                        { level: 3,  name: "Sacred Weapon",    desc: "Channel Divinity: weapon gains +CHA mod to attack rolls and emits bright light (1 min)." },
                        { level: 3,  name: "Turn the Unholy",   desc: "Channel Divinity: Undead/fiends flee for 1 min (WIS save DC 8+prof+CHA)." },
                        { level: 7,  name: "Aura of Devotion",  desc: "You and allies within 10ft (30ft at Lvl 18) can't be charmed while you're conscious." },
                        { level: 15, name: "Purity of Spirit",  desc: "Always under Protection from Evil and Good." },
                        { level: 20, name: "Holy Nimbus",       desc: "30ft aura emits sunlight: enemies in it take 10 radiant/turn. Advantage on saves vs spells from fiends/undead (1/long rest)." }
                    ]
                },
                {
                    name: "Oath of the Ancients",
                    features: [
                        { level: 3,  name: "Nature's Wrath",    desc: "Channel Divinity: Conjure spectral vines — restrain creature (STR/DEX save)." },
                        { level: 3,  name: "Turn the Faithless", desc: "Channel Divinity: Fey and fiends flee for 1 min (WIS save)." },
                        { level: 7,  name: "Aura of Warding",   desc: "You and allies within 10ft (30ft at 18) resistance to spell damage." },
                        { level: 15, name: "Undying Sentinel",  desc: "Drop to 0 HP: stay at 1 HP instead (1/long rest). Age doesn't cause death." },
                        { level: 20, name: "Elder Champion",    desc: "Transform for 1 min: regain 10 HP/turn, spells cost 1 less action, enemies within 10ft have disadvantage vs druid/ranger spells (1/long rest)." }
                    ]
                },
                {
                    name: "Oath of Vengeance",
                    features: [
                        { level: 3,  name: "Abjure Enemy",      desc: "Channel Divinity: Frighten one creature (WIS save). Fiends/undead auto-fail. Speed drops to 0." },
                        { level: 3,  name: "Vow of Enmity",     desc: "Channel Divinity: Bonus action — advantage on attacks vs one target within 10ft for 1 min." },
                        { level: 7,  name: "Relentless Avenger", desc: "Opportunity attack hits: move up to half speed toward target (no opportunity attacks)." },
                        { level: 15, name: "Soul of Vengeance",  desc: "Vow of Enmity target attacks: make an attack against it as reaction." },
                        { level: 20, name: "Avenging Angel",     desc: "Transform for 1 hr: fly 60ft, frightening aura (WIS save DC 8+prof+CHA; fail = frightened for 1 min) (1/long rest)." }
                    ]
                },
                {
                    name: "Oath of Glory",
                    features: [
                        { level: 3,  name: "Inspiring Smite",   desc: "After Divine Smite: bonus action to distribute 2d8 + paladin level temp HP among 6 creatures within 30ft." },
                        { level: 3,  name: "Peerless Athlete",   desc: "Channel Divinity: For 10 min, Athletics/Acrobatics advantage, carry/lift doubled, jumps 10ft extra." },
                        { level: 7,  name: "Aura of Alacrity",  desc: "Walk speed +10ft. Allies starting turn within 5ft (10ft at 18) also gain +10ft speed." },
                        { level: 15, name: "Glorious Defense",  desc: "Reaction on hit vs ally within 30ft: add CHA mod to ally's AC (possibly turning hit to miss). If miss: make one weapon attack vs attacker." },
                        { level: 20, name: "Living Legend",      desc: "Become a paragon for 1 min: CHA modifier to attack rolls, reroll any missed attack once/turn, success on failed CHA check (1/long rest)." }
                    ]
                },
                {
                    name: "Oath of Conquest",
                    features: [
                        { level: 3,  name: "Conquering Presence", desc: "Channel Divinity: Frighten all enemies within 30ft for 1 min (WIS save)." },
                        { level: 3,  name: "Guided Strike",     desc: "Channel Divinity: +10 to an attack roll." },
                        { level: 7,  name: "Aura of Conquest",  desc: "Frightened creatures within 10ft (30ft at 18): speed 0, take psychic damage equal to CHA mod if they start there." },
                        { level: 15, name: "Scornful Rebuke",   desc: "Reaction on taking damage: attacker takes CHA mod psychic damage." },
                        { level: 20, name: "Invincible Conqueror", desc: "Transform 1 hr: resistance to all damage, extra attack when attacking, melee attacks score crits on 19–20 (1/long rest)." }
                    ]
                },
                {
                    name: "Oath of Redemption",
                    features: [
                        { level: 3,  name: "Emissary of Peace", desc: "Channel Divinity: +5 to Persuasion for 10 min." },
                        { level: 3,  name: "Rebuke the Violent", desc: "Channel Divinity: Reaction on ally damaged: attacker takes same damage as radiant (WIS save = half)." },
                        { level: 7,  name: "Aura of the Guardian", desc: "Reaction: take damage an ally within 10ft (30ft at 18) would take." },
                        { level: 15, name: "Protective Spirit",  desc: "End of turn below half HP: regain 1d6 + half paladin level HP." },
                        { level: 20, name: "Emissary of Redemption", desc: "Resistance to all damage from creatures. Creature that attacks you: takes radiant = 50% of damage dealt (breaking if you attack)." }
                    ]
                }
            ]
        },

        "Ranger": {
            unlockLevel: 3,
            options: [
                {
                    name: "Hunter",
                    features: [
                        { level: 3,  name: "Hunter's Prey",     desc: "Choose: Colossus Slayer (1d8 extra vs wounded), Giant Killer (reaction attack large+), or Horde Breaker (attack additional nearby same creature type)." },
                        { level: 7,  name: "Defensive Tactics",  desc: "Escape the Horde (no opp attacks on Disengage), Multiattack Defense (+4 AC after hit), or Steel Will (adv vs frightened)." },
                        { level: 11, name: "Multiattack",        desc: "Volley (area ranged attack) or Whirlwind Attack (melee attack vs all in reach)." },
                        { level: 15, name: "Superior Hunter",    desc: "Evasion, Stand Against the Tide (attacker misses: use reaction to redirect to another creature), or Uncanny Dodge." }
                    ]
                },
                {
                    name: "Beast Master",
                    features: [
                        { level: 3,  name: "Ranger's Companion", desc: "Bond with a beast companion (challenge 1/4 or lower). Commands with bonus action; shares actions at Lvl 11." },
                        { level: 7,  name: "Exceptional Training", desc: "Bonus action: companion can Dash, Disengage, Dodge. Its attacks count as magical." },
                        { level: 11, name: "Bestial Fury",       desc: "Companion can make 2 attacks per turn." },
                        { level: 15, name: "Share Spells",       desc: "Spells you cast on yourself also affect companion within 30ft." }
                    ]
                },
                {
                    name: "Gloom Stalker",
                    features: [
                        { level: 3,  name: "Dread Ambusher",    desc: "Gain WIS mod to initiative. First turn: +10ft speed, extra attack, +1d8 damage on first attack." },
                        { level: 3,  name: "Umbral Sight",      desc: "Darkvision 60ft (or 30ft extra). Invisible to darkvision while in darkness." },
                        { level: 7,  name: "Iron Mind",         desc: "Proficiency in WIS saves (or INT if already proficient)." },
                        { level: 11, name: "Stalker's Flurry",  desc: "Miss with attack: make another attack immediately." },
                        { level: 15, name: "Shadowy Dodge",     desc: "Reaction on attack: impose disadvantage on it." }
                    ]
                },
                {
                    name: "Horizon Walker",
                    features: [
                        { level: 3,  name: "Detect Portal",     desc: "Action: detect planar portals within 1 mile (1/short rest)." },
                        { level: 3,  name: "Planar Warrior",    desc: "Bonus action before attack: change damage to force and add +1d8 force." },
                        { level: 7,  name: "Ethereal Step",     desc: "Bonus action: enter Ethereal Plane until start of next turn (1/short rest)." },
                        { level: 11, name: "Distant Strike",    desc: "Teleport 10ft before each attack (up to 3 targets on Attack action, extra attack if 3 different targets)." },
                        { level: 15, name: "Spectral Defense",  desc: "Reaction on hit: resistance to that attack's damage type." }
                    ]
                },
                {
                    name: "Monster Slayer",
                    features: [
                        { level: 3,  name: "Hunter's Sense",    desc: "Action: learn immunities/resistances/vulnerabilities (WIS mod/long rest)." },
                        { level: 3,  name: "Slayer's Prey",     desc: "Bonus action: mark creature. Once per turn: +1d6 to damage against it." },
                        { level: 7,  name: "Supernatural Defense", desc: "Slayer's Prey: add 1d6 to STR/DEX saves vs it and vs being grappled by it." },
                        { level: 11, name: "Magic-User's Nemesis", desc: "Reaction to creature casting a spell or teleporting within 60ft: attempt to negate (WIS save vs its DC, or 10+spell level)." },
                        { level: 15, name: "Slayer's Counter",  desc: "Slayer's Prey target forces a save: make one weapon attack vs it as reaction. Success negates the effect." }
                    ]
                },
                {
                    name: "Fey Wanderer",
                    features: [
                        { level: 3,  name: "Dreadful Strikes",  desc: "Weapon attack: add 1d4 psychic damage (once per turn per creature). Scales to 1d6 at Lvl 11." },
                        { level: 3,  name: "Otherworldly Glamour", desc: "Add WIS mod to Persuasion, Deception, or Performance. Proficiency in one of these." },
                        { level: 7,  name: "Beguiling Twist",   desc: "Reaction: creature within 120ft succeeds charm/fright save — redirect to nearby creature (WIS save)." },
                        { level: 11, name: "Fey Reinforcements", desc: "Summon Fey (1/long rest free; or spell slot)." },
                        { level: 15, name: "Misty Wanderer",    desc: "Misty Step at will and can take one willing creature." }
                    ]
                },
                {
                    name: "Swarmkeeper",
                    features: [
                        { level: 3,  name: "Gathered Swarm",    desc: "Swarm of spirits surrounds you. Once/turn on hit: move target 15ft (STR save), or you move 5ft, or +1d6 piercing/bludgeoning." },
                        { level: 3,  name: "Writhing Tide",     desc: "Bonus action: 10ft flying speed for 1 min (can hover). Swarm carries you." },
                        { level: 7,  name: "Mighty Swarm",      desc: "Gathered Swarm improves: 15ft becomes restraint, you can move 10ft, damage becomes 1d8." },
                        { level: 11, name: "Grounding Line",    desc: "Swarm can grapple one creature you hit." },
                        { level: 15, name: "Storm of the Swarm", desc: "Bonus action: each creature in swarm 5ft cube must save (CON) or take swarm damage." }
                    ]
                }
            ]
        },

        "Rogue": {
            unlockLevel: 3,
            options: [
                {
                    name: "Thief",
                    features: [
                        { level: 3,  name: "Fast Hands",        desc: "Cunning Action: also use Sleight of Hand, disarm trap, pick lock, or Use an Object." },
                        { level: 3,  name: "Second-Story Work",  desc: "Climb at full speed (no penalty). Running jump: +DEX mod feet." },
                        { level: 9,  name: "Supreme Sneak",     desc: "Advantage on Stealth checks when moving at half speed or less." },
                        { level: 13, name: "Use Magic Device",   desc: "Ignore class, race, and level requirements for magic items." },
                        { level: 17, name: "Thief's Reflexes",  desc: "First round of combat: take 2 turns (initiative and init-10)." }
                    ]
                },
                {
                    name: "Assassin",
                    features: [
                        { level: 3,  name: "Bonus Proficiency", desc: "Disguise kit and poisoner's kit." },
                        { level: 3,  name: "Assassinate",       desc: "Advantage on attacks vs any creature that hasn't taken a turn. Attacks against surprised creatures automatically crit." },
                        { level: 9,  name: "Infiltration Expertise", desc: "Create false identity (7 days + 25gp). Perfectly convincing in that identity." },
                        { level: 13, name: "Impostor",          desc: "Unerring mimic of a person after 3 hours of study." },
                        { level: 17, name: "Death Strike",      desc: "First turn of combat: sneak attack target must CON save (DC 8+prof+DEX) or take damage twice." }
                    ]
                },
                {
                    name: "Arcane Trickster",
                    features: [
                        { level: 3,  name: "Spellcasting",      desc: "Cast wizard spells (INT-based). Focus on Enchantment and Illusion." },
                        { level: 3,  name: "Mage Hand Legerdemain", desc: "Mage Hand becomes invisible; use it to pick pockets, disarm traps, open locks remotely (Sleight of Hand vs Perception)." },
                        { level: 9,  name: "Magical Ambush",    desc: "If hidden when casting a spell: target has disadvantage on first save against it." },
                        { level: 13, name: "Versatile Trickster", desc: "Bonus action: Mage Hand distracts creature — advantage on your attacks vs it until end of turn." },
                        { level: 17, name: "Spell Thief",       desc: "Reaction on being hit by spell: steal the spell (INT save). Cast it once within 8 hrs using caster's stats." }
                    ]
                },
                {
                    name: "Inquisitive",
                    features: [
                        { level: 3,  name: "Ear for Deceit",    desc: "Minimum roll of 8 on Insight checks." },
                        { level: 3,  name: "Eye for Detail",    desc: "Bonus action: Perception or Investigation check." },
                        { level: 3,  name: "Insightful Fighting", desc: "Bonus action: make Insight vs Deception. If win: sneak attack without needing advantage (and no ally adjacent needed) for 1 min." },
                        { level: 9,  name: "Steady Eye",        desc: "Full movement turn: Advantage on Perception and Investigation." },
                        { level: 13, name: "Unerring Eye",      desc: "Action: detect illusions, shapechangers, disguises within 30ft (WIS mod/long rest)." },
                        { level: 17, name: "Eye for Weakness",   desc: "During Insightful Fighting: Sneak Attack +3d6." }
                    ]
                },
                {
                    name: "Mastermind",
                    features: [
                        { level: 3,  name: "Master of Intrigue", desc: "Two languages plus disguise/forgery/gaming set proficiency. Mimic speech accents after 1 min listening." },
                        { level: 3,  name: "Master of Tactics",  desc: "Help action as bonus action (and can Help from 30ft away)." },
                        { level: 9,  name: "Insightful Manipulator", desc: "1 min study of a creature: know 2 of 4 things: CHA comparison, INT comparison, class, personality traits/ideals/bonds/flaws." },
                        { level: 13, name: "Misdirection",       desc: "Bonus action: redirect attention — Deception vs Insight to make creature ignore you and view ally as threat." },
                        { level: 17, name: "Soul of Deceit",     desc: "Truthful statements can't be detected by magic. Telepathic communication: you choose what to reveal." }
                    ]
                },
                {
                    name: "Scout",
                    features: [
                        { level: 3,  name: "Skirmisher",         desc: "Reaction when enemy ends turn adjacent: move up to half speed without provoking opportunity attacks." },
                        { level: 3,  name: "Survivalist",        desc: "Proficiency (or expertise) in Nature and Survival." },
                        { level: 9,  name: "Superior Mobility",   desc: "Walk/Climb/Swim speeds each increase by 10ft." },
                        { level: 13, name: "Ambush Master",       desc: "Advantage on initiative. Allies who haven't acted yet get advantage on attacks vs creatures you've attacked this turn." },
                        { level: 17, name: "Sudden Strike",       desc: "If you take the Attack action, make one extra attack against a different creature." }
                    ]
                },
                {
                    name: "Swashbuckler",
                    features: [
                        { level: 3,  name: "Fancy Footwork",      desc: "Melee attack: target can't make opportunity attacks against you for the rest of your turn." },
                        { level: 3,  name: "Rakish Audacity",     desc: "Add CHA mod to initiative. Sneak Attack if only one enemy adjacent (no ally needed)." },
                        { level: 9,  name: "Panache",              desc: "1 min Persuasion vs Insight: charm or taunt humanoid creature." },
                        { level: 13, name: "Elegant Maneuver",    desc: "Bonus action: advantage on Acrobatics or Athletics until end of turn." },
                        { level: 17, name: "Master Duelist",       desc: "Miss with attack: reroll with advantage (1/short rest)." }
                    ]
                },
                {
                    name: "Soulknife",
                    features: [
                        { level: 3,  name: "Psionic Power",       desc: "Pool of Psionic Energy Dice (d6). Replenish one as bonus action (1/long rest)." },
                        { level: 3,  name: "Psychic Blades",      desc: "Attack with spectral blades (1d6 psychic, finesse, thrown 30/60) that vanish after throwing; bonus action for off-hand." },
                        { level: 3,  name: "Psi-Bolstered Knack", desc: "Fail proficient check: roll a die and add to total (no cost if success)." },
                        { level: 3,  name: "Psychic Whispers",    desc: "Telepathic network with up to prof creatures for WIS mod hours." },
                        { level: 9,  name: "Soul Blades",          desc: "Homing Strikes: spend die to reroll psychic blade attack. Psychic Teleportation: spend die, teleport = result × 10ft." },
                        { level: 13, name: "Psychic Veil",         desc: "Become invisible 1 hour (1/long rest or spend die). Break on attack/spell." },
                        { level: 17, name: "Rend Mind",            desc: "Psychic blade attack: stun target until end of next turn (WIS save DC 8+prof+DEX). 3 dice cost." }
                    ]
                }
            ]
        },

        "Sorcerer": {
            unlockLevel: 1,
            options: [
                {
                    name: "Draconic Bloodline",
                    features: [
                        { level: 1,  name: "Dragon Ancestor",    desc: "Choose dragon type. Speak/understand Draconic. Advantage on Charisma checks vs dragons." },
                        { level: 1,  name: "Draconic Resilience", desc: "+1 HP per sorcerer level. Unarmored AC = 13 + DEX modifier." },
                        { level: 6,  name: "Elemental Affinity",  desc: "Damage matching ancestry type: add CHA modifier. Spend 1 SP: resistance to that type for 1 hr." },
                        { level: 14, name: "Dragon Wings",        desc: "Bonus action: grow dragon wings, fly speed equal to walk speed." },
                        { level: 18, name: "Draconic Presence",   desc: "Spend 5 SP: Presence aura 60ft. Creatures entering must WIS save (DC 8+prof+CHA) or be charmed/frightened." }
                    ]
                },
                {
                    name: "Wild Magic",
                    features: [
                        { level: 1,  name: "Wild Magic Surge",    desc: "After casting 1st+ level spell: DM can call for a d20 — on 1, roll Wild Magic Surge table." },
                        { level: 1,  name: "Tides of Chaos",      desc: "Gain advantage on attack/check/save (1/long rest). DM recharges it by causing Wild Magic Surge." },
                        { level: 6,  name: "Bend Luck",           desc: "Spend 2 SP: add or subtract 1d4 from any attack/check/save roll you can see." },
                        { level: 14, name: "Controlled Chaos",    desc: "Roll Wild Magic Surge twice, choose which result applies." },
                        { level: 18, name: "Spell Bombardment",   desc: "Once per turn: roll spell damage die that rolls max — roll one additional die." }
                    ]
                },
                {
                    name: "Divine Soul",
                    features: [
                        { level: 1,  name: "Divine Magic",        desc: "Choose Affinity (good/evil/law/chaos/neutrality). Access cleric spell list + bonus spell." },
                        { level: 1,  name: "Favored by the Gods", desc: "When you fail an attack or save: add 2d4 to the result (1/short rest)." },
                        { level: 6,  name: "Empowered Healing",   desc: "Spend 1 SP: reroll any healing dice when you or another creature in 5ft casts healing spell." },
                        { level: 14, name: "Otherworldly Wings",  desc: "Bonus action: spectral wings — 30ft fly speed." },
                        { level: 18, name: "Unearthly Recovery",  desc: "Bonus action at below half HP: regain half max HP (1/long rest)." }
                    ]
                },
                {
                    name: "Shadow Magic",
                    features: [
                        { level: 1,  name: "Eyes of the Dark",    desc: "Darkvision 120ft. Spend 1 SP: cast Darkness (with 5th level slot: see through own Darkness)." },
                        { level: 1,  name: "Strength of the Grave", desc: "Drop to 0 HP from damage: CHA save (DC = damage dealt) or stay at 1 HP (1/long rest)." },
                        { level: 6,  name: "Hound of Ill Omen",   desc: "Spend 3 SP: summon shadow hound that pursues one target (bite attack, disadvantage on saves vs your spells)." },
                        { level: 14, name: "Shadow Walk",         desc: "Bonus action in dim light/darkness: teleport up to 120ft to another dim/dark spot." },
                        { level: 18, name: "Umbral Form",         desc: "Spend 6 SP: transform for 1 min — resistance to nonforce/radiant damage, move through objects as difficult terrain." }
                    ]
                },
                {
                    name: "Storm Sorcery",
                    features: [
                        { level: 1,  name: "Wind Speaker",        desc: "Speak, read, and write Primordial (and Aquan, Auran, Ignan, Terran dialects)." },
                        { level: 1,  name: "Tempestuous Magic",   desc: "Before or after casting 1st+ level spell: fly 10ft without opportunity attacks." },
                        { level: 6,  name: "Heart of the Storm",  desc: "Resistance to lightning and thunder. Casting lightning/thunder spell: creatures within 10ft take CHA mod lightning/thunder." },
                        { level: 6,  name: "Storm Guide",         desc: "Stop/direct rain within 20ft. Redirect wind within 100ft." },
                        { level: 14, name: "Storm's Fury",        desc: "Reaction on melee attack: deal 1d6 per sorcerer level lightning (DEX save) + push 20ft." },
                        { level: 18, name: "Wind Soul",           desc: "Immunity to lightning/thunder. Fly 60ft. Reduce to 30ft: give 3+ creatures 30ft fly for 1 hour." }
                    ]
                },
                {
                    name: "Aberrant Mind",
                    features: [
                        { level: 1,  name: "Telepathic Speech",   desc: "Telepathy with one creature within INT-mod × 10ft (min 1). Creature doesn't need to share language." },
                        { level: 1,  name: "Psionic Spells",      desc: "Bonus spells include Mind Sliver, Arms of Hadar, Dissonant Whispers, Calm Emotions, etc." },
                        { level: 6,  name: "Psionic Sorcery",     desc: "Cast psionic spell using only SP (equal to spell level) — no verbal/somatic components." },
                        { level: 6,  name: "Psychic Defenses",    desc: "Resistance to psychic. Advantage vs charmed and frightened." },
                        { level: 14, name: "Revelation in Flesh",  desc: "Spend 1+ SP: transform body — see invisible, swim/breathe water, fly, or squeeze through tiny gaps." },
                        { level: 18, name: "Warping Implosion",   desc: "Action: teleport 120ft; each creature within 30ft of departure is pulled 30ft toward old location (STR save or take 3d10 force + restrained until end of next turn). 1/long rest." }
                    ]
                },
                {
                    name: "Clockwork Soul",
                    features: [
                        { level: 1,  name: "Clockwork Magic",     desc: "Bonus spells from the orderly/mechanic theme (Alarm, Aid, Lesser Restoration, etc.)." },
                        { level: 1,  name: "Restore Balance",     desc: "Reaction: cancel advantage/disadvantage on a roll made by creature within 60ft (prof/long rest)." },
                        { level: 6,  name: "Bastion of Law",      desc: "Spend 1-5 SP: touch creature — gains 1d8/SP temp HP and damage taken reduces that pool first." },
                        { level: 6,  name: "Trance of Order",     desc: "Bonus action: attacks against you can't benefit from advantage. Minimum 10 on all attack rolls and checks for 1 min." },
                        { level: 14, name: "Clockwork Cavalcade", desc: "Fill 30ft sphere with spectral clockwork — repair 100 HP among creatures, destroy 6th level or lower spells, repair damaged objects. 1/long rest." }
                    ]
                }
            ]
        },

        "Warlock": {
            unlockLevel: 1,
            options: [
                {
                    name: "The Archfey",
                    features: [
                        { level: 1,  name: "Fey Presence",       desc: "Action: 10ft cube around you — all creatures WIS save (DC 8+prof+CHA) or be charmed or frightened (1/short rest)." },
                        { level: 6,  name: "Misty Escape",       desc: "Reaction on taking damage: teleport 60ft and become invisible until start of next turn (1/short rest)." },
                        { level: 10, name: "Beguiling Defenses",  desc: "Immune to charm. Reaction: reflect charm attempt onto attacker (WIS save)." },
                        { level: 14, name: "Dark Delirium",       desc: "Action: charm or frighten one creature (WIS save; 1 min concentration, creature thinks it's somewhere else entirely). 1/short rest." }
                    ]
                },
                {
                    name: "The Fiend",
                    features: [
                        { level: 1,  name: "Dark One's Blessing", desc: "Kill a creature: gain CHA + warlock level temporary HP." },
                        { level: 6,  name: "Dark One's Own Luck", desc: "Add 1d10 to ability check or save (1/short rest)." },
                        { level: 10, name: "Fiendish Resilience",  desc: "Short rest: choose one damage type (not bludgeoning/slashing/piercing) — gain resistance to it until next short rest." },
                        { level: 14, name: "Hurl Through Hell",    desc: "Creature hit by attack: flung through Hell — 10d10 psychic on return at start of next turn. 1/long rest." }
                    ]
                },
                {
                    name: "The Great Old One",
                    features: [
                        { level: 1,  name: "Awakened Mind",       desc: "Telepathy to any creature within 30ft you can see. Any language." },
                        { level: 6,  name: "Entropic Ward",       desc: "Reaction to being attacked: impose disadvantage. If miss: advantage on next attack vs it (1/short rest)." },
                        { level: 10, name: "Thought Shield",      desc: "Thoughts can't be read by magic. Resistance to psychic. Attacker takes same psychic damage you take." },
                        { level: 14, name: "Create Thrall",       desc: "Touch incapacitated humanoid: charmed until charm removed. Awakened Mind extends to it." }
                    ]
                },
                {
                    name: "The Celestial",
                    features: [
                        { level: 1,  name: "Bonus Cantrips",      desc: "Gain Sacred Flame and Light cantrips." },
                        { level: 1,  name: "Healing Light",       desc: "Pool of d6s = 1 + warlock level. Bonus action: spend dice to heal creature within 60ft (up to 5 dice/turn)." },
                        { level: 6,  name: "Radiant Soul",        desc: "Resistance to radiant. Once/turn: add CHA mod to radiant/fire spell damage." },
                        { level: 10, name: "Celestial Resilience", desc: "Temp HP equal to warlock level + CHA mod when finishing a rest. Also extend this to 5 allies." },
                        { level: 14, name: "Searing Vengeance",   desc: "Beginning of turn at 0 HP: choose to return at half HP, deal radiant burst to nearby enemies, become immune to being restrained until end of turn." }
                    ]
                },
                {
                    name: "The Hexblade",
                    features: [
                        { level: 1,  name: "Hexblade's Curse",    desc: "Bonus action: curse creature for 1 min. +prof bonus damage, crit on 19-20, regain HP = CHA + warlock level on its death. 1/short rest." },
                        { level: 1,  name: "Hex Warrior",         desc: "Medium armor + shields + martial weapons proficiency. One weapon per long rest: use CHA for attacks." },
                        { level: 6,  name: "Accursed Specter",    desc: "Kill a humanoid: rise as specter under your control until long rest." },
                        { level: 10, name: "Armor of Hexes",      desc: "Hexblade's Curse: if it hits you, roll d6 — on 4+, attack misses." },
                        { level: 14, name: "Master of Hexes",     desc: "Hexblade's Curse target dies: move curse to new creature within 30ft (no recharge needed)." }
                    ]
                },
                {
                    name: "The Fathomless",
                    features: [
                        { level: 1,  name: "Tentacle of the Deeps", desc: "Bonus action: summon spectral tentacle 10ft from you (1 min): melee attack 1d8 cold + reduce speed 10ft (CHA mod/long rest)." },
                        { level: 1,  name: "Gift of the Sea",     desc: "Breathe water. 40ft swim speed." },
                        { level: 6,  name: "Oceanic Soul",        desc: "Resistance to cold. Telepathy with water-breathing creatures." },
                        { level: 6,  name: "Guardian Coil",       desc: "Tentacle reaction: reduce incoming damage by 1d8 to you or adjacent ally." },
                        { level: 10, name: "Grasping Tentacles",   desc: "Cast Evard's Black Tentacles without slot (1/long rest). Tentacle of the Deeps: +1d8 cold while it persists." },
                        { level: 14, name: "Fathomless Plunge",   desc: "Action: teleport self + 5 willing within 30ft to water or dry land within 1 mile (1/short rest)." }
                    ]
                },
                {
                    name: "The Genie",
                    features: [
                        { level: 1,  name: "Genie's Vessel",      desc: "Tiny vessel contains your genie patron's essence. Bonus action: enter vessel, survive 10 min as sanctuary. Tether: 100ft range on your spells." },
                        { level: 1,  name: "Bottled Respite",     desc: "Enter vessel as action: pocket dimension for 4 hours. Time passes normally outside." },
                        { level: 6,  name: "Elemental Gift",      desc: "Resistance to genie element. 10ft fly (hover) as bonus action for 10 min (prof/long rest)." },
                        { level: 10, name: "Sanctuary Vessel",    desc: "Up to 5 allies can enter vessel with you. Short rest in vessel = full regen. Temp HP on exit = CHA + pb." },
                        { level: 14, name: "Limited Wish",        desc: "Replicate any spell of 6th level or lower from any class spell list (1d6+1 long rests to recharge)." }
                    ]
                }
            ]
        },

        "Wizard": {
            unlockLevel: 2,
            options: [
                {
                    name: "School of Evocation",
                    features: [
                        { level: 2,  name: "Evocation Savant",   desc: "Copy Evocation spells into spellbook at half cost (25 gp / 1 hr instead of 50 gp / 2 hrs)." },
                        { level: 2,  name: "Sculpt Spells",      desc: "When casting Evocation spell: choose up to 1 + spell level creatures — they automatically succeed their save and take no damage." },
                        { level: 6,  name: "Potent Cantrip",     desc: "Targets always take half damage even on successful saves against damaging cantrips." },
                        { level: 10, name: "Empowered Evocation", desc: "Add INT modifier to damage rolls of Evocation wizard spells." },
                        { level: 14, name: "Overchannel",        desc: "Non-cantrip wizard spell of 5th level or lower: deal maximum damage. 2nd use: take 2d12 necrotic. Doubles each subsequent use (1/long rest to reset)." }
                    ]
                },
                {
                    name: "School of Abjuration",
                    features: [
                        { level: 2,  name: "Abjuration Savant",  desc: "Copy Abjuration spells into spellbook at half cost." },
                        { level: 2,  name: "Arcane Ward",        desc: "Cast abjuration spell: create ward with 2x wizard level + INT HP. Damage hits you: reduced by ward first." },
                        { level: 6,  name: "Projected Ward",     desc: "Reaction: Arcane Ward absorbs damage for ally within 30ft." },
                        { level: 10, name: "Improved Abjuration", desc: "Add proficiency bonus to abjuration spell ability checks (Counterspell, Dispel Magic, etc.)." },
                        { level: 14, name: "Spell Resistance",   desc: "Advantage on saves vs spells. Resistance to spell damage." }
                    ]
                },
                {
                    name: "School of Conjuration",
                    features: [
                        { level: 2,  name: "Conjuration Savant", desc: "Copy Conjuration spells at half cost." },
                        { level: 2,  name: "Minor Conjuration",  desc: "Action: create small object (3ft cube, 10 lbs) for 1 hour." },
                        { level: 6,  name: "Benign Transposition", desc: "Bonus action: teleport 30ft to unoccupied space, or swap with willing creature within 30ft (1/long rest or conjuration spell cast)." },
                        { level: 10, name: "Focused Conjuration", desc: "Concentration on conjuration spell: can't break from taking damage." },
                        { level: 14, name: "Durable Summons",    desc: "Conjured/summoned creatures gain 30 temp HP." }
                    ]
                },
                {
                    name: "School of Divination",
                    features: [
                        { level: 2,  name: "Divination Savant",  desc: "Copy Divination spells at half cost." },
                        { level: 2,  name: "Portent",            desc: "After long rest: roll two d20s. Replace any attack/check/save roll with one of these results (must choose before rolling)." },
                        { level: 6,  name: "Expert Divination",  desc: "Cast divination spell of 2nd level or higher: regain one expended spell slot (max same level, max 5th)." },
                        { level: 10, name: "The Third Eye",      desc: "Bonus action: Darkvision 60ft, see invisible in 10ft, read any language, or see into Ethereal Plane 60ft (1/short rest)." },
                        { level: 14, name: "Greater Portent",    desc: "Roll three d20s for Portent instead of two." }
                    ]
                },
                {
                    name: "School of Enchantment",
                    features: [
                        { level: 2,  name: "Enchantment Savant", desc: "Copy Enchantment spells at half cost." },
                        { level: 2,  name: "Hypnotic Gaze",      desc: "Action: charm creature within 5ft (WIS save). It's incapacitated and speed 0 while you sustain it each turn. 1/short rest." },
                        { level: 6,  name: "Instinctive Charm",  desc: "Reaction to being attacked: redirect attack to nearest creature (WIS save DC 8+prof+INT). 1/short rest." },
                        { level: 10, name: "Split Enchantment",   desc: "Enchantment spell targeting one creature: also target one additional creature." },
                        { level: 14, name: "Alter Memories",     desc: "Charm removes memory of enchantment; choose to erase up to 1 hour of memories." }
                    ]
                },
                {
                    name: "School of Illusion",
                    features: [
                        { level: 2,  name: "Illusion Savant",    desc: "Copy Illusion spells at half cost." },
                        { level: 2,  name: "Improved Minor Illusion", desc: "Minor Illusion cantrip creates both sound AND image simultaneously." },
                        { level: 6,  name: "Malleable Illusions",  desc: "Action: change nature of illusion spell while concentrating on it." },
                        { level: 10, name: "Illusory Self",       desc: "Reaction to being attacked: interpose illusory double — attack misses (1/short rest)." },
                        { level: 14, name: "Illusory Reality",    desc: "After casting illusion spell: bonus action to make one non-creature object real for 1 min." }
                    ]
                },
                {
                    name: "School of Necromancy",
                    features: [
                        { level: 2,  name: "Necromancy Savant",  desc: "Copy Necromancy spells at half cost." },
                        { level: 2,  name: "Grim Harvest",       desc: "Kill creature with spell: regain HP = 2x spell level (3x for necromancy spells). Not for undead/constructs." },
                        { level: 6,  name: "Undead Thralls",     desc: "Animate Dead: create extra zombie/skeleton. Undead created by you: +prof bonus to damage, +wizard level extra HP max." },
                        { level: 10, name: "Inured to Undeath",  desc: "Resistance to necrotic damage. Max HP can't be reduced." },
                        { level: 14, name: "Command Undead",     desc: "Action: target undead within 60ft — CHA save (DC 8+prof+INT) or obey commands for 24 hrs." }
                    ]
                },
                {
                    name: "School of Transmutation",
                    features: [
                        { level: 2,  name: "Transmutation Savant", desc: "Copy Transmutation spells at half cost." },
                        { level: 2,  name: "Minor Alchemy",      desc: "Transform small amount of one material into another (wood/stone/iron/copper/silver/gold) for 1 hour." },
                        { level: 6,  name: "Transmuter's Stone",  desc: "Create stone granting one benefit: Darkvision 60ft, +10 speed, proficiency in CON saves, or resistance to one energy type. Change daily." },
                        { level: 10, name: "Shapechanger",        desc: "Cast Polymorph on self without using a spell slot (1/short rest)." },
                        { level: 14, name: "Master Transmuter",   desc: "Action: use/destroy stone. Choose: transmute material, cure disease/poison/curse, Age/Young creature, animate dead briefly, or cast True Resurrection." }
                    ]
                },
                {
                    name: "Bladesinging",
                    features: [
                        { level: 2,  name: "Training in War and Song", desc: "Light armor proficiency and one-handed melee weapon proficiency. Gain Performance proficiency." },
                        { level: 2,  name: "Bladesong",          desc: "Bonus action: begin Bladesong (INT mod/long rest). For 1 min: +INT mod to AC, +10ft walk speed, advantage on DEX (Acrobatics), min 10 on concentration." },
                        { level: 6,  name: "Extra Attack",       desc: "Attack twice on Attack action. Can replace one with casting a cantrip." },
                        { level: 10, name: "Song of Defense",    desc: "Bladesong active: reaction to taking damage — expend spell slot to reduce damage by 5 × slot level." },
                        { level: 14, name: "Song of Victory",    desc: "Bladesong active: add INT modifier to melee weapon damage." }
                    ]
                },
                {
                    name: "Order of Scribes",
                    features: [
                        { level: 2,  name: "Wizardly Quill",     desc: "Bonus action: summon magic quill. Copy spells in 2 min instead of 2 hrs (free ink). Erase writing as bonus action." },
                        { level: 2,  name: "Awakened Spellbook",  desc: "Spellbook is sentient (10 HP, AC 13). Use it as spellcasting focus. Once per long rest: swap prepared spell for same-level spell from book." },
                        { level: 6,  name: "Manifest Mind",      desc: "Bonus action: float spectral mind from book (300ft range). Cast spells from its location. Dismiss with bonus action." },
                        { level: 10, name: "Master Scrivener",   desc: "Long rest: copy spell into scroll (bonus action), using quill (halved spell slot cost). 1 scroll/rest." },
                        { level: 14, name: "One with the Word",   desc: "Spellbook on your person: advantage on INT (Arcana). Spellbook destroyed: expunge spells to survive (3d6 damage) — recreates itself in 1d4 days." }
                    ]
                }
            ]
        }
    },


    // ══════════════════════════════════════════════════════════════════════
    // SUBCLASS DOMAIN SPELL POOLS — used by selectSpellsForClass
    // Format: { minLevel: N, spells: [{name,level,type,school,range,dmg,desc,castTime}] }
    // ══════════════════════════════════════════════════════════════════════
    subclassSpells: {
        // CLERIC DOMAINS
        "Life Domain": [
            {minLevel:1, spells:[
                {name:"Bless",level:1,type:"Buff",school:"Enchantment",range:"30ft",dmg:"-",desc:"Up to 3 creatures add d4 to attack rolls and saving throws (concentration, 1 min)",castTime:"1 Action"},
                {name:"Cure Wounds",level:1,type:"Heal",school:"Evocation",range:"Touch",dmg:"1d8+Mod",desc:"Touch a creature to restore hit points",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Lesser Restoration",level:2,type:"Utility",school:"Abjuration",range:"Touch",dmg:"-",desc:"End one disease, poison, paralysis, or blindness on a creature",castTime:"1 Action"},
                {name:"Spiritual Weapon",level:2,type:"Atk",school:"Evocation",range:"60ft",dmg:"1d8+Mod",desc:"Summon a floating spectral weapon. Bonus action to attack each turn",castTime:"Bonus Action",upcast:"+1d8 per 2 slot levels"}
            ]},
            {minLevel:5, spells:[
                {name:"Beacon of Hope",level:3,type:"Buff",school:"Abjuration",range:"30ft",dmg:"-",desc:"Creatures have advantage on WIS saves and death saves, maximize healing received (concentration, 1 min)",castTime:"1 Action"},
                {name:"Revivify",level:3,type:"Heal",school:"Necromancy",range:"Touch",dmg:"-",desc:"Return a creature to life who died within the last minute (1 min, 300gp diamond)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Death Ward",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature drops to 1 HP the first time it would drop to 0 HP (8 hours)",castTime:"1 Action"},
                {name:"Guardian of Faith",level:4,type:"Utility",school:"Conjuration",range:"30ft",dmg:"20",desc:"Summon a Large spectral guardian that deals 20 radiant to approaching enemies (DEX save, 8 hrs or 60 dmg)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Mass Cure Wounds",level:5,type:"Heal",school:"Evocation",range:"60ft",dmg:"3d8+Mod",desc:"Heal up to 6 creatures within 30ft of a point you choose",castTime:"1 Action",upcast:"+1d8 per slot level"},
                {name:"Raise Dead",level:5,type:"Heal",school:"Necromancy",range:"Touch",dmg:"-",desc:"Restore life to a creature dead no longer than 10 days (500gp diamond, creature -4 to attacks/saves/checks for 4 days)",castTime:"1 Hour"}
            ]}
        ],
        "War Domain": [
            {minLevel:1, spells:[
                {name:"Divine Favor",level:1,type:"Buff",school:"Evocation",range:"Self",dmg:"1d4",desc:"Your weapon attacks deal an extra 1d4 radiant damage (concentration, 1 min)",castTime:"Bonus Action"},
                {name:"Shield of Faith",level:1,type:"Buff",school:"Abjuration",range:"60ft",dmg:"-",desc:"A shimmering field gives target +2 AC (concentration, 10 min)",castTime:"Bonus Action"}
            ]},
            {minLevel:3, spells:[
                {name:"Magic Weapon",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"A nonmagical weapon becomes a +1 magic weapon (concentration, 1 hr)",castTime:"Bonus Action",upcast:"+2 at 4th, +3 at 6th level slot"},
                {name:"Spiritual Weapon",level:2,type:"Atk",school:"Evocation",range:"60ft",dmg:"1d8+Mod",desc:"Summon a floating spectral weapon. Bonus action to attack each turn",castTime:"Bonus Action",upcast:"+1d8 per 2 slot levels"}
            ]},
            {minLevel:5, spells:[
                {name:"Crusader's Mantle",level:3,type:"Buff",school:"Evocation",range:"Self",dmg:"1d4",desc:"Allies within 30ft add 1d4 radiant damage to their weapon attacks (concentration, 1 min)",castTime:"1 Action"},
                {name:"Spirit Guardians",level:3,type:"Save",school:"Conjuration",range:"Self (15ft)",dmg:"3d8",desc:"Spectral spirits surround you. Creatures entering 15ft: WIS save or take radiant/necrotic damage and speed halved",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:7, spells:[
                {name:"Freedom of Movement",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature ignores difficult terrain, can't be paralyzed or restrained by magic (1 hr)",castTime:"1 Action"},
                {name:"Stoneskin",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Target gains resistance to bludgeoning, piercing, and slashing from non-magical attacks (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Flame Strike",level:5,type:"Save",school:"Evocation",range:"60ft",dmg:"4d6+4d6",desc:"A column of divine fire: DEX save or 4d6 fire and 4d6 radiant damage in a 10ft-radius, 40ft-tall cylinder",castTime:"1 Action",upcast:"+1d6 fire and +1d6 radiant per slot level"},
                {name:"Hold Monster",level:5,type:"Save",school:"Enchantment",range:"90ft",dmg:"-",desc:"WIS save or target is paralyzed for up to 1 minute (concentration). Works on any creature type",castTime:"1 Action",upcast:"+1 target per slot level"}
            ]}
        ],
        "Tempest Domain": [
            {minLevel:1, spells:[
                {name:"Fog Cloud",level:1,type:"Utility",school:"Conjuration",range:"120ft",dmg:"-",desc:"Create a 20ft-radius sphere of fog. The area is heavily obscured (concentration, 1 hr)",castTime:"1 Action",upcast:"+10ft radius per slot level"},
                {name:"Thunderwave",level:1,type:"Save",school:"Evocation",range:"Self (15ft cube)",dmg:"2d8",desc:"CON save or take thunder damage and be pushed 10ft. Objects always pushed. Thunder audible 300ft",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Gust of Wind",level:2,type:"Save",school:"Evocation",range:"Self (60ft line)",dmg:"-",desc:"60ft line of strong wind. Creatures must STR save or be pushed 15ft. Extinguishes flames (concentration, 1 min)",castTime:"1 Action"},
                {name:"Shatter",level:2,type:"Save",school:"Evocation",range:"60ft",dmg:"3d8",desc:"CON save or thunder damage in 10ft-radius sphere. Disadvantage if made of inorganic material",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:5, spells:[
                {name:"Call Lightning",level:3,type:"Save",school:"Conjuration",range:"120ft",dmg:"3d10",desc:"Summon storm cloud. Action: call down lightning bolt (DEX save, 3d10). Outdoors: 4d10 (concentration, 10 min)",castTime:"1 Action",upcast:"+1d10 per slot level"},
                {name:"Sleet Storm",level:3,type:"Save",school:"Conjuration",range:"150ft",dmg:"-",desc:"40ft-radius, 20ft-tall cylinder of freezing rain. DEX save or fall prone. Concentration checks for concentration spells",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Control Water",level:4,type:"Utility",school:"Transmutation",range:"300ft",dmg:"-",desc:"Flood, part, redirect, or whirlpool a body of water (concentration, 10 min)",castTime:"1 Action"},
                {name:"Ice Storm",level:4,type:"Save",school:"Evocation",range:"300ft",dmg:"2d8+4d6",desc:"DEX save or 2d8 bludgeoning and 4d6 cold in 20ft-radius, 40ft-tall cylinder. Area becomes difficult terrain",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:9, spells:[
                {name:"Destructive Wave",level:5,type:"Save",school:"Evocation",range:"Self (30ft)",dmg:"5d6+5d6",desc:"CON save or 5d6 thunder and 5d6 radiant or necrotic, and knocked prone. Half on success",castTime:"1 Action"},
                {name:"Insect Plague",level:5,type:"Save",school:"Conjuration",range:"300ft",dmg:"4d10",desc:"20ft-radius sphere of biting locusts. Lightly obscured. CON save or piercing damage (concentration, 10 min)",castTime:"1 Action",upcast:"+1d10 per slot level"}
            ]}
        ],
        "Light Domain": [
            {minLevel:1, spells:[
                {name:"Burning Hands",level:1,type:"Save",school:"Evocation",range:"Self (15ft cone)",dmg:"3d6",desc:"DEX save or fire damage in 15ft cone. Ignites flammable objects",castTime:"1 Action",upcast:"+1d6 per slot level"},
                {name:"Faerie Fire",level:1,type:"Save",school:"Evocation",range:"60ft",dmg:"-",desc:"Objects and creatures in 20ft cube glow. DEX save or outlined in light — all attacks against them have advantage (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:3, spells:[
                {name:"Flaming Sphere",level:2,type:"Save",school:"Conjuration",range:"60ft",dmg:"2d6",desc:"Create a 5ft-diameter sphere of fire. Bonus action to move 30ft. Creatures within 5ft: DEX save or fire damage (concentration, 1 min)",castTime:"1 Action",upcast:"+1d6 per slot level"},
                {name:"Scorching Ray",level:2,type:"Atk",school:"Evocation",range:"120ft",dmg:"6d6",desc:"Create three rays of fire, each requires a ranged spell attack, each deals 2d6 fire",castTime:"1 Action",upcast:"+1 ray per slot level"}
            ]},
            {minLevel:5, spells:[
                {name:"Daylight",level:3,type:"Utility",school:"Evocation",range:"60ft",dmg:"-",desc:"60ft-radius bright light from a point. Dispels darkness spells up to 3rd level. Sunlight for sensitive creatures (1 hr)",castTime:"1 Action"},
                {name:"Fireball",level:3,type:"Save",school:"Evocation",range:"150ft",dmg:"8d6",desc:"DEX save or fire damage in 20ft-radius sphere",castTime:"1 Action",upcast:"+1d6 per slot level"}
            ]},
            {minLevel:7, spells:[
                {name:"Guardian of Faith",level:4,type:"Utility",school:"Conjuration",range:"30ft",dmg:"20",desc:"Summon a Large spectral guardian. Hostile creatures entering 10ft: DEX save or 20 radiant damage (8 hrs or 60 total damage)",castTime:"1 Action"},
                {name:"Wall of Fire",level:4,type:"Save",school:"Evocation",range:"120ft",dmg:"5d8",desc:"Create a wall of flames up to 60ft long, 20ft high, 1ft thick. Creatures passing through take fire damage",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:9, spells:[
                {name:"Flame Strike",level:5,type:"Save",school:"Evocation",range:"60ft",dmg:"4d6+4d6",desc:"Column of divine fire: DEX save or 4d6 fire and 4d6 radiant in a 10ft-radius, 40ft-tall cylinder",castTime:"1 Action",upcast:"+1d6 fire and +1d6 radiant per slot level"},
                {name:"Scrying",level:5,type:"Save",school:"Divination",range:"Self",dmg:"-",desc:"See and hear a creature on the same plane of existence (WIS save, modified by familiarity). Concentration, 10 min",castTime:"10 Minutes"}
            ]}
        ],
        "Trickery Domain": [
            {minLevel:1, spells:[
                {name:"Charm Person",level:1,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"WIS save or charmed for 1 hour. Charmed creature treats you as friendly",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Disguise Self",level:1,type:"Utility",school:"Illusion",range:"Self",dmg:"-",desc:"Change your appearance (clothing, armor, weapons, features). Not a physical change. Lasts 1 hour",castTime:"1 Action"}
            ]},
            {minLevel:3, spells:[
                {name:"Mirror Image",level:2,type:"Buff",school:"Illusion",range:"Self",dmg:"-",desc:"Create 3 illusory duplicates. Attackers roll to hit — on certain rolls, the duplicate is hit and destroyed instead. Lasts 1 min",castTime:"1 Action"},
                {name:"Pass Without Trace",level:2,type:"Buff",school:"Abjuration",range:"Self",dmg:"-",desc:"Aura of shadow: you and allies within 30ft gain +10 to Stealth checks and can't be tracked by nonmagical means (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Blink",level:3,type:"Utility",school:"Transmutation",range:"Self",dmg:"-",desc:"At end of each turn, roll d20 — on 11+, vanish to Ethereal Plane until start of next turn (1 min)",castTime:"1 Action"},
                {name:"Dispel Magic",level:3,type:"Utility",school:"Abjuration",range:"120ft",dmg:"-",desc:"End spells of 3rd level or lower automatically. Higher-level spells require ability check (DC 10 + spell level)",castTime:"1 Action",upcast:"Automatically ends spells of the slot level or lower"}
            ]},
            {minLevel:7, spells:[
                {name:"Dimension Door",level:4,type:"Utility",school:"Conjuration",range:"500ft",dmg:"-",desc:"Teleport yourself and one willing creature to any spot within range you can visualize",castTime:"1 Action"},
                {name:"Polymorph",level:4,type:"Utility",school:"Transmutation",range:"60ft",dmg:"-",desc:"Transform a creature into a beast with CR equal to or less than its level or CR (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Dominate Person",level:5,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or charmed. You have telepathic link — issue commands as a bonus action (concentration, 1 min)",castTime:"1 Action",upcast:"+1 target per slot level at 8th, +1 hr duration at 7th"},
                {name:"Modify Memory",level:5,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"WIS save or you can modify up to 10 minutes of the target's memories from the last 24 hours (concentration, 1 min)",castTime:"1 Action"}
            ]}
        ],
        "Knowledge Domain": [
            {minLevel:1, spells:[
                {name:"Command",level:1,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or follow one-word command (Approach, Drop, Flee, Grovel, Halt)",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Identify",level:1,type:"Utility",school:"Divination",range:"Touch",dmg:"-",desc:"Learn magical properties of a magic item or the spells affecting a creature (ritual)",castTime:"1 Minute"}
            ]},
            {minLevel:3, spells:[
                {name:"Augury",level:2,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Receive omen from divine powers about results of a proposed course of action in the next 30 min (ritual)",castTime:"1 Minute"},
                {name:"Suggestion",level:2,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"WIS save or follow a reasonable suggestion for concentration, 8 hours",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Nondetection",level:3,type:"Utility",school:"Abjuration",range:"Touch",dmg:"-",desc:"Target can't be targeted by divination magic or perceived through magical scrying sensors (8 hrs)",castTime:"1 Action"},
                {name:"Speak with Dead",level:3,type:"Utility",school:"Necromancy",range:"10ft",dmg:"-",desc:"A corpse answers up to 5 questions. Can't reveal info it didn't know in life. Not compelled to tell truth (10 min)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Arcane Eye",level:4,type:"Utility",school:"Divination",range:"30ft",dmg:"-",desc:"Create invisible magical eye that moves 30ft/action. See through it (darkvision 30ft). Concentration, 1 hour",castTime:"1 Action"},
                {name:"Confusion",level:4,type:"Save",school:"Enchantment",range:"90ft",dmg:"-",desc:"WIS save or random behavior: move randomly, attack nearest, do nothing. Concentration, 1 min",castTime:"1 Action",upcast:"+5ft radius per slot level"}
            ]},
            {minLevel:9, spells:[
                {name:"Legend Lore",level:5,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Learn lore about a legendary person, place, or object — its history, powers, and weaknesses",castTime:"10 Minutes"},
                {name:"Scrying",level:5,type:"Save",school:"Divination",range:"Self",dmg:"-",desc:"See and hear a creature on the same plane of existence (WIS save, modified by familiarity). Concentration, 10 min",castTime:"10 Minutes"}
            ]}
        ],
        "Nature Domain": [
            {minLevel:1, spells:[
                {name:"Animal Friendship",level:1,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"WIS save or beast with Intelligence 3 or lower is charmed for 24 hours",castTime:"1 Action",upcast:"+1 beast per slot level"},
                {name:"Speak with Animals",level:1,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Comprehend and verbally communicate with beasts for 10 minutes (ritual)",castTime:"1 Action"}
            ]},
            {minLevel:3, spells:[
                {name:"Barkskin",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"Target's AC can't be less than 16 (concentration, 1 hr)",castTime:"1 Action"},
                {name:"Spike Growth",level:2,type:"Utility",school:"Transmutation",range:"150ft",dmg:"2d4",desc:"20ft-radius area covered in spikes. Difficult terrain. Moving through it deals 2d4 piercing per 5ft moved (concentration, 10 min)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Plant Growth",level:3,type:"Utility",school:"Transmutation",range:"150ft",dmg:"-",desc:"Overgrow plants in 100ft radius (4x difficult terrain) instantly, or enrich crops for a year in 1 mile",castTime:"1 Action or 8 Hours"},
                {name:"Wind Wall",level:3,type:"Save",school:"Evocation",range:"120ft",dmg:"3d8",desc:"Wall of strong wind 50ft long, 15ft tall. STR save or take bludgeoning damage. Small or smaller creatures and ranged attacks can't pass through",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Dominate Beast",level:4,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or beast is charmed and obeys your commands (concentration, 1 min)",castTime:"1 Action",upcast:"+1 hr duration at 5th"},
                {name:"Freedom of Movement",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature ignores difficult terrain and magical effects that slow movement. Can't be paralyzed or restrained by magic (1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Insect Plague",level:5,type:"Save",school:"Conjuration",range:"300ft",dmg:"4d10",desc:"20ft-radius sphere of biting locusts. Lightly obscured. CON save or piercing damage (concentration, 10 min)",castTime:"1 Action",upcast:"+1d10 per slot level"},
                {name:"Tree Stride",level:5,type:"Utility",school:"Conjuration",range:"Self",dmg:"-",desc:"Enter a tree and teleport to another tree of the same type within 500ft. Move between multiple trees (concentration, 1 min)",castTime:"1 Action"}
            ]}
        ],
        "Death Domain": [
            {minLevel:1, spells:[
                {name:"False Life",level:1,type:"Buff",school:"Necromancy",range:"Self",dmg:"-",desc:"Gain 1d4+4 temporary HP (1 hr)",castTime:"1 Action",upcast:"+5 temp HP per slot level"},
                {name:"Ray of Sickness",level:1,type:"Atk",school:"Necromancy",range:"60ft",dmg:"2d8",desc:"Ranged spell attack: poison damage. Hit target: CON save or also Poisoned until end of your next turn",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Blindness/Deafness",level:2,type:"Save",school:"Necromancy",range:"30ft",dmg:"-",desc:"CON save or blinded or deafened for 1 minute. Repeats each turn",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Ray of Enfeeblement",level:2,type:"Atk",school:"Necromancy",range:"60ft",dmg:"-",desc:"Ranged spell attack: creature deals only half damage with STR-based attacks (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Animate Dead",level:3,type:"Utility",school:"Necromancy",range:"10ft",dmg:"-",desc:"Create a zombie or skeleton from a corpse or pile of bones. Obeys your commands for 24 hrs",castTime:"1 Minute",upcast:"+2 undead per slot level"},
                {name:"Speak with Dead",level:3,type:"Utility",school:"Necromancy",range:"10ft",dmg:"-",desc:"A corpse answers up to 5 questions. Can't reveal info it didn't know in life (10 min)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Blight",level:4,type:"Save",school:"Necromancy",range:"30ft",dmg:"8d8",desc:"CON save or necrotic damage. Plants take maximum damage with no save",castTime:"1 Action",upcast:"+1d8 per slot level"},
                {name:"Death Ward",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature drops to 1 HP the first time it would drop to 0 HP (8 hours)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Antilife Shell",level:5,type:"Utility",school:"Abjuration",range:"Self (10ft)",dmg:"-",desc:"Animated barrier prevents living creatures from entering 10ft around you (concentration, 1 hr)",castTime:"1 Action"},
                {name:"Cloudkill",level:5,type:"Save",school:"Conjuration",range:"120ft",dmg:"5d8",desc:"20ft-radius sphere of poisonous yellow-green fog. CON save or poison damage. Fog moves 10ft/round (concentration, 10 min)",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]}
        ],
        "Arcana Domain": [
            {minLevel:1, spells:[
                {name:"Detect Magic",level:1,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Sense magic within 30ft for 10 minutes. See aura and learn school of magic (concentration, ritual)",castTime:"1 Action"},
                {name:"Magic Missile",level:1,type:"Dmg",school:"Evocation",range:"120ft",dmg:"3d4+3",desc:"Three darts of magical force that automatically hit and deal 1d4+1 force each",castTime:"1 Action",upcast:"+1 dart per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Magic Weapon",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"A nonmagical weapon becomes a +1 magic weapon (concentration, 1 hr)",castTime:"Bonus Action",upcast:"+2 at 4th, +3 at 6th level slot"},
                {name:"Magic Circle",level:3,type:"Utility",school:"Abjuration",range:"10ft",dmg:"-",desc:"10ft-radius circle traps or repels celestials, elementals, fey, fiends, or undead (1 hr, 100gp material)",castTime:"1 Minute"}
            ]},
            {minLevel:5, spells:[
                {name:"Dispel Magic",level:3,type:"Utility",school:"Abjuration",range:"120ft",dmg:"-",desc:"End spells of 3rd level or lower automatically. Higher-level spells require ability check (DC 10 + spell level)",castTime:"1 Action",upcast:"Automatically ends spells of the slot level or lower"},
                {name:"Magic Circle",level:3,type:"Utility",school:"Abjuration",range:"10ft",dmg:"-",desc:"10ft-radius circle traps or repels celestials, elementals, fey, fiends, or undead (1 hr)",castTime:"1 Minute"}
            ]},
            {minLevel:7, spells:[
                {name:"Arcane Eye",level:4,type:"Utility",school:"Divination",range:"30ft",dmg:"-",desc:"Create invisible magical eye that moves 30ft/action. See through it with darkvision 30ft (concentration, 1 hr)",castTime:"1 Action"},
                {name:"Banishment",level:4,type:"Save",school:"Abjuration",range:"60ft",dmg:"-",desc:"CHA save or banished to a harmless demiplane (concentration, 1 min). Permanent if held for full duration",castTime:"1 Action",upcast:"+1 target per slot level"}
            ]},
            {minLevel:9, spells:[
                {name:"Planar Binding",level:5,type:"Save",school:"Abjuration",range:"60ft",dmg:"-",desc:"CHA save or a celestial, elemental, fey, or fiend is bound to serve you for 24 hours (1,000gp material)",castTime:"1 Hour",upcast:"+1 day per slot level above 5th"},
                {name:"Teleportation Circle",level:5,type:"Utility",school:"Conjuration",range:"10ft",dmg:"-",desc:"Glowing portal connects to a known permanent teleportation circle on the same plane (round trip, 50gp chalk)",castTime:"1 Minute"}
            ]}
        ],
        "Forge Domain": [
            {minLevel:1, spells:[
                {name:"Identify",level:1,type:"Utility",school:"Divination",range:"Touch",dmg:"-",desc:"Learn magical properties of a magic item or the spells affecting a creature (ritual)",castTime:"1 Minute"},
                {name:"Searing Smite",level:1,type:"Buff",school:"Evocation",range:"Self",dmg:"1d6",desc:"Your next weapon hit deals extra 1d6 fire damage and ignites the target. CON save or continue burning (concentration, 1 min)",castTime:"Bonus Action",upcast:"+1d6 per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Heat Metal",level:2,type:"Save",school:"Transmutation",range:"60ft",dmg:"2d8",desc:"CON save or take fire damage from heated metal object. Drop or take disadvantage on attacks/checks (concentration, 1 min)",castTime:"1 Action",upcast:"+1d8 per slot level"},
                {name:"Magic Weapon",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"A nonmagical weapon becomes a +1 magic weapon (concentration, 1 hr)",castTime:"Bonus Action",upcast:"+2 at 4th, +3 at 6th level slot"}
            ]},
            {minLevel:5, spells:[
                {name:"Elemental Weapon",level:3,type:"Buff",school:"Transmutation",range:"Touch",dmg:"1d4",desc:"A nonmagical weapon becomes +1 and deals +1d4 acid/cold/fire/lightning/thunder damage (concentration, 1 hr)",castTime:"1 Action",upcast:"+2 bonus at 5th, +3 at 7th; +2d4 at 5th, +3d4 at 7th"},
                {name:"Protection from Energy",level:3,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Resistance to acid, cold, fire, lightning, or thunder damage (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Fabricate",level:4,type:"Utility",school:"Transmutation",range:"120ft",dmg:"-",desc:"Convert raw materials into finished products. Wood into furniture, stone into statues, etc. (1 min to 1 hr)",castTime:"10 Minutes"},
                {name:"Wall of Fire",level:4,type:"Save",school:"Evocation",range:"120ft",dmg:"5d8",desc:"Create a wall of flames up to 60ft long, 20ft high, 1ft thick. Creatures passing through take fire damage",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:9, spells:[
                {name:"Animate Objects",level:5,type:"Utility",school:"Transmutation",range:"120ft",dmg:"-",desc:"Animate up to 10 small or fewer larger objects. They obey your commands, attacking with bonus action (concentration, 1 min)",castTime:"1 Action",upcast:"+2 objects per slot level"},
                {name:"Creation",level:5,type:"Utility",school:"Illusion",range:"30ft",dmg:"-",desc:"Create a nonliving object from shadowstuff. Duration based on material (mineral=permanent, organic=varies)",castTime:"1 Minute",upcast:"+5ft cube per slot level"}
            ]}
        ],
        "Grave Domain": [
            {minLevel:1, spells:[
                {name:"Bane",level:1,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"CHA save or up to 3 creatures subtract 1d4 from attack rolls and saving throws (concentration, 1 min)",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"False Life",level:1,type:"Buff",school:"Necromancy",range:"Self",dmg:"-",desc:"Gain 1d4+4 temporary HP (1 hr)",castTime:"1 Action",upcast:"+5 temp HP per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Gentle Repose",level:2,type:"Utility",school:"Necromancy",range:"Touch",dmg:"-",desc:"Preserve a corpse from decay and prevent it from rising as undead for 10 days (ritual)",castTime:"1 Action"},
                {name:"Ray of Enfeeblement",level:2,type:"Atk",school:"Necromancy",range:"60ft",dmg:"-",desc:"Ranged spell attack: creature deals only half damage with STR-based attacks (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Revivify",level:3,type:"Heal",school:"Necromancy",range:"Touch",dmg:"-",desc:"Return a creature to life who died within the last minute (300gp diamond)",castTime:"1 Action"},
                {name:"Vampiric Touch",level:3,type:"Atk",school:"Necromancy",range:"Self",dmg:"3d6",desc:"Melee spell attack: necrotic damage, heal half as HP (concentration, 1 min)",castTime:"1 Action",upcast:"+1d6 per slot level"}
            ]},
            {minLevel:7, spells:[
                {name:"Blight",level:4,type:"Save",school:"Necromancy",range:"30ft",dmg:"8d8",desc:"CON save or necrotic damage. Plants take maximum damage with no save",castTime:"1 Action",upcast:"+1d8 per slot level"},
                {name:"Death Ward",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature drops to 1 HP the first time it would drop to 0 HP (8 hours)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Antilife Shell",level:5,type:"Utility",school:"Abjuration",range:"Self (10ft)",dmg:"-",desc:"Animated barrier prevents living creatures from entering 10ft around you (concentration, 1 hr)",castTime:"1 Action"},
                {name:"Raise Dead",level:5,type:"Heal",school:"Necromancy",range:"Touch",dmg:"-",desc:"Restore life to a creature dead no longer than 10 days (500gp diamond). Creature suffers -4 penalty for 4 days",castTime:"1 Hour"}
            ]}
        ],
        "Order Domain": [
            {minLevel:1, spells:[
                {name:"Command",level:1,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or follow one-word command: Approach, Drop, Flee, Grovel, or Halt",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Heroism",level:1,type:"Buff",school:"Enchantment",range:"Touch",dmg:"-",desc:"Creature is immune to frightened and gains CHA modifier temporary HP at the start of each turn (concentration, 1 min)",castTime:"1 Action",upcast:"+1 target per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Hold Person",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or paralyzed for up to 1 minute (concentration). Repeat save each turn",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Zone of Truth",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"15ft-radius sphere: CHA save or can't lie. Creatures know they're in the zone (10 min)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Mass Healing Word",level:3,type:"Heal",school:"Evocation",range:"60ft",dmg:"1d4+Mod",desc:"Up to 6 creatures each regain 1d4 + spellcasting modifier HP",castTime:"Bonus Action",upcast:"+1d4 per slot level"},
                {name:"Slow",level:3,type:"Save",school:"Transmutation",range:"120ft",dmg:"-",desc:"WIS save or up to 6 targets halved speed, -2 AC and DEX saves, can't use reactions, one action or bonus action only (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Compulsion",level:4,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"WIS save or creatures move in chosen direction at end of each turn (concentration, 1 min). Doesn't provoke opportunity attacks",castTime:"1 Action"},
                {name:"Locate Creature",level:4,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Sense direction to a specific known creature or nearest creature of a type within 1,000ft (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Commune",level:5,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Your deity answers up to 3 yes-or-no questions truthfully (ritual)",castTime:"1 Minute"},
                {name:"Dominate Person",level:5,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or charmed. You have telepathic link — issue commands as a bonus action (concentration, 1 min)",castTime:"1 Action",upcast:"+1 target per slot level at 8th"}
            ]}
        ],
        // PALADIN OATHS
        "Oath of Devotion": [
            {minLevel:3, spells:[
                {name:"Protection from Evil and Good",level:1,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Aberrations, celestials, elementals, fey, fiends, undead: disadvantage on attacks, can't charm/frighten/possess target (concentration, 10 min)",castTime:"1 Action"},
                {name:"Sanctuary",level:1,type:"Buff",school:"Abjuration",range:"30ft",dmg:"-",desc:"WIS save or creature can't attack the warded target. Ward ends if the target attacks or casts an offensive spell (1 min)",castTime:"Bonus Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Lesser Restoration",level:2,type:"Utility",school:"Abjuration",range:"Touch",dmg:"-",desc:"End one disease, poison, paralysis, or blindness on a creature",castTime:"1 Action"},
                {name:"Zone of Truth",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"15ft-radius sphere: CHA save or can't lie (10 min)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Beacon of Hope",level:3,type:"Buff",school:"Abjuration",range:"30ft",dmg:"-",desc:"Creatures have advantage on WIS saves and death saves, maximize healing received (concentration, 1 min)",castTime:"1 Action"},
                {name:"Dispel Magic",level:3,type:"Utility",school:"Abjuration",range:"120ft",dmg:"-",desc:"End spells of 3rd level or lower automatically. Higher-level spells require ability check",castTime:"1 Action"}
            ]},
            {minLevel:13, spells:[
                {name:"Freedom of Movement",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature ignores difficult terrain and magical movement restrictions (1 hr)",castTime:"1 Action"},
                {name:"Guardian of Faith",level:4,type:"Utility",school:"Conjuration",range:"30ft",dmg:"20",desc:"Summon spectral guardian. Hostile creatures within 10ft: DEX save or 20 radiant damage",castTime:"1 Action"}
            ]},
            {minLevel:17, spells:[
                {name:"Commune",level:5,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Your deity answers up to 3 yes-or-no questions truthfully (ritual)",castTime:"1 Minute"},
                {name:"Flame Strike",level:5,type:"Save",school:"Evocation",range:"60ft",dmg:"4d6+4d6",desc:"Column of divine fire: 4d6 fire and 4d6 radiant in a 10ft-radius, 40ft-tall cylinder (DEX save)",castTime:"1 Action"}
            ]}
        ],
        "Oath of the Ancients": [
            {minLevel:3, spells:[
                {name:"Ensnaring Strike",level:1,type:"Buff",school:"Conjuration",range:"Self",dmg:"1d6",desc:"Next weapon hit: STR save or restrained by magical vines. Deals 1d6 piercing/turn. STR check to escape (concentration, 1 min)",castTime:"Bonus Action",upcast:"+1d6 per slot level"},
                {name:"Speak with Animals",level:1,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Comprehend and verbally communicate with beasts for 10 minutes",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Misty Step",level:2,type:"Utility",school:"Conjuration",range:"Self",dmg:"-",desc:"Teleport up to 30ft to an unoccupied space you can see",castTime:"Bonus Action"},
                {name:"Moonbeam",level:2,type:"Save",school:"Evocation",range:"120ft",dmg:"2d10",desc:"5ft-radius, 40ft-tall cylinder of silvery light. CON save or radiant damage. Shapechangers have disadvantage (concentration, 1 min)",castTime:"1 Action",upcast:"+1d10 per slot level"}
            ]},
            {minLevel:9, spells:[
                {name:"Plant Growth",level:3,type:"Utility",school:"Transmutation",range:"150ft",dmg:"-",desc:"Overgrow plants in 100ft radius (4x difficult terrain), or enrich crops for 1 year in 1 mile",castTime:"1 Action or 8 Hours"},
                {name:"Protection from Energy",level:3,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Resistance to acid, cold, fire, lightning, or thunder damage (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:13, spells:[
                {name:"Ice Storm",level:4,type:"Save",school:"Evocation",range:"300ft",dmg:"2d8+4d6",desc:"DEX save or 2d8 bludgeoning and 4d6 cold in 20ft-radius. Area becomes difficult terrain",castTime:"1 Action"},
                {name:"Stoneskin",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Target gains resistance to bludgeoning, piercing, and slashing from non-magical attacks (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:17, spells:[
                {name:"Commune with Nature",level:5,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Gain up to 3 pieces of information about the surrounding territory within 3 miles (ritual)",castTime:"1 Minute"},
                {name:"Tree Stride",level:5,type:"Utility",school:"Conjuration",range:"Self",dmg:"-",desc:"Enter a tree and teleport to another tree of the same type within 500ft (concentration, 1 min)",castTime:"1 Action"}
            ]}
        ],
        "Oath of Vengeance": [
            {minLevel:3, spells:[
                {name:"Bane",level:1,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"CHA save or up to 3 creatures subtract 1d4 from attack rolls and saving throws (concentration, 1 min)",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Hunter's Mark",level:1,type:"Buff",school:"Divination",range:"90ft",dmg:"1d6",desc:"Mark a creature as your prey: +1d6 damage on weapon hits, advantage on Perception/Survival to track (concentration, 1 hr)",castTime:"Bonus Action",upcast:"+8 hrs at 3rd, +24 hrs at 5th level slot"}
            ]},
            {minLevel:5, spells:[
                {name:"Hold Person",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or paralyzed for up to 1 minute (concentration). Repeat save each turn",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Misty Step",level:2,type:"Utility",school:"Conjuration",range:"Self",dmg:"-",desc:"Teleport up to 30ft to an unoccupied space you can see",castTime:"Bonus Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Haste",level:3,type:"Buff",school:"Transmutation",range:"30ft",dmg:"-",desc:"+2 AC, double speed, extra action limited to Attack/Dash/Disengage/Hide/Use Object (concentration, 1 min)",castTime:"1 Action"},
                {name:"Protection from Energy",level:3,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Resistance to acid, cold, fire, lightning, or thunder damage (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:13, spells:[
                {name:"Banishment",level:4,type:"Save",school:"Abjuration",range:"60ft",dmg:"-",desc:"CHA save or banished to a harmless demiplane (concentration, 1 min). Permanent if held for full duration",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Dimension Door",level:4,type:"Utility",school:"Conjuration",range:"500ft",dmg:"-",desc:"Teleport yourself and one willing creature to any spot within range you can visualize",castTime:"1 Action"}
            ]},
            {minLevel:17, spells:[
                {name:"Hold Monster",level:5,type:"Save",school:"Enchantment",range:"90ft",dmg:"-",desc:"WIS save or target is paralyzed. Works on any creature type (concentration, 1 min)",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Scrying",level:5,type:"Save",school:"Divination",range:"Self",dmg:"-",desc:"See and hear a creature on the same plane of existence (WIS save, modified by familiarity, concentration, 10 min)",castTime:"10 Minutes"}
            ]}
        ],
        "Oath of Conquest": [
            {minLevel:3, spells:[
                {name:"Armor of Agathys",level:1,type:"Buff",school:"Abjuration",range:"Self",dmg:"5",desc:"Gain 5 temp HP. Creatures that hit you in melee take 5 cold damage while those temp HP remain",castTime:"1 Action",upcast:"+5 temp HP and +5 damage per slot level"},
                {name:"Command",level:1,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or follow one-word command: Approach, Drop, Flee, Grovel, or Halt",castTime:"1 Action",upcast:"+1 target per slot level"}
            ]},
            {minLevel:5, spells:[
                {name:"Hold Person",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or paralyzed for up to 1 minute (concentration). Repeat save each turn",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Spiritual Weapon",level:2,type:"Atk",school:"Evocation",range:"60ft",dmg:"1d8+Mod",desc:"Summon a floating spectral weapon. Bonus action to attack each turn",castTime:"Bonus Action",upcast:"+1d8 per 2 slot levels"}
            ]},
            {minLevel:9, spells:[
                {name:"Bestow Curse",level:3,type:"Save",school:"Necromancy",range:"Touch",dmg:"-",desc:"WIS save or cursed for concentration, 1 min. Choose: disadvantage on stat, disadvantage on attacks vs you, WIS save on each turn or lose action, or take +1d8 necrotic",castTime:"1 Action",upcast:"+1 hr at 4th, 8 hrs at 5th, 24 hrs at 7th, permanent at 9th"},
                {name:"Fear",level:3,type:"Save",school:"Illusion",range:"Self (30ft cone)",dmg:"-",desc:"WIS save or frightened and must use movement to flee you (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:13, spells:[
                {name:"Dominate Beast",level:4,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or beast is charmed and obeys your commands (concentration, 1 min)",castTime:"1 Action"},
                {name:"Stoneskin",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Target gains resistance to bludgeoning, piercing, and slashing from non-magical attacks (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:17, spells:[
                {name:"Cloudkill",level:5,type:"Save",school:"Conjuration",range:"120ft",dmg:"5d8",desc:"20ft-radius sphere of poisonous fog. CON save or poison damage. Fog moves 10ft/round (concentration, 10 min)",castTime:"1 Action",upcast:"+1d8 per slot level"},
                {name:"Dominate Person",level:5,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or charmed. Issue commands as a bonus action (concentration, 1 min)",castTime:"1 Action"}
            ]}
        ],
        "Oath of Redemption": [
            {minLevel:3, spells:[
                {name:"Sanctuary",level:1,type:"Buff",school:"Abjuration",range:"30ft",dmg:"-",desc:"WIS save or creature can't attack the warded target (1 min)",castTime:"Bonus Action"},
                {name:"Sleep",level:1,type:"Utility",school:"Enchantment",range:"90ft",dmg:"5d8",desc:"Roll HP pool, creatures with HP up to total fall unconscious (1 min or until woken)",castTime:"1 Action",upcast:"+2d8 HP per slot level"}
            ]},
            {minLevel:5, spells:[
                {name:"Calm Emotions",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"CHA save or creatures in 20ft radius are suppressed of charm/fright, or become indifferent to foes (concentration, 1 min)",castTime:"1 Action"},
                {name:"Hold Person",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or paralyzed for up to 1 minute (concentration)",castTime:"1 Action",upcast:"+1 target per slot level"}
            ]},
            {minLevel:9, spells:[
                {name:"Counterspell",level:3,type:"Reaction",school:"Abjuration",range:"60ft",dmg:"-",desc:"Interrupt a spell of 3rd level or lower automatically. Higher-level spells require ability check (DC 10 + spell level)",castTime:"Reaction"},
                {name:"Hypnotic Pattern",level:3,type:"Save",school:"Illusion",range:"120ft",dmg:"-",desc:"WIS save or incapacitated and charmed by swirling colors in 30ft cube (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:13, spells:[
                {name:"Otiluke's Resilient Sphere",level:4,type:"Save",school:"Evocation",range:"30ft",dmg:"-",desc:"DEX save or enclosed in a translucent sphere. Can't be harmed or harm others (concentration, 1 min)",castTime:"1 Action"},
                {name:"Stoneskin",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Target gains resistance to bludgeoning, piercing, and slashing from non-magical attacks (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:17, spells:[
                {name:"Hold Monster",level:5,type:"Save",school:"Enchantment",range:"90ft",dmg:"-",desc:"WIS save or target is paralyzed. Works on any creature type (concentration, 1 min)",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Wall of Force",level:5,type:"Utility",school:"Evocation",range:"120ft",dmg:"-",desc:"Create an invisible wall up to ten 10ft panels in any configuration. Immune to damage, can't be dispelled (concentration, 10 min)",castTime:"1 Action"}
            ]}
        ],
        "Oath of Glory": [
            {minLevel:3, spells:[
                {name:"Guiding Bolt",level:1,type:"Atk",school:"Evocation",range:"120ft",dmg:"4d6",desc:"Radiant damage, next attack roll against the target this turn has advantage",castTime:"1 Action",upcast:"+1d6 per slot level"},
                {name:"Heroism",level:1,type:"Buff",school:"Enchantment",range:"Touch",dmg:"-",desc:"Creature is immune to frightened and gains CHA modifier temporary HP at start of each turn (concentration, 1 min)",castTime:"1 Action",upcast:"+1 target per slot level"}
            ]},
            {minLevel:5, spells:[
                {name:"Enhance Ability",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"Grant advantage on checks for one ability score and additional effects per stat chosen (concentration, 1 hr)",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Magic Weapon",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"A nonmagical weapon becomes a +1 magic weapon (concentration, 1 hr)",castTime:"Bonus Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Aura of Vitality",level:3,type:"Heal",school:"Evocation",range:"Self (30ft)",dmg:"2d6",desc:"Bonus action each turn: heal one creature within 30ft for 2d6 HP (concentration, 1 min)",castTime:"1 Action"},
                {name:"Protection from Energy",level:3,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Resistance to acid, cold, fire, lightning, or thunder damage (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:13, spells:[
                {name:"Compulsion",level:4,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"WIS save or creatures move in chosen direction each turn (concentration, 1 min)",castTime:"1 Action"},
                {name:"Freedom of Movement",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature ignores difficult terrain and magical movement restrictions (1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:17, spells:[
                {name:"Legend Lore",level:5,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Learn lore about a legendary person, place, or object — history, powers, and weaknesses",castTime:"10 Minutes"},
                {name:"Yolk's Forcecage",level:7,type:"Save",school:"Evocation",range:"100ft",dmg:"-",desc:"Magical cage of force bars or solid box traps creatures within 20ft cube (1 hr, 1500gp dust). Concentration-free",castTime:"1 Action"}
            ]}
        ],
        // DRUID CIRCLES
        "Circle of the Land (Arctic)": [
            {minLevel:3, spells:[
                {name:"Hold Person",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or paralyzed for up to 1 minute (concentration)",castTime:"1 Action"},
                {name:"Spike Growth",level:2,type:"Utility",school:"Transmutation",range:"150ft",dmg:"2d4",desc:"Difficult terrain of spikes. Moving through deals 2d4 piercing per 5ft (concentration, 10 min)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Sleet Storm",level:3,type:"Save",school:"Conjuration",range:"150ft",dmg:"-",desc:"40ft-radius of freezing rain. DEX save or fall prone. Concentration checks for spellcasters inside",castTime:"1 Action"},
                {name:"Slow",level:3,type:"Save",school:"Transmutation",range:"120ft",dmg:"-",desc:"WIS save or up to 6 targets halved speed, -2 AC and DEX saves, can't use reactions (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Freedom of Movement",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature ignores difficult terrain and magical movement restrictions (1 hr)",castTime:"1 Action"},
                {name:"Ice Storm",level:4,type:"Save",school:"Evocation",range:"300ft",dmg:"2d8+4d6",desc:"DEX save or 2d8 bludgeoning and 4d6 cold in 20ft-radius cylinder. Difficult terrain created",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Commune with Nature",level:5,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Gain up to 3 pieces of information about the surrounding territory within 3 miles (ritual)",castTime:"1 Minute"},
                {name:"Cone of Cold",level:5,type:"Save",school:"Evocation",range:"Self (60ft cone)",dmg:"8d8",desc:"CON save or cold damage in 60ft cone",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]}
        ],
        "Circle of the Land (Forest)": [
            {minLevel:3, spells:[
                {name:"Barkskin",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"Target's AC can't be less than 16 (concentration, 1 hr)",castTime:"1 Action"},
                {name:"Spider Climb",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"Creature can climb on ceilings and walls and difficult surfaces without ability checks (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Call Lightning",level:3,type:"Save",school:"Conjuration",range:"120ft",dmg:"3d10",desc:"Summon storm cloud. Action: call down lightning bolt (DEX save, 3d10). Outdoors: 4d10 (concentration, 10 min)",castTime:"1 Action"},
                {name:"Plant Growth",level:3,type:"Utility",school:"Transmutation",range:"150ft",dmg:"-",desc:"Overgrow plants in 100ft radius (4x difficult terrain) instantly, or enrich crops for 1 year in 1 mile",castTime:"1 Action or 8 Hours"}
            ]},
            {minLevel:7, spells:[
                {name:"Divination",level:4,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Receive truthful answer from divine power about a specific goal, event, or activity within 7 days (ritual, 25gp incense)",castTime:"1 Action"},
                {name:"Freedom of Movement",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature ignores difficult terrain and magical movement restrictions (1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Commune with Nature",level:5,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Gain up to 3 pieces of information about the surrounding territory within 3 miles (ritual)",castTime:"1 Minute"},
                {name:"Tree Stride",level:5,type:"Utility",school:"Conjuration",range:"Self",dmg:"-",desc:"Enter a tree and teleport to another tree of the same type within 500ft (concentration, 1 min)",castTime:"1 Action"}
            ]}
        ],
        "Circle of the Land (Mountain)": [
            {minLevel:3, spells:[
                {name:"Spider Climb",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"Creature can climb on ceilings and walls and difficult surfaces without ability checks (concentration, 1 hr)",castTime:"1 Action"},
                {name:"Spike Growth",level:2,type:"Utility",school:"Transmutation",range:"150ft",dmg:"2d4",desc:"Difficult terrain of spikes in 20ft radius. Moving through deals 2d4 piercing per 5ft (concentration, 10 min)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Lightning Bolt",level:3,type:"Save",school:"Evocation",range:"Self (100ft line)",dmg:"8d6",desc:"5ft-wide line, DEX save or lightning damage",castTime:"1 Action",upcast:"+1d6 per slot level"},
                {name:"Meld into Stone",level:3,type:"Utility",school:"Transmutation",range:"Touch",dmg:"-",desc:"Step into a stone object large enough to contain you. No need to eat, drink, or breathe inside (8 hrs, ritual)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Stone Shape",level:4,type:"Utility",school:"Transmutation",range:"Touch",dmg:"-",desc:"Reshape stone into any shape. Create a door in a wall, seal an opening, or form a rough weapon or tool",castTime:"1 Action"},
                {name:"Stoneskin",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Target gains resistance to bludgeoning, piercing, and slashing from non-magical attacks (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Passwall",level:5,type:"Utility",school:"Transmutation",range:"30ft",dmg:"-",desc:"Create a passage through a wooden, plaster, or stone wall up to 20ft deep (8 hrs)",castTime:"1 Action"},
                {name:"Wall of Stone",level:5,type:"Utility",school:"Evocation",range:"120ft",dmg:"-",desc:"Create a nonmagical wall of stone. Panels are 10ft x 10ft x 6in. Can be permanent if concentration maintained for full duration",castTime:"1 Action"}
            ]}
        ],
        "Circle of the Land (Swamp)": [
            {minLevel:3, spells:[
                {name:"Darkness",level:2,type:"Utility",school:"Evocation",range:"60ft",dmg:"-",desc:"Magical darkness fills 15ft-radius sphere. Blocks darkvision. Can't be lit by nonmagical means (concentration, 10 min)",castTime:"1 Action"},
                {name:"Melf's Acid Arrow",level:2,type:"Atk",school:"Evocation",range:"90ft",dmg:"4d4+2d4",desc:"Ranged spell attack: 4d4 acid damage and 2d4 acid at end of next turn. Miss: 2d4 acid only",castTime:"1 Action",upcast:"+1d4 per slot level"}
            ]},
            {minLevel:5, spells:[
                {name:"Water Walk",level:3,type:"Utility",school:"Transmutation",range:"30ft",dmg:"-",desc:"Up to 10 creatures can walk on liquid surfaces as if solid (1 hr, ritual)",castTime:"1 Action"},
                {name:"Stinking Cloud",level:3,type:"Save",school:"Conjuration",range:"90ft",dmg:"-",desc:"20ft-radius sphere of nauseating yellow-green gas. CON save or lose action on turn (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Freedom of Movement",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature ignores difficult terrain and magical movement restrictions (1 hr)",castTime:"1 Action"},
                {name:"Locate Creature",level:4,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Sense direction to a specific known creature within 1,000ft (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Insect Plague",level:5,type:"Save",school:"Conjuration",range:"300ft",dmg:"4d10",desc:"20ft-radius sphere of biting locusts. Lightly obscured. CON save or piercing damage (concentration, 10 min)",castTime:"1 Action",upcast:"+1d10 per slot level"},
                {name:"Scrying",level:5,type:"Save",school:"Divination",range:"Self",dmg:"-",desc:"See and hear a creature on the same plane of existence (WIS save, concentration, 10 min)",castTime:"10 Minutes"}
            ]}
        ],
        "Circle of the Land (Coast)": [
            {minLevel:3, spells:[
                {name:"Mirror Image",level:2,type:"Buff",school:"Illusion",range:"Self",dmg:"-",desc:"Create 3 illusory duplicates. Attackers may hit a duplicate instead (1 min)",castTime:"1 Action"},
                {name:"Misty Step",level:2,type:"Utility",school:"Conjuration",range:"Self",dmg:"-",desc:"Teleport up to 30ft to an unoccupied space you can see",castTime:"Bonus Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Water Breathing",level:3,type:"Utility",school:"Transmutation",range:"30ft",dmg:"-",desc:"Up to 10 creatures can breathe underwater for 24 hours (ritual)",castTime:"1 Action"},
                {name:"Water Walk",level:3,type:"Utility",school:"Transmutation",range:"30ft",dmg:"-",desc:"Up to 10 creatures can walk on liquid surfaces as if solid (1 hr, ritual)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Control Water",level:4,type:"Utility",school:"Transmutation",range:"300ft",dmg:"-",desc:"Flood, part, redirect, or whirlpool a body of water (concentration, 10 min)",castTime:"1 Action"},
                {name:"Freedom of Movement",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature ignores difficult terrain and magical movement restrictions (1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Conjure Elemental",level:5,type:"Utility",school:"Conjuration",range:"90ft",dmg:"-",desc:"Summon an elemental of CR 5 or lower from one of the four elements (concentration, 1 hr)",castTime:"1 Minute",upcast:"+1 CR per slot level"},
                {name:"Scrying",level:5,type:"Save",school:"Divination",range:"Self",dmg:"-",desc:"See and hear a creature on the same plane of existence (WIS save, concentration, 10 min)",castTime:"10 Minutes"}
            ]}
        ],
        "Circle of the Land (Grassland)": [
            {minLevel:3, spells:[
                {name:"Invisibility",level:2,type:"Buff",school:"Illusion",range:"Touch",dmg:"-",desc:"Creature becomes invisible for up to 1 hour (concentration). Ends if creature attacks or casts a spell",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Pass Without Trace",level:2,type:"Buff",school:"Abjuration",range:"Self",dmg:"-",desc:"Aura of shadow: you and allies within 30ft gain +10 to Stealth checks (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Daylight",level:3,type:"Utility",school:"Evocation",range:"60ft",dmg:"-",desc:"60ft-radius bright light. Dispels darkness spells up to 3rd level (1 hr)",castTime:"1 Action"},
                {name:"Haste",level:3,type:"Buff",school:"Transmutation",range:"30ft",dmg:"-",desc:"+2 AC, double speed, extra action (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Divination",level:4,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Receive truthful answer from divine power about a specific goal within 7 days (ritual)",castTime:"1 Action"},
                {name:"Freedom of Movement",level:4,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Creature ignores difficult terrain and magical movement restrictions (1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Dream",level:5,type:"Utility",school:"Illusion",range:"Special",dmg:"-",desc:"Shape the dreams of a creature. Messenger touches a sleeping creature and interacts with its dreams (8 hrs)",castTime:"1 Minute"},
                {name:"Insect Plague",level:5,type:"Save",school:"Conjuration",range:"300ft",dmg:"4d10",desc:"20ft-radius sphere of biting locusts. CON save or piercing damage (concentration, 10 min)",castTime:"1 Action"}
            ]}
        ],
        "Circle of the Land (Desert)": [
            {minLevel:3, spells:[
                {name:"Blur",level:2,type:"Buff",school:"Illusion",range:"Self",dmg:"-",desc:"Attackers have disadvantage on attack rolls against you (concentration, 1 min)",castTime:"1 Action"},
                {name:"Silence",level:2,type:"Utility",school:"Illusion",range:"120ft",dmg:"-",desc:"No sound in 20ft-radius sphere. Sound-based spells can't be cast or affected inside (concentration, 10 min, ritual)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Create Food and Water",level:3,type:"Utility",school:"Conjuration",range:"30ft",dmg:"-",desc:"Create 45 lbs of food and 30 gallons of water — enough for 15 humanoids and 5 steeds for 24 hours",castTime:"1 Action"},
                {name:"Protection from Energy",level:3,type:"Buff",school:"Abjuration",range:"Touch",dmg:"-",desc:"Resistance to acid, cold, fire, lightning, or thunder damage (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Blight",level:4,type:"Save",school:"Necromancy",range:"30ft",dmg:"8d8",desc:"CON save or necrotic damage. Plants take maximum damage with no save",castTime:"1 Action",upcast:"+1d8 per slot level"},
                {name:"Hallucinatory Terrain",level:4,type:"Utility",school:"Illusion",range:"300ft",dmg:"-",desc:"Make natural terrain look, sound, and smell like another terrain type within 300ft (24 hrs)",castTime:"10 Minutes"}
            ]},
            {minLevel:9, spells:[
                {name:"Insect Plague",level:5,type:"Save",school:"Conjuration",range:"300ft",dmg:"4d10",desc:"20ft-radius sphere of biting locusts. CON save or piercing damage (concentration, 10 min)",castTime:"1 Action",upcast:"+1d10 per slot level"},
                {name:"Wall of Stone",level:5,type:"Utility",school:"Evocation",range:"120ft",dmg:"-",desc:"Create a nonmagical wall of stone. Can be permanent if concentration maintained for full duration",castTime:"1 Action"}
            ]}
        ],
        "Circle of the Land (Underdark)": [
            {minLevel:3, spells:[
                {name:"Spider Climb",level:2,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"Creature can climb on ceilings, walls, and difficult surfaces without checks (concentration, 1 hr)",castTime:"1 Action"},
                {name:"Web",level:2,type:"Save",school:"Conjuration",range:"60ft",dmg:"-",desc:"DEX save or restrained in 20ft-cube of webs. Webs are difficult terrain and flammable (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Gaseous Form",level:3,type:"Utility",school:"Transmutation",range:"Touch",dmg:"-",desc:"Transform creature into misty cloud. Fly 10ft, resistance to nonmagical damage, can pass through small openings (concentration, 1 hr)",castTime:"1 Action"},
                {name:"Stinking Cloud",level:3,type:"Save",school:"Conjuration",range:"90ft",dmg:"-",desc:"20ft-radius sphere of nauseating gas. CON save or lose action (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Greater Invisibility",level:4,type:"Buff",school:"Illusion",range:"Touch",dmg:"-",desc:"Target is invisible for up to 1 minute (concentration), even while attacking or casting",castTime:"1 Action"},
                {name:"Stone Shape",level:4,type:"Utility",school:"Transmutation",range:"Touch",dmg:"-",desc:"Reshape stone into any shape — create a door, seal an opening, or form a weapon",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Cloudkill",level:5,type:"Save",school:"Conjuration",range:"120ft",dmg:"5d8",desc:"20ft-radius sphere of poisonous fog. CON save or poison damage. Moves 10ft/round (concentration, 10 min)",castTime:"1 Action",upcast:"+1d8 per slot level"},
                {name:"Insect Plague",level:5,type:"Save",school:"Conjuration",range:"300ft",dmg:"4d10",desc:"20ft-radius sphere of biting locusts. CON save or piercing damage (concentration, 10 min)",castTime:"1 Action"}
            ]}
        ],
        // WARLOCK PATRONS
        "The Archfey": [
            {minLevel:1, spells:[
                {name:"Faerie Fire",level:1,type:"Save",school:"Evocation",range:"60ft",dmg:"-",desc:"Objects and creatures in 20ft cube: DEX save or outlined in light — attacks against them have advantage (concentration, 1 min)",castTime:"1 Action"},
                {name:"Sleep",level:1,type:"Utility",school:"Enchantment",range:"90ft",dmg:"5d8",desc:"Roll HP pool, creatures up to total fall unconscious (1 min or until woken)",castTime:"1 Action",upcast:"+2d8 HP per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Calm Emotions",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"CHA save or creatures are suppressed of charm/fright, or become indifferent (concentration, 1 min)",castTime:"1 Action"},
                {name:"Phantasmal Force",level:2,type:"Save",school:"Illusion",range:"60ft",dmg:"1d6",desc:"INT save or target believes in an illusion you create. Takes 1d6 psychic if it interacts with it (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Blink",level:3,type:"Utility",school:"Transmutation",range:"Self",dmg:"-",desc:"At end of each turn, roll d20 — on 11+, vanish to Ethereal Plane until start of next turn (1 min)",castTime:"1 Action"},
                {name:"Plant Growth",level:3,type:"Utility",school:"Transmutation",range:"150ft",dmg:"-",desc:"Overgrow plants in 100ft radius (4x difficult terrain) instantly",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Dominate Beast",level:4,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or beast is charmed and obeys your commands (concentration, 1 min)",castTime:"1 Action"},
                {name:"Greater Invisibility",level:4,type:"Buff",school:"Illusion",range:"Touch",dmg:"-",desc:"Target is invisible for up to 1 minute (concentration), even while attacking or casting",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Dominate Person",level:5,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or charmed. You have telepathic link — issue commands as a bonus action (concentration, 1 min)",castTime:"1 Action"},
                {name:"Seeming",level:5,type:"Save",school:"Illusion",range:"30ft",dmg:"-",desc:"Up to any number of creatures appear as different people. CHA save for disbelievers (8 hrs)",castTime:"1 Action"}
            ]}
        ],
        "The Fiend": [
            {minLevel:1, spells:[
                {name:"Burning Hands",level:1,type:"Save",school:"Evocation",range:"Self (15ft cone)",dmg:"3d6",desc:"DEX save or fire damage in 15ft cone",castTime:"1 Action",upcast:"+1d6 per slot level"},
                {name:"Command",level:1,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or follow one-word command: Approach, Drop, Flee, Grovel, or Halt",castTime:"1 Action",upcast:"+1 target per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Blindness/Deafness",level:2,type:"Save",school:"Necromancy",range:"30ft",dmg:"-",desc:"CON save or blinded or deafened for 1 minute. Repeats each turn",castTime:"1 Action",upcast:"+1 target per slot level"},
                {name:"Scorching Ray",level:2,type:"Atk",school:"Evocation",range:"120ft",dmg:"6d6",desc:"Three rays of fire, each requires a ranged spell attack, each deals 2d6 fire",castTime:"1 Action",upcast:"+1 ray per slot level"}
            ]},
            {minLevel:5, spells:[
                {name:"Fireball",level:3,type:"Save",school:"Evocation",range:"150ft",dmg:"8d6",desc:"DEX save or fire damage in 20ft-radius sphere",castTime:"1 Action",upcast:"+1d6 per slot level"},
                {name:"Stinking Cloud",level:3,type:"Save",school:"Conjuration",range:"90ft",dmg:"-",desc:"20ft-radius sphere of nauseating gas. CON save or lose action (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Fire Shield",level:4,type:"Buff",school:"Evocation",range:"Self",dmg:"2d8",desc:"Warm shield: fire damage to attackers, resistance to cold. Or cold shield: cold damage to attackers, resistance to fire (10 min)",castTime:"1 Action"},
                {name:"Wall of Fire",level:4,type:"Save",school:"Evocation",range:"120ft",dmg:"5d8",desc:"Create a wall of flames. Creatures passing through take fire damage",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:9, spells:[
                {name:"Flame Strike",level:5,type:"Save",school:"Evocation",range:"60ft",dmg:"4d6+4d6",desc:"Column of divine fire: DEX save or 4d6 fire and 4d6 radiant in a 10ft-radius, 40ft-tall cylinder",castTime:"1 Action"},
                {name:"Hallow",level:5,type:"Utility",school:"Evocation",range:"Touch",dmg:"-",desc:"Designate a 60ft-radius area as hallowed ground. Prevent planar travel, choose an effect (celestial or fiend effects) (permanent, 1,000gp herbs)",castTime:"24 Hours"}
            ]}
        ],
        "The Great Old One": [
            {minLevel:1, spells:[
                {name:"Dissonant Whispers",level:1,type:"Save",school:"Enchantment",range:"60ft",dmg:"3d6",desc:"WIS save or psychic damage and flee. Half on success. Opportunity attacks triggered even on success",castTime:"1 Action",upcast:"+1d6 per slot level"},
                {name:"Tasha's Hideous Laughter",level:1,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"WIS save or incapacitated with laughter for up to 1 min (concentration). Intelligence 4 or lower are immune",castTime:"1 Action"}
            ]},
            {minLevel:3, spells:[
                {name:"Detect Thoughts",level:2,type:"Save",school:"Divination",range:"Self",dmg:"-",desc:"Read surface thoughts of creatures. Or probe deeply (WIS save, concentration, 1 min)",castTime:"1 Action"},
                {name:"Phantasmal Force",level:2,type:"Save",school:"Illusion",range:"60ft",dmg:"1d6",desc:"INT save or target believes in an illusion. Takes 1d6 psychic if it interacts with it (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Clairvoyance",level:3,type:"Utility",school:"Divination",range:"1 mile",dmg:"-",desc:"Create invisible sensor at known location, see/hear through it (concentration, 10 min)",castTime:"10 Minutes"},
                {name:"Sending",level:3,type:"Utility",school:"Evocation",range:"Unlimited",dmg:"-",desc:"Send a 25-word message to any known creature on the same plane. They can reply with 25 words",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Dominate Beast",level:4,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or beast is charmed and obeys your commands (concentration, 1 min)",castTime:"1 Action"},
                {name:"Evard's Black Tentacles",level:4,type:"Save",school:"Conjuration",range:"90ft",dmg:"3d6",desc:"20ft-square covered in writhing tentacles. DEX save or restrained and take 3d6 bludgeoning/turn (concentration, 1 min)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Dominate Person",level:5,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or charmed. Issue commands as a bonus action (concentration, 1 min)",castTime:"1 Action"},
                {name:"Telepathy",level:8,type:"Utility",school:"Evocation",range:"Unlimited",dmg:"-",desc:"Establish a telepathic link with a willing creature anywhere on the same plane (24 hrs)",castTime:"1 Action"}
            ]}
        ],
        "The Celestial": [
            {minLevel:1, spells:[
                {name:"Cure Wounds",level:1,type:"Heal",school:"Evocation",range:"Touch",dmg:"1d8+Mod",desc:"Touch a creature to restore hit points",castTime:"1 Action",upcast:"+1d8 per slot level"},
                {name:"Guiding Bolt",level:1,type:"Atk",school:"Evocation",range:"120ft",dmg:"4d6",desc:"Radiant damage, next attack against target this turn has advantage",castTime:"1 Action",upcast:"+1d6 per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Flaming Sphere",level:2,type:"Save",school:"Conjuration",range:"60ft",dmg:"2d6",desc:"5ft-diameter sphere of fire. Bonus action to move 30ft. Creatures within 5ft: DEX save or fire damage (concentration, 1 min)",castTime:"1 Action"},
                {name:"Lesser Restoration",level:2,type:"Utility",school:"Abjuration",range:"Touch",dmg:"-",desc:"End one disease, poison, paralysis, or blindness",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Daylight",level:3,type:"Utility",school:"Evocation",range:"60ft",dmg:"-",desc:"60ft-radius bright light. Dispels darkness spells up to 3rd level (1 hr)",castTime:"1 Action"},
                {name:"Revivify",level:3,type:"Heal",school:"Necromancy",range:"Touch",dmg:"-",desc:"Return a creature to life who died within the last minute",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Guardian of Faith",level:4,type:"Utility",school:"Conjuration",range:"30ft",dmg:"20",desc:"Summon spectral guardian. Hostile creatures within 10ft: DEX save or 20 radiant damage (8 hrs or 60 total)",castTime:"1 Action"},
                {name:"Wall of Fire",level:4,type:"Save",school:"Evocation",range:"120ft",dmg:"5d8",desc:"Create a wall of flames. Creatures passing through take fire damage",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Flame Strike",level:5,type:"Save",school:"Evocation",range:"60ft",dmg:"4d6+4d6",desc:"Column of divine fire: DEX save or 4d6 fire and 4d6 radiant in a 10ft-radius, 40ft-tall cylinder",castTime:"1 Action"},
                {name:"Mass Cure Wounds",level:5,type:"Heal",school:"Evocation",range:"60ft",dmg:"3d8+Mod",desc:"Heal up to 6 creatures within 30ft of a chosen point",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]}
        ],
        "The Hexblade": [
            {minLevel:1, spells:[
                {name:"Shield",level:1,type:"Buff",school:"Abjuration",range:"Self",dmg:"-",desc:"Reaction: +5 AC until start of your next turn. Immune to Magic Missile",castTime:"Reaction"},
                {name:"Hex",level:1,type:"Buff",school:"Enchantment",range:"90ft",dmg:"1d6",desc:"+1d6 necrotic per hit, target has disadvantage on chosen ability checks (concentration, 1 hr)",castTime:"Bonus Action"}
            ]},
            {minLevel:3, spells:[
                {name:"Blur",level:2,type:"Buff",school:"Illusion",range:"Self",dmg:"-",desc:"Attackers have disadvantage on attack rolls against you (concentration, 1 min)",castTime:"1 Action"},
                {name:"Branding Smite",level:2,type:"Buff",school:"Evocation",range:"Self",dmg:"2d6",desc:"Next weapon hit: 2d6 radiant and target glows (can't be invisible, see it in darkness) (concentration, 1 min)",castTime:"Bonus Action",upcast:"+1d6 per slot level"}
            ]},
            {minLevel:5, spells:[
                {name:"Blink",level:3,type:"Utility",school:"Transmutation",range:"Self",dmg:"-",desc:"At end of each turn, roll d20 — on 11+, vanish to Ethereal Plane until start of next turn (1 min)",castTime:"1 Action"},
                {name:"Elemental Weapon",level:3,type:"Buff",school:"Transmutation",range:"Touch",dmg:"1d4",desc:"A nonmagical weapon becomes +1 and deals +1d4 acid/cold/fire/lightning/thunder (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Phantasmal Killer",level:4,type:"Save",school:"Illusion",range:"120ft",dmg:"4d10",desc:"WIS save or frightened of an illusory threat. Takes 4d10 psychic at end of each turn until it succeeds (concentration, 1 min)",castTime:"1 Action",upcast:"+1d10 per slot level"},
                {name:"Staggering Smite",level:4,type:"Buff",school:"Evocation",range:"Self",dmg:"4d6",desc:"Next weapon hit: 4d6 psychic and WIS save or stunned until end of your next turn",castTime:"Bonus Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Banishing Smite",level:5,type:"Buff",school:"Abjuration",range:"Self",dmg:"5d10",desc:"Next weapon hit: 5d10 force and if target has 50 HP or fewer it is banished to a harmless demiplane (concentration, 1 min)",castTime:"Bonus Action"},
                {name:"Cone of Cold",level:5,type:"Save",school:"Evocation",range:"Self (60ft cone)",dmg:"8d8",desc:"CON save or cold damage in 60ft cone",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]}
        ],
        "The Fathomless": [
            {minLevel:1, spells:[
                {name:"Create/Destroy Water",level:1,type:"Utility",school:"Transmutation",range:"30ft",dmg:"-",desc:"Create 10 gallons of water in an open container, or destroy 10 gallons of water in a 30ft cube",castTime:"1 Action",upcast:"+10 gallons per slot level"},
                {name:"Thunderwave",level:1,type:"Save",school:"Evocation",range:"Self (15ft cube)",dmg:"2d8",desc:"CON save or thunder damage and pushed 10ft",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Gust of Wind",level:2,type:"Save",school:"Evocation",range:"Self (60ft line)",dmg:"-",desc:"60ft line of strong wind. STR save or pushed 15ft (concentration, 1 min)",castTime:"1 Action"},
                {name:"Silence",level:2,type:"Utility",school:"Illusion",range:"120ft",dmg:"-",desc:"No sound in 20ft-radius sphere. Sound-based spells can't function inside (concentration, 10 min, ritual)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Lightning Bolt",level:3,type:"Save",school:"Evocation",range:"Self (100ft line)",dmg:"8d6",desc:"5ft-wide line, DEX save or lightning damage",castTime:"1 Action",upcast:"+1d6 per slot level"},
                {name:"Sleet Storm",level:3,type:"Save",school:"Conjuration",range:"150ft",dmg:"-",desc:"40ft-radius of freezing rain. DEX save or fall prone. Concentration checks for spellcasters",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Control Water",level:4,type:"Utility",school:"Transmutation",range:"300ft",dmg:"-",desc:"Flood, part, redirect, or whirlpool a body of water (concentration, 10 min)",castTime:"1 Action"},
                {name:"Summon Elemental",level:4,type:"Utility",school:"Conjuration",range:"90ft",dmg:"-",desc:"Summon a water, air, fire, or earth elemental spirit (concentration, 1 hr)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Bigby's Hand",level:5,type:"Atk",school:"Evocation",range:"120ft",dmg:"4d8",desc:"Summon Large spectral hand. Actions: Clenched Fist (4d8), Forceful Hand (push), Grasping Hand (restrain), Interposing Hand (cover) (concentration, 1 min)",castTime:"1 Action",upcast:"+1d8 per slot level"},
                {name:"Cone of Cold",level:5,type:"Save",school:"Evocation",range:"Self (60ft cone)",dmg:"8d8",desc:"CON save or cold damage in 60ft cone",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]}
        ],
        "The Genie": [
            {minLevel:1, spells:[
                {name:"Detect Evil and Good",level:1,type:"Utility",school:"Divination",range:"Self",dmg:"-",desc:"Know if there is an aberration, celestial, elemental, fey, fiend, or undead within 30ft (concentration, 10 min)",castTime:"1 Action"},
                {name:"Thunderwave",level:1,type:"Save",school:"Evocation",range:"Self (15ft cube)",dmg:"2d8",desc:"CON save or thunder damage and pushed 10ft",castTime:"1 Action",upcast:"+1d8 per slot level"}
            ]},
            {minLevel:3, spells:[
                {name:"Phantasmal Force",level:2,type:"Save",school:"Illusion",range:"60ft",dmg:"1d6",desc:"INT save or target believes in an illusion. Takes 1d6 psychic if it interacts with it (concentration, 1 min)",castTime:"1 Action"},
                {name:"Spike Growth",level:2,type:"Utility",school:"Transmutation",range:"150ft",dmg:"2d4",desc:"Difficult terrain of spikes in 20ft radius. Moving through deals 2d4 piercing per 5ft (concentration, 10 min)",castTime:"1 Action"}
            ]},
            {minLevel:5, spells:[
                {name:"Gaseous Form",level:3,type:"Utility",school:"Transmutation",range:"Touch",dmg:"-",desc:"Transform into misty cloud. Fly 10ft, resistance to nonmagical damage, can pass through small openings (concentration, 1 hr)",castTime:"1 Action"},
                {name:"Fly",level:3,type:"Buff",school:"Transmutation",range:"Touch",dmg:"-",desc:"Target gains flying speed of 60ft (concentration, 10 min)",castTime:"1 Action",upcast:"+1 target per slot level"}
            ]},
            {minLevel:7, spells:[
                {name:"Phantasmal Killer",level:4,type:"Save",school:"Illusion",range:"120ft",dmg:"4d10",desc:"WIS save or frightened of an illusory threat. Takes 4d10 psychic at end of each turn until it succeeds (concentration, 1 min)",castTime:"1 Action"},
                {name:"Secret Chest",level:4,type:"Utility",school:"Conjuration",range:"Touch",dmg:"-",desc:"Hide a chest on the Ethereal Plane. Recall it with a miniature copy (60 days, 5,000gp ivory chest)",castTime:"1 Action"}
            ]},
            {minLevel:9, spells:[
                {name:"Creation",level:5,type:"Utility",school:"Illusion",range:"30ft",dmg:"-",desc:"Create a nonliving object from shadowstuff. Duration based on material",castTime:"1 Minute"},
                {name:"Bigby's Hand",level:5,type:"Atk",school:"Evocation",range:"120ft",dmg:"4d8",desc:"Summon Large spectral hand with multiple powerful options (concentration, 1 min)",castTime:"1 Action"}
            ]}
        ],
        // THIRD-CASTER SUBCLASSES
        "Eldritch Knight": [
            {minLevel:3, spells:[
                {name:"Shield",level:1,type:"Buff",school:"Abjuration",range:"Self",dmg:"-",desc:"Reaction: +5 AC until start of your next turn. Immune to Magic Missile",castTime:"Reaction"},
                {name:"Absorb Elements",level:1,type:"Buff",school:"Abjuration",range:"Self",dmg:"1d6",desc:"Reaction when you take acid/cold/fire/lightning/thunder: halve damage, store it. Next melee attack: +1d6 of that type",castTime:"Reaction",upcast:"+1d6 per slot level"}
            ]},
            {minLevel:7, spells:[
                {name:"Misty Step",level:2,type:"Utility",school:"Conjuration",range:"Self",dmg:"-",desc:"Teleport up to 30ft to an unoccupied space you can see",castTime:"Bonus Action"},
                {name:"Mirror Image",level:2,type:"Buff",school:"Illusion",range:"Self",dmg:"-",desc:"Create 3 illusory duplicates. Attackers may hit a duplicate instead (1 min)",castTime:"1 Action"}
            ]},
            {minLevel:13, spells:[
                {name:"Counterspell",level:3,type:"Reaction",school:"Abjuration",range:"60ft",dmg:"-",desc:"Interrupt a spell of 3rd level or lower automatically. Higher-level spells require ability check",castTime:"Reaction"},
                {name:"Fireball",level:3,type:"Save",school:"Evocation",range:"150ft",dmg:"8d6",desc:"DEX save or fire damage in 20ft-radius sphere",castTime:"1 Action",upcast:"+1d6 per slot level"}
            ]},
            {minLevel:19, spells:[
                {name:"Banishment",level:4,type:"Save",school:"Abjuration",range:"60ft",dmg:"-",desc:"CHA save or banished to a harmless demiplane (concentration, 1 min)",castTime:"1 Action"},
                {name:"Wall of Fire",level:4,type:"Save",school:"Evocation",range:"120ft",dmg:"5d8",desc:"Create a wall of flames. Creatures passing through take fire damage",castTime:"1 Action"}
            ]}
        ],
        "Arcane Trickster": [
            {minLevel:3, spells:[
                {name:"Mage Hand",level:0,type:"Utility",school:"Conjuration",range:"30ft",dmg:"-",desc:"Create spectral hand to manipulate objects, pick locks, or disarm traps at range",castTime:"1 Action"},
                {name:"Minor Illusion",level:0,type:"Utility",school:"Illusion",range:"30ft",dmg:"-",desc:"Create sound or image illusion (1 min). Interaction reveals it's an illusion",castTime:"1 Action"}
            ]},
            {minLevel:7, spells:[
                {name:"Charm Person",level:1,type:"Save",school:"Enchantment",range:"30ft",dmg:"-",desc:"WIS save or charmed for 1 hour. Charmed creature treats you as friendly",castTime:"1 Action"},
                {name:"Silent Image",level:1,type:"Utility",school:"Illusion",range:"60ft",dmg:"-",desc:"Create a visual illusion up to 15ft cube. Can be moved 20ft/round (concentration, 10 min)",castTime:"1 Action"}
            ]},
            {minLevel:13, spells:[
                {name:"Mirror Image",level:2,type:"Buff",school:"Illusion",range:"Self",dmg:"-",desc:"Create 3 illusory duplicates. Attackers may hit a duplicate instead (1 min)",castTime:"1 Action"},
                {name:"Hold Person",level:2,type:"Save",school:"Enchantment",range:"60ft",dmg:"-",desc:"WIS save or paralyzed for up to 1 minute (concentration)",castTime:"1 Action"}
            ]},
            {minLevel:19, spells:[
                {name:"Fear",level:3,type:"Save",school:"Illusion",range:"Self (30ft cone)",dmg:"-",desc:"WIS save or frightened and must flee (concentration, 1 min)",castTime:"1 Action"},
                {name:"Hypnotic Pattern",level:3,type:"Save",school:"Illusion",range:"120ft",dmg:"-",desc:"WIS save or incapacitated and charmed by swirling colors (concentration, 1 min)",castTime:"1 Action"}
            ]}
        ]
    },
    spells: {
        cantrip: [
            {name: "Fire Bolt", type: "Atk", range: "120ft", dmg: "1d10", desc: "Ranged spell attack dealing fire damage", level: 0, school: "Evocation", castTime: "1 Action"},
            {name: "Ray of Frost", type: "Atk", range: "60ft", dmg: "1d8", desc: "Cold damage and reduces target speed by 10ft", level: 0, school: "Evocation", castTime: "1 Action"},
            {name: "Poison Spray", type: "Save", range: "10ft", dmg: "1d12", desc: "CON save or poison damage", level: 0, school: "Conjuration", castTime: "1 Action"},
            {name: "Eldritch Blast", type: "Atk", range: "120ft", dmg: "1d10", desc: "Beam of crackling force energy", level: 0, school: "Evocation", castTime: "1 Action"},
            {name: "Mage Hand", type: "Utility", range: "30ft", dmg: "-", desc: "Create spectral hand to manipulate objects", level: 0, school: "Conjuration", castTime: "1 Action"},
            {name: "Minor Illusion", type: "Utility", range: "30ft", dmg: "-", desc: "Create sound or image illusion", level: 0, school: "Illusion", castTime: "1 Action"},
            {name: "Prestidigitation", type: "Utility", range: "10ft", dmg: "-", desc: "Perform minor magical tricks", level: 0, school: "Transmutation", castTime: "1 Action"},
            {name: "Sacred Flame", type: "Save", range: "60ft", dmg: "1d8", desc: "DEX save or radiant damage", level: 0, school: "Evocation", castTime: "1 Action"},
            {name: "Vicious Mockery", type: "Save", range: "60ft", dmg: "1d4", desc: "WIS save or psychic damage and disadvantage on next attack", level: 0, school: "Enchantment", castTime: "1 Action"},
            {name: "Chill Touch", type: "Atk", range: "120ft", dmg: "1d8", desc: "Necrotic damage, target can't regain HP until your next turn", level: 0, school: "Necromancy", castTime: "1 Action"},
            {name: "Shocking Grasp", type: "Atk", range: "Touch", dmg: "1d8", desc: "Lightning damage, target can't take reactions", level: 0, school: "Evocation", castTime: "1 Action"}
        ],
        1: [
            {name: "Magic Missile", type: "Dmg", range: "120ft", dmg: "3d4+3", desc: "Three darts of magical force that automatically hit", level: 1, school: "Evocation", castTime: "1 Action", upcast: "+1 dart (1d4+1) per slot level"},
            {name: "Cure Wounds", type: "Heal", range: "Touch", dmg: "1d8+Mod", desc: "Touch creature to restore hit points", level: 1, school: "Evocation", castTime: "1 Action", upcast: "+1d8 per slot level"},
            {name: "Guiding Bolt", type: "Atk", range: "120ft", dmg: "4d6", desc: "Radiant damage, next attack against target has advantage", level: 1, school: "Evocation", castTime: "1 Action", upcast: "+1d6 per slot level"},
            {name: "Shield", type: "Buff", range: "Self", dmg: "-", desc: "Reaction: +5 AC until start of your next turn", level: 1, school: "Abjuration", castTime: "Reaction"},
            {name: "Burning Hands", type: "Save", range: "Self (15ft cone)", dmg: "3d6", desc: "DEX save or fire damage in cone", level: 1, school: "Evocation", castTime: "1 Action", upcast: "+1d6 per slot level"},
            {name: "Charm Person", type: "Save", range: "30ft", dmg: "-", desc: "WIS save or charmed for 1 hour", level: 1, school: "Enchantment", castTime: "1 Action", upcast: "+1 target per slot level"},
            {name: "Sleep", type: "Utility", range: "90ft", dmg: "5d8", desc: "Roll HP, creatures in area fall unconscious", level: 1, school: "Enchantment", castTime: "1 Action", upcast: "+2d8 HP per slot level"},
            {name: "Thunderwave", type: "Save", range: "Self (15ft cube)", dmg: "2d8", desc: "CON save or thunder damage and pushed 10ft", level: 1, school: "Evocation", castTime: "1 Action", upcast: "+1d8 per slot level"},
            {name: "Hex", type: "Buff", range: "90ft", dmg: "1d6", desc: "Deal extra 1d6 necrotic, target has disadvantage on checks", level: 1, school: "Enchantment", castTime: "Bonus Action"},
            {name: "Bless", type: "Buff", range: "30ft", dmg: "-", desc: "Three creatures add d4 to attack rolls and saves", level: 1, school: "Enchantment", castTime: "1 Action", upcast: "+1 target per slot level"},
            {name: "Detect Magic", type: "Utility", range: "Self", dmg: "-", desc: "Sense magic within 30ft for 10 minutes", level: 1, school: "Divination", castTime: "1 Action"},
            {name: "Mage Armor", type: "Buff", range: "Touch", dmg: "-", desc: "AC becomes 13 + DEX mod for 8 hours", level: 1, school: "Abjuration", castTime: "1 Action"}
        ],
        2: [
            {name: "Scorching Ray", type: "Atk", range: "120ft", dmg: "6d6", desc: "Create three rays of fire, each deals 2d6", level: 2, school: "Evocation", castTime: "1 Action", upcast: "+1 ray per slot level"},
            {name: "Shatter", type: "Save", range: "60ft", dmg: "3d8", desc: "CON save or thunder damage in 10ft sphere", level: 2, school: "Evocation", castTime: "1 Action", upcast: "+1d8 per slot level"},
            {name: "Hold Person", type: "Save", range: "60ft", dmg: "-", desc: "WIS save or paralyzed for up to 1 minute", level: 2, school: "Enchantment", castTime: "1 Action", upcast: "+1 target per slot level"},
            {name: "Misty Step", type: "Utility", range: "Self", dmg: "-", desc: "Bonus action: teleport up to 30 feet", level: 2, school: "Conjuration", castTime: "Bonus Action"},
            {name: "Spiritual Weapon", type: "Atk", range: "60ft", dmg: "1d8+Mod", desc: "Create floating weapon, bonus action to attack", level: 2, school: "Evocation", castTime: "Bonus Action", upcast: "+1d8 per 2 slot levels"},
            {name: "Mirror Image", type: "Buff", range: "Self", dmg: "-", desc: "Create three illusory duplicates", level: 2, school: "Illusion", castTime: "1 Action"},
            {name: "Web", type: "Save", range: "60ft", dmg: "-", desc: "DEX save or restrained in sticky webbing", level: 2, school: "Conjuration", castTime: "1 Action"},
            {name: "Invisibility", type: "Buff", range: "Touch", dmg: "-", desc: "Creature becomes invisible for up to 1 hour", level: 2, school: "Illusion", castTime: "1 Action", upcast: "+1 target per slot level"}
        ],
        3: [
            {name: "Fireball", type: "Save", range: "150ft", dmg: "8d6", desc: "20ft radius sphere, DEX save or fire damage", level: 3, school: "Evocation", castTime: "1 Action", upcast: "+1d6 per slot level"},
            {name: "Haste", type: "Buff", range: "30ft", dmg: "-", desc: "+2 AC, double speed, extra action", level: 3, school: "Transmutation", castTime: "1 Action"},
            {name: "Revivify", type: "Heal", range: "Touch", dmg: "-", desc: "Return creature to life who died within 1 minute", level: 3, school: "Necromancy", castTime: "1 Action"},
            {name: "Lightning Bolt", type: "Save", range: "Self (100ft line)", dmg: "8d6", desc: "5ft wide line, DEX save or lightning damage", level: 3, school: "Evocation", castTime: "1 Action", upcast: "+1d6 per slot level"},
            {name: "Counterspell", type: "Reaction", range: "60ft", dmg: "-", desc: "Interrupt spell of 3rd level or lower", level: 3, school: "Abjuration", castTime: "Reaction"},
            {name: "Dispel Magic", type: "Utility", range: "120ft", dmg: "-", desc: "End spells of 3rd level or lower on target", level: 3, school: "Abjuration", castTime: "1 Action"},
            {name: "Fly", type: "Buff", range: "Touch", dmg: "-", desc: "Target gains flying speed of 60ft", level: 3, school: "Transmutation", castTime: "1 Action", upcast: "+1 target per slot level"},
            {name: "Fear", type: "Save", range: "Self (30ft cone)", dmg: "-", desc: "WIS save or frightened and must flee", level: 3, school: "Illusion", castTime: "1 Action"}
        ],
        4: [
            {name: "Blight", type: "Save", range: "30ft", dmg: "8d8", desc: "CON save or necrotic damage, plants take max", level: 4, school: "Necromancy", castTime: "1 Action", upcast: "+1d8 per slot level"},
            {name: "Polymorph", type: "Utility", range: "60ft", dmg: "-", desc: "Transform creature into a beast with CR equal to or less than your level", level: 4, school: "Transmutation", castTime: "1 Action"},
            {name: "Wall of Fire", type: "Save", range: "120ft", dmg: "5d8", desc: "Create wall of flames, 5d8 fire on passing through", level: 4, school: "Evocation", castTime: "1 Action", upcast: "+1d8 per slot level"},
            {name: "Banishment", type: "Save", range: "60ft", dmg: "-", desc: "CHA save or banished to harmless demiplane", level: 4, school: "Abjuration", castTime: "1 Action", upcast: "+1 target per slot level"},
            {name: "Dimension Door", type: "Utility", range: "500ft", dmg: "-", desc: "Teleport yourself and one willing creature", level: 4, school: "Conjuration", castTime: "1 Action"},
            {name: "Greater Invisibility", type: "Buff", range: "Touch", dmg: "-", desc: "Invisible for 1 minute, even when attacking", level: 4, school: "Illusion", castTime: "1 Action"}
        ],
        5: [
            {name: "Cone of Cold", type: "Save", range: "Self (60ft cone)", dmg: "8d8", desc: "CON save or cold damage in cone", level: 5, school: "Evocation", castTime: "1 Action", upcast: "+1d8 per slot level"},
            {name: "Hold Monster", type: "Save", range: "90ft", dmg: "-", desc: "WIS save or paralyzed, works on any creature", level: 5, school: "Enchantment", castTime: "1 Action", upcast: "+1 target per slot level"},
            {name: "Cloudkill", type: "Save", range: "120ft", dmg: "5d8", desc: "20ft sphere of poison gas, moves away", level: 5, school: "Conjuration", castTime: "1 Action", upcast: "+1d8 per slot level"},
            {name: "Dominate Person", type: "Save", range: "60ft", dmg: "-", desc: "WIS save or charmed and obey commands", level: 5, school: "Enchantment", castTime: "1 Action"},
            {name: "Teleportation Circle", type: "Utility", range: "10ft", dmg: "-", desc: "Create portal to permanent teleportation circle", level: 5, school: "Conjuration", castTime: "1 Minute"},
            {name: "Wall of Force", type: "Utility", range: "120ft", dmg: "-", desc: "Create invisible, impenetrable barrier", level: 5, school: "Evocation", castTime: "1 Action"}
        ],
        6: [
            {name: "Chain Lightning", type: "Save", range: "150ft", dmg: "10d8", desc: "Primary target, then 3 secondary targets, DEX save", level: 6, school: "Evocation", castTime: "1 Action", upcast: "+1 target per slot level"},
            {name: "Disintegrate", type: "Save", range: "60ft", dmg: "10d6+40", desc: "DEX save or force damage, reduced to 0 = dust", level: 6, school: "Transmutation", castTime: "1 Action", upcast: "+3d6 per slot level"},
            {name: "Heal", type: "Heal", range: "60ft", dmg: "70", desc: "Restore 70 HP and cure blindness/deafness/disease", level: 6, school: "Evocation", castTime: "1 Action", upcast: "+10 HP per slot level"}
        ],
        7: [
            {name: "Finger of Death", type: "Save", range: "60ft", dmg: "7d8+30", desc: "CON save or necrotic damage, killed = zombie", level: 7, school: "Necromancy", castTime: "1 Action"},
            {name: "Plane Shift", type: "Save", range: "Touch", dmg: "-", desc: "Transport to another plane of existence", level: 7, school: "Conjuration", castTime: "1 Action"},
            {name: "Delayed Blast Fireball", type: "Save", range: "150ft", dmg: "12d6", desc: "Bead explodes after delay, 12d6 + 1d6/round", level: 7, school: "Evocation", castTime: "1 Action"}
        ],
        8: [
            {name: "Sunburst", type: "Save", range: "150ft", dmg: "12d6", desc: "60ft radius, CON save or radiant + blind", level: 8, school: "Evocation", castTime: "1 Action", upcast: "+1d6 per slot level"},
            {name: "Earthquake", type: "Save", range: "500ft", dmg: "-", desc: "100ft radius tremor, structures collapse", level: 8, school: "Evocation", castTime: "1 Action"},
            {name: "Mind Blank", type: "Buff", range: "Touch", dmg: "-", desc: "Immune to psychic, divination, charmed", level: 8, school: "Abjuration", castTime: "1 Action"}
        ],
        9: [
            {name: "Meteor Swarm", type: "Save", range: "1 mile", dmg: "40d6", desc: "Four 40ft spheres, DEX save or fire+bludgeon", level: 9, school: "Evocation", castTime: "1 Action"},
            {name: "Power Word Kill", type: "Instant", range: "60ft", dmg: "-", desc: "Instantly kill creature with 100 HP or fewer", level: 9, school: "Enchantment", castTime: "1 Action"},
            {name: "Wish", type: "Utility", range: "Self", dmg: "-", desc: "Ultimate power: duplicate any spell, alter reality", level: 9, school: "Conjuration", castTime: "1 Action"}
        ]
    },

    magicItems: {
        common: [
            {name: "Potion of Healing", type: "Consumable", desc: "Restore 2d4+2 HP", dropChance: 0.6, cost: "50 gp"},
            {name: "Potion of Climbing", type: "Consumable", desc: "Climb speed equal to walking speed for 1 hour", dropChance: 0.3, cost: "75 gp"},
            {name: "Spell Scroll (Cantrip)", type: "Scroll", desc: "Single use of a random cantrip", dropChance: 0.4, cost: "25 gp"},
            {name: "Alchemist's Fire", type: "Consumable", desc: "1d4 fire damage per round for 1 minute", dropChance: 0.3, cost: "50 gp"},
            {name: "Antitoxin", type: "Consumable", desc: "Advantage on saves vs poison for 1 hour", dropChance: 0.3, cost: "50 gp"}
        ],
        uncommon: [
            {name: "Potion of Greater Healing", type: "Consumable", desc: "Restore 4d4+4 HP", dropChance: 0.3, cost: "150 gp"},
            {name: "Bag of Holding", type: "Wondrous", desc: "Holds 500 lbs in extradimensional space", dropChance: 0.15, cost: "500 gp"},
            {name: "Cloak of Protection", type: "Armor", desc: "+1 to AC and all saving throws", dropChance: 0.12, cost: "1,000 gp"},
            {name: "Wand of Magic Missiles", type: "Wand", desc: "7 charges, cast Magic Missile at will", dropChance: 0.12, cost: "800 gp"},
            {name: "Boots of Elvenkind", type: "Armor", desc: "Advantage on Stealth checks", dropChance: 0.15, cost: "600 gp"},
            {name: "Gauntlets of Ogre Power", type: "Armor", desc: "Strength score becomes 19", dropChance: 0.08, cost: "1,200 gp"},
            {name: "Pearl of Power", type: "Wondrous", desc: "Regain one expended spell slot up to 3rd level", dropChance: 0.1, cost: "1,000 gp"}
        ],
        rare: [
            {name: "Potion of Superior Healing", type: "Consumable", desc: "Restore 8d4+8 HP", dropChance: 0.2, cost: "500 gp"},
            {name: "Flame Tongue", type: "Weapon", desc: "+2d6 fire damage when activated", dropChance: 0.08, cost: "5,000 gp"},
            {name: "Amulet of Health", type: "Wondrous", desc: "Constitution score becomes 19", dropChance: 0.06, cost: "8,000 gp"},
            {name: "Ring of Protection", type: "Ring", desc: "+1 to AC and all saving throws", dropChance: 0.08, cost: "3,500 gp"},
            {name: "Wand of Fireballs", type: "Wand", desc: "7 charges, cast Fireball (5th level)", dropChance: 0.05, cost: "6,000 gp"},
            {name: "Cloak of the Bat", type: "Armor", desc: "Fly in dim light, advantage on Stealth", dropChance: 0.06, cost: "4,500 gp"},
            {name: "Rope of Entanglement", type: "Wondrous", desc: "Animated rope that restrains creatures", dropChance: 0.08, cost: "3,000 gp"}
        ],
        epic: [
            {name: "Potion of Supreme Healing", type: "Consumable", desc: "Restore 10d4+20 HP", dropChance: 0.12, cost: "2,000 gp"},
            {name: "Vorpal Sword", type: "Weapon", desc: "+3, decapitate on natural 20", dropChance: 0.03, cost: "50,000 gp"},
            {name: "Staff of Power", type: "Staff", desc: "+2 to spell attacks, AC, saves. Many spell charges", dropChance: 0.04, cost: "40,000 gp"},
            {name: "Robe of the Archmagi", type: "Armor", desc: "AC 15 + DEX, advantage on spell saves, +2 spell DC", dropChance: 0.03, cost: "35,000 gp"},
            {name: "Ring of Invisibility", type: "Ring", desc: "Turn invisible at will as an action", dropChance: 0.04, cost: "30,000 gp"},
            {name: "Belt of Storm Giant Strength", type: "Wondrous", desc: "Strength becomes 29", dropChance: 0.03, cost: "25,000 gp"}
        ],
        legendary: [
            {name: "Deck of Many Things", type: "Wondrous", desc: "Draw cards for random, powerful effects", dropChance: 0.02, cost: "100,000 gp"},
            {name: "Sword of Kas", type: "Weapon", desc: "+3, critical on 19-20, sentient and malevolent", dropChance: 0.02, cost: "80,000 gp"},
            {name: "Orb of Dragonkind", type: "Wondrous", desc: "Control dragons within 500ft, various powers", dropChance: 0.01, cost: "90,000 gp"},
            {name: "Talisman of Pure Good", type: "Wondrous", desc: "Destroy evil creatures, 7 charges", dropChance: 0.015, cost: "70,000 gp"},
            {name: "Holy Avenger", type: "Weapon", desc: "+3, +2d10 vs fiends/undead, magic resistance aura", dropChance: 0.02, cost: "75,000 gp"},
            {name: "Staff of the Magi", type: "Staff", desc: "+2, spell absorption, 50 charges, massive powers", dropChance: 0.015, cost: "95,000 gp"}
        ],
        mythic: [
            {name: "Luck Blade", type: "Weapon", desc: "+3 longsword, +1 to all saving throws, Luck (1/day reroll any die), 1-3 Wish charges", dropChance: 0.008, cost: "200,000 gp"},
            {name: "Ring of Three Wishes", type: "Ring", desc: "Cast Wish 3 times, then becomes non-magical ring", dropChance: 0.005, cost: "250,000 gp"},
            {name: "Armor of Invulnerability", type: "Armor", desc: "Plate +1, action for resistance to non-magical damage for 10 minutes", dropChance: 0.007, cost: "180,000 gp"},
            {name: "Cube of Force", type: "Wondrous", desc: "Create 15ft force cube with multiple barrier types, 36 charges", dropChance: 0.006, cost: "150,000 gp"},
            {name: "Sphere of Annihilation", type: "Wondrous", desc: "A 2-foot-diameter black sphere that destroys matter utterly", dropChance: 0.004, cost: "300,000 gp"},
            {name: "Talisman of the Sphere", type: "Wondrous", desc: "Control a Sphere of Annihilation with proficiency", dropChance: 0.003, cost: "100,000 gp"},
            {name: "Tome of the Stilled Tongue", type: "Book", desc: "+3 spellcasting focus, free Wish 1/day while attuned", dropChance: 0.004, cost: "250,000 gp"},
            {name: "Eye and Hand of Vecna", type: "Wondrous", desc: "Legendary artifacts of Vecna granting immense power at terrible cost", dropChance: 0.002, cost: "Priceless"},
            {name: "Hand of Vecna", type: "Wondrous", desc: "Replace your hand to gain STR 20, +2d8 cold damage on attacks, death ray 1/day", dropChance: 0.002, cost: "Priceless"},
            {name: "Eye of Vecna", type: "Wondrous", desc: "Replace your eye to gain truesight 120ft, Disintegrate 1/day, true seeing at will", dropChance: 0.002, cost: "Priceless"}
        ]
    },

    // Common gear, standard weapons, armor, and all equipment from PHB/DMG
    allWeapons: [
        // Simple Melee
        {name: "Club", type: "Weapon", rarity: "common", desc: "Simple melee weapon. Damage: 1d4 bludgeoning. Light, monk.", cost: "1 sp", dropChance: 1.0},
        {name: "Dagger", type: "Weapon", rarity: "common", desc: "Simple melee/ranged. Damage: 1d4 piercing. Finesse, light, thrown (20/60).", cost: "2 gp", dropChance: 0.9},
        {name: "Greatclub", type: "Weapon", rarity: "common", desc: "Simple melee. Damage: 1d8 bludgeoning. Two-handed.", cost: "2 sp", dropChance: 0.7},
        {name: "Handaxe", type: "Weapon", rarity: "common", desc: "Simple melee/ranged. Damage: 1d6 slashing. Light, thrown (20/60).", cost: "5 gp", dropChance: 0.8},
        {name: "Javelin", type: "Weapon", rarity: "common", desc: "Simple melee/ranged. Damage: 1d6 piercing. Thrown (30/120).", cost: "5 sp", dropChance: 0.7},
        {name: "Light Hammer", type: "Weapon", rarity: "common", desc: "Simple melee/ranged. Damage: 1d4 bludgeoning. Light, thrown (20/60).", cost: "2 gp", dropChance: 0.7},
        {name: "Mace", type: "Weapon", rarity: "common", desc: "Simple melee. Damage: 1d6 bludgeoning.", cost: "5 gp", dropChance: 0.8},
        {name: "Quarterstaff", type: "Weapon", rarity: "common", desc: "Simple melee. Damage: 1d6 bludgeoning. Versatile (1d8).", cost: "2 sp", dropChance: 0.9},
        {name: "Sickle", type: "Weapon", rarity: "common", desc: "Simple melee. Damage: 1d4 slashing. Light.", cost: "1 gp", dropChance: 0.6},
        {name: "Spear", type: "Weapon", rarity: "common", desc: "Simple melee/ranged. Damage: 1d6 piercing. Thrown (20/60), versatile (1d8).", cost: "1 gp", dropChance: 0.8},
        // Simple Ranged
        {name: "Light Crossbow", type: "Weapon", rarity: "common", desc: "Simple ranged. Damage: 1d8 piercing. Ammunition (80/320), loading, two-handed.", cost: "25 gp", dropChance: 0.7},
        {name: "Dart", type: "Weapon", rarity: "common", desc: "Simple ranged. Damage: 1d4 piercing. Finesse, thrown (20/60).", cost: "5 cp", dropChance: 0.6},
        {name: "Shortbow", type: "Weapon", rarity: "common", desc: "Simple ranged. Damage: 1d6 piercing. Ammunition (80/320), two-handed.", cost: "25 gp", dropChance: 0.7},
        {name: "Sling", type: "Weapon", rarity: "common", desc: "Simple ranged. Damage: 1d4 bludgeoning. Ammunition (30/120).", cost: "1 sp", dropChance: 0.6},
        // Martial Melee
        {name: "Battleaxe", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d8 slashing. Versatile (1d10).", cost: "10 gp", dropChance: 0.7},
        {name: "Flail", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d8 bludgeoning.", cost: "10 gp", dropChance: 0.6},
        {name: "Glaive", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d10 slashing. Heavy, reach, two-handed.", cost: "20 gp", dropChance: 0.5},
        {name: "Greataxe", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d12 slashing. Heavy, two-handed.", cost: "30 gp", dropChance: 0.6},
        {name: "Greatsword", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 2d6 slashing. Heavy, two-handed.", cost: "50 gp", dropChance: 0.6},
        {name: "Halberd", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d10 slashing. Heavy, reach, two-handed.", cost: "20 gp", dropChance: 0.5},
        {name: "Lance", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d12 piercing. Reach, special (mounted).", cost: "10 gp", dropChance: 0.4},
        {name: "Longsword", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d8 slashing. Versatile (1d10).", cost: "15 gp", dropChance: 0.8},
        {name: "Maul", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 2d6 bludgeoning. Heavy, two-handed.", cost: "10 gp", dropChance: 0.5},
        {name: "Morningstar", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d8 piercing.", cost: "15 gp", dropChance: 0.6},
        {name: "Pike", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d10 piercing. Heavy, reach, two-handed.", cost: "5 gp", dropChance: 0.5},
        {name: "Rapier", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d8 piercing. Finesse.", cost: "25 gp", dropChance: 0.7},
        {name: "Scimitar", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d6 slashing. Finesse, light.", cost: "25 gp", dropChance: 0.6},
        {name: "Shortsword", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d6 piercing. Finesse, light.", cost: "10 gp", dropChance: 0.7},
        {name: "Trident", type: "Weapon", rarity: "common", desc: "Martial melee/ranged. Damage: 1d6 piercing. Thrown (20/60), versatile (1d8).", cost: "5 gp", dropChance: 0.5},
        {name: "War Pick", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d8 piercing.", cost: "5 gp", dropChance: 0.6},
        {name: "Warhammer", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d8 bludgeoning. Versatile (1d10).", cost: "15 gp", dropChance: 0.6},
        {name: "Whip", type: "Weapon", rarity: "common", desc: "Martial melee. Damage: 1d4 slashing. Finesse, reach.", cost: "2 gp", dropChance: 0.4},
        // Martial Ranged
        {name: "Blowgun", type: "Weapon", rarity: "common", desc: "Martial ranged. Damage: 1 piercing. Ammunition (25/100), loading.", cost: "10 gp", dropChance: 0.4},
        {name: "Hand Crossbow", type: "Weapon", rarity: "common", desc: "Martial ranged. Damage: 1d6 piercing. Ammunition (30/120), light, loading.", cost: "75 gp", dropChance: 0.5},
        {name: "Heavy Crossbow", type: "Weapon", rarity: "common", desc: "Martial ranged. Damage: 1d10 piercing. Ammunition (100/400), heavy, loading, two-handed.", cost: "50 gp", dropChance: 0.5},
        {name: "Longbow", type: "Weapon", rarity: "common", desc: "Martial ranged. Damage: 1d8 piercing. Ammunition (150/600), heavy, two-handed.", cost: "50 gp", dropChance: 0.6},
        {name: "Net", type: "Weapon", rarity: "common", desc: "Martial ranged. Thrown (5/15). Large or smaller creature is restrained.", cost: "1 gp", dropChance: 0.4}
    ],
    
    allArmor: [
        // Light
        {name: "Padded Armor", type: "Armor", rarity: "common", desc: "Light armor. AC: 11 + DEX. Disadvantage on Stealth.", cost: "5 gp", dropChance: 0.6},
        {name: "Leather Armor", type: "Armor", rarity: "common", desc: "Light armor. AC: 11 + DEX.", cost: "10 gp", dropChance: 0.8},
        {name: "Studded Leather", type: "Armor", rarity: "common", desc: "Light armor. AC: 12 + DEX.", cost: "45 gp", dropChance: 0.7},
        // Medium
        {name: "Hide Armor", type: "Armor", rarity: "common", desc: "Medium armor. AC: 12 + DEX (max 2).", cost: "10 gp", dropChance: 0.6},
        {name: "Chain Shirt", type: "Armor", rarity: "common", desc: "Medium armor. AC: 13 + DEX (max 2).", cost: "50 gp", dropChance: 0.6},
        {name: "Scale Mail", type: "Armor", rarity: "common", desc: "Medium armor. AC: 14 + DEX (max 2). Disadvantage on Stealth.", cost: "50 gp", dropChance: 0.6},
        {name: "Breastplate", type: "Armor", rarity: "common", desc: "Medium armor. AC: 14 + DEX (max 2).", cost: "400 gp", dropChance: 0.5},
        {name: "Half Plate", type: "Armor", rarity: "common", desc: "Medium armor. AC: 15 + DEX (max 2). Disadvantage on Stealth.", cost: "750 gp", dropChance: 0.4},
        // Heavy
        {name: "Ring Mail", type: "Armor", rarity: "common", desc: "Heavy armor. AC: 14. Disadvantage on Stealth.", cost: "30 gp", dropChance: 0.5},
        {name: "Chain Mail", type: "Armor", rarity: "common", desc: "Heavy armor. AC: 16. Requires STR 13. Disadvantage on Stealth.", cost: "75 gp", dropChance: 0.6},
        {name: "Splint Armor", type: "Armor", rarity: "common", desc: "Heavy armor. AC: 17. Requires STR 15. Disadvantage on Stealth.", cost: "200 gp", dropChance: 0.5},
        {name: "Plate Armor", type: "Armor", rarity: "common", desc: "Heavy armor. AC: 18. Requires STR 15. Disadvantage on Stealth.", cost: "1,500 gp", dropChance: 0.3},
        // Shields
        {name: "Shield", type: "Armor", rarity: "common", desc: "+2 AC.", cost: "10 gp", dropChance: 0.8}
    ],
    
    allScrolls: [
        {name: "Spell Scroll (Magic Missile)", type: "Scroll", rarity: "common", desc: "Casts Magic Missile at 1st level. Three darts, 1d4+1 force damage each.", dropChance: 0.3, cost: "50 gp"},
        {name: "Spell Scroll (Burning Hands)", type: "Scroll", rarity: "common", desc: "Casts Burning Hands at 1st level. 3d6 fire damage, DEX save for half.", dropChance: 0.3, cost: "50 gp"},
        {name: "Spell Scroll (Cure Wounds)", type: "Scroll", rarity: "common", desc: "Casts Cure Wounds at 1st level. Restore 1d8 + spellcasting modifier HP.", dropChance: 0.35, cost: "50 gp"},
        {name: "Spell Scroll (Shield)", type: "Scroll", rarity: "common", desc: "Casts Shield. +5 AC until start of next turn, blocks Magic Missile.", dropChance: 0.3, cost: "75 gp"},
        {name: "Spell Scroll (Sleep)", type: "Scroll", rarity: "common", desc: "Casts Sleep at 1st level. Puts 5d8 HP worth of creatures to sleep.", dropChance: 0.3, cost: "50 gp"},
        {name: "Spell Scroll (Fireball)", type: "Scroll", rarity: "uncommon", desc: "Casts Fireball at 3rd level. 8d6 fire damage in 20ft sphere, DEX save for half.", dropChance: 0.15, cost: "300 gp"},
        {name: "Spell Scroll (Fly)", type: "Scroll", rarity: "uncommon", desc: "Casts Fly. Target gains 60ft flying speed for 10 minutes.", dropChance: 0.12, cost: "300 gp"},
        {name: "Spell Scroll (Lightning Bolt)", type: "Scroll", rarity: "uncommon", desc: "Casts Lightning Bolt at 3rd level. 8d6 lightning in 100ft line, DEX save for half.", dropChance: 0.12, cost: "300 gp"},
        {name: "Spell Scroll (Greater Invisibility)", type: "Scroll", rarity: "rare", desc: "Casts Greater Invisibility. Target is invisible even while attacking for 1 minute.", dropChance: 0.08, cost: "1,000 gp"},
        {name: "Spell Scroll (Teleportation Circle)", type: "Scroll", rarity: "rare", desc: "Casts Teleportation Circle. Create portal to permanent teleportation circle.", dropChance: 0.06, cost: "1,500 gp"},
        {name: "Spell Scroll (True Resurrection)", type: "Scroll", rarity: "legendary", desc: "Casts True Resurrection. Return the dead to life with full HP.", dropChance: 0.01, cost: "50,000 gp"},
        {name: "Spell Scroll (Wish)", type: "Scroll", rarity: "mythic", desc: "Casts Wish. The most powerful spell in the game.", dropChance: 0.005, cost: "250,000 gp"}
    ],
    
    allMagicWeapons: [
        {name: "+1 Dagger", type: "Weapon", rarity: "uncommon", desc: "+1 to attack and damage rolls. Finesse, light, thrown (20/60). 1d4+1 piercing.", dropChance: 0.2, cost: "500 gp"},
        {name: "+1 Longsword", type: "Weapon", rarity: "uncommon", desc: "+1 to attack and damage rolls. Versatile (1d10+1). 1d8+1 slashing.", dropChance: 0.18, cost: "1,000 gp"},
        {name: "+1 Shortbow", type: "Weapon", rarity: "uncommon", desc: "+1 to attack and damage rolls. Ranged 80/320. 1d6+1 piercing.", dropChance: 0.18, cost: "800 gp"},
        {name: "+2 Longsword", type: "Weapon", rarity: "rare", desc: "+2 to attack and damage rolls. Versatile (1d10+2). 1d8+2 slashing.", dropChance: 0.08, cost: "5,000 gp"},
        {name: "+2 Greataxe", type: "Weapon", rarity: "rare", desc: "+2 to attack and damage rolls. Heavy, two-handed. 1d12+2 slashing.", dropChance: 0.07, cost: "6,000 gp"},
        {name: "+3 Longsword", type: "Weapon", rarity: "epic", desc: "+3 to attack and damage rolls. Versatile (1d10+3). 1d8+3 slashing.", dropChance: 0.04, cost: "20,000 gp"},
        {name: "Sword of Wounding", type: "Weapon", rarity: "rare", desc: "Wounds that can't heal except by magic. Once per turn +1d4 necrotic on hit.", dropChance: 0.07, cost: "8,000 gp"},
        {name: "Sword of Life Stealing", type: "Weapon", rarity: "rare", desc: "On a critical hit, target loses 3d6 HP, you gain that many temp HP.", dropChance: 0.07, cost: "7,500 gp"},
        {name: "Sword of Sharpness", type: "Weapon", rarity: "epic", desc: "On a 20, deal max weapon dice damage + extra 14 damage. Sever limbs!", dropChance: 0.04, cost: "40,000 gp"},
        {name: "Berserker Axe", type: "Weapon", rarity: "rare", desc: "+1 attack/damage. Cursed: must rage in combat or be frightened. 1d12+1 slashing.", dropChance: 0.08, cost: "5,500 gp"},
        {name: "Dwarven Thrower", type: "Weapon", rarity: "epic", desc: "+3 warhammer, returns after throwing. Doubles damage dice vs giants. Dwarf only.", dropChance: 0.04, cost: "35,000 gp"},
        {name: "Oathbow", type: "Weapon", rarity: "epic", desc: "Swear an oath against a target—advantage, +3d6 on hits, they can't hide from you.", dropChance: 0.04, cost: "35,000 gp"},
        {name: "Javelin of Lightning", type: "Weapon", rarity: "uncommon", desc: "Transforms into lightning bolt (4d6) when thrown. Recharges at dawn.", dropChance: 0.15, cost: "1,500 gp"},
        {name: "Trident of Fish Command", type: "Weapon", rarity: "uncommon", desc: "Command aquatic creatures with Intelligence 2 or lower. 3 charges.", dropChance: 0.12, cost: "1,000 gp"},
        {name: "Mace of Disruption", type: "Weapon", rarity: "rare", desc: "Extra 2d6 radiant vs undead/fiends. Target must WIS save or be frightened.", dropChance: 0.08, cost: "6,000 gp"},
        {name: "Mace of Smiting", type: "Weapon", rarity: "rare", desc: "+1 attack/damage. +1d6 vs constructs, critical on 19-20 vs constructs.", dropChance: 0.08, cost: "5,000 gp"},
        {name: "Mace of Terror", type: "Weapon", rarity: "rare", desc: "3 charges: action to release wave of terror, WIS save or frightened for 1 minute.", dropChance: 0.07, cost: "6,500 gp"},
        {name: "Scimitar of Speed", type: "Weapon", rarity: "epic", desc: "+2 to attack/damage. Bonus action extra attack once per turn.", dropChance: 0.04, cost: "30,000 gp"},
        {name: "Nine Lives Stealer", type: "Weapon", rarity: "epic", desc: "1d8+2 slashing. On crit, target CON save DC 15 or die (9 charges).", dropChance: 0.04, cost: "35,000 gp"},
        {name: "Defender", type: "Weapon", rarity: "legendary", desc: "+3 to attack/damage. Transfer +3 to AC bonus as bonus action.", dropChance: 0.02, cost: "75,000 gp"},
        {name: "Frost Brand", type: "Weapon", rarity: "epic", desc: "1d6+1d6 cold on hit. Resistance to fire. Extinguishes uncontrolled fires.", dropChance: 0.04, cost: "30,000 gp"},
        {name: "Dragon Slayer", type: "Weapon", rarity: "rare", desc: "+1, +3d6 damage against dragons.", dropChance: 0.07, cost: "6,000 gp"},
        {name: "Giant Slayer", type: "Weapon", rarity: "rare", desc: "+1, +2d6 damage against giants. Giant must STR save or fall prone.", dropChance: 0.07, cost: "5,500 gp"},
        {name: "Thunderfury, Blessed Blade", type: "Weapon", rarity: "legendary", desc: "+2 longsword. On hit: thunder damage chain to 3 nearby targets, 2d8 each.", dropChance: 0.02, cost: "80,000 gp"}
    ],
    
    miscMagicItems: [
        // Wonderous Items
        {name: "Alchemy Jug", type: "Wondrous", rarity: "uncommon", desc: "Produce various liquids once per day: water, beer, wine, vinegar, mayonnaise, acid, or poison.", dropChance: 0.15, cost: "1,500 gp"},
        {name: "Apparatus of Kwalish", type: "Wondrous", rarity: "legendary", desc: "Crab-like underwater vehicle with a number of functions. Holds 2 creatures.", dropChance: 0.02, cost: "50,000 gp"},
        {name: "Bag of Beans", type: "Wondrous", rarity: "uncommon", desc: "Plant beans for wild random effects—from treasure to monsters to disasters!", dropChance: 0.12, cost: "1,000 gp"},
        {name: "Bag of Devouring", type: "Wondrous", rarity: "epic", desc: "Appears as Bag of Holding but devours items and creatures placed inside.", dropChance: 0.05, cost: "—"},
        {name: "Bag of Tricks (Gray)", type: "Wondrous", rarity: "uncommon", desc: "Pull out a random animal ally once per day (rat, owl, mastiff, etc.)", dropChance: 0.15, cost: "1,000 gp"},
        {name: "Broom of Flying", type: "Wondrous", rarity: "uncommon", desc: "Fly 50 ft per round. Can carry up to 400 lbs (reduces speed). Command word activated.", dropChance: 0.12, cost: "2,000 gp"},
        {name: "Cap of Water Breathing", type: "Wondrous", rarity: "uncommon", desc: "Breathe underwater while wearing it.", dropChance: 0.15, cost: "800 gp"},
        {name: "Carpet of Flying", type: "Wondrous", rarity: "epic", desc: "Large carpet that flies up to 80 ft/round. Carries up to 800 lbs.", dropChance: 0.04, cost: "30,000 gp"},
        {name: "Chime of Opening", type: "Wondrous", rarity: "rare", desc: "10 uses: open any lock or seal within 300ft that isn't sealed by magic.", dropChance: 0.08, cost: "4,000 gp"},
        {name: "Cloak of Displacement", type: "Wondrous", rarity: "rare", desc: "Attackers have disadvantage on attack rolls against you until you take damage.", dropChance: 0.08, cost: "10,000 gp"},
        {name: "Cloak of Elvenkind", type: "Wondrous", rarity: "uncommon", desc: "Advantage on Stealth checks, disadvantage on Perception vs you.", dropChance: 0.14, cost: "1,200 gp"},
        {name: "Crystal Ball", type: "Wondrous", rarity: "epic", desc: "Cast Scrying with DC 17. See anywhere on the same plane of existence.", dropChance: 0.04, cost: "50,000 gp"},
        {name: "Decanter of Endless Water", type: "Wondrous", rarity: "uncommon", desc: "Produce stream, fountain, or geyser of fresh water on command.", dropChance: 0.14, cost: "1,500 gp"},
        {name: "Dimensional Shackles", type: "Wondrous", rarity: "rare", desc: "Restrain a creature; prevents teleportation and planar travel.", dropChance: 0.08, cost: "3,000 gp"},
        {name: "Dust of Disappearance", type: "Wondrous", rarity: "uncommon", desc: "Throw on self and allies: all turn invisible for 2d4 minutes.", dropChance: 0.14, cost: "1,000 gp"},
        {name: "Efreeti Bottle", type: "Wondrous", rarity: "epic", desc: "Contains an efreeti. 10% enslaved for 1001 days, 10% attack you, 80% grant 3 wishes.", dropChance: 0.03, cost: "40,000 gp"},
        {name: "Feather Token", type: "Wondrous", rarity: "rare", desc: "Single-use token that creates a giant oak tree, swan boat, fan, whip, or anchor.", dropChance: 0.09, cost: "2,000 gp"},
        {name: "Figurine of Wondrous Power (Silver Ravens)", type: "Wondrous", rarity: "uncommon", desc: "Raven animates for 12 hours, can carry messages over unlimited distance.", dropChance: 0.14, cost: "1,000 gp"},
        {name: "Gem of Brightness", type: "Wondrous", rarity: "uncommon", desc: "50 charges: shed light, blinding rays, or brilliant beam of light.", dropChance: 0.13, cost: "1,500 gp"},
        {name: "Gem of Seeing", type: "Wondrous", rarity: "rare", desc: "3 charges/day: true seeing for 10 minutes. See invisible, illusions, shapechanger true form.", dropChance: 0.08, cost: "8,000 gp"},
        {name: "Gloves of Missile Snaring", type: "Wondrous", rarity: "uncommon", desc: "Reaction: grab incoming ranged attacks and reduce damage by 1d10+DEX mod.", dropChance: 0.13, cost: "1,200 gp"},
        {name: "Gloves of Swimming and Climbing", type: "Wondrous", rarity: "uncommon", desc: "Swimming and climbing speed equal to walking speed. No check needed.", dropChance: 0.13, cost: "1,200 gp"},
        {name: "Goggles of Night", type: "Wondrous", rarity: "uncommon", desc: "Darkvision 60ft, or extends existing darkvision by 60ft.", dropChance: 0.14, cost: "1,000 gp"},
        {name: "Handy Haversack", type: "Wondrous", rarity: "rare", desc: "Like a bag of holding; 3 compartments. Item always comes to hand first.", dropChance: 0.09, cost: "2,000 gp"},
        {name: "Hat of Disguise", type: "Wondrous", rarity: "uncommon", desc: "Alter Self at will while wearing (change appearance only).", dropChance: 0.14, cost: "1,500 gp"},
        {name: "Headband of Intellect", type: "Wondrous", rarity: "uncommon", desc: "Intelligence score becomes 19 while wearing.", dropChance: 0.12, cost: "1,500 gp"},
        {name: "Helm of Brilliance", type: "Wondrous", rarity: "epic", desc: "Charges for Daylight, Fireball, Prismatic Spray, Wall of Fire. Blinding light.", dropChance: 0.04, cost: "25,000 gp"},
        {name: "Helm of Comprehending Languages", type: "Wondrous", rarity: "uncommon", desc: "Comprehend Languages at will.", dropChance: 0.15, cost: "800 gp"},
        {name: "Helm of Telepathy", type: "Wondrous", rarity: "uncommon", desc: "Detect Thoughts at will. Suggest to creature you Detect (WIS save DC 14).", dropChance: 0.12, cost: "2,000 gp"},
        {name: "Helm of Teleportation", type: "Wondrous", rarity: "rare", desc: "3 charges/day: Teleport to familiar location.", dropChance: 0.07, cost: "8,000 gp"},
        {name: "Ioun Stone (Absorption)", type: "Wondrous", rarity: "epic", desc: "Orbiting stone absorbs spell levels until it holds 50 levels. Then crumbles.", dropChance: 0.04, cost: "24,000 gp"},
        {name: "Ioun Stone (Agility)", type: "Wondrous", rarity: "epic", desc: "DEX becomes 19 while orbiting.", dropChance: 0.04, cost: "20,000 gp"},
        {name: "Ioun Stone (Reserve)", type: "Wondrous", rarity: "rare", desc: "Stores up to 3 levels of spells. Recover as bonus action.", dropChance: 0.08, cost: "10,000 gp"},
        {name: "Iron Bands of Bilarro", type: "Wondrous", rarity: "rare", desc: "Thrown sphere becomes iron bands restraining a Huge or smaller creature.", dropChance: 0.08, cost: "3,000 gp"},
        {name: "Iron Flask", type: "Wondrous", rarity: "legendary", desc: "Trap any creature from another plane. They must serve you for 1 hour if released.", dropChance: 0.02, cost: "100,000 gp"},
        {name: "Lantern of Revealing", type: "Wondrous", rarity: "uncommon", desc: "Sheds bright light 30ft, reveals invisible creatures and objects.", dropChance: 0.14, cost: "1,200 gp"},
        {name: "Lyre of Building", type: "Wondrous", rarity: "rare", desc: "Play to inspire construction. Undo damage done to a structure. Break enchantments.", dropChance: 0.07, cost: "5,000 gp"},
        {name: "Mantle of Spell Resistance", type: "Wondrous", rarity: "rare", desc: "Advantage on saving throws against spells.", dropChance: 0.08, cost: "8,000 gp"},
        {name: "Manual of Bodily Health", type: "Book", rarity: "epic", desc: "Read over 48 hours: CON +2 and max +2. The manual then loses its magic.", dropChance: 0.03, cost: "25,000 gp"},
        {name: "Manual of Gainful Exercise", type: "Book", rarity: "epic", desc: "Read over 48 hours: STR +2 and max +2. The manual then loses its magic.", dropChance: 0.03, cost: "25,000 gp"},
        {name: "Manual of Quickness of Action", type: "Book", rarity: "epic", desc: "Read over 48 hours: DEX +2 and max +2. The manual then loses its magic.", dropChance: 0.03, cost: "25,000 gp"},
        {name: "Medallion of Thoughts", type: "Wondrous", rarity: "uncommon", desc: "3 charges/day: Detect Thoughts (DC 13).", dropChance: 0.14, cost: "1,500 gp"},
        {name: "Mirror of Life Trapping", type: "Wondrous", rarity: "epic", desc: "12 cells: trap reflected creatures. Release with command word or if mirror breaks.", dropChance: 0.04, cost: "30,000 gp"},
        {name: "Necklace of Fireballs", type: "Wondrous", rarity: "rare", desc: "1-9 beads: detach and throw to cast Fireball (scaling with bead count).", dropChance: 0.09, cost: "5,000 gp"},
        {name: "Necklace of Prayer Beads", type: "Wondrous", rarity: "rare", desc: "Various beads: Bless, Curing, Favor, Smiting, Summons, Wind Walking.", dropChance: 0.08, cost: "4,000 gp"},
        {name: "Nether Scroll", type: "Scroll", rarity: "legendary", desc: "Ancient scroll of unknown power. Reading it has unpredictable, often devastating effects.", dropChance: 0.02, cost: "Unknown"},
        {name: "Oil of Etherealness", type: "Consumable", rarity: "rare", desc: "Apply to enter the Ethereal Plane for 1 hour.", dropChance: 0.08, cost: "3,000 gp"},
        {name: "Oil of Sharpness", type: "Consumable", rarity: "epic", desc: "Apply to weapon or ammo: acts as +3 magic weapon for 1 hour.", dropChance: 0.04, cost: "12,000 gp"},
        {name: "Oil of Slipperiness", type: "Consumable", rarity: "uncommon", desc: "Apply to creature: Freedom of Movement for 8 hours. Or cast on floor.", dropChance: 0.14, cost: "1,000 gp"},
        {name: "Periapt of Health", type: "Wondrous", rarity: "uncommon", desc: "Immune to disease.", dropChance: 0.15, cost: "900 gp"},
        {name: "Periapt of Proof Against Poison", type: "Wondrous", rarity: "rare", desc: "Immune to poison damage and the poisoned condition.", dropChance: 0.09, cost: "5,000 gp"},
        {name: "Periapt of Wound Closure", type: "Wondrous", rarity: "uncommon", desc: "Stabilize automatically when dying. Double HP regained from hit dice.", dropChance: 0.14, cost: "1,500 gp"},
        {name: "Philter of Love", type: "Consumable", rarity: "uncommon", desc: "Drinker becomes charmed by first creature they see for 1 hour.", dropChance: 0.13, cost: "1,000 gp"},
        {name: "Pipes of Haunting", type: "Wondrous", rarity: "uncommon", desc: "3 charges: Frighten up to 10 creatures in 30ft radius (WIS save DC 13).", dropChance: 0.13, cost: "1,200 gp"},
        {name: "Pipes of the Sewers", type: "Wondrous", rarity: "uncommon", desc: "Charm and control swarms of rats. Can call 1d3 swarms.", dropChance: 0.13, cost: "1,000 gp"},
        {name: "Portable Hole", type: "Wondrous", rarity: "rare", desc: "Circular cloth unfolds into 6ft diameter, 10ft deep extradimensional hole.", dropChance: 0.09, cost: "5,000 gp"},
        {name: "Pot of Awakening", type: "Wondrous", rarity: "uncommon", desc: "Plant a shrub, water it—after 30 days it becomes an Awakened Shrub ally.", dropChance: 0.12, cost: "900 gp"},
        {name: "Potion of Animal Friendship", type: "Consumable", rarity: "uncommon", desc: "Animal Friendship at will for 1 hour.", dropChance: 0.15, cost: "750 gp"},
        {name: "Potion of Clairvoyance", type: "Consumable", rarity: "rare", desc: "Clairvoyance for 1 hour.", dropChance: 0.09, cost: "3,000 gp"},
        {name: "Potion of Diminution", type: "Consumable", rarity: "rare", desc: "Shrink to 1/10th size for 1d4 hours.", dropChance: 0.09, cost: "2,500 gp"},
        {name: "Potion of Flying", type: "Consumable", rarity: "epic", desc: "Fly up to 60ft per round for 1 hour.", dropChance: 0.04, cost: "8,000 gp"},
        {name: "Potion of Gaseous Form", type: "Consumable", rarity: "rare", desc: "Gaseous Form for 1 hour.", dropChance: 0.09, cost: "3,000 gp"},
        {name: "Potion of Giant Strength (Hill)", type: "Consumable", rarity: "uncommon", desc: "STR becomes 21 for 1 hour.", dropChance: 0.14, cost: "1,500 gp"},
        {name: "Potion of Giant Strength (Stone)", type: "Consumable", rarity: "rare", desc: "STR becomes 23 for 1 hour.", dropChance: 0.09, cost: "3,000 gp"},
        {name: "Potion of Giant Strength (Cloud)", type: "Consumable", rarity: "legendary", desc: "STR becomes 27 for 1 hour.", dropChance: 0.02, cost: "20,000 gp"},
        {name: "Potion of Giant Strength (Storm)", type: "Consumable", rarity: "legendary", desc: "STR becomes 29 for 1 hour.", dropChance: 0.02, cost: "25,000 gp"},
        {name: "Potion of Heroism", type: "Consumable", rarity: "rare", desc: "10 temp HP and you're under a Bless effect for 1 hour.", dropChance: 0.09, cost: "2,500 gp"},
        {name: "Potion of Invisibility", type: "Consumable", rarity: "epic", desc: "Invisibility for 1 hour or until you attack/cast a spell.", dropChance: 0.05, cost: "7,500 gp"},
        {name: "Potion of Invulnerability", type: "Consumable", rarity: "rare", desc: "Resistance to all damage for 1 hour.", dropChance: 0.08, cost: "4,000 gp"},
        {name: "Potion of Longevity", type: "Consumable", rarity: "epic", desc: "Reduce apparent age by 1d6+6 years.", dropChance: 0.04, cost: "10,000 gp"},
        {name: "Potion of Mind Reading", type: "Consumable", rarity: "rare", desc: "Detect Thoughts for 1 hour (DC 13).", dropChance: 0.09, cost: "2,000 gp"},
        {name: "Potion of Poison", type: "Consumable", rarity: "uncommon", desc: "Tastes like a healing potion. Deals 3d6 poison damage, poisoned for 1 hour.", dropChance: 0.13, cost: "500 gp"},
        {name: "Potion of Resistance", type: "Consumable", rarity: "uncommon", desc: "Resistance to one damage type for 1 hour.", dropChance: 0.14, cost: "1,000 gp"},
        {name: "Potion of Speed", type: "Consumable", rarity: "epic", desc: "Haste for 1 minute.", dropChance: 0.05, cost: "9,000 gp"},
        {name: "Potion of Vitality", type: "Consumable", rarity: "epic", desc: "Remove diseases and poisons, regain all lost HP.", dropChance: 0.05, cost: "8,000 gp"},
        {name: "Potion of Water Breathing", type: "Consumable", rarity: "uncommon", desc: "Breathe underwater for 1 hour.", dropChance: 0.15, cost: "750 gp"},
        {name: "Ring of Animal Influence", type: "Ring", rarity: "rare", desc: "3 charges: Animal Friendship (DC 13), Fear (beasts only, DC 13), Speak with Animals.", dropChance: 0.08, cost: "4,000 gp"},
        {name: "Ring of Djinni Summoning", type: "Ring", rarity: "legendary", desc: "Summon a djinni to serve for 1 hour per day. 1001 days total service.", dropChance: 0.02, cost: "75,000 gp"},
        {name: "Ring of Elemental Command (Fire)", type: "Ring", rarity: "legendary", desc: "Resist fire, speak Ignan, command fire elementals, many fire spell abilities.", dropChance: 0.02, cost: "90,000 gp"},
        {name: "Ring of Evasion", type: "Ring", rarity: "rare", desc: "3 charges: turn a failed DEX save into a success.", dropChance: 0.08, cost: "5,000 gp"},
        {name: "Ring of Feather Falling", type: "Ring", rarity: "rare", desc: "Fall at 60ft per round and take no falling damage.", dropChance: 0.09, cost: "2,000 gp"},
        {name: "Ring of Free Action", type: "Ring", rarity: "rare", desc: "Difficult terrain doesn't slow you. Immune to paralysis and restrained.", dropChance: 0.08, cost: "5,000 gp"},
        {name: "Ring of Mind Shielding", type: "Ring", rarity: "uncommon", desc: "Immune to divination magic. Prevent telepathic communication unless willing.", dropChance: 0.13, cost: "1,500 gp"},
        {name: "Ring of Regeneration", type: "Ring", rarity: "epic", desc: "Regain 1d6 HP per 10 minutes. Regrow limbs after 1d6+1 days.", dropChance: 0.04, cost: "25,000 gp"},
        {name: "Ring of Resistance", type: "Ring", rarity: "rare", desc: "Resistance to a specific damage type (chosen when created).", dropChance: 0.08, cost: "4,000 gp"},
        {name: "Ring of Shooting Stars", type: "Ring", rarity: "epic", desc: "Dancing lights at will. Ball lightning, faerie fire, shooting stars all available.", dropChance: 0.04, cost: "25,000 gp"},
        {name: "Ring of Spell Storing", type: "Ring", rarity: "rare", desc: "Store up to 5 levels of spells. Cast stored spells using the ring.", dropChance: 0.08, cost: "5,000 gp"},
        {name: "Ring of Spell Turning", type: "Ring", rarity: "legendary", desc: "Advantage on saves vs spells that target only you. On 20, spell turns back.", dropChance: 0.02, cost: "80,000 gp"},
        {name: "Ring of Telekinesis", type: "Ring", rarity: "epic", desc: "Cast Telekinesis at will.", dropChance: 0.04, cost: "30,000 gp"},
        {name: "Ring of Warmth", type: "Ring", rarity: "uncommon", desc: "Resist cold damage. Comfortable in temperatures as low as -50°F.", dropChance: 0.15, cost: "1,000 gp"},
        {name: "Ring of Water Walking", type: "Ring", rarity: "uncommon", desc: "Stand on and walk across any liquid surface.", dropChance: 0.15, cost: "1,000 gp"},
        {name: "Ring of X-ray Vision", type: "Ring", rarity: "rare", desc: "See through solid matter up to 5ft thick (1ft lead blocks it). CON save or sick.", dropChance: 0.08, cost: "5,000 gp"},
        {name: "Robe of Eyes", type: "Wondrous", rarity: "rare", desc: "See in all directions, can't be surprised, can't be blinded. Sunlight sensitivity.", dropChance: 0.08, cost: "8,000 gp"},
        {name: "Robe of Stars", type: "Wondrous", rarity: "epic", desc: "+1 saving throws, cast Magic Missile (6 charges). Travel to Astral Plane. Stars for spell slots.", dropChance: 0.04, cost: "40,000 gp"},
        {name: "Robe of Scintillating Colors", type: "Wondrous", rarity: "epic", desc: "Creatures within 30ft must WIS save DC 15 or be stunned for 1 round.", dropChance: 0.04, cost: "25,000 gp"},
        {name: "Robe of Useful Items", type: "Wondrous", rarity: "uncommon", desc: "Patches that become useful items: ladder, rowboat, 10 GP, door, iron window bars, etc.", dropChance: 0.13, cost: "1,000 gp"},
        {name: "Rod of Absorption", type: "Staff", rarity: "epic", desc: "React to absorb spells targeting you. Use absorbed spell energy to cast spells.", dropChance: 0.04, cost: "50,000 gp"},
        {name: "Rod of Alertness", type: "Staff", rarity: "epic", desc: "Advantage on Perception checks. Detect Evil and Good, Detect Magic, Detect Poison.", dropChance: 0.04, cost: "20,000 gp"},
        {name: "Rod of Lordly Might", type: "Staff", rarity: "legendary", desc: "Multi-function legendary rod: flail, spear, ladder, battering ram. Many abilities.", dropChance: 0.02, cost: "75,000 gp"},
        {name: "Rod of Rulership", type: "Staff", rarity: "rare", desc: "Command: all creatures of your choice in 120ft obey you for 8 hours.", dropChance: 0.07, cost: "5,000 gp"},
        {name: "Rod of Security", type: "Staff", rarity: "epic", desc: "Transport up to 199 creatures to a paradise demiplane for 200 days.", dropChance: 0.04, cost: "25,000 gp"},
        {name: "Sending Stones", type: "Wondrous", rarity: "uncommon", desc: "Paired stones: cast Sending to communicate with the other stone's holder.", dropChance: 0.15, cost: "1,500 gp"},
        {name: "Slippers of Spider Climbing", type: "Wondrous", rarity: "uncommon", desc: "Climb on walls and ceilings without hands. Speed equals walking speed.", dropChance: 0.14, cost: "1,500 gp"},
        {name: "Staff of Charming", type: "Staff", rarity: "rare", desc: "10 charges: Charm Person (DC 14), Command (DC 14), Comprehend Languages.", dropChance: 0.08, cost: "6,000 gp"},
        {name: "Staff of Fire", type: "Staff", rarity: "epic", desc: "Burning Hands (1 charge), Fireball (3), Wall of Fire (4). 10 charges total.", dropChance: 0.04, cost: "32,000 gp"},
        {name: "Staff of Frost", type: "Staff", rarity: "epic", desc: "Cone of Cold (5), Fog Cloud (1), Ice Storm (4), Wall of Ice (4). 10 charges.", dropChance: 0.04, cost: "32,000 gp"},
        {name: "Staff of Healing", type: "Staff", rarity: "rare", desc: "10 charges: Cure Wounds, Lesser Restoration, Mass Cure Wounds.", dropChance: 0.08, cost: "6,000 gp"},
        {name: "Staff of Swarming Insects", type: "Staff", rarity: "rare", desc: "Giant Insect (4), Insect Plague (5). 10 charges.", dropChance: 0.08, cost: "5,000 gp"},
        {name: "Staff of Thunder and Lightning", type: "Staff", rarity: "epic", desc: "Lightning, Thunder Strike, Thunderclap, Lightning Strike, Thunder & Lightning. Once each.", dropChance: 0.04, cost: "20,000 gp"},
        {name: "Staff of Withering", type: "Staff", rarity: "rare", desc: "3 charges: hit deals 2d10 necrotic, save or disadvantage on STR checks for 1 hour.", dropChance: 0.08, cost: "5,000 gp"},
        {name: "Stone of Controlling Earth Elementals", type: "Wondrous", rarity: "epic", desc: "Once per day: summon an Earth Elemental that serves for 1 hour.", dropChance: 0.04, cost: "20,000 gp"},
        {name: "Stone of Good Luck", type: "Wondrous", rarity: "uncommon", desc: "+1 to ability checks and saving throws.", dropChance: 0.14, cost: "4,200 gp"},
        {name: "Sun Blade", type: "Weapon", rarity: "rare", desc: "+2 longsword that emits sunlight. Extra 1d8 radiant vs undead. Sunlight 15ft radius.", dropChance: 0.08, cost: "12,000 gp"},
        {name: "Sword of Answering", type: "Weapon", rarity: "legendary", desc: "+3 to attack/damage. Reaction: after being hit, make an attack against attacker.", dropChance: 0.02, cost: "80,000 gp"},
        {name: "Tome of Clear Thought", type: "Book", rarity: "epic", desc: "Read over 48 hours: INT +2 and max +2. Then loses magic.", dropChance: 0.03, cost: "25,000 gp"},
        {name: "Tome of Leadership and Influence", type: "Book", rarity: "epic", desc: "Read over 48 hours: CHA +2 and max +2. Then loses magic.", dropChance: 0.03, cost: "25,000 gp"},
        {name: "Tome of Understanding", type: "Book", rarity: "epic", desc: "Read over 48 hours: WIS +2 and max +2. Then loses magic.", dropChance: 0.03, cost: "25,000 gp"},
        {name: "Trident of Warning", type: "Weapon", rarity: "uncommon", desc: "+2 trident. Warns of danger 1 minute before combat. Can't be surprised while attuned.", dropChance: 0.13, cost: "2,500 gp"},
        {name: "Universal Solvent", type: "Consumable", rarity: "legendary", desc: "Dissolves any adhesive including Sovereign Glue and the like.", dropChance: 0.02, cost: "Unknown"},
        {name: "Wand of Binding", type: "Wand", rarity: "rare", desc: "7 charges: Hold Monster (5), Hold Person (2). If out of charges, bound creature freed.", dropChance: 0.08, cost: "6,000 gp"},
        {name: "Wand of Enemy Detection", type: "Wand", rarity: "rare", desc: "7 charges: Detect nearby hostile creatures (1 charge, 1 minute).", dropChance: 0.09, cost: "4,000 gp"},
        {name: "Wand of Fear", type: "Wand", rarity: "rare", desc: "7 charges: Command creatures in 60ft cone to flee (WIS save DC 15).", dropChance: 0.08, cost: "6,000 gp"},
        {name: "Wand of Fireballs", type: "Wand", rarity: "rare", desc: "7 charges: Cast Fireball at 3rd level or higher.", dropChance: 0.08, cost: "6,500 gp"},
        {name: "Wand of Lightning Bolts", type: "Wand", rarity: "rare", desc: "7 charges: Cast Lightning Bolt at 3rd level or higher.", dropChance: 0.08, cost: "6,500 gp"},
        {name: "Wand of Magic Detection", type: "Wand", rarity: "uncommon", desc: "3 charges: Detect Magic.", dropChance: 0.15, cost: "1,200 gp"},
        {name: "Wand of Paralysis", type: "Wand", rarity: "rare", desc: "7 charges: Paralyze creature (CON save DC 15) for 1 minute.", dropChance: 0.08, cost: "5,500 gp"},
        {name: "Wand of Polymorph", type: "Wand", rarity: "epic", desc: "7 charges: Cast Polymorph (WIS save DC 15).", dropChance: 0.04, cost: "20,000 gp"},
        {name: "Wand of Secrets", type: "Wand", rarity: "uncommon", desc: "3 charges: Detect nearby hidden doors and traps.", dropChance: 0.15, cost: "1,200 gp"},
        {name: "Wand of Web", type: "Wand", rarity: "uncommon", desc: "7 charges: Cast Web (DEX save DC 15).", dropChance: 0.14, cost: "1,200 gp"},
        {name: "Wand of Wonder", type: "Wand", rarity: "rare", desc: "7 charges: Random wild magic effects from a d100 table. Completely unpredictable!", dropChance: 0.08, cost: "4,500 gp"},
        {name: "Wings of Flying", type: "Wondrous", rarity: "rare", desc: "Unfurling cloak reveals wings: fly 60ft per round for 1 hour per day.", dropChance: 0.08, cost: "6,000 gp"}
    ],

    quests: {
        hostile: [
            {type: "Ambush", desc: "This NPC is lying in wait to attack the party. They may be working for a rival or are bandits seeking easy prey.", reward: "Standard loot + information"},
            {type: "Assassination", desc: "A hired killer sent to eliminate one or more party members by a powerful enemy. Highly skilled and dangerous.", reward: "Assassin's poisoned weapons + contract details"},
            {type: "Infection Vector", desc: "This NPC carries a magical disease or poison and attempts to infect the party through contact, food, or deception.", reward: "Rare antidotes and medical supplies"},
            {type: "Betrayal", desc: "Appears friendly initially but will betray the party at the worst possible moment, stealing from them or leading them into a deadly trap.", reward: "Map to their hideout + stolen goods"},
            {type: "Possessed", desc: "Controlled by an evil spirit, demon, or mind magic, attacking the party against their original will.", reward: "Exorcism components + host's gratitude"},
            {type: "Bounty Hunter", desc: "Seeking to capture party member(s) alive or dead for a bounty. Relentless and well-equipped.", reward: "Bounty poster + hunter's gear"},
            {type: "Rival Adventurer", desc: "Competing for the same treasure, quest, or glory. Will sabotage or directly confront the party.", reward: "Rival's magical items + quest info"}
        ],
        side: [
            {type: "Merchant", desc: "Sells rare goods or hard-to-find information. May have a side quest to retrieve special merchandise from dangerous location.", reward: "20% discount + rare items"},
            {type: "Lost Soul", desc: "Needs safe escort to a nearby location. Being hunted by dangerous enemies or needs protection from environment.", reward: "Generous payment + possible ally"},
            {type: "Informant", desc: "Has valuable information about the main quest or regional secrets, but requires a personal favor or payment first.", reward: "Critical quest information + contacts"},
            {type: "Healer", desc: "Can provide magical healing, restoration, or cure rare afflictions for appropriate payment or quest completion.", reward: "Healing services + potions"},
            {name: "Skilled Craftsman", desc: "Master blacksmith, enchanter, or artisan who can create or upgrade equipment if provided with rare materials.", reward: "Custom enchanted equipment"},
            {type: "Trainer", desc: "Veteran warrior, mage, or specialist who can teach new combat techniques or skills if party proves worthy.", reward: "Learn new abilities/proficiencies"},
            {type: "Quest Giver", desc: "Has urgent need for capable adventurers. Offers lucrative quest with good pay and useful rewards.", reward: "Gold + magic items + reputation"}
        ],
        neutral: [
            {type: "Traveler", desc: "Simply passing through the area. May share rumors, local news, directions, or warnings but has no particular agenda.", reward: "Local information + rumors"},
            {type: "Refugee", desc: "Fleeing from recent disaster or conflict. Can provide firsthand information about threats ahead or recent events.", reward: "Warning of dangers + tragic story"},
            {type: "Entertainer", desc: "Bard, juggler, storyteller, or performer. Provides entertainment and can share local gossip, legends, or songs.", reward: "Rumors + entertainment + stories"},
            {type: "Hermit", desc: "Lives in isolation by choice. Possesses ancient knowledge or wisdom but is reluctant to share without good reason.", reward: "Ancient lore (if befriended)"},
            {type: "Scholar", desc: "Studying local history, magic, or phenomena. Curious about party's adventures and willing to share knowledge.", reward: "Historical information"},
            {type: "Pilgrim", desc: "On religious journey to sacred site. May offer blessings or religious insights, needs no help.", reward: "Minor blessing"}
        ]
    },

    raceFeats: {
        "Human": [
            {name: "Ability Score Versatility", desc: "Increase all ability scores by 1, reflecting natural human adaptability across all fields."},
            {name: "Extra Proficiency", desc: "Proficient in one additional skill of choice, representing human breadth of learning."},
            {name: "Extra Feat (Variant)", desc: "Optional: gain one feat at 1st level instead of the +1 to all scores."},
            {name: "Natural Diplomat", desc: "Advantage on Persuasion checks when negotiating between two parties, as humans excel at compromise."}
        ],
        "Elf": [
            {name: "Darkvision", desc: "See in dim light as if it were bright light, and in darkness as if dim light, up to 60 feet."},
            {name: "Fey Ancestry", desc: "Advantage on saving throws against being charmed, and magic can't put you to sleep."},
            {name: "Trance", desc: "Elves don't need to sleep. Instead they meditate deeply for 4 hours a day (semi-conscious)."},
            {name: "Keen Senses", desc: "Proficiency in the Perception skill, reflecting unnaturally acute elven senses."},
            {name: "Elven Weapon Training", desc: "Proficiency with longsword, shortsword, shortbow, and longbow."}
        ],
        "Dwarf": [
            {name: "Darkvision", desc: "See in dim light as if bright light, and darkness as dim light, up to 60 feet."},
            {name: "Dwarven Resilience", desc: "Advantage on saving throws against poison, and resistance to poison damage."},
            {name: "Dwarven Combat Training", desc: "Proficiency with the battleaxe, handaxe, light hammer, and warhammer."},
            {name: "Stonecunning", desc: "Double proficiency bonus on History checks related to stonework, tunnels, and underground structures."},
            {name: "Dwarven Toughness (Hill)", desc: "HP maximum increases by 1 at 1st level, and again every time you gain a level."},
            {name: "Tool Proficiency", desc: "Proficiency with smith's tools, brewer's supplies, or mason's tools (choose one)."}
        ],
        "Halfling": [
            {name: "Lucky", desc: "When you roll a 1 on any attack, ability check, or saving throw, you can reroll and must use the new roll."},
            {name: "Brave", desc: "Advantage on saving throws against being frightened, reflecting halfling indomitable spirit."},
            {name: "Halfling Nimbleness", desc: "You can move through the space of any creature that is of a size larger than yours."},
            {name: "Naturally Stealthy", desc: "You can attempt to hide even when obscured only by a creature one size larger than yourself."}
        ],
        "Orc": [
            {name: "Darkvision", desc: "See in dim light as if bright, darkness as dim light, up to 60 feet."},
            {name: "Aggressive", desc: "As a bonus action, you can move up to your speed toward an enemy you can see or hear."},
            {name: "Primal Intuition", desc: "Proficiency in two of the following: Animal Handling, Insight, Intimidation, Medicine, Nature, Perception, or Survival."},
            {name: "Powerful Build", desc: "You count as one size larger when determining your carrying capacity and the weight you can push, drag, or lift."}
        ],
        "Tiefling": [
            {name: "Darkvision", desc: "See in dim light as if bright, darkness as dim light, up to 60 feet."},
            {name: "Hellish Resistance", desc: "Resistance to fire damage, inherited from infernal ancestry."},
            {name: "Infernal Legacy", desc: "Know the Thaumaturgy cantrip. At 3rd level, Hellish Rebuke 1/day. At 5th level, Darkness 1/day (CHA-based)."},
            {name: "Darkvision (Superior)", desc: "The tiefling's darkvision penetrates magical darkness created by their own Darkness spell."}
        ],
        "Dragonborn": [
            {name: "Draconic Ancestry", desc: "Choose a dragon type (Black-acid, Blue-lightning, etc.) which determines breath weapon damage type and resistance."},
            {name: "Breath Weapon", desc: "As an action, exhale destructive energy. Damage = 2d6 (rises to 3d6 at 6th, 4d6 at 11th, 5d6 at 16th). DEX save (DC = 8 + CON + proficiency)."},
            {name: "Damage Resistance", desc: "Resistance to the damage type associated with your draconic ancestry (fire, acid, lightning, etc.)."},
            {name: "Draconic Presence (Bonus Feat)", desc: "Some dragonborn exude a commanding aura: advantage on Intimidation and Persuasion."}
        ],
        "Gnome": [
            {name: "Darkvision", desc: "See in dim light as if bright, darkness as dim light, up to 60 feet."},
            {name: "Gnome Cunning", desc: "Advantage on all Intelligence, Wisdom, and Charisma saving throws against magic."},
            {name: "Artificer's Lore (Rock Gnome)", desc: "Add twice proficiency bonus to History checks about magical, alchemical, or technological items."},
            {name: "Tinker (Rock Gnome)", desc: "Proficiency with artisan's tools (tinker's tools). Construct tiny clockwork devices as an action."},
            {name: "Natural Illusionist (Forest Gnome)", desc: "Know the Minor Illusion cantrip (INT-based). Speak with small beasts."}
        ]
    },

    racialClothing: {
        "Human": ["worn leather traveling coat", "simple merchant's tunic and breeches", "sturdy guard's uniform", "patched wool cloak", "faded noble's doublet", "roughspun linen shirt"],
        "Elf": ["flowing sylvan robes with leaf motifs", "fitted elven leather in forest greens and golds", "gossamer silk robes", "elegant elven court attire with silver embroidery", "simple hunter's tunic with vine-woven accents"],
        "Dwarf": ["heavy wool tunic over ringmail shirt", "soot-stained leather apron over clan tartan", "formal clan regalia with house insignia", "fur-trimmed mountain coat", "practical miner's vest with iron clasps"],
        "Halfling": ["bright colourful waistcoat over linen shirt", "patchwork traveler's jacket", "cozy woolen vest and rolled-up trousers", "festive fair-day clothes", "simple country clothes, grass-stained"],
        "Orc": ["roughhewn war-scarred leathers", "tribal hide with clan markings", "heavy fur mantle over bare torso", "scavenged armor pieces lashed together", "simple woven cloth worn under bone-adorned pauldrons"],
        "Tiefling": ["dark flowing robes that pool at the feet", "dramatic black and crimson vestments", "fitted dark leather with brass buckles", "scholarly dark coat with occult trim", "elegant but sinister court clothes"],
        "Dragonborn": ["scaled plate armor etched with draconic runes", "military coat bearing a draconic crest", "heavy fur-lined robe over scale mail", "ceremonial draconic war regalia", "sturdy traveler's gear reinforced for a large frame"],
        "Gnome": ["brightly coloured patchwork coat covered in pockets", "leather apron over wildly mismatched clothes", "formal gnomish attire with mechanical embellishments", "colourful vest with a dozen tiny gadgets", "simple robes covered in alchemical stains"]
    },

    racialWeaponDescriptions: {
        "Human": ["a well-oiled longsword in a practical leather scabbard", "a battered shortsword showing years of use", "a reliable crossbow with extra bolts", "a spear with iron tip", "a hand axe worn at the belt"],
        "Elf": ["a graceful longbow of yew strung with elven cord", "a slender elven blade with intricate leaf-patterned guard", "a curved elven knife in a silver-chased sheath", "a shortbow of exceptional craftsmanship"],
        "Dwarf": ["a masterwork battleaxe with the clan rune engraved on the head", "a stout warhammer with a scarred, well-used face", "a heavy crossbow of dwarven design", "a handaxe with a worn wooden grip"],
        "Halfling": ["a short sword almost comically sized for their stature", "a sling and pouch of smooth river stones", "a small hunting dagger tucked in a boot", "a shortbow of simple design"],
        "Orc": ["a crude greataxe notched from heavy use", "a pair of javelins slung across the back", "a spiked club bound in leather", "a heavy morningstar dripping old blood"],
        "Tiefling": ["a slim dagger with a fire-blackened blade", "a short rapier with a hellish motif on the handguard", "a bone-handled throwing knife", "an ornate hand crossbow with infernal engravings"],
        "Dragonborn": ["a greataxe scaled to dragonborn size, intimidatingly large", "a broad greatsword engraved with draconic script", "a warhammer bearing the symbol of their draconic clan", "a massive spear tipped with a claw-shaped blade"],
        "Gnome": ["a crossbow of ingenious small-scale gnomish design", "a short sword light enough for nimble fingers", "a variety of alchemical vials strapped to a belt", "a slim dagger that doubles as a tool"]
    },

    relationships: [
        {type: "Parent", desc: "raised and cared for", bond: "deep familial love", variance: 0.9},
        {type: "Child", desc: "is the offspring of", bond: "parental pride and responsibility", variance: 0.85},
        {type: "Sibling", desc: "grew up alongside", bond: "sibling rivalry and camaraderie", variance: 0.7},
        {type: "Twin", desc: "shares a birth with", bond: "unbreakable psychic connection", variance: 0.95},
        {type: "Spouse", desc: "is married to", bond: "romantic devotion", variance: 0.9},
        {type: "Fiancé", desc: "is betrothed to", bond: "promised love", variance: 0.85},
        {type: "Ex-Spouse", desc: "was once married to", bond: "complicated bitter history", variance: 0.4},
        {type: "Secret Lover", desc: "is secretly involved with", bond: "passionate forbidden affair", variance: 0.8},
        {type: "Childhood Friend", desc: "has known since youth", bond: "nostalgic deep friendship", variance: 0.75},
        {type: "Best Friend", desc: "is closest companion to", bond: "unwavering loyalty", variance: 0.85},
        {type: "Rival", desc: "competes fiercely with", bond: "respectful competitive tension", variance: 0.5},
        {type: "Bitter Enemy", desc: "holds deep grudge against", bond: "burning hatred", variance: 0.2},
        {type: "Mentor", desc: "taught and guided", bond: "teacher-student respect", variance: 0.8},
        {type: "Student", desc: "learns from and admires", bond: "eager admiration", variance: 0.75},
        {type: "Business Partner", desc: "runs schemes and ventures with", bond: "professional trust", variance: 0.6},
        {type: "Debtor", desc: "owes significant money to", bond: "financial obligation", variance: 0.5},
        {type: "Creditor", desc: "is owed money by", bond: "financial leverage", variance: 0.5},
        {type: "Master", desc: "serves loyally as", bond: "duty and servitude", variance: 0.7},
        {type: "Servant", desc: "is served faithfully by", bond: "authority and responsibility", variance: 0.6},
        {type: "War Comrade", desc: "fought bloody battles alongside", bond: "battle-forged unbreakable trust", variance: 0.85},
        {type: "Savior", desc: "heroically saved the life of", bond: "life debt", variance: 0.9},
        {type: "The Saved", desc: "was dramatically rescued by", bond: "eternal gratitude", variance: 0.85}
    ],

    groupRelationships: [
        {type: "Rescued by Group", desc: "was saved from peril by", bond: "eternal gratitude and life debt", variance: 0.92, connection: "The group pulled this person from a desperate situation they could not escape alone."},
        {type: "Hired the Group", desc: "employed and paid for services rendered by", bond: "professional respect and trust", variance: 0.7, connection: "A past employer who still has loose ties and may call on the group again."},
        {type: "Betrayed by Group", desc: "was wronged or abandoned by", bond: "simmering resentment", variance: 0.2, connection: "Something went wrong on a past job. They haven't forgotten — or forgiven."},
        {type: "Group Member's Sibling", desc: "shares blood with a member of", bond: "familial concern and curiosity", variance: 0.8, connection: "Blood relative of one group member, aware of their adventuring life."},
        {type: "Group Member's Ex", desc: "has complicated romantic history with a member of", bond: "unresolved tension", variance: 0.45, connection: "History with one member. Still thinks about it. Whether fondly or bitterly depends on the outcome."},
        {type: "Fan of the Group", desc: "idolizes and follows the legend of", bond: "star-struck admiration", variance: 0.88, connection: "Has heard the tales and desperately wants to meet — or join — the group."},
        {type: "Owes Debt to Group", desc: "is indebted financially or morally to", bond: "uncomfortable obligation", variance: 0.65, connection: "The group did them a favor, big or small. The debt sits uneasily on their conscience."},
        {type: "Rival Group Member", desc: "competes with and is challenged by a member of", bond: "heated professional rivalry", variance: 0.5, connection: "Crossed paths with one group member and refuses to be outdone."},
        {type: "Former Ally", desc: "once fought alongside and trusted members of", bond: "fond but faded camaraderie", variance: 0.75, connection: "Shared a quest or battle once. The world moved on, but the memory remains."},
        {type: "Informant", desc: "secretly passes information to or from", bond: "calculated mutual benefit", variance: 0.6, connection: "A contact who feeds or receives intelligence. Trust is transactional, not emotional."},
        {type: "Innocent Bystander Helped", desc: "was an ordinary person aided in passing by", bond: "warm and lasting gratitude", variance: 0.85, connection: "The group did not even realize the impact they had on this person's life."},
        {type: "Witness to Group's Deed", desc: "saw firsthand the actions — good or ill — of", bond: "awe, fear, or moral conflict", variance: 0.55, connection: "Was present for a significant moment. What they saw shapes how they speak of the group."},
        {type: "Group's Contact", desc: "serves as a local resource and ally for", bond: "reliable professional partnership", variance: 0.72, connection: "A fence, scholar, innkeeper, or official who regularly assists the group."},
        {type: "Wants to Join Group", desc: "desperately seeks membership in", bond: "earnest ambition and idealism", variance: 0.82, connection: "Has prepared, trained, and dreamed about joining. May seek out the group deliberately."},
        {type: "Orphaned by Group's Enemy", desc: "lost family to the same foes opposed by", bond: "shared cause born from tragedy", variance: 0.78, connection: "The group and this person share a common enemy. They don't know each other yet, but fate may intervene."},
    ],

    groupTypes: [
        {
            type: "Adventuring Party",
            minSize: 2, maxSize: 6,
            names: ["The Crimson Blades", "Steel Brotherhood", "Dragon's Watch", "Shadow Company", "The Iron Vanguard", "Windrunners", "The Emerald Order", "Nightfall Alliance", "Stormbringers", "The Golden Lions"],
            goals: ["Seeking ancient artifacts", "Hunting a legendary monster", "Investigating mysterious disappearances", "Mapping uncharted territories", "Recovering stolen relics", "Avenging fallen comrades"],
            mottos: ["Together we stand", "Fortune favors the bold", "No quest too dangerous", "United in steel", "Honor above all", "Strength through unity"]
        },
        {
            type: "Bandit Gang",
            minSize: 3, maxSize: 8,
            names: ["The Red Talons", "Black Masks", "Razor's Edge", "The Vultures", "Iron Chain Gang", "Shadowfoot Bandits", "The Scorpions", "Blood Hawks", "The Cutthroats", "Viper's Nest"],
            goals: ["Robbing merchant caravans", "Controlling local trade routes", "Extorting nearby villages", "Hiding from authorities", "Planning a major heist", "Seeking revenge on nobles"],
            mottos: ["Take what's yours", "Survive at any cost", "Trust no one", "Gold over glory", "We owe the world nothing", "Only the strong survive"]
        },
        {
            type: "Master & Disciples",
            minSize: 2, maxSize: 4,
            names: ["The Sacred Circle", "The Order of the Way", "Keepers of the Ancient Art", "The Enlightened Path", "Children of the Eternal Flame", "Disciples of the Blade"],
            goals: ["Seeking enlightenment", "Preserving ancient knowledge", "Training for a great challenge", "Hunting down corrupted magic", "Protecting sacred sites", "Completing a pilgrimage"],
            mottos: ["Knowledge is power", "The student becomes the master", "Walk the path of wisdom", "Through discipline, perfection", "Tradition must endure", "Master yourself, master all"]
        },
        {
            type: "Mercenary Company",
            minSize: 3, maxSize: 7,
            names: ["The Free Swords", "Coin & Steel", "Blackshield Company", "The Reavers", "War Dogs", "Fortune's Chosen", "The Sellswords", "Iron Contract", "Blood Money Brigade"],
            goals: ["Fulfilling current contract", "Building reputation", "Seeking higher paying jobs", "Protecting a caravan", "Besieging a fortress", "Training new recruits"],
            mottos: ["Gold speaks louder than honor", "Any job for the right price", "We fight for coin, not cause", "Professional to the end", "Death before breach of contract", "No loyalty but to the purse"]
        },
        {
            type: "Cult",
            minSize: 3, maxSize: 8,
            names: ["The Children of the Void", "Crimson Circle", "The Awakened", "Servants of the Deep", "The Eternal Covenant", "Order of the Black Star", "The Devoted", "Seekers of Truth"],
            goals: ["Summoning their dark deity", "Converting new believers", "Performing forbidden rituals", "Gathering sacrifices", "Undermining local authorities", "Seeking ancient prophecies"],
            mottos: ["In darkness we trust", "The end is nigh", "Embrace the truth", "All shall serve", "The old ways endure", "Sacrifice brings power"]
        },
        {
            type: "Noble House Retinue",
            minSize: 2, maxSize: 5,
            names: ["House Blackwood Guard", "The Silver Lions", "Crimson Banner Knights", "Royal Protectors", "House of the Phoenix", "The Golden Eagles"],
            goals: ["Protecting their lord/lady", "Investigating political rivals", "Securing trade agreements", "Hunting assassins", "Maintaining family honor", "Seeking advantageous marriages"],
            mottos: ["Honor and duty", "Blood before all", "For house and home", "Nobility demands sacrifice", "Tradition is our strength", "We serve with pride"]
        },
        {
            type: "Thieves' Guild",
            minSize: 3, maxSize: 6,
            names: ["The Silent Hand", "Shadow Collective", "The Unseen", "Velvet Fingers", "Nightmarket Crew", "The Lockpicks", "Whisper Network", "The Gray Ghosts"],
            goals: ["Pulling off the big score", "Eliminating rival thieves", "Bribing city guards", "Fencing stolen goods", "Protecting territory", "Recruiting new members"],
            mottos: ["What's yours is ours", "Never caught, never blamed", "Silence is golden", "Honor among thieves", "The city is our treasure", "Take only what you can carry"]
        },
        {
            type: "Monster Hunters",
            minSize: 2, maxSize: 5,
            names: ["The Slayers", "Beast Breakers", "The Hunt", "Monster's Bane", "Night Watchers", "The Eradicators", "Fang & Claw", "Death's Shadow"],
            goals: ["Tracking a deadly creature", "Collecting bounties", "Protecting villages", "Researching monster weaknesses", "Avenging fallen hunters", "Clearing infested areas"],
            mottos: ["Hunt or be hunted", "Fear is for prey", "Every beast falls eventually", "The strong survive", "Knowledge is survival", "No monster is immortal"]
        },
        {
            type: "Bodyguards",
            minSize: 2, maxSize: 6,
            names: ["Iron Shield Company", "The Steadfast", "Sword & Shadow", "The Bulwark", "Last Line", "The Wardens", "Ironclad Escort", "The Sentinels"],
            goals: ["Protecting a high-value client", "Escorting a noble across dangerous territory", "Guarding a shipment of valuables", "Providing personal security at a public event", "Tracking down a threat to their employer", "Eliminating a rival who targeted their client"],
            mottos: ["No harm shall pass us", "We stand between you and death", "Loyalty is our blade", "Our client's life is our life", "Gold buys our blades, honor keeps them", "We die before they do"]
        }
    ],

    shopTypes: {
        "Blacksmith": {
            inventory: [
                {name: "Longsword", cost: "15 gp", type: "Weapon"},
                {name: "Shortsword", cost: "10 gp", type: "Weapon"},
                {name: "Greatsword", cost: "50 gp", type: "Weapon"},
                {name: "Battleaxe", cost: "10 gp", type: "Weapon"},
                {name: "Greataxe", cost: "30 gp", type: "Weapon"},
                {name: "Warhammer", cost: "15 gp", type: "Weapon"},
                {name: "Maul", cost: "10 gp", type: "Weapon"},
                {name: "Chain Mail", cost: "75 gp", type: "Armor"},
                {name: "Plate Armor", cost: "1,500 gp", type: "Armor"},
                {name: "Scale Mail", cost: "50 gp", type: "Armor"},
                {name: "Breastplate", cost: "400 gp", type: "Armor"},
                {name: "Shield", cost: "10 gp", type: "Armor"},
                {name: "Horseshoes", cost: "5 gp", type: "Tool"},
                {name: "Smith's Tools", cost: "20 gp", type: "Tool"},
                {name: "Iron Spikes (10)", cost: "1 gp", type: "Gear"}
            ],
            specialty: "Weapons & Heavy Armor",
            occupation: "Blacksmith",
            personality: ["Gruff but fair", "Takes pride in their work", "Suspicious of cheap imports", "Loves talking about metallurgy"]
        },
        "General Store": {
            inventory: [
                {name: "Backpack", cost: "2 gp", type: "Gear"},
                {name: "Bedroll", cost: "1 gp", type: "Gear"},
                {name: "Rations (1 day)", cost: "5 sp", type: "Consumable"},
                {name: "Rope, Hempen (50 ft)", cost: "1 gp", type: "Gear"},
                {name: "Rope, Silk (50 ft)", cost: "10 gp", type: "Gear"},
                {name: "Torch (10)", cost: "1 sp", type: "Gear"},
                {name: "Waterskin", cost: "2 sp", type: "Gear"},
                {name: "Candles (10)", cost: "1 cp", type: "Gear"},
                {name: "Blanket", cost: "5 sp", type: "Gear"},
                {name: "Tinderbox", cost: "5 sp", type: "Gear"},
                {name: "Mess Kit", cost: "2 sp", type: "Gear"},
                {name: "Soap", cost: "2 cp", type: "Gear"},
                {name: "Clothes, Common", cost: "5 sp", type: "Gear"},
                {name: "Clothes, Fine", cost: "15 gp", type: "Gear"},
                {name: "Tent, Two-person", cost: "2 gp", type: "Gear"}
            ],
            specialty: "General Goods & Supplies",
            occupation: "Merchant",
            personality: ["Friendly and chatty", "Always looking for a deal", "Knows everyone's business", "Cheerfully overcharges outsiders"]
        },
        "Magic Shop": {
            inventory: [
                {name: "Spell Scroll (1st level)", cost: "50 gp", type: "Scroll"},
                {name: "Spell Scroll (2nd level)", cost: "150 gp", type: "Scroll"},
                {name: "Potion of Healing", cost: "50 gp", type: "Potion"},
                {name: "Potion of Greater Healing", cost: "150 gp", type: "Potion"},
                {name: "Component Pouch", cost: "25 gp", type: "Gear"},
                {name: "Arcane Focus (Crystal)", cost: "10 gp", type: "Gear"},
                {name: "Arcane Focus (Orb)", cost: "20 gp", type: "Gear"},
                {name: "Arcane Focus (Rod)", cost: "10 gp", type: "Gear"},
                {name: "Arcane Focus (Staff)", cost: "5 gp", type: "Gear"},
                {name: "Arcane Focus (Wand)", cost: "10 gp", type: "Gear"},
                {name: "Spellbook", cost: "50 gp", type: "Gear"},
                {name: "Ink (1 oz bottle)", cost: "10 gp", type: "Gear"},
                {name: "Parchment (sheet)", cost: "1 sp", type: "Gear"}
            ],
            specialty: "Magical Items & Components",
            occupation: "Wizard's Apprentice",
            personality: ["Eccentric and mysterious", "Speaks in riddles", "Very cautious about customers", "Obsessed with rare components"]
        },
        "Apothecary": {
            inventory: [
                {name: "Potion of Healing", cost: "50 gp", type: "Potion"},
                {name: "Antitoxin", cost: "50 gp", type: "Potion"},
                {name: "Potion of Climbing", cost: "75 gp", type: "Potion"},
                {name: "Herbalism Kit", cost: "5 gp", type: "Tool"},
                {name: "Healer's Kit", cost: "5 gp", type: "Gear"},
                {name: "Poison, Basic (vial)", cost: "100 gp", type: "Poison"},
                {name: "Perfume (vial)", cost: "5 gp", type: "Gear"},
                {name: "Soap", cost: "2 cp", type: "Gear"},
                {name: "Holy Water (flask)", cost: "25 gp", type: "Gear"}
            ],
            specialty: "Potions, Herbs & Remedies",
            occupation: "Herbalist",
            personality: ["Kind and nurturing", "Knows ancient remedies", "Distrusts modern medicine", "Has a secret past"]
        },
        "Tavern/Inn": {
            inventory: [
                {name: "Ale (mug)", cost: "4 cp", type: "Food/Drink"},
                {name: "Ale (gallon)", cost: "2 sp", type: "Food/Drink"},
                {name: "Wine, Common (pitcher)", cost: "2 sp", type: "Food/Drink"},
                {name: "Wine, Fine (bottle)", cost: "10 gp", type: "Food/Drink"},
                {name: "Meal, Modest", cost: "3 sp", type: "Food/Drink"},
                {name: "Meal, Comfortable", cost: "5 sp", type: "Food/Drink"},
                {name: "Meal, Wealthy", cost: "8 sp", type: "Food/Drink"},
                {name: "Inn Stay (per day), Squalid", cost: "7 cp", type: "Service"},
                {name: "Inn Stay (per day), Poor", cost: "1 sp", type: "Service"},
                {name: "Inn Stay (per day), Modest", cost: "5 sp", type: "Service"},
                {name: "Inn Stay (per day), Comfortable", cost: "8 sp", type: "Service"},
                {name: "Inn Stay (per day), Wealthy", cost: "2 gp", type: "Service"}
            ],
            specialty: "Food, Drink & Lodging",
            occupation: "Innkeeper",
            personality: ["Jovial and welcoming", "Hears everything", "Knows how to keep secrets", "Can be bribed easily"]
        },
        "Fletcher/Bowyer": {
            inventory: [
                {name: "Longbow", cost: "50 gp", type: "Weapon"},
                {name: "Shortbow", cost: "25 gp", type: "Weapon"},
                {name: "Light Crossbow", cost: "25 gp", type: "Weapon"},
                {name: "Heavy Crossbow", cost: "50 gp", type: "Weapon"},
                {name: "Hand Crossbow", cost: "75 gp", type: "Weapon"},
                {name: "Arrows (20)", cost: "1 gp", type: "Ammunition"},
                {name: "Crossbow Bolts (20)", cost: "1 gp", type: "Ammunition"},
                {name: "Quiver", cost: "1 gp", type: "Gear"},
                {name: "Bowstring", cost: "5 sp", type: "Gear"}
            ],
            specialty: "Bows, Crossbows & Ammunition",
            occupation: "Fletcher",
            personality: ["Perfectionist", "Quiet and focused", "Competitive archer", "Proud of their craft"]
        },
        "Alchemist": {
            inventory: [
                {name: "Alchemist's Fire (flask)", cost: "50 gp", type: "Alchemical"},
                {name: "Acid (vial)", cost: "25 gp", type: "Alchemical"},
                {name: "Antitoxin (vial)", cost: "50 gp", type: "Potion"},
                {name: "Potion of Healing", cost: "50 gp", type: "Potion"},
                {name: "Oil (flask)", cost: "1 sp", type: "Gear"},
                {name: "Alchemist's Supplies", cost: "50 gp", type: "Tool"},
                {name: "Vial", cost: "1 gp", type: "Gear"},
                {name: "Flask", cost: "2 cp", type: "Gear"}
            ],
            specialty: "Alchemical Substances",
            occupation: "Alchemist",
            personality: ["Slightly mad scientist", "Excited about explosions", "Forgetful", "Always experimenting"]
        },
        "Jeweler": {
            inventory: [
                {name: "Ring, Gold", cost: "25 gp", type: "Jewelry"},
                {name: "Ring, Platinum", cost: "50 gp", type: "Jewelry"},
                {name: "Necklace, Gold", cost: "50 gp", type: "Jewelry"},
                {name: "Necklace, Platinum", cost: "100 gp", type: "Jewelry"},
                {name: "Gem, Azurite (10 gp)", cost: "10 gp", type: "Gem"},
                {name: "Gem, Jade (100 gp)", cost: "100 gp", type: "Gem"},
                {name: "Gem, Pearl (100 gp)", cost: "100 gp", type: "Gem"},
                {name: "Gem, Ruby (500 gp)", cost: "500 gp", type: "Gem"},
                {name: "Gem, Diamond (1,000 gp)", cost: "1,000 gp", type: "Gem"},
                {name: "Jeweler's Tools", cost: "25 gp", type: "Tool"}
            ],
            specialty: "Fine Jewelry & Gems",
            occupation: "Jeweler",
            personality: ["Meticulous and precise", "Paranoid about theft", "Appreciates beauty", "Greedy but fair"]
        },
        "Leatherworker": {
            inventory: [
                {name: "Leather Armor", cost: "10 gp", type: "Armor"},
                {name: "Studded Leather Armor", cost: "45 gp", type: "Armor"},
                {name: "Hide Armor", cost: "10 gp", type: "Armor"},
                {name: "Backpack", cost: "2 gp", type: "Gear"},
                {name: "Pouch", cost: "5 sp", type: "Gear"},
                {name: "Quiver", cost: "1 gp", type: "Gear"},
                {name: "Saddlebags", cost: "4 gp", type: "Gear"},
                {name: "Saddle, Riding", cost: "10 gp", type: "Gear"},
                {name: "Saddle, Military", cost: "20 gp", type: "Gear"},
                {name: "Belt", cost: "1 sp", type: "Gear"},
                {name: "Boots", cost: "1 gp", type: "Gear"},
                {name: "Leatherworker's Tools", cost: "5 gp", type: "Tool"}
            ],
            specialty: "Leather Armor & Goods",
            occupation: "Leatherworker",
            personality: ["Patient craftsman", "Smells of tanned leather", "Prefers practical over fancy", "Animal lover"]
        },
        "Tailor/Weaver": {
            inventory: [
                {name: "Clothes, Common", cost: "5 sp", type: "Clothing"},
                {name: "Clothes, Costume", cost: "5 gp", type: "Clothing"},
                {name: "Clothes, Fine", cost: "15 gp", type: "Clothing"},
                {name: "Clothes, Traveler's", cost: "2 gp", type: "Clothing"},
                {name: "Robes", cost: "1 gp", type: "Clothing"},
                {name: "Cloak", cost: "1 gp", type: "Clothing"},
                {name: "Blanket", cost: "5 sp", type: "Gear"},
                {name: "Weaver's Tools", cost: "1 gp", type: "Tool"},
                {name: "Sewing Needle", cost: "5 cp", type: "Gear"},
                {name: "Yarn (1 ball)", cost: "1 sp", type: "Gear"}
            ],
            specialty: "Clothing & Fabric",
            occupation: "Tailor",
            personality: ["Fashion-conscious", "Gossips constantly", "Critical eye for detail", "Dreams of dressing nobility"]
        },
        "Temple/Shrine": {
            inventory: [
                {name: "Holy Symbol (Amulet)", cost: "5 gp", type: "Holy Item"},
                {name: "Holy Symbol (Emblem)", cost: "5 gp", type: "Holy Item"},
                {name: "Holy Symbol (Reliquary)", cost: "5 gp", type: "Holy Item"},
                {name: "Holy Water (flask)", cost: "25 gp", type: "Holy Item"},
                {name: "Prayer Book", cost: "25 gp", type: "Book"},
                {name: "Incense (1 block)", cost: "1 gp", type: "Gear"},
                {name: "Censer", cost: "5 gp", type: "Gear"},
                {name: "Healer's Kit", cost: "5 gp", type: "Gear"},
                {name: "Healing Service (Lesser)", cost: "10 gp", type: "Service"},
                {name: "Healing Service (Greater)", cost: "50 gp", type: "Service"},
                {name: "Remove Curse Service", cost: "100 gp", type: "Service"},
                {name: "Raise Dead Service", cost: "500 gp", type: "Service"}
            ],
            specialty: "Religious Items & Services",
            occupation: "Priest",
            personality: ["Pious and devoted", "Offers blessings freely", "Judgmental of sinners", "Collects donations eagerly"]
        },
        "Scribe/Library": {
            inventory: [
                {name: "Book", cost: "25 gp", type: "Book"},
                {name: "Spellbook", cost: "50 gp", type: "Book"},
                {name: "Ink (1 oz bottle)", cost: "10 gp", type: "Gear"},
                {name: "Ink Pen", cost: "2 cp", type: "Gear"},
                {name: "Parchment (one sheet)", cost: "1 sp", type: "Gear"},
                {name: "Paper (one sheet)", cost: "2 sp", type: "Gear"},
                {name: "Scroll Case", cost: "1 gp", type: "Gear"},
                {name: "Calligrapher's Supplies", cost: "10 gp", type: "Tool"},
                {name: "Map or Scroll", cost: "5 gp", type: "Gear"},
                {name: "Sealing Wax", cost: "5 sp", type: "Gear"}
            ],
            specialty: "Books, Writing Supplies & Maps",
            occupation: "Scribe",
            personality: ["Intellectual and bookish", "Loves obscure knowledge", "Poor eyesight", "Hates damaged books"]
        },
        "Stable": {
            inventory: [
                {name: "Horse, Draft", cost: "50 gp", type: "Mount"},
                {name: "Horse, Riding", cost: "75 gp", type: "Mount"},
                {name: "Warhorse", cost: "400 gp", type: "Mount"},
                {name: "Pony", cost: "30 gp", type: "Mount"},
                {name: "Mule", cost: "8 gp", type: "Mount"},
                {name: "Saddle, Riding", cost: "10 gp", type: "Gear"},
                {name: "Saddle, Military", cost: "20 gp", type: "Gear"},
                {name: "Saddlebags", cost: "4 gp", type: "Gear"},
                {name: "Stabling (per day)", cost: "5 sp", type: "Service"},
                {name: "Feed (per day)", cost: "5 cp", type: "Gear"},
                {name: "Horseshoes", cost: "5 gp", type: "Gear"}
            ],
            specialty: "Mounts & Mount Equipment",
            occupation: "Stable Master",
            personality: ["Gruff animal handler", "Knows every horse by name", "Distrusts people, loves animals", "Smells strongly of hay"]
        },
        "Herbalist": {
            inventory: [
                {name: "Potion of Healing", cost: "50 gp", type: "Potion"},
                {name: "Antitoxin (vial)", cost: "50 gp", type: "Potion"},
                {name: "Herbalism Kit", cost: "5 gp", type: "Tool"},
                {name: "Healer's Kit", cost: "5 gp", type: "Gear"},
                {name: "Medicinal Herbs (bundle)", cost: "5 gp", type: "Gear"},
                {name: "Healing Salve", cost: "25 gp", type: "Consumable"},
                {name: "Sleeping Draught", cost: "10 gp", type: "Consumable"},
                {name: "Calming Tea", cost: "1 gp", type: "Consumable"}
            ],
            specialty: "Natural Remedies & Herbs",
            occupation: "Herbalist",
            personality: ["Knowledgeable about plants", "Lives on edge of town", "Distrusts city medicine", "Offers folk wisdom"]
        },
        "Cartographer": {
            inventory: [
                {name: "Map of Local Area", cost: "5 gp", type: "Map"},
                {name: "Map of Region", cost: "25 gp", type: "Map"},
                {name: "Dungeon Map", cost: "50 gp", type: "Map"},
                {name: "Navigator's Tools", cost: "25 gp", type: "Tool"},
                {name: "Cartographer's Tools", cost: "15 gp", type: "Tool"},
                {name: "Parchment (10 sheets)", cost: "1 gp", type: "Gear"},
                {name: "Ink (1 oz bottle)", cost: "10 gp", type: "Gear"},
                {name: "Map Case", cost: "1 gp", type: "Gear"}
            ],
            specialty: "Maps & Navigation Tools",
            occupation: "Cartographer",
            personality: ["Detail-oriented", "Well-traveled", "Loves geography", "Sells outdated maps cheap"]
        },
        "Tinker": {
            inventory: [
                {name: "Tinker's Tools", cost: "50 gp", type: "Tool"},
                {name: "Thieves' Tools", cost: "25 gp", type: "Tool"},
                {name: "Lock", cost: "10 gp", type: "Gear"},
                {name: "Manacles", cost: "2 gp", type: "Gear"},
                {name: "Bell", cost: "1 gp", type: "Gear"},
                {name: "Chain (10 feet)", cost: "5 gp", type: "Gear"},
                {name: "Crowbar", cost: "2 gp", type: "Tool"},
                {name: "Hammer", cost: "1 gp", type: "Tool"},
                {name: "Iron Spikes (10)", cost: "1 gp", type: "Gear"},
                {name: "Lantern, Bullseye", cost: "10 gp", type: "Gear"},
                {name: "Lantern, Hooded", cost: "5 gp", type: "Gear"},
                {name: "Oil (flask)", cost: "1 sp", type: "Gear"}
            ],
            specialty: "Tools & Mechanical Devices",
            occupation: "Tinker",
            personality: ["Ingenious inventor", "Always tinkering", "Sells oddities", "Half their items don't work"]
        },
        "Black Market": {
            inventory: [
                {name: "Thieves' Tools (Fine)", cost: "50 gp", type: "Tool"},
                {name: "Poison, Basic (vial)", cost: "80 gp", type: "Poison"},
                {name: "Poison, Assassin's Blood (vial)", cost: "150 gp", type: "Poison"},
                {name: "Poison, Midnight Tears (vial)", cost: "1,500 gp", type: "Poison"},
                {name: "Forgery Kit", cost: "15 gp", type: "Tool"},
                {name: "Disguise Kit", cost: "25 gp", type: "Tool"},
                {name: "Stolen Goods (misc.)", cost: "varies", type: "Contraband"},
                {name: "Smuggled Spellbook", cost: "200 gp", type: "Contraband"},
                {name: "Illegal Potion (unknown)", cost: "100 gp", type: "Potion"},
                {name: "Cursed Item (unknowing)", cost: "50 gp", type: "Contraband"},
                {name: "Forged Documents", cost: "75 gp", type: "Contraband"},
                {name: "Smoke Bomb", cost: "20 gp", type: "Gear"},
                {name: "Marked Cards / Loaded Dice", cost: "5 gp", type: "Gear"},
                {name: "Black Powder Flask", cost: "250 gp", type: "Contraband"},
                {name: "Wanted Poster (someone else's)", cost: "10 gp", type: "Contraband"},
                {name: "Unregistered Spellscroll", cost: "120 gp", type: "Scroll"}
            ],
            specialty: "Illicit Goods, Contraband & Forbidden Wares",
            occupation: "Black Market Fence",
            personality: ["Never gives their real name", "Always watching the exits", "Friendly only when profitable", "Will sell anyone out for the right price", "Speaks in veiled threats and euphemisms"]
        },
        "Enchanted Armoury": {
            inventory: [
                {name: "+1 Longsword", cost: "1,000 gp", type: "Magic Weapon"},
                {name: "+1 Shortsword", cost: "800 gp", type: "Magic Weapon"},
                {name: "+1 Battleaxe", cost: "900 gp", type: "Magic Weapon"},
                {name: "+1 Greataxe", cost: "1,100 gp", type: "Magic Weapon"},
                {name: "+1 Dagger", cost: "500 gp", type: "Magic Weapon"},
                {name: "+1 Longbow", cost: "1,000 gp", type: "Magic Weapon"},
                {name: "+2 Longsword", cost: "5,000 gp", type: "Magic Weapon"},
                {name: "+2 Greataxe", cost: "6,000 gp", type: "Magic Weapon"},
                {name: "Flame Tongue Sword", cost: "5,000 gp", type: "Magic Weapon"},
                {name: "Frost Brand Longsword", cost: "30,000 gp", type: "Magic Weapon"},
                {name: "Dragon Slayer Sword", cost: "6,000 gp", type: "Magic Weapon"},
                {name: "+1 Shield of Protection", cost: "1,500 gp", type: "Magic Armor"},
                {name: "+1 Chain Mail", cost: "1,500 gp", type: "Magic Armor"},
                {name: "+1 Plate Armor", cost: "3,000 gp", type: "Magic Armor"},
                {name: "Cloak of Protection", cost: "3,500 gp", type: "Wondrous Item"},
                {name: "Ring of Protection", cost: "3,500 gp", type: "Ring"}
            ],
            specialty: "Enchanted Weapons, Armor & Magic Items",
            occupation: "Enchanter",
            personality: ["Obsessed with magical theory", "Disdainful of mundane steel", "Haggles fiercely over price", "Knows the history of every piece"]
        },
        "The Shadow Dispensary": {
            inventory: [
                {name: "Poison, Basic (vial)", cost: "100 gp", type: "Poison"},
                {name: "Poison, Assassin's Blood", cost: "150 gp", type: "Poison"},
                {name: "Poison, Crawler Mucus", cost: "200 gp", type: "Poison"},
                {name: "Poison, Midnight Tears", cost: "1,500 gp", type: "Poison"},
                {name: "Poison, Pale Tincture", cost: "250 gp", type: "Poison"},
                {name: "Poison, Serpent Venom", cost: "200 gp", type: "Poison"},
                {name: "Poison, Truth Serum", cost: "150 gp", type: "Poison"},
                {name: "Poison, Torpor", cost: "600 gp", type: "Poison"},
                {name: "Poisoned Dagger (pre-coated)", cost: "300 gp", type: "Poison Weapon"},
                {name: "Poisoned Crossbow Bolts (5)", cost: "250 gp", type: "Poison Weapon"},
                {name: "Blowgun & Needles (10)", cost: "75 gp", type: "Weapon"},
                {name: "Garotte Wire", cost: "15 gp", type: "Weapon"},
                {name: "Disguise Kit", cost: "25 gp", type: "Tool"},
                {name: "Thieves' Tools (Fine)", cost: "50 gp", type: "Tool"},
                {name: "Smoke Pellet (x3)", cost: "30 gp", type: "Gear"},
                {name: "Dust of Disappearance", cost: "300 gp", type: "Gear"},
                {name: "Herbalism Kit (poisons focus)", cost: "25 gp", type: "Tool"},
                {name: "Antitoxin (vial)", cost: "50 gp", type: "Potion"}
            ],
            specialty: "Poisons, Assassination Tools & Covert Gear",
            occupation: "Shadow Apothecary",
            personality: ["Speaks barely above a whisper", "Never asks why you need it", "Has an antidote for every poison they sell", "Wears a veil at all times", "Disappears if guards are nearby"]
        },
        "Travelling Merchant": {
            inventory: [
                {name: "Exotic Spice Bundle", cost: "15 gp", type: "Trade Good"},
                {name: "Foreign Silk Bolt", cost: "40 gp", type: "Trade Good"},
                {name: "Rare Map Fragment", cost: "75 gp", type: "Curiosity"},
                {name: "Foreign Spirits (bottle)", cost: "12 gp", type: "Consumable"},
                {name: "Unusual Gemstone", cost: "50–200 gp", type: "Gem"},
                {name: "Ancient Coin Collection", cost: "30 gp", type: "Curiosity"},
                {name: "Caravan Wagon Lock (heavy)", cost: "20 gp", type: "Gear"},
                {name: "Rope, Elven Silk (50 ft)", cost: "25 gp", type: "Gear"},
                {name: "Potion of Healing", cost: "55 gp", type: "Potion"},
                {name: "Smoked Meats & Preserved Foods", cost: "8 gp", type: "Consumable"},
                {name: "Foreign Language Primer", cost: "18 gp", type: "Book"},
                {name: "Travel Cloak, Weathered Wool", cost: "10 gp", type: "Gear"},
                {name: "Weighted Dice (for cheating)", cost: "5 gp", type: "Curiosity"},
                {name: "Map of Nearby Region", cost: "25 gp", type: "Map"},
                {name: "Mystery Crate (unknown contents)", cost: "40 gp", type: "Curiosity"},
                {name: "Trinket from Far Lands", cost: "5–30 gp", type: "Curiosity"},
                {name: "Alchemist's Fire (flask)", cost: "50 gp", type: "Gear"},
                {name: "Diplomatic Letter of Passage", cost: "100 gp", type: "Document"}
            ],
            specialty: "Exotic Goods, Curiosities & Trade Items from Distant Lands",
            occupation: "Travelling Merchant",
            personality: ["Endlessly charming and well-traveled", "Has a story for every item they carry", "Shrewd negotiator, never gives first price", "Knows rumors from three kingdoms over", "Always looking over their shoulder slightly", "Generous with food and stories, tight with coin"]
        }
    }
};

/* =========================================
   BOUNTY BOARD DATA
   ========================================= */
const BOUNTY_BOARD_ALL = [
    /* ───────────── TIER 1: NOVICE (Levels 1–4) ───────────── */
    {
        id: "b101",
        title: "Pip Rattlecage, Rat-King of the Undercroft",
        poster: "Dead or Alive",
        reward: "80 gp",
        threat: "Low — Street Criminal with Gang Backup",
        crime: "Running a violent protection racket across Dockside market stalls. Three merchants who refused to pay had their stalls burned. One merchant — a halfling woman named Bessa — was beaten badly enough to lose her left eye.",
        description: "A wiry human male, early twenties. Missing front teeth, dirty-blond cropped hair, patched green coat with a caged-rat emblem sewn on the back. Commands a loose gang of six street toughs he calls the Cage. Frequents the Rusty Anchor tavern after sundown.",
        backstory: "Pip grew up in the Undercroft sewers after his family was evicted by a merchant guild landlord when he was nine. He never forgot the man's face — and that landlord now runs three of the stalls Pip extorts. He tells himself the protection money is justice. It stopped being justice the night Bessa lost her eye.",
        beware: "Cowardly alone but genuinely dangerous with gang backup — he will whistle to summon them the moment he feels threatened. Gang members are loyal through fear. Some may stand down if Pip is incapacitated first.",
        needs: "Alive preferred — he knows who runs the larger smuggling operation above him. Dead accepted at 50 gp. The local merchants will provide free lodging for one night if he is handed over without further damage to their stalls.",
        levelRange: [1, 3],
        isBoss: false,
        count: 1
    },
    {
        id: "b102",
        title: "The Forgery Ring of Millhaven",
        poster: "Alive Only — All Members",
        reward: "220 gp total",
        threat: "Low — Non-Violent but Destruction Risk",
        crime: "Counterfeiting city tax documents, merchant licenses, and property deeds across three towns. Over 40 forged documents distributed. Two innocent landowners already arrested for owning deeds the ring sold them.",
        description: "A trio: Carla Denn (human, middle-aged scribe, ink-stained fingers, sharp eyes), her nephew Wick (teenage boy, quick hands, never makes eye contact), and retired city clerk Oswyn Faulk (dwarf, balding, walks with a cane). Operate from a printshop on Coppergate Lane.",
        backstory: "Oswyn Faulk was a legitimate clerk for 30 years until a treasury auditor framed him for embezzlement to cover the auditor's own crimes. Faulk lost his career, his home, and his reputation. Carla took him in. The forgery ring started as a way to forge Faulk's credentials back — then the coin was too good to stop. Young Wick doesn't understand what they're doing. He thinks they make 'fancy papers for people who need them.'",
        beware: "Not combat-capable. However, if alarmed they will immediately destroy all evidence — a hidden furnace beneath the shop floor can incinerate everything within minutes. Approach silently. Do not alert anyone on Coppergate Lane before moving in.",
        needs: "All three alive — the court needs their testimony to free two wrongfully imprisoned landowners. Wick (the boy) has committed no crime and is to be released to the Temple of Mercy's orphan ward. The forging press must be recovered intact.",
        levelRange: [1, 4],
        isBoss: false,
        count: 3
    },
    {
        id: "b103",
        title: "Scratch, the Crossroads Highwayman",
        poster: "Dead or Alive",
        reward: "150 gp",
        threat: "Moderate — Expert Rider and Ambush Tactician",
        crime: "Armed robbery of six caravans on the South Fork Road over two months. Killed one caravan guard who drew his weapon. Has taken horses, coin, and goods worth approximately 800 gp.",
        description: "A tall half-elf with a thin scar bisecting her left eyebrow. Wide-brimmed road hat, dark riding leathers. Rides a grey-speckled mare named Coin. Works alone. Strikes at dusk on smaller caravans. Leaves a scratched X on every wagon she robs.",
        backstory: "Scratch — real name Ellara Vane — was a cavalry scout dismissed from the city guard without pay after a noble officer took credit for her work and had her discharged on invented insubordination charges. She has a young son in the city cared for by a neighbour. Every coin stolen goes toward buying passage north to start over. The guard she killed drew first. She replays it every night.",
        beware: "Expert rider and ambush tactician who will not engage in open terrain. Always attacks from treeline or ravines. Her mare Coin responds to whistled commands and will scatter pursuing horses. Retreats fast and cleanly.",
        needs: "Dead or alive. The merchant guild wants her stopped. The guard (quietly) wants her alive — the officer who discharged her is tied to larger corruption, and her testimony has value. Her son is not to be involved.",
        levelRange: [2, 4],
        isBoss: false,
        count: 1
    },
    {
        id: "b104",
        title: "The Grave Robbers of St. Aldric's",
        poster: "Alive Only",
        reward: "175 gp",
        threat: "Low — Non-Combat, Noxious Substance Risk",
        crime: "Systematic grave robbing at St. Aldric's cemetery. Seventeen graves disturbed in six weeks. Family heirlooms, burial jewellery, and in several cases the remains themselves have been taken. Three bereaved families have filed formal complaints with the Temple.",
        description: "A pair: Morrigan Ash (gnome, female, alchemist's apprentice, always carrying a bag that smells of preserving fluid) and Torvald Grix (orc, male, large build, surprisingly quiet and gentle, often humming to himself). Have a rented cellar somewhere in the Warrens.",
        backstory: "Morrigan is not selling the remains — she is studying them. She believes she is on the verge of discovering why some people are immune to a wasting plague that killed her entire family when she was seven. Torvald helps her because she cured his daughter of a painful skin condition two years ago and he owes her a debt he has never spoken aloud. Neither intended to cause grief. Both of them have stopped thinking about the families.",
        beware: "Not trained fighters. Morrigan carries alchemical compounds that produce noxious fumes — she will use them if cornered. Torvald is strong enough to be dangerous if he panics. Both will likely surrender if told their research will not be destroyed.",
        needs: "Both alive for questioning by the Temple. Remains must be returned and catalogued. If Morrigan's research notes can be preserved, the Temple of Healing has expressed interest — the plague she is studying has never been cured.",
        levelRange: [1, 3],
        isBoss: false,
        count: 2
    },
    {
        id: "b105",
        title: "Davan the Bloodless Fence",
        poster: "Alive Only",
        reward: "120 gp",
        threat: "Low — Well-Connected, No Direct Combat Ability",
        crime: "Known fence for stolen goods from seven confirmed thefts across the merchant district. Evidence links him to receiving a stolen Merchant Guild shipment manifest, a stolen noble family signet ring, and black-market healing supplies taken from a Temple relief wagon.",
        description: "A pallid, thin tiefling male in his late thirties, always impeccably dressed in black. Runs a legitimate antique shop called The Still Mirror on Weavers' Close. Polite to a fault. Never raises his voice. Small hands, long fingers, always fidgets with a jet-black ring.",
        backstory: "Davan was once an investigator for the Merchant Guild, hired specifically to track stolen goods. He was exceptionally good at it — and learned which fences were the most profitable and untouchable. When the Guild refused to promote him because of his tiefling heritage, he started working for the fences instead. He has never stolen anything himself. He will tell you this repeatedly.",
        beware: "No physical threat. However, he has blackmail material on at least two city watch officers who will tip him off if the Guard is mobilized. Do not approach through official channels. He will vanish within an hour of any official warrant being issued.",
        needs: "Alive only — he knows the names of the thieves and their buyers. The Guild wants the stolen manifest back above all else. A sealed envelope found in his safe is believed to contain the blackmail material on the watch officers — it is to be delivered unopened to the Lord Magistrate.",
        levelRange: [2, 4],
        isBoss: false,
        count: 1
    },
    /* ───────────── TIER 2: SEASONED (Levels 4–8) ───────────── */
    {
        id: "b201",
        title: "The Crimson Reaper",
        poster: "Dead or Alive",
        reward: "500 gp",
        threat: "Extremely Dangerous — Assassin-Class Combatant",
        crime: "Mass murder of a merchant caravan — slaughtered 12 guards and 4 merchants on the King's Road. Confirmed suspect in 3 prior roadside massacres totalling 31 dead over the past year.",
        description: "A scarred human male, mid-thirties, missing his left ear — severed during a childhood punishment by his own father. Last seen in a red-trimmed black cloak, wielding two shortswords. Travels alone. Uses the alias Kael Vorn in taverns.",
        backstory: "Kael Vorn was a militia soldier in border-town Ashford. A corrupt merchant lord named Dravus Holt falsely accused his father of theft and had him publicly hanged. Kael killed Holt, burned his estate — and the three servants inside it. He has since turned grief into profession, murdering merchants he believes embody the same rot that took his father. He carries his father's broken pocket watch and has never stopped hearing the crowd's laughter at the execution.",
        beware: "Exceptional speed and reflexes. Will flee when outnumbered and ambush the same hunters days later. Knows the King's Road better than the guards who patrol it. Has already killed two bounty hunters this season.",
        needs: "Body as proof, or alive for trial. His missing left ear and father's pocket watch are identifying markers. Alive delivery earns an extra 150 gp — the Lord wants a public confession before execution.",
        levelRange: [6, 10],
        isBoss: false,
        count: 1
    },
    {
        id: "b202",
        title: "The Hollow Coven",
        poster: "Dead or Alive",
        reward: "800 gp split",
        threat: "High — Multiple Spellcasters, Supernatural Threat",
        crime: "Kidnapping 11 villagers from three settlements for dark rituals. Two victims found dead, ritually drained of blood, eyes removed. Necromantic activity confirmed at the old Ashmill site.",
        description: "Three warlocks led by Seraphex — tall tiefling woman, silver hair, ritualistic burn scars across her palms. Two human brothers (Pol and Davan Mire) serve as bodyguards. All three wear matching iron amulets carved with a hollow eye symbol.",
        backstory: "Seraphex was once a devoted cleric who watched her entire order slaughtered during a failed exorcism. The demon she was trying to banish whispered that her goddess had abandoned her on purpose. She survived. Her faith did not. The brothers Pol and Davan are not evil men — they are desperate fathers whose daughters were taken by that same demon. Seraphex has promised to resurrect their children if they help complete the ritual. She is deceiving them.",
        beware: "They operate as a unit. Seraphex can summon a shadow demon at will. The brothers are heavily armored and will not negotiate. Most vulnerable in daylight — the ritual magic has made all three photosensitive. Do NOT engage at night near the old mill.",
        needs: "Eliminate the coven or capture Seraphex for interrogation. Bring her iron amulet and grimoire as proof. Each villager recovered alive earns an additional 50 gp from the Merchants' Guild. The brothers may be brought in alive — the Temple of Justice will consider their circumstances.",
        levelRange: [5, 9],
        isBoss: false,
        count: 3
    },
    {
        id: "b203",
        title: "The Ghost of Greymere",
        poster: "Dead or Alive",
        reward: "600 gp",
        threat: "High — Master Rogue, Poison User",
        crime: "Serial burglar turned murderer. Broke into seven noble estates. Killed three members of the Harwick family who caught them mid-burglary. Armed and extremely dangerous.",
        description: "An elf rogue of indeterminate gender. Slender, pale, moves without sound even on creaking boards. Nicknamed The Ghost — enters and exits locked buildings without a trace. Leaves a single dried flower at every scene.",
        backstory: "The Ghost was Lord Harwick's personal courier for seven years — until they overheard Harwick planning an assassination and reported it to the Guard. Harwick used his influence to have the Ghost's lover, a half-elf named Sable, arrested on fabricated charges and executed within a week. The Ghost watched from a rooftop and never spoke to a living soul again. The burglaries are not for money — they are methodically recovering documents that will expose Harwick's crimes. The three kills were family members who recognized them and would have ended everything.",
        beware: "Expertise-level stealth and lockpicking. Contact poison on blades with a 1-hour delayed onset — the wound will feel like nothing. Has at least three safehouses across the city. Not seen in daylight in two years.",
        needs: "Dead or alive. A crescent moon tattoo on their right inner forearm is definitive identification. The Guard will pay an additional 200 gp if brought in alive — they believe this person has evidence against Lord Harwick that the Guard itself cannot openly investigate.",
        levelRange: [5, 8],
        isBoss: false,
        count: 1
    },
    {
        id: "b204",
        title: "The Gilded Tongue",
        poster: "Alive Only",
        reward: "350 gp",
        threat: "Low Combat — Extreme Social Danger",
        crime: "Master con artist and forger active across five cities for six years. Has impersonated a duke, a bishop, a Royal Inspector, and two deceased merchants. Defrauded citizens of an estimated 40,000 gp total.",
        description: "A gnome bard operating under at least six known aliases. Most commonly appears as an elderly gentleman with silver hair, spectacles, and a carved walking cane. Master of disguise and voice mimicry. Current appearance entirely unknown.",
        backstory: "Born Pip Goldwhisper in the Undercity slums of Westmarch, he watched his mother die of a treatable illness because the noble physicians refused to treat non-humans without payment. He stole a noble's identity at age twelve to buy her medicine — too late, but it worked. He never stopped. Investigators found he donates most of his fraudulent gains to underground healing houses in slum districts. He has never physically harmed anyone. But the forged succession documents he holds could send two noble houses to war.",
        beware: "Exceptional Charisma magic — will attempt to charm, confuse, or recruit anyone who approaches. Has cultivated allies inside multiple city watches. Do not approach without magical countermeasure preparation. Will not fight. Will simply vanish.",
        needs: "Alive only — he is the only person who knows where the stolen noble succession documents are hidden. No reward for a corpse. The Council of Lords is privately offering an additional 200 gp to the hunter who delivers him without incident.",
        levelRange: [4, 7],
        isBoss: false,
        count: 1
    },
    {
        id: "b205",
        title: "Brother Malachar's Flock",
        poster: "Alive Only — Leadership Priority",
        reward: "1,200 gp total",
        threat: "High — Fanatical, Conditioned Against Fear and Pain",
        crime: "Doomsday cult responsible for poisoning the Millbridge water supply with a concentrated alchemical toxin. 30 ill; 6 dead including two children. Planning a mass ritual sacrifice — new moon is in 11 days.",
        description: "Brother Malachar: gaunt, pale human male in his fifties, tattered white robes with blackened-out sun stitching, unnatural golden eyes with no visible pupils. Five devoted followers — two clerics in defaced vestments, three fighters who act as enforcers. Preach openly in market squares.",
        backstory: "Aldric Malachar was a beloved and genuine cleric of the Sun God who ran a children's orphanage for thirty years. A plague swept through and killed nineteen of his orphans in a single week. He prayed without ceasing. No intervention came. The last child — a girl named Lena who called him Father — died in his arms. He walked out of the temple and never returned. He now believes the gods deliberately feed on suffering, and only by ending the world can the cycle be broken. His followers include two former orphans who follow him out of warped devotion, not fanaticism.",
        beware: "Malachar's healing magic has been repurposed to inflict necrotic damage on those he deems unworthy. His followers will not flee, will not surrender, and are conditioned against pain. Some may be victims themselves. Killing innocent, manipulated followers is not sanctioned by the Temple.",
        needs: "Malachar alive for urgent interrogation — he alone knows the ritual time and location. 600 gp for Malachar, 120 gp per follower (alive preferred). Time is critical.",
        levelRange: [6, 10],
        isBoss: false,
        count: 6
    },
    {
        id: "b206",
        title: "Rynn Ashveil, the Oathbreaker",
        poster: "Dead or Alive",
        reward: "750 gp",
        threat: "High — Former Paladin, Combat-Trained and Desperate",
        crime: "Murdered the High Paladin Commander of the Order of the Golden Shield — his own mentor and adoptive father — during a ceremony. Slew two additional paladins who intervened. Stole the sacred Oath Seal of the Order.",
        description: "Human male, late twenties, broad-shouldered, dark circles beneath his eyes from weeks without sleep. Wears deliberately defaced paladin armor with the golden symbols scratched away. Carries a longsword etched with cracked oath-runes pulsing faintly with shadow energy.",
        backstory: "Rynn was the Order's most decorated junior paladin, raised from age seven by Commander Aldos Vane after his village burned. He loved Vane like a father. Three months ago Rynn discovered a sealed vault of evidence showing Vane had accepted bribes for 15 years to suppress investigation of a noble family sheltering a demon incursion — an incursion that had killed hundreds of peasants attributed to disease. When confronted, Vane threatened to have Rynn imprisoned and called in two paladins to restrain him. Rynn killed all three in the struggle. He did not plan it. He has not slept properly since. He took the Oath Seal because he believes the Order's new leadership will be equally corrupt — not to profit from it.",
        beware: "Despite his broken emotional state, Rynn retains full paladin training and considerable combat ability. His shadow-corrupted sword suggests early warlock corruption from psychological collapse — he may use abilities he cannot fully control. Will not start a fight. Will finish one.",
        needs: "Dead or alive. The new Order Commander privately believes Rynn is telling the truth about Vane. Alive delivery plus return of the Oath Seal earns an unofficial 300 gp bonus from the Commander, off record.",
        levelRange: [7, 11],
        isBoss: false,
        count: 1
    },
    {
        id: "b207",
        title: "The Twice-Burned Witch",
        poster: "Dead or Alive",
        reward: "900 gp",
        threat: "Extremely Dangerous — Uncontrolled Pyromancy",
        crime: "Arson and mass murder. Burned the Merchant Quarter of Thornwall — 22 buildings, 18 dead, 40 injured. Burned two guardsmen alive with her bare hands. Suspected in two prior suspicious fires in neighbouring towns.",
        description: "A human woman, approximately forty, with burn scars covering the left side of her face and neck in patterns that suggest she survived being burned at the stake. Long auburn hair, wild-eyed. Always slightly warm to the touch — reported to radiate heat through walls. Carries a scorched wooden doll tied to her belt.",
        backstory: "Mira Solenn was a midwife accused of witchcraft by a jealous rival and mob-executed twelve years ago. The fire awakened dormant fire sorcery that had lain dormant in her bloodline for generations. She escaped scarred and alone. Her daughter Tess had been told her mother was a criminal and refused contact. The Merchant Quarter Mira burned housed the firm of the merchant who originally testified against her — still prospering, still respected. She set fire to everything he owned. Tess was in that building visiting a friend. Tess survived. But she saw her mother's face through the flames. The scorched doll belonged to Tess, left behind in the chaos. Mira has not slept since.",
        beware: "Pyromantic sorcery of considerable power. Fire-based spells are instinctive when she is emotionally destabilised — she can ignite nearby objects without intending to. Fire-resistant. Do NOT engage in enclosed or flammable environments. Do NOT mention her daughter's name.",
        needs: "Dead or alive. The Temple of Mercy privately offers an additional 200 gp if brought in alive — a priest named Father Corvin believes she is more victim than criminal and wants her testimony before any sentence. The scorched doll is her daughter's property and must be returned to Tess.",
        levelRange: [6, 10],
        isBoss: false,
        count: 1
    },
    {
        id: "b208",
        title: "The Pale Surgeon",
        poster: "Dead or Alive",
        reward: "1,100 gp",
        threat: "Extremely Dangerous — Calculated, Patient, Methodical",
        crime: "Murder of 9 confirmed victims across three cities. Victims found surgically dissected with specific organs removed and preserved in alchemical solution. Consistent medical precision across all cases. All victims connected to an abandoned healing college.",
        description: "Believed male gnome or halfling based on wound angles indicating very short reach with exceptional fine motor skill. Always wears gloves. Never leaves footprints. Victims are sedated before surgery begins — they feel nothing. Known to carry a fine leather surgeon's case.",
        backstory: "A decade ago, the Collegia Medica expelled six students for unauthorized corpse research. What was suppressed: their research was successful — they had developed a method to regenerate damaged organs using alchemical transplantation that could have saved thousands. The college destroyed their findings to protect the monopoly of healing guilds who funded it. All six lost their careers and futures. The nine victims are all people involved in that decision: professors, administrators, and the guild representatives who pressured the suppression. The Pale Surgeon is collecting organs from each victim — specifically the same organs each one specialized in studying. He is not insane. He has a list. There are three more names on it.",
        beware: "Extraordinarily patient and methodical. Leaves no evidence unless he chooses to. He finds you — you will not find him first. His sedative is delivered via touch through needles concealed in his gloves. Has evaded two prior capture attempts without being seen once.",
        needs: "Dead or alive. The City Medical Authority wants him alive — quietly — because physicians believe his original research findings, if recovered, could save thousands. Three identified future victims are under guard and could serve as lures. His surgeon's case must be recovered intact.",
        levelRange: [8, 12],
        isBoss: false,
        count: 1
    },
    {
        id: "b209",
        title: "Vane Hollowmask and the Stage-Blood Troupe",
        poster: "Dead or Alive — Multiple Targets",
        reward: "650 gp total",
        threat: "High — Skilled Combatants Disguised as Performers",
        crime: "A travelling theatre troupe operating as a cover for a string of targeted assassinations. Seven nobles and merchants across four cities have been found dead within a week of the troupe performing nearby. Method of death varies — poison, staged accidents, one victim drowned in a locked bath.",
        description: "Vane Hollowmask (human male, thirties, charismatic, always wearing theatrical face paint that serves as a genuine disguise) leads a troupe of six: two genuine actors who know nothing, and four trained killers who perform dual roles nightly. The troupe travels by painted wagon and performs popular historical plays.",
        backstory: "Vane is a former intelligence operative who was sold out by his handler and barely escaped execution. The troupe is a contract operation — he takes paid jobs from anonymous clients, never asking who or why. The two genuine actors (a young couple named Fen and Liria) have no idea what the others are. They believe they are touring with an eccentric but talented company. Fen and Liria are entirely innocent.",
        beware: "Four of the six members are trained assassins with varied combat specialties — blade, poison, illusion magic, and hand-to-hand. Vane himself is dangerously intelligent and was trained in counter-surveillance. The troupe will not stay in any city longer than three days. If they suspect they are being watched, they will abandon the wagon and disperse immediately.",
        needs: "Vane and the four killers dead or alive. Fen and Liria are to be released unharmed and informed of what they were unknowingly part of. The client list hidden in the wagon's false floor is of critical interest to the Crown's intelligence service.",
        levelRange: [5, 9],
        isBoss: false,
        count: 6
    },
    {
        id: "b210",
        title: "Ironjaw Bekka, the Debt Collector",
        poster: "Alive Only",
        reward: "480 gp",
        threat: "High — Veteran Fighter, Torture-Capable",
        crime: "Operating an illegal debt enforcement operation under no guild license. Three debtors have been tortured and permanently injured. One — a human male named Cort — had his right hand removed as a payment reminder. Two debtors are believed to be held captive at an unknown location.",
        description: "A dwarf woman, mid-forties, exceptionally strong, with a jaw visibly reinforced by a steel prosthetic after an old combat injury. Always wears heavy work gloves. Flat affect — rarely shows any emotion. Two hired muscle accompany her at all times.",
        backstory: "Bekka was once a licensed debt collector for the Merchant Guild — honest, efficient, and within the law. When the Guild was restructured and her license was revoked without explanation (replaced by the nephew of a Guild director who had a fraction of her experience), she went independent. The debtors she targets are people who genuinely borrowed money and refused to pay, often causing real harm to small lenders who couldn't absorb the loss. She crossed the line with Cort because he had borrowed from a widow who hadn't eaten properly in three weeks. She does not believe she crossed a line at all.",
        beware: "Veteran fighter with 20 years of enforcement experience. Her two muscle are skilled brawlers. She will not run. She will negotiate briefly and then fight if negotiation fails. The captive debtors are her leverage — find them before she realises they are at risk.",
        needs: "Alive only for full pay — the two captive debtors must be located and freed as part of the operation. Her ledger detailing all illegal enforcement operations is required by the Guild for legal proceedings. Partial pay of 200 gp if captured alive without the ledger.",
        levelRange: [4, 7],
        isBoss: false,
        count: 1
    },
    /* ───────────── TIER 3: VETERAN (Levels 7–12) ───────────── */
    {
        id: "b301",
        title: "Volgrak the Despoiler",
        poster: "Dead or Alive — BOSS BOUNTY",
        reward: "2,000 gp",
        threat: "LEGENDARY — Approach with Overwhelming Force",
        crime: "Razed the village of Edgewater — 34 civilians killed including children. Leads a warband of 30+ orcs. Holds 8 villagers hostage. Has raided 6 surrounding farmsteads in three weeks.",
        description: "An enormous orc barbarian, nearly 7 feet tall, covered in ritual scars commemorating every kill. Wears bone trophies stripped from victims — including the skull of Edgewater's magistrate — mounted on his belt. Wields an enchanted greataxe stolen from a fallen warrior king.",
        backstory: "Volgrak's entire clan was annihilated 17 years ago by a military campaign ordered by the very magistrate whose skull hangs from his belt. He survived at age twelve by hiding under the bodies of his kin for three days, found by an old shaman who raised him on vengeance. The warband is not simply raiding — Volgrak is systematically targeting the families of every officer who signed the original campaign order. He has a list. He is halfway through it. The hostages are kept alive as leverage, not for sport.",
        beware: "Legendary combatant. Berserker rage grants resistance to all non-magical damage. Multiple attacks per round with cleave capability. Four elite orc bodyguards who will die before permitting him to be surrounded. Suspected cursed artifact that partially absorbs spell effects. A prior six-person bounty hunting team was found three miles from Edgewater. None survived.",
        needs: "Kill on sight — the City Council has authorised lethal force. Bring his enchanted greataxe and kill-list scroll as proof of death. Bring the 8 hostages alive for full reward. Partial reward of 800 gp for the axe alone if hostages cannot be recovered.",
        levelRange: [10, 15],
        isBoss: true,
        count: 1
    },
    {
        id: "b302",
        title: "Lord Commander Grayden Voss — The Butcher of Brackwall",
        poster: "Dead or Alive — BOSS BOUNTY — Royal Warrant",
        reward: "3,500 gp",
        threat: "LEGENDARY — Decorated War Criminal, 30 Years Military Experience",
        crime: "War crimes. Ordered the deliberate slaughter of Brackwall — over 200 non-combatant civilians — under false claim of insurgent activity. Covered up evidence for three years. Now confirmed by surviving witnesses. Has fled into hiding with a loyal personal guard.",
        description: "Powerfully built human male, late fifties, cropped silver-grey hair, thick scar across his jaw. Rigid military posture even in hiding. Last seen near the Ironwood frontier dressed as a travelling merchant. Personal guard of four veteran fighters who served under him at Brackwall.",
        backstory: "Voss was a celebrated commander of three wars — a genuine hero by all prior accounts. At Brackwall, he received intelligence later proven to be fabricated by a rival noble that the town harboured an insurgent weapons cache. He gave the order without hesitation. By the time he reached the town himself and saw women and children among the dead, it was over. He spent three years in denial, then two years in private guilt severe enough that he began drinking heavily. When the truth emerged, he refused to surrender — not out of cowardice, but because he is convinced the rival noble who fabricated the intelligence will face no consequences while he alone carries the sentence. His four bodyguards lost family in the wars Voss previously saved them from. Their loyalty is absolute and genuine.",
        beware: "Thirty years of personal combat training and command experience. Despite his age, still physically formidable and tactically brilliant. Will not panic, will not make mistakes, will not hesitate. The four guards are coordinated veterans who have trained together for years and will take lethal action the instant Voss is threatened. At least one city watch captain is believed to be informing him of hunter movements.",
        needs: "Dead or alive. The Royal Court strongly prefers alive — they need his testimony to dismantle the rival noble's network. Sealed Crown warrant included — hunters are authorised to cross any national boundary in pursuit. Full payment on delivery to the Royal Court. Partial payment of 1,200 gp for confirmed death with evidence.",
        levelRange: [13, 18],
        isBoss: true,
        count: 1
    },
    {
        id: "b303",
        title: "Mareveth Sorn, the Poisoner of Courts",
        poster: "Dead or Alive",
        reward: "1,400 gp",
        threat: "Extremely Dangerous — Master Alchemist and Social Infiltrator",
        crime: "Suspected in the poisoning deaths of four minor nobles over two years. All deaths ruled natural until a persistent young city physician noticed identical trace compounds in three autopsies. Now confirmed homicide. One victim's family has posted additional private reward.",
        description: "A tiefling woman, late thirties, strikingly beautiful, moves in the highest social circles with forged credentials as a minor Countess. Always impeccably dressed. Never holds a cup or glass she has not personally poured. Has been seen at every victim's gathering in the weeks before their death.",
        backstory: "Mareveth's mother was a court alchemist who served a noble family loyally for twenty years. When the noble patriarch died, the family dismissed the mother without pension and reported her alchemy license as fraudulently obtained — a lie told purely to avoid paying her severance. The mother spent her last four years in poverty and died destitute. Mareveth has since spent twelve years infiltrating high society and poisoning the heirs of the four families who were present when that decision was made. She has already killed the heirs of three of the four families. One heir — a young woman named Thessaly, who was not yet born when her grandfather made the decision — is currently Mareveth's guest at a house party. She is the last name on the list.",
        beware: "Do not eat or drink anything in her presence under any circumstances. Her poisons have no taste, no colour, and no smell. She can administer them via physical contact. She is well-liked by every guard and servant in any house she occupies — they will protect her out of genuine affection. She will not fight. She will vanish into a crowd and never be seen again.",
        needs: "Dead or alive. Thessaly must be warned immediately — she may already have been dosed. The family of the third victim has posted an additional 400 gp private reward for her capture. Her alchemical formula book is of critical interest to the Healers' Guild as it contains undocumented compound interactions that could inform antidote research.",
        levelRange: [8, 12],
        isBoss: false,
        count: 1
    },
    {
        id: "b304",
        title: "The Thornwall Deserters",
        poster: "Dead or Alive — Military Warrant",
        reward: "900 gp total",
        threat: "High — Trained Soldiers with Military Equipment",
        crime: "Desertion in the face of the enemy during the Siege of Thornwall. Seven soldiers abandoned their posts at the eastern gatehouse at a critical moment — the breach that followed killed 14 of their comrades. They took military equipment including two enchanted crossbows when they fled.",
        description: "Seven soldiers of varying races and classes, all wearing modified versions of their military uniforms with insignia removed. They move together as a unit. Last seen heading toward the Thornwood border. They travel armed and have shown willingness to use violence when approached.",
        backstory: "The seven deserted because their commanding officer ordered them to hold a position he knew was tactically impossible — a suicide hold to buy time for a noble's private estate to be evacuated. Five of the seven are young recruits who had been in service less than three months. Two are veterans who watched their officer ride away from the gatehouse on a horse before issuing the hold order. They ran because they believed, correctly, that they were being ordered to die for a carpet and a chandelier. The 14 who died stayed because they trusted the order more than their instincts. The deserters have been unable to sleep since Thornwall.",
        beware: "Seven trained military combatants who move as a coordinated unit and are not looking to be taken without a fight. However, morale is fractured — several of the recruits have expressed regret and two are believed to be considering surrender. The veterans are the dangerous ones.",
        needs: "All seven dead or alive. The military court has issued a warrant. However, the city council has privately communicated that if evidence of the commanding officer's evacuation order can be produced, the charges may be reduced significantly. The two enchanted crossbows are military property and must be returned.",
        levelRange: [5, 9],
        isBoss: false,
        count: 7
    },
    {
        id: "b305",
        title: "Sister Corvath, the Healer's Ruin",
        poster: "Alive Only",
        reward: "1,000 gp",
        threat: "High — Healing Magic Subverted for Harm",
        crime: "A cleric posing as a wandering healer in rural villages who administers treatment that appears to cure but actually implants a slow-acting magical dependency. Victims begin showing deterioration 4–6 weeks after treatment, then seek her out again. She charges exponentially more each visit. Three villages are now effectively under her medical extortion. One elderly man died when his family could not afford the third treatment.",
        description: "A human woman, early fifties, genuinely warm manner, deeply calming presence. Dresses as a simple travelling sister of a minor healing order. Carries a white wooden staff with a carved sun-serpent symbol. Always accompanied by a young acolyte named Davin who believes everything she tells him.",
        backstory: "Sister Corvath was an exceptional and legitimate healer for twenty-five years. When her healing order was audited and she was accused of financial mismanagement — the mismanagement was actually committed by the order's treasurer, who framed her — she was stripped of her credentials and expelled. She spent three years trying to clear her name through proper channels before she stopped trying. The dependency magic came from a forbidden text she found in an abandoned library. She tells herself the villages benefit from the first treatment — and they do. She has never quite finished the thought that comes after that.",
        beware: "Her healing magic can be weaponised — she can cause intense physical pain through touch under the guise of examination. Young Davin, her acolyte, is entirely innocent but will physically defend her out of misplaced devotion. He must not be harmed.",
        needs: "Alive only — the Temple of Healing needs her methodology to develop a counter-treatment for the dependency. The three affected villages must be treated pro bono as part of the resolution. Davin is to be brought to the Temple for counselling and legitimate religious instruction. Her forbidden text must be recovered and sealed.",
        levelRange: [6, 9],
        isBoss: false,
        count: 1
    },
    {
        id: "b306",
        title: "The Merchant Prince of the Black Ledger",
        poster: "Alive Only — High-Value Capture",
        reward: "2,200 gp",
        threat: "Low Direct Combat — Extreme Financial and Political Danger",
        crime: "A wealthy tiefling merchant named Salcor Dren has been running a shadow trading network that has funnelled weapons to three separatist factions, triggered the collapse of two local banks, and is believed to have funded the assassination of a city alderman who was investigating him.",
        description: "Salcor Dren (tiefling male, fifties, impeccably groomed, always wearing deep blue silk and a single large ruby ring) operates from a fortified merchant tower in the Galleria district. Maintains a private guard force of twelve. Has connections in the city watch, the merchant guild, and rumoured connections to a foreign crown.",
        backstory: "Salcor Dren built his fortune through legitimate trade before his company was deliberately targeted and nearly destroyed by a guild monopoly action orchestrated by rivals. Rather than appeal through channels he knew were corrupt, he built his own shadow system — one that operates outside guild control entirely. He is not ideological. He is pragmatic. The three separatist factions he armed are each fighting the governments that enabled the guild monopoly that targeted him. The alderman who was assassinated had been in the pocket of those same guild rivals for a decade. He believes he is balancing scales. He is causing enormous collateral harm.",
        beware: "Salcor himself is not a fighter — he has never raised a hand in violence and likely never will. His twelve guards are professional and well-equipped. More dangerously, he has a network of informants across the city. Any official approach will be detected at least 48 hours before arrival. He has an escape plan. He has always had an escape plan.",
        needs: "Alive only — the city council needs his testimony and his Black Ledger (the encrypted record of every transaction, bribe, and assassination contract) to prosecute those who enabled him. The Ledger alone would implicate at least six guild directors and two city watch captains. Hunters who recover the Ledger alone will be paid 800 gp even if Dren escapes.",
        levelRange: [7, 11],
        isBoss: false,
        count: 1
    },
    /* ───────────── TIER 4: ELITE (Levels 10–16) ───────────── */
    {
        id: "b401",
        title: "The Archserpent — Cult of the Endless Scale",
        poster: "Dead or Alive — BOSS BOUNTY",
        reward: "4,000 gp",
        threat: "LEGENDARY — Ancient Dragonblood Sorcerer with Cult Army",
        crime: "The leader of the Cult of the Endless Scale has orchestrated the ritual destruction of two villages, the assassination of a regional governor, the theft of a sealed artifact from the Royal Vault, and is believed to be progressing toward a large-scale ritual that could permanently alter the local leyline network.",
        description: "Known only as the Archserpent. Dragonborn male of advanced age, scales the deep grey of old iron, eyes that shift colour depending on spell active. Always surrounded by cult enforcers — eight fanatically loyal disciples who have undergone bodily transformation rituals. Wears the stolen Royal Vault artifact as a breastplate clasp.",
        backstory: "The Archserpent was once Theraxis Vorn, court sorcerer to the previous king — a man who spent forty years in faithful service. When the king died and his heir took the throne, the new king had Theraxis arrested on false treason charges at the suggestion of a rival court sorcerer who wanted his position. Theraxis was imprisoned for three years, released only when one of his former students proved the charges fabricated — after the rival sorcerer had already taken his title, his laboratory, and his life's research. Theraxis emerged from prison with nothing, went into the wild, found the Cult of the Endless Scale — a fringe dragon-worship sect — and over the next fifteen years became its absolute leader. The ritual he is planning is not about power. It is about making it impossible for any government to ever trust its institutions again. He wants to break the structure itself.",
        beware: "Legendary sorcerer with decades of practical combat magic experience. His eight disciples have undergone blood ritual transformations giving each a draconic ability — breath weapons, scales, tail strikes, and in one case the ability to grow wings. The Archserpent himself has resistance to fire, cold, and lightning. He is not personally reckless — he fights from a distance with overwhelming magical force and retreats if losing. Do not pursue him into the cult compound without at least 6 capable fighters.",
        needs: "The Archserpent dead or alive (alive preferred for ritual knowledge interrogation). The stolen Royal Vault artifact must be recovered. All eight disciples are to be eliminated or captured — they cannot be allowed to continue the ritual without him. Full reward on delivery to the Crown's intelligence office.",
        levelRange: [13, 17],
        isBoss: true,
        count: 1
    },
    {
        id: "b402",
        title: "The Iron Widow",
        poster: "Dead or Alive",
        reward: "2,800 gp",
        threat: "Extremely Dangerous — Legendary Assassin, Unknown Identity",
        crime: "The Iron Widow is a contract assassin responsible for 23 confirmed kills across six kingdoms over eleven years. All targets were powerful individuals: three generals, a high bishop, two archmages, five guild masters, and numerous political figures. Current contract: believed to be targeting a senior member of the King's council.",
        description: "No confirmed physical description. Known to use every form of disguise, prosthetic, and magical alteration. The only consistent detail across witness accounts: she always leaves a single iron nail driven into a wooden surface at the scene. Gender confirmed female by one surviving witness. Estimated age 35–50. Exceptional at everything.",
        backstory: "No verified history. Intelligence suggests she was once a noble lady whose husband — a political figure — was assassinated by a contract killer hired by his rivals. The local guard closed the case without investigation because the rivals were wealthy. She spent seven years hunting the people responsible before she killed the last one. Then she found she was very good at it and someone was willing to pay her. She now operates on a strict personal code — she never takes contracts on children, never kills innocents, and will refund a contract if she discovers the client is corrupt in a way she finds worse than the target. She has refunded exactly four contracts in eleven years.",
        beware: "Do not attempt to tail, surveil, or make contact without assuming she already knows you are doing so. She will be aware of this bounty within days of its posting. There is a real possibility she is already watching the bounty hunter who takes this contract. She is not reckless — she will only engage if she has already won.",
        needs: "Dead or alive. The council member she is believed to be targeting must be immediately warned and moved to a secure location. Any information on her current contract client is of significant intelligence value — the Crown will pay an additional 1,000 gp for verified client identity regardless of the Iron Widow's fate.",
        levelRange: [12, 16],
        isBoss: false,
        count: 1
    },
    {
        id: "b403",
        title: "Durven Ashpyre, the Lich-in-Waiting",
        poster: "Dead or Alive — BOSS BOUNTY",
        reward: "3,200 gp",
        threat: "LEGENDARY — Necromancer Preparing Lichdom Ritual",
        crime: "Suspected of creating an undead army estimated at 60–80 corpses beneath the ruins of the Ashpyre estate. Confirmed to have murdered four gravediggers who discovered his operation. Believed to have stolen at least three living victims for use in the final stage of a Lich phylactery preparation ritual.",
        description: "Durven Ashpyre (human male, early sixties, prematurely white hair, deeply sunken eyes with faint necrotic glow, always wears black scholar's robes with elaborate silver embroidery). Former professor of theoretical necromancy at the Academica Arcana before he was expelled for conducting experiments on living students.",
        backstory: "Durven Ashpyre spent forty years studying death magic theoretically — writing the books that other necromancers read. He was never personally dangerous, just fascinatingly obsessed. His expulsion came when a student died in one of his practical seminars — an accident, most believe. What is not widely known is that Durven's wife, a brilliant arcanist named Sera, died of a mundane illness fifteen years ago — one that healing magic could have treated if they had reached the right temple in time. Durven has spent the fifteen years since working on a ritual that will allow him to use lichdom not for immortality or power, but to undo Sera's death. He genuinely believes he can reverse her death once he completes the transformation. The living victims he has taken are not cruelty — they are necessary ritual components, in his view. He has stopped seeing them as people.",
        beware: "Exceptional necromancer at or near the power threshold for lichdom — if he completes the ritual before capture, he will be vastly more difficult to eliminate. His undead army beneath the estate can be raised in minutes. He does not personally fight — he layers himself behind undead and animated constructs. The estate has magical traps throughout. Do not enter through the front.",
        needs: "Durven dead is acceptable but alive is strongly preferred — his accumulated necromantic knowledge is irreplaceable and of significant academic and military interest. The three living captives must be recovered. His current phylactery vessel (believed to be a silver hand mirror) must be destroyed or the ritual cannot be completed. Full reward on delivery to the Academica Arcana.",
        levelRange: [11, 15],
        isBoss: true,
        count: 1
    },
    {
        id: "b404",
        title: "The Glass Parliament",
        poster: "Alive Only — All Members",
        reward: "5,000 gp total",
        threat: "LEGENDARY — Shadow Government Cell, Multiple Elite Operatives",
        crime: "A secretive cabal of six individuals believed to be manipulating politics, trade, and law across the entire region through a combination of bribery, blackmail, assassination, and the strategic placement of their own agents in positions of power. Three confirmed deaths linked to their operations. The extent of their control is unknown — and terrifying.",
        description: "Six members, identities partially confirmed through two years of investigation. Known members: a retired admiral, a current guild mistress, a prominent physician, a court jester with unusual access, an anonymous robed figure known only as The Margin, and believed to include one unidentified member of the current city council.",
        backstory: "The Glass Parliament formed twenty years ago as a genuine reform movement — six civic-minded individuals who were disgusted by the corruption they saw in government and determined to fix it by operating outside it. Their early work was genuinely beneficial: they exposed three corrupt judges, dismantled a child-labour network, and prevented a fraudulent land seizure that would have displaced 200 families. Somewhere in the last decade, the line blurred. The deaths started. Each member individually believes their methods are still justified. None of them have spoken honestly with each other in years.",
        beware: "Six elite individuals with complementary skills, deep resources, and two decades of operational experience. They have failsafe protocols — if one member is captured, the others will know within hours and vanish. There is very likely a seventh member whose identity is entirely unknown. Do not move on any single member without ability to simultaneously prevent the others from being warned.",
        needs: "All six alive — their testimony is required to prosecute the 30+ officials they have compromised. The operation requires simultaneous capture. The Crown's intelligence service is coordinating and will brief hunters on individual member locations and habits upon acceptance. The unidentified council member must be identified — the Crown is offering an additional 2,000 gp for their identity confirmed with evidence.",
        levelRange: [14, 18],
        isBoss: true,
        count: 6
    },
    /* ───────────── TIER 5: LEGENDARY (Levels 15–20) ───────────── */
    {
        id: "b501",
        title: "Kethara the Undying, the Twice-Executed",
        poster: "Dead — Permanent Termination Required",
        reward: "6,000 gp",
        threat: "LEGENDARY — Confirmed Magical Resurrection Ability",
        crime: "A warlord who has been executed twice by the Crown — once by beheading, once by public burning — and has returned both times within the month. Has since destroyed two military outposts with a force of summoned celestial-corrupted creatures and slaughtered the 47 soldiers garrisoned there. Is currently marching on the border city of Halvenmere.",
        description: "A human woman, appears to be in her forties despite being sixty-two years of age. Exceptionally tall, white hair kept close-cropped, always wearing the scorched remnants of her execution shawl beneath armour. Commands creatures that appear angelic but are clearly corrupted — white feathers stained with dark ichor, halos cracked and inverted.",
        backstory: "Kethara spent her life as a devout paladin of the divine order, fighting genuine evil for thirty years. When her order was dissolved by a king who wanted their territory and properties, she appealed to the gods themselves for justice — and heard something answer. What answered was not a god. Whatever it was gave her the ability to return from death and the power to command beings that wear the faces of angels but carry something hollow inside them. She does not know what she made a pact with. She is no longer sure she cares. The king who dissolved her order died in his sleep six months after her first execution. She never confirmed whether she caused that death or not. She will not answer the question.",
        beware: "Has survived execution twice — conventional death will not end this bounty. The method of her resurrection is unknown. Hunters must identify and destroy her means of return before or during the kill, or she will simply come back. Her corrupted-celestial force is significant in both numbers and power. She fights with the capability of a legendary paladin who has had her moral constraints surgically removed.",
        needs: "Permanent termination. The Crown is providing access to the Royal Arcanist's sealed notes on her prior executions, which may suggest the nature of her resurrection mechanic. Full reward only on confirmation that her resurrection ability has been neutralised. A 1,000 gp advance is available upon acceptance for preparation costs.",
        levelRange: [16, 20],
        isBoss: true,
        count: 1
    },
    {
        id: "b502",
        title: "The Betrayer Archmage — Solvern the Unmade",
        poster: "Dead or Alive — Royal Warrant — Highest Priority",
        reward: "8,000 gp",
        threat: "LEGENDARY — Former Royal Archmage, Reality-Altering Power",
        crime: "Solvern the Unmade — former Royal Archmage — destroyed the city of Vethmark in a single night. Estimated 12,000 dead. He then erected a permanent spatial distortion field around the ruins that has prevented entry, recovery of remains, or magical investigation. Has since destroyed two military expeditions sent to investigate. The field has been expanding at a rate of half a mile per month for three months.",
        description: "A human male who appears to be in his thirties due to age-suppression magic but is confirmed to be ninety-four. Lean, sharp-featured, silver-white hair, eyes that have no whites — entirely deep violet. Wears robes that exist partially outside normal space — they trail into nothing at the edges. Carries no visible weapons.",
        backstory: "Solvern served the Crown faithfully for fifty years as Royal Archmage. His daughter — a young wizard named Callista — was recruited into the city of Vethmark's new magical research programme, which the Crown had funded. Three years ago, Solvern discovered that the programme had been secretly redirected by its corrupt director into weapons development using human test subjects. Callista was one of those subjects. He submitted evidence to the Crown and requested intervention. The Crown delayed for six months, then submitted the case to a council review process expected to take two additional years. Callista died in the programme four months into the review. Solvern spent one year in complete silence, destroyed the programme's director and three of his associates without leaving evidence, and then destroyed Vethmark in a single night precisely 365 days after Callista's death. He has not spoken since. He is still expanding the field. Nobody knows what is in the centre.",
        beware: "One of the most powerful mortal spellcasters alive. He is not fighting — he is building something. Interrupting whatever he is building inside the field is the primary objective. He has demonstrated the ability to restructure local reality in a radius around himself. Prior expeditions were not destroyed by direct combat — they were simply translated to locations unknown and never found. Do not engage without extensive magical preparation and anti-teleportation wards.",
        needs: "Alive strongly preferred — the Crown needs to know what he is building inside the field and whether it can be undone. Dead accepted if alive capture is impossible. A Royal Investigator will accompany any accepted hunting party with authority to negotiate if Solvern proves willing to communicate. The full 8,000 gp is only available alive. Dead delivery earns 3,000 gp.",
        levelRange: [17, 20],
        isBoss: true,
        count: 1
    },
    {
        id: "b503",
        title: "The Revenant General — Aldric Crone",
        poster: "Dead — Permanent Destruction Required",
        reward: "5,500 gp",
        threat: "LEGENDARY — Revenant, Undead, Cannot be Permanently Slain Without Special Method",
        crime: "General Aldric Crone — confirmed deceased for seven years — has returned as a revenant and has been systematically killing the surviving members of the war council that ordered the destruction of his regiment during the Battle of the Ashen Gate. Six council members dead. Two remain. He is close.",
        description: "Appears as he did in life: a stocky, heavily scarred human male in his late fifties, wearing the charred remnants of his general's dress uniform. His eyes emit a constant faint amber glow. He does not speak. He does not need to eat, sleep, or breathe. He only stops moving when he has killed.",
        backstory: "During the Battle of the Ashen Gate, General Crone's regiment of 800 soldiers was deliberately ordered to hold an exposed position as a tactical sacrifice — a decision made by the war council to save a more politically valuable unit. The regiment was destroyed. Crone survived by three hours, long enough to write a full account of the order and the context and seal it with his signet ring. He died of his wounds before he could send it. The account was found by a scribe, suppressed by a council member, and Crone was buried as a hero with full military honours. His regiment was listed as 'fallen gallantly.' Seven years later, Crone dug himself out of his grave with both hands.",
        beware: "A revenant cannot be permanently destroyed through conventional means — he will reform within 24 hours of apparent death. The specific method of permanent destruction for Crone's revenant state is unknown and must be researched before the hunt. A sage familiar with revenant lore has been retained by the city and will consult with accepted hunters. The two surviving council members are under guard but the guards are terrified and of uncertain reliability.",
        needs: "Permanent destruction of the revenant. The two surviving council members must be protected throughout. Notably: Crone's original account of the Battle of the Ashen Gate — if recovered from wherever he has preserved it — would constitute evidence of war crimes against the council members he is currently killing. The Crown is watching the legal implications carefully. Hunters who recover the account as well as permanently stopping Crone will receive an additional 1,500 gp.",
        levelRange: [15, 19],
        isBoss: true,
        count: 1
    },
    {
        id: "b504",
        title: "The Silence — No Known Name",
        poster: "Dead or Alive",
        reward: "10,000 gp",
        threat: "UNKNOWN — All Prior Witnesses Deceased",
        crime: "The entity known only as The Silence has been responsible for the complete disappearance of three towns over eighteen months. No bodies. No damage. No signs of struggle. Everything left exactly as it was — food still on tables, fires still burning — and then nothing. No one. The last town, Greywood, had 2,400 inhabitants.",
        description: "No confirmed description. The few survivors who have fled the perimeter of affected towns report seeing a figure at the town's edge before running — tall, featureless, making no sound whatsoever. Animals flee. Sound itself diminishes in its vicinity. Nothing else is known.",
        backstory: "Unknown. The Crown's arcane investigators have found no precedent in any documented bestiary, no parallel in any historical record, and no magical signature they can categorise. One investigator submitted a 40-page report and resigned the following morning, having apparently burned all personal copies of her notes. She has refused to discuss the case with anyone since.",
        beware: "Unknown. Every method of remote investigation — magical scrying, sending, divination — has returned nothing. The three towns remain on the map. Their interiors remain exactly preserved. Something is in them. No one who has entered has come back out. The Crown's arcane office has authorised the use of any means necessary.",
        needs: "Any confirmed intelligence on what The Silence is constitutes partial payment of 2,000 gp. Identified and neutralised earns the full 10,000 gp. Any hunters who accept this contract are strongly advised to prepare last will and testament documentation before departure. This is not a formality.",
        levelRange: [17, 20],
        isBoss: true,
        count: 1
    }
];

// Generate active board from all bounties (filtered by level if specified)
function getBountyPool(levelFilter) {
    if (!levelFilter) return [...BOUNTY_BOARD_ALL];
    const [minL, maxL] = levelFilter.split('-').map(Number);
    const filtered = BOUNTY_BOARD_ALL.filter(b => {
        const [bMin, bMax] = b.levelRange;
        return bMin <= maxL && bMax >= minL;
    });
    return filtered.length > 0 ? filtered : [...BOUNTY_BOARD_ALL];
}

// Shuffle and select bounties for the board
function buildActiveBountyBoard(pool, count = 6) {
    const shuffled = [...pool].sort(() => Math.random() - 0.5);
    return shuffled.slice(0, Math.min(count, shuffled.length));
}

let BOUNTY_BOARD = buildActiveBountyBoard(BOUNTY_BOARD_ALL);

/* =========================================
   BOUNTY ITEM REWARDS BY DIFFICULTY
   ========================================= */
const BOUNTY_ITEM_REWARDS = {
    tier1: [ // Levels 1-4 (Common/Uncommon)
        { name: "Potion of Healing", rarity: "common", type: "Potion", desc: "Regain 2d4+2 HP.", icon: "🧪" },
        { name: "Potion of Healing (x2)", rarity: "common", type: "Potion", desc: "Two healing potions.", icon: "🧪" },
        { name: "Rope of Climbing", rarity: "uncommon", type: "Wondrous", desc: "60ft magic rope that obeys commands.", icon: "🪢" },
        { name: "Bag of Holding", rarity: "uncommon", type: "Wondrous", desc: "Holds up to 500 lbs in a pocket dimension.", icon: "🎒" },
        { name: "+1 Shortsword", rarity: "uncommon", type: "Weapon", desc: "+1 bonus to attack and damage rolls.", icon: "⚔️" },
        { name: "Cloak of Protection", rarity: "uncommon", type: "Armour", desc: "+1 AC and saving throws while attuned.", icon: "🧥" },
        { name: "Eyes of the Eagle", rarity: "uncommon", type: "Wondrous", desc: "Advantage on Perception checks relying on sight.", icon: "👁️" },
        { name: "Boots of the Winterlands", rarity: "uncommon", type: "Wondrous", desc: "Resist cold, ignore difficult terrain from ice/snow.", icon: "👢" },
        { name: "Hat of Disguise", rarity: "uncommon", type: "Wondrous", desc: "Cast Disguise Self at will while wearing.", icon: "🎩" },
        { name: "Gloves of Missile Snaring", rarity: "uncommon", type: "Wondrous", desc: "Catch ranged weapon attacks as a reaction.", icon: "🧤" },
    ],
    tier2: [ // Levels 5-8 (Uncommon/Rare)
        { name: "Potion of Greater Healing", rarity: "uncommon", type: "Potion", desc: "Regain 4d4+4 HP.", icon: "🧪" },
        { name: "+1 Longsword", rarity: "uncommon", type: "Weapon", desc: "+1 bonus to attack and damage rolls.", icon: "⚔️" },
        { name: "+2 Leather Armour", rarity: "rare", type: "Armour", desc: "Leather armour with +2 AC bonus.", icon: "🛡️" },
        { name: "Wand of Fireballs", rarity: "rare", type: "Wand", desc: "7 charges — cast Fireball (DC 15). Regains 1d6+1 charges daily.", icon: "🪄" },
        { name: "Winged Boots", rarity: "uncommon", type: "Wondrous", desc: "Fly speed equal to walking speed, 4 hours per day.", icon: "👢" },
        { name: "Headband of Intellect", rarity: "uncommon", type: "Wondrous", desc: "Intelligence score becomes 19 while attuned.", icon: "🎗️" },
        { name: "Gauntlets of Ogre Power", rarity: "uncommon", type: "Wondrous", desc: "Strength score becomes 19 while attuned.", icon: "🧤" },
        { name: "Ring of Feather Falling", rarity: "rare", type: "Ring", desc: "Fall gently at 60ft/round, take no fall damage.", icon: "💍" },
        { name: "Bracers of Archery", rarity: "uncommon", type: "Wondrous", desc: "+2 to damage rolls with longbows and shortbows.", icon: "🏹" },
        { name: "Staff of Healing (3 charges)", rarity: "rare", type: "Staff", desc: "Spend charges to cast Cure Wounds, Lesser Restoration, or Mass Cure Wounds.", icon: "🪄" },
    ],
    tier3: [ // Levels 9-12 (Rare)
        { name: "Potion of Superior Healing", rarity: "rare", type: "Potion", desc: "Regain 8d4+8 HP.", icon: "🧪" },
        { name: "+2 Longsword", rarity: "rare", type: "Weapon", desc: "+2 bonus to attack and damage rolls.", icon: "⚔️" },
        { name: "+2 Chain Mail", rarity: "rare", type: "Armour", desc: "Chain mail with +2 AC bonus.", icon: "🛡️" },
        { name: "Flame Tongue Greatsword", rarity: "rare", type: "Weapon", desc: "On command, blade erupts in flame. +2d6 fire damage, sheds bright light.", icon: "🗡️" },
        { name: "Ring of Spell Storing", rarity: "rare", type: "Ring", desc: "Stores up to 5 levels of spells, cast by anyone holding the ring.", icon: "💍" },
        { name: "Mantle of Spell Resistance", rarity: "rare", type: "Armour", desc: "Advantage on saving throws against spells while attuned.", icon: "🧥" },
        { name: "Necklace of Fireballs", rarity: "rare", type: "Wondrous", desc: "1d6+3 beads, each explodes as Fireball (DC 15, 10d6).", icon: "📿" },
        { name: "Wand of Lightning Bolts", rarity: "rare", type: "Wand", desc: "7 charges — cast Lightning Bolt (DC 15). Regains 1d6+1 charges daily.", icon: "🪄" },
        { name: "Amulet of Health", rarity: "rare", type: "Wondrous", desc: "Constitution score becomes 19 while attuned.", icon: "📿" },
        { name: "Belt of Giant Strength (Hill)", rarity: "rare", type: "Wondrous", desc: "Strength score becomes 21 while attuned.", icon: "🎗️" },
    ],
    tier4: [ // Levels 13-16 (Rare/Very Rare)
        { name: "Potion of Supreme Healing", rarity: "very rare", type: "Potion", desc: "Regain 10d4+20 HP.", icon: "🧪" },
        { name: "+3 Longsword", rarity: "very rare", type: "Weapon", desc: "+3 bonus to attack and damage rolls.", icon: "⚔️" },
        { name: "+3 Plate Armour", rarity: "very rare", type: "Armour", desc: "Plate armour with +3 AC bonus.", icon: "🛡️" },
        { name: "Defender Longsword", rarity: "legendary", type: "Weapon", desc: "Transfer attack bonus to AC as a bonus action. +3 attack/damage base.", icon: "🗡️" },
        { name: "Robe of the Archmagi", rarity: "legendary", type: "Armour", desc: "+2 AC, spell save DC +2, advantage vs spells, regain sorcery points daily.", icon: "🧥" },
        { name: "Tome of Clear Thought", rarity: "very rare", type: "Wondrous", desc: "Permanently increase Intelligence by 2 (max 24).", icon: "📖" },
        { name: "Ring of Regeneration", rarity: "very rare", type: "Ring", desc: "Regain 1d6 HP every 10 minutes. Regrow lost limbs in 1d6+1 days.", icon: "💍" },
        { name: "Vorpal Sword", rarity: "legendary", type: "Weapon", desc: "On a natural 20, sever a limb or behead the target outright.", icon: "🗡️" },
        { name: "Cloak of Invisibility", rarity: "legendary", type: "Wondrous", desc: "Become invisible while wearing, for up to 2 hours total per day.", icon: "🧥" },
        { name: "Staff of Power", rarity: "very rare", type: "Staff", desc: "+2 AC/attacks/damage, 20 charges for powerful spells. Break for retributive strike.", icon: "🪄" },
    ],
    boss: [ // Boss bounties (Legendary)
        { name: "Holy Avenger Longsword", rarity: "legendary", type: "Weapon", desc: "+3, +2d10 radiant vs undead/fiends. Aura grants advantage vs spells to allies within 10ft.", icon: "⚔️" },
        { name: "Armor of Invulnerability", rarity: "legendary", type: "Armour", desc: "Resistance to non-magical damage. Once/day: immunity to non-magical damage for 10 min.", icon: "🛡️" },
        { name: "Ring of Three Wishes", rarity: "legendary", type: "Ring", desc: "3 charges — cast Wish. Ring crumbles when all charges are used.", icon: "💍" },
        { name: "Deck of Many Things", rarity: "legendary", type: "Wondrous", desc: "Draw a card for miraculous or catastrophic fate. 13 or 22 cards.", icon: "🃏" },
        { name: "Sphere of Annihilation", rarity: "legendary", type: "Wondrous", desc: "2ft diameter void that annihilates everything it touches. Controlled telepathically.", icon: "⚫" },
        { name: "Tome of the Stilled Tongue", rarity: "legendary", type: "Wondrous", desc: "Spellbook with 3 extra spell slots and bonus spells. Linked to Vecna.", icon: "📖" },
        { name: "Eye of Vecna", rarity: "artifact", type: "Artifact", desc: "Replace your eye with this to gain truesight, ESP, and terrifying new powers. The cost is terrible.", icon: "👁️" },
        { name: "Hand of Vecna", rarity: "artifact", type: "Artifact", desc: "Replace your hand for +2d8 cold damage, cone of cold, and other dark gifts.", icon: "🖐️" },
        { name: "Blackrazor Greatsword", rarity: "legendary", type: "Weapon", desc: "+3, absorbs souls of those it slays to grant power. Has its own will. Craves life force.", icon: "🗡️" },
        { name: "Ioun Stone of Greater Absorption", rarity: "legendary", type: "Wondrous", desc: "Orbits your head. Absorbs spell levels as a reaction. Holds up to 50 levels total.", icon: "🔮" },
    ]
};

function getBountyItemReward(bounty) {
    const avgLevel = Math.round((bounty.levelRange[0] + bounty.levelRange[1]) / 2);
    let pool;
    if (bounty.isBoss) pool = BOUNTY_ITEM_REWARDS.boss;
    else if (avgLevel <= 4) pool = BOUNTY_ITEM_REWARDS.tier1;
    else if (avgLevel <= 8) pool = BOUNTY_ITEM_REWARDS.tier2;
    else if (avgLevel <= 12) pool = BOUNTY_ITEM_REWARDS.tier3;
    else pool = BOUNTY_ITEM_REWARDS.tier4;
    // Pick 1-2 items based on difficulty
    const count = bounty.isBoss ? 2 : (avgLevel >= 9 ? 2 : 1);
    const shuffled = [...pool].sort(() => Math.random() - 0.5);
    return shuffled.slice(0, count);
}

const RARITY_COLORS = {
    common: '#9d9d9d',
    uncommon: '#1eff00',
    rare: '#0070dd',
    'very rare': '#a335ee',
    legendary: '#ff8000',
    artifact: '#e6cc80'
};


function calculateSpellSlots(level, casterClass) {
    const isFullCaster = ["Wizard", "Cleric", "Sorcerer", "Bard", "Druid"].includes(casterClass);
    const isHalfCaster = ["Paladin", "Ranger"].includes(casterClass);
    const isWarlock = casterClass === "Warlock";
    
    if (isWarlock) {
        // Warlock Pact Magic progression
        let slots, slotLevel;
        if (level === 1) { slots = 1; slotLevel = 1; }
        else if (level >= 2 && level <= 10) { slots = 2; slotLevel = Math.ceil(level / 2); }
        else if (level >= 11 && level <= 16) { slots = 3; slotLevel = 5; }
        else { slots = 4; slotLevel = 5; } // 17-20
        
        return {
            type: "pact",
            slots: Array(slots).fill(slotLevel),
            maxSlots: slots,
            currentSlots: slots,
            slotLevel: slotLevel
        };
    }
    
    if (isHalfCaster) {
        const effectiveLevel = Math.ceil(level / 2);
        if (effectiveLevel < 1) return null;
        return getStandardSlots(effectiveLevel, 5);
    }
    
    if (isFullCaster) {
        return getStandardSlots(level, 9);
    }
    
    return null;
}

function getStandardSlots(level, maxSpellLevel) {
    // Official D&D 5E spell slot table
    const slotsTable = {
        1: [2], 
        2: [3], 
        3: [4, 2], 
        4: [4, 3], 
        5: [4, 3, 2],
        6: [4, 3, 3], 
        7: [4, 3, 3, 1], 
        8: [4, 3, 3, 2], 
        9: [4, 3, 3, 3, 1],
        10: [4, 3, 3, 3, 2], 
        11: [4, 3, 3, 3, 2, 1], 
        12: [4, 3, 3, 3, 2, 1],
        13: [4, 3, 3, 3, 2, 1, 1], 
        14: [4, 3, 3, 3, 2, 1, 1],
        15: [4, 3, 3, 3, 2, 1, 1, 1], 
        16: [4, 3, 3, 3, 2, 1, 1, 1],
        17: [4, 3, 3, 3, 2, 1, 1, 1, 1], 
        18: [4, 3, 3, 3, 3, 1, 1, 1, 1],
        19: [4, 3, 3, 3, 3, 2, 1, 1, 1], 
        20: [4, 3, 3, 3, 3, 2, 2, 1, 1]
    };
    
    const available = slotsTable[Math.min(20, level)] || [0];
    const slots = {};
    
    for (let i = 0; i < Math.min(available.length, maxSpellLevel); i++) {
        slots[i + 1] = {
            max: available[i],
            current: available[i]
        };
    }
    
    const totalSlots = available.slice(0, maxSpellLevel).reduce((a, b) => a + b, 0);
    
    return {
        type: "standard",
        slots: slots,
        maxSlots: totalSlots,
        currentSlots: totalSlots
    };
}

/* =========================================
   SPELL SELECTION - CLASS APPROPRIATE
   ========================================= */
function selectSpellsForClass(classKey, level, spellAbility, subclassData) {
    const spellList = [];
    
    // Determine max spell level based on character level AND class type
    const cDataRef = DB.classes[classKey] || {};
    const isFullCaster = ["Wizard", "Cleric", "Sorcerer", "Bard", "Druid"].includes(classKey)
        || (cDataRef.spellcasting && !["Paladin","Ranger","Warlock"].includes(classKey) && cDataRef.casterType !== 'half');
    const isHalfCaster = ["Paladin", "Ranger"].includes(classKey)
        || (cDataRef.spellcasting && cDataRef.casterType === 'half');
    const isWarlock = classKey === "Warlock";
    
    let maxSpellLevel = 0;
    
    if (isHalfCaster) {
        // Half-casters max at 5th level spells
        const effectiveLevel = Math.ceil(level / 2);
        if (effectiveLevel >= 1) maxSpellLevel = 1;
        if (effectiveLevel >= 3) maxSpellLevel = 2;
        if (effectiveLevel >= 5) maxSpellLevel = 3;
        if (effectiveLevel >= 7) maxSpellLevel = 4;
        if (effectiveLevel >= 9) maxSpellLevel = 5;
    } else if (isWarlock) {
        // Warlock pact magic progression
        if (level >= 1) maxSpellLevel = 1;
        if (level >= 3) maxSpellLevel = 2;
        if (level >= 5) maxSpellLevel = 3;
        if (level >= 7) maxSpellLevel = 4;
        if (level >= 9) maxSpellLevel = 5;
    } else if (isFullCaster) {
        // Full casters can go up to 9th
        if (level >= 1) maxSpellLevel = 1;
        if (level >= 3) maxSpellLevel = 2;
        if (level >= 5) maxSpellLevel = 3;
        if (level >= 7) maxSpellLevel = 4;
        if (level >= 9) maxSpellLevel = 5;
        if (level >= 11) maxSpellLevel = 6;
        if (level >= 13) maxSpellLevel = 7;
        if (level >= 15) maxSpellLevel = 8;
        if (level >= 17) maxSpellLevel = 9;
    }
    
    // Collect available spells up to max level
    let availableSpells = [];
    for (let i = 0; i <= maxSpellLevel; i++) {
        if (DB.spells[i === 0 ? 'cantrip' : i]) {
            availableSpells = availableSpells.concat(DB.spells[i === 0 ? 'cantrip' : i]);
        }
    }
    
    // Number of spells known
    const cantripCount = Math.min(level >= 10 ? 4 : level >= 4 ? 3 : 2, DB.spells.cantrip.length);
    const spellCount = Math.min(3 + Math.floor(level / 2), availableSpells.length - cantripCount);
    
    // Select cantrips
    const selectedCantrips = [];
    const cantrips = [...DB.spells.cantrip];
    
    // Warlocks always get Eldritch Blast
    if (classKey === 'Warlock') {
        const eldritchBlast = cantrips.find(s => s.name === 'Eldritch Blast');
        if (eldritchBlast) {
            selectedCantrips.push(eldritchBlast);
            cantrips.splice(cantrips.indexOf(eldritchBlast), 1);
        }
    }
    
    for (let i = selectedCantrips.length; i < cantripCount && cantrips.length > 0; i++) {
        const idx = Math.floor(Math.random() * cantrips.length);
        selectedCantrips.push(cantrips.splice(idx, 1)[0]);
    }
    
    // Select leveled spells (only up to maxSpellLevel)
    const selectedSpells = [];
    const leveledSpells = availableSpells.filter(s => s.level > 0 && s.level <= maxSpellLevel);
    for (let i = 0; i < spellCount && leveledSpells.length > 0; i++) {
        const idx = Math.floor(Math.random() * leveledSpells.length);
        const spell = leveledSpells.splice(idx, 1)[0];
        if (!selectedSpells.find(s => s.name === spell.name)) {
            selectedSpells.push(spell);
        }
    }
    
    // Inject domain/oath/patron/circle spells (always included)
    const domainSpells = (subclassData && subclassData.domainSpells) ? subclassData.domainSpells : [];
    // Remove domain spells from general pool to avoid duplicates
    const domainNames = new Set(domainSpells.map(s => s.name));
    const filteredCantrips = selectedCantrips.filter(s => !domainNames.has(s.name));
    const filteredLeveled = selectedSpells.filter(s => !domainNames.has(s.name));
    return [...domainSpells, ...filteredCantrips, ...filteredLeveled];
}

/* =========================================
   HOMEBREW MANAGER
   ========================================= */
const HB_STORAGE_KEY = 'dm_homebrew_packages_v1';
window._hbState = window._hbState || { packages: [] };
window._hbBaseDB = window._hbBaseDB || null;
window._hbPendingImport = window._hbPendingImport || null;

function hbClone(v) {
    try { return JSON.parse(JSON.stringify(v)); } catch(e) { return v; }
}

function hbEnsureDBShape() {
    if (!window.DB || typeof DB !== 'object') window.DB = {};
    DB.races = (DB.races && typeof DB.races === 'object') ? DB.races : {};
    DB.names = (DB.names && typeof DB.names === 'object') ? DB.names : {};
    DB.classes = (DB.classes && typeof DB.classes === 'object') ? DB.classes : {};
    DB.subclasses = (DB.subclasses && typeof DB.subclasses === 'object') ? DB.subclasses : {};
    DB.subclassSpells = (DB.subclassSpells && typeof DB.subclassSpells === 'object') ? DB.subclassSpells : {};
    DB.spells = (DB.spells && typeof DB.spells === 'object') ? DB.spells : {};
    DB.allWeapons = Array.isArray(DB.allWeapons) ? DB.allWeapons : [];
    DB.allArmor = Array.isArray(DB.allArmor) ? DB.allArmor : [];
    DB.homebrewItems = Array.isArray(DB.homebrewItems) ? DB.homebrewItems : [];
    DB.homebrewFeatures = Array.isArray(DB.homebrewFeatures) ? DB.homebrewFeatures : [];
    DB.homebrewSkills = Array.isArray(DB.homebrewSkills) ? DB.homebrewSkills : [];
}

function hbEmptyData() {
    return { classes:[], subclasses:[], races:[], items:[], weapons:[], armor:[], spells:[], features:[], skills:[] };
}

function hbNewPackage(name, source) {
    return {
        id: 'hb_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,7),
        name: (name || ('Homebrew ' + new Date().toLocaleString())),
        source: source || 'manual',
        enabled: true,
        createdAt: Date.now(),
        data: hbEmptyData()
    };
}

function hbEnsureBaseDBSnapshot() {
    hbEnsureDBShape();
    if (window._hbBaseDB) return;
    window._hbBaseDB = hbClone({
        races: DB.races,
        names: DB.names,
        classes: DB.classes,
        subclasses: DB.subclasses,
        subclassSpells: DB.subclassSpells,
        spells: DB.spells,
        allWeapons: DB.allWeapons || [],
        allArmor: DB.allArmor || []
    });
}

function hbSavePackages() {
    localStorage.setItem(HB_STORAGE_KEY, JSON.stringify(window._hbState.packages || []));
}

function hbLoadPackages() {
    var arr = [];
    try { arr = JSON.parse(localStorage.getItem(HB_STORAGE_KEY) || '[]'); } catch(e) { arr = []; }
    if (!Array.isArray(arr)) arr = [];
    window._hbState.packages = arr.map(function(p){
        p = p || {};
        p.data = p.data || hbEmptyData();
        Object.keys(hbEmptyData()).forEach(function(k){ if (!Array.isArray(p.data[k])) p.data[k] = []; });
        if (typeof p.enabled !== 'boolean') p.enabled = true;
        if (!p.id) p.id = 'hb_' + Math.random().toString(36).slice(2,9);
        if (!p.name) p.name = 'Homebrew Package';
        return p;
    });
    hbMergeDuplicatePackages();
}

function hbMergeDuplicatePackages() {
    var seen = {};
    var merged = [];
    (window._hbState.packages || []).forEach(function(p){
        var key = String((p && p.name) || '').trim().toLowerCase() + '|' + String((p && p.source) || 'manual').trim().toLowerCase();
        if (!seen[key]) {
            seen[key] = hbClone(p);
            merged.push(seen[key]);
            return;
        }
        var target = seen[key];
        target.enabled = !!(target.enabled || p.enabled);
        var keys = Object.keys(hbEmptyData());
        keys.forEach(function(k){
            var add = Array.isArray((p.data || {})[k]) ? (p.data || {})[k] : [];
            if (!Array.isArray(target.data[k])) target.data[k] = [];
            add.forEach(function(entry){
                var nm = String((entry && entry.name) || entry || '').trim().toLowerCase();
                if (!nm) return;
                var exists = target.data[k].some(function(x){ return String((x && x.name) || x || '').trim().toLowerCase() === nm; });
                if (!exists) target.data[k].push(entry);
            });
        });
    });
    window._hbState.packages = merged;
}

function hbNormClass(c) {
    c = c || {};
    return {
        name: String(c.name || '').trim(),
        hd: parseInt(c.hd, 10) || 8,
        save: Array.isArray(c.save) && c.save.length ? c.save.slice(0,2) : ['STR','CON'],
        weps: Array.isArray(c.weps) && c.weps.length ? c.weps.slice() : ['Longsword'],
        armor: String(c.armor || 'Leather Armor'),
        skills: Array.isArray(c.skills) ? c.skills.slice() : [],
        features: Array.isArray(c.features) ? c.features.map(function(f){
            if (typeof f === 'string') return { name: f, desc: '' };
            return { name: String((f||{}).name || 'Feature'), desc: String((f||{}).desc || '') };
        }) : [],
        spellcasting: !!c.spellcasting,
        spellAbility: c.spellAbility || null,
        casterType: c.casterType || null
    };
}

function hbNormRace(r) {
    r = r || {};
    var mod = (r.mod && typeof r.mod === 'object') ? r.mod : { all: 1 };
    var male = Array.isArray((r.names||{}).male) ? r.names.male : ['Arin','Doran','Kael'];
    var female = Array.isArray((r.names||{}).female) ? r.names.female : ['Lyra','Mira','Selene'];
    return {
        name: String(r.name || '').trim(),
        mod: mod,
        speed: parseInt(r.speed, 10) || 30,
        desc: String(r.desc || 'Homebrew ancestry.'),
        look: Array.isArray(r.look) && r.look.length ? r.look.slice() : ['distinctive homebrew traits'],
        names: { male: male, female: female }
    };
}

function hbNormSubclass(s) {
    s = s || {};
    return {
        name: String(s.name || '').trim(),
        className: String(s.className || s.class || '').trim(),
        unlockLevel: parseInt(s.unlockLevel, 10) || 3,
        features: Array.isArray(s.features) ? s.features.map(function(f){
            if (typeof f === 'string') return { level: 3, name: f, desc: '' };
            return { level: parseInt((f||{}).level, 10) || 3, name: String((f||{}).name || 'Subclass Feature'), desc: String((f||{}).desc || '') };
        }) : [],
        domainSpells: Array.isArray(s.domainSpells) ? s.domainSpells : [],
        grantsSpellcasting: !!s.grantsSpellcasting
    };
}

function hbNormalizeSubclassSpellTiers(domainSpells) {
    if (!Array.isArray(domainSpells) || !domainSpells.length) return [];
    var isTiered = domainSpells.every(function(t){ return t && typeof t === 'object' && Array.isArray(t.spells); });
    if (isTiered) {
        return domainSpells.map(function(t){
            var minLevel = parseInt((t || {}).minLevel, 10);
            if (isNaN(minLevel) || minLevel < 1) minLevel = 1;
            var spells = Array.isArray(t.spells) ? t.spells.map(hbNormSpell).filter(function(sp){ return sp.name; }) : [];
            return { minLevel: minLevel, spells: spells };
        }).filter(function(t){ return t.spells.length > 0; });
    }

    var grouped = {};
    domainSpells.forEach(function(sp){
        var norm = hbNormSpell(sp);
        if (!norm.name) return;
        var minLevel = norm.level <= 0 ? 1 : Math.max(1, (norm.level * 2) - 1);
        if (!grouped[minLevel]) grouped[minLevel] = [];
        if (!grouped[minLevel].some(function(x){ return String(x.name || '').toLowerCase() === norm.name.toLowerCase(); })) {
            grouped[minLevel].push(norm);
        }
    });

    return Object.keys(grouped).map(function(k){
        return { minLevel: parseInt(k, 10), spells: grouped[k] };
    }).sort(function(a,b){ return a.minLevel - b.minLevel; });
}

function hbNormSpell(s) {
    s = s || {};
    var lvl = parseInt(s.level, 10);
    if (isNaN(lvl)) lvl = 0;
    return {
        name: String(s.name || '').trim(),
        level: Math.max(0, Math.min(9, lvl)),
        school: String(s.school || 'Evocation'),
        desc: String(s.desc || s.description || 'Homebrew spell.'),
        castingTime: s.castingTime || s.casting_time || '1 action',
        range: s.range || 'Self',
        components: s.components || '',
        duration: s.duration || 'Instantaneous'
    };
}

function hbNormalizePackageObject(raw, name, source) {
    var pkg = hbNewPackage(name, source);
    var data = raw && raw.data && typeof raw.data === 'object' ? raw.data : (raw || {});
    var keys = Object.keys(hbEmptyData());
    keys.forEach(function(k){
        var v = data[k];
        if (!v) return;
        if (Array.isArray(v)) pkg.data[k] = v;
        else if (typeof v === 'object') {
            if (k === 'classes' || k === 'races') {
                pkg.data[k] = Object.keys(v).map(function(nm){
                    var o = hbClone(v[nm]) || {};
                    if (!o.name) o.name = nm;
                    return o;
                });
            }
        }
    });

    pkg.data.classes = pkg.data.classes.map(hbNormClass).filter(function(x){ return x.name; });
    pkg.data.races = pkg.data.races.map(hbNormRace).filter(function(x){ return x.name; });
    pkg.data.subclasses = pkg.data.subclasses.map(hbNormSubclass).filter(function(x){ return x.name && x.className; });
    pkg.data.spells = pkg.data.spells.map(hbNormSpell).filter(function(x){ return x.name; });
    ['items','weapons','armor','features','skills'].forEach(function(k){
        pkg.data[k] = (pkg.data[k] || []).map(function(v){
            if (typeof v === 'string') return { name: v };
            return v || {};
        }).filter(function(v){ return String(v.name || '').trim(); });
    });
    return pkg;
}

function hbParseTextPackage(text, name) {
    var pkg = hbNewPackage(name, 'text');
    var section = '';
    var map = {
        classes: 'classes', class: 'classes',
        subclasses: 'subclasses', subclass: 'subclasses',
        races: 'races', race: 'races',
        items: 'items', item: 'items',
        weapons: 'weapons', weapon: 'weapons',
        armor: 'armor', armour: 'armor',
        spells: 'spells', spell: 'spells',
        features: 'features', feature: 'features',
        skills: 'skills', skill: 'skills'
    };

    String(text || '').split(/\r?\n/).forEach(function(line){
        var t = String(line || '').trim();
        if (!t) return;
        var head = t.match(/^([a-zA-Z ]+)\s*:\s*$/);
        if (head) {
            var k = head[1].toLowerCase().trim();
            section = map[k] || '';
            return;
        }
        if (!section) return;
        t = t.replace(/^[-*\u2022\d.\)\s]+/, '').trim();
        if (!t) return;

        if (section === 'subclasses') {
            var m = t.match(/^(.+?)\s*[-:|]\s*(.+)$/);
            if (m) pkg.data.subclasses.push({ className: m[1].trim(), name: m[2].trim() });
            else pkg.data.subclasses.push({ className: 'Fighter', name: t });
            return;
        }
        if (section === 'spells') {
            var lvl = 0;
            var lm = t.match(/level\s*(\d)/i);
            if (lm) lvl = parseInt(lm[1], 10) || 0;
            var nm = t.split('|')[0].trim();
            pkg.data.spells.push({ name: nm, level: lvl });
            return;
        }
        if (section === 'classes') { pkg.data.classes.push({ name: t }); return; }
        if (section === 'races') { pkg.data.races.push({ name: t }); return; }
        pkg.data[section].push({ name: t });
    });
    return hbNormalizePackageObject(pkg, name, 'text');
}

function hbRestoreBaseDB() {
    hbEnsureBaseDBSnapshot();
    hbEnsureDBShape();
    var b = window._hbBaseDB || {};
    DB.races = hbClone(b.races || {});
    DB.names = hbClone(b.names || {});
    DB.classes = hbClone(b.classes || {});
    DB.subclasses = hbClone(b.subclasses || {});
    DB.subclassSpells = hbClone(b.subclassSpells || {});
    DB.spells = hbClone(b.spells || {});
    DB.allWeapons = hbClone(b.allWeapons || []);
    DB.allArmor = hbClone(b.allArmor || []);
}

function hbApplyPackageToDB(pkg) {
    hbEnsureDBShape();
    if (!pkg || !pkg.data) return;
    (pkg.data.races || []).forEach(function(r){
        var nr = hbNormRace(r);
        DB.races[nr.name] = { mod:nr.mod, speed:nr.speed, desc:nr.desc, look:nr.look };
        DB.names[nr.name] = nr.names;
    });

    (pkg.data.classes || []).forEach(function(c){
        var nc = hbNormClass(c);
        DB.classes[nc.name] = {
            hd: nc.hd,
            save: nc.save,
            weps: nc.weps,
            armor: nc.armor,
            skills: nc.skills,
            features: nc.features,
            spellcasting: nc.spellcasting,
            spellAbility: nc.spellAbility,
            casterType: nc.casterType
        };
    });

    (pkg.data.subclasses || []).forEach(function(s){
        var ns = hbNormSubclass(s);
        if (!DB.subclasses[ns.className]) DB.subclasses[ns.className] = { unlockLevel: ns.unlockLevel, options: [] };
        if (!Array.isArray(DB.subclasses[ns.className].options)) DB.subclasses[ns.className].options = [];
        DB.subclasses[ns.className].unlockLevel = Math.min(DB.subclasses[ns.className].unlockLevel || ns.unlockLevel, ns.unlockLevel);
        var idx = DB.subclasses[ns.className].options.findIndex(function(o){ return o.name === ns.name; });
        var opt = { name: ns.name, features: ns.features, grantsSpellcasting: !!ns.grantsSpellcasting };
        if (idx >= 0) DB.subclasses[ns.className].options[idx] = opt;
        else DB.subclasses[ns.className].options.push(opt);
        if (Array.isArray(ns.domainSpells) && ns.domainSpells.length) DB.subclassSpells[ns.name] = hbNormalizeSubclassSpellTiers(ns.domainSpells);
    });

    (pkg.data.spells || []).forEach(function(s){
        var sp = hbNormSpell(s);
        var bucket = sp.level === 0 ? 'cantrip' : String(sp.level);
        if (!DB.spells[bucket]) DB.spells[bucket] = [];
        if (!DB.spells[bucket].some(function(x){ return String(x.name||'').toLowerCase() === sp.name.toLowerCase(); })) {
            DB.spells[bucket].push({ name: sp.name, level: sp.level, school: sp.school, desc: sp.desc, range: sp.range, castTime: sp.castingTime, duration: sp.duration, components: sp.components });
        }
    });

    (pkg.data.weapons || []).forEach(function(w){
        var nm = String((w||{}).name || '').trim();
        if (!nm) return;
        if (!DB.allWeapons.some(function(x){ return String(x.name||x).toLowerCase() === nm.toLowerCase(); })) {
            DB.allWeapons.push({ name: nm, type: 'Weapon', rarity: 'common' });
        }
    });
    (pkg.data.armor || []).forEach(function(a){
        var nm = String((a||{}).name || '').trim();
        if (!nm) return;
        if (!DB.allArmor.some(function(x){ return String(x.name||x).toLowerCase() === nm.toLowerCase(); })) {
            DB.allArmor.push({ name: nm, type: 'Armor', rarity: 'common' });
        }
    });

    DB.homebrewItems = (DB.homebrewItems || []).concat((pkg.data.items || []).map(function(i){ return { name: i.name, source: pkg.name }; }));
    DB.homebrewFeatures = (DB.homebrewFeatures || []).concat((pkg.data.features || []).map(function(i){ return { name: i.name, source: pkg.name }; }));
    DB.homebrewSkills = (DB.homebrewSkills || []).concat((pkg.data.skills || []).map(function(i){ return { name: i.name, source: pkg.name }; }));
}

function hbRefreshSpellCaches() {
    if (typeof loadSpellDatabase === 'function') {
        loadSpellDatabase();
        var hbSpells = [];
        (window._hbState.packages || []).forEach(function(p){
            if (!p.enabled) return;
            (p.data.spells || []).forEach(function(s){ hbSpells.push(hbNormSpell(s)); });
        });
        if (typeof _allSpells !== 'undefined' && Array.isArray(_allSpells)) {
            hbSpells.forEach(function(sp){
                if (!_allSpells.some(function(x){ return String(x.name||'').toLowerCase() === sp.name.toLowerCase(); })) {
                    _allSpells.push({
                        name: sp.name,
                        level: sp.level,
                        school: sp.school,
                        castingTime: sp.castingTime,
                        range: sp.range,
                        components: sp.components,
                        duration: sp.duration,
                        description: sp.desc
                    });
                }
            });
        }
    }
    var sel = document.getElementById('psSpellSelect');
    if (sel) sel.dataset.built = '0';
}

function hbRefreshSelects() {
    var rSel = document.getElementById('raceSel');
    var cSel = document.getElementById('classSel');
    if (rSel) {
        var oldR = rSel.value;
        rSel.innerHTML = '<option value="">Random</option>' + Object.keys(DB.races).map(function(r){ return '<option value="' + r + '">' + r + '</option>'; }).join('');
        rSel.value = Object.prototype.hasOwnProperty.call(DB.races, oldR) ? oldR : '';
    }
    if (cSel) {
        var oldC = cSel.value;
        cSel.innerHTML = '<option value="">Random</option>' + Object.keys(DB.classes).map(function(c){ return '<option value="' + c + '">' + c + '</option>'; }).join('');
        cSel.value = Object.prototype.hasOwnProperty.call(DB.classes, oldC) ? oldC : '';
    }
    if (typeof lpSyncNPCSelects === 'function') lpSyncNPCSelects();
}

function hbActiveCountsText() {
    var totals = hbEmptyData();
    (window._hbState.packages || []).forEach(function(p){
        if (!p.enabled) return;
        Object.keys(totals).forEach(function(k){ totals[k] += ((p.data||{})[k] || []).length; });
    });
    return 'Active: ' + totals.classes + ' classes, ' + totals.subclasses + ' subclasses, ' + totals.races + ' races, '
        + totals.spells + ' spells, ' + totals.items + ' items';
}

function hbUpdateHeaderCounts() {
    var el = document.getElementById('hbActiveCounts');
    if (el) el.textContent = hbActiveCountsText();
}

function hbRenderPackages() {
    hbUpdateHeaderCounts();
    var list = document.getElementById('hbPackagesList');
    if (!list) return;
    var pkgs = window._hbState.packages || [];
    if (!pkgs.length) {
        list.innerHTML = '<div style="padding:12px;border:1px dashed rgba(255,255,255,0.2);border-radius:8px;color:rgba(255,255,255,0.6);font-family:\'Crimson Text\',serif;">No homebrew packages loaded yet.</div>';
        return;
    }
    list.innerHTML = pkgs.map(function(p){
        var d = p.data || hbEmptyData();
        var summary = 'Classes ' + d.classes.length + ' · Subclasses ' + d.subclasses.length + ' · Races ' + d.races.length
            + ' · Spells ' + d.spells.length + ' · Items ' + d.items.length + ' · Weapons ' + d.weapons.length + ' · Armor ' + d.armor.length;
        var cardOpacity = p.enabled ? '1' : '0.55';
        var borderColor = p.enabled ? 'rgba(218,165,32,0.35)' : 'rgba(255,255,255,0.1)';
        var trackBg = p.enabled ? 'rgba(46,204,113,0.45)' : 'rgba(255,255,255,0.15)';
        var trackBorder = p.enabled ? 'rgba(46,204,113,0.6)' : 'rgba(255,255,255,0.25)';
        var knobLeft = p.enabled ? '22px' : '2px';
        var knobBg = p.enabled ? '#2ecc71' : 'rgba(255,255,255,0.45)';
        var statusText = p.enabled ? 'Enabled' : 'Disabled';
        var statusColor = p.enabled ? '#a0ffc0' : 'rgba(255,255,255,0.5)';
        return '<div style="background:rgba(0,0,0,0.22);border:1px solid ' + borderColor + ';border-radius:10px;padding:12px 14px;opacity:' + cardOpacity + ';transition:opacity 0.3s;">'
            + '<div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">'
            +   '<div style="flex:1;min-width:180px;"><div style="font-family:\'Cinzel\',serif;color:#fff3c0;font-weight:800;font-size:0.88em;">' + p.name + '</div>'
            +   '<div style="font-family:\'Crimson Text\',serif;color:rgba(255,255,255,0.55);font-size:0.84em;margin-top:2px;">' + summary + '</div></div>'
            +   '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">'
            +     '<div onclick="hbTogglePackage(\'' + p.id + '\')" style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;" title="Click to ' + (p.enabled ? 'disable' : 'enable') + ' this package">'
            +       '<div style="position:relative;width:42px;height:22px;border-radius:12px;background:' + trackBg + ';border:1px solid ' + trackBorder + ';transition:all 0.25s;">'
            +         '<div style="position:absolute;top:2px;left:' + knobLeft + ';width:16px;height:16px;border-radius:50%;background:' + knobBg + ';box-shadow:0 1px 4px rgba(0,0,0,0.4);transition:all 0.25s;"></div>'
            +       '</div>'
            +       '<span style="font-family:\'Cinzel\',serif;font-size:0.72em;font-weight:900;color:' + statusColor + ';letter-spacing:0.5px;min-width:52px;">' + statusText + '</span>'
            +     '</div>'
            +     '<button onclick="hbRemovePackage(\'' + p.id + '\')" style="padding:6px 10px;border-radius:6px;border:1px solid rgba(139,0,0,0.45);background:rgba(139,0,0,0.15);color:#f0a0a0;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.72em;font-weight:900;">Remove</button>'
            +   '</div>'
            + '</div>'
            + '</div>';
    }).join('');
}

function hbRebuildAll() {
    hbEnsureDBShape();
    hbRestoreBaseDB();
    DB.homebrewItems = [];
    DB.homebrewFeatures = [];
    DB.homebrewSkills = [];
    var failures = 0;
    (window._hbState.packages || []).forEach(function(p){
        if (!p.enabled) return;
        try { hbApplyPackageToDB(p); } catch(_e) { failures++; }
    });
    hbSavePackages();
    hbRefreshSelects();
    hbRefreshSpellCaches();
    hbRenderPackages();
    if (failures && typeof showToast === 'function') showToast('Some homebrew packages failed to apply (' + failures + ')', 'warning');
}

function hbRunIntegrationCheck() {
    hbEnsureDBShape();
    hbRebuildAll();
    var enabled = (window._hbState.packages || []).filter(function(p){ return p && p.enabled; }).length;
    var classCount = Object.keys(DB.classes || {}).length;
    var raceCount = Object.keys(DB.races || {}).length;
    var spellCount = 0;
    Object.keys(DB.spells || {}).forEach(function(k){ spellCount += ((DB.spells || {})[k] || []).length; });
    if (typeof showToast === 'function') showToast('Homebrew OK — ' + enabled + ' packages active | ' + classCount + ' classes | ' + raceCount + ' races | ' + spellCount + ' spells', 'success');
}

function hbSwitchTab(tab) {
    ['import','manual','active'].forEach(function(t){
        var panel = document.getElementById('hbTab_' + t);
        var btn = document.getElementById('hbTabBtn_' + t);
        if (panel) panel.style.display = (t === tab ? '' : 'none');
        if (btn) {
            btn.style.background = (t === tab ? 'rgba(218,165,32,0.18)' : 'rgba(255,255,255,0.05)');
            btn.style.borderColor = (t === tab ? 'rgba(218,165,32,0.35)' : 'rgba(218,165,32,0.2)');
            btn.style.color = (t === tab ? '#fff3c0' : 'rgba(255,255,255,0.75)');
        }
    });
    hbRenderPackages();
}

window.hbOpenManager = function() {
    var m = document.getElementById('homebrewModal');
    if (m) m.style.display = 'flex';
    hbSwitchTab('import');
};

window.hbCloseManager = function() {
    var m = document.getElementById('homebrewModal');
    if (m) m.style.display = 'none';
    var fi = document.getElementById('hbFileInput');
    if (fi) fi.value = '';
};

window.hbImportFromFileClick = function() {
    var input = document.getElementById('hbFileInput');
    if (input) input.click();
};

window.hbHandleFileImport = function(ev) {
    var file = ev && ev.target && ev.target.files ? ev.target.files[0] : null;
    if (!file) return;
    var isPdf = (file.type === 'application/pdf' || /\.pdf$/i.test(file.name));
    if (isPdf) {
        var box = document.getElementById('hbImportText');
        if (box) {
            box.value = '';
            box.placeholder = 'PDF/Homebrewery: Open your PDF in a viewer, copy the text (Ctrl+A, Ctrl+C), then paste here. You can import items, weapons, armor, spells, classes, races, and story content.';
        }
        var n = document.getElementById('hbPackageName');
        if (n && !n.value.trim()) n.value = file.name.replace(/\.[^.]+$/, '');
        if (typeof showToast === 'function') showToast('PDF selected. Copy text from your PDF (e.g. Homebrewery) and paste in the box below.', 'success');
        ev.target.value = '';
        return;
    }
    var rd = new FileReader();
    rd.onload = function(e){
        var txt = (e && e.target) ? String(e.target.result || '') : '';
        var box = document.getElementById('hbImportText');
        if (box) box.value = txt;
        var n = document.getElementById('hbPackageName');
        if (n && !n.value.trim()) n.value = file.name.replace(/\.[^.]+$/, '');
        if (typeof showToast === 'function') showToast('Loaded file. Click Preview Import.', 'success');
    };
    rd.readAsText(file);
};

async function hbParseImportInput(name, txt) {
    var pkg = null;
    var source = 'text';
    try {
        var json = JSON.parse(txt);
        pkg = hbNormalizePackageObject(json, name, 'json');
        source = 'json';
    } catch(_e) {
        if (typeof window.homebrewAiNormalize === 'function') {
            try {
                var aiOut = await window.homebrewAiNormalize(txt);
                if (aiOut && typeof aiOut === 'object') {
                    pkg = hbNormalizePackageObject(aiOut, name, 'ai');
                    source = 'ai';
                }
            } catch(_aiErr) {
                // Fall back to deterministic parser
            }
        }
        if (!pkg) {
            pkg = hbParseTextPackage(txt, name);
            source = 'text';
        }
    }
    return { pkg: pkg, source: source };
}

function hbDryRunDiagnostics(pkg) {
    var diag = { warnings: [], errors: [], counts: hbEmptyData() };
    if (!pkg || !pkg.data) {
        diag.errors.push('Parser returned an empty package.');
        return diag;
    }
    Object.keys(diag.counts).forEach(function(k){ diag.counts[k] = ((pkg.data || {})[k] || []).length; });

    Object.keys(diag.counts).forEach(function(k){
        var arr = (pkg.data || {})[k] || [];
        var seen = {};
        arr.forEach(function(entry){
            var nm = String((entry && entry.name) || '').trim().toLowerCase();
            if (!nm) {
                diag.warnings.push(k + ': entry with missing name ignored during normalize/apply.');
                return;
            }
            if (seen[nm]) diag.warnings.push(k + ': duplicate "' + nm + '" in preview package.');
            seen[nm] = true;
        });
    });

    if (!diag.counts.classes && !diag.counts.subclasses && !diag.counts.races && !diag.counts.spells && !diag.counts.items && !diag.counts.weapons && !diag.counts.armor && !diag.counts.features && !diag.counts.skills) {
        diag.errors.push('No recognizable homebrew entries were found.');
    }
    return diag;
}

function hbRenderPreview(pkg, source, diag) {
    var panel = document.getElementById('hbPreviewPanel');
    var sum = document.getElementById('hbPreviewSummary');
    var warn = document.getElementById('hbPreviewWarnings');
    if (!panel || !sum || !warn) return;

    panel.style.display = 'block';
    var c = (diag && diag.counts) || hbEmptyData();
    sum.innerHTML = ''
        + '<div><strong>Package:</strong> ' + (pkg && pkg.name ? pkg.name : 'Unknown') + ' <span style="opacity:0.7;">(' + source + ' parser)</span></div>'
        + '<div style="margin-top:4px;">Classes ' + c.classes + ' · Subclasses ' + c.subclasses + ' · Races ' + c.races + ' · Spells ' + c.spells + ' · Items ' + c.items + ' · Weapons ' + c.weapons + ' · Armor ' + c.armor + ' · Features ' + c.features + ' · Skills ' + c.skills + '</div>';

    var lines = [];
    (diag.errors || []).forEach(function(e){ lines.push('❌ ' + e); });
    (diag.warnings || []).slice(0, 12).forEach(function(w){ lines.push('⚠ ' + w); });
    warn.innerHTML = lines.length ? lines.join('<br>') : 'No dry-run warnings detected. Ready to apply.';
}

window.hbPreviewImportFromText = async function() {
    var txtEl = document.getElementById('hbImportText');
    var nameEl = document.getElementById('hbPackageName');
    var txt = txtEl ? String(txtEl.value || '').trim() : '';
    if (!txt) { if (typeof showToast === 'function') showToast('Paste JSON/text first.', 'warning'); return; }
    var name = (nameEl && nameEl.value.trim()) ? nameEl.value.trim() : ('Homebrew ' + new Date().toLocaleString());

    var parsed = await hbParseImportInput(name, txt);
    var pkg = parsed.pkg;
    var source = parsed.source;
    var diag = hbDryRunDiagnostics(pkg);
    hbRenderPreview(pkg, source, diag);
    if ((diag.errors || []).length) {
        window._hbPendingImport = null;
        if (typeof showToast === 'function') showToast('Preview found blocking issues. Fix and preview again.', 'warning');
        return;
    }
    window._hbPendingImport = { pkg: pkg, source: source, diagnostics: diag };
    if (typeof showToast === 'function') showToast('Preview ready. Click Apply Preview to import.', 'success');
};

window.hbApplyPreviewImport = function() {
    var pending = window._hbPendingImport;
    if (!pending || !pending.pkg) {
        if (typeof showToast === 'function') showToast('No preview ready. Click Preview Import first.', 'warning');
        return;
    }
    window._hbState.packages.push(pending.pkg);
    hbRebuildAll();
    hbSwitchTab('active');
    window._hbPendingImport = null;
    if (typeof showToast === 'function') showToast('Homebrew imported: ' + pending.pkg.name, 'success');
};

window.hbImportFromText = window.hbPreviewImportFromText;

window.hbAddManualEntry = function() {
    var tEl = document.getElementById('hbManualType');
    var nEl = document.getElementById('hbManualName');
    var dEl = document.getElementById('hbManualDetails');
    var type = tEl ? tEl.value : 'items';
    var name = nEl ? nEl.value.trim() : '';
    var details = {};
    if (!name) { if (typeof showToast === 'function') showToast('Manual entry needs a name.', 'warning'); return; }
    try {
        var raw = dEl ? dEl.value.trim() : '';
        details = raw ? JSON.parse(raw) : {};
    } catch(e) {
        if (typeof showToast === 'function') showToast('Details must be valid JSON object (or blank).', 'warning');
        return;
    }
    var pkg = hbNewPackage('Manual: ' + name, 'manual');
    var entry = Object.assign({}, details, { name: name });
    if (type === 'classes') pkg.data.classes.push(entry);
    else if (type === 'subclasses') pkg.data.subclasses.push(entry);
    else if (type === 'races') pkg.data.races.push(entry);
    else pkg.data[type].push(entry);

    pkg = hbNormalizePackageObject(pkg, pkg.name, 'manual');
    window._hbState.packages.push(pkg);
    hbRebuildAll();
    hbSwitchTab('active');
    if (nEl) nEl.value = '';
    if (dEl) dEl.value = '';
    if (typeof showToast === 'function') showToast('Manual homebrew added.', 'success');
};

window.hbTogglePackage = function(id) {
    var p = (window._hbState.packages || []).find(function(x){ return x.id === id; });
    if (!p) return;
    p.enabled = !p.enabled;
    hbRebuildAll();
    if (typeof showToast === 'function') showToast(p.name + (p.enabled ? ' enabled' : ' disabled'), p.enabled ? 'success' : 'info');
};

window.hbRemovePackage = function(id) {
    var before = JSON.parse(JSON.stringify(window._hbState.packages || []));
    window._hbState.packages = (window._hbState.packages || []).filter(function(x){ return x.id !== id; });
    hbRebuildAll();
    dmPushUndoAction('Remove homebrew package', function() {
        window._hbState.packages = JSON.parse(JSON.stringify(before || []));
        hbRebuildAll();
    });
    if (typeof showToast === 'function') showToast('Homebrew package removed.', 'success');
};

function hbInit() {
    hbEnsureBaseDBSnapshot();
    hbLoadPackages();
    hbRebuildAll();

    var modal = document.getElementById('homebrewModal');
    if (modal && !modal.dataset.boundClose) {
        modal.addEventListener('click', function(e){
            if (e.target === modal) hbCloseManager();
        });
        modal.dataset.boundClose = '1';
    }
    if (!window._hbEscBound) {
        document.addEventListener('keydown', function(e){
            if (e.key === 'Escape') {
                var m = document.getElementById('homebrewModal');
                if (m && m.style.display === 'flex') hbCloseManager();
            }
        });
        window._hbEscBound = true;
    }
}

function hbGetEnabledEntries(type) {
    var out = [];
    (window._hbState.packages || []).forEach(function(p){
        if (!p || !p.enabled || !p.data) return;
        var arr = p.data[type] || [];
        if (Array.isArray(arr)) out = out.concat(arr);
    });
    return out;
}

function hbPickEnabledEntry(type) {
    var arr = hbGetEnabledEntries(type);
    if (!arr.length) return null;
    return arr[Math.floor(Math.random() * arr.length)] || null;
}

function hbApplyExtrasToBuiltNPC(npc) {
    if (!npc || typeof npc !== 'object') return npc;

    // Detach from shared class templates to avoid cross-NPC mutation.
    if (Array.isArray(npc.features)) {
        npc.features = npc.features.map(function(f){
            if (!f || typeof f !== 'object') return { name: String(f || ''), desc: '' };
            return { name: String(f.name || 'Feature'), desc: String(f.desc || '') };
        });
    }

    // Homebrew item hook (applies to all generation paths)
    if (Array.isArray(npc.inventory) && Math.random() < 0.4) {
        var item = hbPickEnabledEntry('items') || hbPickEnabledEntry('weapons') || hbPickEnabledEntry('armor');
        if (item && item.name) {
            npc.inventory.push({
                name: item.name,
                rarity: item.rarity || 'uncommon',
                type: item.type || 'Homebrew',
                source: 'Homebrew',
                dropChance: 1.0,
                dc: 10
            });
        }
    }

    // Homebrew features/skills hook
    var feat = hbPickEnabledEntry('features');
    if (feat && feat.name) {
        if (!Array.isArray(npc.features)) npc.features = [];
        npc.features.push({ name: feat.name, desc: feat.desc || 'Homebrew feature.' });
    }
    var skill = hbPickEnabledEntry('skills');
    if (skill && skill.name) {
        if (!Array.isArray(npc.features)) npc.features = [];
        npc.features.push({ name: 'Homebrew Skill: ' + skill.name, desc: skill.desc || 'Additional homebrew skill capability.' });
    }

    // Homebrew spell hook for spellcasters
    if (Array.isArray(npc.spells) && npc.spells.length) {
        var hbSpell = hbPickEnabledEntry('spells');
        if (hbSpell && hbSpell.name && !npc.spells.some(function(s){ return (s && s.name) === hbSpell.name; })) {
            var nsp = hbNormSpell(hbSpell);
            npc.spells.push({
                name: nsp.name,
                level: nsp.level,
                data: {
                    name: nsp.name,
                    level: nsp.level,
                    school: nsp.school,
                    desc: nsp.desc,
                    range: nsp.range,
                    castTime: nsp.castingTime,
                    duration: nsp.duration,
                    components: nsp.components
                },
                isDomain: false,
                isHomebrew: true
            });
        }
    }
    return npc;
}

/* =========================================
   INIT & UTILS
   ========================================= */
const DM_APP_SETTINGS_KEY = 'dm_app_settings_v1';
const DM_SCHEMA_VERSION_KEY = 'dm_schema_version';
const DM_SCHEMA_VERSION = 2;
window._dmAppSettings = window._dmAppSettings || {
    performanceMode: 'balanced',   /* low | balanced | high */
    portraitQuality: 'balanced',   /* low | balanced | high */
    mapDetail: 'balanced'          /* low | balanced | high */
};

function dmLoadAppSettings() {
    try {
        var raw = JSON.parse(localStorage.getItem(DM_APP_SETTINGS_KEY) || 'null');
        if (raw && typeof raw === 'object') {
            window._dmAppSettings.performanceMode = raw.performanceMode || window._dmAppSettings.performanceMode;
            window._dmAppSettings.portraitQuality = raw.portraitQuality || window._dmAppSettings.portraitQuality;
            window._dmAppSettings.mapDetail = raw.mapDetail || window._dmAppSettings.mapDetail;
        }
    } catch(e) {}
}

function dmSaveAppSettings() {
    try { localStorage.setItem(DM_APP_SETTINGS_KEY, JSON.stringify(window._dmAppSettings)); } catch(e) {}
}

function dmRunStorageMigrations() {
    var ver = 0;
    try { ver = parseInt(localStorage.getItem(DM_SCHEMA_VERSION_KEY) || '0', 10) || 0; } catch(e) { ver = 0; }
    if (ver >= DM_SCHEMA_VERSION) return;

    if (ver < 1) {
        try {
            var vault = JSON.parse(localStorage.getItem('dm_vault') || '[]');
            if (!Array.isArray(vault)) vault = [];
            vault = vault.filter(function(v){ return v && typeof v === 'object' && (v.id || v._isGroup); });
            localStorage.setItem('dm_vault', JSON.stringify(vault));
        } catch(e) {}
    }

    if (ver < 2) {
        try {
            var packs = JSON.parse(localStorage.getItem(HB_STORAGE_KEY) || '[]');
            if (!Array.isArray(packs)) packs = [];
            packs = packs.map(function(p){
                p = p || {};
                if (!p.id) p.id = 'hb_' + Math.random().toString(36).slice(2,9);
                if (!p.data || typeof p.data !== 'object') p.data = hbEmptyData();
                Object.keys(hbEmptyData()).forEach(function(k){ if (!Array.isArray(p.data[k])) p.data[k] = []; });
                if (typeof p.enabled !== 'boolean') p.enabled = true;
                if (!p.name) p.name = 'Homebrew Package';
                return p;
            });
            localStorage.setItem(HB_STORAGE_KEY, JSON.stringify(packs));
        } catch(e) {}
    }

    try { localStorage.setItem(DM_SCHEMA_VERSION_KEY, String(DM_SCHEMA_VERSION)); } catch(e) {}
}

window._dmUndoStack = window._dmUndoStack || [];
function dmPushUndoAction(label, undoFn) {
    if (typeof undoFn !== 'function') return;
    window._dmUndoStack.push({ label: label || 'Undo action', undo: undoFn, at: Date.now() });
    if (window._dmUndoStack.length > 20) window._dmUndoStack.shift();
}
function dmUndoLastAction() {
    var entry = window._dmUndoStack.pop();
    if (!entry) {
        if (typeof showToast === 'function') showToast('Nothing to undo.', 'warning');
        return;
    }
    try {
        entry.undo();
        if (typeof showToast === 'function') showToast('Undid: ' + entry.label, 'success');
    } catch(e) {
        if (typeof showToast === 'function') showToast('Undo failed: ' + (entry.label || 'action'), 'warning');
    }
}

function dmStartLongSessionPerformancePass() {
    if (window._dmLongSessionPerfTimer) return;
    window._dmLongSessionPerfTimer = setInterval(function() {
        if (typeof _rollHistory !== 'undefined' && Array.isArray(_rollHistory) && _rollHistory.length > 120) {
            _rollHistory.length = 120;
            if (typeof _renderRollLog === 'function') _renderRollLog();
        }
        if (Array.isArray(window.generatedNPCs) && window.generatedNPCs.length > 180 && !window._dmLargeNpcWarned) {
            window._dmLargeNpcWarned = true;
            if (typeof showToast === 'function') showToast('Large on-screen NPC count detected. Save/archive to keep UI responsive.', 'warning');
        }
        if (window._currentCampaign && typeof saveCurrentCampaign === 'function') {
            try { saveCurrentCampaign(); } catch(_e) {}
        }
    }, 180000);
}

function dmWorkflowKickoff() {
    if (typeof openLiveDMTools === 'function') openLiveDMTools();
    if (typeof dmToolSwitch === 'function') dmToolSwitch('round');
    if (typeof showToast === 'function') {
        var hints = [
            '1) Save campaign snapshot',
            '2) Set/verify turn order',
            '3) Generate/activate quest or location',
            '4) Export diagnostics before major imports'
        ];
        showToast('DM Workflow: ' + hints.join(' · '), 'success');
    }
}

function dmSyncSettingsControls() {
    var perf = document.getElementById('dmPerfModeSel');
    var portrait = document.getElementById('dmPortraitQualitySel');
    var map = document.getElementById('dmMapDetailSel');
    if (perf) perf.value = window._dmAppSettings.performanceMode || 'balanced';
    if (portrait) portrait.value = window._dmAppSettings.portraitQuality || 'balanced';
    if (map) map.value = window._dmAppSettings.mapDetail || 'balanced';
}

function dmSetPerformanceMode(mode) {
    window._dmAppSettings.performanceMode = mode || 'balanced';
    dmApplyPerformanceProfile();
    dmSaveAppSettings();
    if (typeof showToast === 'function') showToast('Performance mode: ' + window._dmAppSettings.performanceMode, 'success');
}

function dmSetPortraitQuality(mode) {
    window._dmAppSettings.portraitQuality = mode || 'balanced';
    dmSaveAppSettings();
    if (typeof showToast === 'function') showToast('Portrait quality: ' + window._dmAppSettings.portraitQuality, 'success');
}

function dmSetMapDetail(mode) {
    window._dmAppSettings.mapDetail = mode || 'balanced';
    dmSaveAppSettings();
    if (typeof showToast === 'function') showToast('Battlemap detail: ' + window._dmAppSettings.mapDetail, 'success');
}

function dmApplyPerformanceProfile() {
    var mode = (window._dmAppSettings && window._dmAppSettings.performanceMode) || 'balanced';
    var reduced = (mode === 'low');
    document.body.classList.toggle('dm-reduced-motion', reduced);
    if (reduced) {
        document.documentElement.style.setProperty('--t-fast', '0ms');
        document.documentElement.style.setProperty('--t-med', '0ms');
        document.documentElement.style.setProperty('--t-slow', '0ms');
    } else {
        document.documentElement.style.removeProperty('--t-fast');
        document.documentElement.style.removeProperty('--t-med');
        document.documentElement.style.removeProperty('--t-slow');
    }
}

function dmBootApplication() {
    dmRunStorageMigrations();
    dmLoadAppSettings();
    dmApplyPerformanceProfile();
    hbInit();
    dmSyncSettingsControls();
    dmStartLongSessionPerformancePass();
    window.addEventListener('app:update-available', function(e) {
        var v = (e.detail && e.detail.version) ? e.detail.version : '';
        if (typeof showInGameUpdateBanner === 'function' && v) showInGameUpdateBanner(v);
    });
    window.addEventListener('app:update-download-progress', function(e) {
        var d = e.detail || {};
        if (typeof optionsUpdateUI_onDownloadProgress === 'function') optionsUpdateUI_onDownloadProgress(d.percent, d.bytesPerSecond, d.transferred, d.total);
        if (typeof igOnDownloadProgress === 'function') igOnDownloadProgress(d.percent, d.bytesPerSecond);
    });
    window.addEventListener('app:update-downloaded', function() {
        if (typeof optionsUpdateUI_onDownloaded === 'function') optionsUpdateUI_onDownloaded();
        if (typeof igOnDownloaded === 'function') igOnDownloaded();
    });
    window.addEventListener('app:update-error', function(e) {
        var msg = (e.detail && e.detail.message) ? e.detail.message : '';
        if (typeof optionsUpdateUI_onError === 'function') optionsUpdateUI_onError(msg);
    });
    window.addEventListener('app:ollama-now-running', function() {
        if (typeof refreshCsOllamaStatus === 'function') refreshCsOllamaStatus();
        var banner = document.getElementById('dmAISetupBanner');
        if (banner) banner.remove();
        if (typeof optionsRefreshOllamaStatusInModal === 'function') optionsRefreshOllamaStatusInModal();
        if (typeof swLoadStoryAISettings === 'function') swLoadStoryAISettings();
        if (typeof showToast === 'function') showToast('Ollama is now running. AI is ready.', 'success');
    });

    /* Phase heavy startup over frames for smoother initial render */
    requestAnimationFrame(function() {
        if (typeof loadSavedNPCs === 'function') loadSavedNPCs();
        if (typeof updateRelativeSelect === 'function') updateRelativeSelect();
    });
    setTimeout(function() {
        if (typeof renderHeaderPlayerCards === 'function') renderHeaderPlayerCards();
        if (typeof renderHeaderPartyHealth === 'function') renderHeaderPartyHealth();
    }, 80);
}

window.addEventListener('load', dmBootApplication);

function getMod(score) { return Math.floor((score - 10) / 2); }
function roll(d) { return Math.floor(Math.random() * d) + 1; }
function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function rollSkillCheck(skillName, modifier) {
    const d20 = Math.floor(Math.random() * 20) + 1;
    const total = d20 + modifier;
    const sign = modifier >= 0 ? '+' : '';
    const isCrit = d20 === 20;
    const isFail = d20 === 1;
    const type = isFail ? 'warning' : 'success';
    const special = isCrit ? 'boss' : '';
    const critText = isCrit ? ' 💥 NATURAL 20!' : isFail ? ' 💀 Natural 1!' : '';
    showToast(`🎲 ${skillName}: rolled ${d20} ${sign}${modifier} = <strong>${total}</strong>${critText}`, type, special);
}

function scrollToGroup(groupId, groupName) {
    // Check if any member from this group is on screen
    const onScreenMember = generatedNPCs.find(n => n.groupName === groupName);
    if (onScreenMember) {
        switchToNPC(onScreenMember.id);
        setTimeout(() => {
            const el = document.getElementById('npc-' + onScreenMember.id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.transition = 'box-shadow 0.4s ease';
                el.style.boxShadow = '0 0 0 4px #7b5ea7, 0 0 40px rgba(123,94,167,0.7)';
                setTimeout(() => { el.style.boxShadow = ''; }, 2000);
            }
        }, 80);
        return;
    }
    // Not on screen — try to load from vault
    const vault = JSON.parse(localStorage.getItem('dm_vault') || '[]');
    const groupEntry = vault.find(n => n._isGroup && (n.id === groupId || n.groupName === groupName));
    if (!groupEntry) {
        showToast('That group is not on screen and not in the vault.', 'warning');
        return;
    }
    const members = groupEntry.members || [];
    if (generatedNPCs.length > 0) {
        generatedNPCs = [...generatedNPCs, ...members];
    } else {
        generatedNPCs = [...members];
    }
    renderAllNPCs();
    setTimeout(() => {
        if (members.length > 0) {
            const el = document.getElementById('npc-' + members[0].id);
            if (el) {
                switchToNPC(members[0].id);
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.transition = 'box-shadow 0.4s ease';
                el.style.boxShadow = '0 0 0 4px #7b5ea7, 0 0 40px rgba(123,94,167,0.7)';
                setTimeout(() => { el.style.boxShadow = ''; }, 2000);
            }
        }
    }, 120);
    showToast('Loaded group "' + groupName + '" from vault', 'success');
}

function scrollToNPC(id) {
    // Check if already on screen
    const el = document.getElementById('npc-' + id);
    if (el) {
        switchToNPC(id);
        setTimeout(() => {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.style.transition = 'box-shadow 0.4s ease';
            el.style.boxShadow = '0 0 0 4px #9b59b6, 0 0 40px rgba(155,89,182,0.7)';
            setTimeout(() => { el.style.boxShadow = ''; }, 2000);
        }, 80);
        return;
    }
    // Not on screen — try to load from vault
    const vault = JSON.parse(localStorage.getItem('dm_vault') || '[]');
    const entry = vault.find(n => n.id === id);
    if (!entry) {
        showToast('That NPC is not on screen and not in the vault.', 'warning');
        return;
    }
    // Load alongside current NPCs
    if (generatedNPCs.length > 0) {
        generatedNPCs.push(entry);
    } else {
        generatedNPCs = [entry];
    }
    renderAllNPCs();
    setTimeout(() => {
        const newEl = document.getElementById('npc-' + id);
        if (newEl) {
            switchToNPC(id);
            newEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            newEl.style.transition = 'box-shadow 0.4s ease';
            newEl.style.boxShadow = '0 0 0 4px #9b59b6, 0 0 40px rgba(155,89,182,0.7)';
            setTimeout(() => { newEl.style.boxShadow = ''; }, 2000);
        }
    }, 120);
    showToast('Loaded ' + entry.name + ' from vault', 'success');
}

function showToast(message, type = 'success', special = '') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast' + (special === 'boss' ? ' boss-toast' : special === 'relative' ? ' relative-toast' : '');
    // Fix \n -> actual line breaks, then format with line-break divs
    const cleanMsg = message.replace(/\n/g, '\n').replace(/\n/g, '<br>');
    toast.innerHTML = (type === 'success' ? '✓ ' : '⚠ ') + cleanMsg;
    toast.style.lineHeight = '1.6';
    toast.style.padding = '12px 18px';
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function generateName(race, lastName = null, forceGender = null) {
    const raceNames = DB.names[race] || DB.names.Human;
    const gender = forceGender || (Math.random() < 0.5 ? 'male' : 'female');
    const firstName = pick(raceNames[gender]);
    const title = Math.random() < 0.3 ? " " + pick(DB.titles) : "";
    
    if (lastName) {
        return firstName + " " + lastName;
    }
    
    // Generate last name for family members
    const lastNames = {
        Human: ["Smith", "Johnson", "Williams", "Brown", "Jones", "Miller", "Davis", "Wilson", "Moore", "Taylor"],
        Elf: ["Moonwhisper", "Starweaver", "Silverleaf", "Nightbreeze", "Sunstrider", "Windrunner"],
        Dwarf: ["Ironforge", "Stonehammer", "Firebeard", "Steelshield", "Goldvein", "Rockfist"],
        Halfling: ["Goodbarrel", "Greenhill", "Thornburrow", "Tealeaf", "Bramblefoot", "Meadowbrook"],
        Orc: ["Bloodfang", "Skullcrusher", "Ironjaw", "Blacktusk", "Bonegrinder", "Warbringer"],
        Tiefling: ["Ashborne", "Hellfire", "Shadowhorn", "Dreadmane", "Nightshade", "Darkflame"],
        Dragonborn: ["Draconis", "Scalewing", "Flameheart", "Stormblade", "Emberclaw", "Frostfang"],
        Gnome: ["Tinkertop", "Sparkwheel", "Gearspring", "Brightbolt", "Fizzlebang", "Quickwit"]
    };
    
    const familyName = pick(lastNames[race] || lastNames.Human);
    return firstName + title + (title ? "" : (" " + familyName));
}

function generateAge(race) {
    // D&D 5e typical age ranges
    const ageRanges = {
        Human: { young: [16, 25], adult: [26, 45], middle: [46, 65], old: [66, 90] },
        Elf: { young: [20, 100], adult: [101, 400], middle: [401, 600], old: [601, 750] },
        Dwarf: { young: [18, 50], adult: [51, 150], middle: [151, 250], old: [251, 350] },
        Halfling: { young: [15, 30], adult: [31, 70], middle: [71, 110], old: [111, 150] },
        Orc: { young: [12, 20], adult: [21, 35], middle: [36, 50], old: [51, 70] },
        Tiefling: { young: [16, 25], adult: [26, 50], middle: [51, 75], old: [76, 100] },
        Dragonborn: { young: [10, 20], adult: [21, 45], middle: [46, 65], old: [66, 80] },
        Gnome: { young: [20, 60], adult: [61, 200], middle: [201, 350], old: [351, 500] }
    };

    const ranges = ageRanges[race] || ageRanges.Human;
    const roll = Math.random();
    
    let category, range;
    if (roll < 0.15) { category = "young"; range = ranges.young; }
    else if (roll < 0.70) { category = "adult"; range = ranges.adult; }
    else if (roll < 0.95) { category = "middle"; range = ranges.middle; }
    else { category = "old"; range = ranges.old; }
    
    const age = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
    return { age, category };
}

function generateOccupation() {
    return pick(DB.occupations);
}

function generateStartingCondition() {
    // 3% chance of having a starting condition
    if (Math.random() < 0.03) {
        return pick(DB.startingConditions);
    }
    return null;
}

/* =========================================
   LOOT GENERATION - WITH MYTHIC ITEMS
   ========================================= */
function generateLoot(isBoss, level, classKey, raceKey) {
    const loot = [];
    const cData = classKey ? DB.classes[classKey] : null;

    // ── Tier helpers ──
    const tier = level <= 4 ? 1 : level <= 10 ? 2 : level <= 16 ? 3 : 4;
    const goldMultiplier = [1, 3, 8, 20][tier - 1];
    const gold = isBoss
        ? Math.round(roll(100) * goldMultiplier * 2.5)
        : Math.round(roll(20) * goldMultiplier);

    loot.push({ name: `${gold} Gold Pieces`, rarity: "common", type: "Currency", dropChance: 1.0, dc: 0, cost: gold + ' gp' });

    // ── Silver / Electrum for low tiers ──
    if (tier <= 2) {
        const silver = roll(20) * level;
        if (silver > 5) loot.push({ name: `${silver} Silver Pieces`, rarity: "common", type: "Currency", dropChance: 0.9, dc: 0, cost: Math.round(silver / 10) + ' gp' });
    }

    // ── Mundane gear (1-3 items, more for bosses) ──
    const regularItems = [
        "Waterskin","Bedroll","Rations (5 days)","Rope (50ft)","Torch (3)",
        "Tinderbox","Backpack","Pouch","Whetstone","Soap",
        "Crowbar","Hammer","Lantern (Hooded)","Oil (1 pint)","Piton (10)",
        "Rations (1 day)","Signal Whistle","Manacles","Caltrops (bag of 20)",
        "Grappling Hook","Thieves' Tools","Healer's Kit","Climber's Kit",
        "Chain (10 ft)","Ink (1 oz bottle)","Parchment (5 sheets)","Candles (10)",
        "Mirror, Steel","Sealing Wax","Chalk (5 pieces)","Bell"
    ];
    const gearCount = isBoss ? 2 + roll(2) : 1 + (Math.random() < 0.4 ? 1 : 0);
    for (let i = 0; i < gearCount; i++) {
        loot.push({ name: pick(regularItems), rarity: "common", type: "Gear", dropChance: 1.0, dc: 5 });
    }

    // ── Class-appropriate equipped weapon ──
    if (cData && Array.isArray(cData.weps) && cData.weps.length) {
        const equippedWep = pick(cData.weps);
        const wInfo = (typeof WEAPON_DATA !== 'undefined' && WEAPON_DATA[equippedWep]) || {};
        loot.push({
            name: equippedWep,
            rarity: "common",
            type: "Weapon",
            desc: wInfo.damage ? (wInfo.damage + ' ' + (wInfo.damageType || '')) : ('Standard ' + equippedWep.toLowerCase()),
            cost: wInfo.cost || '',
            dropChance: 1.0,
            dc: 0
        });
    }

    // ── Class-appropriate equipped armor ──
    if (cData && cData.armor && cData.armor !== 'Unarmored' && cData.armor !== 'None') {
        const armorName = cData.armor;
        const aInfo = (typeof ARMOR_DATA !== 'undefined' && ARMOR_DATA[armorName]) || {};
        loot.push({
            name: armorName,
            rarity: "common",
            type: "Armor",
            desc: aInfo.ac ? ('AC: ' + aInfo.ac) : ('Standard ' + armorName.toLowerCase()),
            cost: aInfo.cost || '',
            dropChance: 1.0,
            dc: 0
        });
    }

    // ── Extra random weapon or armor from full pool ──
    if (Math.random() < (0.2 + tier * 0.1) || isBoss) {
        const allEquip = [...(DB.allWeapons || []), ...(DB.allArmor || [])];
        if (allEquip.length > 0) {
            const eq = pick(allEquip);
            loot.push({ ...eq, dropChance: 0.7, dc: 5 });
        }
    }

    // ── Consumables (potions, oils, antitoxins) ──
    const consumables = [
        { name: "Potion of Healing", rarity: "common", type: "Potion", desc: "Restore 2d4+2 HP", cost: "50 gp", minTier: 1 },
        { name: "Antitoxin", rarity: "common", type: "Potion", desc: "Advantage on saves vs poison for 1 hour", cost: "50 gp", minTier: 1 },
        { name: "Alchemist's Fire", rarity: "common", type: "Consumable", desc: "1d4 fire damage per round", cost: "50 gp", minTier: 1 },
        { name: "Holy Water (flask)", rarity: "common", type: "Consumable", desc: "2d6 radiant vs fiends/undead", cost: "25 gp", minTier: 1 },
        { name: "Oil (flask)", rarity: "common", type: "Consumable", desc: "Fuel or improvised weapon (5 fire)", cost: "1 sp", minTier: 1 },
        { name: "Potion of Greater Healing", rarity: "uncommon", type: "Potion", desc: "Restore 4d4+4 HP", cost: "150 gp", minTier: 2 },
        { name: "Potion of Climbing", rarity: "common", type: "Potion", desc: "Climbing speed = walking for 1 hour", cost: "75 gp", minTier: 1 },
        { name: "Potion of Fire Breath", rarity: "uncommon", type: "Potion", desc: "Exhale 4d6 fire in a 30ft cone", cost: "150 gp", minTier: 2 },
        { name: "Potion of Resistance", rarity: "uncommon", type: "Potion", desc: "Resist one damage type for 1 hour", cost: "300 gp", minTier: 2 },
        { name: "Potion of Superior Healing", rarity: "rare", type: "Potion", desc: "Restore 8d4+8 HP", cost: "500 gp", minTier: 3 },
        { name: "Potion of Heroism", rarity: "rare", type: "Potion", desc: "10 temp HP + Bless for 1 hour", cost: "500 gp", minTier: 3 },
        { name: "Potion of Invisibility", rarity: "rare", type: "Potion", desc: "Invisible for 1 hour", cost: "5,000 gp", minTier: 3 },
        { name: "Potion of Speed", rarity: "rare", type: "Potion", desc: "Haste for 1 minute (no exhaustion)", cost: "5,000 gp", minTier: 3 },
        { name: "Potion of Supreme Healing", rarity: "epic", type: "Potion", desc: "Restore 10d4+20 HP", cost: "2,000 gp", minTier: 4 },
        { name: "Potion of Flying", rarity: "epic", type: "Potion", desc: "60ft flying speed for 1 hour", cost: "5,000 gp", minTier: 4 }
    ];
    const potionChance = isBoss ? 0.8 : (0.15 + tier * 0.08);
    if (Math.random() < potionChance) {
        const eligiblePotions = consumables.filter(c => c.minTier <= tier);
        if (eligiblePotions.length) {
            const pot = pick(eligiblePotions);
            loot.push({ name: pot.name, rarity: pot.rarity, type: pot.type, desc: pot.desc, cost: pot.cost, dropChance: isBoss ? 0.9 : 0.5, dc: 5 });
        }
    }
    if (isBoss && tier >= 2) {
        const bossPots = consumables.filter(c => c.minTier <= tier && c.rarity !== 'common');
        if (bossPots.length) {
            const pot2 = pick(bossPots);
            loot.push({ name: pot2.name, rarity: pot2.rarity, type: pot2.type, desc: pot2.desc, cost: pot2.cost, dropChance: 0.7, dc: 10 });
        }
    }

    // ── Gems & Art Objects (tier-scaled) ──
    const gemTiers = { 1: ['10 gp','50 gp'], 2: ['50 gp','100 gp'], 3: ['100 gp','500 gp'], 4: ['500 gp','1,000 gp','5,000 gp'] };
    const gemNames = {
        '10 gp': ["Azurite","Blue Quartz","Hematite","Lapis Lazuli","Malachite","Obsidian","Tiger Eye","Turquoise"],
        '50 gp': ["Bloodstone","Carnelian","Chalcedony","Citrine","Moonstone","Onyx","Quartz","Star Rose Quartz","Zircon"],
        '100 gp': ["Amber","Amethyst","Coral","Garnet","Jade","Jet","Pearl","Spinel","Tourmaline"],
        '500 gp': ["Alexandrite","Aquamarine","Black Pearl","Blue Spinel","Peridot","Topaz"],
        '1,000 gp': ["Black Opal","Blue Sapphire","Emerald","Fire Opal","Star Ruby","Star Sapphire"],
        '5,000 gp': ["Black Sapphire","Diamond","Jacinth","Ruby"]
    };
    const gemChance = isBoss ? 0.7 : (0.1 + tier * 0.08);
    if (Math.random() < gemChance) {
        const gTier = pick(gemTiers[tier] || ['50 gp']);
        const gName = pick(gemNames[gTier] || ['Quartz']);
        loot.push({ name: gName + ' (' + gTier + ')', rarity: tier >= 3 ? 'uncommon' : 'common', type: 'Gem', cost: gTier, dropChance: 0.8, dc: 8 });
        if (isBoss && Math.random() < 0.5) {
            const gTier2 = pick(gemTiers[tier] || ['100 gp']);
            const gName2 = pick(gemNames[gTier2] || ['Pearl']);
            loot.push({ name: gName2 + ' (' + gTier2 + ')', rarity: 'uncommon', type: 'Gem', cost: gTier2, dropChance: 0.6, dc: 10 });
        }
    }

    const artTiers = { 1: '25 gp', 2: '250 gp', 3: '750 gp', 4: '2,500 gp' };
    const artObjects = {
        '25 gp': ["Silver ewer","Carved bone statuette","Small gold bracelet","Black velvet mask with silver","Copper chalice with silver filigree","Embroidered silk handkerchief","Gold locket with portrait"],
        '250 gp': ["Gold ring with bloodstones","Carved ivory statuette","Silver necklace with gem pendant","Bronze crown","Silk robe with gold embroidery","Brass mug with jade inlay"],
        '750 gp': ["Silver chalice with moonstones","Carved harp of exotic wood","Small gold idol","Gold dragon comb with red garnets","Ceremonial electrum dagger","Painted gold war mask"],
        '2,500 gp': ["Fine gold chain with fire opal","Old masterpiece painting","Platinum bracelet with sapphire","Jeweled anklet","Gold music box","Gold circlet with aquamarines"]
    };
    if (Math.random() < (isBoss ? 0.6 : 0.12 + tier * 0.04)) {
        const aTier = artTiers[tier] || '25 gp';
        const aObj = pick(artObjects[aTier] || ['Silver ewer']);
        loot.push({ name: aObj + ' (' + aTier + ')', rarity: tier >= 3 ? 'rare' : 'uncommon', type: 'Art Object', cost: aTier, dropChance: 0.6, dc: 10 });
    }

    // ── Homebrew items ──
    if (Array.isArray(DB.homebrewItems) && DB.homebrewItems.length > 0 && (Math.random() < 0.3 || isBoss)) {
        const hbItem = pick(DB.homebrewItems);
        if (hbItem && hbItem.name) {
            loot.push({ name: hbItem.name, rarity: hbItem.rarity || 'uncommon', type: hbItem.type || 'Homebrew', desc: hbItem.desc || '', source: 'Homebrew', dropChance: 0.6, dc: 10, cost: hbItem.cost || '' });
        }
    }

    // ── Spell scrolls (tier-scaled) ──
    const scrollChance = isBoss ? 0.7 : (0.1 + tier * 0.06);
    if (Math.random() < scrollChance && DB.allScrolls && DB.allScrolls.length) {
        const tierScrollFilter = tier <= 1 ? (s => s.rarity === 'common')
            : tier <= 2 ? (s => ['common','uncommon'].includes(s.rarity))
            : (s => true);
        const eligibleScrolls = DB.allScrolls.filter(tierScrollFilter);
        const scrollPool = eligibleScrolls.length ? eligibleScrolls : DB.allScrolls;
        const scroll = pick(scrollPool);
        loot.push({ ...scroll, dropChance: isBoss ? 0.9 : 0.3 });
    }

    // ── Magic items (tier-scaled rarity chances) ──
    const allMagic = [
        ...(DB.allMagicWeapons || []),
        ...(DB.miscMagicItems || [])
    ];

    const tierRarityConfig = {
        1: { uncommon: 0.15, rare: 0.03, epic: 0, legendary: 0, mythic: 0 },
        2: { uncommon: 0.35, rare: 0.12, epic: 0.03, legendary: 0, mythic: 0 },
        3: { uncommon: 0.5, rare: 0.25, epic: 0.1, legendary: 0.03, mythic: 0 },
        4: { uncommon: 0.6, rare: 0.35, epic: 0.2, legendary: 0.08, mythic: 0.02 }
    };
    const bossRarityConfig = {
        1: { uncommon: 0.9, rare: 0.4, epic: 0.1, legendary: 0.02, mythic: 0 },
        2: { uncommon: 0.95, rare: 0.6, epic: 0.3, legendary: 0.08, mythic: 0.01 },
        3: { uncommon: 1.0, rare: 0.8, epic: 0.5, legendary: 0.2, mythic: 0.05 },
        4: { uncommon: 1.0, rare: 0.9, epic: 0.7, legendary: 0.35, mythic: 0.12 }
    };

    const rarityDCs = { uncommon: 10, rare: 15, epic: 18, legendary: 20, mythic: 25 };
    const chances = isBoss ? (bossRarityConfig[tier] || bossRarityConfig[2]) : (tierRarityConfig[tier] || tierRarityConfig[1]);

    const rarities = ['mythic', 'legendary', 'epic', 'rare', 'uncommon'];
    rarities.forEach(rarity => {
        if (chances[rarity] > 0 && Math.random() < chances[rarity]) {
            const pool = allMagic.filter(i => i.rarity === rarity);
            const fallback = DB.magicItems ? (DB.magicItems[rarity] || DB.magicItems.rare || DB.magicItems.uncommon) : [];
            const item = pool.length > 0 ? pick(pool) : (fallback.length ? pick(fallback) : null);
            if (item) {
                loot.push({
                    name: item.name, rarity: rarity, type: item.type,
                    desc: item.desc, cost: item.cost,
                    dropChance: item.dropChance || (isBoss ? 0.6 : 0.3),
                    dc: rarityDCs[rarity]
                });
            }
        }
    });

    // Bosses always get at least one rare+ item
    if (isBoss && !loot.find(i => ['rare', 'epic', 'legendary', 'mythic'].includes(i.rarity))) {
        const rarePool = allMagic.filter(i => i.rarity === 'rare');
        const fallback = DB.magicItems ? (DB.magicItems.rare || []) : [];
        const guaranteedRare = rarePool.length > 0 ? pick(rarePool) : (fallback.length ? pick(fallback) : null);
        if (guaranteedRare) {
            loot.push({
                name: guaranteedRare.name, rarity: "rare", type: guaranteedRare.type,
                desc: guaranteedRare.desc, cost: guaranteedRare.cost,
                dropChance: 1.0, dc: 15
            });
        }
    }

    return loot;
}

function generateAppearance(race, isBoss, classKey) {
    const rData = DB.races[race];
    const cData = classKey ? DB.classes[classKey] : null;
    let parts = [];
    
    // Base racial look — filter out items that mention armor/armour to avoid conflicts with class armor
    const _armorWords = /\b(armor|armour|mail|plate|leather armor|chain|studded|scale mail|breastplate)\b/i;
    const _safeLook = rData.look.filter(l => !_armorWords.test(l));
    const _lookPool = _safeLook.length > 0 ? _safeLook : rData.look;
    parts.push(pick(_lookPool));
    
    // Physical trait
    parts.push(pick(DB.physicalTraits));
    
    // Clothing
    const clothing = DB.racialClothing[race] ? pick(DB.racialClothing[race]) : "simple traveling clothes";
    
    // Armor based on class
    let armorDesc = "no particular armor";
    if (cData) {
        const armorMap = {
            "Chain Mail": "a battered suit of chain mail, each link worn smooth",
            "Scale Mail": "scale mail whose overlapping plates gleam dully",
            "Leather Armor": "well-oiled leather armor fitted for agility",
            "Plate Mail": "imposing full plate armor polished to a high shine",
            "Robes": "flowing robes of their arcane tradition",
            "Unarmored": "no armor, relying on raw toughness and speed"
        };
        armorDesc = armorMap[cData.armor] || cData.armor.toLowerCase();
    }
    
    // Weapon
    const weaponDesc = DB.racialWeaponDescriptions[race] ? pick(DB.racialWeaponDescriptions[race]) : "a simple weapon";
    
    if (isBoss) {
        const bossFeatures = [
            "radiates an unmistakable aura of power and command",
            "has piercing eyes that seem to see directly into one's soul",
            "wears ornate armor etched with glowing magical runes",
            "carries themselves with supernatural, almost otherworldly grace",
            "is surrounded by a faint shimmering magical aura",
            "bears countless scars from a hundred deadly battles"
        ];
        parts.push(bossFeatures[Math.floor(Math.random() * bossFeatures.length)]);
    }
    
    return { 
        desc: parts.join(". They have ") + ".",
        base: parts[0],
        clothing: clothing,
        armor: armorDesc,
        weapon: weaponDesc
    };
}

function generatePersonality(isBoss) {
    let traits = [pick(DB.personalities)];
    let second = pick(DB.personalities);
    while (second === traits[0]) second = pick(DB.personalities);
    traits.push(second);
    
    // Add a flaw
    const flaw = pick(DB.flaws);
    
    // Speech patterns
    const speechPatterns = [
        "Speaks in short, clipped sentences",
        "Uses overly formal language and archaic words",
        "Peppers speech with regional slang",
        "Rambles on tangents before getting to the point",
        "Speaks very quietly, forcing others to lean in",
        "Booms loudly in every setting",
        "Asks rhetorical questions constantly",
        "Repeats the last word of each sentence... sentence",
        "Refers to themselves in the third person",
        "Never makes direct eye contact while speaking",
        "Hums or whistles between sentences",
        "Quotes obscure proverbs inappropriately",
        "Speaks in riddles when nervous",
        "Has a habit of saying 'if you know what I mean' after every claim",
        "Uses military terminology even in casual conversation",
        "Switches languages mid-sentence when excited",
        "Speaks poetically, in rhyme when stressed",
        "Monotone delivery regardless of topic",
        "Laughs nervously after every statement",
        "Always speaks as if sharing a great secret",
        "Uses excessive hand gestures",
        "Pauses dramatically before key words"
    ];
    
    // Secrets
    const secrets = [
        "Is wanted in another city under a different name",
        "Secretly worships a forbidden deity",
        "Owes a massive debt to a criminal organization",
        "Has a hidden family they never speak of",
        "Was once a member of a disgraced faction",
        "Carries stolen goods of unknown origin",
        "Is a spy for a rival faction",
        "Has a terminal illness they hide from everyone",
        "Witnessed a powerful figure commit a crime and said nothing",
        "Knows the location of a hidden treasure",
        "Has a twin no one knows about",
        "Used to be of noble birth, now in hiding",
        "Is the last survivor of a destroyed village",
        "Has been cursed but keeps it secret",
        "Secretly has a powerful magical ability they never use",
        "Made a pact with an otherworldly entity",
        "Is in possession of forbidden knowledge",
        "Has been blackmailing a local official",
        "Their whole identity is an assumed persona",
        "Helped cause a local disaster years ago"
    ];
    
    const speech = pick(speechPatterns);
    const secret = pick(secrets);
    
    if (isBoss) {
        const bossTraits = ["Commanding presence", "Terrifying calm", "Maniacal obsession", "Cold calculation", "Righteous fury", "Megalomaniacal"];
        traits.push(pick(bossTraits));
    }
    
    return {
        traits: traits,
        flaw: flaw,
        speech: speech,
        secret: secret,
        summary: traits.join(", ") + ". " + flaw
    };
}

function generateQuest(isBoss) {
    if (isBoss) {
        return {
            type: "boss",
            category: "Boss Encounter",
            desc: "This powerful enemy seeks to destroy the party. They may be the leader of a dangerous faction, a legendary monster, or a personal nemesis with a vendetta. Defeating them will have major consequences for the entire region and could shift the balance of power.",
            reward: "Legendary loot, massive story progression, regional faction reputation, potential territory or title"
        };
    }
    
    const roll = Math.random();
    let questType, questData;
    
    if (roll < 0.25) {
        questType = "hostile";
        questData = pick(DB.quests.hostile);
    } else if (roll < 0.70) {
        questType = "side";
        questData = pick(DB.quests.side);
    } else {
        questType = "neutral";
        questData = pick(DB.quests.neutral);
    }
    
    return {
        type: questType,
        category: questData.type,
        desc: questData.desc,
        reward: questData.reward
    };
}


/* =========================================
   RELATIVE GENERATION
   ========================================= */
function updateRelativeSelect() {
    const select = document.getElementById('relativeSelect');
    const vault = JSON.parse(localStorage.getItem('dm_vault') || "[]");
    
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    vault.forEach(entry => {
        const option = document.createElement('option');
        option.value = entry.id;
        if (entry._isGroup) {
            option.textContent = `${entry.groupName} (${entry.groupType || 'Group'} · ${entry.memberCount} members)`;
        } else {
            option.textContent = `${entry.name} (${entry.race} ${entry.class})`;
        }
        select.appendChild(option);
    });
}

function updateDiscipleSelect() {
    const select = document.getElementById('discipleSelect');
    const vault = JSON.parse(localStorage.getItem('dm_vault') || "[]");
    
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    vault.forEach(npc => {
        const option = document.createElement('option');
        option.value = npc.id;
        option.textContent = `${npc.name} (${npc.race} ${npc.class})`;
        select.appendChild(option);
    });
}

function generateDisciple() {
    const select = document.getElementById('discipleSelect');
    const masterId = select.value;
    
    if (!masterId) {
        showToast('Please select a master NPC first!', 'warning');
        return;
    }
    
    const vault = JSON.parse(localStorage.getItem('dm_vault') || "[]");
    const master = vault.find(n => n.id === masterId);
    
    if (!master) {
        showToast('Master NPC not found in vault!', 'warning');
        return;
    }
    
    const disciple = createDisciple(master);
    
    generatedNPCs = [disciple];
    renderAllNPCs();
    
    showToast(`Generated disciple of ${master.name}`, 'success');
}

function createDisciple(master) {
    // Disciple is same class as master, lower level
    const classKey = master.class;
    const raceKey = Math.random() < 0.3 ? master.race : pick(Object.keys(DB.races));
    let level = Math.max(1, master.level - roll(5) - 3);

    // Inherit master's subclass if disciple is at the unlock level
    // Otherwise no subclass yet (still learning)
    let discipleSubclass = null;
    if (master.subclass) {
        const subclassData = DB.subclasses[classKey];
        if (subclassData && level >= subclassData.unlockLevel) {
            // Same subclass as master, but only features unlocked at disciple's level
            const masterOption = (subclassData.options || []).find(o => o.name === master.subclass.name);
            if (masterOption) {
                const unlockedFeatures = masterOption.features.filter(f => f.level <= level);
                const domainPool = DB.subclassSpells[masterOption.name] || [];
                const domainSpells = [];
                domainPool.forEach(tier => {
                    if (level >= tier.minLevel) {
                        tier.spells.forEach(sp => {
                            if (!domainSpells.find(s => s.name === sp.name)) {
                                domainSpells.push({...sp, isDomain: true});
                            }
                        });
                    }
                });
                const grantsSpellcasting = !!masterOption.grantsSpellcasting || ["Eldritch Knight","Arcane Trickster"].includes(masterOption.name);
                discipleSubclass = {
                    name: masterOption.name,
                    features: unlockedFeatures,
                    domainSpells: domainSpells,
                    grantsSpellcasting: grantsSpellcasting
                };
            }
        }
    }
    
    const gender = Math.random() < 0.5 ? 'male' : 'female';
    const name = generateName(raceKey, null, gender);
    const rData = DB.races[raceKey];
    const cData = DB.classes[classKey];
    let prof = Math.ceil(level / 4) + 1;
    
    let stats = {};
    Object.keys(master.stats).forEach(stat => {
        let base = master.stats[stat] - roll(4);
        base = Math.max(8, Math.min(16, base));
        stats[stat] = base;
    });
    
    Object.keys(stats).forEach(k => {
        if(rData.mod.all) stats[k] += 1;
        if(rData.mod[k]) stats[k] += rData.mod[k];
    });
    
    const conMod = getMod(stats.CON);
    const dexMod = getMod(stats.DEX);
    const hpMax = (cData.hd + conMod) + ((level - 1) * (Math.floor(cData.hd/2) + 1 + conMod));
    
    let ac = 10 + dexMod;
    if(cData.armor.includes("Chain")) ac = 16;
    if(cData.armor.includes("Scale")) ac = 14 + Math.min(dexMod, 2);
    if(cData.armor.includes("Leather")) ac = 11 + dexMod;
    if(cData.armor.includes("Plate")) ac = 18;
    if(cData.armor === "Unarmored") ac = 10 + dexMod + getMod(stats.CON);
    
    const attacks = generateAttacks(cData, stats, prof);
    
    let spellList = [];
    let spellSlots = null;
    let relSubclass = null;
    
    const isThirdCasterDisciple = discipleSubclass && discipleSubclass.grantsSpellcasting;
    const effectiveSpellAbilityD = cData.spellAbility || (isThirdCasterDisciple ? "INT" : null);
    if(cData.spellcasting || isThirdCasterDisciple) {
        spellSlots = isThirdCasterDisciple ? getThirdCasterSlots(level) : calculateSpellSlots(level, classKey);
        const selectedSpells = selectSpellsForClass(classKey, level, effectiveSpellAbilityD, discipleSubclass);
        const spellDC = 8 + prof + getMod(stats[effectiveSpellAbilityD]);
        
        spellList.push({
            header: true,
            text: `<strong>Spell Save DC:</strong> ${spellDC} | <strong>Spell Attack:</strong> +${prof + getMod(stats[effectiveSpellAbilityD])}`
        });
        
        selectedSpells.forEach(spell => {
            spellList.push({
                name: spell.name,
                level: spell.level,
                data: spell,
                isDomain: spell.isDomain || false
            });
        });
    }
    
    const inventory = generateLoot(false, level, classKey, raceKey);
    const appearance = generateAppearance(raceKey, false, classKey);
    const personality = generatePersonality(false);
    const ageData = generateAge(raceKey);
    const occupation = generateOccupation();
    const startingCondition = generateStartingCondition();
    
    var discipleNpc = {
        id: Date.now() + Math.random().toString(36).substr(2, 9),
        name,
        gender,
        race: raceKey,
        class: classKey,
        subclass: discipleSubclass,
        level,
        prof,
        isBoss: false,
        isDisciple: true,
        age: ageData.age,
        ageCategory: ageData.category,
        occupation: occupation,
        masterOf: {
            id: master.id,
            name: master.name
        },
        stats,
        hpMax,
        hpCurr: hpMax,
        ac,
        speed: rData.speed,
        attacks,
        spells: spellList,
        spellSlots: spellSlots,
        features: cData.features,
        inventory,
        appearance,
        physicalDesc: appearance.desc,
        personality: personality,
        quest: {
            type: "side",
            category: "Training",
            desc: `This character is a devoted student of ${master.name}, learning the ways of the ${classKey}. They are eager to prove themselves worthy and often seek their master's approval.`,
            reward: "Potential ally, training assistance"
        },
        dmNotes: "",
        isCombat: false,
        conditions: startingCondition ? [startingCondition] : [],
        startingCondition: startingCondition,
        initiative: null
    };
    return hbApplyExtrasToBuiltNPC(discipleNpc);
}

function generateStorefront() {
    const select = document.getElementById('shopSelect');
    const shopType = select.value;
    const isBoss = document.getElementById('bossMode').checked;
    
    if (!shopType) {
        showToast('Please select a shop type!', 'warning');
        return;
    }
    
    // Use smart dialog if NPCs on screen
    if (generatedNPCs.length > 0) {
        _pendingGenFn = () => {
            const shopkeeper = generateShopkeeperOfType(shopType, isBoss);
            return [shopkeeper];
        };
        _pendingGenLabel = `${shopType} Shopkeeper`;
        const sub = document.getElementById('genModeSubtitle');
        if (sub) sub.textContent = `You have ${generatedNPCs.length} NPC${generatedNPCs.length > 1 ? 's' : ''} on screen. What would you like to do?`;
        document.getElementById('genModeDialog').classList.add('active');
    } else {
        const shopkeeper = generateShopkeeperOfType(shopType, isBoss);
        generatedNPCs = [shopkeeper];
        renderAllNPCs();
        showToast(`Generated ${shopType} shopkeeper`, 'success');
    }
}

function generateGroup() {
    const groupTypeSelect = document.getElementById('groupType');
    let selectedType = groupTypeSelect.value;
    const isBossMode = document.getElementById('bossMode').checked;
    
    // Capture existing NPCs for smart dialog
    const _prexistingCount = generatedNPCs.length;
    const _prexistingNPCs = [...generatedNPCs];
    
    let groupData;
    if (!selectedType) {
        groupData = pick(DB.groupTypes);
    } else {
        groupData = DB.groupTypes.find(g => g.type === selectedType);
    }
    
    const size = Math.floor(Math.random() * (groupData.maxSize - groupData.minSize + 1)) + groupData.minSize;
    const groupName = pick(groupData.names);
    const goal = pick(groupData.goals);
    const motto = pick(groupData.mottos);
    
    generatedNPCs = [];
    
    // Special handling for Master & Disciples
    if (groupData.type === "Master & Disciples") {
        // Generate master (higher level, boss if bossMode)
        const master = createNPC(isBossMode);
        rebuildNPCDerivedCombatAndMagic(master, Math.max(master.level, 8));
        master.groupRole = "Master";
        master.groupName = groupName;
        master.groupType = groupData.type;
        master.groupGoal = goal;
        master.groupMotto = motto;
        generatedNPCs.push(master);
        
        // Generate disciples of same class
        for (let i = 1; i < size; i++) {
            const disciple = createDisciple(master);
            disciple.groupRole = "Disciple";
            disciple.groupName = groupName;
            disciple.groupType = groupData.type;
            disciple.groupGoal = goal;
            disciple.groupMotto = motto;
            generatedNPCs.push(disciple);
        }
    } else {
        // Generate leader (higher level, boss if bossMode)
        const leader = createNPC(isBossMode);
        rebuildNPCDerivedCombatAndMagic(leader, Math.max(leader.level, 5));
        leader.groupRole = "Leader";
        leader.groupName = groupName;
        leader.groupType = groupData.type;
        leader.groupGoal = goal;
        leader.groupMotto = motto;
        generatedNPCs.push(leader);
        
        // Generate members
        for (let i = 1; i < size; i++) {
            const member = createNPC(false);
            rebuildNPCDerivedCombatAndMagic(member, Math.max(1, leader.level - roll(3)));
            member.groupRole = i === 1 ? "Second-in-Command" : "Member";
            member.groupName = groupName;
            member.groupType = groupData.type;
            member.groupGoal = goal;
            member.groupMotto = motto;
            member.groupLeader = leader.name;
            generatedNPCs.push(member);
        }
    }
    
    // Use smart dialog if other NPCs already on screen
    if (_prexistingCount > 0) {
        const pendingGroup = [...generatedNPCs];
        generatedNPCs = _prexistingNPCs;
        _pendingGenFn = () => pendingGroup;
        _pendingGenLabel = `${groupData.type}: ${groupName} (${size} members)`;
        const sub = document.getElementById('genModeSubtitle');
        if (sub) sub.textContent = `You have ${_prexistingCount} NPC${_prexistingCount > 1 ? 's' : ''} on screen. What would you like to do?`;
        document.getElementById('genModeDialog').classList.add('active');
    } else {
        renderAllNPCs();
        showToast(`Generated ${groupData.type}: ${groupName} (${size} members)`, 'success');
    }
}

/* =========================================
   BOUNTY BOARD FUNCTIONS
   ========================================= */
function openBountyBoard() {
    const modal = document.getElementById('bountyBoardModal');
    const list = document.getElementById('bountyBoardList');
    const levelFilter = (document.getElementById('bountyLevelSel') || {}).value || '';
    const pool = getBountyPool(levelFilter);
    BOUNTY_BOARD = buildActiveBountyBoard(pool);
    renderBountyBoard(list);
    modal.style.display = 'flex';
}

function refreshBountyBoard() {
    const list = document.getElementById('bountyBoardList');
    const levelFilter = (document.getElementById('bountyLevelSel') || {}).value || '';
    const pool = getBountyPool(levelFilter);
    BOUNTY_BOARD = buildActiveBountyBoard(pool);
    renderBountyBoard(list);
    // Flash effect
    list.style.opacity = '0';
    list.style.transition = 'opacity 0.3s';
    setTimeout(() => { list.style.opacity = '1'; }, 50);
}

function renderBountyBoard(list) {
    list.innerHTML = BOUNTY_BOARD.map(bounty => {
        const posterColor = bounty.poster.includes('BOSS') ? '#4a0080' : bounty.poster.includes('Alive Only') ? '#27ae60' : '#8b0000';
        const threatColor = bounty.threat.includes('LEGENDARY') ? '#ffd700' : bounty.threat.includes('Extremely') ? '#e74c3c' : bounty.threat.includes('High') ? '#e67e22' : '#27ae60';
        const backstoryHtml = bounty.backstory ? `
            <div style="background:rgba(74,0,128,0.06);border-left:3px solid #7b00c8;padding:6px 10px;border-radius:0 4px 4px 0;font-size:0.88em;">
                <strong style="color:#5a0080;font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;">Known History:</strong><br>
                <span style="font-style:italic;">${bounty.backstory}</span>
            </div>` : '';

        // Calculate XP for this bounty's targets
        const avgLevel = Math.round((bounty.levelRange[0] + bounty.levelRange[1]) / 2);
        const baseXP = calculateXPForLevel(avgLevel);
        const killXP = bounty.isBoss ? Math.floor(baseXP * 4) : baseXP;
        const questXP = bounty.isBoss ? Math.floor(baseXP * 6) : Math.floor(baseXP * 2);
        const totalKillXP = killXP * bounty.count;
        const totalQuestXP = questXP * bounty.count;

        const targetLabel = bounty.count === 1 ? '1 Target' : `${bounty.count} Targets`;
        const btnLabel = bounty.count === 1 ? 'Generate Wanted NPC' : `Generate ${bounty.count} Wanted NPCs`;

        return `
        <div style="background:linear-gradient(145deg,#fffdf0,#f9f3e0);border:2px solid #b8860b;border-radius:8px;padding:16px;position:relative;box-shadow:0 3px 10px rgba(0,0,0,0.15);">
            <div style="position:absolute;top:0;left:0;right:0;height:6px;background:linear-gradient(90deg,${posterColor},${posterColor}aa,${posterColor});border-radius:6px 6px 0 0;"></div>
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-top:4px;">
                <div style="flex:1;min-width:200px;">
                    <div style="font-family:'Cinzel',serif;font-size:1.15em;font-weight:700;color:#5a0000;margin-bottom:4px;">${bounty.title}</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                        <span style="background:${posterColor};color:white;padding:2px 10px;border-radius:12px;font-size:0.78em;font-weight:700;font-family:'Cinzel',serif;">${bounty.poster}</span>
                        <span style="background:rgba(255,150,0,0.15);border:1px solid ${threatColor};color:${threatColor};padding:2px 10px;border-radius:12px;font-size:0.78em;font-weight:700;">${bounty.threat}</span>
                        <span style="background:rgba(0,100,0,0.1);border:1px solid #27ae60;color:#27ae60;padding:2px 10px;border-radius:12px;font-size:0.78em;font-weight:700;">${bounty.reward}</span>
                    </div>
                    <div style="display:grid;gap:7px;">
                        <div style="background:rgba(139,0,0,0.05);border-left:3px solid #8b0000;padding:6px 10px;border-radius:0 4px 4px 0;font-size:0.88em;"><strong style="color:#8b0000;font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;">Crime:</strong><br>${bounty.crime}</div>
                        <div style="background:rgba(184,134,11,0.06);border-left:3px solid #b8860b;padding:6px 10px;border-radius:0 4px 4px 0;font-size:0.88em;"><strong style="color:#8b6914;font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;">Description:</strong><br>${bounty.description}</div>
                        ${backstoryHtml}
                        <div style="background:rgba(231,76,60,0.06);border-left:3px solid #e74c3c;padding:6px 10px;border-radius:0 4px 4px 0;font-size:0.88em;"><strong style="color:#c0392b;font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;">Beware:</strong><br>${bounty.beware}</div>
                        <div style="background:rgba(39,174,96,0.06);border-left:3px solid #27ae60;padding:6px 10px;border-radius:0 4px 4px 0;font-size:0.88em;"><strong style="color:#1e8449;font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;">Requirements:</strong><br>${bounty.needs}</div>
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;flex-shrink:0;min-width:160px;">
                    <div style="text-align:right;font-family:'Cinzel',serif;">
                        <div style="font-size:0.75em;color:#888;margin-bottom:6px;">${targetLabel} &nbsp;·&nbsp; Lvl ${bounty.levelRange[0]}–${bounty.levelRange[1]}</div>
                        <div style="background:linear-gradient(145deg,#fff8dc,#f5e8a0);border:1px solid #b8860b;border-radius:6px;padding:8px 12px;margin-bottom:6px;font-size:0.82em;">
                            <div style="color:#5a0000;font-weight:700;font-size:0.9em;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Rewards</div>
                            <div style="color:#1e8449;font-weight:700;">Gold: ${bounty.reward}</div>
                            <div style="color:#c0392b;margin-top:2px;">Kill XP: ${totalKillXP.toLocaleString()} XP${bounty.count > 1 ? ` (${killXP.toLocaleString()} ea)` : ''}</div>
                            <div style="color:#2980b9;margin-top:2px;">Quest XP: ${totalQuestXP.toLocaleString()} XP${bounty.count > 1 ? ` (${questXP.toLocaleString()} ea)` : ''}</div>
                            ${(() => {
                                const items = getBountyItemReward(bounty);
                                return `<div style="margin-top:6px;padding-top:5px;border-top:1px solid rgba(184,134,11,0.4);">
                                    <div style="color:#5a0000;font-size:0.85em;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px;">✨ Item Reward${items.length > 1 ? 's' : ''}</div>
                                    ${items.map(item => `<div style="display:flex;align-items:center;gap:5px;margin-top:3px;padding:3px 6px;background:rgba(255,255,255,0.5);border-radius:4px;border-left:3px solid ${RARITY_COLORS[item.rarity]||'#9d9d9d'};">
                                        <span>${item.icon}</span>
                                        <div>
                                            <div style="font-weight:700;color:${RARITY_COLORS[item.rarity]||'#9d9d9d'};font-size:0.9em;">${item.name}</div>
                                            <div style="font-size:0.75em;color:#666;font-style:italic;font-family:'Crimson Text',serif;">${item.type} · ${item.rarity}</div>
                                        </div>
                                    </div>`).join('')}
                                </div>`;
                            })()}
                        </div>
                    </div>
                    <button onclick="generateFromBounty('${bounty.id}')" style="background:linear-gradient(145deg,#8b0000,#5a0000);color:white;border:none;border-radius:6px;padding:10px 14px;cursor:pointer;font-family:'Cinzel',serif;font-weight:700;font-size:0.85em;letter-spacing:0.5px;box-shadow:0 3px 10px rgba(139,0,0,0.4);transition:all 0.2s;width:100%;text-align:center;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                        ${btnLabel}
                    </button>
                    <button onclick="printWantedPoster('${bounty.id}')" style="background:linear-gradient(145deg,#3a2000,#5a3500);color:#fff8dc;border:1px solid #b8860b;border-radius:6px;padding:8px 14px;cursor:pointer;font-family:'Cinzel',serif;font-weight:700;font-size:0.8em;letter-spacing:0.5px;transition:all 0.2s;width:100%;text-align:center;margin-top:4px;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                        🖨 Print Wanted Poster
                    </button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function closeBountyBoard() {
    document.getElementById('bountyBoardModal').style.display = 'none';
}

function printWantedPoster(bountyId) {
    const bounty = [...BOUNTY_BOARD, ...BOUNTY_BOARD_ALL].find(function(b){ return b.id === bountyId; });
    if (!bounty) { alert('Bounty not found'); return; }

    var avgLevel = Math.round((bounty.levelRange[0] + bounty.levelRange[1]) / 2);
    var baseXP = calculateXPForLevel(avgLevel);
    var killXP = bounty.isBoss ? Math.floor(baseXP * 4) : baseXP;
    var questXP = bounty.isBoss ? Math.floor(baseXP * 6) : Math.floor(baseXP * 2);
    var totalKillXP = killXP * bounty.count;
    var totalQuestXP = questXP * bounty.count;

    var pc = bounty.poster.indexOf('BOSS') !== -1 ? '#4a0080' : bounty.poster.indexOf('Alive Only') !== -1 ? '#1a6b3a' : '#8b0000';
    var bgStyle = bounty.isBoss
        ? 'background:linear-gradient(145deg,#fff8dc,#f5e68c);border:4px solid #b8860b;'
        : 'background:linear-gradient(145deg,#fffaf5,#f9f0e0);border:3px solid #8b0000;';

    var bSec = '';
    if (bounty.beware) {
        bSec = '<div class="section"><div class="sec-label" style="color:#c0392b;">Beware</div><div class="sec-body">' + bounty.beware + '</div></div>';
    }
    var nSec = '';
    if (bounty.needs) {
        nSec = '<div class="section"><div class="sec-label" style="color:#1a6b3a;">Requirements</div><div class="sec-body">' + bounty.needs + '</div></div>';
    }
    var multiNote = bounty.count > 1
        ? '<div class="xp-note">XP totals across all ' + bounty.count + ' targets &middot; ' + killXP.toLocaleString() + ' Kill / ' + questXP.toLocaleString() + ' Quest XP each</div>'
        : '';
    var multiTargets = bounty.count > 1
        ? '<div style="font-family:\'Cinzel\',serif;font-size:11px;color:#666;margin-top:6px;letter-spacing:1px;">' + bounty.count + ' TARGETS SOUGHT</div>'
        : '';
    var targetStr = bounty.count === 1 ? '1 Individual' : bounty.count + ' Individuals';
    var levelStr = 'Levels ' + bounty.levelRange[0] + '\u2013' + bounty.levelRange[1];

    var html = '<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n'
        + '<title>Wanted Poster</title>\n'
        + '<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">\n'
        + '<style>\n'
        + '* { box-sizing:border-box; margin:0; padding:0; }\n'
        + '@page { size:A4 portrait; margin:0; }\n'
        + 'body { font-family:\'Crimson Text\',Georgia,serif; background:#d0c9a8; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:30px 20px; flex-direction:column; }\n'
        + '.poster { ' + bgStyle + ' border-radius:4px; width:600px; max-width:100%; padding:0; box-shadow:0 8px 30px rgba(0,0,0,0.5); position:relative; overflow:hidden; }\n'
        + '.top-bar { background:' + pc + '; padding:10px 24px; }\n'
        + '.top-bar-inner { border:2px solid rgba(255,255,255,0.35); border-radius:2px; padding:12px 20px; text-align:center; }\n'
        + '.wanted-word { font-family:\'Cinzel\',serif; font-weight:900; font-size:42px; color:#fff8dc; letter-spacing:12px; text-transform:uppercase; text-shadow:2px 3px 6px rgba(0,0,0,0.5); line-height:1; }\n'
        + '.poster-type { font-family:\'Cinzel\',serif; font-size:13px; color:rgba(255,255,255,0.9); letter-spacing:4px; text-transform:uppercase; margin-top:4px; }\n'
        + '.content { padding:22px 28px; }\n'
        + '.title-block { text-align:center; padding:14px 0 16px; border-bottom:2px solid ' + pc + '; margin-bottom:14px; }\n'
        + '.bounty-title { font-family:\'Cinzel\',serif; font-weight:900; font-size:24px; color:#3a0000; }\n'
        + '.threat-badge { display:inline-block; background:' + pc + '; color:white; font-family:\'Cinzel\',serif; font-size:10px; font-weight:700; letter-spacing:1px; padding:3px 14px; border-radius:14px; margin-top:8px; text-transform:uppercase; }\n'
        + '.section { margin-bottom:10px; }\n'
        + '.sec-label { font-family:\'Cinzel\',serif; font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; color:' + pc + '; margin-bottom:3px; border-bottom:1px solid rgba(0,0,0,0.12); padding-bottom:2px; }\n'
        + '.sec-body { font-size:12px; line-height:1.5; color:#2a1a00; }\n'
        + '.info-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }\n'
        + '.reward-block { background:' + pc + '; border-radius:4px; padding:14px 20px; margin-top:14px; display:flex; align-items:center; justify-content:space-around; gap:10px; }\n'
        + '.reward-item { text-align:center; }\n'
        + '.reward-label { font-family:\'Cinzel\',serif; font-size:8px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:rgba(255,248,220,0.8); margin-bottom:4px; }\n'
        + '.reward-value { font-family:\'Cinzel\',serif; font-size:22px; font-weight:900; color:#fff8dc; line-height:1; }\n'
        + '.reward-div { width:1px; height:46px; background:rgba(255,248,220,0.3); }\n'
        + '.xp-note { font-size:10px; color:rgba(255,248,220,0.65); text-align:center; margin-top:6px; font-style:italic; }\n'
        + '.footer-bar { background:' + pc + '; padding:8px 24px; text-align:center; }\n'
        + '.footer-text { font-family:\'Cinzel\',serif; font-size:9px; color:rgba(255,255,255,0.7); letter-spacing:2px; text-transform:uppercase; }\n'
        + '.no-print { text-align:center; margin-top:20px; }\n'
        + '@media print { body { background:white; padding:0; } .poster { box-shadow:none; width:100%; max-width:100%; border-radius:0; } .no-print { display:none !important; } }\n'
        + '</style>\n</head>\n<body>\n'
        + '<div class="poster">\n'
        + '  <div class="top-bar"><div class="top-bar-inner">'
        + '<div class="wanted-word">WANTED</div>'
        + '<div class="poster-type">' + bounty.poster + '</div>'
        + '</div></div>\n'
        + '  <div class="content">\n'
        + '    <div class="title-block">'
        + '<div class="bounty-title">' + bounty.title + '</div>'
        + '<div class="threat-badge">' + bounty.threat + '</div>'
        + multiTargets
        + '</div>\n'
        + '    <div class="section"><div class="sec-label">Crime</div><div class="sec-body">' + bounty.crime + '</div></div>\n'
        + '    <div class="section"><div class="sec-label">Known Description</div><div class="sec-body">' + bounty.description + '</div></div>\n'
        + '    <div class="info-grid">'
        + '<div class="section"><div class="sec-label">Level Range</div><div class="sec-body">' + levelStr + '</div></div>'
        + '<div class="section"><div class="sec-label">Targets</div><div class="sec-body">' + targetStr + '</div></div>'
        + '</div>\n'
        + bSec + nSec
        + '    <div class="reward-block">'
        + '<div class="reward-item"><div class="reward-label">Gold Reward</div><div class="reward-value">' + bounty.reward + '</div></div>'
        + '<div class="reward-div"></div>'
        + '<div class="reward-item"><div class="reward-label">Kill XP</div><div class="reward-value">' + totalKillXP.toLocaleString() + '</div></div>'
        + '<div class="reward-div"></div>'
        + '<div class="reward-item"><div class="reward-label">Quest XP</div><div class="reward-value">' + totalQuestXP.toLocaleString() + '</div></div>'
        + '</div>\n'
        + multiNote
        + '  </div>\n'
        + '  <div class="footer-bar"><div class="footer-text">Posted by Order of the City Guard &amp; Merchants\' Guild &nbsp;&middot;&nbsp; Report to the nearest Guard Barracks</div></div>\n'
        + '</div>\n'
        + '<div class="no-print">'
        + '<button onclick="window.print()" style="background:#8b0000;color:white;border:none;padding:12px 30px;font-family:\'Cinzel\',serif;font-size:1em;font-weight:700;border-radius:6px;cursor:pointer;letter-spacing:1px;box-shadow:0 4px 14px rgba(0,0,0,0.3);">Print / Save as PDF</button>'
        + '<button onclick="window.close()" style="background:#555;color:white;border:none;padding:12px 20px;font-family:\'Cinzel\',serif;font-size:1em;font-weight:700;border-radius:6px;cursor:pointer;margin-left:10px;">Close</button>'
        + '</div>\n'
        + '</body>\n</html>';

    var win = window.open('', '_blank', 'width=720,height=950');
    if (!win) { alert('Please allow pop-ups for this page to print wanted posters.'); return; }
    win.document.open();
    win.document.write(html);
    win.document.close();
}

// Helper: calculate base XP by level (D&D 5e CR approximation by level)
function calculateXPForLevel(level) {
    const xpTable = {
        1:200, 2:450, 3:700, 4:1100, 5:1800, 6:2300, 7:2900, 8:3900,
        9:5000, 10:5900, 11:7200, 12:8400, 13:10000, 14:11500, 15:13000,
        16:15000, 17:18000, 18:20000, 19:22000, 20:25000
    };
    return xpTable[Math.min(20, Math.max(1, level))] || 200;
}

function generateFromBounty(bountyId) {
    // Search both current board and full pool
    const bounty = [...BOUNTY_BOARD, ...BOUNTY_BOARD_ALL].find(b => b.id === bountyId);
    if (!bounty) return;

    closeBountyBoard();

    const [minLvl, maxLvl] = bounty.levelRange;
    const npcsToGen = [];

    // Calculate XP values
    const avgLevel = Math.round((minLvl + maxLvl) / 2);
    const baseXP = calculateXPForLevel(avgLevel);
    const killXP = bounty.isBoss ? Math.floor(baseXP * 4) : baseXP;
    const questXP = bounty.isBoss ? Math.floor(baseXP * 6) : Math.floor(baseXP * 2);

    for (let i = 0; i < bounty.count; i++) {
        const npc = createNPC(bounty.isBoss && i === 0);
        const level = minLvl + Math.floor(Math.random() * (maxLvl - minLvl + 1));
        rebuildNPCDerivedCombatAndMagic(npc, level);

        // Full bounty data attached to NPC
        npc.bountyId = bountyId;
        npc.bountyTitle = bounty.title;
        npc.bountyReward = bounty.reward;
        npc.bountyCrime = bounty.crime;
        npc.bountyDescription = bounty.description;
        npc.bountyBackstory = bounty.backstory || '';
        npc.bountyBeware = bounty.beware;
        npc.bountyNeeds = bounty.needs;
        npc.bountyPoster = bounty.poster;
        npc.bountyThreat = bounty.threat;
        npc.bountyCount = bounty.count;
        npc.bountyIsBoss = bounty.isBoss;
        npc.isBountyTarget = true;
        npc.killXP = killXP;
        npc.questXP = questXP;
        npc.bountyItemRewards = getBountyItemReward(bounty);

        // Quest section override
        npc.quest = {
            type: "hostile",
            category: "Bounty Target",
            desc: `${bounty.crime}`,
            reward: bounty.reward
        };

        if (bounty.count > 1) {
            npc.groupRole = i === 0 ? "Primary Target" : (i === 1 ? "Second-in-Command" : "Associate");
            npc.groupName = bounty.title;
            npc.groupType = "Wanted Group";
            npc.groupGoal = `Evade capture and continue criminal operations.`;
            npc.groupMotto = "Hunted but not caught.";
        }

        npcsToGen.push(npc);
    }

    if (generatedNPCs.length > 0) {
        _pendingGenFn = () => npcsToGen;
        _pendingGenLabel = `Bounty: ${bounty.title} (${bounty.count} NPC${bounty.count > 1 ? 's' : ''})`;
        const sub = document.getElementById('genModeSubtitle');
        if (sub) sub.textContent = `You have ${generatedNPCs.length} NPC${generatedNPCs.length > 1 ? 's' : ''} on screen. What would you like to do?`;
        document.getElementById('genModeDialog').classList.add('active');
    } else {
        generatedNPCs = npcsToGen;
        renderAllNPCs();
        showToast(`Generated ${bounty.count} wanted NPC${bounty.count > 1 ? 's' : ''}: ${bounty.title} — ${bounty.reward} reward`, 'success');
    }
}

/* =========================================
   END BOUNTY BOARD FUNCTIONS
   =========================================*/

function generateShopkeeperOfType(shopType, isBoss = false) {
    const shopData = DB.shopTypes[shopType];
    const npc = createNPC(isBoss);
    
    // Override occupation
    npc.occupation = shopData.occupation;
    npc.shopType = shopType;
    npc.shopSpecialty = shopData.specialty;
    
    // Replace personality with shop-specific
    npc.personality.traits = shopData.personality;
    npc.personality.summary = shopData.personality.join(", ");
    
    // Replace quest with shop-related
    npc.quest = {
        type: "side",
        category: "Shopkeeper",
        desc: `This ${shopData.occupation} runs a ${shopType} and specializes in ${shopData.specialty}. They may have unique items, need help with supply problems, or have information about local events.`,
        reward: "Discounts, special items, information"
    };
    
    // Replace inventory with shop inventory
    npc.inventory = shopData.inventory.map(item => ({
        name: item.name,
        rarity: "common",
        type: item.type,
        cost: item.cost,
        dropChance: 1.0,
        dc: 0 // Shop items don't need Investigation checks
    }));
    
    // For Travelling Merchant, tag merchant ID on NPC for bodyguard generation
    if (shopType === 'Travelling Merchant') {
        npc.isTravellingMerchant = true;
        npc.merchantId = npc.id;
    }
    
    return npc;
}

function generateTravellingMerchantBodyguards(merchantId) {
    // Find the merchant from generated NPCs or just generate guards
    const merchant = generatedNPCs.find(n => n.id === merchantId);
    const merchantName = merchant ? merchant.name : 'the Travelling Merchant';
    
    // Generate 2-4 bodyguards as a Bodyguards group
    const guardCount = 2 + Math.floor(Math.random() * 3); // 2–4
    const guardNPCs = [];
    const guardGroupNames = [
        "Sellsword Escorts", "Hired Blades", "Road Wardens", "Caravan Guards", "The Merchant's Shadow", "Ironcloak Escorts"
    ];
    const groupName = guardGroupNames[Math.floor(Math.random() * guardGroupNames.length)];
    const guardRoles = ["Captain of the Guard", "Veteran Swordhand", "Scout & Outrider", "Rear Guard"];
    
    for (let i = 0; i < guardCount; i++) {
        const guard = createNPC(false);
        // Bodyguards tend to be fighter-type, level 3-7
        const guardLvl = 3 + Math.floor(Math.random() * 5);
        rebuildNPCDerivedCombatAndMagic(guard, guardLvl);
        guard.groupRole = guardRoles[i] || "Guard";
        guard.groupName = groupName;
        guard.groupType = "Bodyguards";
        guard.groupGoal = `Protect ${merchantName} and the merchant's goods at all costs during their travels.`;
        guard.groupMotto = "Coin paid, loyalty given.";
        guard.groupLeader = i === 0 ? guard.name : (guardNPCs[0] ? guardNPCs[0].name : merchantName);
        guard.occupation = i === 0 ? "Mercenary Captain" : pick(["Caravan Guard", "Mercenary", "Former Soldier", "Sellsword", "Road Warden"]);
        guard.quest = {
            type: "side",
            category: "Bodyguard",
            desc: `This ${guard.occupation} is employed as a personal guard for ${merchantName}, a travelling merchant. They are paid handsomely and are fiercely loyal for the duration of the contract. They travel dangerous roads and have seen much of the world at their employer's side.`,
            reward: "Loyalty to their employer"
        };
        guardNPCs.push(guard);
    }
    
    // Set leader
    if (guardNPCs.length > 0) {
        guardNPCs[0].groupRole = "Captain of the Guard";
        for (let i = 1; i < guardNPCs.length; i++) {
            guardNPCs[i].groupLeader = guardNPCs[0].name;
        }
    }
    
    // Add bodyguards alongside current NPCs
    if (generatedNPCs.length > 0) {
        _pendingGenFn = () => guardNPCs;
        _pendingGenLabel = `${groupName} — Bodyguards of ${merchantName}`;
        const sub = document.getElementById('genModeSubtitle');
        if (sub) sub.textContent = `Generate bodyguards for ${merchantName}? You have ${generatedNPCs.length} NPC${generatedNPCs.length > 1 ? 's' : ''} on screen.`;
        document.getElementById('genModeDialog').classList.add('active');
    } else {
        generatedNPCs = guardNPCs;
        renderAllNPCs();
        showToast(`Generated ${guardCount} bodyguards for ${merchantName}`, 'success');
    }
}

function saveAllNPCs() {
    if (generatedNPCs.length === 0) {
        showToast('No NPCs to save!', 'warning');
        return;
    }
    
    let vault = JSON.parse(localStorage.getItem('dm_vault') || '[]');
    
    // Check if all NPCs share a group name (group save)
    const firstNPC = generatedNPCs[0];
    const allSameGroup = generatedNPCs.length > 1 && firstNPC.groupName &&
        generatedNPCs.every(n => n.groupName === firstNPC.groupName);
    
    if (allSameGroup) {
        // Save as a single group entry
        const groupId = firstNPC.groupName + '_group_' + Date.now();
        const groupEntry = {
            _isGroup: true,
            id: groupId,
            groupName: firstNPC.groupName,
            groupType: firstNPC.groupType || 'Group',
            memberCount: generatedNPCs.length,
            members: generatedNPCs.map(n => ({...n})),
            savedAt: new Date().toISOString()
        };
        
        // Remove old group with same name if exists
        vault = vault.filter(v => !(v._isGroup && v.groupName === firstNPC.groupName));
        vault.push(groupEntry);
        if (!window._isOneShot) localStorage.setItem('dm_vault', JSON.stringify(vault));
        loadSavedNPCs();
        updateRelativeSelect();
        showToast(`Group "${firstNPC.groupName}" saved (${generatedNPCs.length} members)`, 'success');
        return;
    }
    
    // Individual saves
    let savedCount = 0;
    generatedNPCs.forEach(npc => {
        const index = vault.findIndex(v => !v._isGroup && v.id === npc.id);
        if (index >= 0) {
            vault[index] = npc;
        } else {
            vault.push(npc);
            savedCount++;
        }
    });
    
    if (!window._isOneShot) localStorage.setItem('dm_vault', JSON.stringify(vault));
    loadSavedNPCs();
    updateRelativeSelect();
    showToast(`Saved ${savedCount} new NPC${savedCount !== 1 ? 's' : ''} to vault`);
}

function closeAllNPCs() {
    if (generatedNPCs.length === 0) {
        showToast('No NPCs to close!', 'warning');
        return;
    }
    
    if (confirm(`Close all ${generatedNPCs.length} NPCs?`)) {
        generatedNPCs = [];
        renderAllNPCs();
        showToast('All NPCs closed');
    }
}

function deleteAllNPCs() {
    if (generatedNPCs.length === 0) {
        showToast('No NPCs on screen!', 'warning');
        return;
    }
    const count = generatedNPCs.length;
    const names = generatedNPCs.map(n => n.name).join(', ');
    const confirmed = confirm(`⚠️ Remove All NPCs\n\nThis will remove ${count} NPC${count !== 1 ? 's' : ''} from the screen:\n${names.length > 80 ? names.slice(0, 80) + '...' : names}\n\nUnsaved progress will be lost. Continue?`);
    if (!confirmed) return;
    generatedNPCs = [];
    renderAllNPCs();
    showToast(`Removed ${count} NPC${count !== 1 ? 's' : ''} from screen`);
}

function generateRelative() {
    const select = document.getElementById('relativeSelect');
    const relativeId = select.value;
    
    if (!relativeId) {
        showToast('Please select a saved NPC or group first!', 'warning');
        return;
    }
    
    const vault = JSON.parse(localStorage.getItem('dm_vault') || "[]");
    const entry = vault.find(n => n.id === relativeId);
    
    if (!entry) {
        showToast('Not found in vault!', 'warning');
        return;
    }
    
    // Route to group relative logic if a group was selected
    if (entry._isGroup) {
        const npc = createGroupRelative(entry);
        const label = `${npc.groupRelationship.type}: connected to ${entry.groupName}`;
        if (generatedNPCs.length > 0) {
            _pendingGenFn = () => [npc];
            _pendingGenLabel = label;
            const sub = document.getElementById('genModeSubtitle');
            if (sub) sub.textContent = `You have ${generatedNPCs.length} NPC${generatedNPCs.length > 1 ? 's' : ''} on screen. What would you like to do?`;
            document.getElementById('genModeDialog').classList.add('active');
        } else {
            generatedNPCs = [npc];
            renderAllNPCs();
            showToast(`Generated ${npc.groupRelationship.type} — connected to ${entry.groupName}`, 'success', 'relative');
        }
        return;
    }
    
    const isBossMode = document.getElementById('bossMode').checked;
    const relative = createRelative(entry, isBossMode);
    
    // Use smart dialog if NPCs on screen
    if (generatedNPCs.length > 0) {
        _pendingGenFn = () => [relative];
        _pendingGenLabel = `${relative.relationship.type} of ${entry.name}`;
        const sub = document.getElementById('genModeSubtitle');
        if (sub) sub.textContent = `You have ${generatedNPCs.length} NPC${generatedNPCs.length > 1 ? 's' : ''} on screen. What would you like to do?`;
        document.getElementById('genModeDialog').classList.add('active');
    } else {
        generatedNPCs = [relative];
        renderAllNPCs();
        showToast(`Generated ${relative.relationship.type} of ${entry.name}`, 'success', 'relative');
    }
}

function createRelative(original, forceBoss = false) {
    const relationship = pick(DB.relationships);
    const raceKey = Math.random() < 0.7 ? original.race : pick(Object.keys(DB.races));
    const classKey = Math.random() < 0.4 ? original.class : pick(Object.keys(DB.classes));
    let level = Math.max(1, original.level + (roll(6) - 3));
    const isBoss = forceBoss;
    if (isBoss) level = Math.max(level, 8);
    
    // Family members get same last name
    const familyRelationships = ["Parent", "Child", "Sibling", "Twin"];
    const isFamilyMember = familyRelationships.includes(relationship.type);
    
    const gender = Math.random() < 0.5 ? 'male' : 'female';
    let name;
    if (isFamilyMember && original.name.includes(" ")) {
        const originalLastName = original.name.split(" ").pop();
        name = generateName(raceKey, originalLastName, gender);
    } else {
        name = generateName(raceKey, null, gender);
    }
    
    const rData = DB.races[raceKey];
    const cData = DB.classes[classKey];
    let prof = Math.ceil(level / 4) + 1;
    
    let stats = {};
    Object.keys(original.stats).forEach(stat => {
        let base = original.stats[stat] + (roll(6) - 3);
        base = Math.max(8, Math.min(18, base));
        stats[stat] = base;
    });
    
    Object.keys(stats).forEach(k => {
        if(rData.mod.all) stats[k] += 1;
        if(rData.mod[k]) stats[k] += rData.mod[k];
    });
    
    const conMod = getMod(stats.CON);
    const dexMod = getMod(stats.DEX);
    const hpMax = (cData.hd + conMod) + ((level - 1) * (Math.floor(cData.hd/2) + 1 + conMod));
    
    let ac = 10 + dexMod; 
    if(cData.armor.includes("Chain")) ac = 16;
    if(cData.armor.includes("Scale")) ac = 14 + Math.min(dexMod, 2);
    if(cData.armor.includes("Leather")) ac = 11 + dexMod;
    if(cData.armor.includes("Plate")) ac = 18;
    if(cData.armor === "Unarmored") ac = 10 + dexMod + getMod(stats.CON);
    
    const attacks = generateAttacks(cData, stats, prof);
    
    let spellList = [];
    let spellSlots = null;
    let relSubclass = null;

    if(cData.spellcasting) {
        spellSlots = calculateSpellSlots(level, classKey);
        relSubclass = selectSubclass(classKey, level);
        const selectedSpells = selectSpellsForClass(classKey, level, cData.spellAbility, relSubclass);
        const spellDC = 8 + prof + getMod(stats[cData.spellAbility]);
        
        spellList.push({
            header: true,
            text: `<strong>Spell Save DC:</strong> ${spellDC} | <strong>Spell Attack:</strong> +${prof + getMod(stats[cData.spellAbility])}`
        });
        
        selectedSpells.forEach(spell => {
            spellList.push({
                name: spell.name,
                level: spell.level,
                data: spell,
                isDomain: spell.isDomain || false
            });
        });
    }
    
    const inventory = generateLoot(isBoss, level, classKey, raceKey);
    const appearance = generateAppearance(raceKey, isBoss, classKey);
    const personality = generatePersonality(isBoss);
    const quest = generateQuest(isBoss);
    const ageData = generateAge(raceKey);
    const occupation = generateOccupation();
    const startingCondition = generateStartingCondition();
    const subclass = relSubclass || selectSubclass(classKey, level);
    
    const relationshipQuality = Math.random() < relationship.variance ? 
        Math.floor(Math.random() * 40) + 60 :
        Math.floor(Math.random() * 40) + 10;
    
    const xpByLevel = {1:25,2:50,3:100,4:150,5:250,6:300,7:450,8:600,9:850,10:1100,
                        11:1250,12:1700,13:2100,14:2300,15:2800,16:3600,17:5000,18:6300,19:8400,20:10000};
    const baseXP = xpByLevel[Math.min(level, 20)] || 25;
    const killXP = isBoss ? Math.floor(baseXP * 4) : baseXP;
    const questXP = isBoss ? Math.floor(baseXP * 6) : Math.floor(baseXP * 2);
    
    var relativeNpc = {
        id: Date.now() + Math.random().toString(36).substr(2, 9),
        name,
        gender,
        race: raceKey,
        class: classKey,
        subclass: subclass,
        level,
        prof,
        isBoss: isBoss,
        isRelative: true,
        age: ageData.age,
        ageCategory: ageData.category,
        occupation: occupation,
        relativeOf: {
            id: original.id,
            name: original.name,
            relationship: relationship.type,
            quality: relationshipQuality
        },
        stats,
        hpMax,
        hpCurr: hpMax,
        ac,
        speed: rData.speed,
        attacks,
        spells: spellList,
        spellSlots: spellSlots,
        features: cData.features,
        inventory,
        appearance,
        physicalDesc: appearance.desc,
        personality: personality,
        quest: quest,
        killXP,
        questXP,
        dmNotes: '',
        isCombat: false,
        conditions: startingCondition ? [startingCondition] : [],
        startingCondition: startingCondition,
        initiative: null,
        relationship: relationship
    };
    return hbApplyExtrasToBuiltNPC(relativeNpc);
}

/* Build a minimal "original" NPC from a killed log entry so createRelative can be used (e.g. for revenge quest NPCs). */
function _syntheticOriginalFromKilledEntry(entry) {
    if (!entry) return null;
    var raceKeys = Object.keys(DB.races);
    var classKeys = Object.keys(DB.classes);
    function resolveKey(str, keys) {
        if (!str) return pick(keys);
        if (keys.includes(str)) return str;
        var title = str.charAt(0).toUpperCase() + (str.slice(1) || '').toLowerCase();
        if (keys.includes(title)) return title;
        return pick(keys);
    }
    var level = Math.max(1, parseInt(entry.npcLevel, 10) || 5);
    return {
        id: entry.id,
        name: entry.npcName || 'Fallen',
        race: resolveKey(entry.npcRace, raceKeys),
        class: resolveKey(entry.npcClass, classKeys),
        level: level,
        stats: { STR: 10, DEX: 10, CON: 10, INT: 10, WIS: 10, CHA: 10 }
    };
}

/* Generate NPCs for the current revenge quest using the same createRelative logic (relation + hunters). */
function generateRevengeQuestNPCs() {
    var data = window._currentQuestData;
    var entry = data && data.type === 'revenge' && data.revengeKilledEntry ? data.revengeKilledEntry : null;
    if (!entry) {
        if (typeof showToast === 'function') showToast('No revenge quest loaded — generate or load a revenge quest first.', 'warning');
        return;
    }
    var synthetic = _syntheticOriginalFromKilledEntry(entry);
    if (!synthetic) return;
    var isBoss = !!(entry.isBoss);
    var relation = createRelative(synthetic, isBoss);
    var hunters = [ createRelative(synthetic, false), createRelative(synthetic, false) ];
    var newNPCs = [ relation ].concat(hunters);
    var deadName = entry.npcName;
    var killerName = entry.killedBy || 'the party';
    newNPCs.forEach(function(n) {
        n.isHostileToKiller = true;
        n.hostileReason = deadName + ' was killed by ' + killerName;
        n.huntingPlayerName = killerName;
        n._revengeNPC = true;
        if (typeof _addHostileBannerToTab === 'function') _addHostileBannerToTab(n.id);
    });
    if (typeof generatedNPCs !== 'undefined' && generatedNPCs.length > 0) {
        _pendingGenFn = function() { return newNPCs; };
        _pendingGenLabel = 'Revenge NPCs (1 relation + 2 hunters) for ' + deadName;
        var sub = document.getElementById('genModeSubtitle');
        if (sub) sub.textContent = 'You have ' + generatedNPCs.length + ' NPC' + (generatedNPCs.length !== 1 ? 's' : '') + ' on screen. What would you like to do?';
        document.getElementById('genModeDialog').classList.add('active');
    } else {
        generatedNPCs = newNPCs;
        if (typeof renderAllNPCs === 'function') renderAllNPCs();
        if (typeof showToast === 'function') showToast('Generated revenge NPCs for ' + deadName + ' (1 relation + 2 hunters).', 'success', 'relative');
    }
    var tabs = document.getElementById('npcTabsContainer');
    if (tabs) tabs.scrollIntoView({ behavior: 'smooth' });
}

/* =========================================
   CORE NPC GENERATION
   ========================================= */
// Unified smart dialog system - works for all generate functions
let _pendingGenParams = null;  // for generateBatch
let _pendingGenFn = null;      // for storefront/relative/group — returns array of NPCs
let _pendingGenLabel = '';     // toast label

/* ── SW Generator NPC Bridge ──────────────────────────────────────────
   Called by Story & World Generator NPC buttons. Shares this script
   scope so it can directly read/write generatedNPCs & _pendingGenFn.
   npcArray  = already-built array of NPC objects from createNPC()
   label     = toast / dialog label string
──────────────────────────────────────────────────────────────────── */
function swBridgeGenNPCs(npcArray, label) {
    if (!npcArray || !npcArray.length) return;
    /* Switch to NPC tab */
    if (typeof switchMode === 'function') switchMode('npc');
    setTimeout(function() {
        if (generatedNPCs.length > 0) {
            /* Smart dialog — user picks replace or add */
            _pendingGenFn = function() { return npcArray; };
            _pendingGenLabel = label || (npcArray.length + ' NPC' + (npcArray.length !== 1 ? 's' : ''));
            var sub = document.getElementById('genModeSubtitle');
            if (sub) sub.textContent = 'You have ' + generatedNPCs.length + ' NPC' + (generatedNPCs.length > 1 ? 's' : '') + ' on screen. What would you like to do?';
            var dlg = document.getElementById('genModeDialog');
            if (dlg) dlg.classList.add('active');
        } else {
            generatedNPCs = npcArray;
            renderAllNPCs();
            if (typeof showToast === 'function') showToast('Generated ' + (label || npcArray.length + ' NPC(s)'), 'success', npcArray.some(function(n){return n.isBoss;}) ? 'boss' : '');
        }
    }, 80);
}

function generateBatch() {
    const qty = parseInt(document.getElementById('qtyInput').value) || 1;
    const isBoss = document.getElementById('bossMode').checked;
    _pendingGenParams = { qty, isBoss };
    _pendingGenFn = null;
    
    if (generatedNPCs.length > 0) {
        const sub = document.getElementById('genModeSubtitle');
        if (sub) sub.textContent = `You have ${generatedNPCs.length} NPC${generatedNPCs.length > 1 ? 's' : ''} on screen. What would you like to do?`;
        document.getElementById('genModeDialog').classList.add('active');
    } else {
        confirmGenerate(true);
    }
}

function closeGenDialog() {
    document.getElementById('genModeDialog').classList.remove('active');
    _pendingGenParams = null;
    _pendingGenFn = null;
    _pendingGenLabel = '';
}

function confirmGenerate(replace) {
    document.getElementById('genModeDialog').classList.remove('active');
    
    if (_pendingGenFn) {
        // Function-based generation (storefront, relative, group)
        const newNPCs = _pendingGenFn();
        const label = _pendingGenLabel || 'NPC(s)';
        _pendingGenFn = null;
        _pendingGenLabel = '';
        if (replace) {
            generatedNPCs = newNPCs;
        } else {
            generatedNPCs = [...generatedNPCs, ...newNPCs];
        }
        renderAllNPCs();
        showToast(`${replace ? 'Generated' : 'Added'} ${label}`, 'success');
    } else {
        // Batch NPC generation
        const { qty, isBoss } = _pendingGenParams || { qty: 1, isBoss: false };
        _pendingGenParams = null;
        if (replace) generatedNPCs = [];
        const singleNpcGroupName = 'Single NPCs';
        for (let i = 0; i < qty; i++) {
            const npc = createNPC(isBoss);
            if (qty === 1) {
                npc.groupName = singleNpcGroupName;
                npc.groupType = 'Solo';
                npc.groupGoal = 'Individual NPCs';
                npc.groupMotto = '—';
            }
            generatedNPCs.push(npc);
        }
        renderAllNPCs();
        showToast(`${replace ? 'Generated' : 'Added'} ${isBoss ? 'BOSS ' : ''}${qty} NPC${qty > 1 ? 's' : ''}`, 'success', isBoss ? 'boss' : '');
    }
}

/* ─── SUBCLASS SELECTION ─────────────────────────────────────────── */
function selectSubclass(classKey, level) {
    const data = DB.subclasses[classKey];
    if (!data) return null;
    if (level < data.unlockLevel) return null;
    const option = pick(data.options);
    // Filter features to only those unlocked at this level
    const unlocked = option.features.filter(f => f.level <= level);

    // Retrieve domain spells for this subclass (if any) up to current level
    const domainPool = DB.subclassSpells[option.name] || [];
    const domainSpells = [];
    domainPool.forEach(tier => {
        if (level >= tier.minLevel) {
            tier.spells.forEach(sp => {
                if (!domainSpells.find(s => s.name === sp.name)) {
                    domainSpells.push({...sp, isDomain: true});
                }
            });
        }
    });

    // Grant spellcasting for third-caster subclasses (EK, AT)
    const grantsSpellcasting = !!option.grantsSpellcasting || ["Eldritch Knight", "Arcane Trickster"].includes(option.name);

    // For Circle of the Land, pick a terrain variant for domain spells
    let finalName = option.name;
    if (option.name === "Circle of the Land") {
        const terrains = ["Arctic","Coast","Desert","Forest","Grassland","Mountain","Swamp","Underdark"];
        const terrain = pick(terrains);
        finalName = `Circle of the Land (${terrain})`;
        // Override domainSpells with terrain-specific ones
        const terrainPool = DB.subclassSpells[finalName] || [];
        domainSpells.length = 0;
        terrainPool.forEach(tier => {
            if (level >= tier.minLevel) {
                tier.spells.forEach(sp => {
                    if (!domainSpells.find(s => s.name === sp.name)) {
                        domainSpells.push({...sp, isDomain: true});
                    }
                });
            }
        });
    }

    return {
        name:     finalName,
        features: unlocked,
        domainSpells: domainSpells,
        grantsSpellcasting: grantsSpellcasting
    };
}

// Third-caster spell slot table (1/3 of full caster)
function getThirdCasterSlots(level) {
    if (level < 3) return null;
    const table = {
        3:[2], 4:[3], 5:[3], 6:[3], 7:[4,2], 8:[4,2], 9:[4,2], 10:[4,3],
        11:[4,3], 12:[4,3], 13:[4,3,2], 14:[4,3,2], 15:[4,3,2], 16:[4,3,3],
        17:[4,3,3], 18:[4,3,3], 19:[4,3,3,1], 20:[4,3,3,1]
    };
    const available = table[Math.min(20, level)] || [2];
    const slots = {};
    available.forEach((count, i) => { slots[i+1] = {max:count, current:count}; });
    const totalSlots = available.reduce((a,b) => a+b, 0);
    return { type:"standard", slots, maxSlots:totalSlots, currentSlots:totalSlots };
}

function rebuildNPCDerivedCombatAndMagic(npc, targetLevel) {
    if (!npc || typeof npc !== 'object') return npc;
    const classKey = npc.class;
    const raceKey = npc.race;
    const cData = DB.classes[classKey];
    const rData = DB.races[raceKey];
    if (!cData || !rData || !npc.stats) return npc;

    let level = parseInt(targetLevel, 10);
    if (isNaN(level)) level = parseInt(npc.level, 10) || 1;
    level = Math.max(1, Math.min(20, level));
    npc.level = level;

    let prof = Math.ceil(level / 4) + 1;
    if (npc.isBoss) prof += 2;
    npc.prof = prof;

    const conMod = getMod(npc.stats.CON);
    const dexMod = getMod(npc.stats.DEX);
    let hpMax = (cData.hd + conMod) + ((level - 1) * (Math.floor(cData.hd/2) + 1 + conMod));
    if (npc.isBoss) hpMax = Math.floor(hpMax * 2.5);
    const oldMax = Math.max(1, parseInt(npc.hpMax, 10) || hpMax);
    const oldCurr = Math.max(0, parseInt(npc.hpCurr, 10) || hpMax);
    const hpRatio = Math.max(0, Math.min(1, oldCurr / oldMax));
    npc.hpMax = hpMax;
    npc.hpCurr = Math.max(1, Math.min(hpMax, Math.round(hpMax * hpRatio)));

    let ac = 10 + dexMod;
    if (cData.armor.includes('Chain')) ac = 16;
    if (cData.armor.includes('Scale')) ac = 14 + Math.min(dexMod, 2);
    if (cData.armor.includes('Leather')) ac = 11 + dexMod;
    if (cData.armor.includes('Plate')) ac = 18;
    if (cData.armor === 'Unarmored') ac = 10 + dexMod + getMod(npc.stats.CON);
    if (npc.isBoss) ac += 2;
    npc.ac = ac;
    npc.speed = rData.speed;
    npc.attacks = generateAttacks(cData, npc.stats, prof, !!npc.isBoss, level);

    const subclass = selectSubclass(classKey, level);
    npc.subclass = subclass;

    let spellList = [];
    let spellSlots = null;
    const isThirdCasterSub = subclass && subclass.grantsSpellcasting;
    const isSpellcaster = cData.spellcasting || isThirdCasterSub;
    const effectiveSpellAbility = cData.spellAbility || (isThirdCasterSub ? 'INT' : null);
    if (isSpellcaster) {
        spellSlots = isThirdCasterSub ? getThirdCasterSlots(level) : calculateSpellSlots(level, classKey);
        const selectedSpells = selectSpellsForClass(classKey, level, effectiveSpellAbility, subclass);
        const spellDC = 8 + prof + getMod(npc.stats[effectiveSpellAbility]);
        spellList.push({
            header: true,
            text: '<strong>Spell Save DC:</strong> ' + spellDC + ' | <strong>Spell Attack:</strong> +' + (prof + getMod(npc.stats[effectiveSpellAbility]))
        });
        selectedSpells.forEach(function(spell){
            spellList.push({ name: spell.name, level: spell.level, data: spell, isDomain: spell.isDomain || false });
        });
    }
    npc.spells = spellList;
    npc.spellSlots = spellSlots;
    npc.features = cData.features;

    const xpByLevel = {1:25,2:50,3:100,4:150,5:250,6:300,7:450,8:600,9:850,10:1100,11:1250,12:1700,13:2100,14:2300,15:2800,16:3600,17:5000,18:6300,19:8400,20:10000};
    const baseXP = xpByLevel[Math.min(level, 20)] || 25;
    npc.killXP = npc.isBoss ? Math.floor(baseXP * 4) : baseXP;
    npc.questXP = npc.isBoss ? Math.floor(baseXP * 6) : Math.floor(baseXP * 2);
    return npc;
}

/* ─── Advanced NPC Options Helpers ──────────────────────────────── */
function getAdvancedNPCOptions() {
    var src = (document.getElementById('npcContentSource') || {}).value || 'all';
    var gen = (document.getElementById('npcGenderPref') || {}).value || '';
    var align = (document.getElementById('npcAlignmentPref') || {}).value || '';
    var spellOnly = !!(document.getElementById('npcForceSpellcaster') || {}).checked;
    var martialOnly = !!(document.getElementById('npcForceMartial') || {}).checked;
    if (spellOnly && martialOnly) martialOnly = false;
    return { source: src, gender: gen, alignment: align, spellcasterOnly: spellOnly, martialOnly: martialOnly };
}

function getFilteredRaceKeys(source) {
    var allKeys = Object.keys(DB.races);
    if (source === 'all' || !window._hbBaseDB) return allKeys;
    var baseKeys = Object.keys(window._hbBaseDB.races || {});
    if (source === 'official') return allKeys.filter(function(k) { return baseKeys.indexOf(k) !== -1; });
    if (source === 'homebrew') return allKeys.filter(function(k) { return baseKeys.indexOf(k) === -1; });
    return allKeys;
}

function getFilteredClassKeys(source, spellcasterOnly, martialOnly) {
    var allKeys = Object.keys(DB.classes);
    var filtered = allKeys;
    if (source !== 'all' && window._hbBaseDB) {
        var baseKeys = Object.keys(window._hbBaseDB.classes || {});
        if (source === 'official') filtered = filtered.filter(function(k) { return baseKeys.indexOf(k) !== -1; });
        if (source === 'homebrew') filtered = filtered.filter(function(k) { return baseKeys.indexOf(k) === -1; });
    }
    if (spellcasterOnly) filtered = filtered.filter(function(k) { return DB.classes[k] && DB.classes[k].spellcasting; });
    if (martialOnly) filtered = filtered.filter(function(k) { return DB.classes[k] && !DB.classes[k].spellcasting; });
    return filtered.length > 0 ? filtered : allKeys;
}

function createNPC(forceBoss = false) {
    const opts = getAdvancedNPCOptions();
    const racePool = getFilteredRaceKeys(opts.source);
    const classPool = getFilteredClassKeys(opts.source, opts.spellcasterOnly, opts.martialOnly);

    const raceKey = document.getElementById('raceSel').value || pick(racePool);
    const classKey = document.getElementById('classSel').value || pick(classPool);
    let level = parseInt(document.getElementById('lvlSel').value) || (forceBoss ? roll(5) + 10 : roll(12));
    
    const isBoss = forceBoss || (Math.random() < 0.05 && level >= 5);
    if (isBoss && !forceBoss) level = Math.max(level, 8);
    
    const gender = opts.gender || (Math.random() < 0.5 ? 'male' : 'female');
    const name = generateName(raceKey, null, gender);
    
    const rData = DB.races[raceKey];
    const cData = DB.classes[classKey];
    let prof = Math.ceil(level / 4) + 1;
    
    if (isBoss) prof += 2;

    let stats = {STR:10, DEX:10, CON:10, INT:10, WIS:10, CHA:10};
    Object.keys(stats).forEach(k => {
        let base = isBoss ? roll(6) + 12 : roll(8) + 8;
        stats[k] = base;
    });
    
    Object.keys(stats).forEach(k => {
        if(rData.mod.all) stats[k] += 1;
        if(rData.mod[k]) stats[k] += rData.mod[k];
    });

    if (isBoss) {
        const mainStat = cData.save[0];
        stats[mainStat] = Math.min(20, stats[mainStat] + 4);
        stats.CON = Math.min(20, stats.CON + 2);
    }

    const conMod = getMod(stats.CON);
    const dexMod = getMod(stats.DEX);
    let hpMax = (cData.hd + conMod) + ((level - 1) * (Math.floor(cData.hd/2) + 1 + conMod));
    if (isBoss) hpMax = Math.floor(hpMax * 2.5);
    
    let ac = 10 + dexMod; 
    if(cData.armor.includes("Chain")) ac = 16;
    if(cData.armor.includes("Scale")) ac = 14 + Math.min(dexMod, 2);
    if(cData.armor.includes("Leather")) ac = 11 + dexMod;
    if(cData.armor.includes("Plate")) ac = 18;
    if(cData.armor === "Unarmored") ac = 10 + dexMod + getMod(stats.CON);
    if (isBoss) ac += 2;

    const attacks = generateAttacks(cData, stats, prof, isBoss, level);

    // Select subclass FIRST so domain spells can be added to spell list
    const subclass = selectSubclass(classKey, level);

    let spellList = [];
    let spellSlots = null;
    
    // Determine effective spellcasting (includes third-caster subclasses)
    const isThirdCasterSub = subclass && subclass.grantsSpellcasting;
    const isSpellcaster = cData.spellcasting || isThirdCasterSub;
    const effectiveSpellAbility = cData.spellAbility || (isThirdCasterSub ? "INT" : null);
    
    if(isSpellcaster) {
        spellSlots = isThirdCasterSub ? getThirdCasterSlots(level) : calculateSpellSlots(level, classKey);
        const selectedSpells = selectSpellsForClass(classKey, level, effectiveSpellAbility, subclass);
        const spellDC = 8 + prof + getMod(stats[effectiveSpellAbility]);
        
        spellList.push({
            header: true,
            text: `<strong>Spell Save DC:</strong> ${spellDC} | <strong>Spell Attack:</strong> +${prof + getMod(stats[effectiveSpellAbility])}`
        });
        
        selectedSpells.forEach(spell => {
            spellList.push({
                name: spell.name,
                level: spell.level,
                data: spell,
                isDomain: spell.isDomain || false
            });
        });
    }

    const inventory = generateLoot(isBoss, level, classKey, raceKey);
    const appearance = generateAppearance(raceKey, isBoss, classKey);
    const personality = generatePersonality(isBoss);
    let quest = generateQuest(isBoss);
    const ageData = generateAge(raceKey);
    const occupation = generateOccupation();
    const startingCondition = generateStartingCondition();
    // subclass already selected above
    
    // Link to story if story link is enabled
    let storyLinkNote = '';
    if (typeof _swStoryLinked !== 'undefined' && _swStoryLinked && typeof _swCurrentStory !== 'undefined' && _swCurrentStory) {
        storyLinkNote = '\n\n🔗 Linked to Story: "' + (_swCurrentStory.title || 'Current Story') + '"\n';
        storyLinkNote += 'This NPC is connected to the active story. Consider how they relate to: ' + (_swCurrentStory.antagonist || 'the antagonist') + '.\n';
        storyLinkNote += 'Their role may connect to: ' + (_swCurrentStory.goal || 'the main goal') + '.';
        // Modify quest to reference story
        if (quest && quest.desc) {
            quest.desc = quest.desc + ' This quest relates to the active story: "' + (_swCurrentStory.title || 'Current Story') + '".';
        }
    }
    
    // XP tables based on D&D 5E Challenge Rating approximations
    const xpByLevel = {1:25,2:50,3:100,4:150,5:250,6:300,7:450,8:600,9:850,10:1100,
                        11:1250,12:1700,13:2100,14:2300,15:2800,16:3600,17:5000,18:6300,19:8400,20:10000};
    const baseXP = xpByLevel[Math.min(level, 20)] || 25;
    const killXP = isBoss ? Math.floor(baseXP * 4) : baseXP;
    const questXP = isBoss ? Math.floor(baseXP * 6) : Math.floor(baseXP * 2);

    var npc = {
        id: Date.now() + Math.random().toString(36).substr(2, 9),
        name,
        race: raceKey,
        class: classKey,
        subclass: subclass,
        level,
        prof,
        isBoss,
        isRelative: false,
        gender,
        age: ageData.age,
        ageCategory: ageData.category,
        occupation: occupation,
        stats,
        hpMax,
        hpCurr: hpMax,
        ac,
        speed: rData.speed,
        attacks,
        spells: spellList,
        spellSlots: spellSlots,
        features: cData.features,
        inventory,
        appearance,
        physicalDesc: appearance.desc,
        personality: personality,
        quest: quest,
        killXP,
        questXP,
        alignment: opts.alignment || generateAlignment(classKey, isBoss),
        languages: generateLanguages(raceKey),
        legendaryResistances: isBoss ? 3 : 0,
        legendaryResistancesUsed: 0,
        legendaryActions: isBoss ? 3 : 0,
        legendaryActionsUsed: 0,
        dmNotes: storyLinkNote,
        isCombat: false,
        conditions: startingCondition ? [startingCondition] : [],
        startingCondition: startingCondition,
        initiative: null
    };
    return hbApplyExtrasToBuiltNPC(npc);
}

function generateAttacks(cData, stats, prof, isBoss = false, level = 1) {
    const attacks = [];
    const mainStat = cData.save[0];
    const atkMod = getMod(stats[mainStat]) + prof;
    const dmgMod = getMod(stats[mainStat]);
    
    const weapon = pick(cData.weps);
    let die = "1d8";
    let dmgType = "slashing";
    
    if(weapon.includes("Dagger")) { die = "1d4"; dmgType = "piercing"; }
    else if(weapon.includes("Greataxe")) { die = "1d12"; dmgType = "slashing"; }
    else if(weapon.includes("Greatsword")) { die = "2d6"; dmgType = "slashing"; }
    else if(weapon.includes("Mace") || weapon.includes("Warhammer")) { die = "1d6"; dmgType = "bludgeoning"; }
    else if(weapon.includes("Longsword")) { die = "1d8"; dmgType = "slashing"; }
    else if(weapon.includes("Quarterstaff")) { die = "1d6"; dmgType = "bludgeoning"; }
    else if(weapon.includes("Shortsword") || weapon.includes("Rapier")) { die = "1d6"; dmgType = "piercing"; }
    else if(weapon.includes("bow")) { die = "1d8"; dmgType = "piercing"; }
    
    attacks.push({
        name: weapon,
        type: "Weapon",
        range: weapon.includes("bow") || weapon.includes("Crossbow") ? "Ranged" : "Melee",
        roll: `+${atkMod}`,
        dmg: `${die}+${dmgMod}`,
        dmgType: dmgType,
        desc: `Standard ${weapon.toLowerCase()} attack`
    });

    if (isBoss && level >= 5) {
        attacks.push({
            name: "Multiattack",
            type: "Special",
            range: "Self",
            roll: "-",
            dmg: "2-3 attacks",
            dmgType: "varies",
            desc: "Make two or three weapon attacks per action"
        });
    }
    
    return attacks;
}

/* =========================================
   NPC TABS AND RENDERING
   ========================================= */
function renderAllNPCs() {
    const container = document.getElementById('displayArea');
    const tabsContainer = document.getElementById('npcTabsContainer');
    const tabsDiv = document.getElementById('npcTabs');
    const batchControls = document.getElementById('batchControls');
    const previousActiveId = activeNPCId;
    
    // Clear existing
    container.innerHTML = '';
    tabsDiv.innerHTML = '';
    
    const party = (typeof _party !== 'undefined' && Array.isArray(_party)) ? _party : [];
    const hasParty = party.length > 0;

    if (generatedNPCs.length === 0 && !hasParty) {
        activeNPCId = null;
        batchControls.style.display = 'none';
        container.innerHTML = `
            <div class="empty-state">
                <div style="font-size: 3em; margin-bottom: 20px;">🎲</div>
                Ready to generate legendary NPCs.<br>
                Select your parameters and forge your characters.
            </div>
        `;
        if (tabsContainer) tabsContainer.classList.remove('active');
        return;
    }

    if (generatedNPCs.length === 0 && hasParty) {
        activeNPCId = null;
        batchControls.style.display = 'flex';
        container.innerHTML = '';
        tabsDiv.innerHTML = '';
        tabsContainer.classList.add('active');
        _renderPlayersGroupOnly(tabsDiv, party);
        setTimeout(function() {
            if (typeof _renderPartyInitInputs === 'function') _renderPartyInitInputs();
            if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
        }, 50);
        return;
    }

    const activeMatch = generatedNPCs.find(n => String(n.id) === String(previousActiveId));
    const activeId = activeMatch ? activeMatch.id : generatedNPCs[0].id;
    
    // Show batch controls if any NPCs exist or party has members
    if (generatedNPCs.length >= 1 || hasParty) {
        batchControls.style.display = 'flex';
    } else {
        batchControls.style.display = 'none';
    }
    
    // Sync Combat All button label
    const _combatAllBtn = document.getElementById('combatAllBtn');
    if (_combatAllBtn) {
        const allInCombat = generatedNPCs.length > 0 && generatedNPCs.every(n => n.isCombat);
        _combatAllBtn.textContent = allInCombat ? 'End Combat (All)' : 'Combat Mode (All)';
    }
    
    // Show tabs if any NPCs exist
    if (generatedNPCs.length >= 1) {
        tabsContainer.classList.add('active');
        
        // Add group banner if this is a group
        const firstNPC = generatedNPCs[0];
        if (firstNPC.groupName) {
            const groupBanner = document.createElement('div');
            groupBanner.style.cssText = 'background: linear-gradient(145deg, var(--gold) 0%, #966f0a 100%); color: white; padding: 12px 20px; border-radius: 6px; margin-bottom: 12px; border: 2px solid var(--red);';
            const goal = firstNPC.groupGoal != null ? firstNPC.groupGoal : '';
            const motto = firstNPC.groupMotto != null ? firstNPC.groupMotto : '';
            const goalMottoLine = (goal || motto) ? '<div style="font-size: 0.9em; opacity: 0.95;"><strong>Goal:</strong> ' + goal + (goal && motto ? ' | ' : '') + (motto ? '<strong>Motto:</strong> "' + motto + '"' : '') + '</div>' : '';
            groupBanner.innerHTML = '<div style="font-family: \'Cinzel\', serif; font-weight: 700; font-size: 1.1em; margin-bottom: 5px;">' + (firstNPC.groupType || 'Group') + ': ' + firstNPC.groupName + '</div>' + goalMottoLine;
            tabsDiv.appendChild(groupBanner);
        }
        
        // ── GROUP COLOR PALETTE ──────────────────────────────────
        const groupColorPalette = [
            { h: 200, s: 70, l: 38 },
            { h: 150, s: 55, l: 30 },
            { h: 10,  s: 75, l: 38 },
            { h: 50,  s: 80, l: 32 },
            { h: 170, s: 60, l: 30 },
            { h: 320, s: 55, l: 35 },
            { h: 240, s: 60, l: 38 },
            { h: 30,  s: 70, l: 35 },
        ];
        const groupColorIndex = {};
        let colorIdx = 0;
        generatedNPCs.forEach(npc => {
            if (npc.groupName && !(npc.groupName in groupColorIndex)) {
                groupColorIndex[npc.groupName] = colorIdx % groupColorPalette.length;
                colorIdx++;
            }
        });

        // ── BUILD GROUPED RENDER ORDER ────────────────────────
        // Prepend "Players" segment when party has members (so players appear in Generated NPCs, initiative order 1st→last)
        const segments = [];
        if (hasParty) {
            const stateMap = window._playerInitState || {};
            const members = party.map(p => ({
                id: p.id,
                name: p.name || 'Player',
                cls: p.cls || '',
                hpCurr: p.hpCurr || 0,
                hpMax: p.hpMax || 0,
                roll: Number.isFinite(stateMap[p.id]) ? stateMap[p.id] : null
            })).sort((a, b) => {
                if (a.roll != null && b.roll != null) return b.roll - a.roll;
                if (a.roll != null) return -1;
                if (b.roll != null) return 1;
                return 0;
            });
            segments.push({ type: 'players', groupName: 'Players', groupType: 'Players', members: members });
        }
        // segment = { type:'solo'|'group'|'players', groupName?, groupType?, npcs:[] | members:[] }
        let currentSeg = null;
        generatedNPCs.forEach(npc => {
            const gName = npc.groupName || null;
            if (!gName) {
                // Solo NPC
                if (!currentSeg || currentSeg.type !== 'solo') {
                    currentSeg = { type: 'solo', npcs: [] };
                    segments.push(currentSeg);
                }
                currentSeg.npcs.push(npc);
            } else {
                // Grouped NPC — open a new group segment if needed
                if (!currentSeg || currentSeg.type !== 'group' || currentSeg.groupName !== gName) {
                    currentSeg = { type: 'group', groupName: gName, groupType: npc.groupType || 'Group', npcs: [] };
                    segments.push(currentSeg);
                }
                currentSeg.npcs.push(npc);
            }
        });

        // Helper: build a single tab element
        function buildTab(npc, globalIndex) {
            const tab = document.createElement('div');
            const isLeader = npc.groupRole === "Leader" || npc.groupRole === "Master";
            const isRelativeNPC = npc.isRelative || npc.isGroupRelative;
            tab.className = `npc-tab ${npc.isBoss ? 'boss' : ''} ${npc.id === activeId ? 'active' : ''}`;
            tab.dataset.npcId = npc.id;

            if (npc.groupName && npc.groupName in groupColorIndex) {
                const ci = groupColorIndex[npc.groupName];
                const col = groupColorPalette[ci];
                if (isLeader) {
                    tab.style.cssText = `background:linear-gradient(135deg,hsl(${col.h},${col.s}%,${col.l}%) 0%,hsl(45,80%,45%) 50%,hsl(${col.h},${col.s}%,${Math.max(col.l-10,10)}%) 100%);border:3px solid hsl(45,90%,55%);color:white;box-shadow:0 0 14px hsla(${col.h},${col.s}%,${col.l}%,0.5);font-weight:900;text-shadow:1px 1px 3px rgba(0,0,0,0.7);`;
                } else {
                    tab.style.cssText = `background:linear-gradient(145deg,hsl(${col.h},${col.s}%,${col.l+22}%) 0%,hsl(${col.h},${col.s}%,${col.l+12}%) 100%);border:2px solid hsl(${col.h},${col.s}%,${col.l}%);color:hsl(${col.h},${col.s}%,${Math.max(col.l-18,8)}%);`;
                }
            } else if (isRelativeNPC) {
                tab.style.cssText = 'background:linear-gradient(145deg,#7b5ea7 0%,#5a3d8a 100%);border:2px solid #9b79c7;color:white;text-shadow:1px 1px 2px rgba(0,0,0,0.5);';
            } else if (isLeader) {
                tab.style.cssText = 'background:linear-gradient(135deg,#b8860b 0%,#ffd700 50%,#b8860b 100%);border:3px solid #8b0000;color:white;box-shadow:0 0 14px rgba(255,215,0,0.7);font-weight:900;';
            }

            tab.onclick = () => switchToNPC(npc.id);

            const hpPct = Math.round((npc.hpCurr / npc.hpMax) * 100);
            const hpColor = hpPct > 75 ? 'var(--success)' : hpPct > 50 ? 'var(--gold)' : hpPct > 25 ? 'orange' : 'var(--danger)';
            const isColoredTab = (npc.groupName && npc.groupName in groupColorIndex && isLeader) || isRelativeNPC;
            const nameColor = isColoredTab ? 'white' : (npc.groupName && npc.groupName in groupColorIndex ? 'inherit' : '');

            let relativeLabel = '';
            if (npc.isRelative && npc.relationship) relativeLabel = `<span style="font-size:0.68em;opacity:0.85;margin-left:4px;">[${npc.relationship.type}]</span>`;
            else if (npc.isGroupRelative && npc.groupRelationship) relativeLabel = `<span style="font-size:0.68em;opacity:0.85;margin-left:4px;">[${npc.groupRelationship.type}]</span>`;

            const roleTag = npc.groupRole && !isLeader ? `<span style="opacity:0.65;font-size:0.68em;margin-left:3px;">[${npc.groupRole.toUpperCase()}]</span>` : '';

            tab.innerHTML = `
                <div class="tab-name" style="${nameColor ? 'color:'+nameColor+';' : ''}">
                    ${isLeader ? '👑 ' : npc.isBoss ? '💀 ' : isRelativeNPC ? '🔗 ' : ''}${npc.name}
                    ${npc.initiative !== null ? `<span style="background:var(--gold);color:white;padding:1px 5px;border-radius:3px;font-size:0.72em;margin-left:4px;font-weight:700;">⚡${npc.initiative}</span>` : ''}
                    ${isLeader ? '<span style="background:rgba(255,255,255,0.22);font-size:0.68em;margin-left:4px;padding:1px 4px;border-radius:3px;font-weight:900;">LEADER</span>' : ''}
                    ${roleTag}${relativeLabel}
                </div>
                <div class="tab-info" style="${isColoredTab ? 'color:rgba(255,255,255,0.88);' : ''}">
                    Lvl ${npc.level} ${npc.race} ${npc.class}
                    <div style="margin-top:2px;">
                        <span style="color:${hpColor};font-weight:700;">HP ${npc.hpCurr}/${npc.hpMax}</span>
                        <span style="font-size:0.82em;opacity:0.7;"> (${hpPct}%)</span>
                    </div>
                </div>`;
            return tab;
        }

        // ── RENDER SEGMENTS INTO TABS DIV ─────────────────────
        let globalIdx = 0;
        segments.forEach(seg => {
            if (seg.type === 'players') {
                const bracket = document.createElement('div');
                bracket.className = 'npc-tab-group-bracket';
                bracket.style.cssText = 'border: 2px solid rgba(46,204,113,0.7);';
                const header = document.createElement('div');
                header.className = 'npc-tab-group-header';
                header.style.cssText = 'background:linear-gradient(135deg,rgba(46,160,80,0.9),rgba(30,100,50,0.95));';
                header.innerHTML = '<span style="font-family:\'Cinzel\',serif;font-weight:700;color:white;font-size:0.82em;">🧑 Players</span><span style="font-size:0.72em;color:rgba(255,255,255,0.8);margin-left:auto;">' + seg.members.length + ' member' + (seg.members.length !== 1 ? 's' : '') + '</span>';
                bracket.appendChild(header);
                const membersRow = document.createElement('div');
                membersRow.className = 'npc-tab-group-members';
                membersRow.id = 'playersGroupMembers';
                membersRow.style.cssText = 'background:rgba(46,204,113,0.12);';
                const sortedMembers = seg.members.slice().sort((a, b) => {
                    if (a.roll != null && b.roll != null) return b.roll - a.roll;
                    if (a.roll != null) return -1;
                    if (b.roll != null) return 1;
                    return 0;
                });
                let html = '';
                sortedMembers.forEach((m, idx) => {
                    const rank = m.roll != null ? (idx + 1) : '?';
                    const rankStyle = rank === 1 ? 'background:var(--gold);color:#111;' : 'background:rgba(80,80,80,0.6);color:#eee;';
                    html += '<div class="player-init-row" style="display:flex;align-items:center;gap:8px;padding:6px 10px;margin:4px 0;background:rgba(0,0,0,0.2);border-radius:6px;border:1px solid rgba(46,204,113,0.35);">' +
                        '<span style="min-width:22px;height:22px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75em;' + rankStyle + '">' + rank + '</span>' +
                        '<span style="flex:1;color:#a8e8a8;font-weight:700;">' + (m.name || 'Player') + '</span>' +
                        '<span style="font-size:0.75em;opacity:0.8;">' + (m.cls || '') + ' · HP ' + m.hpCurr + '/' + m.hpMax + '</span>' +
                        '<input type="number" class="player-init-input" min="1" max="30" value="' + (m.roll != null ? m.roll : '') + '" placeholder="Init" oninput="updatePlayerInitiativeRoll(\'' + m.id + '\', this.value); if(typeof refreshPlayersGroupDisplay===\'function\')refreshPlayersGroupDisplay();" style="width:52px;padding:4px;">' +
                        '</div>';
                });
                membersRow.innerHTML = html;
                bracket.appendChild(membersRow);
                tabsDiv.appendChild(bracket);
                return;
            }
            if (seg.type === 'solo') {
                seg.npcs.forEach(npc => {
                    tabsDiv.appendChild(buildTab(npc, globalIdx));
                    globalIdx++;
                });
            } else {
                // Group bracket
                const ci = groupColorIndex[seg.groupName] ?? 0;
                const col = groupColorPalette[ci];
                const bracketH = `hsl(${col.h},${col.s}%,${col.l}%)`;
                const bracketHLight = `hsl(${col.h},${col.s}%,${col.l+32}%)`;

                const bracket = document.createElement('div');
                bracket.className = 'npc-tab-group-bracket';
                bracket.style.cssText = `border: 2px solid ${bracketH};`;

                // Group header bar
                const header = document.createElement('div');
                header.className = 'npc-tab-group-header';
                header.style.cssText = `background:linear-gradient(135deg,${bracketH},hsl(${col.h},${col.s}%,${Math.max(col.l-8,10)}%));`;
                header.innerHTML = `
                    <span style="font-family:'Cinzel',serif;font-weight:700;color:white;font-size:0.82em;text-shadow:1px 1px 2px rgba(0,0,0,0.5);">
                        ⚔ ${seg.groupType}: ${seg.groupName}
                    </span>
                    <span style="font-size:0.72em;color:rgba(255,255,255,0.8);margin-left:auto;">${seg.npcs.length} member${seg.npcs.length>1?'s':''}</span>`;
                bracket.appendChild(header);

                // Members row inside bracket
                const membersRow = document.createElement('div');
                membersRow.className = 'npc-tab-group-members';
                membersRow.style.cssText = `background:${bracketHLight}22;`;
                seg.npcs.forEach(npc => {
                    const t = buildTab(npc, globalIdx);
                    // Remove bottom margin from tabs inside bracket
                    t.style.marginBottom = '0';
                    membersRow.appendChild(t);
                    globalIdx++;
                });
                bracket.appendChild(membersRow);
                tabsDiv.appendChild(bracket);
            }
        });
    } else {
        tabsContainer.classList.remove('active');
    }
    
    // Always show tabs container for initiative panel (even single NPC)
    if (generatedNPCs.length >= 1) {
        tabsContainer.classList.add('active');
    }

    // Render all NPCs (hidden except active)
    generatedNPCs.forEach((npc) => {
        renderNPC(npc, container, npc.id === activeId);
    });

    activeNPCId = activeId;

    // Update initiative order panel
    setTimeout(() => updateInitiativeOrderPanel(), 50);
}

function switchToNPC(npcId) {
    const selected = generatedNPCs.find(n => String(n.id) === String(npcId));
    if (!selected) return;
    const selectedId = selected.id;
    activeNPCId = selectedId;
    
    // Update tabs — use data-npcId (works with bracket grouping)
    document.querySelectorAll('.npc-tab').forEach(tab => {
        if (String(tab.dataset.npcId) === String(selectedId)) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // Update cards
    document.querySelectorAll('.npc-card').forEach(card => {
        if (card.id === `card-${selectedId}`) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
    
    // Refresh initiative order panel to update active highlight
    setTimeout(() => updateInitiativeOrderPanel(), 30);
}


/* =========================================
   NPC CARD RENDERING WITH COMBAT UI
   ========================================= */
function renderNPC(npc, container, isActive = false) {
    const div = document.createElement('div');
    div.className = `npc-card ${isActive ? 'active' : ''}`;
    if (npc.isBoss) div.classList.add('boss-card');
    if (npc.isRelative || npc.isGroupRelative) div.classList.add('relative-card');
    div.id = `card-${npc.id}`;
    if(npc.isCombat) div.classList.add('combat-active');

    const conditionsHtml = npc.conditions.map(c => 
        `<span class="condition-tag">${c} <button onclick="removeCondition('${npc.id}', '${c}')">×</button></span>`
    ).join('');

    const initiativeClass = npc.initiative !== null ? 'rolled' : '';
    const initiativeText = npc.initiative !== null ? `Init: ${npc.initiative}` : 'Roll Init';

    const rarityColors = {
        common: '#9d9d9d',
        uncommon: '#1eff00',
        rare: '#0070dd',
        epic: '#a335ee',
        legendary: '#ff8000',
        mythic: '#ff3333'
    };

    const questStyles = {
        hostile: 'quest-hostile',
        side: 'quest-side',
        neutral: 'quest-none',
        boss: 'quest-boss'
    };

    let relativeHtml = '';
    if (npc.isRelative && npc.relativeOf) {
        const qualityPercent = npc.relativeOf.quality;
        const qualityClass = qualityPercent >= 70 ? 'relationship-positive' : qualityPercent >= 40 ? 'relationship-neutral' : 'relationship-negative';
        const qualityText = qualityPercent >= 70 ? 'Close Bond' : qualityPercent >= 40 ? 'Complicated' : 'Strained';
        
        relativeHtml = `
            <div class="relative-info">
                <div class="relative-details">
                    <div class="relative-block">
                        <h5>Relationship</h5>
                        <div style="font-size:1.1em; font-weight:700; color:#9b59b6;">${npc.relationship.type}</div>
                        <div style="font-size:0.9em; color:#666; margin-top:5px;">${npc.name} ${npc.relationship.desc} <a href="#" onclick="scrollToNPC('${npc.relativeOf.id}'); return false;" style="color:#9b59b6; font-weight:700; text-decoration:underline; cursor:pointer;" title="Jump to ${npc.relativeOf.name}'s card">${npc.relativeOf.name}</a></div>
                    </div>
                    <div class="relative-block">
                        <h5>Bond Quality: ${qualityText}</h5>
                        <div class="relationship-bar">
                            <div class="relationship-fill ${qualityClass}" style="width:${qualityPercent}%"></div>
                        </div>
                        <div style="font-size:0.85em; color:#666; margin-top:5px;">${qualityPercent}% affinity</div>
                    </div>
                </div>
            </div>
        `;
    } else if (npc.isGroupRelative && npc.groupRelationship) {
        const gr = npc.groupRelationship;
        relativeHtml = `
            <div class="relative-info" style="border-color:#7b5ea7; background:rgba(123,94,167,0.06);">
                <div class="relative-details">
                    <div class="relative-block">
                        <h5 style="color:#7b5ea7;">Group Connection</h5>
                        <div style="font-size:1.05em; font-weight:700; color:#7b5ea7;">${gr.type}</div>
                        <div style="font-size:0.88em; color:#666; margin-top:4px;">${npc.name} ${gr.desc} <a href="#" onclick="scrollToGroup('${gr.groupId}', '${gr.groupName}'); return false;" style="color:#7b5ea7; font-weight:700; text-decoration:underline; cursor:pointer;" title="Open ${gr.groupName}">${gr.groupName}</a></div>
                    </div>
                    <div class="relative-block">
                        <h5 style="color:#7b5ea7;">The Bond</h5>
                        <div style="font-size:0.9em; color:#555; font-style:italic;">"${gr.bond}"</div>
                        ${gr.referencedMember ? `<div style="font-size:0.82em; color:#777; margin-top:5px;">Specifically tied to: <strong>${gr.referencedMember.name}</strong> (${gr.referencedMember.class})</div>` : ''}
                    </div>
                </div>
                <div style="margin-top:10px; padding:8px 10px; background:rgba(123,94,167,0.1); border-left:3px solid #7b5ea7; border-radius:4px; font-size:0.88em; color:#444;">${gr.connection}</div>
            </div>
        `;
    }

    // Build spell slots and spells HTML
    const spellSlotsAndSpellsHtml = buildSpellsHTML(npc);

    div.innerHTML = `
        ${npc.isBoss ? '<div class="boss-badge">👑 BOSS</div>' : ''}
        ${npc.isRelative ? `<div class="relative-badge">👥 ${npc.relationship.type}</div>` : ''}
        ${npc.isGroupRelative ? `<div class="relative-badge" style="background:linear-gradient(135deg,#7b5ea7,#5a3d8a);">${npc.groupRelationship.type}</div>` : ''}
        
        ${npc.isBoss ? `
        <div class="legendary-tracker" id="legtracker-${npc.id}">
            <div class="legendary-tracker-title">⚔️ Legendary Resources</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div>
                    <div style="font-size:0.78em;color:var(--gold-light);margin-bottom:4px;font-weight:700;">Legendary Resistance (${npc.legendaryResistances||3}/day)</div>
                    <div class="leg-uses" id="legres-${npc.id}">
                        ${Array.from({length:npc.legendaryResistances||3},(_,i)=>`<div class="leg-pip${(npc.legendaryResistancesUsed||0)>i?' used':''}" onclick="useLegendaryResource('${npc.id}','resistance',${i})" title="Click to toggle"></div>`).join('')}
                    </div>
                </div>
                <div>
                    <div style="font-size:0.78em;color:var(--gold-light);margin-bottom:4px;font-weight:700;">Legendary Actions (${npc.legendaryActions||3}/round)</div>
                    <div class="leg-uses" id="legact-${npc.id}">
                        ${Array.from({length:npc.legendaryActions||3},(_,i)=>`<div class="leg-pip${(npc.legendaryActionsUsed||0)>i?' used':''}" onclick="useLegendaryResource('${npc.id}','action',${i})" title="Click to toggle"></div>`).join('')}
                    </div>
                    <button onclick="resetLegendaryActions('${npc.id}')" style="margin-top:5px;padding:2px 8px;background:none;border:1px solid var(--gold);color:var(--gold-light);border-radius:4px;cursor:pointer;font-size:0.75em;font-family:'Cinzel',serif;">Reset (End of Round)</button>
                </div>
            </div>
        </div>` : ''}
        
        <div class="card-toolbar-top">
            <button class="btn-top btn-combat-top" onclick="toggleCombat('${npc.id}')">
                ${npc.isCombat ? 'End Combat' : 'Combat'}
            </button>
            <button class="btn-top btn-rest-top" onclick="longRestNPC('${npc.id}')">Long Rest</button>
            <button class="btn-top btn-rest-top" onclick="shortRestNPC('${npc.id}')" style="background: linear-gradient(145deg, #5d8a6b 0%, #3d6b4a 100%);">Short Rest</button>
            <button class="btn-top btn-restall-top" onclick="restAllNPCs()" title="Long rest all NPCs (restore HP & spell slots)">Long Rest All</button>
            <button class="btn-top btn-restall-top" onclick="shortRestAllNPCs()" title="Short rest all NPCs" style="background: linear-gradient(145deg, #5d8a6b 0%, #3d6b4a 100%);">Short Rest All</button>
            <button class="btn-top btn-save-top" onclick="saveNPC('${npc.id}')">Save</button>
            <button class="btn-top btn-save-top" onclick="printNPC('${npc.id}')" style="background: linear-gradient(145deg, #4a6fa5 0%, #2c4a7a 100%);">Print</button>
            ${npc.isBountyTarget ? `<button class="btn-top btn-save-top" onclick="printNPCWantedPoster('${npc.id}')" style="background: linear-gradient(145deg, #5a0000 0%, #8b0000 100%); border:1px solid #b8860b;">🖨 Wanted Poster</button>` : ''}
            <button class="btn-top btn-saveall-top" onclick="saveAllNPCs()" title="Save all NPCs to vault">Save All</button>
            <button class="btn-top btn-kill-top" onclick="openKillQuestModal('${npc.id}')" title="Mark this NPC as killed by a player — triggers revenge quest">☠ Killed</button>
            <button class="btn-top btn-delete-top" onclick="deleteNPC('${npc.id}')">Delete</button>
            <button class="btn-top btn-deleteall-top" onclick="deleteAllNPCs()" title="Remove all NPCs from screen">Delete All</button>
        </div>
        
        <div class="combat-ui">
            <div class="combat-npc-name-header">
                <div class="combat-npc-name-text">${npc.name} <span style="font-size:0.65em; color:rgba(255,255,255,0.7); font-weight:400; margin-left:10px;">AC ${npc.ac} &nbsp;|&nbsp; SPD ${npc.speed}ft</span></div>
                <div class="combat-npc-class-text">Level ${npc.level} ${npc.race} ${npc.class}${npc.isBoss ? ' — LEGENDARY' : ''}</div>
            </div>
            <div class="combat-header">
                <span class="combat-title">⚔️ COMBAT TRACKER</span>
                <span id="init-${npc.id}" class="initiative-display ${initiativeClass}">${initiativeText}</span>
            </div>
            <div class="hp-control">
                <button class="hp-btn hp-minus" onclick="modHP('${npc.id}', -5)">-5</button>
                <button class="hp-btn hp-minus" onclick="modHP('${npc.id}', -1)">-1</button>
                <div class="hp-bar-bg">
                    <div id="hp-bar-${npc.id}" class="hp-bar-fill" style="width: ${(npc.hpCurr/npc.hpMax)*100}%"></div>
                    <div id="hp-txt-${npc.id}" class="hp-text">${npc.hpCurr} / ${npc.hpMax}</div>
                </div>
                <button class="hp-btn hp-plus" onclick="modHP('${npc.id}', 1)">+1</button>
                <button class="hp-btn hp-plus" onclick="modHP('${npc.id}', 5)">+5</button>
            </div>
            <div class="condition-tracker">
                <select class="condition-select" onchange="if(this.value) { addCondition('${npc.id}', this.value); this.value=''; }">
                    <option value="">Add Condition...</option>
                    ${DB.conditions.map(c => `<option value="${c}">${c}</option>`).join('')}
                </select>
                <button class="btn-roll" onclick="rollInit('${npc.id}')">🎲 Roll</button>
            </div>
            <div id="conditions-${npc.id}" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                ${conditionsHtml}
            </div>
            
            <div class="combat-spells" id="combat-spells-${npc.id}">
                ${buildCombatWeaponsHTML(npc)}
                ${buildClassFeaturesHTML(npc)}
                ${spellSlotsAndSpellsHtml}
            </div>
        </div>

        <div class="card-header">
            <div>
                <h2 class="npc-name">${npc.name}${npc.startingCondition ? `<span class="starting-condition" onclick="showConditionDetail(npc.startingCondition, npc.id)" style="cursor:pointer;" title="Click for details">${npc.startingCondition}</span>` : ''} <button onclick="renameNPC('${npc.id}')" title="Rename this NPC" style="background:none;border:none;cursor:pointer;font-size:0.55em;opacity:0.5;vertical-align:middle;padding:0 4px;color:var(--red);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">✏️</button> <button onclick="openNPCEdit('${npc.id}')" title="Edit NPC stats" style="background:none;border:none;cursor:pointer;font-size:0.55em;opacity:0.5;vertical-align:middle;padding:0 4px;color:var(--gold);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">🛠️</button>${npc.alignment ? `<span class="alignment-badge alignment-${npc.alignment}" title="Alignment">${ALIGNMENT_FULL[npc.alignment]||npc.alignment}</span>` : ''}</h2>
                <div class="npc-sub">
                    ${npc.race} ${npc.class}${npc.subclass ? ` — <span style="color:var(--gold);font-weight:700;">${npc.subclass.name}</span>` : ''} (Level ${npc.level}) ${npc.gender ? '• ' + npc.gender.charAt(0).toUpperCase() + npc.gender.slice(1) : ''} ${npc.isBoss ? '• LEGENDARY' : ''}
                    ${npc.isDisciple ? `<br><span style="color:#9b59b6;">Disciple of <a href="#" onclick="scrollToNPC('${npc.masterOf.id}'); return false;" style="color:#9b59b6; font-weight:700; text-decoration:underline; cursor:pointer;">${npc.masterOf.name}</a></span>` : ''}
                    ${npc.groupName ? `<br><span style="color:var(--gold); font-weight:700;">👥 <span id="groupname-display-${npc.id}">${npc.groupName}</span></span> • ${npc.groupRole} <button onclick="renameGroup('${npc.id}')" title="Rename group" style="background:none;border:none;cursor:pointer;font-size:0.75em;opacity:0.5;vertical-align:middle;padding:0 3px;color:var(--gold);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">✏️</button>` : ''}
                    ${npc.shopType ? `<br><span style="color:var(--success); font-weight:700;">${npc.shopType === 'Travelling Merchant' ? 'Travelling Merchant' : npc.shopType + ' Owner'}</span>${npc.shopType === 'Travelling Merchant' ? ` &nbsp;&middot;&nbsp; <a href="#" onclick="generateTravellingMerchantBodyguards('${npc.id}'); return false;" style="color:var(--gold);font-weight:700;text-decoration:underline;cursor:pointer;">View Bodyguards</a>` : ''}` : ''}
                    <br>
                    <span style="font-size: 0.9em; opacity: 0.8;">Age ${npc.age} (${npc.ageCategory}) • ${npc.occupation}</span>
                    ${npc.languages && npc.languages.length ? `<br><span style="font-size:0.85em;opacity:0.75;">🗣 Languages: ${npc.languages.join(', ')}</span>` : ''}
                </div>
            </div>
            <div class="quick-stats">
                <div><strong>AC:</strong> ${npc.ac}</div>
                <div><strong>HP:</strong> ${npc.hpMax}</div>
                <div><strong>SPD:</strong> ${npc.speed}ft</div>
                <div><strong>PROF:</strong> +${npc.prof}</div>
            </div>
        </div>

        ${npc.groupName ? `
            <div class="quest-section" style="margin-bottom:20px;">
                <div class="quest-header">👥 ${npc.groupType} Information</div>
                <div style="margin-top:10px;">
                    <strong style="color:var(--red);">Group:</strong> ${npc.groupName}<br>
                    <strong style="color:var(--red);">Role:</strong> ${npc.groupRole}${npc.groupLeader ? ` (serves under ${npc.groupLeader})` : ''}<br>
                    <strong style="color:var(--red);">Goal:</strong> ${npc.groupGoal}<br>
                    <strong style="color:var(--red);">Motto:</strong> "${npc.groupMotto}"
                </div>
            </div>
        ` : ''}

        ${relativeHtml}

        <div class="character-flavor">
            <div class="flavor-section">
                <h4>👤 Appearance <button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','appearance','Appearance',\`${(npc.physicalDesc||'').replace(/`/g,"'")}\`)">✏ Edit</button></h4>
                <div class="flavor-content" id="nfc-appearance-${npc.id}">${npc.physicalDesc}</div>
                <div class="appearance-detail-grid">
                    <div class="appearance-chip">
                        <div class="appearance-chip-label">Clothing <button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','clothing','Clothing',\`${((npc.appearance&&npc.appearance.clothing)||'').replace(/`/g,"'")}\`)">✏</button></div>
                        <div id="nfc-clothing-${npc.id}">${npc.appearance && npc.appearance.clothing ? npc.appearance.clothing : 'Common attire'}</div>
                    </div>
                    <div class="appearance-chip">
                        <div class="appearance-chip-label">Armor <button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','armor','Armour',\`${((npc.appearance&&npc.appearance.armor)||'').replace(/`/g,"'")}\`)">✏</button></div>
                        <div id="nfc-armor-${npc.id}">${npc.appearance && npc.appearance.armor ? npc.appearance.armor : 'Unarmored'}</div>
                    </div>
                    <div class="appearance-chip" style="grid-column:1/-1;">
                        <div class="appearance-chip-label">Weapon Visible <button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','weapon','Weapon Visible',\`${((npc.appearance&&npc.appearance.weapon)||'').replace(/`/g,"'")}\`)">✏</button></div>
                        <div id="nfc-weapon-${npc.id}">${npc.appearance && npc.appearance.weapon ? npc.appearance.weapon : 'No visible weapon'}</div>
                    </div>
                </div>
                <div class="portrait-section">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                        <span style="font-family:'Cinzel',serif; font-size:0.8em; color:var(--red); font-weight:700; text-transform:uppercase; letter-spacing:1px;">🎨 Portrait</span>
                        <div style="display:flex; gap:6px;">
                            <button onclick="togglePortrait('${npc.id}')" id="portrait-toggle-${npc.id}" style="background:rgba(139,0,0,0.1); border:1px solid var(--gold); color:var(--red); padding:3px 10px; border-radius:4px; cursor:pointer; font-family:'Cinzel',serif; font-size:0.78em;">Hide</button>
                            <label style="margin:0; cursor:pointer;"><input type="file" accept="image/*" style="display:none;" onchange="uploadNPCPortrait('${npc.id}', this.files)"><span style="display:inline-block; padding:3px 10px; border-radius:4px; border:1px solid var(--gold); background:rgba(184,134,11,0.15); color:var(--gold-light); font-family:'Cinzel',serif; font-size:0.78em;">Upload</span></label>
                        </div>
                    </div>
                    <div id="portrait-area-${npc.id}" class="portrait-wrapper"></div>
                </div>
            </div>
            <div class="flavor-section">
                <h4>🎭 Personality <button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','personality','Personality Summary',\`${(npc.personality.summary||'').replace(/`/g,"'")}\`)">✏ Edit</button></h4>
                <div class="flavor-content" id="nfc-personality-${npc.id}">${npc.personality.summary}</div>
                <div class="personality-traits">
                    ${npc.personality.traits.map(t => `<span class="trait-tag">${t}</span>`).join('')}
                </div>
                ${npc.personality.flaw ? `<div style="margin-top:8px; padding:6px 10px; background:rgba(139,0,0,0.08); border-left:3px solid var(--red); border-radius:4px;"><strong style="color:var(--red);">⚠ Flaw:</strong> <span style="font-style:italic;" id="nfc-flaw-${npc.id}">${npc.personality.flaw}</span> <button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','flaw','Flaw',\`${(npc.personality.flaw||'').replace(/`/g,"'")}\`)">✏</button></div>` : `<div style="margin-top:8px;"><button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','flaw','Flaw','')">+ Add Flaw</button></div>`}
                ${npc.personality.speech ? `<div style="margin-top:6px; padding:6px 10px; background:rgba(184,134,11,0.08); border-left:3px solid var(--gold); border-radius:4px;"><strong style="color:var(--gold-light);">🗣 Speech:</strong> <span style="font-style:italic;" id="nfc-speech-${npc.id}">${npc.personality.speech}</span> <button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','speech','Speech Pattern',\`${(npc.personality.speech||'').replace(/`/g,"'")}\`)">✏</button></div>` : `<div style="margin-top:6px;"><button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','speech','Speech Pattern','')">+ Add Speech</button></div>`}
                ${npc.personality.secret ? `<div style="margin-top:6px; padding:6px 10px; background:rgba(74,0,128,0.08); border-left:3px solid #7a0080; border-radius:4px;"><strong style="color:#9b59b6;">🤫 Secret:</strong> <span style="font-style:italic;" id="nfc-secret-${npc.id}">${npc.personality.secret}</span> <button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','secret','Secret',\`${(npc.personality.secret||'').replace(/`/g,"'")}\`)">✏</button></div>` : `<div style="margin-top:6px;"><button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','secret','Secret','')">+ Add Secret</button></div>`}
            </div>
        </div>
        
        ${(() => {
            const raceFeatData = DB.raceFeats[npc.race];
            if (!raceFeatData) return '';
            return `<div class="race-feats-section">
                <div class="section-header">⭐ ${npc.race} Racial Traits</div>
                <ul class="race-feat-list">
                    ${raceFeatData.map(f => `<li><strong>${f.name}:</strong> ${f.desc}</li>`).join('')}
                </ul>
            </div>`;
        })()}

        <div class="quest-section" style="${npc.isBountyTarget ? 'border-color:#8b0000;background:linear-gradient(145deg,rgba(139,0,0,0.04),rgba(220,20,60,0.03));' : ''}">
            ${npc.isBountyTarget ? `
            <div style="background:linear-gradient(145deg,#fff0f0,#ffe8e8);border:2px solid #8b0000;border-radius:8px;padding:14px;position:relative;overflow:hidden;margin-bottom:0;">
                <div style="position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#8b0000,#dc143c,#8b0000);border-radius:4px 4px 0 0;"></div>
                <div style="margin-top:4px;text-align:center;margin-bottom:10px;">
                    <div style="font-family:'Cinzel',serif;font-weight:900;font-size:0.75em;color:#5a0000;letter-spacing:3px;text-transform:uppercase;border-bottom:2px solid #c0392b;padding-bottom:5px;margin-bottom:6px;">WANTED — ${npc.bountyPoster||'Dead or Alive'}</div>
                    <div style="font-family:'Cinzel',serif;font-size:1.1em;font-weight:800;color:#5a0000;">${npc.bountyTitle||''}</div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:6px;">
                        <span style="background:#8b0000;color:white;padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700;font-family:'Cinzel',serif;">${npc.bountyPoster||''}</span>
                        <span style="background:rgba(255,100,0,0.12);border:1px solid #e67e22;color:#c0392b;padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700;">${npc.bountyThreat||''}</span>
                    </div>
                </div>
                <div style="display:grid;gap:6px;margin-bottom:10px;">
                    ${npc.bountyCrime ? `<div style="background:rgba(139,0,0,0.05);border-left:3px solid #8b0000;padding:6px 10px;border-radius:0 4px 4px 0;font-size:0.88em;"><strong style="color:#8b0000;font-size:0.82em;text-transform:uppercase;letter-spacing:0.5px;">Crime:</strong><br>${npc.bountyCrime}</div>` : ''}
                    ${npc.bountyBackstory ? `<div style="background:rgba(74,0,128,0.05);border-left:3px solid #7b00c8;padding:6px 10px;border-radius:0 4px 4px 0;font-size:0.88em;font-style:italic;"><strong style="color:#5a0080;font-size:0.82em;text-transform:uppercase;letter-spacing:0.5px;font-style:normal;">Known History:</strong><br>${npc.bountyBackstory}</div>` : ''}
                    ${npc.bountyBeware ? `<div style="background:rgba(231,76,60,0.06);border-left:3px solid #e74c3c;padding:6px 10px;border-radius:0 4px 4px 0;font-size:0.88em;"><strong style="color:#c0392b;font-size:0.82em;text-transform:uppercase;letter-spacing:0.5px;">Beware:</strong><br>${npc.bountyBeware}</div>` : ''}
                    ${npc.bountyNeeds ? `<div style="background:rgba(39,174,96,0.06);border-left:3px solid #27ae60;padding:6px 10px;border-radius:0 4px 4px 0;font-size:0.88em;"><strong style="color:#1e8449;font-size:0.82em;text-transform:uppercase;letter-spacing:0.5px;">Requirements:</strong><br>${npc.bountyNeeds}</div>` : ''}
                </div>
                <div style="background:linear-gradient(145deg,#fff8dc,#f5e8a0);border:2px solid #b8860b;border-radius:8px;padding:10px 14px;display:flex;gap:16px;flex-wrap:wrap;justify-content:center;align-items:center;">
                    <div style="text-align:center;">
                        <div style="font-size:0.7em;font-weight:700;text-transform:uppercase;color:#5a3a00;letter-spacing:0.5px;font-family:'Cinzel',serif;">Gold Reward</div>
                        <div style="font-size:1.4em;font-weight:900;color:#27ae60;font-family:'Cinzel',serif;">${npc.bountyReward||'—'}</div>
                    </div>
                    <div style="width:1px;height:40px;background:#b8860b;opacity:0.4;"></div>
                    <div style="text-align:center;">
                        <div style="font-size:0.7em;font-weight:700;text-transform:uppercase;color:#5a3a00;letter-spacing:0.5px;font-family:'Cinzel',serif;">Kill XP</div>
                        <div style="font-size:1.4em;font-weight:900;color:#c0392b;font-family:'Cinzel',serif;">${(npc.killXP||0).toLocaleString()}</div>
                    </div>
                    <div style="width:1px;height:40px;background:#b8860b;opacity:0.4;"></div>
                    <div style="text-align:center;">
                        <div style="font-size:0.7em;font-weight:700;text-transform:uppercase;color:#5a3a00;letter-spacing:0.5px;font-family:'Cinzel',serif;">Quest XP</div>
                        <div style="font-size:1.4em;font-weight:900;color:#2980b9;font-family:'Cinzel',serif;">${(npc.questXP||0).toLocaleString()}</div>
                    </div>
                </div>
                ${npc.bountyItemRewards && npc.bountyItemRewards.length > 0 ? `
                <div style="margin-top:10px;padding:10px 12px;background:linear-gradient(145deg,rgba(255,255,255,0.7),rgba(240,235,220,0.8));border:1px solid #b8860b;border-radius:6px;">
                    <div style="font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;color:#5a0000;text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;">✨ Item Reward${npc.bountyItemRewards.length > 1 ? 's' : ''} upon Completion</div>
                    ${npc.bountyItemRewards.map(item => `
                    <div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:5px;padding:6px 8px;background:rgba(255,255,255,0.6);border-radius:5px;border-left:3px solid ${RARITY_COLORS[item.rarity]||'#9d9d9d'};">
                        <span style="font-size:1.3em;flex-shrink:0;">${item.icon}</span>
                        <div>
                            <div style="font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;color:${RARITY_COLORS[item.rarity]||'#9d9d9d'};">${item.name}</div>
                            <div style="font-size:0.78em;color:#666;margin-top:1px;"><em>${item.type}</em> · <span style="color:${RARITY_COLORS[item.rarity]||'#9d9d9d'};text-transform:capitalize;">${item.rarity}</span></div>
                            <div style="font-size:0.82em;color:#444;margin-top:2px;">${item.desc}</div>
                        </div>
                    </div>`).join('')}
                </div>` : ''}
                ${npc.bountyCount > 1 ? `<div style="margin-top:8px;font-size:0.8em;text-align:center;color:#888;font-style:italic;">Part of a ${npc.bountyCount}-target group bounty — This NPC is the <strong>${npc.groupRole||'Target'}</strong></div>` : ''}
                <div style="margin-top:10px;">
                    <button onclick="printNPCWantedPoster('${npc.id}')" style="width:100%;padding:9px 14px;background:linear-gradient(145deg,#5a0000,#8b0000);color:#fff8dc;border:1px solid #b8860b;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-weight:700;font-size:0.85em;letter-spacing:1px;box-shadow:0 3px 10px rgba(139,0,0,0.35);transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">🖨 Print Wanted Poster</button>
                </div>
            </div>
            ` : `
            <div class="quest-header">📜 Quest Hook <button class="npc-edit-btn" onclick="openNpcFieldEdit('${npc.id}','questHook','Quest Hook',\`${(npc.quest.desc||'').replace(/`/g,"'")}\`)">✏ Edit</button></div>
            <span class="quest-type ${questStyles[npc.quest.type]}">${npc.quest.category}</span>
            <div class="quest-details" id="nfc-questHook-${npc.id}">${npc.quest.desc}</div>
            <div style="margin-top:8px; font-size:0.9em; color:#666; font-style:italic;">
                <strong>Potential Reward:</strong> ${npc.quest.reward}
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <div style="padding:6px 12px; background:rgba(231,76,60,0.1); border:1px solid rgba(231,76,60,0.4); border-radius:6px; font-size:0.9em;">
                    ⚔️ <strong style="color:var(--red);">Kill XP:</strong> <span style="font-weight:700;">${(npc.killXP||0).toLocaleString()} XP</span>
                </div>
                <div style="padding:6px 12px; background:rgba(46,204,113,0.1); border:1px solid rgba(46,204,113,0.4); border-radius:6px; font-size:0.9em;">
                    📜 <strong style="color:#27ae60;">Quest XP:</strong> <span style="font-weight:700;">${(npc.questXP||0).toLocaleString()} XP</span>
                </div>
            </div>
            `}
        </div>
        ${npc._revengeQuestHtml ? `
        <div class="quest-section" style="border-color:#8b0000;background:linear-gradient(145deg,rgba(139,0,0,0.06),rgba(80,0,0,0.04));margin-top:0;">
            <div style="font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:#8b0000;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;border-bottom:1px solid rgba(139,0,0,0.25);padding-bottom:5px;">☠ Nemesis Revenge Quest</div>
            <div style="font-family:'Crimson Text',serif;font-size:0.92em;color:#1a1a1a;line-height:1.65;">${npc._revengeQuestHtml}</div>
        </div>` : ''}

        ${(npc._storyLinked && npc._storyQuestHtml) ? `
        <div class="quest-section" style="border-color:rgba(160,100,255,0.7);background:linear-gradient(145deg,rgba(100,0,180,0.07),rgba(60,0,120,0.04));margin-top:0;">
            <div style="font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:#7a2cff;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;border-bottom:1px solid rgba(160,100,255,0.25);padding-bottom:5px;">🔗 Story-Linked Quest</div>
            <div style="font-family:'Crimson Text',serif;font-size:0.92em;color:#1a1a1a;line-height:1.65;">${npc._storyQuestHtml}</div>
        </div>` : ''}
        
        <div class="npc-stat-strip" aria-label="NPC Ability Scores">
            ${(['STR','DEX','CON','INT','WIS','CHA']).map((k) => {
                const v = (npc.stats||{})[k] ?? 10;
                const m = getMod(v);
                const ms = (m>=0?'+':'') + m;
                return `
                <div class="npc-stat-tile" id="statbox-${npc.id}-${k}">
                    <div class="npc-stat-label">${k}</div>
                    <div class="npc-stat-score" id="stat-${npc.id}-${k}">${v}</div>
                    <div class="npc-stat-mod">${ms}</div>
                    <button class="npc-stat-roll" onclick="rollStat('${npc.id}', '${k}')" title="Roll ${k} Check">🎲</button>
                </div>`;
            }).join('')}
        </div>

        <div class="info-grid">
            <div>
                <div class="section-header">⚔️ Attacks & Actions</div>
                ${npc.attacks.map((atk, idx) => `
                    <div class="action-entry" style="cursor:pointer;" onclick="showEquipmentDetail('${npc.id}', '${atk.name}')" title="Click for full weapon details">
                        <div class="action-name" style="display:flex; justify-content:space-between; align-items:center;">
                            ${atk.name}
                            <span style="font-size:0.7em; color:#aaa; font-style:italic; font-weight:400;">Click for details ›</span>
                        </div>
                        <div class="action-detail">${atk.range} • ${atk.type}</div>
                        <div class="action-meta">
                            Attack: <strong>${atk.roll}</strong> | 
                            Damage: <strong>${atk.dmg}</strong> ${atk.dmgType}
                        </div>
                        ${atk.desc ? `<div style="font-size:0.85em; color:#666; margin-top:4px;">${atk.desc}</div>` : ''}
                        <div style="margin-top:8px; display:flex; gap:8px;" onclick="event.stopPropagation()">
                            <button class="btn-small" onclick="rollWeaponAttack('${npc.id}', ${idx})" style="flex:1;">Roll Attack</button>
                            <button class="btn-small" onclick="rollWeaponDamage('${npc.id}', ${idx})" style="flex:1; background:var(--red);">Roll Damage</button>
                        </div>
                    </div>
                `).join('')}
                
                ${npc.class === "Rogue" ? `
                    <div class="action-entry">
                        <span class="action-name">Sneak Attack</span>
                        <div class="action-detail">Once per turn: +${Math.ceil(npc.level/2)}d6 damage when you have advantage or ally adjacent.</div>
                        <button class="btn-small" onclick="rollSneakAttack('${npc.id}')" style="margin-top:8px; background:var(--gold);">Roll Sneak Attack</button>
                    </div>
                ` : ''}

                <div id="non-combat-spells-${npc.id}">
                    ${spellSlotsAndSpellsHtml}
                </div>

                <div class="section-header">🛡️ Class Features</div>
                <ul class="feature-list">
                    ${npc.features.map(f => `<li><strong>${f.name}:</strong> ${f.desc}</li>`).join('')}
                </ul>
                ${(npc.subclass && npc.subclass.features && npc.subclass.features.length > 0) ? `
                <div style="margin-top:10px;padding:10px 12px;background:linear-gradient(135deg,rgba(123,94,167,0.08),rgba(155,89,182,0.05));border:1px solid rgba(155,89,182,0.25);border-radius:6px;">
                    <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:#9b59b6;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;align-items:center;gap:6px;">
                        <span style="font-size:1.1em;">✦</span> ${npc.subclass.name} Features
                    </div>
                    <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:5px;">
                        ${npc.subclass.features.map(f => `
                        <li style="display:flex;gap:6px;align-items:flex-start;padding:5px 8px;background:rgba(155,89,182,0.06);border-left:3px solid #9b59b6;border-radius:0 4px 4px 0;">
                            <span style="min-width:0;flex:1;">
                                <strong style="color:#9b59b6;font-family:'Cinzel',serif;">${f.name}</strong>
                                <span style="font-size:0.72em;color:#aaa;margin-left:4px;font-style:italic;">(Lvl ${f.level}+)</span>
                                <span style="font-size:0.88em;color:var(--ink);margin-left:4px;">${f.desc}</span>
                            </span>
                        </li>`).join('')}
                    </ul>
                </div>` : ''}
            </div>

            <div>
                <div class="section-header">💰 Equipment & Loot</div>
                <div class="loot-section">
                    <ul class="loot-list">
                        ${npc.inventory.map(item => {
                            const rarityColor = rarityColors[item.rarity] || '#9d9d9d';
                            const safeName = item.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            const hasDetail = !!(WEAPON_DATA && WEAPON_DATA[item.name]) || !!(ARMOR_DATA && ARMOR_DATA[item.name]) 
                                || !!(GEAR_DATA && GEAR_DATA[item.name]) || !!(POTION_DATA && POTION_DATA[item.name]) 
                                || item.desc;
                            return `
                                <li class="loot-item clickable-item" onclick="showEquipmentDetail('${npc.id}', '${safeName}')" style="cursor:pointer;" title="Click for full details">
                                    <span class="rarity-indicator rarity-${item.rarity}" style="background:${rarityColor}; box-shadow:0 0 5px ${rarityColor};"></span>
                                    <span style="color:${rarityColor}; font-weight:600;">${item.name}</span>
                                    ${item.type ? `<span style="font-size:0.8em; color:#666; margin-left:3px;">(${item.type})</span>` : ''}
                                    ${item.cost ? `<span style="font-size:0.85em; color:var(--gold); font-weight:700; margin-left:8px;">${item.cost}</span>` : ''}
                                    ${item.dc ? `<span style="font-size:0.85em; color:var(--red); font-weight:700; margin-left:8px;">DC ${item.dc}</span>` : ''}
                                    <span class="drop-chance">${(item.dropChance * 100).toFixed(0)}% drop</span>
                                    <span style="font-size:0.75em; color:var(--gold); opacity:0.7; margin-left:auto;">tap for details ›</span>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </div>

                <div class="section-header">🎲 Skills & Senses</div>
                ${buildSkillsPanelHTML(npc)}

                <div class="dm-notes">
                    <textarea id="note-${npc.id}" oninput="updateNote('${npc.id}', this.value)" rows="5" placeholder="Write your DM notes here...">${npc.dmNotes}</textarea>
                </div>
            </div>
        </div>
    `;
    
    div.npcData = npc;
    container.appendChild(div);
    updateHPVisuals(npc.id);
    setTimeout(() => dmQueuePortraitGeneration(npc.id), 30);
}

function buildSkillsPanelHTML(npc) {
    // All 18 D&D 5E skills mapped to their ability score
    const ALL_SKILLS = [
        { name: "Acrobatics",      stat: "DEX" },
        { name: "Animal Handling", stat: "WIS" },
        { name: "Arcana",          stat: "INT" },
        { name: "Athletics",       stat: "STR" },
        { name: "Deception",       stat: "CHA" },
        { name: "History",         stat: "INT" },
        { name: "Insight",         stat: "WIS" },
        { name: "Intimidation",    stat: "CHA" },
        { name: "Investigation",   stat: "INT" },
        { name: "Medicine",        stat: "WIS" },
        { name: "Nature",          stat: "INT" },
        { name: "Perception",      stat: "WIS" },
        { name: "Performance",     stat: "CHA" },
        { name: "Persuasion",      stat: "CHA" },
        { name: "Religion",        stat: "INT" },
        { name: "Sleight of Hand", stat: "DEX" },
        { name: "Stealth",         stat: "DEX" },
        { name: "Survival",        stat: "WIS" }
    ];
    
    const classData = DB.classes[npc.class] || {};
    const classSkills = classData.skills || [];
    const prof = npc.prof || Math.ceil(1 + npc.level / 4);
    
    // Rogues get expertise in half their skills (round up), Bards in 2 skills
    const expertiseCount = npc.class === "Rogue" ? Math.ceil(classSkills.length / 2) : (npc.class === "Bard" ? 2 : 0);
    // Pick first N skills as expertise skills (deterministic based on class skill list order)
    const expertiseSkills = new Set(classSkills.slice(0, expertiseCount));
    
    // Jack of All Trades: Bard adds half prof to non-proficient skills
    const hasJackOfAllTrades = npc.class === "Bard";
    
    // Calculate passive perception
    const wisPerception = classSkills.includes("Perception");
    const percMod = getMod(npc.stats.WIS) + (wisPerception ? (expertiseSkills.has("Perception") ? prof * 2 : prof) : (hasJackOfAllTrades ? Math.floor(prof / 2) : 0));
    const passivePerc = 10 + percMod;
    
    // Build skill rows HTML
    const skillRows = ALL_SKILLS.map(skill => {
        const statMod = getMod(npc.stats[skill.stat]);
        const isProficient = classSkills.includes(skill.name);
        const isExpertise = isProficient && expertiseSkills.has(skill.name);
        const isJAT = !isProficient && hasJackOfAllTrades;
        
        let total;
        if (isExpertise) {
            total = statMod + (prof * 2);
        } else if (isProficient) {
            total = statMod + prof;
        } else if (isJAT) {
            total = statMod + Math.floor(prof / 2);
        } else {
            total = statMod;
        }
        
        const sign = total >= 0 ? "+" : "";
        const profClass = isExpertise ? "expertise" : isProficient ? "proficient" : isJAT ? "half" : "";
        
        return `
            <div class="skill-row skill-rollable" onclick="rollSkillCheck('${skill.name}', ${total})" title="Click to roll ${skill.name} (${sign}${total})">
                <div class="skill-proficiency ${profClass}" title="${isExpertise ? "Expertise" : isProficient ? "Proficient" : isJAT ? "Jack of All Trades" : "Not proficient"}"></div>
                <span class="skill-modifier ${profClass}">${sign}${total}</span>
                <span class="skill-name ${profClass}">${skill.name}</span>
                <span class="skill-stat-label">${skill.stat}</span>
                <span class="skill-roll-icon">🎲</span>
            </div>
        `;
    }).join("");
    
    // Saving throws
    const STATS = ["STR","DEX","CON","INT","WIS","CHA"];
    const saveProfs = classData.save || [];
    const savesHTML = STATS.map(stat => {
        const base = getMod(npc.stats[stat]);
        const isProfSave = saveProfs.includes(stat);
        const total = base + (isProfSave ? prof : 0);
        const sign = total >= 0 ? "+" : "";
        return `
            <div class="skill-row skill-rollable" onclick="rollSkillCheck('${stat} Save', ${total})" title="Click to roll ${stat} saving throw (${sign}${total})">
                <div class="skill-proficiency ${isProfSave ? "proficient" : ""}"></div>
                <span class="skill-modifier ${isProfSave ? "proficient" : ""}">${sign}${total}</span>
                <span class="skill-name ${isProfSave ? "proficient" : ""}">${stat}</span>
                <span class="skill-roll-icon">🎲</span>
            </div>
        `;
    }).join("");
    
    return `
        <div class="skills-panel">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0 20px; margin-bottom:8px;">
                <div>
                    <div style="font-family:'Cinzel',serif; font-weight:700; font-size:0.8em; color:var(--red); margin-bottom:4px; text-transform:uppercase; letter-spacing:1px;">Saving Throws</div>
                    ${savesHTML}
                </div>
                <div style="padding-left:8px; border-left:1px dashed var(--gold);">
                    <div style="font-size:0.78em; color:#666; margin-bottom:6px;">
                        <strong style="color:var(--ink);">Proficiency:</strong> +${prof}<br>
                        <strong style="color:var(--ink);">Passive Perception:</strong> ${passivePerc}
                        ${hasJackOfAllTrades ? "<br><em style=\"color:var(--gold);font-size:0.9em;\">Jack of All Trades</em>" : ""}
                        ${expertiseCount > 0 ? `<br><em style="color:var(--gold);font-size:0.9em;">Expertise (${expertiseCount} skills)</em>` : ""}
                    </div>
                    <div style="font-size:0.72em; display:flex; gap:8px; flex-wrap:wrap;">
                        <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--red);vertical-align:middle;margin-right:2px;"></span>Proficient</span>
                        <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--gold);vertical-align:middle;margin-right:2px;"></span>Expertise</span>
                    </div>
                </div>
            </div>
            <div style="font-family:'Cinzel',serif; font-weight:700; font-size:0.8em; color:var(--red); margin:10px 0 4px; text-transform:uppercase; letter-spacing:1px; border-top:1px solid var(--gold); padding-top:8px;">Skills</div>
            <div class="skills-grid">${skillRows}</div>
        </div>
    `;
}

function buildSpellsHTML(npc) {
    if (!npc.spells || npc.spells.length === 0) return '';
    
    let html = '';
    
    // Spell slots
    if (npc.spellSlots && npc.spellSlots.type === "standard") {
        const slots = npc.spellSlots.slots;
        html += `
            <div class="spell-slots-section">
                <div class="spell-slots-header">
                    <span>🔮 Spell Slots</span>
                    <span style="font-size:0.9em;">${npc.spellSlots.currentSlots}/${npc.spellSlots.maxSlots} remaining</span>
                </div>
                <div class="spell-slots-grid">
                    ${Object.entries(slots).map(([level, data]) => `
                        <div class="slot-level">
                            <div class="slot-level-label">Lvl ${level}</div>
                            <div class="slot-circles">
                                ${Array(data.max).fill(0).map((_, i) => `
                                    <div class="spell-slot ${i >= data.current ? 'used' : ''}" 
                                         data-level="${level}"
                                         onclick="useSpellSlot('${npc.id}', ${level}, ${i})"
                                         title="Level ${level} Spell Slot"></div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (npc.spellSlots && npc.spellSlots.type === "pact") {
        html += `
            <div class="spell-slots-section">
                <div class="spell-slots-header">
                    <span>👁️ Pact Magic (All ${npc.spellSlots.slotLevel}th level)</span>
                    <span style="font-size:0.9em;">${npc.spellSlots.currentSlots}/${npc.spellSlots.maxSlots} remaining</span>
                </div>
                <div class="slot-circles" style="justify-content:center; gap:10px; margin-top:10px;">
                    ${Array(npc.spellSlots.maxSlots).fill(0).map((_, i) => `
                        <div class="spell-slot ${i >= npc.spellSlots.currentSlots ? 'used' : ''}" 
                             style="width:30px; height:30px;"
                             data-level="${npc.spellSlots.slotLevel}"
                             onclick="useSpellSlot('${npc.id}', ${npc.spellSlots.slotLevel}, ${i})"
                             title="Pact Magic Slot"></div>
                    `).join('')}
                </div>
                <div style="text-align:center; margin-top:8px; font-size:0.85em; opacity:0.8;">
                    Regain all slots on short rest
                </div>
            </div>
        `;
    }
    
    // Spells
    html += `<div class="section-header spells-header" style="margin-top:14px;">✨ Spells</div><div class="spell-grid">`;
    
    npc.spells.forEach(s => {
        if (s.header) {
            html += `<div style="background:rgba(139,0,0,0.1); padding:8px; border-radius:4px; margin-bottom:8px; font-size:0.9em;">${s.text}</div>`;
        } else {
            const isCantrip = s.level === 0;
            const hasSlots = npc.spellSlots && (isCantrip || hasAvailableSlot(npc.spellSlots, s.level));
            const castableClass = isCantrip ? 'castable' : hasSlots ? 'castable' : 'uncastable';
            const badgeClass = isCantrip ? 'spell-cantrip' : `spell-l${s.level}`;
            
            html += `
                <div class="spell-card ${castableClass}" 
                     onclick="${isCantrip || hasSlots ? `openSpellModal('${npc.id}', ${JSON.stringify(s.data).replace(/"/g, '&quot;')})` : ''}"
                     title="${isCantrip ? 'Click to cast (Cantrip, at will)' : hasSlots ? 'Click to cast spell' : 'No spell slots available'}">
                    <div class="spell-card-header">
                        <span class="spell-level-badge ${badgeClass}">${isCantrip ? 'C' : s.level}</span>
                        <span class="spell-card-name">${s.name}${s.isDomain ? ' <span style="font-size:0.6em;background:rgba(232,160,32,0.25);color:#f0c040;border:1px solid rgba(232,160,32,0.4);border-radius:3px;padding:0 4px;vertical-align:middle;font-family:sans-serif;">Domain</span>' : ''}</span>
                    </div>
                    <div class="spell-card-details">${s.data.desc}</div>
                    ${(isCantrip || hasSlots) ? `<div class="spell-card-click-hint">✨ Click to cast</div>` : ''}
                </div>
            `;
        }
    });
    
    html += `</div>`;
    return html;
}

/* =========================================
   SPELL FUNCTIONS
   ========================================= */

function buildCombatWeaponsHTML(npc) {
    if (!npc.attacks || npc.attacks.length === 0) return '';
    
    let html = `
        <div class="section-header" style="color:white; border-color:rgba(255,255,255,0.2); margin-top:0; margin-bottom:8px;">⚔️ Weapon Attacks</div>
        <div class="combat-weapons-section">
    `;
    
    npc.attacks.forEach((atk, idx) => {
        html += `
            <div class="combat-weapon-entry">
                <div class="combat-weapon-name">${atk.name}</div>
                <div class="combat-weapon-stats">${atk.range} • ${atk.type} • Attack ${atk.roll} • ${atk.dmg} ${atk.dmgType}</div>
                <div class="combat-weapon-btns">
                    <button class="btn-combat-attack" onclick="rollWeaponAttack('${npc.id}', ${idx})">Roll Attack (${atk.roll})</button>
                    <button class="btn-combat-damage" onclick="rollWeaponDamage('${npc.id}', ${idx})">Roll Damage (${atk.dmg})</button>
                </div>
            </div>
        `;
    });
    
    // Rogue sneak attack
    if (npc.class === "Rogue") {
        html += `
            <div class="combat-weapon-entry">
                <div class="combat-weapon-name">Sneak Attack</div>
                <div class="combat-weapon-stats">+${Math.ceil(npc.level/2)}d6 extra damage when conditions met</div>
                <div class="combat-weapon-btns">
                    <button class="btn-combat-damage" onclick="rollSneakAttack('${npc.id}')" style="flex:1;">Roll Sneak Attack (${Math.ceil(npc.level/2)}d6)</button>
                </div>
            </div>
        `;
    }
    
    html += `</div>`;
    return html;
}

function buildClassFeaturesHTML(npc) {
    const lvl = npc.level || 1;
    const chaMod = getMod(npc.stats ? npc.stats.CHA : 10);
    const strMod = getMod(npc.stats ? npc.stats.STR : 10);
    const dexMod = getMod(npc.stats ? npc.stats.DEX : 10);
    const wisMod = getMod(npc.stats ? npc.stats.WIS : 10);
    const conMod = getMod(npc.stats ? npc.stats.CON : 10);
    const prof   = npc.prof || Math.ceil(1 + lvl / 4);

    // Each feature: { name, effect, uses, rest, rollable, roll, desc }
    // uses: null=passive, {max,cur}=trackable, "at-will"=infinite
    const features = [];

    // ── BARBARIAN ─────────────────────────────────────────────
    if (npc.class === "Barbarian") {
        const rageMax = lvl < 3 ? 2 : lvl < 6 ? 3 : lvl < 12 ? 4 : lvl < 17 ? 5 : 6;
        const rageDmg = lvl < 9 ? 2 : lvl < 16 ? 3 : 4;
        if (!npc.rageUses) npc.rageUses = { max: rageMax, current: rageMax };
        npc.rageUses.max = rageMax;
        features.push({ name:"Rage", effect:`+${rageDmg} melee dmg · Resistance: bludg/pierc/slash · Adv STR checks/saves`, uses:npc.rageUses, rest:"short", desc:"Bonus action. Lasts 1 min. Can't cast spells.", rollable:false });
        features.push({ name:"Reckless Attack", effect:"Advantage on STR attacks this turn (enemies gain Adv vs you)", uses:"passive", rest:"", desc:"Declare before first attack of your turn.", rollable:false });
        if (lvl >= 5) features.push({ name:"Extra Attack", effect:"2 attacks per Attack action", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 7) features.push({ name:"Feral Instinct", effect:"Advantage on Initiative · Can't be surprised while raging", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 9) features.push({ name:"Brutal Critical", effect:`+${Math.floor((lvl-9)/4)+1} extra damage dice on crit`, uses:"passive", rest:"", desc:"Applies to weapon attacks.", rollable:false });
        if (lvl >= 11) features.push({ name:"Relentless Rage", effect:"DC 10+5/use CON save to drop to 1 HP instead of 0 while raging", uses:"passive", rest:"", desc:"DC resets after short/long rest.", rollable:true, roll:`1d20+${conMod} vs DC` });
    }

    // ── FIGHTER ──────────────────────────────────────────────
    if (npc.class === "Fighter") {
        if (!npc.secondWind) npc.secondWind = { max: 1, current: 1 };
        features.push({ name:"Second Wind", effect:`Heal 1d10+${lvl} HP`, uses:npc.secondWind, rest:"short", desc:"Bonus action.", rollable:true, roll:`1d10+${lvl}` });
        const surgeMax = lvl < 17 ? 1 : 2;
        if (!npc.actionSurge) npc.actionSurge = { max: surgeMax, current: surgeMax };
        npc.actionSurge.max = surgeMax;
        features.push({ name:"Action Surge", effect:"Take one additional full action", uses:npc.actionSurge, rest:"short", desc:"Can't be used twice in a row.", rollable:false });
        if (lvl >= 5) features.push({ name:"Extra Attack", effect:"2 attacks per Attack action", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 11) features.push({ name:"Extra Attack (x3)", effect:"3 attacks per Attack action", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 9) {
            const indoMax = lvl < 13 ? 1 : lvl < 17 ? 2 : 3;
            if (!npc.indomitable) npc.indomitable = { max:indoMax, current:indoMax };
            npc.indomitable.max = indoMax;
            features.push({ name:"Indomitable", effect:"Reroll a failed saving throw", uses:npc.indomitable, rest:"long", desc:"Must use the new roll.", rollable:false });
        }
    }

    // ── ROGUE ─────────────────────────────────────────────────
    if (npc.class === "Rogue") {
        const sneakDice = Math.ceil(lvl / 2);
        features.push({ name:"Sneak Attack", effect:`+${sneakDice}d6 dmg (Adv or ally adj)`, uses:"passive", rest:"", desc:"Once per turn. Must use finesse or ranged weapon.", rollable:true, roll:`${sneakDice}d6` });
        features.push({ name:"Cunning Action", effect:"Dash, Disengage, or Hide as Bonus Action", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 5) features.push({ name:"Uncanny Dodge", effect:"Reaction: halve damage from one attack you see", uses:"passive", rest:"", desc:"Requires you to see the attacker.", rollable:false });
        if (lvl >= 7) features.push({ name:"Evasion", effect:"DEX save vs area: success=no dmg, fail=half dmg", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 11) features.push({ name:"Reliable Talent", effect:"Treat any d20 roll of 9 or lower as a 10 for proficient ability checks", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 14) features.push({ name:"Blindsense", effect:"Aware of hidden/invisible creatures within 10 ft", uses:"passive", rest:"", desc:"", rollable:false });
    }

    // ── PALADIN ──────────────────────────────────────────────
    if (npc.class === "Paladin") {
        const lohPool = lvl * 5;
        if (!npc.layOnHands) npc.layOnHands = { max: lohPool, current: lohPool };
        npc.layOnHands.max = lohPool;
        features.push({ name:"Lay on Hands", effect:`Restore up to ${lohPool} HP total (1 HP per point)`, uses:npc.layOnHands, rest:"long", desc:"Action. Can also cure disease/poison (5 pts each).", rollable:false });
        features.push({ name:"Divine Smite", effect:`2d8 to 5d8 radiant damage on hit (spend a spell slot)`, uses:{ max:"Spell Slots", current:"Spell Slots" }, rest:"", desc:`+1d8 per slot level (max 5d8). +1d8 vs undead/fiend.`, rollable:true, roll:"2d8 radiant" });
        if (lvl >= 5) features.push({ name:"Extra Attack", effect:"2 attacks per Attack action", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 6) features.push({ name:"Aura of Protection", effect:`All allies within 10ft add +${Math.max(1,chaMod)} to saves`, uses:"passive", rest:"", desc:"While you are conscious.", rollable:false });
        if (lvl >= 10) features.push({ name:"Aura of Courage", effect:"Allies within 10ft immune to Frightened", uses:"passive", rest:"", desc:"While you are conscious.", rollable:false });
        if (lvl >= 11) features.push({ name:"Improved Divine Smite", effect:"+1d8 radiant dmg on every melee weapon hit", uses:"passive", rest:"", desc:"Automatic, no slot needed.", rollable:true, roll:"1d8 radiant" });
    }

    // ── RANGER ───────────────────────────────────────────────
    if (npc.class === "Ranger") {
        features.push({ name:"Favored Enemy", effect:"Adv on Survival to track, recall info about chosen foe type", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 5) features.push({ name:"Extra Attack", effect:"2 attacks per Attack action", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 8) features.push({ name:"Land's Stride", effect:"Ignore difficult terrain from plants · Adv vs plant-based spells", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 10) features.push({ name:"Natural Explorer", effect:"Difficult terrain doesn't slow · Never lost · Adv tracking · Double food found", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 14) features.push({ name:"Vanish", effect:"Hide as Bonus Action · Can't be tracked by non-magical means", uses:"passive", rest:"", desc:"", rollable:false });
    }

    // ── MONK ─────────────────────────────────────────────────
    if (npc.class === "Monk") {
        const martialDie = lvl < 5 ? "1d4" : lvl < 11 ? "1d6" : lvl < 17 ? "1d8" : "1d10";
        if (!npc.kiPoints) npc.kiPoints = { max: lvl, current: lvl };
        npc.kiPoints.max = lvl;
        features.push({ name:"Martial Arts", effect:`Unarmed: ${martialDie}+DEX/STR · Bonus unarmed after Attack action`, uses:"passive", rest:"", desc:`DEX or STR for attack/damage. Damage die: ${martialDie}.`, rollable:true, roll:martialDie });
        features.push({ name:"Flurry of Blows", effect:"2 extra unarmed strikes as Bonus Action", uses:npc.kiPoints, rest:"short", desc:"Spend 1 ki. Uses ki pool shown.", rollable:true, roll:`${martialDie}+${Math.max(dexMod,strMod)} x2` });
        features.push({ name:"Patient Defense", effect:"Dodge as Bonus Action (1 ki)", uses:npc.kiPoints, rest:"short", desc:"Attackers have Disadv, Adv on DEX saves.", rollable:false });
        features.push({ name:"Step of Wind", effect:"Dash/Disengage as Bonus Action + jump dist doubled (1 ki)", uses:npc.kiPoints, rest:"short", desc:"", rollable:false });
        if (lvl >= 5) features.push({ name:"Stunning Strike", effect:`CON save DC ${8+prof+Math.max(dexMod,strMod)} or Stunned until your next turn`, uses:npc.kiPoints, rest:"short", desc:"Spend 1 ki after hitting. Stunned: incapacitated, Adv vs them, crit on hit.", rollable:false });
        if (lvl >= 6) features.push({ name:"Ki-Empowered Strikes", effect:"Unarmed strikes count as magical", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 7) features.push({ name:"Stillness of Mind", effect:"End Charm or Frighten on self as Action", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 9) features.push({ name:"Unarmored Movement (+)", effect:"Pass through creatures and objects (end turn outside)", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 10) features.push({ name:"Purity of Body", effect:"Immune to disease and poison", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 13) features.push({ name:"Tongue of Sun and Moon", effect:"Understand and be understood by any language", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 14) features.push({ name:"Diamond Soul", effect:"Proficiency in ALL saving throws · Spend 1 ki to reroll", uses:npc.kiPoints, rest:"short", desc:"", rollable:false });
        if (lvl >= 18) features.push({ name:"Empty Body", effect:"Invisible for 1 min (4 ki) · Astral projection (8 ki)", uses:npc.kiPoints, rest:"short", desc:"", rollable:false });
    }

    // ── WIZARD ───────────────────────────────────────────────
    if (npc.class === "Wizard") {
        if (!npc.arcaneRecovery) npc.arcaneRecovery = { max: 1, current: 1 };
        features.push({ name:"Arcane Recovery", effect:`Regain spell slots totalling up to ${Math.ceil(lvl/2)} levels on short rest`, uses:npc.arcaneRecovery, rest:"long", desc:"Max slot level = half wizard level (round up).", rollable:false });
        features.push({ name:"Ritual Casting", effect:"Cast ritual spells without preparing or using a slot", uses:"passive", rest:"", desc:"Takes 10 extra minutes.", rollable:false });
        if (lvl >= 18) features.push({ name:"Spell Mastery", effect:"Cast chosen 1st and 2nd level spell at will without slot", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 20) features.push({ name:"Signature Spell", effect:"Cast two chosen 3rd level spells without slot (1/short rest each)", uses:"passive", rest:"", desc:"", rollable:false });
    }

    // ── SORCERER ─────────────────────────────────────────────
    if (npc.class === "Sorcerer") {
        const spMax = lvl;
        if (!npc.sorcPoints) npc.sorcPoints = { max: spMax, current: spMax };
        npc.sorcPoints.max = spMax;
        features.push({ name:"Sorcery Points", effect:`${spMax} points — convert to/from spell slots or fuel Metamagic`, uses:npc.sorcPoints, rest:"long", desc:"1 SP = level 1 slot. 2=lvl2, 3=lvl3, 5=lvl4, 6=lvl5.", rollable:false });
        features.push({ name:"Metamagic: Quickened", effect:"Cast 1-action spell as Bonus Action (2 SP)", uses:npc.sorcPoints, rest:"long", desc:"", rollable:false });
        features.push({ name:"Metamagic: Twinned", effect:"Target a second creature with a single-target spell (1 SP / spell level)", uses:npc.sorcPoints, rest:"long", desc:"Spell must target only one creature.", rollable:false });
        features.push({ name:"Metamagic: Empowered", effect:"Reroll up to CHA mod damage dice (1 SP)", uses:npc.sorcPoints, rest:"long", desc:"Must keep new rolls.", rollable:false });
        if (lvl >= 20) features.push({ name:"Sorcerous Restoration", effect:"Regain 4 SP on short rest", uses:"passive", rest:"", desc:"", rollable:false });
    }

    // ── WARLOCK ──────────────────────────────────────────────
    if (npc.class === "Warlock") {
        features.push({ name:"Eldritch Blast", effect:`1d10 force per beam · ${Math.floor((lvl+9)/6)} beams at this level`, uses:"passive", rest:"", desc:`+${chaMod} dmg per beam (Agonizing Blast). Range 120ft.`, rollable:true, roll:`${Math.floor((lvl+9)/6)}d10+${Math.floor((lvl+9)/6)*chaMod}` });
        features.push({ name:"Pact Magic", effect:"ALL spell slots regained on short rest", uses:"passive", rest:"", desc:"Short rest = full slots back.", rollable:false });
        features.push({ name:"Agonizing Blast", effect:`+${chaMod} force dmg per Eldritch Blast beam`, uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 2) features.push({ name:"Hex", effect:"+1d6 necrotic per hit, target has Disadv on chosen ability checks", uses:{ max:"Slot", current:"Slot" }, rest:"", desc:"Concentration, up to 1 hour. Bonus action to move on kill.", rollable:true, roll:"1d6 necrotic/hit" });
        if (lvl >= 5) features.push({ name:"Thirsting Blade (Pact of Blade)", effect:"Attack twice with pact weapon", uses:"passive", rest:"", desc:"Invocation (Lvl 5+).", rollable:false });
        if (lvl >= 9) features.push({ name:"Lifedrinker (Pact of Blade)", effect:`+${chaMod} necrotic dmg per pact weapon hit`, uses:"passive", rest:"", desc:"Invocation (Lvl 12+).", rollable:true, roll:`+${chaMod} necrotic` });
    }

    // ── CLERIC ───────────────────────────────────────────────
    if (npc.class === "Cleric") {
        const cdMax = lvl < 6 ? 1 : lvl < 18 ? 2 : 3;
        if (!npc.channelDivinity) npc.channelDivinity = { max: cdMax, current: cdMax };
        npc.channelDivinity.max = cdMax;
        features.push({ name:"Channel Divinity", effect:"Turn Undead · Domain feature · Destroy Undead (Lvl 5+)", uses:npc.channelDivinity, rest:"short", desc:"Turn Undead: WIS save DC "+(8+prof+wisMod)+" or flee for 1 min.", rollable:false });
        if (lvl >= 5) {
            const destroyCR = lvl < 8 ? "CR 1/4" : lvl < 11 ? "CR 1/2" : lvl < 14 ? "CR 1" : lvl < 17 ? "CR 2" : "CR 3";
            features.push({ name:"Destroy Undead", effect:`Destroy undead ${destroyCR} or lower on failed Turn save`, uses:"passive", rest:"", desc:"Used when Turn Undead would affect the creature.", rollable:false });
        }
        if (lvl >= 10) features.push({ name:"Divine Intervention", effect:`${lvl}% chance deity answers (1/week if successful)`, uses:{ max: 1, current: 1 }, rest:"long", desc:"Action. Describe the aid needed. DM decides result.", rollable:false });
        features.push({ name:"Spiritual Weapon", effect:"Bonus action attack: 1d8+"+(prof+wisMod)+" force per turn", uses:{ max:"Slot", current:"Slot" }, rest:"", desc:"Level 2 spell. Concentration-free. Moves 20ft as Bonus Action.", rollable:true, roll:`1d8+${prof+wisMod}` });
    }

    // ── DRUID ────────────────────────────────────────────────
    if (npc.class === "Druid") {
        const wsMax = 2;
        if (!npc.wildShape) npc.wildShape = { max: wsMax, current: wsMax };
        const wsCR = lvl < 4 ? "CR 1/4 (no swim speed or fly)" : lvl < 8 ? "CR 1/2 (no fly speed)" : "CR 1 (swim and fly ok)";
        features.push({ name:"Wild Shape", effect:`Transform into beast CR ${wsCR}`, uses:npc.wildShape, rest:"short", desc:"Action. Retain personality. Equipment melds or drops.", rollable:false });
        features.push({ name:"Spellcasting (WIS)", effect:`DC ${8+prof+wisMod} · +${prof+wisMod} spell attack`, uses:"passive", rest:"", desc:"Concentration spells can boost combat significantly.", rollable:false });
        if (lvl >= 18) features.push({ name:"Beast Spells", effect:"Cast spells while in Wild Shape form", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 20) features.push({ name:"Archdruid", effect:"Unlimited Wild Shape uses", uses:"passive", rest:"", desc:"", rollable:false });
    }

    // ── BARD ─────────────────────────────────────────────────
    if (npc.class === "Bard") {
        const biMax = Math.max(1, chaMod);
        const biDie = lvl < 5 ? "d6" : lvl < 10 ? "d8" : lvl < 15 ? "d10" : "d12";
        if (!npc.bardicInsp) npc.bardicInsp = { max: biMax, current: biMax };
        npc.bardicInsp.max = biMax;
        features.push({ name:"Bardic Inspiration", effect:`Grant ally 1${biDie} to add to attack/check/save`, uses:npc.bardicInsp, rest:"short", desc:"Bonus action. Lasts 10 min or until used.", rollable:false });
        features.push({ name:"Jack of All Trades", effect:"Add half proficiency to all non-proficient checks", uses:"passive", rest:"", desc:"+"+Math.floor(prof/2)+" bonus.", rollable:false });
        if (lvl >= 5) features.push({ name:"Font of Inspiration", effect:"Regain Bardic Inspiration on short rest", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 6) features.push({ name:"Countercharm", effect:"Action: allies within 30ft have Adv vs charm/frighten (1 min)", uses:"passive", rest:"", desc:"Concentration. Must be able to speak.", rollable:false });
        if (lvl >= 10) {
            if (!npc.magicalSecrets) npc.magicalSecrets = { max: 1, current: 1 };
            features.push({ name:"Magical Secrets", effect:"Know 2 spells from any class list", uses:"passive", rest:"", desc:"Gained at Lvl 10, 14, 18.", rollable:false });
        }
        if (lvl >= 20) features.push({ name:"Superior Inspiration", effect:"If 0 Bardic Inspiration on initiative, regain 1", uses:"passive", rest:"", desc:"", rollable:false });
    }

    // ── RACIAL COMBAT FEATURES ────────────────────────────────
    const race = npc.race;
    if (race === "Tiefling") {
        features.push({ name:"Hellish Resistance", effect:"Resistance to fire damage", uses:"passive", rest:"", desc:"", rollable:false });
        if (lvl >= 3) features.push({ name:"Hellish Rebuke", effect:"Reaction on damage: target takes 2d10 fire (DEX save DC "+(8+prof+chaMod)+")", uses:{ max:1, current:1 }, rest:"long", desc:"Reaction when damaged.", rollable:true, roll:"2d10 fire" });
        if (lvl >= 5) features.push({ name:"Darkness", effect:"60ft radius magical darkness (1/day, concentration)", uses:{ max:1, current:1 }, rest:"long", desc:"Blocks darkvision too.", rollable:false });
    }
    if (race === "Dragonborn") {
        const breathDmg = lvl < 6 ? "2d6" : lvl < 11 ? "3d6" : lvl < 16 ? "4d6" : "5d6";
        if (!npc.breathWeapon) npc.breathWeapon = { max:1, current:1 };
        features.push({ name:"Breath Weapon", effect:`${breathDmg} (dragon type) in line/cone — DEX save DC ${8+prof+conMod}`, uses:npc.breathWeapon, rest:"short", desc:"Action. 15ft cone or 30x5ft line (depends on ancestry).", rollable:true, roll:breathDmg });
        features.push({ name:"Damage Resistance", effect:"Resistance to draconic ancestry damage type", uses:"passive", rest:"", desc:"", rollable:false });
    }
    if (race === "Half-Orc") {
        features.push({ name:"Relentless Endurance", effect:"Drop to 1 HP instead of 0 (once per long rest)", uses:{ max:1, current:1 }, rest:"long", desc:"Not the same as dying — you stay up with 1 HP.", rollable:false });
        features.push({ name:"Savage Attacks", effect:"+1 extra damage die on weapon crit", uses:"passive", rest:"", desc:"Applies to melee weapon crits.", rollable:false });
    }
    if (race === "Halfling") {
        features.push({ name:"Lucky", effect:"Reroll any attack/check/save that rolls a 1", uses:"passive", rest:"", desc:"Must use the new roll.", rollable:false });
        features.push({ name:"Brave", effect:"Advantage on saves vs Frightened", uses:"passive", rest:"", desc:"", rollable:false });
    }
    if (race === "Elf" || race === "Half-Elf") {
        features.push({ name:"Fey Ancestry", effect:"Advantage vs Charmed · Immune to magical sleep", uses:"passive", rest:"", desc:"", rollable:false });
    }
    if (race === "Gnome") {
        features.push({ name:"Gnome Cunning", effect:"Advantage on INT/WIS/CHA saves vs magic", uses:"passive", rest:"", desc:"", rollable:false });
    }
    if (race === "Dwarf") {
        features.push({ name:"Dwarven Resilience", effect:"Advantage vs Poisoned · Resistance to poison damage", uses:"passive", rest:"", desc:"", rollable:false });
    }

    if (features.length === 0) return '';

    // Separate passive/at-will from trackable
    const tracked  = features.filter(f => f.uses && typeof f.uses === 'object' && typeof f.uses.max === 'number');
    const atWill   = features.filter(f => f.uses === 'passive' || f.uses === 'at-will' || (f.uses && f.uses.max === "At Will"));
    const slotBased = features.filter(f => f.uses && f.uses.max === "Slot" || f.uses && f.uses.max === "Spell Slots");

    let html = `<div class="section-header" style="margin-top:18px; font-size:1em; letter-spacing:1px; border-bottom:2px solid #e8a020; color:#f0c040;">⚡ CLASS &amp; RACIAL FEATURES</div>
    <div style="display:flex;flex-direction:column;gap:10px;">`;

    // Render trackable resources first (most useful in combat)
    tracked.forEach(f => {
        const restLabel = f.rest === 'short' ? 'S/L REST' : f.rest === 'long' ? 'L REST' : '';
        const useBtns = `
            <div style="display:flex;align-items:center;gap:6px;margin-top:8px;flex-wrap:wrap;">
                <button onclick="useFeatureCharge('${npc.id}','${f.name}',-1)" style="background:#c0392b;color:white;border:none;border-radius:4px;padding:4px 12px;cursor:pointer;font-weight:700;font-size:0.88em;letter-spacing:0.5px;">Use</button>
                <span id="feat-${npc.id}-${f.name.replace(/\s/g,'_')}" style="background:rgba(255,255,255,0.15);color:white;padding:4px 10px;border-radius:4px;font-size:0.9em;font-weight:700;border:1px solid rgba(255,255,255,0.3);">${f.uses.current}/${f.uses.max}</span>
                <button onclick="useFeatureCharge('${npc.id}','${f.name}',1)" style="background:#27ae60;color:white;border:none;border-radius:4px;padding:4px 12px;cursor:pointer;font-weight:700;font-size:0.88em;">+</button>
                ${restLabel ? `<span style="font-size:0.72em;color:rgba(255,200,100,0.8);padding:2px 7px;background:rgba(255,200,100,0.12);border-radius:3px;border:1px solid rgba(255,200,100,0.25);">⟳ ${restLabel}</span>` : ''}
                ${f.rollable && f.roll ? `<button onclick="rollFeature('${f.roll}','${f.name}')" style="background:#b8860b;color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:0.82em;">🎲 Roll ${f.roll}</button>` : ''}
            </div>`;
        html += `<div style="background:rgba(255,255,255,0.07);padding:12px 14px;border-radius:6px;border-left:4px solid #e8a020;border:1px solid rgba(232,160,32,0.35);border-left:4px solid #e8a020;">
            <div style="font-family:'Cinzel',serif;font-size:0.95em;font-weight:700;color:#f0c040;margin-bottom:4px;">${f.name}</div>
            <div style="font-size:0.9em;color:rgba(255,255,255,0.9);line-height:1.4;">${f.effect}</div>
            ${f.desc ? `<div style="font-size:0.8em;color:rgba(255,255,200,0.6);font-style:italic;margin-top:3px;">${f.desc}</div>` : ''}
            ${useBtns}
        </div>`;
    });

    // Slot-based features
    slotBased.forEach(f => {
        html += `<div style="background:rgba(123,94,167,0.2);padding:12px 14px;border-radius:6px;border-left:4px solid #9b59b6;border:1px solid rgba(155,89,182,0.4);border-left:4px solid #9b59b6;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <span style="font-family:'Cinzel',serif;font-size:0.95em;font-weight:700;color:#c39bd3;">${f.name}</span>
                <span style="background:rgba(155,89,182,0.5);color:white;padding:2px 8px;border-radius:3px;font-size:0.75em;border:1px solid rgba(155,89,182,0.6);">SPELL SLOT</span>
            </div>
            <div style="font-size:0.9em;color:rgba(255,255,255,0.9);">${f.effect}</div>
            ${f.desc ? `<div style="font-size:0.8em;color:rgba(255,255,200,0.6);font-style:italic;margin-top:3px;">${f.desc}</div>` : ''}
            ${f.rollable && f.roll ? `<button onclick="rollFeature('${f.roll}','${f.name}')" style="background:#7b5ea7;color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:0.82em;margin-top:6px;">🎲 Roll ${f.roll}</button>` : ''}
        </div>`;
    });

    // Passive/constant features — compact readable list on dark bg
    if (atWill.length > 0) {
        html += `<div style="background:rgba(255,255,255,0.05);border-radius:6px;padding:10px 14px;border:1px solid rgba(255,255,255,0.1);border-left:3px solid #f0c040;">
            <div style="font-family:'Cinzel',serif;font-size:0.8em;color:#f0c040;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">⬡ Passive / Always Active</div>`;
        atWill.forEach(f => {
            html += `<div style="display:flex;gap:10px;align-items:baseline;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.06);">
                <span style="font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;color:rgba(255,220,150,0.95);min-width:130px;flex-shrink:0;">${f.name}</span>
                <span style="font-size:0.85em;color:rgba(255,255,255,0.8);line-height:1.4;">${f.effect}</span>
                ${f.rollable && f.roll ? `<button onclick="rollFeature('${f.roll}','${f.name}')" style="background:#b8860b;color:white;border:none;border-radius:3px;padding:2px 8px;cursor:pointer;font-size:0.75em;flex-shrink:0;">🎲</button>` : ''}
            </div>`;
        });
        html += `</div>`;
    }

    // ── SUBCLASS FEATURES — appended inside the class features section ──
    if (npc.subclass && npc.subclass.features && npc.subclass.features.length > 0) {
        // Sub-header inside the same features block
        html += `
        <div style="margin-top:12px;padding:6px 14px 4px 14px;background:rgba(155,89,182,0.12);border-radius:6px;border-left:4px solid #9b59b6;border:1px solid rgba(155,89,182,0.3);border-left:4px solid #9b59b6;">
            <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:#c39bd3;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">✦ ${npc.subclass.name} Features</div>
            <div style="display:flex;flex-direction:column;gap:7px;">`;

        npc.subclass.features.forEach(f => {
            // Determine if this feature is trackable (has limited uses per rest)
            // We handle known trackable subclass features explicitly
            const isTracked = _isTrackedSubclassFeature(f.name);
            const useInfo   = isTracked ? _getSubclassFeatureUses(npc, f.name, lvl, prof) : null;

            html += `
            <div style="background:rgba(123,94,167,0.13);border:1px solid rgba(155,89,182,0.28);border-left:3px solid #9b59b6;border-radius:5px;padding:9px 12px;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap;margin-bottom:4px;">
                    <span style="font-family:'Cinzel',serif;font-size:0.88em;font-weight:700;color:#c39bd3;">${f.name}</span>
                    <span style="font-size:0.68em;background:rgba(155,89,182,0.35);color:rgba(255,255,255,0.75);padding:2px 7px;border-radius:10px;white-space:nowrap;border:1px solid rgba(155,89,182,0.45);">Lvl ${f.level}+</span>
                </div>
                <div style="font-size:0.82em;color:rgba(255,255,255,0.85);line-height:1.5;">${f.desc}</div>
                ${useInfo ? `<div style="font-size:0.74em;color:rgba(200,180,255,0.75);margin-top:4px;font-style:italic;">⟳ Recharges on ${useInfo.rest}</div>` : ''}
            </div>`;
        });

        html += `</div></div>`;
    }

    html += `</div>`;

    return html;
}

// ── HELPERS for subclass feature tracking ─────────────────────────────
function _isTrackedSubclassFeature(name) {
    const tracked = [
        "Preserve Life","Radiance of the Dawn","Invoke Duplicity","Knowledge of the Ages",
        "Read Thoughts","Charm Animals & Plants","Touch of Death","Guided Strike",
        "War God's Blessing","Destructive Wrath","Thunderbolt Strike",
        "Wild Shape","Timeless Body","Song of Rest",
        "Assassinate","Uncanny Dodge","Evasion",
        "Action Surge","Second Wind","Indomitable",
        "Lay on Hands","Divine Smite","Channel Divinity: War God's Blessing",
        "Flurry of Blows","Patient Defense","Step of Wind","Stunning Strike",
        "Cloak of Shadows","Improved Flare","Warding Flare","Wrath of the Storm"
    ];
    return tracked.includes(name);
}

function _getSubclassFeatureUses(npc, name, lvl, prof) {
    // Channel Divinity features recharge on short rest at lvl 6+, otherwise long rest
    const cdFeatures = [
        "Preserve Life","Radiance of the Dawn","Invoke Duplicity","Knowledge of the Ages",
        "Read Thoughts","Charm Animals & Plants","Touch of Death","Guided Strike",
        "War God's Blessing","Destructive Wrath","Channel Divinity: War God's Blessing",
        "Cloak of Shadows"
    ];
    if (cdFeatures.includes(name)) {
        const restType = lvl >= 6 ? "Short or Long Rest" : "Short or Long Rest";
        return { rest: restType };
    }
    // Wrath of the Storm uses = WIS mod per long rest
    if (name === "Wrath of the Storm" || name === "Warding Flare") return { rest: "Long Rest" };
    return null;
}

// ── RENAME NPC / GROUP ─────────────────────────────────────────────
function renameNPC(npcId) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    const newName = prompt('Rename NPC — enter new name:', npc.name);
    if (!newName || !newName.trim()) return;
    const oldName = npc.name;
    npc.name = newName.trim();

    // Update all places that show the name without a full re-render
    // 1. Card header h2
    const card = document.getElementById('card-' + npcId);
    if (card) {
        const h2 = card.querySelector('.npc-name');
        if (h2) {
            // rebuild content: name + condition badge + pencil button
            const conditionSpan = npc.startingCondition
                ? `<span class="starting-condition" onclick="showConditionDetail('${npc.startingCondition}','${npc.id}')" style="cursor:pointer;" title="Click for details">${npc.startingCondition}</span>`
                : '';
            h2.innerHTML = npc.name + conditionSpan +
                ' <button onclick="renameNPC(\'' + npcId + '\')" title="Rename this NPC" style="background:none;border:none;cursor:pointer;font-size:0.55em;opacity:0.5;vertical-align:middle;padding:0 4px;color:var(--red);" onmouseover="this.style.opacity=\'1\'" onmouseout="this.style.opacity=\'0.5\'">✏️</button>';
        }
        // 2. Combat header name
        const combatNameEl = card.querySelector('.combat-npc-name-text');
        if (combatNameEl) {
            combatNameEl.innerHTML = npc.name + ' <span style="font-size:0.65em;color:rgba(255,255,255,0.7);font-weight:400;margin-left:10px;">AC ' + npc.ac + ' &nbsp;|&nbsp; SPD ' + npc.speed + 'ft</span>';
        }
    }
    // 3. Tab name
    const tab = document.querySelector('.npc-tab[data-npc-id="' + npcId + '"]');
    if (tab) {
        const nameDiv = tab.querySelector('.tab-name');
        if (nameDiv) {
            // Preserve initiative badge if present
            const badge = nameDiv.querySelector('.init-tab-badge');
            nameDiv.textContent = npc.name;
            if (badge) nameDiv.appendChild(badge);
        }
    }
    // 4. Initiative order panel (if open)
    updateInitiativeOrderPanel();

    showToast(oldName + ' renamed to ' + npc.name, 'success');
}

function renameGroup(npcId) {
    const npc = getNPCById(npcId);
    if (!npc || !npc.groupName) return;
    const oldGroupName = npc.groupName;
    const newName = prompt('Rename group — enter new group name:', oldGroupName);
    if (!newName || !newName.trim()) return;
    const trimmed = newName.trim();

    // Update ALL NPCs that share this group name
    generatedNPCs.forEach(function(n) {
        if (n.groupName === oldGroupName) {
            n.groupName = trimmed;
            // Update the visible span inside their card (no full re-render)
            const el = document.getElementById('groupname-display-' + n.id);
            if (el) el.textContent = trimmed;
            // Update tab group header too
            const tabHeader = document.querySelector('.npc-tab-group-header');
            if (tabHeader && tabHeader.textContent.includes(oldGroupName)) {
                tabHeader.textContent = tabHeader.textContent.replace(oldGroupName, trimmed);
            }
        }
    });

    showToast('Group renamed to ' + trimmed, 'success');
}

function useFeatureCharge(npcId, featureName, delta) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    const key = featureName === "Rage" ? "rageUses"
        : featureName === "Action Surge" ? "actionSurge"
        : featureName === "Second Wind" ? "secondWind"
        : featureName === "Flurry of Blows" || featureName === "Patient Defense" || featureName === "Step of Wind" || featureName === "Stunning Strike" || featureName === "Diamond Soul" || featureName === "Empty Body" || featureName === "Ki-Empowered Strikes" ? "kiPoints"
        : featureName === "Channel Divinity" ? "channelDivinity"
        : featureName === "Wild Shape" ? "wildShape"
        : featureName === "Bardic Inspiration" ? "bardicInsp"
        : featureName === "Lay on Hands" ? "layOnHands"
        : featureName === "Indomitable" ? "indomitable"
        : featureName === "Sorcery Points" || featureName.startsWith("Metamagic") ? "sorcPoints"
        : featureName === "Breath Weapon" ? "breathWeapon"
        : featureName === "Hellish Rebuke" || featureName === "Darkness" ? null
        : featureName === "Relentless Endurance" ? null
        : featureName === "Arcane Recovery" ? "arcaneRecovery" : null;
    
    let resource = key ? npc[key] : null;
    if (!resource) {
        // Try direct from feature name
        if (featureName === "Hellish Rebuke") { if (!npc._hellishRebuke) npc._hellishRebuke={max:1,current:1}; resource=npc._hellishRebuke; }
        else if (featureName === "Darkness") { if (!npc._darkness) npc._darkness={max:1,current:1}; resource=npc._darkness; }
        else if (featureName === "Relentless Endurance") { if (!npc._relEndurance) npc._relEndurance={max:1,current:1}; resource=npc._relEndurance; }
        else { showToast("Can't track: "+featureName,"warning"); return; }
    }
    if (resource.max === "Slot" || resource.max === "Spell Slots" || resource.max === "At Will") return;
    resource.current = Math.max(0, Math.min(resource.max, resource.current + delta));
    const el = document.getElementById("feat-"+npcId+"-"+featureName.replace(/\s/g,"_"));
    if (el) el.textContent = resource.current+"/"+resource.max;
    showToast(delta < 0 ? featureName+" used ("+resource.current+" left)" : featureName+" restored", delta < 0 ? "warning" : "success");
}

function rollFeature(rollExpr, featureName) {
    // Parse rollExpr like "2d6+3", "1d10", "3d10+9"
    const match = rollExpr.match(/^(\d+)d(\d+)([+-]\d+)?/i);
    if (!match) { showToast("Roll: "+rollExpr+" for "+featureName); return; }
    const num=parseInt(match[1]), die=parseInt(match[2]), mod=parseInt(match[3]||0);
    let total=mod, rolls=[];
    for(let i=0;i<num;i++){const r=Math.floor(Math.random()*die)+1;rolls.push(r);total+=r;}
    const isCrit = rolls.some(r=>r===die) && rolls.length===1;
    showToast("🎲 "+featureName+": ["+rolls.join("+")+"]"+(mod?"+("+mod+")":"")+' = <strong>'+total+'</strong>'+(isCrit?" MAX!":""), "success", isCrit?"boss":"");
}

function hasAvailableSlot(spellSlots, level) {
    if (!spellSlots) return false;
    if (spellSlots.type === "pact") {
        return spellSlots.currentSlots > 0;
    }
    return spellSlots.slots[level] && spellSlots.slots[level].current > 0;
}

function useSpellSlot(npcId, level, slotIndex) {
    const npc = getNPCById(npcId);
    if (!npc || !npc.spellSlots) return;
    
    if (npc.spellSlots.type === "pact") {
        if (slotIndex >= npc.spellSlots.currentSlots) {
            npc.spellSlots.currentSlots++;
            showToast(`Regained Pact Magic slot`);
        } else {
            npc.spellSlots.currentSlots--;
            showToast(`Used Pact Magic slot`);
        }
    } else {
        const slot = npc.spellSlots.slots[level];
        if (!slot) return;
        
        if (slotIndex >= slot.current) {
            slot.current++;
            npc.spellSlots.currentSlots++;
            showToast(`Restored Level ${level} spell slot`);
        } else {
            slot.current--;
            npc.spellSlots.currentSlots--;
            showToast(`Used Level ${level} spell slot`);
        }
    }
    
    refreshNPCCard(npcId);
}

function openSpellModal(npcId, spellData) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    
    // For cantrips, show modal but mark as free casting
    const isCantrip = spellData.level === 0;
    
    currentSpellCast = { npcId, spellData, selectedLevel: spellData.level, isCantrip };
    
    document.getElementById('modalSpellName').textContent = spellData.name;
    document.getElementById('modalSpellType').textContent = spellData.school || 'Magic';
    
    const detailsGrid = document.getElementById('spellDetailsGrid');
    detailsGrid.innerHTML = `
        <div class="spell-detail-item">
            <div class="spell-detail-label">Level</div>
            <div class="spell-detail-value">${spellData.level === 0 ? 'Cantrip' : `Level ${spellData.level}`}</div>
        </div>
        <div class="spell-detail-item">
            <div class="spell-detail-label">Casting Time</div>
            <div class="spell-detail-value">${spellData.castTime || '1 Action'}</div>
        </div>
        <div class="spell-detail-item">
            <div class="spell-detail-label">Range</div>
            <div class="spell-detail-value">${spellData.range}</div>
        </div>
        <div class="spell-detail-item">
            <div class="spell-detail-label">Type</div>
            <div class="spell-detail-value">${spellData.type}</div>
        </div>
        <div class="spell-detail-item">
            <div class="spell-detail-label">School</div>
            <div class="spell-detail-value">${spellData.school || 'Evocation'}</div>
        </div>
        ${spellData.dmg && spellData.dmg !== '-' ? `
        <div class="spell-detail-item">
            <div class="spell-detail-label">Damage</div>
            <div class="spell-detail-value" style="color:var(--red); font-weight:700;">${spellData.dmg}</div>
        </div>
        ` : ''}
    `;
    
    const descriptionDiv = document.getElementById('modalSpellDescription');
    descriptionDiv.innerHTML = `
        <div style="margin-bottom:12px; line-height:1.6;"><strong>Effect:</strong> ${spellData.desc}</div>
        ${isCantrip ? '<div style="margin-top:10px; padding:10px; background:rgba(46,204,113,0.1); border-left:3px solid var(--success); font-weight:600;">✨ Cantrip - Can be cast at will without using spell slots</div>' : ''}
        ${spellData.upcast ? `<div style="margin-top:10px; padding:10px; background:rgba(184,134,11,0.1); border-left:3px solid var(--gold); font-style:italic;"><strong>At Higher Levels:</strong> ${spellData.upcast}</div>` : ''}
    `;
    
    const levelSelector = document.getElementById('spellLevelSelector');
    const levelOptions = document.getElementById('spellLevelOptions');
    
    if (spellData.level > 0 && spellData.upcast && npc.spellSlots) {
        levelSelector.style.display = 'block';
        levelOptions.innerHTML = '';
        
        const maxAvailableLevel = npc.spellSlots.type === "pact" ? 
            (npc.spellSlots.currentSlots > 0 ? npc.spellSlots.slotLevel : 0) :
            Math.max(...Object.keys(npc.spellSlots.slots).map(Number).filter(l => npc.spellSlots.slots[l].current > 0), 0);
        
        for (let level = spellData.level; level <= Math.min(maxAvailableLevel, 9); level++) {
            const hasSlot = npc.spellSlots.type === "pact" ? 
                (npc.spellSlots.currentSlots > 0 && level <= npc.spellSlots.slotLevel) :
                (npc.spellSlots.slots[level] && npc.spellSlots.slots[level].current > 0);
            
            const btn = document.createElement('div');
            btn.className = `spell-level-option ${!hasSlot ? 'unavailable' : ''} ${level === spellData.level ? 'selected' : ''}`;
            btn.textContent = `Level ${level}`;
            btn.onclick = () => {
                if (hasSlot) {
                    document.querySelectorAll('.spell-level-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    currentSpellCast.selectedLevel = level;
                    document.getElementById('btnCastSpell').disabled = false;
                }
            };
            levelOptions.appendChild(btn);
        }
        
        document.getElementById('btnCastSpell').disabled = false;
    } else {
        levelSelector.style.display = 'none';
        document.getElementById('btnCastSpell').disabled = false;
    }
    
    document.getElementById('spellModal').classList.add('active');
}

function closeSpellModal() {
    document.getElementById('spellModal').classList.remove('active');
    currentSpellCast = null;
}

function confirmCastSpell() {
    if (!currentSpellCast) return;
    
    const { npcId, spellData, selectedLevel, isCantrip } = currentSpellCast;
    const npc = getNPCById(npcId);
    if (!npc) return;
    
    // Calculate and roll damage if applicable
    let damageRoll = '';
    if (spellData.dmg && spellData.dmg !== '-') {
        let damageDice = spellData.dmg;
        
        // Apply upcasting if applicable
        if (!isCantrip && selectedLevel > spellData.level && spellData.upcast) {
            const levelDiff = selectedLevel - spellData.level;
            
            // Parse upcast pattern (e.g., "+1d6 per slot level")
            if (spellData.upcast.includes('+1d6')) {
                const baseDice = damageDice.match(/(\d+)d(\d+)/);
                if (baseDice) {
                    const extraDice = levelDiff;
                    const diceSize = baseDice[2];
                    damageDice = `${parseInt(baseDice[1]) + extraDice}d${diceSize}`;
                }
            } else if (spellData.upcast.includes('+1d8')) {
                const baseDice = damageDice.match(/(\d+)d(\d+)/);
                if (baseDice) {
                    const extraDice = levelDiff;
                    damageDice = `${parseInt(baseDice[1]) + extraDice}d8`;
                }
            } else if (spellData.upcast.includes('+1 dart')) {
                // Magic Missile style
                const darts = 3 + levelDiff;
                damageDice = `${darts}d4+${darts}`;
            }
        }
        
        // Roll the damage
        const diceMatch = damageDice.match(/(\d+)d(\d+)([+-]\d+)?/);
        if (diceMatch) {
            const numDice = parseInt(diceMatch[1]);
            const diceSize = parseInt(diceMatch[2]);
            const bonus = diceMatch[3] ? parseInt(diceMatch[3]) : 0;
            
            let total = bonus;
            let rolls = [];
            for (let i = 0; i < numDice; i++) {
                const roll = Math.floor(Math.random() * diceSize) + 1;
                rolls.push(roll);
                total += roll;
            }
            
            damageRoll = `\n💥 Damage: ${total} (${rolls.join('+')})`;
            if (bonus !== 0) damageRoll += ` ${bonus > 0 ? '+' : ''}${bonus}`;
        }
    }
    
    // Cantrips don't use slots
    if (!isCantrip) {
        if (npc.spellSlots.type === "pact") {
            npc.spellSlots.currentSlots--;
        } else {
            if (npc.spellSlots.slots[selectedLevel]) {
                npc.spellSlots.slots[selectedLevel].current--;
                npc.spellSlots.currentSlots--;
            }
        }
    }
    
    const levelText = isCantrip ? ' (Cantrip - at will)' : (selectedLevel > spellData.level ? ` at level ${selectedLevel}` : '');
    showToast(`Cast ${spellData.name}${levelText}! ✨${damageRoll}`);
    closeSpellModal();
    
    if (!isCantrip) {
        refreshNPCCard(npcId);
    }
}


/* =========================================
   COMBAT FUNCTIONS
   ========================================= */
function toggleCombat(id) {
    const npc = getNPCById(id);
    if (!npc) return;
    
    npc.isCombat = !npc.isCombat;
    
    const card = document.getElementById(`card-${id}`);
    if (npc.isCombat) {
        card.classList.add('combat-active');
        // Auto-add players to initiative when any NPC enters combat
        if (typeof addPartyToInitiative === 'function') addPartyToInitiative();
        showToast('Combat mode activated! Players added to initiative.');
    } else {
        card.classList.remove('combat-active');
        showToast('Combat ended for ' + (npc.name || 'NPC'));
    }
    
    // Update the btn-combat-top button text
    const btn = card.querySelector('.btn-combat-top');
    if (btn) {
        btn.textContent = npc.isCombat ? 'End Combat' : 'Combat';
    }
    // Also update old .btn-combat if present
    const btn2 = card.querySelector('.btn-combat');
    if (btn2) {
        btn2.textContent = npc.isCombat ? 'End Combat' : 'Combat';
    }
    
    // Refresh initiative panel
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
}

function modHP(id, amount) {
    const npc = getNPCById(id);
    if (!npc) return;
    
    npc.hpCurr = Math.min(npc.hpMax, Math.max(0, npc.hpCurr + amount));

    const hpTextEl = document.getElementById(`hp-txt-${id}`);
    if (hpTextEl) hpTextEl.innerText = `${npc.hpCurr} / ${npc.hpMax}`;
    updateHPVisuals(id);
    
    if (npc.hpCurr === 0) showToast(`${npc.name} has fallen!`, 'warning');
}

function updateHPVisuals(id) {
    const npc = getNPCById(id);
    if (!npc) return;
    
    const bar = document.getElementById(`hp-bar-${id}`);
    if (!bar) return;
    
    const pct = (npc.hpCurr / npc.hpMax) * 100;
    bar.style.width = `${pct}%`;
    bar.className = 'hp-bar-fill';
    
    if (pct <= 25) bar.classList.add('critical');
    else if (pct <= 50) bar.classList.add('low');
}

function rollInit(id) {
    const npc = getNPCById(id);
    if (!npc) return;
    
    const dex = getMod(npc.stats.DEX);
    const rollResult = roll(20);
    const total = rollResult + dex;
    
    npc.initiative = total;
    
    const initDisplay = document.getElementById(`init-${id}`);
    if (initDisplay) {
        initDisplay.textContent = `Init: ${total} (Rolled ${rollResult})`;
        initDisplay.classList.add('rolled');
    }
    
    showToast(`${npc.name} rolled ${total} for initiative!`);
}

function addCondition(id, condition) {
    if (!condition.trim()) return;
    const npc = getNPCById(id);
    if (!npc) return;
    
    if (!npc.conditions.includes(condition)) {
        npc.conditions.push(condition);
        renderConditions(id);
    }
}

function removeCondition(id, condition) {
    const npc = getNPCById(id);
    if (!npc) return;
    
    npc.conditions = npc.conditions.filter(c => c !== condition);
    renderConditions(id);
}

function renderConditions(id) {
    const npc = getNPCById(id);
    if (!npc) return;
    
    const container = document.getElementById(`conditions-${id}`);
    if (!container) return;
    
    container.innerHTML = npc.conditions.map(c => 
        `<span class="condition-tag">${c} <button onclick="removeCondition('${id}', '${c}')">×</button></span>`
    ).join('');
}

function rollStat(npcId, statName) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    
    const statValue = npc.stats[statName];
    const mod = getMod(statValue);
    const prof = npc.prof;
    
    const isProficient = DB.classes[npc.class].save.includes(statName);
    const totalMod = isProficient ? mod + prof : mod;
    
    const rollResult = roll(20);
    const total = rollResult + totalMod;
    
    const statBox = document.getElementById(`statbox-${npcId}-${statName}`);
    if (!statBox) return;
    
    const existing = statBox.querySelector('.stat-roll-result');
    if (existing) existing.remove();
    
    const resultDiv = document.createElement('div');
    resultDiv.className = 'stat-roll-result';
    resultDiv.innerHTML = `
        Rolled: ${rollResult} ${totalMod >= 0 ? '+' : ''}${totalMod} = <strong>${total}</strong>
        ${isProficient ? '<span style="color:var(--gold);"> (Proficient)</span>' : ''}
    `;
    statBox.appendChild(resultDiv);
    
    setTimeout(() => {
        if (resultDiv.parentElement) resultDiv.remove();
    }, 3000);
    
    statBox.style.transform = 'scale(1.1)';
    setTimeout(() => statBox.style.transform = '', 200);
}

function updateNote(id, text) {
    const npc = getNPCById(id);
    if (npc) npc.dmNotes = text;
}

function deleteNPC(id) {
    if(!confirm("Permanently delete this NPC from this session?")) return;
    var removed = generatedNPCs.find(function(n){ return n.id === id; });
    var before = JSON.parse(JSON.stringify(generatedNPCs || []));
    generatedNPCs = generatedNPCs.filter(n => n.id !== id);
    renderAllNPCs();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    if (removed && typeof dmPushUndoAction === 'function') {
        dmPushUndoAction('Delete NPC: ' + (removed.name || id), function() {
            generatedNPCs = before;
            if (typeof renderAllNPCs === 'function') renderAllNPCs();
            if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
        });
    }
    showToast('NPC deleted');
}

/* =========================================
   BATCH COMBAT FUNCTIONS
   ========================================= */
function toggleAllCombat() {
    const hasNPCs = generatedNPCs.length > 0;
    const allInCombat = hasNPCs && generatedNPCs.every(npc => npc.isCombat);
    const enteringCombat = !allInCombat;
    
    generatedNPCs.forEach(npc => {
        npc.isCombat = enteringCombat;
        const card = document.getElementById(`card-${npc.id}`);
        if (card) {
            if (npc.isCombat) {
                card.classList.add('combat-active');
            } else {
                card.classList.remove('combat-active');
            }
            const btn = card.querySelector('.btn-combat-top');
            if (btn) {
                btn.textContent = npc.isCombat ? 'End Combat' : 'Combat';
            }
        }
    });
    
    // When entering combat mode: always add players to initiative
    if (enteringCombat) {
        if (typeof addPartyToInitiative === 'function') addPartyToInitiative();
        if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
        if (typeof renderAllNPCs === 'function') renderAllNPCs();
    } else {
        // Exiting combat — refresh initiative panel
        if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    }
    
    const combatAllBtn = document.getElementById('combatAllBtn');
    if (combatAllBtn) {
        combatAllBtn.textContent = enteringCombat ? 'End Combat (All)' : 'Combat Mode (All)';
    }
    
    var msg = enteringCombat ? 'Combat mode! Players added to initiative.' : 'Combat ended.';
    showToast(msg, enteringCombat ? 'success' : 'warning');
}

function rollAllInitiative() {
    let results = [];
    
    generatedNPCs.forEach(npc => {
        const dex = getMod(npc.stats.DEX);
        const rollResult = roll(20);
        const total = rollResult + dex;
        
        npc.initiative = total;
        results.push({ name: npc.name, init: total, roll: rollResult });
        
        const initDisplay = document.getElementById(`init-${npc.id}`);
        if (initDisplay) {
            initDisplay.textContent = `Init: ${total} (Rolled ${rollResult})`;
            initDisplay.classList.add('rolled');
        }
    });
    
    // Sort by initiative
    results.sort((a, b) => b.init - a.init);
    
    const message = results.map(r => `${r.name}: ${r.init}`).join(', ');
    showToast(`Initiative rolled! ${message.substring(0, 100)}...`);
}

function longRestNPC(id) {
    const npc = getNPCById(id);
    if (!npc) return;
    
    // Restore HP
    npc.hpCurr = npc.hpMax;
    
    // Restore all spell slots
    if (npc.spellSlots) {
        if (npc.spellSlots.type === "pact") {
            npc.spellSlots.currentSlots = npc.spellSlots.maxSlots;
        } else {
            Object.keys(npc.spellSlots.slots).forEach(level => {
                npc.spellSlots.slots[level].current = npc.spellSlots.slots[level].max;
            });
            npc.spellSlots.currentSlots = npc.spellSlots.maxSlots;
        }
    }
    
    // Clear non-starting conditions
    if (npc.startingCondition) {
        npc.conditions = [npc.startingCondition];
    } else {
        npc.conditions = [];
    }
    
    refreshNPCCard(id);
    showToast(`${npc.name} took a Long Rest! HP and all spell slots restored.`);
}

// Keep restNPC as alias
function restNPC(id) { longRestNPC(id); }

function shortRestNPC(id) {
    const npc = getNPCById(id);
    if (!npc) return;
    
    // Short rest: Restore half HP (hit dice), restore Warlock pact slots
    const hdMid = Math.floor(DB.classes[npc.class]?.hd / 2) || 4;
    const conMod = getMod(npc.stats.CON);
    const hdHeal = Math.max(1, Math.floor(npc.level / 2)) * (Math.floor(Math.random() * hdMid) + 1 + conMod);
    npc.hpCurr = Math.min(npc.hpMax, npc.hpCurr + hdHeal);
    
    // Warlocks restore pact magic on short rest
    if (npc.spellSlots && npc.spellSlots.type === "pact") {
        npc.spellSlots.currentSlots = npc.spellSlots.maxSlots;
    }
    
    refreshNPCCard(id);
    showToast(`${npc.name} took a Short Rest! Regained ~${hdHeal} HP${npc.spellSlots?.type === 'pact' ? ' + Pact Magic restored' : ''}.`);
}

function restAllNPCs() {
    if (generatedNPCs.length === 0) {
        showToast('No NPCs on screen!', 'warning');
        return;
    }
    generatedNPCs.forEach(npc => {
        npc.hpCurr = npc.hpMax;
        if (npc.spellSlots) {
            if (npc.spellSlots.type === 'pact') {
                npc.spellSlots.currentSlots = npc.spellSlots.maxSlots;
            } else {
                Object.keys(npc.spellSlots.slots).forEach(level => {
                    npc.spellSlots.slots[level].current = npc.spellSlots.slots[level].max;
                });
                npc.spellSlots.currentSlots = npc.spellSlots.maxSlots;
            }
        }
        if (npc.startingCondition) {
            npc.conditions = [npc.startingCondition];
        } else {
            npc.conditions = [];
        }
    });
    // Refresh all cards
    generatedNPCs.forEach(npc => refreshNPCCard(npc.id));
    showToast(`All ${generatedNPCs.length} NPCs rested — HP and spell slots restored!`, 'success');
}

function shortRestAllNPCs() {
    if (generatedNPCs.length === 0) {
        showToast('No NPCs on screen!', 'warning');
        return;
    }
    generatedNPCs.forEach(npc => {
        const hdMid = Math.floor((DB.classes[npc.class]?.hd || 8) / 2);
        const conMod = getMod(npc.stats.CON);
        const hdHeal = Math.max(1, Math.floor(npc.level / 2)) * (Math.floor(Math.random() * hdMid) + 1 + conMod);
        npc.hpCurr = Math.min(npc.hpMax, npc.hpCurr + hdHeal);
        if (npc.spellSlots && npc.spellSlots.type === 'pact') {
            npc.spellSlots.currentSlots = npc.spellSlots.maxSlots;
        }
    });
    generatedNPCs.forEach(npc => refreshNPCCard(npc.id));
    showToast(`All ${generatedNPCs.length} NPCs took a Short Rest — HP partially restored!`, 'success');
}

function printNPC(id) {
    const npc = getNPCById(id);
    if (!npc) return;

    const statMod = (s) => { const m = Math.floor((s-10)/2); return (m>=0?'+':'')+m; };

    const ALL_SKILLS_P = [
        {name:"Acrobatics",stat:"DEX"},{name:"Animal Handling",stat:"WIS"},{name:"Arcana",stat:"INT"},
        {name:"Athletics",stat:"STR"},{name:"Deception",stat:"CHA"},{name:"History",stat:"INT"},
        {name:"Insight",stat:"WIS"},{name:"Intimidation",stat:"CHA"},{name:"Investigation",stat:"INT"},
        {name:"Medicine",stat:"WIS"},{name:"Nature",stat:"INT"},{name:"Perception",stat:"WIS"},
        {name:"Performance",stat:"CHA"},{name:"Persuasion",stat:"CHA"},{name:"Religion",stat:"INT"},
        {name:"Sleight of Hand",stat:"DEX"},{name:"Stealth",stat:"DEX"},{name:"Survival",stat:"WIS"}
    ];
    const classData = DB.classes[npc.class] || {};
    const classSkills = classData.skills || [];
    const prof = npc.prof || Math.ceil(1 + npc.level/4);
    const expertiseCount = npc.class==="Rogue" ? Math.ceil(classSkills.length/2) : (npc.class==="Bard" ? 2 : 0);
    const expertiseSkills = new Set(classSkills.slice(0, expertiseCount));
    const hasJAT = npc.class === "Bard";
    const saveProfs = classData.save || [];

    const skillRows = ALL_SKILLS_P.map(skill => {
        const mod = Math.floor((npc.stats[skill.stat]-10)/2);
        const isProf = classSkills.includes(skill.name);
        const isExp = isProf && expertiseSkills.has(skill.name);
        const isJAT2 = !isProf && hasJAT;
        let total = mod + (isExp ? prof*2 : isProf ? prof : isJAT2 ? Math.floor(prof/2) : 0);
        const sign = total>=0?"+":"";
        const dot = isExp ? "\u25C6" : isProf ? "\u25CF" : isJAT2 ? "\u25D0" : "\u25CB";
        const color = isExp ? "#8B6914" : isProf ? "#8b0000" : "#888";
        return `<tr><td style="color:${color};font-size:11px;padding:2px 4px;">${dot}</td><td style="padding:2px 4px;font-size:11px;">${sign}${total}</td><td style="padding:2px 4px;font-size:11px;">${skill.name}</td><td style="padding:2px 4px;font-size:9px;color:#888;">${skill.stat}</td></tr>`;
    }).join("");

    const savesRows = ["STR","DEX","CON","INT","WIS","CHA"].map(stat => {
        const base = Math.floor((npc.stats[stat]-10)/2);
        const isSP = saveProfs.includes(stat);
        const total = base + (isSP ? prof : 0);
        const sign = total>=0?"+":"";
        const dot = isSP ? "\u25CF" : "\u25CB";
        const color = isSP ? "#8b0000" : "#888";
        return `<tr><td style="color:${color};padding:2px 4px;font-size:11px;">${dot}</td><td style="padding:2px 4px;font-size:11px;">${sign}${total}</td><td style="padding:2px 4px;font-size:11px;">${stat}</td></tr>`;
    }).join("");

    const percMod = Math.floor((npc.stats.WIS-10)/2) + (classSkills.includes("Perception") ? (expertiseSkills.has("Perception") ? prof*2 : prof) : (hasJAT ? Math.floor(prof/2) : 0));
    const passivePerc = 10 + percMod;

    const raceData = DB.races[npc.race] || {};
    const senses = raceData.senses || [];
    const sensesHTML = senses.length > 0 ? senses.map(s => `<span class="sense-tag">${s}</span>`).join("") : `<span style="color:#888;font-size:11px;">Standard vision only</span>`;

    // Build grouped spell HTML
    let spellSectionHTML = "";
    if (npc.spells && npc.spells.some(s => !s.header)) {
        const byLevel = {};
        npc.spells.filter(s => !s.header).forEach(s => {
            const lv = String(s.level || 0);
            if (!byLevel[lv]) byLevel[lv] = [];
            byLevel[lv].push(s);
        });

        let slotHTML = "";
        if (npc.spellSlots) {
            if (npc.spellSlots.type === "standard") {
                slotHTML = `<div class="slot-row">`;
                Object.entries(npc.spellSlots.slots).forEach(([lv, data]) => {
                    slotHTML += `<div class="slot-level-block"><div class="slot-lv-label">Lvl ${lv}</div>`;
                    for (let i=0;i<data.max;i++) slotHTML += `<span class="slot-circle"></span>`;
                    slotHTML += `</div>`;
                });
                slotHTML += `</div>`;
            } else if (npc.spellSlots.type === "pact") {
                slotHTML = `<div class="slot-row"><div class="slot-level-block"><div class="slot-lv-label">Pact (Lvl ${npc.spellSlots.slotLevel})</div>`;
                for (let i=0;i<npc.spellSlots.maxSlots;i++) slotHTML += `<span class="slot-circle" style="width:16px;height:16px;"></span>`;
                slotHTML += `</div></div>`;
            }
        }
        const headerSpell = npc.spells.find(s => s.header);
        const spellMeta = headerSpell ? `<div style="font-size:10px;color:#666;margin-bottom:6px;">${headerSpell.text}</div>` : "";

        const groupedHTML = Object.entries(byLevel).sort(([a],[b])=>Number(a)-Number(b)).map(([lv, spells]) => {
            const lvLabel = lv==="0" ? "Cantrips (At Will)" : `Level ${lv} Spells`;
            const spellCards = spells.map(sp => {
                const sData = sp.data || {};
                const comp = [sData.verbal?"V":"", sData.somatic?"S":"", sData.material?"M":""].filter(Boolean).join(", ");
                const castTime = sData.castingTime || "";
                const range = sData.range || "";
                const duration = sData.duration || "";
                const school = sData.school || "";
                const desc = sData.desc || "";
                const metaParts = [castTime&&("Cast: "+castTime), range&&("Range: "+range), duration&&("Duration: "+duration)].filter(Boolean).join("  \u2022  ");
                return `<div class="spell-card"><div class="spell-name">${sp.name}<span class="spell-school">${school}</span></div>${metaParts?`<div class="spell-meta">${metaParts}</div>`:""}${comp?`<div class="spell-comp">Components: ${comp}</div>`:""}${desc?`<div class="spell-desc">${desc}</div>`:""}</div>`;
            }).join("");
            return `<div class="spell-level-group"><div class="spell-level-header">${lvLabel}</div>${spellCards}</div>`;
        }).join("");

        spellSectionHTML = slotHTML + spellMeta + groupedHTML;
    }

    const portraitImg = npc._portraitDataUrl
        ? `<img src="${npc._portraitDataUrl || npc._aiPortraitUrl}" style="width:110px;height:auto;border-radius:4px;border:2px solid #b8860b;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:block;" />`
        : "";

    const CSS = `
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
  @page{size:A4;margin:0.6cm;}
  *{box-sizing:border-box;margin:0;padding:0;}
  html,body{width:100%;background:#fff;color:#1a1a1a;}
  body{font-family:'Crimson Text',serif;padding:4px 6px;font-size:9.5px;line-height:1.25;}
  .sheet{max-width:100%;margin:0 auto;}
  h1{font-family:'Cinzel',serif;font-size:13px;color:#8b0000;text-align:center;border-bottom:2px double #b8860b;padding-bottom:4px;margin-bottom:6px;letter-spacing:1px;}
  .section{border:1px solid #d4c89a;border-radius:3px;padding:4px 6px;margin-bottom:4px;background:#fff;break-inside:avoid;page-break-inside:avoid;}
  .section h3{font-family:'Cinzel',serif;font-size:8px;color:#8b0000;border-bottom:1px solid #e8d9a0;padding-bottom:2px;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;}
  .top-row{display:grid;grid-template-columns:repeat(5,1fr);gap:3px;margin-bottom:4px;}
  .field-group{border:1px solid #d4c89a;border-radius:2px;padding:2px 4px;background:#fff;}
  .field-label{font-size:6px;text-transform:uppercase;letter-spacing:0.6px;color:#8b0000;font-weight:700;}
  .field-val{font-size:9px;font-weight:600;}
  .stats-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:3px;margin-bottom:5px;}
  .stat-box{border:1.5px solid #8b0000;border-radius:3px;text-align:center;padding:3px 1px;background:#fff;}
  .stat-name{font-size:6px;text-transform:uppercase;font-weight:700;color:#8b0000;}
  .stat-score{font-size:13px;font-weight:700;font-family:'Cinzel',serif;}
  .stat-mod{font-size:9px;color:#8b0000;font-weight:700;}
  .hp-box{border:1.5px solid #8b0000;border-radius:4px;text-align:center;padding:3px;background:#fff;}
  .hp-label{font-size:6px;text-transform:uppercase;color:#8b0000;font-weight:700;}
  .hp-val{font-size:14px;font-weight:700;font-family:'Cinzel',serif;color:#8b0000;}
  .main-cols{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
  .left-col,.right-col{display:flex;flex-direction:column;gap:4px;}
  table{width:100%;border-collapse:collapse;font-size:8.5px;}
  th{background:#8b0000;color:#fff;padding:2px 4px;text-align:left;font-size:7.5px;font-family:'Cinzel',serif;}
  td{border-bottom:1px solid #ece6d5;padding:1.5px 4px;}
  tr:nth-child(even) td{background:#faf7f0;}
  .trait-box{background:#faf7f0;border:1px solid #ddd6b8;border-radius:2px;padding:2px 5px;margin-bottom:2px;}
  .trait-label{font-size:6.5px;color:#8b0000;font-weight:700;text-transform:uppercase;margin-bottom:1px;}
  .boss-banner{background:linear-gradient(135deg,#4a0080,#8b0000);color:gold;text-align:center;padding:4px;border-radius:3px;font-family:'Cinzel',serif;font-weight:700;font-size:11px;letter-spacing:2px;margin-bottom:5px;}
  .skills-table{width:100%;}
  .skills-table td{padding:1px 2px;font-size:8.5px;border:none;}
  .sense-tag{display:inline-block;background:#f0e8cc;border:1px solid #c8b870;border-radius:2px;padding:0px 4px;font-size:7.5px;margin:1px;}
  .slot-row{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px;padding:3px 6px;background:#f8f4ec;border-radius:2px;border:1px solid #e0d0a0;}
  .slot-level-block{text-align:center;}
  .slot-lv-label{font-size:7px;font-weight:700;color:#8b0000;text-transform:uppercase;margin-bottom:1px;}
  .slot-circle{display:inline-block;width:9px;height:9px;border:1.5px solid #8b0000;border-radius:50%;margin:1px;}
  .spell-level-group{margin-bottom:4px;}
  .spell-level-header{font-family:'Cinzel',serif;font-size:7.5px;font-weight:700;color:#8b0000;background:linear-gradient(90deg,#f8f0e0,transparent);border-left:2px solid #b8860b;padding:1px 5px;margin-bottom:2px;text-transform:uppercase;}
  .spell-card{background:#fdfaf4;border:1px solid #e8ddb8;border-radius:2px;padding:2px 5px;margin-bottom:2px;}
  .spell-name{font-family:'Cinzel',serif;font-size:8.5px;font-weight:700;color:#1a1a1a;}
  .spell-school{font-size:7.5px;color:#8b6914;font-style:italic;margin-left:3px;}
  .spell-meta{font-size:7.5px;color:#555;margin-bottom:1px;}
  .spell-desc{font-size:8px;color:#333;font-style:italic;line-height:1.25;}
  .feat-row{display:flex;gap:3px;margin-bottom:3px;font-size:8.5px;line-height:1.25;}
  .feat-name{font-weight:700;color:#8b0000;min-width:75px;flex-shrink:0;}
  .sub-feat-row{display:flex;gap:3px;margin-bottom:2px;padding:2px 5px;background:#f6f0ff;border-left:2px solid #9b59b6;border-radius:0 2px 2px 0;font-size:8px;line-height:1.25;}
  .sub-feat-name{font-weight:700;color:#7b5ea7;min-width:75px;flex-shrink:0;}
  @media print{
    html,body{width:100%;height:auto;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
    body{padding:2px 4px;font-size:9px;}
    .section{break-inside:avoid;page-break-inside:avoid;margin-bottom:3px;}
    .main-cols{gap:4px;}
    h1{font-size:12px;margin-bottom:5px;}
  }
`;

    const BODY = `
<div class="sheet">
  ${npc.isBoss ? '<div class="boss-banner">&#128081; LEGENDARY BOSS NPC</div>' : ''}

  <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:8px;">
    ${portraitImg ? `<div style="flex-shrink:0;">${portraitImg}</div>` : ''}
    <div style="flex:1;">
      <h1>${npc.name}</h1>
      <div class="top-row">
        <div class="field-group"><div class="field-label">Race / Class</div><div class="field-val">${npc.race} ${npc.class}${npc.subclass ? ' — ' + npc.subclass.name : ''}</div></div>
        <div class="field-group"><div class="field-label">Level / Prof</div><div class="field-val">Lvl ${npc.level} &nbsp;+${npc.prof}</div></div>
        <div class="field-group"><div class="field-label">AC / Speed</div><div class="field-val">${npc.ac} AC · ${npc.speed}ft</div></div>
        <div class="field-group"><div class="field-label">Occupation</div><div class="field-val">${npc.occupation}</div></div>
        <div class="field-group"><div class="field-label">Age</div><div class="field-val">${npc.age} yrs (${npc.ageCategory})</div></div>
        <div class="field-group"><div class="field-label">Kill XP / Quest XP</div><div class="field-val">${(npc.killXP||0).toLocaleString()} / ${(npc.questXP||0).toLocaleString()}</div></div>
        <div class="hp-box" style="padding:4px 8px;"><div class="hp-label">Max HP</div><div class="hp-val" style="font-size:18px;">${npc.hpMax}</div></div>
        <div class="hp-box" style="border-color:#b8860b;padding:4px 8px;"><div class="hp-label">Current HP</div><div class="hp-val" style="color:#b8860b;font-size:15px;">______/ ${npc.hpMax}</div></div>
        <div class="hp-box" style="border-color:#555;padding:4px 8px;"><div class="hp-label">Temp HP &amp; Init</div><div class="hp-val" style="color:#555;font-size:14px;">_____ / ____</div></div>
        <div class="hp-box" style="border-color:#27ae60;padding:4px 8px;"><div class="hp-label">Death Saves</div><div class="hp-val" style="font-size:12px;color:#555;">&#9675;&#9675;&#9675; / &#9675;&#9675;&#9675;</div></div>
      </div>
    </div>
  </div>

  <div class="stats-grid" style="margin-bottom:7px;">
    ${Object.entries(npc.stats).map(([k,v]) => `<div class="stat-box"><div class="stat-name">${k}</div><div class="stat-score">${v}</div><div class="stat-mod">${statMod(v)}</div></div>`).join("")}
  </div>

  <div class="main-cols">
    <div class="left-col">
      <div class="section">
        <h3>&#9876; Attacks &amp; Actions</h3>
        <table>
          <tr><th>Weapon</th><th>Atk</th><th>Damage</th><th>Range</th><th>Type</th></tr>
          ${npc.attacks.map(a => `<tr><td><strong>${a.name}</strong></td><td>${a.roll}</td><td>${a.dmg} ${a.dmgType}</td><td>${a.range}</td><td>${a.type}</td></tr>`).join("")}
        </table>
        ${npc.class==="Rogue" ? `<div style="margin-top:4px;padding:3px 6px;background:#fdf8f0;border-left:2px solid #b8860b;font-size:10px;"><strong>Sneak Attack:</strong> +${Math.ceil(npc.level/2)}d6</div>` : ""}
      </div>

      <div class="section">
        <h3>&#128737;&#65039; Class Features${npc.subclass ? ' &amp; ' + npc.subclass.name : ''}</h3>
        ${npc.features.map(f => `<div class="feat-row"><span class="feat-name">${f.name}:</span><span>${f.desc}</span></div>`).join("")}
        ${(npc.subclass && npc.subclass.features && npc.subclass.features.length > 0) ? `
          <div style="margin-top:6px;padding-top:5px;border-top:1px dashed #c9b7e0;">
            <div style="font-family:'Cinzel',serif;font-size:8px;font-weight:700;color:#7b5ea7;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">&#10022; ${npc.subclass.name} Subclass Features</div>
            ${npc.subclass.features.map(f => `<div class="sub-feat-row"><span class="sub-feat-name">${f.name} <span style="font-size:8px;color:#aaa;">(Lvl${f.level}+)</span>:</span><span>${f.desc}</span></div>`).join("")}
          </div>` : ""}
      </div>

      ${spellSectionHTML ? `<div class="section"><h3>&#10024; Spells &amp; Spell Slots</h3>${spellSectionHTML}</div>` : ""}

      <div class="section">
        <h3>&#128220; Quest &amp; Bounty</h3>
        <p style="margin-bottom:3px;font-size:10.5px;"><strong style="color:#8b0000;">${npc.quest.category}:</strong> ${npc.quest.desc}</p>
        <p style="font-size:10px;"><strong>Reward:</strong> ${npc.quest.reward}</p>
        ${npc.isBountyTarget ? `
        <div style="background:linear-gradient(145deg,#fff8f8,#ffeaea);border:2px solid #8b0000;border-radius:6px;padding:8px;margin-top:6px;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#8b0000,#dc143c,#8b0000);"></div>
            <div style="margin-top:4px;text-align:center;">
                <div style="font-family:'Cinzel',serif;font-weight:900;font-size:10px;color:#5a0000;letter-spacing:2px;text-transform:uppercase;border-bottom:1px solid #c0392b;padding-bottom:4px;margin-bottom:5px;">WANTED — ${npc.bountyPoster||'Dead or Alive'}</div>
                <div style="font-family:'Cinzel',serif;font-size:11px;font-weight:700;color:#5a0000;margin-bottom:5px;">${npc.bountyTitle||''}</div>
            </div>
            ${npc.bountyCrime ? `<div style="background:rgba(139,0,0,0.06);border-left:3px solid #8b0000;padding:4px 7px;border-radius:0 3px 3px 0;font-size:9.5px;margin-bottom:4px;"><strong style="color:#8b0000;font-size:8.5px;text-transform:uppercase;">Crime:</strong> ${npc.bountyCrime}</div>` : ''}
            ${npc.bountyBackstory ? `<div style="background:rgba(74,0,128,0.06);border-left:3px solid #7b00c8;padding:4px 7px;border-radius:0 3px 3px 0;font-size:9.5px;margin-bottom:4px;font-style:italic;"><strong style="color:#5a0080;font-size:8.5px;text-transform:uppercase;font-style:normal;">History:</strong> ${npc.bountyBackstory}</div>` : ''}
            ${npc.bountyBeware ? `<div style="background:rgba(231,76,60,0.07);border-left:3px solid #e74c3c;padding:4px 7px;border-radius:0 3px 3px 0;font-size:9.5px;margin-bottom:4px;"><strong style="color:#c0392b;font-size:8.5px;text-transform:uppercase;">Beware:</strong> ${npc.bountyBeware}</div>` : ''}
            ${npc.bountyNeeds ? `<div style="background:rgba(39,174,96,0.07);border-left:3px solid #27ae60;padding:4px 7px;border-radius:0 3px 3px 0;font-size:9.5px;margin-bottom:6px;"><strong style="color:#1e8449;font-size:8.5px;text-transform:uppercase;">Requirements:</strong> ${npc.bountyNeeds}</div>` : ''}
            <div style="background:linear-gradient(145deg,#fff8dc,#f5e8a0);border:1px solid #b8860b;border-radius:5px;padding:6px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <div style="text-align:center;"><div style="font-size:7.5px;font-weight:700;text-transform:uppercase;color:#5a3a00;font-family:'Cinzel',serif;">Gold Reward</div><div style="font-size:12px;font-weight:900;color:#27ae60;font-family:'Cinzel',serif;">${npc.bountyReward||'—'}</div></div>
                <div style="width:1px;background:#b8860b;opacity:0.4;"></div>
                <div style="text-align:center;"><div style="font-size:7.5px;font-weight:700;text-transform:uppercase;color:#5a3a00;font-family:'Cinzel',serif;">Kill XP</div><div style="font-size:12px;font-weight:900;color:#c0392b;font-family:'Cinzel',serif;">${(npc.killXP||0).toLocaleString()}</div></div>
                <div style="width:1px;background:#b8860b;opacity:0.4;"></div>
                <div style="text-align:center;"><div style="font-size:7.5px;font-weight:700;text-transform:uppercase;color:#5a3a00;font-family:'Cinzel',serif;">Quest XP</div><div style="font-size:12px;font-weight:900;color:#2980b9;font-family:'Cinzel',serif;">${(npc.questXP||0).toLocaleString()}</div></div>
            </div>
            ${npc.bountyCount > 1 ? `<div style="margin-top:4px;font-size:8.5px;text-align:center;color:#888;font-style:italic;">Part of ${npc.bountyCount}-target group bounty — Role: ${npc.groupRole||'Target'}</div>` : ''}
        </div>` : ''}
      </div>
    </div>

    <div class="right-col">
      <div class="section">
        <h3>&#127917; Personality &amp; Background</h3>
        <div class="trait-box" style="margin-bottom:3px;"><div class="trait-label">Traits</div>${npc.personality.traits.join(" \u2022 ")}</div>
        ${npc.personality.flaw ? `<div class="trait-box" style="margin-bottom:3px;"><div class="trait-label">&#9888; Flaw</div>${npc.personality.flaw}</div>` : ""}
        ${npc.personality.speech ? `<div class="trait-box" style="margin-bottom:3px;"><div class="trait-label">Speech</div>${npc.personality.speech}</div>` : ""}
        ${npc.personality.secret ? `<div class="trait-box" style="margin-bottom:3px;"><div class="trait-label">&#128272; Secret</div>${npc.personality.secret}</div>` : ""}
        <div class="trait-box" style="margin-bottom:3px;"><div class="trait-label">Appearance</div>${npc.physicalDesc}</div>
        ${npc.appearance ? `<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:3px;"><div class="trait-box" style="margin:0;"><div class="trait-label">Clothing</div>${npc.appearance.clothing||"—"}</div><div class="trait-box" style="margin:0;"><div class="trait-label">Armour</div>${npc.appearance.armor||"—"}</div></div>` : ""}
      </div>

      <div class="section">
        <h3>&#127922; Skills &amp; Saving Throws</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div>
            <div style="font-family:'Cinzel',serif;font-size:8px;color:#8b0000;font-weight:700;text-transform:uppercase;margin-bottom:3px;">Saving Throws</div>
            <table class="skills-table">${savesRows}</table>
            <div style="margin-top:4px;font-size:9.5px;"><strong>Passive Perception:</strong> ${passivePerc}</div>
            ${expertiseCount > 0 ? `<div style="font-size:9px;color:#8b6914;font-style:italic;">Expertise &#x25C6; (${expertiseCount} skills)</div>` : ""}
          </div>
          <div>
            <div style="font-family:'Cinzel',serif;font-size:8px;color:#8b0000;font-weight:700;text-transform:uppercase;margin-bottom:3px;">Skills</div>
            <table class="skills-table">${skillRows}</table>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>&#128065; Senses &amp; Movement</h3>
        <div style="margin-bottom:4px;">${sensesHTML}</div>
        <div style="font-size:10.5px;"><strong>Speed:</strong> ${npc.speed} ft &nbsp;|&nbsp; <strong>Passive Perception:</strong> ${passivePerc}</div>
      </div>

      <div class="section">
        <h3>&#128176; Equipment &amp; Inventory</h3>
        <table>
          <tr><th>Item</th><th>Type</th><th>Rarity</th><th>Value</th></tr>
          ${npc.inventory.map(i => `<tr><td>${i.name}</td><td>${i.type||"—"}</td><td style="color:${i.rarity==="legendary"?"#ff8000":i.rarity==="epic"?"#a335ee":i.rarity==="rare"?"#0070dd":i.rarity==="uncommon"?"#1eff00":"#9d9d9d"};">${i.rarity||"common"}</td><td>${i.cost||"—"}</td></tr>`).join("")}
        </table>
      </div>

      ${npc.groupName ? `<div class="section"><h3>&#128101; Group</h3><p style="font-size:10.5px;"><strong style="color:#8b0000;">${npc.groupName}</strong> &nbsp;&#8212;&nbsp; ${npc.groupRole||"Member"}</p>${npc.groupGoal?`<p style="font-size:10px;color:#555;">${npc.groupGoal}</p>`:""}</div>` : ""}

      <div class="section">
        <h3>&#128221; DM Notes</h3>
        <div style="min-height:40px;border:1px solid #ddd;border-radius:3px;padding:5px;font-size:10px;color:#555;">${npc.dmNotes || "&nbsp;"}</div>
      </div>
    </div>
  </div>
</div>
`;

    const printWindow = window.open("", "_blank");
    printWindow.document.write(`<!DOCTYPE html><html><head><title>NPC Sheet \u2014 ${npc.name}</title><style>${CSS}</style></head><body>${BODY}<script>window.onload=()=>window.print();<\u002fscript></body></html>`);
    printWindow.document.close();
}

/* =========================================
   PRINT NPC AS WANTED POSTER
   ========================================= */
function printNPCWantedPoster(id) {
    const npc = getNPCById(id);
    if (!npc) return;

    var pc = (npc.bountyPoster||'').indexOf('BOSS') !== -1 ? '#4a0080'
           : (npc.bountyPoster||'').indexOf('Alive Only') !== -1 ? '#1a6b3a'
           : '#8b0000';
    var bgStyle = npc.isBoss
        ? 'background:linear-gradient(145deg,#fff8dc,#f5e68c);border:4px solid #b8860b;'
        : 'background:linear-gradient(145deg,#fffaf5,#f9f0e0);border:3px solid #8b0000;';

    var portraitSection = npc._portraitDataUrl || npc._aiPortraitUrl
        ? '<div style="text-align:center;margin-bottom:14px;"><img src="'+(npc._aiPortraitUrl||npc._portraitDataUrl)+'" style="width:180px;height:auto;border:3px solid '+pc+';border-radius:4px;box-shadow:0 4px 16px rgba(0,0,0,0.35);" /></div>'
        : '';

    var bSec = npc.bountyBeware ? '<div class="section"><div class="sec-label" style="color:#c0392b;">Beware</div><div class="sec-body">'+npc.bountyBeware+'</div></div>' : '';
    var nSec = npc.bountyNeeds ? '<div class="section"><div class="sec-label" style="color:#1a6b3a;">Requirements</div><div class="sec-body">'+npc.bountyNeeds+'</div></div>' : '';
    var backstorySec = npc.bountyBackstory ? '<div class="section"><div class="sec-label" style="color:#5a0080;">Known History</div><div class="sec-body" style="font-style:italic;">'+npc.bountyBackstory+'</div></div>' : '';

    var killXP = (npc.killXP||0).toLocaleString();
    var questXP = (npc.questXP||0).toLocaleString();

    var itemRewardHtml = '';
    if (npc.bountyItemRewards && npc.bountyItemRewards.length > 0) {
        var RCMAP = {common:'#9d9d9d',uncommon:'#1eff00',rare:'#0070dd','very rare':'#a335ee',legendary:'#ff8000',artifact:'#e6cc80'};
        var itemsHtml = npc.bountyItemRewards.map(function(item){
            var rc = RCMAP[item.rarity] || '#9d9d9d';
            return '<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:5px;padding:6px 8px;background:rgba(255,255,255,0.6);border-radius:4px;border-left:3px solid '+rc+';">'
                + '<span style="font-size:1.2em;flex-shrink:0;">'+item.icon+'</span>'
                + '<div>'
                + '<div style="font-size:11px;font-weight:700;color:'+rc+';">'+item.name+'</div>'
                + '<div style="font-size:9.5px;color:#666;font-style:italic;margin-top:1px;">'+item.type+' &middot; '+item.rarity+'</div>'
                + '<div style="font-size:10px;color:#333;margin-top:2px;">'+item.desc+'</div>'
                + '</div></div>';
        }).join('');
        itemRewardHtml = '<div style="margin-top:12px;padding:10px 14px;background:linear-gradient(145deg,#fff8dc,#f5e8a0);border:1px solid #b8860b;border-radius:6px;">'
            + '<div style="font-size:9px;font-weight:700;color:#5a0000;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:7px;">&#10024; Item Reward'+(npc.bountyItemRewards.length>1?'s':'')+' upon Completion</div>'
            + itemsHtml
            + '</div>';
    }

    var html = '<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">'
        + '<title>Wanted — '+npc.name+'</title>\n'
        + '<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">\n'
        + '<style>\n'
        + '* { box-sizing:border-box; margin:0; padding:0; }\n'
        + '@page { size:A4 portrait; margin:0; }\n'
        + 'body { font-family:\'Crimson Text\',Georgia,serif; background:#d0c9a8; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:30px 20px; flex-direction:column; }\n'
        + '.poster { '+bgStyle+' border-radius:4px; width:600px; max-width:100%; padding:0; box-shadow:0 8px 30px rgba(0,0,0,0.5); position:relative; overflow:hidden; }\n'
        + '.top-bar { background:'+pc+'; padding:10px 24px; }\n'
        + '.top-bar-inner { border:2px solid rgba(255,255,255,0.35); border-radius:2px; padding:12px 20px; text-align:center; }\n'
        + '.wanted-word { font-family:\'Cinzel\',serif; font-weight:900; font-size:42px; color:#fff8dc; letter-spacing:12px; text-transform:uppercase; text-shadow:2px 3px 6px rgba(0,0,0,0.5); line-height:1; }\n'
        + '.poster-type { font-family:\'Cinzel\',serif; font-size:13px; color:rgba(255,255,255,0.9); letter-spacing:4px; text-transform:uppercase; margin-top:4px; }\n'
        + '.content { padding:22px 28px; }\n'
        + '.title-block { text-align:center; padding:14px 0 16px; border-bottom:2px solid '+pc+'; margin-bottom:14px; }\n'
        + '.bounty-title { font-family:\'Cinzel\',serif; font-weight:900; font-size:24px; color:#3a0000; }\n'
        + '.threat-badge { display:inline-block; background:'+pc+'; color:white; font-family:\'Cinzel\',serif; font-size:10px; font-weight:700; letter-spacing:1px; padding:3px 14px; border-radius:14px; margin-top:8px; text-transform:uppercase; }\n'
        + '.section { margin-bottom:10px; }\n'
        + '.sec-label { font-family:\'Cinzel\',serif; font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; color:'+pc+'; margin-bottom:3px; border-bottom:1px solid rgba(0,0,0,0.12); padding-bottom:2px; }\n'
        + '.sec-body { font-size:12px; line-height:1.5; color:#2a1a00; }\n'
        + '.info-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }\n'
        + '.reward-block { background:'+pc+'; border-radius:4px; padding:14px 20px; margin-top:14px; display:flex; align-items:center; justify-content:space-around; gap:10px; }\n'
        + '.reward-item { text-align:center; }\n'
        + '.reward-label { font-family:\'Cinzel\',serif; font-size:8px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:rgba(255,248,220,0.8); margin-bottom:4px; }\n'
        + '.reward-value { font-family:\'Cinzel\',serif; font-size:22px; font-weight:900; color:#fff8dc; line-height:1; }\n'
        + '.reward-div { width:1px; height:46px; background:rgba(255,248,220,0.3); }\n'
        + '.footer-bar { background:'+pc+'; padding:8px 24px; text-align:center; }\n'
        + '.footer-text { font-family:\'Cinzel\',serif; font-size:9px; color:rgba(255,255,255,0.7); letter-spacing:2px; text-transform:uppercase; }\n'
        + '.no-print { text-align:center; margin-top:20px; }\n'
        + '@media print { body { background:white; padding:0; } .poster { box-shadow:none; width:100%; max-width:100%; border-radius:0; } .no-print { display:none !important; } }\n'
        + '</style>\n</head>\n<body>\n'
        + '<div class="poster">\n'
        + '  <div class="top-bar"><div class="top-bar-inner">'
        + '<div class="wanted-word">WANTED</div>'
        + '<div class="poster-type">'+(npc.bountyPoster||'Dead or Alive')+'</div>'
        + '</div></div>\n'
        + '  <div class="content">\n'
        + '    <div class="title-block">'
        + '<div class="bounty-title">'+npc.name+'</div>'
        + '<div class="threat-badge">'+(npc.bountyThreat||npc.race+' '+npc.class+', Level '+npc.level)+'</div>'
        + '</div>\n'
        + portraitSection
        + '    <div class="section"><div class="sec-label">Crime</div><div class="sec-body">'+(npc.bountyCrime||'Wanted by authorities.')+'</div></div>\n'
        + '    <div class="section"><div class="sec-label">Known Description</div><div class="sec-body">'+npc.physicalDesc+(npc.appearance ? ' Typically seen wearing '+npc.appearance.clothing+'.' : '')+'</div></div>\n'
        + backstorySec
        + bSec + nSec
        + '    <div class="info-grid">'
        + '<div class="section"><div class="sec-label">Race / Class</div><div class="sec-body">'+npc.race+' '+npc.class+(npc.subclass?' — '+npc.subclass.name:'')+'</div></div>'
        + '<div class="section"><div class="sec-label">Level</div><div class="sec-body">Level '+npc.level+'</div></div>'
        + '</div>\n'
        + '    <div class="reward-block">'
        + '<div class="reward-item"><div class="reward-label">Gold Reward</div><div class="reward-value">'+(npc.bountyReward||'—')+'</div></div>'
        + '<div class="reward-div"></div>'
        + '<div class="reward-item"><div class="reward-label">Kill XP</div><div class="reward-value">'+killXP+'</div></div>'
        + '<div class="reward-div"></div>'
        + '<div class="reward-item"><div class="reward-label">Quest XP</div><div class="reward-value">'+questXP+'</div></div>'
        + '</div>\n'
        + itemRewardHtml
        + '  </div>\n'
        + '  <div class="footer-bar"><div class="footer-text">Posted by Order of the City Guard &amp; Merchants\' Guild &nbsp;&middot;&nbsp; Report to the nearest Guard Barracks</div></div>\n'
        + '</div>\n'
        + '<div class="no-print">'
        + '<button onclick="window.print()" style="background:#8b0000;color:white;border:none;padding:12px 30px;font-family:\'Cinzel\',serif;font-size:1em;font-weight:700;border-radius:6px;cursor:pointer;letter-spacing:1px;box-shadow:0 4px 14px rgba(0,0,0,0.3);">Print / Save as PDF</button>'
        + '<button onclick="window.close()" style="background:#555;color:white;border:none;padding:12px 20px;font-family:\'Cinzel\',serif;font-size:1em;font-weight:700;border-radius:6px;cursor:pointer;margin-left:10px;">Close</button>'
        + '</div>\n'
        + '</body>\n</html>';

    var win = window.open('', '_blank', 'width=720,height=950');
    if (!win) { alert('Please allow pop-ups for this page to print wanted posters.'); return; }
    win.document.open();
    win.document.write(html);
    win.document.close();
}

/* =========================================
   STORAGE FUNCTIONS
   ========================================= */
function saveNPC(id) {
    const npc = getNPCById(id);
    if (!npc) return;
    
    let vault = JSON.parse(localStorage.getItem('dm_vault') || "[]");
    
    const index = vault.findIndex(n => n.id === npc.id);
    if(index >= 0) {
        vault[index] = npc;
    } else {
        vault.push(npc);
    }
    
    if (!window._isOneShot) localStorage.setItem('dm_vault', JSON.stringify(vault));
    loadSavedNPCs();
    updateRelativeSelect();
    
    const special = npc.isBoss ? 'boss' : npc.isRelative ? 'relative' : '';
    showToast(`${npc.name} saved to Saved NPCs`, 'success', special);
}

function loadSavedNPCs() {
    const list = document.getElementById('savedList');
    const vault = JSON.parse(localStorage.getItem('dm_vault') || '[]');
    
    list.innerHTML = "";
    if (vault.length === 0) {
        list.innerHTML = "<div style='font-size:0.9em; color:#666; text-align:center; padding:20px;'>Your vault is empty.<br>Generate and save some NPCs!</div>";
        return;
    }
    
    vault.forEach(entry => {
        const div = document.createElement('div');
        
        if (entry._isGroup) {
            div.className = 'vault-group-item';
            const memberNames = (entry.members || []).slice(0, 3).map(m => m.name).join(', ');
            const extraCount = (entry.members || []).length > 3 ? ` +${entry.members.length - 3} more` : '';
            const savedDate = entry.savedAt ? new Date(entry.savedAt).toLocaleDateString() : '';
            div.innerHTML = `
                <div class="vault-group-name">&#x1F465; ${entry.groupName}</div>
                <div class="vault-group-info">${entry.groupType || 'Group'} &bull; ${entry.memberCount} members${savedDate ? ' &bull; ' + savedDate : ''}</div>
                <div class="vault-group-info" style="margin-top:3px; font-style:italic; color:#555;">${memberNames}${extraCount}</div>
                <div class="vault-group-btns">
                    <button class="btn-mini btn-load" onclick="loadNPC('${entry.id}')">Load Group</button>
                    <button class="btn-mini btn-delete" onclick="removeSaved('${entry.id}')">&#x00D7;</button>
                </div>
            `;
        } else {
            div.className = 'saved-item';
            div.innerHTML = `
                <div>
                    <strong>${entry.name}</strong> ${entry.isBoss ? '&#x1F451;' : ''} ${entry.isRelative ? '&#x1F465;' : ''} ${entry.isDisciple ? '&#x1F393;' : ''}${entry.shopType ? ' &#x1F3EA;' : ''}<br>
                    <small style="color:#666;">Lvl ${entry.level} ${entry.race} ${entry.class}</small>
                    ${entry.isRelative && entry.relationship ? `<span class="relative-indicator">${entry.relationship.type} of ${entry.relativeOf.name}</span>` : ''}
                    ${entry.isGroupRelative && entry.groupRelationship ? `<span class="relative-indicator" style="background:rgba(123,94,167,0.15); color:#7b5ea7; border-color:#7b5ea7;">${entry.groupRelationship.type} — ${entry.groupRelationship.groupName}</span>` : ''}
                    ${entry.isDisciple && entry.masterOf ? `<span class="relative-indicator">Student of ${entry.masterOf.name}</span>` : ''}
                    ${entry.groupName ? `<span class="relative-indicator">${entry.groupName} &mdash; ${entry.groupRole}</span>` : ''}
                    ${entry.shopType ? `<span class="relative-indicator">${entry.shopType}</span>` : ''}
                </div>
                <div>
                    <button class="btn-mini btn-load" onclick="loadNPC('${entry.id}')">Load</button>
                    <button class="btn-mini btn-relative" onclick="generateRelativeOf('${entry.id}')" title="Generate Relative">&#x1F465;</button>
                    <button class="btn-mini btn-delete" onclick="removeSaved('${entry.id}')">&#x00D7;</button>
                </div>
            `;
        }
        list.appendChild(div);
    });
}

function generateRelativeOf(npcId) {
    const select = document.getElementById('relativeSelect');
    select.value = npcId;
    generateRelative();
}

function generateGroupRelative(groupId) {
    const vault = JSON.parse(localStorage.getItem('dm_vault') || '[]');
    const groupEntry = vault.find(n => n.id === groupId);
    
    if (!groupEntry || !groupEntry._isGroup) {
        showToast('Group not found!', 'warning');
        return;
    }
    
    const npc = createGroupRelative(groupEntry);
    
    if (generatedNPCs.length > 0) {
        _pendingGenFn = () => [npc];
        _pendingGenLabel = `${npc.groupRelationship.type}: connected to ${groupEntry.groupName}`;
        const sub = document.getElementById('genModeSubtitle');
        if (sub) sub.textContent = `You have ${generatedNPCs.length} NPC${generatedNPCs.length > 1 ? 's' : ''} on screen. What would you like to do?`;
        document.getElementById('genModeDialog').classList.add('active');
    } else {
        generatedNPCs = [npc];
        renderAllNPCs();
        showToast(`Generated ${npc.groupRelationship.type} — connected to ${groupEntry.groupName}`, 'success', 'relative');
    }
}

function generateSkills(cData, stats, prof) {
    const allSkills = [
        {name: "Acrobatics", stat: "DEX"}, {name: "Animal Handling", stat: "WIS"},
        {name: "Arcana", stat: "INT"}, {name: "Athletics", stat: "STR"},
        {name: "Deception", stat: "CHA"}, {name: "History", stat: "INT"},
        {name: "Insight", stat: "WIS"}, {name: "Intimidation", stat: "CHA"},
        {name: "Investigation", stat: "INT"}, {name: "Medicine", stat: "WIS"},
        {name: "Nature", stat: "INT"}, {name: "Perception", stat: "WIS"},
        {name: "Performance", stat: "CHA"}, {name: "Persuasion", stat: "CHA"},
        {name: "Religion", stat: "INT"}, {name: "Sleight of Hand", stat: "DEX"},
        {name: "Stealth", stat: "DEX"}, {name: "Survival", stat: "WIS"}
    ];
    const classSkills = cData.skills || [];
    return allSkills.map(skill => {
        const isProficient = classSkills.includes(skill.name);
        const mod = getMod(stats[skill.stat]) + (isProficient ? prof : 0);
        return { name: skill.name, stat: skill.stat, mod, proficient: isProficient };
    });
}

function createGroupRelative(groupEntry) {
    const isBossMode = document.getElementById('bossMode') ? document.getElementById('bossMode').checked : false;
    const relationship = pick(DB.groupRelationships);
    
    // Pick a race/class — favour the group's member makeup if available
    const members = groupEntry.members || [];
    let raceKey, classKey;
    if (members.length > 0 && Math.random() < 0.4) {
        const refMember = pick(members);
        raceKey = Math.random() < 0.6 ? refMember.race : pick(Object.keys(DB.races));
        classKey = Math.random() < 0.3 ? refMember.class : pick(Object.keys(DB.classes));
    } else {
        raceKey = pick(Object.keys(DB.races));
        classKey = pick(Object.keys(DB.classes));
    }
    
    // Level tied loosely to group's average level
    const avgLevel = members.length > 0
        ? Math.round(members.reduce((a, m) => a + (m.level || 1), 0) / members.length)
        : 5;
    let level = Math.max(1, avgLevel + (roll(6) - 4));
    if (isBossMode) level = Math.max(level, 8);
    
    const gender = Math.random() < 0.5 ? 'male' : 'female';
    const name = generateName(raceKey, null, gender);
    const rData = DB.races[raceKey];
    const cData = DB.classes[classKey];
    let prof = Math.ceil(level / 4) + 1;
    
    let stats = {};
    ['STR','DEX','CON','INT','WIS','CHA'].forEach(s => {
        stats[s] = Math.max(8, Math.min(18, roll(6) + roll(6) + roll(4)));
    });
    Object.keys(stats).forEach(k => {
        if (rData.mod.all) stats[k] += 1;
        if (rData.mod[k]) stats[k] += rData.mod[k];
    });
    
    const conMod = getMod(stats.CON);
    const dexMod = getMod(stats.DEX);
    const hpMax = (cData.hd + conMod) + ((level - 1) * (Math.floor(cData.hd/2) + 1 + conMod));
    let ac = 10 + dexMod;
    if (cData.armor.includes('Chain')) ac = 16;
    if (cData.armor.includes('Scale')) ac = 14 + Math.min(dexMod, 2);
    if (cData.armor.includes('Leather')) ac = 11 + dexMod;
    if (cData.armor.includes('Plate')) ac = 18;
    if (cData.armor === 'Unarmored') ac = 10 + dexMod + getMod(stats.CON);
    
    const attacks = generateAttacks(cData, stats, prof);
    let spellList = [], spellSlots = null;
    if (cData.spellcasting) {
        spellSlots = calculateSpellSlots(level, classKey);
        const selectedSpells = selectSpellsForClass(classKey, level, cData.spellAbility);
        const spellDC = 8 + prof + getMod(stats[cData.spellAbility]);
        spellList.push({ header: true, text: `<strong>Spell Save DC:</strong> ${spellDC} | <strong>Spell Attack:</strong> +${prof + getMod(stats[cData.spellAbility])}` });
        selectedSpells.forEach(spell => spellList.push({ name: spell.name, level: spell.level, data: spell }));
    }
    
    const inventory = generateLoot(isBossMode, level, classKey, raceKey);
    const appearance = generateAppearance(raceKey, isBossMode, classKey);
    const personality = generatePersonality(isBossMode);
    const quest = generateQuest(isBossMode);
    const ageData = generateAge(raceKey);
    const occupation = generateOccupation();
    const startingCondition = generateStartingCondition();
    
    const xpByLevel = {1:25,2:50,3:100,4:150,5:250,6:300,7:450,8:600,9:850,10:1100,
                        11:1250,12:1700,13:2100,14:2300,15:2800,16:3600,17:5000,18:6300,19:8400,20:10000};
    const baseXP = xpByLevel[Math.min(level, 20)] || 25;
    const killXP = isBossMode ? Math.floor(baseXP * 4) : baseXP;
    const questXP = isBossMode ? Math.floor(baseXP * 6) : Math.floor(baseXP * 2);
    
    // Pick a group member to reference if the relationship involves one
    const refMember = members.length > 0 ? pick(members) : null;
    const connectionDesc = refMember && Math.random() < 0.6
        ? `${relationship.connection} Specifically connected to ${refMember.name}.`
        : relationship.connection;
    
    var groupRelativeNpc = {
        id: Date.now() + Math.random().toString(36).substr(2, 9),
        name, gender, race: raceKey, class: classKey, level, prof,
        isBoss: isBossMode,
        isGroupRelative: true,
        age: ageData.age, ageCategory: ageData.category,
        occupation,
        groupRelationship: {
            type: relationship.type,
            desc: relationship.desc,
            bond: relationship.bond,
            connection: connectionDesc,
            groupName: groupEntry.groupName,
            groupId: groupEntry.id,
            referencedMember: refMember ? { name: refMember.name, class: refMember.class } : null
        },
        stats, hpMax, hpCurr: hpMax, ac,
        speed: rData.speed,
        attacks, spells: spellList, spellSlots,
        features: cData.features,
        racialTraits: rData.traits || [],
        skills: generateSkills(cData, stats, prof),
        senses: rData.senses || [],
        inventory, appearance, physicalDesc: appearance.desc, personality, quest,
        dmNotes: '', isCombat: false, initiative: null,
        conditions: startingCondition ? [startingCondition] : [],
        startingCondition, killXP, questXP
    };
    return hbApplyExtrasToBuiltNPC(groupRelativeNpc);
}

function loadNPC(id) {
    const vault = JSON.parse(localStorage.getItem('dm_vault') || '[]');
    const entry = vault.find(n => n.id === id);
    if (!entry) return;
    
    if (entry._isGroup) {
        const members = entry.members || [];
        if (generatedNPCs.length > 0) {
            const choice = confirm(`Load group "${entry.groupName}" (${members.length} NPCs)?

OK = Add alongside current NPCs on screen
Cancel = Replace current NPCs`);
            if (choice) {
                generatedNPCs = [...generatedNPCs, ...members];
            } else {
                generatedNPCs = [...members];
            }
        } else {
            generatedNPCs = [...members];
        }
        renderAllNPCs();
        showToast(`Loaded group "${entry.groupName}" (${members.length} members)`, 'success');
        return;
    }
    
    if (generatedNPCs.length > 0) {
        const existing = generatedNPCs.findIndex(n => n.id === entry.id);
        if (existing >= 0) {
            showToast(`${entry.name} is already on screen!`, 'warning');
            return;
        }
        const choice = confirm(`Load ${entry.name}?

OK = Add alongside current NPCs
Cancel = Replace current NPCs`);
        if (choice) {
            generatedNPCs.push(entry);
        } else {
            generatedNPCs = [entry];
        }
    } else {
        generatedNPCs = [entry];
    }
    renderAllNPCs();
    const special = entry.isBoss ? 'boss' : entry.isRelative ? 'relative' : '';
    showToast(`${entry.name} loaded from Saved NPCs`, 'success', special);
}

function removeSaved(id) {
    let vault = JSON.parse(localStorage.getItem('dm_vault') || '[]');
    const entry = vault.find(n => n.id === id);
    var beforeVault = JSON.parse(JSON.stringify(vault || []));
    vault = vault.filter(n => n.id !== id);
    if (!window._isOneShot) localStorage.setItem('dm_vault', JSON.stringify(vault));
    loadSavedNPCs();
    updateRelativeSelect();
    dmPushUndoAction('Remove saved NPC/group', function() {
        if (!window._isOneShot) localStorage.setItem('dm_vault', JSON.stringify(beforeVault || []));
        loadSavedNPCs();
        updateRelativeSelect();
    });
    const label = entry?._isGroup ? `Group "${entry.groupName}"` : (entry?.name || 'NPC');
    showToast(`${label} removed from Saved NPCs`);
}

function clearStorage() {
    if(confirm("WARNING: This will delete ALL saved NPCs permanently. Are you sure?")) {
        var beforeVault = localStorage.getItem('dm_vault');
        localStorage.removeItem('dm_vault');
        loadSavedNPCs();
        updateRelativeSelect();
        dmPushUndoAction('Clear saved NPC vault', function() {
            if (beforeVault == null) localStorage.removeItem('dm_vault');
            else if (!window._isOneShot) localStorage.setItem('dm_vault', beforeVault);
            loadSavedNPCs();
            updateRelativeSelect();
        });
        showToast('Saved NPCs cleared');
    }
}

function exportVault() {
    const vault = JSON.parse(localStorage.getItem('dm_vault') || "[]");
    if (vault.length === 0) {
        showToast('No NPCs to export!', 'warning');
        return;
    }
    
    const dataStr = JSON.stringify(vault, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dm-vault-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Saved NPCs exported successfully');
}

function importVault(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) throw new Error('Invalid format');
            
            let vault = JSON.parse(localStorage.getItem('dm_vault') || "[]");
            const newNPCs = imported.filter(imp => !vault.find(v => v.id === imp.id));
            vault = [...vault, ...newNPCs];
            
            if (!window._isOneShot) localStorage.setItem('dm_vault', JSON.stringify(vault));
            loadSavedNPCs();
            updateRelativeSelect();
            showToast(`Imported ${newNPCs.length} NPC${newNPCs.length !== 1 ? 's' : ''}`);
        } catch (err) {
            showToast('Invalid file format', 'warning');
        }
    };
    reader.readAsText(file);
    input.value = '';
}

/* =========================================
   UTILITY FUNCTIONS
   ========================================= */
function getNPCById(id) {
    return generatedNPCs.find(n => n.id === id);
}

function refreshNPCCard(npcId) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    
    const card = document.getElementById(`card-${npcId}`);
    if (!card) return;
    
    const isActive = card.classList.contains('active');
    const container = card.parentElement;
    card.remove();
    
    renderNPC(npc, container, isActive);
}



// ===== ENHANCED FEATURES =====

// Equipment modal
// Weapon data for item modal lookups
const WEAPON_DATA = {
    // Simple Melee
    "Club":             { damage: "1d4", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "Light, Monk", weight: "2 lb", cost: "1 sp", attackType: "Melee Weapon Attack" },
    "Dagger":           { damage: "1d4", damageType: "Piercing", range: "20/60 ft", properties: "Finesse, Light, Thrown", weight: "1 lb", cost: "2 gp", attackType: "Melee/Ranged Weapon Attack" },
    "Greatclub":        { damage: "1d8", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "Two-Handed", weight: "10 lb", cost: "2 sp", attackType: "Melee Weapon Attack" },
    "Handaxe":          { damage: "1d6", damageType: "Slashing", range: "20/60 ft", properties: "Light, Thrown", weight: "2 lb", cost: "5 gp", attackType: "Melee/Ranged Weapon Attack" },
    "Javelin":          { damage: "1d6", damageType: "Piercing", range: "30/120 ft", properties: "Thrown", weight: "2 lb", cost: "5 sp", attackType: "Melee/Ranged Weapon Attack" },
    "Light Hammer":     { damage: "1d4", damageType: "Bludgeoning", range: "20/60 ft", properties: "Light, Thrown", weight: "2 lb", cost: "2 gp", attackType: "Melee/Ranged Weapon Attack" },
    "Mace":             { damage: "1d6", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "None", weight: "4 lb", cost: "5 gp", attackType: "Melee Weapon Attack" },
    "Quarterstaff":     { damage: "1d6", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "Versatile (1d8)", weight: "4 lb", cost: "2 sp", attackType: "Melee Weapon Attack" },
    "Sickle":           { damage: "1d4", damageType: "Slashing", range: "5 ft (melee)", properties: "Light", weight: "2 lb", cost: "1 gp", attackType: "Melee Weapon Attack" },
    "Spear":            { damage: "1d6", damageType: "Piercing", range: "20/60 ft", properties: "Thrown, Versatile (1d8)", weight: "3 lb", cost: "1 gp", attackType: "Melee/Ranged Weapon Attack" },
    // Simple Ranged
    "Light Crossbow":   { damage: "1d8", damageType: "Piercing", range: "80/320 ft", properties: "Ammunition, Loading, Two-Handed", weight: "5 lb", cost: "25 gp", attackType: "Ranged Weapon Attack" },
    "Dart":             { damage: "1d4", damageType: "Piercing", range: "20/60 ft", properties: "Finesse, Thrown", weight: "0.25 lb", cost: "5 cp", attackType: "Ranged Weapon Attack" },
    "Shortbow":         { damage: "1d6", damageType: "Piercing", range: "80/320 ft", properties: "Ammunition, Two-Handed", weight: "2 lb", cost: "25 gp", attackType: "Ranged Weapon Attack" },
    "Sling":            { damage: "1d4", damageType: "Bludgeoning", range: "30/120 ft", properties: "Ammunition", weight: "—", cost: "1 sp", attackType: "Ranged Weapon Attack" },
    // Martial Melee
    "Battleaxe":        { damage: "1d8", damageType: "Slashing", range: "5 ft (melee)", properties: "Versatile (1d10)", weight: "4 lb", cost: "10 gp", attackType: "Melee Weapon Attack" },
    "Flail":            { damage: "1d8", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "None", weight: "2 lb", cost: "10 gp", attackType: "Melee Weapon Attack" },
    "Glaive":           { damage: "1d10", damageType: "Slashing", range: "10 ft (reach)", properties: "Heavy, Reach, Two-Handed", weight: "6 lb", cost: "20 gp", attackType: "Melee Weapon Attack" },
    "Greataxe":         { damage: "1d12", damageType: "Slashing", range: "5 ft (melee)", properties: "Heavy, Two-Handed", weight: "7 lb", cost: "30 gp", attackType: "Melee Weapon Attack" },
    "Greatsword":       { damage: "2d6", damageType: "Slashing", range: "5 ft (melee)", properties: "Heavy, Two-Handed", weight: "6 lb", cost: "50 gp", attackType: "Melee Weapon Attack" },
    "Halberd":          { damage: "1d10", damageType: "Slashing", range: "10 ft (reach)", properties: "Heavy, Reach, Two-Handed", weight: "6 lb", cost: "20 gp", attackType: "Melee Weapon Attack" },
    "Lance":            { damage: "1d12", damageType: "Piercing", range: "10 ft (reach)", properties: "Reach, Special (mounted)", weight: "6 lb", cost: "10 gp", attackType: "Melee Weapon Attack" },
    "Longsword":        { damage: "1d8", damageType: "Slashing", range: "5 ft (melee)", properties: "Versatile (1d10)", weight: "3 lb", cost: "15 gp", attackType: "Melee Weapon Attack" },
    "Maul":             { damage: "2d6", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "Heavy, Two-Handed", weight: "10 lb", cost: "10 gp", attackType: "Melee Weapon Attack" },
    "Morningstar":      { damage: "1d8", damageType: "Piercing", range: "5 ft (melee)", properties: "None", weight: "4 lb", cost: "15 gp", attackType: "Melee Weapon Attack" },
    "Pike":             { damage: "1d10", damageType: "Piercing", range: "10 ft (reach)", properties: "Heavy, Reach, Two-Handed", weight: "18 lb", cost: "5 gp", attackType: "Melee Weapon Attack" },
    "Rapier":           { damage: "1d8", damageType: "Piercing", range: "5 ft (melee)", properties: "Finesse", weight: "2 lb", cost: "25 gp", attackType: "Melee Weapon Attack" },
    "Scimitar":         { damage: "1d6", damageType: "Slashing", range: "5 ft (melee)", properties: "Finesse, Light", weight: "3 lb", cost: "25 gp", attackType: "Melee Weapon Attack" },
    "Shortsword":       { damage: "1d6", damageType: "Piercing", range: "5 ft (melee)", properties: "Finesse, Light", weight: "2 lb", cost: "10 gp", attackType: "Melee Weapon Attack" },
    "Trident":          { damage: "1d6", damageType: "Piercing", range: "20/60 ft", properties: "Thrown, Versatile (1d8)", weight: "4 lb", cost: "5 gp", attackType: "Melee/Ranged Weapon Attack" },
    "War Pick":         { damage: "1d8", damageType: "Piercing", range: "5 ft (melee)", properties: "None", weight: "2 lb", cost: "5 gp", attackType: "Melee Weapon Attack" },
    "Warhammer":        { damage: "1d8", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "Versatile (1d10)", weight: "2 lb", cost: "15 gp", attackType: "Melee Weapon Attack" },
    "Whip":             { damage: "1d4", damageType: "Slashing", range: "10 ft (reach)", properties: "Finesse, Reach", weight: "3 lb", cost: "2 gp", attackType: "Melee Weapon Attack" },
    // Martial Ranged
    "Blowgun":          { damage: "1", damageType: "Piercing", range: "25/100 ft", properties: "Ammunition, Loading", weight: "1 lb", cost: "10 gp", attackType: "Ranged Weapon Attack" },
    "Hand Crossbow":    { damage: "1d6", damageType: "Piercing", range: "30/120 ft", properties: "Ammunition, Light, Loading", weight: "3 lb", cost: "75 gp", attackType: "Ranged Weapon Attack" },
    "Heavy Crossbow":   { damage: "1d10", damageType: "Piercing", range: "100/400 ft", properties: "Ammunition, Heavy, Loading, Two-Handed", weight: "18 lb", cost: "50 gp", attackType: "Ranged Weapon Attack" },
    "Longbow":          { damage: "1d8", damageType: "Piercing", range: "150/600 ft", properties: "Ammunition, Heavy, Two-Handed", weight: "2 lb", cost: "50 gp", attackType: "Ranged Weapon Attack" },
    "Net":              { damage: "—", damageType: "—", range: "5/15 ft", properties: "Special, Thrown", weight: "3 lb", cost: "1 gp", attackType: "Ranged Weapon Attack", special: "Large or smaller creature is restrained (DC 10 STR to escape)" },
    // Special/Monk
    "Unarmed Strike":   { damage: "1 + STR mod", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "Always available", weight: "—", cost: "—", attackType: "Melee Weapon Attack" },
    // Multi-weapon shorthand (generated combos)
    "Dual Scimitars":   { damage: "1d6 + 1d6", damageType: "Slashing", range: "5 ft (melee)", properties: "Finesse, Light × 2, Two-Weapon Fighting", weight: "6 lb total", cost: "50 gp", attackType: "Melee Weapon Attack" },
    // Magic Weapons
    "Flame Tongue":     { damage: "1d8 + 2d6 fire", damageType: "Slashing + Fire", range: "5 ft (melee)", properties: "Versatile, Magical, Requires Attunement", weight: "3 lb", cost: "5,000 gp", attackType: "Melee Weapon Attack", special: "Command word ignites/extinguishes. Sheds bright light 40 ft while lit." },
    "Vorpal Sword":     { damage: "1d8 + 3", damageType: "Slashing", range: "5 ft (melee)", properties: "+3, Magical, Requires Attunement, Decapitate on nat 20", weight: "3 lb", cost: "50,000 gp", attackType: "Melee Weapon Attack", special: "On a natural 20 vs creature with a head, it is decapitated (immune: undead, constructs, etc.)" },
    "+1 Dagger":        { damage: "1d4 + 1", damageType: "Piercing", range: "20/60 ft", properties: "+1 magical, Finesse, Light, Thrown", weight: "1 lb", cost: "500 gp", attackType: "Melee/Ranged Weapon Attack" },
    "+1 Longsword":     { damage: "1d8 + 1", damageType: "Slashing", range: "5 ft (melee)", properties: "+1 magical, Versatile (1d10+1)", weight: "3 lb", cost: "1,000 gp", attackType: "Melee Weapon Attack" },
    "+1 Shortbow":      { damage: "1d6 + 1", damageType: "Piercing", range: "80/320 ft", properties: "+1 magical, Ammunition, Two-Handed", weight: "2 lb", cost: "800 gp", attackType: "Ranged Weapon Attack" },
    "+2 Longsword":     { damage: "1d8 + 2", damageType: "Slashing", range: "5 ft (melee)", properties: "+2 magical, Versatile (1d10+2)", weight: "3 lb", cost: "5,000 gp", attackType: "Melee Weapon Attack" },
    "+2 Greataxe":      { damage: "1d12 + 2", damageType: "Slashing", range: "5 ft (melee)", properties: "+2 magical, Heavy, Two-Handed", weight: "7 lb", cost: "6,000 gp", attackType: "Melee Weapon Attack" },
    "+3 Longsword":     { damage: "1d8 + 3", damageType: "Slashing", range: "5 ft (melee)", properties: "+3 magical, Versatile (1d10+3)", weight: "3 lb", cost: "20,000 gp", attackType: "Melee Weapon Attack" },
    "Sword of Wounding":{ damage: "1d8 + 1d4 necrotic", damageType: "Slashing + Necrotic", range: "5 ft (melee)", properties: "Magical, Requires Attunement", weight: "3 lb", cost: "8,000 gp", attackType: "Melee Weapon Attack", special: "Wounds can't heal except by magic. Once per turn on hit, target loses 1d4 HP at start of each turn until healed." },
    "Sword of Life Stealing": { damage: "1d8", damageType: "Slashing", range: "5 ft (melee)", properties: "Magical, Requires Attunement", weight: "3 lb", cost: "7,500 gp", attackType: "Melee Weapon Attack", special: "On a critical hit, target loses 3d6 HP and you gain that many temporary HP (not undead)." },
    "Sword of Sharpness": { damage: "1d8 + max weapon dice on 20", damageType: "Slashing", range: "5 ft (melee)", properties: "Magical, Requires Attunement", weight: "3 lb", cost: "40,000 gp", attackType: "Melee Weapon Attack", special: "On a 20, deal maximum weapon damage + extra 14 damage. Roll on chart for possible limb severance." },
    "Berserker Axe":    { damage: "1d12 + 1", damageType: "Slashing", range: "5 ft (melee)", properties: "+1 magical, Cursed, Requires Attunement", weight: "7 lb", cost: "5,500 gp", attackType: "Melee Weapon Attack", special: "Cursed: Must attack nearest creature when you enter combat. Remove Curse needed to unattune." },
    "Dwarven Thrower":  { damage: "1d8 + 3 (2d8+3 vs giants)", damageType: "Bludgeoning", range: "20/60 ft", properties: "+3 magical, Thrown, Returns, Dwarf only, Requires Attunement", weight: "2 lb", cost: "35,000 gp", attackType: "Melee/Ranged Weapon Attack" },
    "Oathbow":          { damage: "1d8 + 3 + 3d6 vs oath target", damageType: "Piercing", range: "150/600 ft", properties: "Magical, Requires Attunement, Sworn Oath", weight: "2 lb", cost: "35,000 gp", attackType: "Ranged Weapon Attack", special: "Swear an oath against a target: advantage on all attacks, +3d6 damage. Oath target can't hide from you." },
    "Javelin of Lightning": { damage: "1d6 + 4d6 lightning (line)", damageType: "Piercing + Lightning", range: "30/120 ft", properties: "Thrown, Magical, Recharges at dawn", weight: "2 lb", cost: "1,500 gp", attackType: "Melee/Ranged Weapon Attack", special: "When thrown, transforms into 5 ft wide, 120 ft long lightning bolt (DC 13 DEX save, 4d6 lightning)." },
    "Mace of Disruption": { damage: "1d6 + 2d6 radiant (vs undead/fiends)", damageType: "Bludgeoning + Radiant", range: "5 ft (melee)", properties: "Magical, Requires Attunement", weight: "4 lb", cost: "6,000 gp", attackType: "Melee Weapon Attack", special: "Extra 2d6 radiant vs undead/fiends. Target WIS save DC 15 or be frightened until end of next turn." },
    "Mace of Smiting":  { damage: "1d6 + 1 (1d6+1 extra vs constructs)", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "+1 magical, Extra vs Constructs", weight: "4 lb", cost: "5,000 gp", attackType: "Melee Weapon Attack", special: "Critical hit range 19-20 vs constructs. On crit vs construct, it must make DC 10 CON save or be destroyed." },
    "Mace of Terror":   { damage: "1d6", damageType: "Bludgeoning", range: "5 ft (melee)", properties: "Magical, Requires Attunement, 3 charges", weight: "4 lb", cost: "6,500 gp", attackType: "Melee Weapon Attack", special: "Action: release wave of terror (30ft). Creatures WIS save DC 15 or frightened 1 minute. Regain 1d3 charges at dawn." },
    "Scimitar of Speed":{ damage: "1d6 + 2", damageType: "Slashing", range: "5 ft (melee)", properties: "+2 magical, Finesse, Light, Bonus Action Attack, Requires Attunement", weight: "3 lb", cost: "30,000 gp", attackType: "Melee Weapon Attack", special: "Once per turn, bonus action to make an extra attack with this weapon." },
    "Nine Lives Stealer": { damage: "1d8 + 2", damageType: "Slashing", range: "5 ft (melee)", properties: "+2 magical, Requires Attunement, 9 charges", weight: "3 lb", cost: "35,000 gp", attackType: "Melee Weapon Attack", special: "On a critical hit, target CON save DC 15 or die instantly. Doesn't work on constructs, undead, or creatures without CON. 9 charges total." },
    "Defender":         { damage: "1d8 + 3", damageType: "Slashing", range: "5 ft (melee)", properties: "+3 magical, Requires Attunement", weight: "3 lb", cost: "75,000 gp", attackType: "Melee Weapon Attack", special: "Before attacking, transfer part or all of the +3 bonus to AC as a bonus action instead." },
    "Frost Brand":      { damage: "1d8 + 1d6 cold", damageType: "Slashing + Cold", range: "5 ft (melee)", properties: "Magical, Requires Attunement", weight: "3 lb", cost: "30,000 gp", attackType: "Melee Weapon Attack", special: "When you hit, deals extra 1d6 cold. Resistance to fire. Extinguishes nonmagical flames in 30ft when drawn." },
    "Dragon Slayer":    { damage: "1d8 + 1 (+3d6 vs dragons)", damageType: "Slashing", range: "5 ft (melee)", properties: "+1 magical", weight: "3 lb", cost: "6,000 gp", attackType: "Melee Weapon Attack", special: "Deals extra 3d6 damage to creatures of the dragon type." },
    "Giant Slayer":     { damage: "1d8 + 1 (+2d6 vs giants)", damageType: "Slashing", range: "5 ft (melee)", properties: "+1 magical", weight: "3 lb", cost: "5,500 gp", attackType: "Melee Weapon Attack", special: "Deals extra 2d6 damage vs giants. Giant hit must succeed DC 15 STR save or fall prone." },
    "Sun Blade":        { damage: "1d8 + 2 + 1d8 radiant vs undead", damageType: "Radiant", range: "5 ft (melee)", properties: "+2 magical, Requires Attunement, Emits sunlight 15ft", weight: "2 lb", cost: "12,000 gp", attackType: "Melee Weapon Attack", special: "Blade of pure sunlight. Extra 1d8 radiant vs undead. Sheds bright light 15ft, dim light 15ft further." },
    "Luck Blade":       { damage: "1d8 + 3", damageType: "Slashing", range: "5 ft (melee)", properties: "+3 magical, Requires Attunement, 1-3 Wish charges", weight: "3 lb", cost: "200,000 gp", attackType: "Melee Weapon Attack", special: "+1 to all saving throws while attuned. Once/day reroll any die. 1-3 Wish charges (DM determines)." },
    "Sword of Kas":     { damage: "1d8 + 3", damageType: "Slashing", range: "5 ft (melee)", properties: "+3 magical, Sentient Evil, Requires Attunement, Crit 19-20", weight: "3 lb", cost: "80,000 gp", attackType: "Melee Weapon Attack", special: "Sentient and malevolent. Crits on 19-20. Whispers murderous thoughts. +3d6 on crit. Seeks to destroy Vecna." },
    "Holy Avenger":     { damage: "1d8 + 3 + 2d10 radiant (vs fiends/undead)", damageType: "Slashing + Radiant", range: "5 ft (melee)", properties: "+3 magical, Paladin only, Requires Attunement", weight: "3 lb", cost: "75,000 gp", attackType: "Melee Weapon Attack", special: "Extra 2d10 radiant vs fiends and undead. Creates 10ft aura granting advantage on saves vs spells for you and allies." },
    "Staff of Power":   { damage: "1d6 + 2 melee", damageType: "Bludgeoning", range: "5 ft (melee) / spell range", properties: "+2 magical staff, 20 charges, Requires Attunement (spellcaster)", weight: "4 lb", cost: "40,000 gp", attackType: "Melee Weapon Attack / Spell", special: "+2 to spell attacks, AC, and saves. Spells: Cone of Cold, Fireball, Globe of Invulnerability, Hold Monster, Levitate, Lightning Bolt, Magic Missile, Ray of Enfeeblement, Wall of Force." },
    "Staff of the Magi":{ damage: "1d6 + 2 melee", damageType: "Bludgeoning", range: "5 ft / spell range", properties: "+2 magical staff, 50 charges, Spell Absorption, Requires Attunement (spellcaster)", weight: "4 lb", cost: "95,000 gp", attackType: "Melee Weapon Attack / Spell", special: "Absorbs spell levels cast at you (restores charges). Retributive Strike: smash for 16x charges force damage in 30ft (destroys staff)." },
    "Trident of Fish Command": { damage: "1d6", damageType: "Piercing", range: "20/60 ft", properties: "Thrown, Versatile (1d8), Magical, 3 charges", weight: "4 lb", cost: "1,000 gp", attackType: "Melee/Ranged Weapon Attack", special: "Action + 1 charge: cast Dominate Beast on aquatic creatures with Intelligence 2 or lower (DC 15 WIS save). Regains 1d3 charges at dawn." },
    "Thunderfury, Blessed Blade": { damage: "1d8 + 2", damageType: "Slashing + Thunder", range: "5 ft (melee)", properties: "+2 magical, Requires Attunement", weight: "3 lb", cost: "80,000 gp", attackType: "Melee Weapon Attack", special: "On hit, chain lightning to 3 nearby targets (2d8 each, DC 14 CON save for half). Thunder ripple reduces target speed by 10." },
    "Arcane Focus":     { damage: "—", damageType: "—", range: "Self (spellcasting focus)", properties: "Spellcasting Focus", weight: "1 lb", cost: "5 gp", attackType: "Spellcasting Focus", special: "Used by Warlocks, Wizards, Sorcerers as a spellcasting focus. Allows ignoring material components (not consumed)." },
    "Lute":             { damage: "—", damageType: "—", range: "Self (musical instrument)", properties: "Musical Instrument, Bardic Focus", weight: "2 lb", cost: "35 gp", attackType: "Bardic Focus", special: "Bards can use a musical instrument as a spellcasting focus." }
};

// Armor data lookup
const ARMOR_DATA = {
    // Light Armor
    "Padded Armor":         { ac: "11 + DEX", type: "Light Armor", stealth: "Disadvantage", weight: "8 lb", cost: "5 gp", strReq: "None" },
    "Leather Armor":        { ac: "11 + DEX", type: "Light Armor", stealth: "Normal", weight: "10 lb", cost: "10 gp", strReq: "None" },
    "Studded Leather":      { ac: "12 + DEX", type: "Light Armor", stealth: "Normal", weight: "13 lb", cost: "45 gp", strReq: "None" },
    "Studded Leather Armor":{ ac: "12 + DEX", type: "Light Armor", stealth: "Normal", weight: "13 lb", cost: "45 gp", strReq: "None" },
    // Medium Armor
    "Hide Armor":           { ac: "12 + DEX (max 2)", type: "Medium Armor", stealth: "Normal", weight: "12 lb", cost: "10 gp", strReq: "None" },
    "Chain Shirt":          { ac: "13 + DEX (max 2)", type: "Medium Armor", stealth: "Normal", weight: "20 lb", cost: "50 gp", strReq: "None" },
    "Scale Mail":           { ac: "14 + DEX (max 2)", type: "Medium Armor", stealth: "Disadvantage", weight: "45 lb", cost: "50 gp", strReq: "None" },
    "Breastplate":          { ac: "14 + DEX (max 2)", type: "Medium Armor", stealth: "Normal", weight: "20 lb", cost: "400 gp", strReq: "None" },
    "Half Plate":           { ac: "15 + DEX (max 2)", type: "Medium Armor", stealth: "Disadvantage", weight: "40 lb", cost: "750 gp", strReq: "None" },
    // Heavy Armor
    "Ring Mail":            { ac: "14", type: "Heavy Armor", stealth: "Disadvantage", weight: "40 lb", cost: "30 gp", strReq: "None" },
    "Chain Mail":           { ac: "16", type: "Heavy Armor", stealth: "Disadvantage", weight: "55 lb", cost: "75 gp", strReq: "STR 13" },
    "Splint Armor":         { ac: "17", type: "Heavy Armor", stealth: "Disadvantage", weight: "60 lb", cost: "200 gp", strReq: "STR 15" },
    "Plate Mail":           { ac: "18", type: "Heavy Armor", stealth: "Disadvantage", weight: "65 lb", cost: "1,500 gp", strReq: "STR 15" },
    "Plate Armor":          { ac: "18", type: "Heavy Armor", stealth: "Disadvantage", weight: "65 lb", cost: "1,500 gp", strReq: "STR 15" },
    // Shields
    "Shield":               { ac: "+2", type: "Shield", stealth: "Normal", weight: "6 lb", cost: "10 gp", strReq: "None" },
    // Magic Armor
    "Cloak of Protection":      { ac: "+1 AC & saves", type: "Wondrous Item (worn)", stealth: "Normal", weight: "1 lb", cost: "1,000 gp", strReq: "Requires Attunement" },
    "Robe of the Archmagi":     { ac: "15 + DEX", type: "Magic Robes", stealth: "Normal", weight: "4 lb", cost: "35,000 gp", strReq: "Requires Attunement (wizard/sorcerer/warlock)" },
    "Armor of Invulnerability": { ac: "18 + 1", type: "Magic Plate Armor", stealth: "Disadvantage", weight: "65 lb", cost: "180,000 gp", strReq: "STR 15, Requires Attunement" },
    "Boots of Elvenkind":       { ac: "Normal", type: "Wondrous Item (footwear)", stealth: "Advantage on Stealth", weight: "1 lb", cost: "600 gp", strReq: "None" },
    "Gauntlets of Ogre Power":  { ac: "Normal", type: "Wondrous Item (gloves)", stealth: "Normal", weight: "2 lb", cost: "1,200 gp", strReq: "Requires Attunement" },
    "Cloak of Elvenkind":       { ac: "Normal", type: "Wondrous Item (cloak)", stealth: "Advantage on Stealth", weight: "1 lb", cost: "1,200 gp", strReq: "Requires Attunement" },
    "Cloak of the Bat":         { ac: "Normal", type: "Wondrous Item (cloak)", stealth: "Advantage on Stealth", weight: "1 lb", cost: "4,500 gp", strReq: "Requires Attunement" },
    "Mithral Armor":            { ac: "Same as base armor", type: "Magic Armor (any medium or heavy)", stealth: "No disadvantage", weight: "Half base armor", cost: "4,000 gp", strReq: "Same as base armor" },
    "Adamantine Armor":         { ac: "Same as base armor", type: "Magic Armor (any medium or heavy)", stealth: "Same as base armor", weight: "Same as base armor", cost: "3,000 gp", strReq: "Same as base armor" },
    "Elven Chain":              { ac: "13 + DEX (max 2)", type: "Magic Chain Shirt", stealth: "Normal", weight: "20 lb", cost: "4,000 gp", strReq: "None (proficient without training)" },
    "Dragon Scale Mail":        { ac: "14 + DEX (max 2)", type: "Magic Scale Mail", stealth: "Disadvantage", weight: "45 lb", cost: "4,000 gp", strReq: "Requires Attunement" }
};

// Gear, tools, and adventuring equipment
const GEAR_DATA = {
    // Adventuring Gear
    "Backpack":           { weight: "5 lb", cost: "2 gp", capacity: "30 lb / 1 cubic ft", desc: "A leather pack worn on the back. Can carry 30 lb of gear or 1 cubic foot of material.", use: "Storage" },
    "Bedroll":            { weight: "7 lb", cost: "1 gp", capacity: "—", desc: "A rolled sleeping mat that provides warmth and comfort when resting outdoors. Required for quality long rests in the wild.", use: "Rest / Survival" },
    "Blanket":            { weight: "3 lb", cost: "5 sp", capacity: "—", desc: "A warm wool blanket. Provides comfort during rests and can aid against cold environments.", use: "Rest / Survival" },
    "Candle":             { weight: "—", cost: "1 cp", capacity: "—", desc: "For 1 hour, a candle sheds bright light in a 5-foot radius and dim light for another 5 feet.", use: "Light Source" },
    "Chain (10 ft)":      { weight: "10 lb", cost: "5 gp", capacity: "—", desc: "Iron chain with 10 hit points. Can be burst with a DC 20 STR check.", use: "Restraint / Utility" },
    "Chalk (1 piece)":    { weight: "—", cost: "1 cp", capacity: "—", desc: "Used to mark dungeon walls, leave messages, or draw diagrams.", use: "Utility" },
    "Climber's Kit":      { weight: "12 lb", cost: "25 gp", capacity: "—", desc: "Pitons, boot tips, gloves, and a harness. Gives you advantage on Athletics checks made to climb and prevents falling when you stop moving.", use: "Climbing" },
    "Crowbar":            { weight: "5 lb", cost: "2 gp", capacity: "—", desc: "Using a crowbar grants advantage on STR checks where the leverage from a crowbar can apply, such as forcing open doors and chests.", use: "Utility / Force" },
    "Grappling Hook":     { weight: "4 lb", cost: "2 gp", capacity: "—", desc: "A four-pronged iron hook on a rope. Used to latch onto ledges or over walls when thrown.", use: "Climbing / Utility" },
    "Hammer":             { weight: "3 lb", cost: "1 gp", capacity: "—", desc: "A sturdy iron hammer. Used for driving pitons or breaking loose objects.", use: "Utility" },
    "Healer's Kit":       { weight: "3 lb", cost: "5 gp", capacity: "10 uses", desc: "A pouch with bandages, salves, and splints. Stabilize a dying creature (0 HP) without a medicine check. 10 uses total.", use: "Medicine" },
    "Hooded Lantern":     { weight: "2 lb", cost: "5 gp", capacity: "—", desc: "Casts bright light in a 30-foot radius and dim light for another 30 feet. With hood closed: dim light in a 5-foot cone. Burns 6 hours on 1 pint of oil.", use: "Light Source" },
    "Torch":              { weight: "1 lb", cost: "1 cp", capacity: "—", desc: "Burns 1 hour, shedding bright light in a 20-foot radius and dim light for an additional 20 feet. Also usable as a weapon (1d4 fire damage).", use: "Light Source / Improvised Weapon" },
    "Lantern, Bullseye":  { weight: "2 lb", cost: "10 gp", capacity: "—", desc: "Casts bright light in a 60-foot cone and dim light for another 60 feet. Burns 6 hours per pint of oil.", use: "Light Source" },
    "Magnifying Glass":   { weight: "—", cost: "100 gp", capacity: "—", desc: "Grants advantage on checks to examine fine details. Can start fires when focused on tinder in bright sunlight.", use: "Examination / Utility" },
    "Manacles":           { weight: "6 lb", cost: "2 gp", capacity: "—", desc: "Iron shackles that bind a Small or Medium creature. Escape requires DC 20 DEX (Sleight of Hand) or DC 20 STR check. AC 19, 15 HP.", use: "Restraint" },
    "Mirror, Steel":      { weight: "0.5 lb", cost: "5 gp", capacity: "—", desc: "A polished steel hand mirror. Useful for looking around corners, signaling, and checking for reflections (e.g., avoiding basilisk gaze).", use: "Utility" },
    "Oil (flask)":        { weight: "1 lb", cost: "1 sp", capacity: "—", desc: "Can fuel a lantern for 6 hours. Thrown flask (range 20 ft) coats the target; if lit, target burns for 5 fire damage on next turn.", use: "Fuel / Improvised Weapon" },
    "Pouch":              { weight: "1 lb", cost: "5 sp", capacity: "1/5 cubic ft / 6 lb", desc: "A small leather pouch. Can hold up to 6 pounds of material or 1/5 cubic foot of material, including up to 100 coins.", use: "Storage" },
    "Quiver":             { weight: "1 lb", cost: "1 gp", capacity: "20 arrows", desc: "A leather case for holding 20 arrows or bolts. Keeps ammunition organized and easily accessible.", use: "Ammunition Storage" },
    "Rations (1 day)":    { weight: "2 lb", cost: "5 sp", capacity: "—", desc: "Dry food suitable for extended travel. Includes jerky, hardtack, dried fruit, nuts. One day's supply per unit.", use: "Food / Survival" },
    "Rope, Hempen (50 ft)":{ weight: "10 lb", cost: "1 gp", capacity: "—", desc: "Hemp rope, 50 feet long. Has 2 HP and can be burst with a DC 17 STR check.", use: "Utility / Climbing" },
    "Rope, Silk (50 ft)": { weight: "5 lb", cost: "10 gp", capacity: "—", desc: "Silken rope, 50 feet long. Lighter than hemp and easier to grip. Has 2 HP and can be burst with a DC 17 STR check.", use: "Utility / Climbing" },
    "Spyglass":           { weight: "1 lb", cost: "1,000 gp", capacity: "—", desc: "Objects viewed through a spyglass are magnified to twice their size. Useful for reconnaissance and naval navigation.", use: "Observation" },
    "Tinderbox":          { weight: "1 lb", cost: "5 sp", capacity: "—", desc: "Contains flint, steel, and tinder. Used to light fires including torches or lanterns. Takes one action to light.", use: "Fire Starting" },
    "Waterskin":          { weight: "5 lb (full)", cost: "2 sp", capacity: "4 pints water", desc: "A leather pouch for holding water. Holds 4 pints (half a gallon). An adventurer needs 1 gallon per day in normal conditions.", use: "Hydration / Survival" },
    // Mounts & Vehicles
    "Saddlebags":         { weight: "8 lb", cost: "4 gp", capacity: "2 × saddlebag", desc: "Leather bags slung over a mount's back. Each bag can hold up to 20 lb of gear.", use: "Mount Storage" },
    "Saddle, Riding":     { weight: "25 lb", cost: "10 gp", capacity: "—", desc: "A standard saddle for riding a horse or similar mount. Required for mounted combat proficiency.", use: "Mount / Riding" },
    "Saddle, Military":   { weight: "30 lb", cost: "20 gp", capacity: "—", desc: "A reinforced saddle with deeper seat. Advantage on checks to remain mounted. Required for cavalry charges.", use: "Mount / Combat Riding" },
    "Saddle, Exotic":     { weight: "40 lb", cost: "60 gp", capacity: "—", desc: "A specially crafted saddle for exotic mounts (griffons, hippogriffs, etc.). Allows riding creatures not built for saddles.", use: "Mount / Exotic Riding" },
    // Clothing
    "Belt":               { weight: "0.5 lb", cost: "1 sp", capacity: "—", desc: "A leather belt worn around the waist. Often used to hold pouches, scabbards, and tools.", use: "Clothing / Utility" },
    "Boots":              { weight: "2 lb", cost: "1 gp", capacity: "—", desc: "Sturdy leather boots. Essential for travel and protecting feet from difficult terrain.", use: "Clothing" },
    "Common Clothes":     { weight: "3 lb", cost: "5 sp", capacity: "—", desc: "Simple attire — a shift, breeches, and shoes. The everyday wear of common folk.", use: "Clothing" },
    "Fine Clothes":       { weight: "6 lb", cost: "15 gp", capacity: "—", desc: "Elegant garments befitting nobility. Advantage on Persuasion checks with high-society NPCs when worn.", use: "Clothing / Social" },
    "Traveler's Clothes": { weight: "4 lb", cost: "2 gp", capacity: "—", desc: "Practical attire designed for long journeys — sturdy cloth with pockets and road-worthy boots.", use: "Clothing / Travel" },
    "Robes":              { weight: "4 lb", cost: "1 gp", capacity: "—", desc: "Flowing robes typically worn by scholars, mages, and clergy. Provides a look of wisdom and authority.", use: "Clothing" },
    // Tools
    "Thieves' Tools":     { weight: "1 lb", cost: "25 gp", capacity: "—", desc: "A small file, lock picks, a small mirror on a metal handle, a set of narrow-bladed scissors, and a pair of pliers. Required for picking locks and disarming traps.", use: "Tool (Proficiency Required)", special: "Proficiency in Thieves' Tools required to add proficiency bonus to DEX checks for picking locks or disarming traps." },
    "Alchemist's Supplies":  { weight: "8 lb", cost: "50 gp", capacity: "—", desc: "Glassware, a burner, tweezers, and common chemicals. Used to craft potions, poisons, and alchemical items.", use: "Tool (Proficiency Required)", special: "Proficiency lets you identify potions, render monsters into alchemical reagents, and create alchemical fire, acid, and other items over a long rest." },
    "Herbalism Kit":      { weight: "3 lb", cost: "5 gp", capacity: "—", desc: "Pouches and vials holding plant materials, mortar and pestle, clippers, and leather gloves. Used to identify and apply herbs.", use: "Tool (Proficiency Required)", special: "Required to craft antitoxins and potions of healing. Proficiency adds bonus to Nature and Medicine checks related to plants and healing." },
    "Cartographer's Tools": { weight: "6 lb", cost: "15 gp", capacity: "—", desc: "Quills, ink, parchment, a pair of compasses, calipers, and rulers. Used to draw maps and navigate.", use: "Tool (Proficiency Required)" },
    "Carpenter's Tools":  { weight: "8 lb", cost: "8 gp", capacity: "—", desc: "Saws, hammers, nails, a square, a ruler, and chisels. Used to build and repair wooden structures and objects.", use: "Tool (Proficiency Required)" },
    "Leatherworker's Tools": { weight: "5 lb", cost: "5 gp", capacity: "—", desc: "Knives, awls, needles, and thread. Used to craft and repair leather goods including armor, saddlery, and clothing.", use: "Tool (Proficiency Required)" },
    "Smith's Tools":      { weight: "8 lb", cost: "20 gp", capacity: "—", desc: "Hammers, tongs, charcoal, and a small fire kit. Used to forge and repair metal objects including weapons and armor.", use: "Tool (Proficiency Required)", special: "Proficiency lets you sharpen weapons, repair armor and metal gear, and create metal objects over a long rest." },
    "Brewer's Supplies":  { weight: "9 lb", cost: "20 gp", capacity: "—", desc: "Large copper pot, fermenting jug, cloth filter, and tubing. Used to brew ales, meads, and herbal draughts.", use: "Tool (Proficiency Required)" },
    "Cook's Utensils":    { weight: "8 lb", cost: "1 gp", capacity: "—", desc: "Metal pot, skillet, ladle, and knife. Used to prepare meals. Proficiency grants advantage on checks to impress others with cuisine.", use: "Tool (Proficiency Required)" },
    "Disguise Kit":       { weight: "3 lb", cost: "25 gp", capacity: "—", desc: "Cosmetics, hair dye, small props, and a mirror. Used to create disguises and impersonate other creatures.", use: "Tool (Proficiency Required)", special: "Required to make disguises. Proficiency adds bonus to Deception and Performance checks when maintaining a disguise." },
    "Forgery Kit":        { weight: "5 lb", cost: "15 gp", capacity: "—", desc: "Multiple types of ink, a variety of papers, several quills, wax seals, and gold, silver, and copper leaf. Used to create forgeries.", use: "Tool (Proficiency Required)" },
    "Musical Instrument": { weight: "2–10 lb", cost: "2–40 gp", capacity: "—", desc: "A Bard's chosen instrument. Proficiency allows performance checks. Can serve as a spellcasting focus for Bards.", use: "Instrument / Bardic Focus", special: "Bards can use a musical instrument as a spellcasting focus." },
    "Navigator's Tools":  { weight: "2 lb", cost: "25 gp", capacity: "—", desc: "Sextant, compass, calipers, ruler, parchment, ink, and quill. Required to navigate using the stars.", use: "Tool (Proficiency Required)" },
    "Poisoner's Kit":     { weight: "2 lb", cost: "50 gp", capacity: "—", desc: "Vials, chemicals, and a mortar and pestle. Used to craft poisons and identify them.", use: "Tool (Proficiency Required)", special: "Proficiency lets you create basic poisons, apply poison without risk, and make INT checks to identify unknown poisons." },
    // Holy & Arcane
    "Holy Symbol":        { weight: "1 lb", cost: "5 gp", capacity: "—", desc: "A holy symbol worn or carried by a cleric or paladin. Acts as a spellcasting focus. Can be an amulet, embossed shield, or similar item.", use: "Spellcasting Focus", special: "Clerics and Paladins can use a holy symbol as a spellcasting focus. May be used as shield without taking a hand." },
    "Arcane Focus":       { weight: "1–4 lb", cost: "5–20 gp", capacity: "—", desc: "A crystal, orb, rod, staff, or wand used as a spellcasting focus. Allows ignoring material components (not consumed ones).", use: "Spellcasting Focus" },
    "Druidic Focus":      { weight: "2 lb", cost: "5 gp", capacity: "—", desc: "A sprig of mistletoe, totem, wooden staff, or yew wand. Used as a spellcasting focus by Druids.", use: "Spellcasting Focus" },
    "Holy Water (flask)": { weight: "1 lb", cost: "25 gp", capacity: "—", desc: "Throw (range 20 ft). Fiends and undead take 2d6 radiant damage on a hit. Also used to consecrate ground.", use: "Weapon vs Undead/Fiends" },
    "Antitoxin (vial)":   { weight: "—", cost: "50 gp", capacity: "—", desc: "A creature that drinks this vial of liquid gains advantage on saving throws against poison for 1 hour. Does not apply to constructs or undead.", use: "Consumable / Medicine" },
    // Books & Papers
    "Book":               { weight: "5 lb", cost: "25 gp", capacity: "—", desc: "A bound volume of 400 pages. May contain lore, spells, records, or other information. A wizard's spellbook holds 100 pages.", use: "Knowledge / Reference" },
    "Map":                { weight: "—", cost: "variable", capacity: "—", desc: "A drawn or printed chart of a region, dungeon, or treasure location. May reveal important locations or be worth selling to explorers.", use: "Navigation / Information" },
    "Spellbook":          { weight: "3 lb", cost: "50 gp", capacity: "100 pages", desc: "Essential for Wizards. Contains all known spells (prepared from it each day). Each spell takes 1 page per spell level. Copying a spell costs 50 gp + 2 hours per spell level.", use: "Wizard Spellbook", special: "Wizards prepare their daily spells from their spellbook. Losing it doesn't erase memorized spells but prevents preparing new ones." },
    // Gems & Valuables
    "Gem":                { weight: "—", cost: "50–5,000 gp", capacity: "—", desc: "A precious stone — ruby, sapphire, emerald, diamond, or similar. Portable wealth, also used as material components for certain spells.", use: "Currency / Material Component" },
    "Jewelry":            { weight: "—", cost: "variable", capacity: "—", desc: "A crafted ornament — rings, necklaces, brooches, or earrings. May be valuable heirlooms, enchanted items, or simply decorative.", use: "Wealth / Social" },
    // Food & Drink
    "Ale (mug)":          { weight: "—", cost: "4 cp", capacity: "—", desc: "A mug of standard tavern ale. Popular in the common folk's diet. Worth more in drought years.", use: "Food & Drink" },
    "Wine, Common (pitcher)": { weight: "—", cost: "2 sp", capacity: "—", desc: "A pitcher of basic wine. Common table drink throughout the realms.", use: "Food & Drink" },
    "Wine, Fine (bottle)":  { weight: "—", cost: "10 gp", capacity: "—", desc: "A bottle of aged, quality wine. Favored by nobility and used in gifts or bribes.", use: "Food & Drink / Social" },
    "Rations":            { weight: "2 lb", cost: "5 sp", capacity: "—", desc: "Dry food for one day: hardtack, jerky, dried fruit, and nuts. Prevents the Hungry condition during travel.", use: "Food / Survival" },
    // Scrolls - by school
    "Scroll of Magic Missile": { weight: "—", cost: "75 gp", rarity: "Common", desc: "A rolled parchment inscribed with the Magic Missile spell. When read, fires 3 darts dealing 1d4+1 force damage each. Auto-hits any target you can see.", use: "Spell Scroll", damage: "3 × (1d4+1) force", range: "120 ft", school: "Evocation", level: "1st" },
    "Scroll of Fireball":  { weight: "—", cost: "300 gp", rarity: "Rare", desc: "A scroll of the 3rd-level Fireball spell. 20-ft radius explosion at a point within 150 ft. DC 15 DEX save or take 8d6 fire damage (half on save).", use: "Spell Scroll", damage: "8d6 fire", range: "150 ft", school: "Evocation", level: "3rd", dc: "15" },
    "Scroll of Cure Wounds": { weight: "—", cost: "50 gp", rarity: "Common", desc: "A scroll containing the Cure Wounds spell (1st level). Touch a creature to restore 1d8 + spellcasting modifier HP.", use: "Spell Scroll", damage: "1d8+mod healing", range: "Touch", school: "Evocation", level: "1st" },
    "Scroll of Detect Magic": { weight: "—", cost: "60 gp", rarity: "Common", desc: "A scroll of Detect Magic. For up to 10 minutes, sense magic within 30 feet and see a faint aura around magical objects/creatures.", use: "Spell Scroll", range: "30 ft aura", school: "Divination", level: "1st" },
    "Scroll of Invisibility": { weight: "—", cost: "150 gp", rarity: "Uncommon", desc: "A scroll of Invisibility (2nd level). Target creature becomes invisible until it attacks or casts a spell (up to 1 hour).", use: "Spell Scroll", range: "Touch", school: "Illusion", level: "2nd" },
    "Scroll of Lightning Bolt": { weight: "—", cost: "300 gp", rarity: "Rare", desc: "A scroll of Lightning Bolt (3rd level). A 100-ft long, 5-ft wide bolt of lightning. DC 15 DEX save or take 8d6 lightning damage.", use: "Spell Scroll", damage: "8d6 lightning", range: "100 ft line", school: "Evocation", level: "3rd", dc: "15" },
    "Scroll of Teleportation": { weight: "—", cost: "5,000 gp", rarity: "Very Rare", desc: "A scroll of Teleport (7th level). Instantly transports you and up to 8 willing creatures to a destination you know. Risk of mishap if unfamiliar.", use: "Spell Scroll", range: "Anywhere on same plane", school: "Conjuration", level: "7th" },
    "Scroll of Wish":     { weight: "—", cost: "50,000 gp", rarity: "Legendary", desc: "The mightiest scroll in existence. When read aloud, grants any one wish within the power of a 8th-level or lower spell — or DM's discretion for greater effects. Chance of never being able to cast Wish again afterwards.", use: "Spell Scroll", range: "Unlimited", school: "Conjuration", level: "9th" },
};

// Potion data
const POTION_DATA = {
    "Potion of Healing":            { healing: "2d4+2", cost: "50 gp", rarity: "Common", weight: "0.5 lb", desc: "A magical red liquid that restores 2d4+2 HP when drunk. Smells faintly of cinnamon.", use: "Consumable / Healing" },
    "Potion of Greater Healing":    { healing: "4d4+4", cost: "150 gp", rarity: "Uncommon", weight: "0.5 lb", desc: "Restores 4d4+4 HP. A vibrant red liquid with tiny golden motes swirling inside.", use: "Consumable / Healing" },
    "Potion of Superior Healing":   { healing: "8d4+8", cost: "450 gp", rarity: "Rare", weight: "0.5 lb", desc: "Restores 8d4+8 HP. A brilliant red-gold liquid that swirls on its own.", use: "Consumable / Healing" },
    "Potion of Supreme Healing":    { healing: "10d4+20", cost: "1,350 gp", rarity: "Very Rare", weight: "0.5 lb", desc: "Restores 10d4+20 HP. A shimmering red liquid of the highest potency.", use: "Consumable / Healing" },
    "Potion of Invisibility":       { healing: "—", cost: "180 gp", rarity: "Very Rare", weight: "0.5 lb", desc: "Become invisible for up to 1 hour. Effect ends if you attack or cast a spell. The potion appears to disappear the moment you drink it.", use: "Consumable / Stealth" },
    "Potion of Speed":              { healing: "—", cost: "400 gp", rarity: "Very Rare", weight: "0.5 lb", desc: "For 1 minute: gain extra action (attack, Dash, Disengage, Hide, or Use Object), +2 AC, advantage on DEX saves, double movement speed.", use: "Consumable / Combat", special: "As the Haste spell but no concentration required." },
    "Potion of Flying":             { healing: "—", cost: "500 gp", rarity: "Very Rare", weight: "0.5 lb", desc: "Gain a flying speed equal to your walking speed for 1 hour. If the effect ends mid-air, you fall.", use: "Consumable / Movement" },
    "Potion of Fire Breath":        { healing: "—", cost: "150 gp", rarity: "Uncommon", weight: "0.5 lb", desc: "For 1 hour (or 3 uses), breathe fire: 15-ft cone, DC 13 DEX save or 4d6 fire damage (half on save).", use: "Consumable / Combat", damage: "4d6 fire (DC 13)", range: "15 ft cone" },
    "Potion of Heroism":            { healing: "—", cost: "180 gp", rarity: "Rare", weight: "0.5 lb", desc: "Gain 10 temporary HP and the Blessed condition for 1 hour (add 1d4 to attack rolls and saving throws).", use: "Consumable / Buff" },
    "Potion of Climbing":           { healing: "—", cost: "180 gp", rarity: "Common", weight: "0.5 lb", desc: "Gain a climbing speed equal to your walking speed for 1 hour. Also gain advantage on Athletics checks to climb.", use: "Consumable / Movement" },
    "Potion of Resistance":         { healing: "—", cost: "300 gp", rarity: "Uncommon", weight: "0.5 lb", desc: "Gain resistance to one type of damage (fire, cold, lightning, etc.) for 1 hour.", use: "Consumable / Defense" },
    "Potion of Poison":             { healing: "—", cost: "100 gp", rarity: "Uncommon", weight: "0.5 lb", desc: "A deceptive trap: DC 10 CON save or take 3d6 poison damage and become poisoned for 24 hours. Looks identical to a Potion of Healing.", use: "Consumable / Hazard", damage: "3d6 poison" },
    "Potion of Mind Reading":       { healing: "—", cost: "180 gp", rarity: "Rare", weight: "0.5 lb", desc: "Cast Detect Thoughts (no save) for 1 minute. Read surface thoughts of any creature within 30 feet as an action.", use: "Consumable / Divination" },
    "Potion of Growth":             { healing: "—", cost: "270 gp", rarity: "Uncommon", weight: "0.5 lb", desc: "Grow to Large size for 1d4 hours: advantage on STR checks & saves, +1d4 melee damage, and disadvantage on DEX checks. Clothing doesn't grow with you.", use: "Consumable / Utility" },
    "Potion of Water Breathing":    { healing: "—", cost: "180 gp", rarity: "Uncommon", weight: "0.5 lb", desc: "Breathe underwater for 1 hour.", use: "Consumable / Utility" },
    "Potion of Longevity":          { healing: "—", cost: "9,000 gp", rarity: "Very Rare", weight: "0.5 lb", desc: "Reduce your physical age by 1d6+6 years (minimum 13). Each subsequent potion has a cumulative 10% chance of reversing the effect.", use: "Consumable / Utility" },
    "Potion of Vitality":           { healing: "—", cost: "960 gp", rarity: "Very Rare", weight: "0.5 lb", desc: "Remove all diseases, poisons, and exhaustion. Restore all HP. Maximize HP for the next 24 hours.", use: "Consumable / Healing" },
};

function showEquipmentDetail(npcId, itemName) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    
    // Try inventory first
    let item = npc.inventory ? npc.inventory.find(i => i.name === itemName) : null;
    
    // Also try to find in attacks
    if (!item && npc.attacks) {
        const atk = npc.attacks.find(a => a.name === itemName);
        if (atk) {
            item = {
                name: atk.name,
                type: 'Weapon',
                rarity: 'common',
                desc: atk.desc || `${atk.type} weapon attack.`,
                _attackData: atk,
                dropChance: 0.5
            };
        }
    }

    // If still no item, create a stub so we can show whatever data we can find
    if (!item) {
        item = { name: itemName, type: 'Item', rarity: 'common' };
    }
    
    // Enrich from GEAR_DATA
    const gearEntry = GEAR_DATA[itemName];
    if (gearEntry) {
        item = { ...item, ...gearEntry, name: itemName,
            desc: item.desc || gearEntry.desc,
            rarity: item.rarity || 'common',
            cost: item.cost || gearEntry.cost };
        if (!item.type || item.type === 'Item') item.type = gearEntry.use || 'Gear';
    }
    
    // Enrich from POTION_DATA
    const potionEntry = POTION_DATA[itemName];
    if (potionEntry) {
        item = { ...item, ...potionEntry, name: itemName,
            desc: item.desc || potionEntry.desc,
            rarity: item.rarity || potionEntry.rarity || 'uncommon',
            cost: item.cost || potionEntry.cost };
        if (!item.type || item.type === 'Item') item.type = 'Potion';
    }

    // Enrich from SCROLL_DATA inside GEAR_DATA (already there with 'use: Spell Scroll')
    // Also check WEAPON_DATA and ARMOR_DATA for type fixes
    const wepCheck = WEAPON_DATA[itemName];
    if (wepCheck && (!item.type || item.type === 'Item')) item.type = 'Weapon';
    const armCheck = ARMOR_DATA[itemName];
    if (armCheck && (!item.type || item.type === 'Item')) item.type = 'Armor';
    
    // Search all DB item arrays for richer data
    const allDBItems = [
        ...(DB.allWeapons || []),
        ...(DB.allArmor || []),
        ...(DB.allScrolls || []),
        ...(DB.allMagicWeapons || []),
        ...(DB.miscMagicItems || []),
        ...(DB.magicItems?.common || []),
        ...(DB.magicItems?.uncommon || []),
        ...(DB.magicItems?.rare || []),
        ...(DB.magicItems?.epic || []),
        ...(DB.magicItems?.legendary || []),
        ...(DB.magicItems?.mythic || [])
    ];
    const dbItem = allDBItems.find(i => i.name === itemName);
    if (dbItem) {
        item = { ...dbItem, ...item, desc: item.desc || dbItem.desc, rarity: item.rarity || dbItem.rarity || 'common' };
    }
    
    openItemModal(item, npc);
}

function openItemModal(item, npc) {
    const rarityColors = {
        common: '#9d9d9d', uncommon: '#1eff00', rare: '#0070dd',
        'very rare': '#a335ee', epic: '#a335ee', legendary: '#ff8000', mythic: '#ff3333'
    };
    const rarityColor = rarityColors[(item.rarity||'common').toLowerCase()] || '#9d9d9d';
    
    // Pick best icon for type
    const typeStr = (item.type || 'Item').toLowerCase();
    let icon = '📦';
    if (typeStr.includes('weapon') || WEAPON_DATA[item.name]) icon = '⚔️';
    else if (typeStr.includes('armor') || typeStr.includes('shield') || ARMOR_DATA[item.name]) icon = '🛡️';
    else if (typeStr.includes('potion') || item.name.toLowerCase().includes('potion')) icon = '⚗️';
    else if (typeStr.includes('scroll') || item.name.toLowerCase().includes('scroll')) icon = '📜';
    else if (typeStr.includes('wand')) icon = '🪄';
    else if (typeStr.includes('ring')) icon = '💍';
    else if (typeStr.includes('staff')) icon = '🔮';
    else if (typeStr.includes('currency') || typeStr.includes('gold') || typeStr.includes('coin')) icon = '🪙';
    else if (typeStr.includes('gem')) icon = '💎';
    else if (typeStr.includes('book') || item.name.toLowerCase().includes('spellbook') || item.name.toLowerCase().includes('tome')) icon = '📖';
    else if (typeStr.includes('cloak') || typeStr.includes('robe')) icon = '🧥';
    else if (typeStr.includes('boot') || typeStr.includes('feet')) icon = '👢';
    else if (typeStr.includes('glove') || typeStr.includes('gauntlet')) icon = '🧤';
    else if (typeStr.includes('tool')) icon = '🔧';
    else if (typeStr.includes('holy') || item.name.toLowerCase().includes('holy')) icon = '✝️';
    else if (typeStr.includes('food') || typeStr.includes('drink') || typeStr.includes('ration')) icon = '🍺';
    else if (typeStr.includes('mount') || typeStr.includes('saddle')) icon = '🐎';
    else if (typeStr.includes('poison')) icon = '☠️';
    else if (typeStr.includes('gear') || typeStr.includes('storage') || typeStr.includes('utility')) icon = '🎒';
    else if (typeStr.includes('magic') || typeStr.includes('wondrous') || typeStr.includes('arcane')) icon = '✨';
    
    document.getElementById('itemModalRarityBar').style.background = rarityColor;
    document.getElementById('itemModalIcon').textContent = icon;
    document.getElementById('itemModalTitle').textContent = item.name;

    // Nice subtitle
    const rarityLabel = (item.rarity || 'Common').charAt(0).toUpperCase() + (item.rarity || 'common').slice(1);
    const typeLabel = item.type || (WEAPON_DATA[item.name] ? 'Weapon' : ARMOR_DATA[item.name] ? 'Armor' : 'Item');
    document.getElementById('itemModalSub').textContent = `${typeLabel} · ${rarityLabel}`;
    
    const badge = document.getElementById('itemRarityBadge');
    badge.textContent = rarityLabel.toUpperCase();
    badge.style.background = rarityColor;
    badge.style.color = ['uncommon','legendary','very rare'].includes((item.rarity||'').toLowerCase()) ? '#000' : '#fff';
    
    // Look up rich data
    const wepData = WEAPON_DATA[item.name] || (item._attackData ? {
        damage: item._attackData.dmg,
        damageType: item._attackData.dmgType || '—',
        range: item._attackData.range || '5 ft',
        attackType: item._attackData.type || 'Melee Weapon Attack',
        properties: '—'
    } : null);
    const armData = ARMOR_DATA[item.name];
    const gearEntry = GEAR_DATA[item.name];
    const potionEntry = POTION_DATA[item.name];
    // Check if it's a scroll (gear_data entries with 'Spell Scroll' use)
    const scrollEntry = gearEntry && gearEntry.use === 'Spell Scroll' ? gearEntry : null;
    
    const stats = [];
    
    // === WEAPON ===
    if (wepData) {
        stats.push({label: 'Attack Type', value: wepData.attackType, icon: '⚔️'});
        if (wepData.damage && wepData.damage !== '—') stats.push({label: 'Damage', value: `${wepData.damage} ${wepData.damageType}`, icon: '💥'});
        stats.push({label: 'Range', value: wepData.range, icon: '📏'});
        if (wepData.properties && wepData.properties !== '—') stats.push({label: 'Properties', value: wepData.properties, icon: '📋'});
        if (wepData.weight && wepData.weight !== '—') stats.push({label: 'Weight', value: wepData.weight, icon: '⚖️'});
        stats.push({label: 'Value', value: item.cost || wepData.cost || '—', icon: '🪙'});
        if (item._attackData && item._attackData.roll) stats.push({label: 'NPC Attack Bonus', value: item._attackData.roll, icon: '🎲'});
    }
    // === ARMOR ===
    else if (armData) {
        stats.push({label: 'Armor Class', value: armData.ac, icon: '🛡️'});
        stats.push({label: 'Armor Type', value: armData.type, icon: '📋'});
        stats.push({label: 'Stealth Check', value: armData.stealth, icon: '🤫'});
        stats.push({label: 'Weight', value: armData.weight, icon: '⚖️'});
        stats.push({label: 'STR Requirement', value: armData.strReq, icon: '💪'});
        stats.push({label: 'Value', value: item.cost || armData.cost, icon: '🪙'});
    }
    // === POTION ===
    else if (potionEntry) {
        if (potionEntry.healing && potionEntry.healing !== '—') stats.push({label: 'Healing', value: potionEntry.healing + ' HP', icon: '❤️'});
        if (potionEntry.damage) stats.push({label: 'Damage', value: potionEntry.damage, icon: '💥'});
        stats.push({label: 'Duration', value: '1 action to drink', icon: '⏱️'});
        stats.push({label: 'Weight', value: potionEntry.weight || '0.5 lb', icon: '⚖️'});
        stats.push({label: 'Rarity', value: potionEntry.rarity || rarityLabel, icon: '✨'});
        stats.push({label: 'Value', value: item.cost || potionEntry.cost, icon: '🪙'});
    }
    // === SCROLL ===
    else if (scrollEntry) {
        if (scrollEntry.level) stats.push({label: 'Spell Level', value: scrollEntry.level, icon: '📜'});
        if (scrollEntry.school) stats.push({label: 'School', value: scrollEntry.school, icon: '🔮'});
        if (scrollEntry.damage) stats.push({label: 'Damage', value: scrollEntry.damage, icon: '💥'});
        if (scrollEntry.range) stats.push({label: 'Range', value: scrollEntry.range, icon: '📏'});
        if (scrollEntry.dc) stats.push({label: 'Save DC', value: `DC ${scrollEntry.dc}`, icon: '🎯'});
        stats.push({label: 'Rarity', value: scrollEntry.rarity || rarityLabel, icon: '✨'});
        stats.push({label: 'Value', value: item.cost || scrollEntry.cost || '—', icon: '🪙'});
    }
    // === GEAR / TOOL ===
    else if (gearEntry) {
        if (gearEntry.use) stats.push({label: 'Use', value: gearEntry.use, icon: '🎯'});
        if (gearEntry.capacity && gearEntry.capacity !== '—') stats.push({label: 'Capacity', value: gearEntry.capacity, icon: '📦'});
        if (gearEntry.weight && gearEntry.weight !== '—') stats.push({label: 'Weight', value: gearEntry.weight, icon: '⚖️'});
        stats.push({label: 'Value', value: item.cost || gearEntry.cost, icon: '🪙'});
        if (item.dropChance !== undefined) stats.push({label: 'Drop Chance', value: `${(item.dropChance*100).toFixed(0)}%`, icon: '🎲'});
    }
    // === GENERIC FALLBACK ===
    else {
        if (item.cost) stats.push({label: 'Value', value: item.cost, icon: '🪙'});
        if (item.weight) stats.push({label: 'Weight', value: item.weight, icon: '⚖️'});
        if (typeLabel) stats.push({label: 'Category', value: typeLabel, icon: '📦'});
        if (item.dropChance !== undefined && item.dropChance < 1) stats.push({label: 'Drop Chance', value: `${(item.dropChance*100).toFixed(0)}%`, icon: '🎲'});
        if (item.dc && item.dc > 0) stats.push({label: 'DC', value: `DC ${item.dc}`, icon: '🔍'});
        // Smart-parse desc for useful stats
        if (item.desc) {
            const healMatch = item.desc.match(/(\d+d\d+[\+\d]*)\s*HP/i);
            if (healMatch) stats.push({label: 'Healing', value: healMatch[1] + ' HP', icon: '❤️'});
            const dmgMatch = item.desc.match(/(\d+d\d+[\+\d]*)\s*(fire|cold|lightning|radiant|necrotic|thunder|force|acid|poison|psychic)?\s*damage/i);
            if (dmgMatch) stats.push({label: 'Damage', value: dmgMatch[0].trim(), icon: '💥'});
            const chargeMatch = item.desc.match(/(\d+)\s*charges?/i);
            if (chargeMatch) stats.push({label: 'Charges', value: chargeMatch[1], icon: '✨'});
            const dcMatch = item.desc.match(/DC\s*(\d+)/i);
            if (dcMatch) stats.push({label: 'Save DC', value: `DC ${dcMatch[1]}`, icon: '🎯'});
        }
    }
    
    document.getElementById('itemStatGrid').innerHTML = stats.length
        ? stats.map(s => `
            <div style="display:flex; flex-direction:column; gap:3px; padding:10px; background:rgba(0,0,0,0.05); border-radius:6px; border:1px solid rgba(184,134,11,0.2);">
                <div style="font-size:0.7em; font-weight:700; color:var(--red); text-transform:uppercase; letter-spacing:0.5px; font-family:'Cinzel',serif;">${s.icon} ${s.label}</div>
                <div style="font-weight:700; color:var(--ink); font-size:0.95em;">${s.value}</div>
            </div>`).join('')
        : '';
    
    // === Description ===
    let descHTML = '';
    const mainDesc = item.desc || (wepData ? `A ${item.name.toLowerCase()} used in ${(wepData.attackType||'').toLowerCase().includes('ranged')?'ranged':'melee'} combat.` : armData ? `${armData.type} providing AC ${armData.ac}.` : '');
    if (mainDesc) {
        descHTML += `<p style="margin:0 0 10px; line-height:1.65;">${mainDesc}</p>`;
    }
    
    // Special ability callout
    const specialText = (wepData && wepData.special) || (armData && armData.special) || (gearEntry && gearEntry.special) || (potionEntry && potionEntry.special) || item.special;
    if (specialText) {
        descHTML += `<div style="margin-top:10px; padding:10px 14px; background:rgba(139,0,0,0.07); border-left:3px solid var(--red); border-radius:4px;">
            <div style="font-size:0.75em; font-weight:700; color:var(--red); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; font-family:'Cinzel',serif;">⚡ Special</div>
            <div style="font-size:0.91em; line-height:1.55;">${specialText}</div>
        </div>`;
    }

    // Currency breakdown
    if ((item.type||'').toLowerCase() === 'currency') {
        const goldAmt = parseInt(item.name) || 0;
        if (goldAmt > 0) {
            descHTML += `<div style="margin-top:8px; padding:8px 12px; background:rgba(184,134,11,0.1); border-radius:4px; font-size:0.88em;">
                💰 <strong>${goldAmt} gp</strong> = ${goldAmt * 10} sp = ${goldAmt * 100} cp
            </div>`;
        }
    }
    
    if (!descHTML) descHTML = `<p style="margin:0; color:#888; font-style:italic;">No additional description available for this item.</p>`;
    
    document.getElementById('itemDescription').innerHTML = descHTML;
    document.getElementById('itemModal').classList.add('active');
}

function closeItemModal() {
    document.getElementById('itemModal').classList.remove('active');
}

// Condition details
const CONDITION_DETAILS = {
    "Blinded": "Can't see. Auto-fail sight checks. Attacks against have advantage, your attacks have disadvantage.",
    "Charmed": "Can't attack charmer. Charmer has advantage on social checks.",
    "Deafened": "Can't hear. Auto-fail hearing checks.",
    "Frightened": "Disadvantage on checks and attacks while source in sight. Can't move closer.",
    "Grappled": "Speed becomes 0.",
    "Incapacitated": "Can't take actions or reactions.",
    "Paralyzed": "Incapacitated. Auto-fail STR/DEX saves. Attacks have advantage. Hits within 5ft are crits.",
    "Petrified": "Turned to stone. Resistance to all damage. Immune to poison/disease.",
    "Poisoned": "Disadvantage on attack rolls and ability checks.",
    "Prone": "Disadvantage on attacks. Melee attacks against you have advantage.",
    "Restrained": "Speed becomes 0. Attacks have disadvantage. Attacks against have advantage.",
    "Stunned": "Incapacitated. Auto-fail STR/DEX saves. Attacks against have advantage.",
    "Unconscious": "Incapacitated, can't move or speak. Falls prone. Auto-fail STR/DEX saves. Attacks have advantage. Hits within 5ft are crits.",
    "Exhausted (Level 1)": "Disadvantage on ability checks.",
    "Exhausted (Level 2)": "Speed halved.",
    "Exhausted (Level 3)": "Disadvantage on attack rolls and saving throws."
};

function showConditionDetail(condition, npcId) {
    const detail = CONDITION_DETAILS[condition] || "No details available.";
    if (confirm(`${condition}\n\n${detail}\n\nRemove this condition?`)) {
        removeCondition(npcId, condition);
    }
}

// Update tabs live
function updateAllNPCTabs() {
    if (!generatedNPCs || generatedNPCs.length === 0) return;
    
    generatedNPCs.forEach((npc) => {
        // Find tab by data-npcId (works with bracket grouping)
        const tab = document.querySelector(`.npc-tab[data-npc-id="${npc.id}"]`);
        if (!tab) return;

        const hpPercent = Math.round((npc.hpCurr / npc.hpMax) * 100);
        const hpColor = hpPercent > 75 ? 'var(--success)' : hpPercent > 50 ? 'var(--gold)' : hpPercent > 25 ? 'orange' : 'var(--danger)';
        
        const isLeader = npc.groupRole === "Leader" || npc.groupRole === "Master";
        if (isLeader) tab.classList.add('leader');
        
        const infoDiv = tab.querySelector('.tab-info');
        if (infoDiv) {
            infoDiv.innerHTML = `
                Lvl ${npc.level} ${npc.race} ${npc.class}
                <div style="margin-top:2px;">
                    <span style="color:${hpColor}; font-weight:700;">HP ${npc.hpCurr}/${npc.hpMax}</span>
                    <span style="font-size:0.82em; opacity:0.7;"> (${hpPercent}%)</span>
                </div>`;
        }
        
        // Update initiative badge in tab name area
        const nameDiv = tab.querySelector('.tab-name');
        if (nameDiv) {
            const existingBadge = nameDiv.querySelector('.init-tab-badge');
            if (existingBadge) existingBadge.remove();
            if (npc.initiative !== null) {
                const badge = document.createElement('span');
                badge.className = 'init-tab-badge';
                badge.style.cssText = 'background:var(--gold); color:white; padding:1px 5px; border-radius:3px; font-size:0.72em; margin-left:5px; font-weight:900;';
                badge.textContent = `⚡${npc.initiative}`;
                nameDiv.appendChild(badge);
            }
        }
    });
    
    // Render player initiative inputs and update order panel
    if (typeof _renderPartyInitInputs === 'function') _renderPartyInitInputs();
    updateInitiativeOrderPanel();
}

function updateInitiativeOrderPanel() {
    const panel = document.getElementById('initiativeOrderPanel');
    const list = document.getElementById('initiativeOrderList');
    if (!panel || !list) return;

    const party = Array.isArray(window._party) ? window._party : [];
    const npcList = Array.isArray(window.generatedNPCs) ? generatedNPCs : [];
    const playerEntries = (function() {
        const activeMap = window._playerInitActive || {};
        const stateMap = window._playerInitState || {};
        return party
            .filter(p => !!activeMap[p.id])
            .map(p => {
                const raw = stateMap[p.id];
                const roll = Number.isFinite(raw) ? raw : null;
                return {
                    type: 'player',
                    id: p.id,
                    name: p.name || 'Player',
                    cls: p.cls || '',
                    hpCurr: p.hpCurr || 0,
                    hpMax: p.hpMax || 0,
                    roll: roll
                };
            });
    })();

    const combined = npcList.map(n => ({
        type: 'npc',
        id: n.id,
        name: n.name,
        isBoss: !!n.isBoss,
        hpCurr: n.hpCurr,
        hpMax: n.hpMax,
        roll: Number.isFinite(n.initiative) ? n.initiative : null,
        npcRef: n
    })).concat(playerEntries);

    const hasEntries = combined.length >= 1;
    const hasParty = party.length >= 1;
    const shouldShowPanel = hasEntries || hasParty;

    if (!shouldShowPanel) {
        panel.classList.remove('active');
        return;
    }

    panel.classList.add('active');

    if (!hasEntries) {
        var playerNames = party.map(function(p) { return p.name || 'Player'; }).join(', ');
        var hint = party.length ? 'Enter initiative rolls above for ' + (playerNames || 'your party') + ', then click <strong>Add Players to Initiative</strong>. They will appear below in turn order (1st → last).' : 'Enter each player&apos;s initiative roll in the boxes above, then click <strong>Add Players to Initiative</strong>.';
        if (party.length && npcList.length === 0) hint += ' Generate NPCs and roll their initiative to add enemies to the order.';
        list.innerHTML = '<div style="width:100%;font-size:0.8em;color:rgba(255,255,255,0.7);padding:10px;line-height:1.6;">' + hint + '</div>';
        return;
    }

    const sorted = combined.sort((a, b) => {
        if (a.roll !== null && b.roll !== null) return b.roll - a.roll;
        if (a.roll !== null) return -1;
        if (b.roll !== null) return 1;
        return 0;
    });

    let rankCounter = 0;
    function rankLabel(n) {
        if (n === 1) return '1st';
        if (n === 2) return '2nd';
        if (n === 3) return '3rd';
        return n + 'th';
    }
    list.innerHTML = sorted.map((entry) => {
        const hasInit = entry.roll !== null;
        const rankNum = hasInit ? (++rankCounter) : 0;
        const rankValue = hasInit ? rankNum : '?';
        const rankText = hasInit ? rankLabel(rankNum) : '?';
        const isFirst = rankNum === 1;
        const isActive = entry.type === 'npc' && entry.id === activeNPCId;
        const hpMax = Math.max(1, Number(entry.hpMax || 1));
        const hpPercent = Math.round((Number(entry.hpCurr || 0) / hpMax) * 100);
        const hpColor = hpPercent > 75 ? '#2ecc71' : hpPercent > 50 ? '#f39c12' : hpPercent > 25 ? '#e67e22' : '#e74c3c';

        if (entry.type === 'player') {
            return '<div class="initiative-order-entry ' + (isFirst && hasInit ? 'first-place' : '') + '" data-player-id="' + entry.id + '" style="border-color:rgba(46,204,113,0.6);">' +
            '<div class="init-rank-badge ' + (isFirst && hasInit ? 'first' : '') + ' ' + (!hasInit ? 'pending' : '') + '" style="background:' + (hasInit ? '#27ae60' : 'rgba(80,80,80,0.6)') + ';" title="Turn ' + rankText + '">' + rankText + '</div>' +
            '<div style="flex:1;min-width:0;"><div class="init-name" style="color:#7ee8a2;">🧑 ' + entry.name + (hasInit ? ' <span style="font-weight:400;opacity:0.9;">(Init ' + entry.roll + ')</span>' : '') + '</div>' +
            '<div style="font-size:0.75em; opacity:0.7; color:' + hpColor + '; margin-top:1px; display:flex; align-items:center; gap:4px;">' + (entry.cls || 'Player') + ' · HP: ' + entry.hpCurr + '/' + entry.hpMax +
            ' <button type="button" onclick="event.stopPropagation();dmInitOrderModPlayerHP(\'' + entry.id + '\', -1)" style="padding:0 4px;font-size:0.9em;line-height:1;border-radius:3px;border:1px solid rgba(139,0,0,0.5);background:rgba(139,0,0,0.2);color:#f0a0a0;cursor:pointer;" title="-1 HP">−</button>' +
            ' <button type="button" onclick="event.stopPropagation();dmInitOrderModPlayerHP(\'' + entry.id + '\', 1)" style="padding:0 4px;font-size:0.9em;line-height:1;border-radius:3px;border:1px solid rgba(46,204,113,0.5);background:rgba(46,204,113,0.2);color:#90ff90;cursor:pointer;" title="+1 HP">+</button></div></div>' +
            '<div style="display:flex;align-items:center;gap:5px;" onclick="event.stopPropagation()" title="Edit initiative roll">' +
            '<input type="number" class="player-init-input" min="1" max="30" value="' + (hasInit ? entry.roll : '') + '" placeholder="roll" oninput="updatePlayerInitiativeRoll(\'' + entry.id + '\', this.value)" style="width:52px;">' +
            '<button onclick="removePlayerFromInitiative(\'' + entry.id + '\')" style="background:rgba(139,0,0,0.24);color:rgba(255,180,180,0.9);border:1px solid rgba(139,0,0,0.5);border-radius:4px;cursor:pointer;padding:2px 6px;font-size:0.72em;" title="Remove from order">✕</button></div></div>';
        }
        return '<div class="initiative-order-entry ' + (isFirst && hasInit ? 'first-place' : '') + ' ' + (isActive ? 'active-tab' : '') + '" onclick="switchToNPC(\'' + entry.id + '\')" title="Click to view ' + String(entry.name).replace(/"/g, '&quot;') + '">' +
            '<div class="init-rank-badge ' + (isFirst && hasInit ? 'first' : '') + ' ' + (!hasInit ? 'pending' : '') + '" title="Turn ' + rankText + '">' + rankText + '</div>' +
            '<div style="flex:1;min-width:0;"><div class="init-name">' + (entry.isBoss ? '👑 ' : '') + entry.name + (hasInit ? ' <span style="font-weight:400;opacity:0.85;">(Init ' + entry.roll + ')</span>' : '') + '</div>' +
            '<div style="font-size:0.75em; opacity:0.7; color:' + hpColor + '; margin-top:1px; display:flex; align-items:center; gap:4px;">HP: ' + entry.hpCurr + '/' + entry.hpMax +
            ' <button type="button" onclick="event.stopPropagation();if(typeof modHP===\'function\')modHP(\'' + entry.id + '\', -1)" style="padding:0 4px;font-size:0.9em;line-height:1;border-radius:3px;border:1px solid rgba(139,0,0,0.5);background:rgba(139,0,0,0.2);color:#f0a0a0;cursor:pointer;" title="-1 HP">−</button>' +
            ' <button type="button" onclick="event.stopPropagation();if(typeof modHP===\'function\')modHP(\'' + entry.id + '\', 1)" style="padding:0 4px;font-size:0.9em;line-height:1;border-radius:3px;border:1px solid rgba(46,204,113,0.5);background:rgba(46,204,113,0.2);color:#90ff90;cursor:pointer;" title="+1 HP">+</button></div></div>' +
            '<div style="display:flex;align-items:center;gap:6px;" onclick="event.stopPropagation()" title="Edit initiative roll">' +
            '<input type="number" class="player-init-input" min="1" max="40" value="' + (hasInit ? entry.roll : '') + '" placeholder="roll" oninput="updateNPCInitiativeRoll(\'' + entry.id + '\', this.value)" style="width:54px;"></div></div>';
    }).join('');
}

function updateNPCInitiativeRoll(npcId, rawValue) {
    const npc = (typeof getNPCById === 'function') ? getNPCById(npcId) : null;
    if (!npc) return;
    var val = parseInt(rawValue, 10);
    npc.initiative = Number.isFinite(val) && val > 0 ? val : null;
    if (typeof updateAllNPCTabs === 'function') updateAllNPCTabs();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
}

function dmInitOrderModPlayerHP(playerId, delta) {
    if (typeof _party === 'undefined' || !Array.isArray(_party)) return;
    var p = _party.find(function(x) { return x.id === playerId; });
    if (!p) return;
    var max = Math.max(1, parseInt(p.hpMax, 10) || 1);
    var curr = parseInt(p.hpCurr, 10) || 0;
    p.hpCurr = Math.max(0, Math.min(max, curr + delta));
    if (typeof _saveParty === 'function') _saveParty();
    if (typeof renderPartyTracker === 'function') renderPartyTracker();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
}

// Override functions to trigger tab updates
const _originalModHP = window.modHP;
window.modHP = function(id, amount) {
    _originalModHP(id, amount);
    setTimeout(() => { updateAllNPCTabs(); updateInitiativeOrderPanel(); }, 50);
};

const _originalRollInit = window.rollInit;
window.rollInit = function(id) {
    _originalRollInit(id);
    setTimeout(() => { updateAllNPCTabs(); updateInitiativeOrderPanel(); }, 50);
};

const _originalRenderAllNPCs = window.renderAllNPCs;
window.renderAllNPCs = function() {
    _originalRenderAllNPCs();
    setTimeout(() => { updateAllNPCTabs(); updateInitiativeOrderPanel(); }, 100);
};

const _originalRollAllInitiative = window.rollAllInitiative;
window.rollAllInitiative = function() {
    _originalRollAllInitiative();
    setTimeout(() => { updateAllNPCTabs(); updateInitiativeOrderPanel(); }, 100);
};

console.log("✨ D&D 5E DM Command Center Enhanced - Loaded!");
console.log("Features: Fixed spell slots, enhanced descriptions, mythic items, combat UI, NPC tabs");

// ===== WEAPON DAMAGE ROLLING =====
function rollWeaponAttack(npcId, attackIndex) {
    const npc = getNPCById(npcId);
    if (!npc || !npc.attacks[attackIndex]) return;
    
    const attack = npc.attacks[attackIndex];
    const d20Roll = Math.floor(Math.random() * 20) + 1;
    const bonusMatch = attack.roll.match(/\+(\d+)/);
    const bonus = bonusMatch ? parseInt(bonusMatch[1]) : 0;
    const total = d20Roll + bonus;
    const isCrit = d20Roll === 20;
    const isFumble = d20Roll === 1;
    if (typeof _addRollLog === 'function') _addRollLog({
        who: npc.name || 'NPC',
        type: attack.name + ' (attack)',
        result: total + (isCrit ? ' 🎯 CRIT!' : '') + (isFumble ? ' 💀 FUMBLE!' : ''),
        detail: 'd20: ' + d20Roll + ' + ' + bonus,
        isCrit: isCrit,
        isFumble: isFumble
    });
    const critText = isCrit ? ' 🎯 CRITICAL HIT!' : (isFumble ? ' 💀 FUMBLE!' : '');
    showToast(`${npc.name} - ${attack.name}\nAttack Roll: ${d20Roll} + ${bonus} = ${total}${critText}`);
}

function rollWeaponDamage(npcId, attackIndex) {
    const npc = getNPCById(npcId);
    if (!npc || !npc.attacks[attackIndex]) return;
    
    const attack = npc.attacks[attackIndex];
    const damageStr = attack.dmg;
    
    const diceMatch = damageStr.match(/(\d+)d(\d+)([+-]\d+)?/);
    if (!diceMatch) {
        showToast(`${attack.name}: ${damageStr} ${attack.dmgType}`);
        return;
    }
    
    const numDice = parseInt(diceMatch[1]);
    const diceSize = parseInt(diceMatch[2]);
    const bonus = diceMatch[3] ? parseInt(diceMatch[3]) : 0;
    
    let total = bonus;
    let rolls = [];
    for (let i = 0; i < numDice; i++) {
        const roll = Math.floor(Math.random() * diceSize) + 1;
        rolls.push(roll);
        total += roll;
    }
    
    const rollsText = `(${rolls.join(' + ')})`;
    const bonusText = bonus !== 0 ? ` ${bonus > 0 ? '+' : ''}${bonus}` : '';
    if (typeof _addRollLog === 'function') _addRollLog({
        who: npc.name || 'NPC',
        type: attack.name + ' (damage)',
        result: total + ' ' + (attack.dmgType || ''),
        detail: rollsText + bonusText
    });
    showToast(`${npc.name} - ${attack.name}\n💥 Damage: ${total} ${attack.dmgType}\n${rollsText}${bonusText}`);
}

function rollSneakAttack(npcId) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    
    const sneakDice = Math.ceil(npc.level / 2);
    let total = 0;
    let rolls = [];
    
    for (let i = 0; i < sneakDice; i++) {
        const roll = Math.floor(Math.random() * 6) + 1;
        rolls.push(roll);
        total += roll;
    }
    
    showToast(`${npc.name} - Sneak Attack\n💥 Extra Damage: ${total} (${sneakDice}d6)\nRolls: ${rolls.join(' + ')}`);
}

// ===== QUEST GENERATION =====
const QUEST_TEMPLATES = {
    fetch: [
        {name: "Retrieve the Sacred Relic", desc: "A holy artifact has been stolen from the temple. Track down the thieves and return it before the festival.", reward: "500gp + blessing", difficulty: "Medium"},
        {name: "Gather Rare Herbs", desc: "The village healer needs moonbloom flowers that only grow in the haunted forest during the full moon.", reward: "250gp + potion", difficulty: "Easy"},
        {name: "Find the Lost Heirloom", desc: "A noble's family ring was lost in the old mine. Retrieve it from whatever creatures now dwell there.", reward: "400gp + favor", difficulty: "Medium"},
        {name: "Collect Dragon Scales", desc: "An armorer needs dragon scales for a special commission. Bring back 5 scales from the wyrm's lair.", reward: "1000gp", difficulty: "Hard"}
    ],
    kill: [
        {name: "Slay the Bandit Leader", desc: "A notorious bandit captain has been terrorizing trade routes. End their reign of terror.", reward: "600gp + magic item", difficulty: "Medium"},
        {name: "Hunt the Beast", desc: "A dire wolf pack leader has been attacking livestock. Hunt it down before it claims human lives.", reward: "300gp", difficulty: "Easy"},
        {name: "Eliminate the Necromancer", desc: "A dark wizard is raising the dead in the cemetery. Stop them before an undead army rises.", reward: "800gp + spellbook", difficulty: "Hard"},
        {name: "Destroy the Aberration", desc: "A mind flayer has been abducting villagers. Destroy it and free any surviving captives.", reward: "1200gp + rare item", difficulty: "Very Hard"}
    ],
    escort: [
        {name: "Protect the Caravan", desc: "Guard a merchant caravan traveling through bandit territory to the next city.", reward: "400gp + trade goods", difficulty: "Medium"},
        {name: "Escort the Diplomat", desc: "A royal envoy needs protection on their journey to negotiate with the neighboring kingdom.", reward: "600gp + political favor", difficulty: "Medium"},
        {name: "Guide the Pilgrims", desc: "A group of pilgrims needs safe passage through monster-infested lands to reach the holy site.", reward: "350gp + blessing", difficulty: "Easy"},
        {name: "Deliver the Prisoner", desc: "Transport a dangerous criminal to the capital for trial. Expect rescue attempts.", reward: "700gp", difficulty: "Hard"}
    ],
    investigate: [
        {name: "Solve the Mystery", desc: "People in town are disappearing. Investigate and discover what's causing it before you're next.", reward: "500gp + info", difficulty: "Medium"},
        {name: "Uncover the Conspiracy", desc: "The town council is acting strange. Investigate rumors of mind control or doppelgangers.", reward: "800gp + allies", difficulty: "Hard"},
        {name: "Track the Thief", desc: "A series of impossible burglaries suggests a skilled thief or magical means. Find out who and how.", reward: "400gp + recovered goods", difficulty: "Medium"},
        {name: "Identify the Spy", desc: "Someone is leaking military secrets to the enemy. Root out the traitor before the invasion.", reward: "1000gp + military rank", difficulty: "Very Hard"}
    ],
    rescue: [
        {name: "Save the Kidnapped", desc: "Bandits have taken hostages and are demanding ransom. Rescue them before time runs out.", reward: "700gp + gratitude", difficulty: "Medium"},
        {name: "Free the Prisoners", desc: "Innocent people are held in the old fortress. Break in and free them from their captors.", reward: "600gp + allies", difficulty: "Hard"},
        {name: "Retrieve the Captive", desc: "A noble's child was taken by goblins. Find their hideout and bring them back safely.", reward: "900gp + estate access", difficulty: "Medium"},
        {name: "Escape the Dungeon", desc: "You've been captured! Find a way to escape and rescue other prisoners along the way.", reward: "Freedom + items", difficulty: "Hard"}
    ],
    explore: [
        {name: "Map the Wilderness", desc: "Chart unexplored territory beyond the frontier. Document any discoveries or dangers.", reward: "500gp + land grant", difficulty: "Medium"},
        {name: "Clear the Dungeon", desc: "An ancient ruin has been discovered. Explore it, clear out monsters, and recover any treasures.", reward: "Variable loot", difficulty: "Hard"},
        {name: "Find the Lost City", desc: "Legends speak of a civilization swallowed by the jungle. Find it and uncover its secrets.", reward: "2000gp + artifacts", difficulty: "Very Hard"},
        {name: "Survey the Ruins", desc: "A wizard needs detailed information about ancient ruins. Explore and document everything you find.", reward: "600gp + spell scroll", difficulty: "Medium"}
    ],
    protect: [
        {name: "Defend the Village", desc: "Orc raiders are coming. Help fortify the village and defend it when they attack.", reward: "800gp + hero status", difficulty: "Hard"},
        {name: "Guard the Ritual", desc: "Clerics are performing a sacred ritual that takes 3 days. Protect them from those who would disrupt it.", reward: "500gp + divine favor", difficulty: "Medium"},
        {name: "Secure the Mine", desc: "The mine is under attack by underground creatures. Seal the breaches and eliminate the threat.", reward: "700gp + mining rights", difficulty: "Hard"},
        {name: "Watch the Border", desc: "Man a remote watchtower for a month. Report any enemy movements or unusual activity.", reward: "400gp + military favor", difficulty: "Easy"}
    ]
};

function generateRandomQuest() {
    const types = Object.keys(QUEST_TEMPLATES);
    const randomType = types[Math.floor(Math.random() * types.length)];
    const quests = QUEST_TEMPLATES[randomType];
    const quest = quests[Math.floor(Math.random() * quests.length)];
    
    return {
        type: randomType,
        name: quest.name,
        description: quest.desc,
        reward: quest.reward,
        difficulty: quest.difficulty
    };
}

// ===== NPC PORTRAIT GENERATION - DUAL MODE (AI + Canvas) =====

/**
 * Build a rich, detailed image-generation prompt from all NPC data.
 * Reads race, class, gender, age, physicalDesc, clothing, armor, weapon,
 * personality traits, and boss status to build an extremely detailed prompt.
 */
// ===== AI PORTRAIT SYSTEM =====
// Auto-generates on NPC creation using Pollinations.ai Flux model
// No user buttons — just loads automatically and shows the portrait

function buildNPCPortraitPrompt(npc) {
    var gender = (npc.gender === 'male' || npc.gender === 'female') ? npc.gender : 'person';
    var race   = npc.race  || 'Human';
    var cls    = npc.class || 'Fighter';
    var isBoss = npc.isBoss || false;

    // Race core visual — written as stable descriptive text, no apostrophes in values
    var raceCore = {
        'Human':      'realistic human, natural skin tones, expressive human face, human ears, fully human appearance',
        'Elf':        'fantasy elf with long sharply pointed ears, high cheekbones, thin elegant nose, large almond-shaped eyes, slender graceful build, ethereal beauty, pale or lightly tanned skin',
        'Half-Elf':   'half-elf with slightly pointed ears, mixed human and elven features, striking eyes, graceful yet sturdy build',
        'Dwarf':      'fantasy dwarf, very short and stocky, barrel-chested, extremely thick long beard braided with metal rings, broad flat nose, deep-set eyes under heavy brows, rough weathered skin, powerful arms',
        'Halfling':   'halfling, very small stature similar to a child but adult face, round plump cheeks, large bright eyes, curly hair, warm cheerful expression, large hairy feet visible',
        'Gnome':      'gnome, tiny small stature, oversized round eyes, bulbous nose, wild spiky or fluffy hair, mischievous grin, small nimble fingers',
        'Half-Orc':   'half-orc fantasy RPG character, green-grey tinted skin, large protruding lower tusk fangs jutting up past upper lip, wide flat nose, heavy brow ridge, coarse black hair, muscular 6-foot-plus build, battle scars, red or yellow eyes, clearly non-human monstrous features, green-toned skin complexion',
        'Orc':        'fantasy DnD orc, GREEN SKIN completely covering body, DARK FOREST GREEN complexion, massive boar-like tusk fangs jutting upward from lower jaw, flat wide pig nose, enormous heavy brow ridge, sloping low forehead, burning red eyes, hulking massive body over 6 feet tall, coarse black hair, green-skinned monster, tribal war paint on GREEN SKIN, savage expression, stooped powerful posture, looks completely non-human, unmistakably an orc',
        'Tiefling':   'tiefling with small curved ram horns on forehead, solid-colored eyes with no white sclera, reddish or purple-tinted skin, sharp angular features, long thin spaded tail, slightly pointed teeth',
        'Dragonborn': 'dragonborn covered in overlapping reptilian scales, no hair whatsoever, short snout with nostrils, reptilian slit-pupil eyes, scaled neck and hands with claws, draconic facial structure',
        'Aasimar':    'aasimar with faintly luminous glowing skin, silver or gold radiant eyes, strikingly beautiful otherworldly features, faint halo or golden light around head, divine presence',
    };

    // Class visual layer — describes gear, stance, aura
    var classCore = {
        'Fighter':      'battle-scarred warrior in combat armor, confident powerful stance, weapon at ready',
        'Barbarian':    'massive heavily muscled barbarian, wild unkempt hair, tribal war paint on face and arms, barely contained savage rage in eyes, minimal armor showing off physique',
        'Paladin':      'holy warrior in gleaming sacred armor, divine light emanating subtly, righteous commanding presence, holy symbol prominently displayed',
        'Rogue':        'shadowy rogue in dark fitted leather, sharp calculating eyes, concealed daggers, hood partially up, nimble deceptive appearance',
        'Ranger':       'weathered ranger in forest leathers, keen alert eyes scanning surroundings, natural earth tones, bow or blade at hand, outdoorsman appearance',
        'Monk':         'lean toned monk in simple robes, serene focused expression, perfect posture, inner power visible in calm intense gaze',
        'Wizard':       'scholarly wizard in ornate robes, arcane focus or staff, piercing intelligent eyes, arcane runes or sigils on clothing, commanding magical presence',
        'Sorcerer':     'sorcerer with magical energy visibly crackling around hands, wild intense eyes glowing with power, dramatic robes, innate magical aura',
        'Warlock':      'warlock with unsettling eldritch aura, eyes glowing with otherworldly light, dark dramatic clothing, pact mark visible, sinister yet compelling appearance',
        'Druid':        'druid in nature-woven robes with leaves and vines as accents, earthy green and brown tones, connection to nature visible, natural wooden staff',
        'Cleric':       'cleric in sacred vestments, holy symbol worn prominently, divine radiance, devout righteous bearing, armor adorned with religious iconography',
        'Bard':         'charismatic bard in colorful theatrical clothing, charming wide smile, expressive face, musical instrument visible, performer presence',
        'Artificer':    'artificer with mechanical goggles on forehead, gadgets and tools on belt, intelligent focused gaze, steam-punk inspired leather armor with clockwork accents',
        'Blood Hunter': 'blood hunter with haunted intense eyes, ritualistic scars on arms and face, blood magic markings glowing faintly, dark leather armor stained with battle',
    };

    // Age description
    var ageDesc = 'adult';
    if (npc.ageCategory === 'Young Adult') ageDesc = 'young adult';
    else if (npc.ageCategory === 'Middle-Aged') ageDesc = 'middle-aged with visible life experience';
    else if (npc.ageCategory === 'Old') ageDesc = 'elderly with deeply lined face and grey hair';
    else if (npc.ageCategory === 'Ancient') ageDesc = 'ancient very old with white hair and profound age';

    var raceVisual  = raceCore[race]  || 'fantasy creature with distinct non-human features';
    var classVisual = classCore[cls]  || 'adventurer in appropriate gear';

    // Extract key appearance details from NPC data
    var physDesc  = (npc.physicalDesc  || '').replace(/\.$/, '');
    var clothing  = (npc.appearance && npc.appearance.clothing) ? npc.appearance.clothing : '';
    var armorDesc = (npc.appearance && npc.appearance.armor)    ? npc.appearance.armor    : '';
    var weaponDesc= (npc.appearance && npc.appearance.weapon)   ? npc.appearance.weapon   : '';

    var bossLine = isBoss ? 'legendary boss with aura of immense power and authority, dramatic epic lighting, imposing presence' : '';

    var parts = [
        'fantasy RPG character portrait',
        ageDesc + ' ' + gender + ' ' + race + ' ' + cls,
        raceVisual,
        classVisual,
        bossLine,
        physDesc,
        clothing ? ('wearing ' + clothing) : '',
        armorDesc ? ('armor: ' + armorDesc) : '',
        weaponDesc ? ('holding ' + weaponDesc) : '',
        'dramatic portrait close-up framing shoulders and face',
        'dark fantasy background with atmospheric fog',
        'cinematic dramatic lighting with rim light',
        'ultra-detailed hyper-realistic photorealistic digital painting',
        'highly detailed intricate character art',
        '8k resolution masterwork illustration by Greg Rutkowski and Artgerm',
        'intricate fine details on face costume and accessories',
        'sharp focus detailed skin texture and fabric',
        'professional fantasy art quality',
        'perfect anatomy'
    ].filter(function(s){ return s && s.trim(); }).join(', ');

    // Build race-specific negative additions
    var raceNegative = '';
    if (race === 'Orc' || race === 'Half-Orc') {
        raceNegative = 'human skin color, normal human nose, small teeth, no tusks, human-looking, human face, human appearance, pink skin, realistic human, ';
    } else if (race === 'Elf') {
        raceNegative = 'round ears, human ears, ';
    } else if (race === 'Dragonborn') {
        raceNegative = 'human face, human skin, hair, mammal features, ';
    }

    var negative = raceNegative + [
        'deformed', 'ugly', 'blurry', 'low quality', 'watermark', 'text', 'signature',
        'bad anatomy', 'extra limbs', 'extra fingers', 'missing fingers', 'fused fingers',
        'cartoon', 'anime', 'sketch', 'flat colors', 'out of frame', 'duplicate',
        'poorly drawn face', 'poorly drawn hands', 'long neck', 'unrealistic proportions'
    ].join(', ');

    return { prompt: parts, negative: negative };
}

// Called automatically when NPC is rendered - no user action needed
function generateNPCPortrait(npcId) {
    var npc = getNPCById(npcId);
    if (!npc) return;
    var area = document.getElementById('portrait-area-' + npcId);
    if (!area) return;

    // If we already generated one this session, re-display it
    if (npc._aiPortraitUrl) {
        _displayAIPortrait(area, npc._aiPortraitUrl, npc);
        return;
    }
    if (npc._portraitDataUrl) {
        _displayPortrait(area, npc._portraitDataUrl, npc);
        return;
    }

    // Show spinner immediately
    area.innerHTML = '<div class="ai-portrait-loading"><div class="ai-spinner"></div><div>Generating portrait for ' + npc.name + '...</div></div>';

    // Build prompt and fire off request
    var promptData = buildNPCPortraitPrompt(npc);

    // Stable seed from NPC id
    var seed = 0;
    var idStr = String(npc.id);
    for (var i = 0; i < idStr.length; i++) {
        seed = ((seed * 31) + idStr.charCodeAt(i)) & 0x7fffffff;
    }
    seed = seed % 99999;

    var portraitQ = (window._dmAppSettings && window._dmAppSettings.portraitQuality) || 'balanced';
    var dims = (portraitQ === 'high') ? { w: 768, h: 960 } : (portraitQ === 'low' ? { w: 384, h: 512 } : { w: 512, h: 640 });

    var imageUrl = 'https://image.pollinations.ai/prompt/' +
        encodeURIComponent(promptData.prompt) +
        '?model=flux&width=' + dims.w + '&height=' + dims.h + '&seed=' + seed +
        '&nologo=true&negative=' + encodeURIComponent(promptData.negative);

    var img = new Image();
    var timeoutHandle = setTimeout(function() {
        // Timed out — fall back to canvas
        img.onload = null;
        img.onerror = null;
        npc._portraitDataUrl = _drawPortrait(npc);
        _displayPortrait(area, npc._portraitDataUrl, npc);
    }, 45000);

    img.onload = function() {
        clearTimeout(timeoutHandle);
        npc._aiPortraitUrl = imageUrl;
        _displayAIPortrait(area, imageUrl, npc);
    };
    img.onerror = function() {
        clearTimeout(timeoutHandle);
        // Fall back to canvas portrait
        npc._portraitDataUrl = _drawPortrait(npc);
        _displayPortrait(area, npc._portraitDataUrl, npc);
    };
    img.src = imageUrl;
}

var _dmPortraitObserver = null;
function dmQueuePortraitGeneration(npcId) {
    var area = document.getElementById('portrait-area-' + npcId);
    if (!area) return;
    if (window._dmAppSettings && window._dmAppSettings.performanceMode === 'high') {
        generateNPCPortrait(npcId);
        return;
    }
    if (!('IntersectionObserver' in window)) {
        generateNPCPortrait(npcId);
        return;
    }
    if (!_dmPortraitObserver) {
        _dmPortraitObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (!entry.isIntersecting) return;
                var id = entry.target && entry.target.dataset ? entry.target.dataset.portraitNpcId : null;
                if (id) generateNPCPortrait(id);
                _dmPortraitObserver.unobserve(entry.target);
            });
        }, { rootMargin: '140px 0px' });
    }
    area.dataset.portraitNpcId = String(npcId);
    _dmPortraitObserver.observe(area);
}

function _displayAIPortrait(area, imgSrc, npc) {
    area.innerHTML = '';
    var img = document.createElement('img');
    img.src = imgSrc;
    img.className = 'portrait-ai-img';
    img.alt = npc.name + ' portrait';
    img.title = npc.name + ' — click to view full size';
    img.onclick = function() {
        var tab = window.open('', '_blank');
        tab.document.write('<!DOCTYPE html><html><head><title>' + npc.name + '</title><style>*{margin:0;padding:0;box-sizing:border-box;}body{background:#0d0d1a;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:Georgia,serif;gap:20px;}img{max-width:90vw;max-height:85vh;border-radius:10px;box-shadow:0 0 60px rgba(0,0,0,0.9);}p{color:#daa520;font-size:1.1em;letter-spacing:2px;}span{color:#aaa;font-size:0.85em;}</style></head><body><img src="' + imgSrc + '" alt="' + npc.name + '"><p>' + npc.name + '</p><span>' + npc.race + ' ' + npc.class + ' Level ' + npc.level + '</span></body></html>');
        tab.document.close();
    };
    area.appendChild(img);
}

function _displayPortrait(area, dataUrl, npc) {
    area.innerHTML = '';
    var img = document.createElement('img');
    img.src = dataUrl;
    img.className = 'portrait-canvas';
    img.alt = npc.name + ' portrait';
    img.style.cursor = 'pointer';
    img.onclick = function() {
        var tab = window.open('', '_blank');
        tab.document.write('<!DOCTYPE html><html><head><title>' + npc.name + '</title><style>*{margin:0;padding:0;box-sizing:border-box;}body{background:#1a1a2e;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:Georgia,serif;}img{max-width:90vw;max-height:90vh;border-radius:8px;box-shadow:0 0 60px rgba(0,0,0,0.8);}p{color:#b8860b;margin-top:20px;font-size:1.1em;letter-spacing:2px;}</style></head><body><img src="' + dataUrl + '" alt="' + npc.name + '"><p>' + npc.race + ' ' + npc.class + ' Level ' + npc.level + '</p></body></html>');
        tab.document.close();
    };
    area.appendChild(img);
}

function togglePortrait(npcId) {
    var area = document.getElementById('portrait-area-' + npcId);
    var btn  = document.getElementById('portrait-toggle-' + npcId);
    if (!area || !btn) return;
    if (area.style.display === 'none') {
        area.style.display = '';
        btn.textContent = 'Hide';
    } else {
        area.style.display = 'none';
        btn.textContent = 'Show';
    }
}

function uploadNPCPortrait(npcId, files) {
    if (!files || !files.length) return;
    if (typeof getNPCById !== 'function') return;
    var npc = getNPCById(npcId);
    if (!npc) return;
    var file = files[0];
    if (!file.type || !file.type.startsWith('image/')) {
        if (typeof showToast === 'function') showToast('Please choose an image file (PNG, JPG, etc.)', 'success');
        return;
    }
    var reader = new FileReader();
    reader.onload = function() {
        var dataUrl = reader.result;
        npc._portraitDataUrl = dataUrl;
        npc._aiPortraitUrl = null;
        var area = document.getElementById('portrait-area-' + npcId);
        if (area) _displayPortrait(area, dataUrl, npc);
        if (typeof showToast === 'function') showToast('Portrait updated', 'success');
    };
    reader.readAsDataURL(file);
}

function _drawPortrait(npc) {
    // ---------- SEEDED RNG (deterministic per NPC) ----------
    let _s = 0;
    const idStr = npc.id + (npc.name||'');
    for (let i = 0; i < idStr.length; i++) _s = (_s * 31 + idStr.charCodeAt(i)) >>> 0;
    function rng()  { _s = (_s * 1664525 + 1013904223) >>> 0; return _s / 4294967296; }
    function ri(a,b){ return a + Math.floor(rng() * (b - a + 1)); }
    function rp(arr){ return arr[Math.floor(rng() * arr.length)]; }
    function hex(r,g,b){ return '#'+(r<16?'0':'')+r.toString(16)+(g<16?'0':'')+g.toString(16)+(b<16?'0':'')+b.toString(16); }
    function blendHex(c1,c2,t){
        const h=s=>{const n=parseInt(s.replace('#',''),16);return[n>>16&255,n>>8&255,n&255];};
        const [r1,g1,b1]=h(c1),[r2,g2,b2]=h(c2);
        return hex(Math.round(r1+(r2-r1)*t)|0,Math.round(g1+(g2-g1)*t)|0,Math.round(b1+(b2-b1)*t)|0);
    }
    function alpha(hexc, a){ const n=parseInt(hexc.replace('#',''),16); return `rgba(${n>>16&255},${n>>8&255},${n&255},${a})`; }

    // ---------- PARSE NPC DESCRIPTION FOR SPECIFIC FEATURES ----------
    const desc = (npc.physicalDesc||'') + ' ' + (npc.appearance ? npc.appearance.base||'' : '');
    const traits = (npc.personality ? (npc.personality.traits||[]).join(' ') : '').toLowerCase();
    const hasEyepatch    = /eye.?patch|missing.*eye|left eye|right eye covered/i.test(desc);
    const hasScar        = /scar|slash|blade mark|burn|wound/i.test(desc);
    const hasTattoo      = /tattoo|marking|brand|ink/i.test(desc);
    const hasMissingFinger = /missing.*finger|lost.*finger/i.test(desc);
    const isGiantTall    = /unusually tall|towering|6'6|enormous/i.test(desc);
    const isShort        = /surprisingly short|barely 5|small for/i.test(desc);
    const isHeavy        = /barrel.chest|heavily muscled|massive build/i.test(desc);
    const hasHeterochromia = /heterochromia|different.*eye|one blue.*one/i.test(desc);
    const hasSilverHair  = /silver.white hair|silver hair|white hair/i.test(desc);
    const isAngryPersonality = /angry|aggressive|fierce|violent|cruel|ruthless|vengeful|bitter/i.test(traits);
    const isKindPersonality  = /kind|cheerful|friendly|joyful|warm|compassionate|generous/i.test(traits);
    const isSlyPersonality   = /sly|cunning|scheming|deceptive|mischievous|manipulative/i.test(traits);
    const isBrooding         = /melanchol|brooding|haunted|dark|stoic|silent/i.test(traits);

    const W = 400, H = 520;
    const canvas = document.createElement('canvas');
    const DPR = Math.min(window.devicePixelRatio || 2, 2); // up to 2× for crisp portraits
    canvas.width  = W * DPR;
    canvas.height = H * DPR;
    canvas.style.width  = W + 'px';
    canvas.style.height = H + 'px';
    const ctx = canvas.getContext('2d', { willReadFrequently: false, alpha: false });
    ctx.scale(DPR, DPR);

    // ---------- RACE CONFIGURATION ----------
    // faceW/faceH: scale multipliers for face width/height relative to base
    // jawType: 'round'|'square'|'pointed'|'wide' — overrides gender jaw if set
    // eyeShape: 'almond'|'round'|'wide'|'reptile'
    // browWeight: 1=normal, 1.5=heavy (Half-Orc/Dwarf), 0.7=fine (Elf)
    const RF = {
        Human:     {earType:'round',earMult:1.0,wide:false,small:false,snout:false,scales:false,horns:false,tusks:false,ridge:false,fangs:false,beard_chance:0.45,faceW:1.0,faceH:1.0,jawType:null,eyeShape:'round',browWeight:1.0,tail:false,stocky:false,tall:false},
        Elf:       {earType:'pointed',earMult:1.8,wide:false,small:false,snout:false,scales:false,horns:false,tusks:false,ridge:false,fangs:false,beard_chance:0.15,faceW:0.88,faceH:1.08,jawType:'pointed',eyeShape:'almond',browWeight:0.65,tail:false,stocky:false,tall:true},
        'Half-Elf':{earType:'pointed',earMult:1.3,wide:false,small:false,snout:false,scales:false,horns:false,tusks:false,ridge:false,fangs:false,beard_chance:0.3,faceW:0.94,faceH:1.04,jawType:null,eyeShape:'almond',browWeight:0.8,tail:false,stocky:false,tall:false},
        Dwarf:     {earType:'round',earMult:0.85,wide:true,small:false,snout:false,scales:false,horns:false,tusks:false,ridge:false,fangs:false,beard_chance:0.95,faceW:1.15,faceH:0.88,jawType:'square',eyeShape:'round',browWeight:1.5,tail:false,stocky:true,tall:false},
        Halfling:  {earType:'round',earMult:1.2,wide:false,small:true,snout:false,scales:false,horns:false,tusks:false,ridge:false,fangs:false,beard_chance:0.15,faceW:0.9,faceH:0.9,jawType:'round',eyeShape:'wide',browWeight:0.8,tail:false,stocky:false,tall:false},
        Gnome:     {earType:'round',earMult:1.25,wide:false,small:true,snout:false,scales:false,horns:false,tusks:false,ridge:false,fangs:false,beard_chance:0.25,bigNose:true,faceW:0.85,faceH:0.92,jawType:'round',eyeShape:'wide',browWeight:0.75,tail:false,stocky:false,tall:false},
        'Half-Orc':{earType:'round',earMult:1.15,wide:true,small:false,snout:false,scales:false,horns:false,tusks:true,ridge:true,fangs:false,beard_chance:0.55,faceW:1.12,faceH:1.0,jawType:'square',eyeShape:'round',browWeight:1.7,tail:false,stocky:true,tall:true},
        Tiefling:  {earType:'pointed',earMult:1.4,wide:false,small:false,snout:false,scales:false,horns:true,tusks:false,ridge:false,fangs:false,beard_chance:0.25,faceW:0.96,faceH:1.02,jawType:'pointed',eyeShape:'almond',browWeight:0.9,tail:true,stocky:false,tall:false},
        Dragonborn:{earType:'none',earMult:1.0,wide:true,small:false,snout:true,scales:true,horns:false,tusks:false,ridge:false,fangs:true,beard_chance:0.0,faceW:1.18,faceH:1.05,jawType:'wide',eyeShape:'reptile',browWeight:1.2,tail:false,stocky:true,tall:true},
    };
    const rf = RF[npc.race] || RF.Human;

    // ---------- SKIN PALETTES (many options per race) ----------
    const SKIN_PALETTES = {
        Human:     ['#FDDBB4','#F5CBA7','#F0C090','#E8A87C','#D4956A','#C07850','#A0522D','#8B4513','#6B3A2A','#4A2010','#3B1F0F','#F8DEC0'],
        Elf:       ['#EEE8D0','#E8DCC4','#E0D0B0','#D8C89A','#C8B080','#B89068','#A07848','#D4C8A8','#C0B090','#F4ECD8'],
        'Half-Elf':['#F5CBA7','#E8A87C','#D4956A','#C07850','#B89068','#A07848','#E8C090','#D0A878'],
        Dwarf:     ['#E8B89A','#D4956A','#C07850','#A05830','#8B3A1E','#6B2810','#B8846A','#F0C8A0'],
        Halfling:  ['#FDDBB4','#F5C89A','#E8A87C','#D4856A','#C07058','#B86050','#F0D0A8'],
        Gnome:     ['#F5D5B0','#E8C090','#D4A870','#C09060','#B07848','#A06840','#E0B880'],
        'Half-Orc':['#7DAB7D','#6B9B6B','#5A8A5A','#4A7A4A','#3A6A3A','#8B9B7A','#6A9060','#506840','#708A68'],
        Orc:       ['#4A8A2A','#3A7A1A','#2E6B10','#387030','#4E9030','#3B6B20','#2A5A10','#568A38','#446028','#305018'],
        Tiefling:  ['#C0607A','#B05070','#9A4060','#7A3050','#D080A0','#8B3060','#E0A0C0','#603050','#A04868','#C85880','#703858','#E890B0'],
        Dragonborn:['#C04020','#A03010','#D06040','#806030','#4060A0','#208040','#203080','#602080','#808080','#303030','#A08020','#60A060','#2040A0','#804020','#4080C0'],
    };

    // ---------- HAIR COLORS (40 options) ----------
    const HAIR_COLORS = [
        '#0A0A0A','#1A0A05','#2C1A0E','#3A1A06','#4A2C0A','#5A3810','#6B4218','#7A4A1A','#8B5220',
        '#9B6228','#A07030','#B08838','#C0A060','#D4B878','#E8D090','#F5E8A8','#FFFFFF','#F0F0E0',
        '#C8C8B0','#A0A098','#808880','#C0B0A0','#A89080',
        '#8B0000','#A01010','#C02020','#D04040',
        '#1A1A6B','#2A2A8B','#3A3AAB','#4A4ACB',
        '#1A6B1A','#2A8B2A','#3AAB3A',
        '#6B1A6B','#8B2A8B','#AB3AAB',
        '#B87333','#C0832B','#D09438',
        '#4B0082','#6B00A2',
    ];

    // ---------- EYE COLORS (30 options) ----------
    const EYE_COLORS = [
        '#2C1A0E','#4A2810','#6B3A18','#8B5428','#4A3028',
        '#2A4A20','#3A6A30','#4A8A40','#60A855','#1A5A2A',
        '#1A3A5A','#2A5A8A','#3A7AAA','#4A9ACA','#1A4A7A','#5AB0D8',
        '#6B4A18','#8B6A28','#A88A40','#C0A858',
        '#8B2020','#A03030','#C04040',
        '#5A3A7A','#7A5A9A','#9A7ABA','#4A2A6A',
        '#1A6A6A','#2A8A8A','#3AAAAА',
        '#C8A820','#D4B828','#E0C830',
    ];

    // Pick base attributes
    const skinPalette = SKIN_PALETTES[npc.race] || SKIN_PALETTES.Human;
    const skinColor   = hasSilverHair ? rp(skinPalette.slice(0,4)) : rp(skinPalette);
    const skinDark    = blendHex(skinColor,'#000000',0.28);
    const skinMid     = blendHex(skinColor,'#000000',0.14);
    const skinLight   = blendHex(skinColor,'#FFFFFF',0.22);
    const hairColor   = hasSilverHair ? rp(['#D0D0D0','#C8C8C8','#E0E0E0','#B8B8B8']) : rp(HAIR_COLORS);
    const hairDark    = blendHex(hairColor,'#000000',0.35);
    const eyeColorL   = rp(EYE_COLORS);
    const eyeColorR   = hasHeterochromia ? rp(EYE_COLORS.filter(e=>e!==eyeColorL)) : eyeColorL;

    // ---------- CLASS COLORS ----------
    const CC = {
        Fighter:   {p:'#6A7A8A',s:'#3A4A5A',a:'#B0B8C0',r:'#8B0000'},
        Wizard:    {p:'#3A2A6A',s:'#1A0A4A',a:'#8080EE',r:'#4040AA'},
        Rogue:     {p:'#202020',s:'#0A0A0A',a:'#8B6914',r:'#4A3A0A'},
        Cleric:    {p:'#C0A040',s:'#806820',a:'#FFD700',r:'#8B6B00'},
        Paladin:   {p:'#B0B8C8',s:'#7080A0',a:'#FFD700',r:'#8B0000'},
        Ranger:    {p:'#3A5A2A',s:'#1A3A0A',a:'#8B6914',r:'#2A4A1A'},
        Barbarian: {p:'#7A2A1A',s:'#4A1008',a:'#C04020',r:'#8B2010'},
        Bard:      {p:'#6A3A7A',s:'#3A1A4A',a:'#FF80C0',r:'#8B0050'},
        Druid:     {p:'#3A5A1A',s:'#1A3A08',a:'#80C040',r:'#2A4A08'},
        Monk:      {p:'#4A3A2A',s:'#2A1A08',a:'#C0A050',r:'#6B4020'},
        Sorcerer:  {p:'#5A1A5A',s:'#380838',a:'#FF40FF',r:'#8B008B'},
        Warlock:   {p:'#1A0A2A',s:'#050510',a:'#8040FF',r:'#4B0082'},
    };
    const cc = CC[npc.class] || CC.Fighter;

    // Gender (affects some features)
    const isFemale = (npc.gender === 'female');
    const isOld    = (npc.ageCategory||'') === 'Elder' || (npc.ageCategory||'') === 'Ancient';
    const isYoung  = (npc.ageCategory||'') === 'Young' || (npc.ageCategory||'') === 'Teen';
    const isBoss   = npc.isBoss;

    // Face proportions — driven by race faceW/faceH and gender
    const baseFW = isFemale ? 86 : 96;
    const baseFH = isFemale ? 108 : 104; // females slightly taller face (more oval)
    const FW = Math.round(baseFW * (rf.faceW || 1.0));
    const FH = Math.round(baseFH * (rf.faceH || 1.0));
    const cx = W / 2;
    const headCY = H * 0.40;
    const shoulderY = headCY + FH * 0.56 + 32;

    // Jaw type — shared between drawFace and drawFineDetails
    const jawTypeEff = rf.jawType || (isFemale ? 'pointed' : null);

    // ---------- BACKGROUNDS (25 varieties) ----------
    const BG_VARIANTS = [
        {n:'Tavern',      c:['#3A1A08','#5A3018','#6A4028'],type:'warm'},
        {n:'Night Sky',   c:['#040812','#0A1428','#060E20'],type:'cold'},
        {n:'Deep Forest', c:['#0A1A0A','#183018','#0A2010'],type:'nature'},
        {n:'Dungeon',     c:['#1A0A2A','#2A1040','#100820'],type:'dark'},
        {n:'Castle Hall', c:['#1A2030','#2A3050','#101828'],type:'cold'},
        {n:'Hellscape',   c:['#2A0800','#4A1000','#1A0400'],type:'fire'},
        {n:'Arcane Vault',c:['#08080A','#101020','#060618'],type:'magic'},
        {n:'Coastal Fog', c:['#182028','#283848','#101820'],type:'cold'},
        {n:'Desert Ruin', c:['#3A2808','#5A4018','#281808'],type:'warm'},
        {n:'Swamp',       c:['#0A1808','#182808','#081008'],type:'nature'},
        {n:'Throne Room', c:['#1A0808','#2A1010','#100404'],type:'warm'},
        {n:'Temple',      c:['#181820','#282830','#101018'],type:'cold'},
        {n:'Wilderness',  c:['#101808','#202810','#081008'],type:'nature'},
        {n:'Void',        c:['#000000','#060606','#030303'],type:'dark'},
        {n:'Mountain',    c:['#182028','#283040','#101820'],type:'cold'},
        {n:'Necropolis',  c:['#0A0A14','#141420','#060610'],type:'dark'},
        {n:'Thieves Guild',c:['#0A0A08','#141410','#060604'],type:'dark'},
        {n:'Market',      c:['#2A1808','#3A2810','#1A1004'],type:'warm'},
        {n:'Magical Ruin',c:['#100818','#180A28','#080614'],type:'magic'},
        {n:'Arena',       c:['#1A0808','#281010','#0E0404'],type:'fire'},
        {n:'Library',     c:['#100808','#181010','#080404'],type:'warm'},
        {n:'Underdark',   c:['#04040A','#08080E','#020206'],type:'dark'},
        {n:'Fae Realm',   c:['#0A1020','#101828','#060C18'],type:'magic'},
        {n:'Battlefield', c:['#201408','#301C0A','#140C04'],type:'warm'},
        {n:'Mage Tower',  c:['#080814','#0A0A20','#040408'],type:'magic'},
    ];
    const bg = rp(BG_VARIANTS);

    // ---------- DRAW BACKGROUND ----------
    const bgG = ctx.createRadialGradient(cx, H*0.38, 40, cx, H*0.5, H*0.85);
    bgG.addColorStop(0, bg.c[1]);
    bgG.addColorStop(0.55, bg.c[0]);
    bgG.addColorStop(1, bg.c[2]);
    ctx.fillStyle = bgG;
    ctx.fillRect(0, 0, W, H);

    // BG atmospheric glow
    if (bg.type === 'magic' || bg.type === 'fire') {
        const aG = ctx.createRadialGradient(cx, headCY, 20, cx, headCY, 200);
        aG.addColorStop(0, bg.type==='magic' ? 'rgba(80,40,160,0.18)' : 'rgba(200,60,10,0.14)');
        aG.addColorStop(1, 'transparent');
        ctx.fillStyle = aG; ctx.fillRect(0, 0, W, H);
    }

    // Boss dramatic aura
    if (isBoss) {
        for (let i = 0; i < 3; i++) {
            const r = 120 + i * 50;
            const aG = ctx.createRadialGradient(cx, headCY, r * 0.2, cx, headCY, r);
            aG.addColorStop(0, alpha(cc.a, 0.12 - i * 0.03));
            aG.addColorStop(1, 'transparent');
            ctx.fillStyle = aG; ctx.fillRect(0, 0, W, H);
        }
    }

    // BG texture grain
    ctx.globalAlpha = 0.03;
    for (let i = 0; i < 350; i++) {
        ctx.fillStyle = rng() > 0.5 ? '#FFF' : '#000';
        ctx.fillRect(ri(0, W), ri(0, H), ri(1, 3), ri(1, 3));
    }
    ctx.globalAlpha = 1;

    // ---------- SHOULDERS / BODY ----------
    function drawBody() {
        const bw = rf.stocky ? (isFemale ? 190 : 215) : rf.small ? 135 : rf.tall ? (isFemale ? 175 : 200) : (isFemale ? 165 : 188);
        const neckW = rf.stocky ? (isFemale ? 28 : 38) : rf.small ? 20 : (isFemale ? 23 : 30);

        const neckH = 50;
        const neckY = headCY + FH * 0.44;
        const shY = shoulderY;
        const armorDesc = (npc.appearance ? npc.appearance.armor : '') || '';
        const cls = npc.class || 'Fighter';

        // ── Neck ──
        const nSh = ctx.createLinearGradient(cx - neckW, neckY, cx + neckW, neckY + neckH);
        nSh.addColorStop(0, skinDark); nSh.addColorStop(0.5, skinColor); nSh.addColorStop(1, skinMid);
        ctx.fillStyle = nSh;
        ctx.beginPath(); ctx.roundRect(cx - neckW/2, neckY, neckW, neckH, 4); ctx.fill();
        const nHL = ctx.createLinearGradient(cx - 6, neckY, cx + 6, neckY + neckH);
        nHL.addColorStop(0, alpha(skinLight, 0.4)); nHL.addColorStop(1, 'transparent');
        ctx.fillStyle = nHL;
        ctx.beginPath(); ctx.roundRect(cx - 5, neckY + 4, 10, neckH - 8, 3); ctx.fill();

        // ─── HELPER: draw main torso silhouette ───
        function torsoPath(lx, rx) {
            ctx.beginPath();
            ctx.moveTo(lx, H + 10);
            ctx.lineTo(lx, shY + 20);
            ctx.quadraticCurveTo(lx, shY - 10, lx + 36, shY - 20);
            ctx.lineTo(cx - neckW/2 - 4, shY - 8);
            ctx.lineTo(cx + neckW/2 + 4, shY - 8);
            ctx.lineTo(rx - 36, shY - 20);
            ctx.quadraticCurveTo(rx, shY - 10, rx, shY + 20);
            ctx.lineTo(rx, H + 10);
            ctx.closePath();
        }

        // ─── Plate Armor (Fighter, Paladin if plate) ───
        if (/plate/i.test(armorDesc) || cls === 'Fighter' || cls === 'Paladin') {
            const metalBase = cls === 'Paladin' ? '#B8C8D8' : '#7A8898';
            const metalShine = cls === 'Paladin' ? '#E8F0F8' : '#A8B8C0';
            const metalDark = cls === 'Paladin' ? '#506070' : '#3A4A56';
            const trimColor = cc.a;

            // Main plate body
            const plateG = ctx.createLinearGradient(cx - bw/2, shY - 20, cx + bw/2, H);
            plateG.addColorStop(0, metalShine);
            plateG.addColorStop(0.2, metalBase);
            plateG.addColorStop(0.7, metalDark);
            plateG.addColorStop(1, blendHex(metalDark, '#000', 0.3));
            ctx.fillStyle = plateG;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.fill();

            // Breastplate centre panel
            const bpG = ctx.createLinearGradient(cx - 32, shY, cx + 32, shY + 80);
            bpG.addColorStop(0, metalShine);
            bpG.addColorStop(0.5, metalBase);
            bpG.addColorStop(1, metalDark);
            ctx.fillStyle = bpG;
            ctx.beginPath();
            ctx.moveTo(cx - 30, shY - 8);
            ctx.lineTo(cx + 30, shY - 8);
            ctx.lineTo(cx + 38, shY + 80);
            ctx.lineTo(cx - 38, shY + 80);
            ctx.closePath(); ctx.fill();

            // Pauldron shoulder plates
            [[cx - bw/2 + 10, -1],[cx + bw/2 - 10, 1]].forEach(([px, side]) => {
                const pG = ctx.createRadialGradient(px, shY - 18, 2, px, shY - 18, 36);
                pG.addColorStop(0, metalShine);
                pG.addColorStop(0.5, metalBase);
                pG.addColorStop(1, metalDark);
                ctx.fillStyle = pG;
                ctx.beginPath();
                ctx.ellipse(px, shY - 18, 34, 22, side * 0.2, 0, Math.PI * 2);
                ctx.fill();
                // Pauldron rim
                ctx.strokeStyle = alpha(trimColor, 0.8); ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(px, shY - 18, 34, 22, side * 0.2, 0, Math.PI * 2);
                ctx.stroke();
                // Rivets
                for (let r = 0; r < 4; r++) {
                    const rx2 = px + side * (8 + r * 7);
                    const ry2 = shY - 18 + ri(-8, 4);
                    ctx.fillStyle = alpha(metalShine, 0.9);
                    ctx.beginPath(); ctx.arc(rx2, ry2, 2.5, 0, Math.PI*2); ctx.fill();
                }
            });

            // Gorget (neck guard)
            ctx.fillStyle = metalBase;
            ctx.beginPath();
            ctx.moveTo(cx - neckW/2 - 10, shY - 8);
            ctx.lineTo(cx + neckW/2 + 10, shY - 8);
            ctx.lineTo(cx + neckW/2 + 4, shY - 22);
            ctx.lineTo(cx - neckW/2 - 4, shY - 22);
            ctx.closePath(); ctx.fill();

            // Plate vertical seams
            ctx.strokeStyle = alpha(metalDark, 0.7); ctx.lineWidth = 1.5;
            [cx - 28, cx, cx + 28].forEach(sx => {
                ctx.beginPath(); ctx.moveTo(sx, shY - 5); ctx.lineTo(sx, shY + 75); ctx.stroke();
            });
            // Horizontal breastplate bands
            [shY + 30, shY + 58].forEach(by => {
                ctx.strokeStyle = alpha(metalDark, 0.5); ctx.lineWidth = 1.5;
                ctx.beginPath(); ctx.moveTo(cx - 36, by); ctx.lineTo(cx + 36, by); ctx.stroke();
            });

            // Trim / gold edging
            ctx.strokeStyle = alpha(trimColor, 0.85); ctx.lineWidth = 2.5;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.stroke();

            // Paladin holy symbol
            if (cls === 'Paladin') {
                const sy2 = shY + 15;
                ctx.strokeStyle = alpha(cc.a, 1.0); ctx.lineWidth = 3;
                ctx.beginPath(); ctx.moveTo(cx, sy2 - 14); ctx.lineTo(cx, sy2 + 14); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx - 10, sy2 - 4); ctx.lineTo(cx + 10, sy2 - 4); ctx.stroke();
                ctx.fillStyle = alpha(cc.a, 0.25);
                ctx.beginPath(); ctx.arc(cx, sy2, 18, 0, Math.PI*2); ctx.fill();
            }

            // Overall shine gradient overlay
            const shineG = ctx.createLinearGradient(cx - bw/2, shY - 20, cx, shY + 10);
            shineG.addColorStop(0, alpha('#FFFFFF', 0.18));
            shineG.addColorStop(1, 'transparent');
            ctx.fillStyle = shineG;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.fill();
        }

        // ─── Chain/Scale Mail (Fighter variants, Ranger, Cleric) ───
        else if (/chain|scale/i.test(armorDesc) || cls === 'Cleric') {
            const mailBase = cls === 'Cleric' ? '#C0A840' : '#5A6A78';
            const mailDark = blendHex(mailBase, '#000', 0.35);
            const mailLight = blendHex(mailBase, '#FFF', 0.25);

            // Base torso
            const mailG = ctx.createLinearGradient(cx - bw/2, shY - 20, cx, H);
            mailG.addColorStop(0, mailLight);
            mailG.addColorStop(0.3, mailBase);
            mailG.addColorStop(1, mailDark);
            ctx.fillStyle = mailG;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.fill();

            // Chain link texture grid
            ctx.strokeStyle = alpha(mailDark, 0.35); ctx.lineWidth = 0.8;
            for (let gy = shY - 10; gy < H + 10; gy += 6) {
                for (let gx2 = cx - bw/2; gx2 < cx + bw/2; gx2 += 8) {
                    const off = ((gy / 6) % 2) * 4;
                    ctx.beginPath();
                    ctx.ellipse(gx2 + off, gy, 3.5, 2, 0, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }

            if (/scale/i.test(armorDesc)) {
                // Scale overlapping plates
                ctx.strokeStyle = alpha(mailDark, 0.4); ctx.lineWidth = 1;
                for (let sy2 = shY; sy2 < H + 10; sy2 += 12) {
                    const row = (sy2 - shY) / 12;
                    for (let sx = cx - bw/2 + (row % 2 ? 0 : 7); sx < cx + bw/2; sx += 14) {
                        ctx.fillStyle = alpha(blendHex(mailBase, '#FFF', 0.1), 0.7);
                        ctx.beginPath();
                        ctx.moveTo(sx, sy2);
                        ctx.lineTo(sx + 12, sy2);
                        ctx.lineTo(sx + 10, sy2 + 12);
                        ctx.lineTo(sx + 2, sy2 + 12);
                        ctx.closePath();
                        ctx.fill(); ctx.stroke();
                    }
                }
            }

            // Shoulder guards
            [[cx - bw/2 + 14, -1],[cx + bw/2 - 14, 1]].forEach(([px, side]) => {
                ctx.fillStyle = mailBase;
                ctx.beginPath();
                ctx.ellipse(px, shY - 14, 28, 18, side * 0.15, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = alpha(mailDark, 0.6); ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.ellipse(px, shY - 14, 28, 18, side * 0.15, 0, Math.PI * 2);
                ctx.stroke();
            });

            // Cleric surcoat / tabard over mail
            if (cls === 'Cleric') {
                ctx.fillStyle = alpha(cc.p, 0.75);
                ctx.beginPath();
                ctx.moveTo(cx - 30, shY - 8);
                ctx.lineTo(cx + 30, shY - 8);
                ctx.lineTo(cx + 44, H + 10);
                ctx.lineTo(cx - 44, H + 10);
                ctx.closePath(); ctx.fill();

                // Clerical cross on tabard
                ctx.strokeStyle = alpha(cc.a, 1.0); ctx.lineWidth = 3.5;
                ctx.beginPath(); ctx.moveTo(cx, shY + 8); ctx.lineTo(cx, shY + 50); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx - 15, shY + 25); ctx.lineTo(cx + 15, shY + 25); ctx.stroke();
                ctx.fillStyle = alpha(cc.a, 0.2);
                ctx.beginPath(); ctx.arc(cx, shY + 28, 22, 0, Math.PI*2); ctx.fill();
            }

            // Trim
            ctx.strokeStyle = alpha(cc.a, 0.7); ctx.lineWidth = 2;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.stroke();
        }

        // ─── Leather Armor (Rogue, Ranger-leather, Fighter-leather) ───
        else if (/leather/i.test(armorDesc) || cls === 'Rogue' || cls === 'Ranger') {
            const lBase = cls === 'Rogue' ? '#1A1A1A' : '#5A3A18';
            const lMid  = blendHex(lBase, '#FFF', 0.18);
            const lDark = blendHex(lBase, '#000', 0.3);

            // Main leather body
            const lG = ctx.createLinearGradient(cx - bw/2, shY, cx + 10, H);
            lG.addColorStop(0, lMid);
            lG.addColorStop(0.4, lBase);
            lG.addColorStop(1, lDark);
            ctx.fillStyle = lG;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.fill();

            // Leather panel stitching lines
            ctx.strokeStyle = alpha(blendHex(lBase, '#8B6914', 0.5), 0.7); ctx.lineWidth = 1.2;
            // Vertical panels
            [cx - 35, cx - 10, cx + 10, cx + 35].forEach(px => {
                ctx.setLineDash([3, 3]);
                ctx.beginPath(); ctx.moveTo(px, shY - 5); ctx.lineTo(px, H + 10); ctx.stroke();
            });
            // Horizontal bands
            [shY + 20, shY + 45, shY + 70].forEach(by => {
                ctx.setLineDash([4, 4]);
                ctx.beginPath(); ctx.moveTo(cx - bw/2 + 8, by); ctx.lineTo(cx + bw/2 - 8, by); ctx.stroke();
            });
            ctx.setLineDash([]);

            // Buckles / straps
            [[cx - bw/2 + 30, shY + 22],[cx + bw/2 - 30, shY + 22],[cx, shY + 45]].forEach(([bx, by]) => {
                ctx.fillStyle = '#8B6914';
                ctx.fillRect(bx - 5, by - 4, 10, 8);
                ctx.strokeStyle = '#C0A030'; ctx.lineWidth = 1.5;
                ctx.strokeRect(bx - 5, by - 4, 10, 8);
                ctx.beginPath(); ctx.moveTo(bx - 2, by); ctx.lineTo(bx + 2, by); ctx.stroke();
            });

            // Rogue: dark hood/cowl suggestion at neckline
            if (cls === 'Rogue') {
                ctx.fillStyle = alpha('#0A0A0A', 0.7);
                ctx.beginPath();
                ctx.moveTo(cx - neckW/2 - 18, shY - 8);
                ctx.quadraticCurveTo(cx, shY - 28, cx + neckW/2 + 18, shY - 8);
                ctx.quadraticCurveTo(cx + neckW/2 + 8, shY + 5, cx, shY + 2);
                ctx.quadraticCurveTo(cx - neckW/2 - 8, shY + 5, cx - neckW/2 - 18, shY - 8);
                ctx.fill();
                // Rogue knife/dagger hint on belt
                ctx.strokeStyle = '#A0A0A8'; ctx.lineWidth = 2.5; ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(cx + bw/2 - 22, shY + 65); ctx.lineTo(cx + bw/2 - 8, shY + 38); ctx.stroke();
                ctx.fillStyle = '#8B6914';
                ctx.fillRect(cx + bw/2 - 24, shY + 64, 5, 8);
            }

            // Ranger: cloak/capelet over one shoulder
            if (cls === 'Ranger') {
                ctx.fillStyle = alpha('#2D4A1A', 0.82);
                ctx.beginPath();
                ctx.moveTo(cx - bw/2 - 5, shY - 22);
                ctx.quadraticCurveTo(cx - bw/4, shY - 30, cx + 5, shY - 10);
                ctx.lineTo(cx - 10, shY + 50);
                ctx.quadraticCurveTo(cx - bw/2 + 15, shY + 55, cx - bw/2, shY + 30);
                ctx.closePath(); ctx.fill();
                // Leaf-pin brooch
                ctx.fillStyle = '#8B6914';
                ctx.beginPath(); ctx.arc(cx - bw/4 + 10, shY - 8, 6, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#40916C';
                ctx.beginPath(); ctx.ellipse(cx - bw/4 + 10, shY - 8, 5, 3, 0.5, 0, Math.PI*2); ctx.fill();
            }

            // Outline trim
            ctx.strokeStyle = alpha(cc.a, 0.5); ctx.lineWidth = 1.5;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.stroke();
        }

        // ─── Robes (Wizard, Sorcerer, Warlock, Druid, Bard) ───
        else if (/robe|unarmored/i.test(armorDesc) || ['Wizard','Sorcerer','Warlock','Druid','Bard','Monk'].includes(cls)) {
            const robeBase = cc.p;
            const robeDark = blendHex(robeBase, '#000', 0.35);
            const robeLight = blendHex(robeBase, '#FFF', 0.2);

            // Wide flowing robe silhouette
            const rbw = bw + (isFemale ? 16 : 8);
            const robeG = ctx.createLinearGradient(cx - rbw/2, shY - 20, cx + rbw/2, H);
            robeG.addColorStop(0, robeLight);
            robeG.addColorStop(0.25, robeBase);
            robeG.addColorStop(0.8, robeDark);
            robeG.addColorStop(1, blendHex(robeDark,'#000',0.3));
            ctx.fillStyle = robeG;
            ctx.beginPath();
            ctx.moveTo(cx - rbw/2 - 8, H + 10);
            ctx.lineTo(cx - rbw/2, shY + 15);
            ctx.quadraticCurveTo(cx - rbw/2, shY - 10, cx - rbw/2 + 32, shY - 22);
            ctx.lineTo(cx - neckW/2 - 4, shY - 8);
            ctx.lineTo(cx + neckW/2 + 4, shY - 8);
            ctx.lineTo(cx + rbw/2 - 32, shY - 22);
            ctx.quadraticCurveTo(cx + rbw/2, shY - 10, cx + rbw/2, shY + 15);
            ctx.lineTo(cx + rbw/2 + 8, H + 10);
            ctx.closePath(); ctx.fill();

            // Robe fabric fold lines
            ctx.strokeStyle = alpha(robeDark, 0.4); ctx.lineWidth = 1.5;
            [[-30, -40, -10, 60],[-8, -15, 5, 65],[20, 25, 5, 55],[40, 50, 12, 45]].forEach(([x1,x2,xd,ylen]) => {
                ctx.beginPath();
                ctx.moveTo(cx + x1, shY + 5);
                ctx.quadraticCurveTo(cx + x2 + xd, shY + ylen/2, cx + x2, shY + ylen);
                ctx.stroke();
            });

            // Front collar opening / placket
            ctx.fillStyle = alpha(robeDark, 0.6);
            ctx.beginPath();
            ctx.moveTo(cx - neckW/2 - 4, shY - 8);
            ctx.lineTo(cx + neckW/2 + 4, shY - 8);
            ctx.lineTo(cx + 14, shY + 48);
            ctx.lineTo(cx - 14, shY + 48);
            ctx.closePath(); ctx.fill();

            // Class-specific robe embellishments
            if (cls === 'Wizard' || cls === 'Sorcerer') {
                // Arcane star constellations
                ctx.fillStyle = alpha(cc.a, 0.55);
                ctx.strokeStyle = alpha(cc.a, 0.35); ctx.lineWidth = 0.8;
                const runes = ['ᚱ','ᚦ','ᚨ','ᛗ','ᛟ','ᚷ','ᚹ','ᛞ','ᛈ','ᚠ','ᛁ','ᛚ','ᚾ','ᛏ','ᛒ'];
                ctx.font = 'bold 11px serif';
                for (let i = 0; i < 8; i++) {
                    const rx2 = cx + ri(-55, 55), ry2 = H - ri(15, 95);
                    ctx.fillText(rp(runes), rx2, ry2);
                }
                // Arcane glowing gem on chest
                const gemG = ctx.createRadialGradient(cx, shY + 18, 1, cx, shY + 18, 10);
                gemG.addColorStop(0, alpha('#FFFFFF', 0.9));
                gemG.addColorStop(0.4, alpha(cc.a, 0.8));
                gemG.addColorStop(1, alpha(cc.a, 0.1));
                ctx.fillStyle = gemG;
                ctx.beginPath(); ctx.arc(cx, shY + 18, 9, 0, Math.PI*2); ctx.fill();
                // Gem gleam
                ctx.fillStyle = alpha('#FFFFFF', 0.7);
                ctx.beginPath(); ctx.ellipse(cx - 2, shY + 15, 3, 2, -0.5, 0, Math.PI*2); ctx.fill();
            }

            if (cls === 'Warlock') {
                // Dark pact insignia
                ctx.fillStyle = alpha(cc.a, 0.18);
                ctx.beginPath(); ctx.arc(cx, shY + 28, 38, 0, Math.PI*2); ctx.fill();
                // Eldritch eye symbol
                ctx.strokeStyle = alpha(cc.a, 0.7); ctx.lineWidth = 2;
                ctx.beginPath(); ctx.ellipse(cx, shY + 28, 14, 8, 0, 0, Math.PI*2); ctx.stroke();
                ctx.fillStyle = alpha(cc.a, 0.7);
                ctx.beginPath(); ctx.arc(cx, shY + 28, 4, 0, Math.PI*2); ctx.fill();
                // Tendrils
                ctx.strokeStyle = alpha(cc.a, 0.4); ctx.lineWidth = 1.5;
                for (let t = 0; t < 6; t++) {
                    const ang = (t / 6) * Math.PI * 2;
                    ctx.beginPath();
                    ctx.moveTo(cx + Math.cos(ang)*14, shY + 28 + Math.sin(ang)*8);
                    ctx.quadraticCurveTo(
                        cx + Math.cos(ang)*24 + ri(-6,6), shY + 28 + Math.sin(ang)*18,
                        cx + Math.cos(ang)*32, shY + 28 + Math.sin(ang)*24
                    );
                    ctx.stroke();
                }
            }

            if (cls === 'Druid') {
                // Leaf and nature motifs on robe
                const leafColors = ['#2D6A4F','#40916C','#52B788','#74C69D'];
                for (let l = 0; l < 8; l++) {
                    ctx.fillStyle = alpha(rp(leafColors), 0.65);
                    const lx = cx + ri(-60, 60);
                    const ly = H - ri(10, 100);
                    const la = ri(-30, 30) * Math.PI / 180;
                    ctx.beginPath();
                    ctx.save(); ctx.translate(lx, ly); ctx.rotate(la);
                    ctx.ellipse(0, 0, 5, 10, 0, 0, Math.PI*2);
                    ctx.restore(); ctx.fill();
                }
                // Wooden brooch
                ctx.fillStyle = '#5D3A1A';
                ctx.beginPath(); ctx.arc(cx, shY + 16, 8, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#40916C';
                ctx.beginPath(); ctx.ellipse(cx, shY + 16, 6, 4, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#52B788';
                ctx.beginPath(); ctx.ellipse(cx - 1, shY + 15, 3, 2, -0.4, 0, Math.PI*2); ctx.fill();
            }

            if (cls === 'Bard') {
                // Flamboyant doublet flourishes
                ctx.strokeStyle = alpha(cc.a, 0.75); ctx.lineWidth = 1.8;
                for (let w = 0; w < 6; w++) {
                    ctx.beginPath();
                    ctx.moveTo(cx - 55, shY + 10 + w * 14);
                    for (let x = -55; x <= 55; x += 4) {
                        ctx.lineTo(cx + x, shY + 10 + w * 14 + Math.sin(x * 0.18) * 5);
                    }
                    ctx.stroke();
                }
                // Lute/instrument silhouette hint at side
                ctx.strokeStyle = alpha('#8B6914', 0.6); ctx.lineWidth = 2.5;
                ctx.beginPath(); ctx.ellipse(cx + bw/2 - 14, shY + 60, 10, 14, 0.2, 0, Math.PI*2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx + bw/2 - 14, shY + 46); ctx.lineTo(cx + bw/2 - 10, shY + 8); ctx.stroke();
                // Jeweled collar pin
                const pinG = ctx.createRadialGradient(cx, shY + 12, 0, cx, shY + 12, 7);
                pinG.addColorStop(0, '#FFFFFF');
                pinG.addColorStop(0.5, cc.a);
                pinG.addColorStop(1, 'transparent');
                ctx.fillStyle = pinG;
                ctx.beginPath(); ctx.arc(cx, shY + 12, 7, 0, Math.PI*2); ctx.fill();
            }

            if (cls === 'Monk') {
                // Simple wrap/gi with belt
                ctx.fillStyle = alpha('#4A3A2A', 0.55);
                ctx.beginPath();
                ctx.moveTo(cx - 8, shY - 8);
                ctx.lineTo(cx - 28, shY + 52);
                ctx.lineTo(cx + 24, shY + 52);
                ctx.lineTo(cx + 8, shY - 8);
                ctx.closePath(); ctx.fill();
                // Belt/sash
                ctx.fillStyle = alpha(cc.a, 0.8);
                ctx.beginPath();
                ctx.moveTo(cx - rbw/2 + 10, shY + 48);
                ctx.lineTo(cx + rbw/2 - 10, shY + 48);
                ctx.lineTo(cx + rbw/2 - 14, shY + 58);
                ctx.lineTo(cx - rbw/2 + 14, shY + 58);
                ctx.closePath(); ctx.fill();
                // Circular focus medallion
                ctx.strokeStyle = alpha(cc.a, 0.7); ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(cx, shY + 22, 14, 0, Math.PI*2); ctx.stroke();
                ctx.beginPath(); ctx.arc(cx, shY + 22, 7, 0, Math.PI*2); ctx.stroke();
                ctx.fillStyle = alpha(cc.a, 0.2);
                ctx.beginPath(); ctx.arc(cx, shY + 22, 14, 0, Math.PI*2); ctx.fill();
            }

            // Wide robe outline
            ctx.strokeStyle = alpha(cc.a, 0.6); ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(cx - rbw/2 - 8, H + 10);
            ctx.lineTo(cx - rbw/2, shY + 15);
            ctx.quadraticCurveTo(cx - rbw/2, shY - 10, cx - rbw/2 + 32, shY - 22);
            ctx.lineTo(cx - neckW/2 - 4, shY - 8);
            ctx.lineTo(cx + neckW/2 + 4, shY - 8);
            ctx.lineTo(cx + rbw/2 - 32, shY - 22);
            ctx.quadraticCurveTo(cx + rbw/2, shY - 10, cx + rbw/2, shY + 15);
            ctx.lineTo(cx + rbw/2 + 8, H + 10);
            ctx.stroke();
        }

        // ─── Barbarian (furs, hides, minimal armor) ───
        else if (cls === 'Barbarian') {
            const furBase = '#5A3A1A';
            const furDark = '#2A1A08';
            const skinExp = skinColor; // exposed skin sections

            // Exposed chest / bare skin base
            const bodyG = ctx.createLinearGradient(cx - bw/2, shY, cx, H);
            bodyG.addColorStop(0, blendHex(skinColor,'#FFF',0.1));
            bodyG.addColorStop(0.5, skinColor);
            bodyG.addColorStop(1, skinDark);
            ctx.fillStyle = bodyG;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.fill();

            // Fur cloak draped across both shoulders
            ctx.fillStyle = furBase;
            ctx.beginPath();
            ctx.moveTo(cx - bw/2 - 6, H + 10);
            ctx.lineTo(cx - bw/2 + 6, shY + 10);
            ctx.quadraticCurveTo(cx - bw/2 + 14, shY - 30, cx - bw/4, shY - 28);
            ctx.lineTo(cx, shY - 20);
            ctx.lineTo(cx + bw/4, shY - 28);
            ctx.quadraticCurveTo(cx + bw/2 - 14, shY - 30, cx + bw/2 - 6, shY + 10);
            ctx.lineTo(cx + bw/2 + 6, H + 10);
            ctx.closePath(); ctx.fill();

            // Fur texture tufts
            ctx.strokeStyle = furDark; ctx.lineWidth = 1.5; ctx.lineCap = 'round';
            for (let f = 0; f < 22; f++) {
                const fx = cx - bw/2 + ri(0, bw);
                const fy = shY - 20 + ri(0, 30);
                ctx.beginPath(); ctx.moveTo(fx, fy); ctx.lineTo(fx + ri(-4, 4), fy + ri(-6, -2)); ctx.stroke();
            }

            // Leather strap harness
            ctx.strokeStyle = '#6B4020'; ctx.lineWidth = 4; ctx.lineCap = 'butt';
            ctx.beginPath();
            ctx.moveTo(cx - neckW/2 - 6, shY - 5);
            ctx.lineTo(cx - bw/2 + 20, shY + 80);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(cx + neckW/2 + 6, shY - 5);
            ctx.lineTo(cx + bw/2 - 20, shY + 80);
            ctx.stroke();
            // Cross strap
            ctx.beginPath();
            ctx.moveTo(cx - bw/4 + 5, shY + 20);
            ctx.lineTo(cx + bw/4 - 5, shY + 40);
            ctx.stroke();

            // War paint / tribal markings
            ctx.strokeStyle = alpha(cc.a, 0.65); ctx.lineWidth = 2.5;
            for (let m = 0; m < 4; m++) {
                const mx = cx + ri(-40, 40), my = shY + 15 + m * 22;
                ctx.beginPath();
                ctx.moveTo(mx - ri(12, 20), my);
                ctx.lineTo(mx + ri(12, 20), my + ri(-4, 4));
                ctx.stroke();
            }

            // Bone/tooth necklace
            ctx.strokeStyle = '#E8D8A0'; ctx.lineWidth = 1.5;
            for (let t = -4; t <= 4; t++) {
                const tx = cx + t * 9, ty = shY - 12;
                ctx.fillStyle = '#D4B860';
                ctx.beginPath();
                ctx.moveTo(tx - 2, ty); ctx.lineTo(tx, ty - 8); ctx.lineTo(tx + 2, ty);
                ctx.closePath(); ctx.fill();
            }

            ctx.strokeStyle = alpha(furDark, 0.5); ctx.lineWidth = 1.5;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.stroke();
        }

        // ─── Fallback (generic traveller clothes) ───
        else {
            const clothG = ctx.createLinearGradient(cx - bw/2, shY - 20, cx + 10, H);
            clothG.addColorStop(0, blendHex(cc.p,'#FFF',0.18));
            clothG.addColorStop(0.4, cc.p);
            clothG.addColorStop(1, blendHex(cc.p,'#000',0.3));
            ctx.fillStyle = clothG;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.fill();

            // Simple shirt seam
            ctx.fillStyle = alpha(cc.s, 0.7);
            ctx.beginPath();
            ctx.moveTo(cx - neckW/2 - 4, shY - 8);
            ctx.lineTo(cx + neckW/2 + 4, shY - 8);
            ctx.lineTo(cx + 28, H + 10);
            ctx.lineTo(cx - 28, H + 10);
            ctx.closePath(); ctx.fill();

            // Collar V
            ctx.strokeStyle = alpha(cc.a, 0.8); ctx.lineWidth = 2.5; ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(cx - neckW/2 - 8, shY - 5);
            ctx.lineTo(cx, shY - 18);
            ctx.lineTo(cx + neckW/2 + 8, shY - 5);
            ctx.stroke();

            // Modest shoulder guards
            [[cx - bw/2 + 18, -1],[cx + bw/2 - 18, 1]].forEach(([px, side]) => {
                ctx.fillStyle = alpha(cc.a, 0.35);
                ctx.beginPath(); ctx.ellipse(px, shY - 14, 22, 14, side*0.1, 0, Math.PI*2); ctx.fill();
            });

            ctx.strokeStyle = alpha(cc.a, 0.6); ctx.lineWidth = 2;
            torsoPath(cx - bw/2, cx + bw/2);
            ctx.stroke();
        }

        // ── Universal: boss aura reinforcement on shoulders ──
        if (isBoss) {
            [[cx - bw/2 + 12, -1],[cx + bw/2 - 12, 1]].forEach(([px, side]) => {
                const bossAura = ctx.createRadialGradient(px, shY - 20, 0, px, shY - 20, 45);
                bossAura.addColorStop(0, alpha(cc.a, 0.35));
                bossAura.addColorStop(1, 'transparent');
                ctx.fillStyle = bossAura; ctx.fillRect(0, 0, W, H);
            });
        }
    }
    drawBody();

    // ---------- HAIR BACK ----------
    // Hair style pools — gender and race biased
    const HAIR_STYLES_FEMALE = ['medium_wavy','long_straight','long_wavy','braided','cornrows','tousled','topknot','curly_short','afro','swept_back','wild','bald'];
    const HAIR_STYLES_MALE   = ['short_neat','short_messy','undercut','swept_back','widow_peak','mohawk','topknot','braided','dreadlocks','cropped_sides','tousled','shaved','afro','curly_short','bald'];
    const HAIR_STYLES_DWARF  = ['short_neat','braided','undercut','mohawk','tousled','bald','shaved'];  // dwarf males tend to shorter above, massive beard below
    const HAIR_STYLES_ELF    = ['long_straight','long_wavy','medium_wavy','swept_back','topknot','braided','tousled','short_neat'];
    const HAIR_STYLES_ORC    = ['short_messy','mohawk','wild','shaved','bald','dreadlocks','short_neat'];
    
    let stylePool;
    if (npc.race === 'Dwarf' && !isFemale) stylePool = HAIR_STYLES_DWARF;
    else if (npc.race === 'Elf' || npc.race === 'Half-Elf') stylePool = isFemale ? HAIR_STYLES_ELF : [...HAIR_STYLES_ELF,'short_neat','undercut'];
    else if (npc.race === 'Half-Orc') stylePool = HAIR_STYLES_ORC;
    else stylePool = isFemale ? HAIR_STYLES_FEMALE : HAIR_STYLES_MALE;
    
    const hairStyle = rp(stylePool);
    const hairLen = ['long_straight','long_wavy','braided','dreadlocks','cornrows'].includes(hairStyle) ? 'long' : ['medium_wavy'].includes(hairStyle) ? 'medium' : 'short';

    function drawHairBack() {
        if (hairStyle === 'bald' || hairStyle === 'shaved') return;
        ctx.fillStyle = hairColor;
        const topY = headCY - FH * 0.5;
        if (hairLen === 'long' || hairLen === 'medium') {
            ctx.beginPath();
            ctx.ellipse(cx, headCY - FH*0.25, FW/2 + 10, FH*0.7, 0, Math.PI, Math.PI*2);
            ctx.fill();
            // Strands down sides
            if (hairLen === 'long') {
                ctx.strokeStyle = hairDark; ctx.lineWidth = 3.5; ctx.lineCap = 'round';
                const strandCount = ri(6, 10);
                for (let i = 0; i < strandCount; i++) {
                    const sx = cx - FW/2 - 8 + (FW + 16) * (i / (strandCount-1));
                    ctx.beginPath();
                    ctx.moveTo(sx, headCY + FH*0.25);
                    ctx.bezierCurveTo(sx + ri(-20,20), headCY + FH*0.6, sx + ri(-25,25), headCY + FH + ri(20,60), sx + ri(-15,15), headCY + FH + ri(50,100));
                    ctx.stroke();
                }
            }
        }
    }
    drawHairBack();

    // ---------- EARS ----------
    function drawEars() {
        if (rf.earType === 'none') return;
        const earY = headCY;
        const earH = 20 * rf.earMult;
        const earW = 11;
        [[-1, 1]].flat().forEach(side => {
            const ex = cx + side * (FW/2 + 2);
            ctx.fillStyle = skinColor;
            ctx.beginPath();
            if (rf.earType === 'pointed') {
                ctx.moveTo(ex, earY - earH * 0.4);
                ctx.lineTo(ex + side * 14, earY - earH * 1.1);
                ctx.lineTo(ex + side * 2, earY + earH * 0.45);
                ctx.closePath();
            } else {
                ctx.ellipse(ex + side * (earW/2 - 2), earY, earW, earH * 0.5, 0, 0, Math.PI*2);
            }
            ctx.fill();
            ctx.strokeStyle = skinMid; ctx.lineWidth = 1.2; ctx.stroke();
            // Inner ear detail
            ctx.strokeStyle = alpha(skinDark, 0.5); ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.ellipse(ex + side * (earW/2 - 2), earY + 2, earW*0.5, earH*0.28, 0, 0, Math.PI*2);
            ctx.stroke();
        });
        // Single ear earring chance
        if (rng() > 0.6) {
            const side = rng() > 0.5 ? -1 : 1;
            const ex = cx + side * (FW/2 + 2);
            const jColor = rp(['#FFD700','#C0C0C0','#CC2020','#2020CC','#20CC20','#201010']);
            ctx.fillStyle = jColor;
            ctx.beginPath(); ctx.arc(ex + side * (rf.earType==='pointed' ? 10 : 8), earY + 6, 4, 0, Math.PI*2); ctx.fill();
            if (rng() > 0.5) { // second earring
                ctx.beginPath(); ctx.arc(ex + side * (rf.earType==='pointed' ? 8 : 7), earY + 14, 3, 0, Math.PI*2); ctx.fill();
            }
        }
    }
    drawEars();

    // ---------- TIEFLING HORNS ----------
    if (rf.horns) {
        const hornStyles = ['curved_back','curved_up','ram','antler','spike'];
        const hStyle = rp(hornStyles);
        const hornColor = rp([hairDark, blendHex(skinDark,'#000000',0.3), '#1A0808', '#300030', '#101808']);
        const topY = headCY - FH * 0.45;
        ctx.fillStyle = hornColor;
        ctx.strokeStyle = alpha('#000', 0.4); ctx.lineWidth = 1.5;
        [-1, 1].forEach(side => {
            const hx = cx + side * FW * 0.28;
            const hy = topY + FH * 0.08;
            ctx.beginPath();
            if (hStyle === 'curved_back') {
                ctx.moveTo(hx, hy);
                ctx.bezierCurveTo(hx + side*12, hy - 25, hx + side*30, hy - 55, hx + side*22, hy - 75);
                ctx.bezierCurveTo(hx + side*18, hy - 60, hx + side*8, hy - 35, hx + side*5, hy);
            } else if (hStyle === 'curved_up') {
                ctx.moveTo(hx, hy);
                ctx.bezierCurveTo(hx + side*6, hy - 28, hx - side*4, hy - 58, hx - side*2, hy - 80);
                ctx.bezierCurveTo(hx - side*6, hy - 62, hx + side*2, hy - 32, hx - side*4, hy);
            } else if (hStyle === 'ram') {
                ctx.moveTo(hx, hy);
                ctx.bezierCurveTo(hx + side*20, hy - 18, hx + side*35, hy, hx + side*32, hy + 20);
                ctx.bezierCurveTo(hx + side*24, hy + 10, hx + side*8, hy - 8, hx, hy);
            } else {
                ctx.moveTo(hx, hy);
                ctx.lineTo(hx + side*8, hy - 55);
                ctx.lineTo(hx + side*4, hy);
            }
            ctx.closePath(); ctx.fill(); ctx.stroke();
            // Horn texture ring
            ctx.strokeStyle = alpha(blendHex(hornColor,'#FFFFFF',0.2), 0.4); ctx.lineWidth = 1;
            for (let r = 0; r < 3; r++) {
                ctx.beginPath(); ctx.arc(hx + side*4, hy - 20 - r*10, 4 - r, 0, Math.PI*2); ctx.stroke();
            }
        });
    }

    // ---------- TIEFLING TAIL ----------
    if (rf.tail) {
        // Tail curls up from behind one shoulder, arcing above the collar
        const tailSide = rng() > 0.5 ? 1 : -1;
        const tx0 = cx + tailSide * (FW/2 + 20);
        const ty0 = shoulderY + 20;
        const tailColor = blendHex(skinColor, '#000000', 0.18);
        const tailDark  = blendHex(skinColor, '#000000', 0.38);
        ctx.strokeStyle = tailColor; ctx.lineWidth = 7; ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(tx0, ty0);
        ctx.bezierCurveTo(
            tx0 + tailSide*30, ty0 - 55,
            tx0 + tailSide*10, ty0 - 95,
            tx0 - tailSide*10, ty0 - 70
        );
        ctx.stroke();
        // Thinner accent line
        ctx.strokeStyle = tailDark; ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(tx0, ty0);
        ctx.bezierCurveTo(
            tx0 + tailSide*30, ty0 - 55,
            tx0 + tailSide*10, ty0 - 95,
            tx0 - tailSide*10, ty0 - 70
        );
        ctx.stroke();
        // Arrow tip
        ctx.fillStyle = tailColor;
        ctx.save();
        ctx.translate(tx0 - tailSide*10, ty0 - 70);
        ctx.rotate(tailSide * 0.4);
        ctx.beginPath();
        ctx.moveTo(0, -14); ctx.lineTo(-6, 0); ctx.lineTo(6, 0);
        ctx.closePath(); ctx.fill();
        ctx.restore();
    }

    // ---------- FACE ----------
    function drawFace() {
        // Ambient shadow under chin
        const chinSh = ctx.createRadialGradient(cx, headCY + FH*0.55, 8, cx, headCY + FH*0.58, FW*0.65);
        chinSh.addColorStop(0, alpha('#000000', 0.3)); chinSh.addColorStop(1, 'transparent');
        ctx.fillStyle = chinSh; ctx.fillRect(0, 0, W, H);

        // FACE SHAPE — driven by jawTypeEff (outer scope) and gender
        const jawW = jawTypeEff === 'square' ? FW * 0.90
                   : jawTypeEff === 'wide'   ? FW * 0.95
                   : jawTypeEff === 'pointed'? FW * (isFemale ? 0.68 : 0.74)
                   : jawTypeEff === 'round'  ? FW * 0.82
                   :                           FW * (isFemale ? 0.74 : 0.84);
        const temW = FW / 2;

        if (rf.snout) {
            // Dragonborn — elongated reptilian muzzle
            ctx.fillStyle = skinColor;
            ctx.beginPath();
            ctx.ellipse(cx, headCY - FH*0.08, FW/2, FH/2*0.88, 0, 0, Math.PI*2);
            ctx.fill();
            // Muzzle protrusion
            ctx.fillStyle = blendHex(skinColor,'#000000',0.12);
            ctx.beginPath();
            ctx.ellipse(cx, headCY + FH*0.24, FW*0.36, FH*0.32, 0, 0, Math.PI*2);
            ctx.fill();
            // Brow ridge on Dragonborn
            ctx.fillStyle = blendHex(skinColor,'#000000',0.2);
            ctx.beginPath(); ctx.ellipse(cx, headCY - FH*0.34, FW*0.46, 10, 0, 0, Math.PI*2); ctx.fill();
        } else {
            const faceG = ctx.createLinearGradient(cx - FW/2, headCY - FH/2, cx + FW*0.3, headCY + FH*0.5);
            faceG.addColorStop(0, skinLight);
            faceG.addColorStop(0.4, skinColor);
            faceG.addColorStop(1, skinMid);
            ctx.fillStyle = faceG;
            ctx.beginPath();
            if (jawTypeEff === 'square') {
                // Square jaw: near-vertical sides, sharp corner to chin
                ctx.moveTo(cx - temW, headCY - FH*0.15);
                ctx.bezierCurveTo(cx - temW - 5, headCY + FH*0.15, cx - jawW/2, headCY + FH*0.36, cx - jawW/2, headCY + FH*0.5);
                ctx.lineTo(cx + jawW/2, headCY + FH*0.5);
                ctx.bezierCurveTo(cx + jawW/2, headCY + FH*0.36, cx + temW + 5, headCY + FH*0.15, cx + temW, headCY - FH*0.15);
            } else if (jawTypeEff === 'pointed') {
                // Pointed/oval chin — narrow taper to point
                ctx.moveTo(cx - temW, headCY - FH*0.15);
                ctx.bezierCurveTo(cx - temW - 5, headCY + FH*0.1, cx - jawW/2, headCY + FH*0.42, cx, headCY + FH*0.62);
                ctx.bezierCurveTo(cx + jawW/2, headCY + FH*0.42, cx + temW + 5, headCY + FH*0.1, cx + temW, headCY - FH*0.15);
            } else if (jawTypeEff === 'wide') {
                // Wide/massive jaw
                ctx.moveTo(cx - temW, headCY - FH*0.15);
                ctx.bezierCurveTo(cx - temW - 8, headCY + FH*0.12, cx - jawW/2, headCY + FH*0.44, cx, headCY + FH*0.55);
                ctx.bezierCurveTo(cx + jawW/2, headCY + FH*0.44, cx + temW + 8, headCY + FH*0.12, cx + temW, headCY - FH*0.15);
            } else {
                // Round/default
                ctx.moveTo(cx - temW, headCY - FH*0.15);
                ctx.bezierCurveTo(cx - temW - 6, headCY + FH*0.15, cx - jawW/2, headCY + FH*0.48, cx, headCY + FH*0.56);
                ctx.bezierCurveTo(cx + jawW/2, headCY + FH*0.48, cx + temW + 6, headCY + FH*0.15, cx + temW, headCY - FH*0.15);
            }
            ctx.ellipse(cx, headCY - FH*0.12, temW, FH/2*1.02, 0, Math.PI, Math.PI*2);
            ctx.closePath();
            ctx.fill();
        }

        // Cheek blush / subsurface
        [[cx - FW*0.3, headCY + FH*0.06],[cx + FW*0.3, headCY + FH*0.06]].forEach(([bx,by]) => {
            const bG = ctx.createRadialGradient(bx,by,2,bx,by,22);
            bG.addColorStop(0, alpha('#CC6050', isFemale ? 0.18 : 0.08));
            bG.addColorStop(1,'transparent');
            ctx.fillStyle = bG; ctx.fillRect(0,0,W,H);
        });

        // Forehead highlight (key light)
        const fHL = ctx.createRadialGradient(cx - FW*0.12, headCY - FH*0.28, 2, cx - FW*0.08, headCY - FH*0.2, FW*0.45);
        fHL.addColorStop(0, alpha('#FFFFFF', 0.22)); fHL.addColorStop(1,'transparent');
        ctx.fillStyle = fHL; ctx.fillRect(0,0,W,H);

        // Side shadow (rim/fill)
        const sideSh = ctx.createLinearGradient(cx + FW*0.2, headCY, cx + FW*0.55, headCY);
        sideSh.addColorStop(0,'transparent'); sideSh.addColorStop(1, alpha(skinDark, 0.35));
        ctx.fillStyle = sideSh; ctx.fillRect(0,0,W,H);

        // Age wrinkles
        if (isOld) {
            ctx.strokeStyle = alpha(skinDark, 0.18); ctx.lineWidth = 1.2; ctx.lineCap = 'round';
            // Forehead lines
            for (let wr = 0; wr < 3; wr++) {
                ctx.beginPath();
                const wy = headCY - FH*0.3 + wr*9;
                ctx.moveTo(cx - FW*0.35, wy); ctx.quadraticCurveTo(cx, wy + ri(-3,3), cx + FW*0.35, wy + 1); ctx.stroke();
            }
            // Crow's feet
            ctx.lineWidth = 0.9;
            [-1,1].forEach(side => {
                const ex = cx + side * FW*0.32;
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath(); ctx.moveTo(ex, headCY - 2); ctx.lineTo(ex + side*10, headCY - 8 + i*6); ctx.stroke();
                }
            });
            // Nasolabial folds
            ctx.lineWidth = 1.1;
            [-1,1].forEach(side => {
                ctx.beginPath();
                ctx.moveTo(cx + side*FW*0.18, headCY + FH*0.12);
                ctx.quadraticCurveTo(cx + side*FW*0.28, headCY + FH*0.25, cx + side*FW*0.22, headCY + FH*0.38);
                ctx.stroke();
            });
        }

        // Half-Orc ridge — more defined, prominent
        if (rf.ridge) {
            // Main brow ridge
            ctx.fillStyle = alpha(skinDark, 0.5);
            ctx.beginPath(); ctx.ellipse(cx, headCY - FH*0.28, FW*0.46, 11, 0, 0, Math.PI*2); ctx.fill();
            // Secondary ridge shadow
            ctx.fillStyle = alpha(skinDark, 0.25);
            ctx.beginPath(); ctx.ellipse(cx, headCY - FH*0.24, FW*0.38, 7, 0, 0, Math.PI*2); ctx.fill();
            // Ridge highlight
            ctx.fillStyle = alpha(skinLight, 0.2);
            ctx.beginPath(); ctx.ellipse(cx - FW*0.08, headCY - FH*0.3, FW*0.2, 4, -0.2, 0, Math.PI*2); ctx.fill();
        }

        // Dragonborn scales texture — overlapping crescent shapes
        if (rf.scales) {
            const scaleBaseColor = alpha(blendHex(skinColor,'#000000',0.22), 0.3);
            const scaleHighColor = alpha(blendHex(skinColor,'#FFFFFF',0.12), 0.2);
            for (let sy = -FH*0.44; sy < FH*0.48; sy += 10) {
                const rowOff = ((Math.round(sy/10)) % 2) * 5;
                for (let sx = -FW*0.44; sx < FW*0.44; sx += 10) {
                    const dist = Math.sqrt((sx/(FW*0.48))**2 + (sy/(FH*0.5))**2);
                    if (dist < 0.96) {
                        // Scale shadow arc
                        ctx.strokeStyle = scaleBaseColor; ctx.lineWidth = 1.2;
                        ctx.beginPath(); ctx.arc(cx+sx+rowOff, headCY+sy, 4.5, 0.4, Math.PI-0.4); ctx.stroke();
                        // Scale highlight
                        ctx.strokeStyle = scaleHighColor; ctx.lineWidth = 0.8;
                        ctx.beginPath(); ctx.arc(cx+sx+rowOff, headCY+sy-2, 3, Math.PI+0.4, -0.4); ctx.stroke();
                    }
                }
            }
        }
    }
    drawFace();

    // ---------- BROWS ----------
    function drawBrows() {
        const browY = headCY - FH*0.18;
        const browW = FW * (isFemale ? 0.24 : 0.28);
        // browWeight: Elf=fine, Human=normal, Dwarf/HalfOrc=heavy
        const baseBrowThick = isBoss ? 4.0 : (isFemale ? 1.8 : 2.8);
        const browThick = baseBrowThick * (rf.browWeight || 1.0);
        const browTilt = isAngryPersonality ? 0.18 : (isBrooding ? 0.12 : (isKindPersonality ? -0.06 : ri(-5,5)/100));
        // Elf brows arch high and narrow; female brows higher arched
        const browArchY = isFemale ? browY - 4 : (rf.eyeShape === 'almond' ? browY - 3 : browY);

        ctx.strokeStyle = blendHex(hairColor,'#000000',0.2);
        ctx.lineWidth = browThick; ctx.lineCap = 'round';
        [-1,1].forEach(side => {
            const bx = cx + side * FW*(isFemale ? 0.22 : 0.24);
            ctx.beginPath();
            ctx.moveTo(bx - side*browW*0.9, browArchY + browTilt*side*28 + (isFemale ? 2 : 0));
            ctx.quadraticCurveTo(bx, browArchY - browThick*(isFemale ? 2.5 : 1.8), bx + side*browW*0.9, browArchY - browTilt*side*28);
            ctx.stroke();
        });
        // Elf: sharp inner corner accent
        if (rf.eyeShape === 'almond') {
            ctx.lineWidth = browThick * 0.6;
            [-1,1].forEach(side => {
                const bx = cx + side * FW*0.22;
                ctx.beginPath();
                ctx.moveTo(bx - side*browW*0.85, browArchY + browTilt*side*28 + 2);
                ctx.lineTo(bx - side*browW*0.65, browArchY + browTilt*side*20);
                ctx.stroke();
            });
        }
    }
    drawBrows();

    // ---------- EYES ----------
    function drawEyes() {
        const eyeY  = headCY - FH*0.08;
        const eyeSpread = FW * (rf.eyeShape === 'wide' ? 0.26 : rf.eyeShape === 'almond' ? 0.22 : 0.24);
        const eyeW  = rf.eyeShape === 'wide' ? 13 : rf.eyeShape === 'almond' ? 13 : rf.eyeShape === 'reptile' ? 10 : (rf.small ? 9 : 11);
        const eyeH  = rf.eyeShape === 'wide' ? 9 : rf.eyeShape === 'almond' ? 6 : rf.eyeShape === 'reptile' ? 9 : (rf.small ? 6 : 7);
        const eyeHf = isFemale ? eyeH * 1.15 : eyeH;
        const eyeLid = isAngryPersonality ? 0.18 : (isBrooding ? 0.12 : (isSlyPersonality ? 0.15 : 0.05));
        const eyeRot = rf.eyeShape === 'almond' ? -0.15 : 0;

        ctx.fillStyle = '#F5EDD8';
        [-1,1].forEach(side => {
            const ex = cx + side * eyeSpread;
            const eyeSh = ctx.createLinearGradient(ex, eyeY - eyeHf, ex, eyeY + eyeHf);
            eyeSh.addColorStop(0, alpha('#000000', 0.08)); eyeSh.addColorStop(0.5,'transparent');
            ctx.fillStyle = '#F5EDD8';
            ctx.beginPath();
            ctx.ellipse(ex, eyeY, eyeW, eyeHf, side * eyeRot, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = eyeSh; ctx.beginPath(); ctx.ellipse(ex, eyeY, eyeW, eyeHf, side * eyeRot, 0, Math.PI*2); ctx.fill();
        });

        // Irises
        [-1,1].forEach((side,idx) => {
            const ex = cx + side * eyeSpread;
            const irColor = idx === 0 ? eyeColorL : eyeColorR;
            const irisR = eyeW * 0.65;

            // Iris gradient
            const irG = ctx.createRadialGradient(ex - 1, eyeY - 1, 1, ex, eyeY, irisR);
            irG.addColorStop(0, blendHex(irColor,'#FFFFFF',0.3));
            irG.addColorStop(0.6, irColor);
            irG.addColorStop(1, blendHex(irColor,'#000000',0.4));
            ctx.fillStyle = irG;
            ctx.beginPath(); ctx.ellipse(ex, eyeY, irisR, eyeHf*0.88, side * eyeRot, 0, Math.PI*2); ctx.fill();

            // Iris detail lines
            ctx.strokeStyle = alpha(blendHex(irColor,'#000000',0.5), 0.35); ctx.lineWidth = 0.7;
            for (let d = 0; d < 8; d++) {
                const angle = d * Math.PI/4;
                ctx.beginPath();
                ctx.moveTo(ex + Math.cos(angle)*irisR*0.35, eyeY + Math.sin(angle)*eyeHf*0.35);
                ctx.lineTo(ex + Math.cos(angle)*irisR*0.92, eyeY + Math.sin(angle)*eyeHf*0.85);
                ctx.stroke();
            }

            // Pupil — reptile = vertical slit, others = round
            const pupilRx = rf.eyeShape === 'reptile' ? irisR * 0.12 : irisR * 0.34;
            const pupilRy = rf.eyeShape === 'reptile' ? eyeHf * 0.9 : eyeHf * 0.42;
            ctx.fillStyle = '#060608';
            ctx.beginPath(); ctx.ellipse(ex, eyeY, pupilRx, pupilRy, 0, 0, Math.PI*2); ctx.fill();

            // Highlights
            ctx.fillStyle = alpha('#FFFFFF', 0.85);
            ctx.beginPath(); ctx.ellipse(ex - irisR*0.28, eyeY - eyeHf*0.28, 2.5, 2, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = alpha('#FFFFFF', 0.4);
            ctx.beginPath(); ctx.ellipse(ex + irisR*0.2, eyeY + eyeHf*0.15, 1.2, 1, 0, 0, Math.PI*2); ctx.fill();
        });

        // Eyelids — race/gender differentiated
        [-1,1].forEach(side => {
            const ex = cx + side * eyeSpread;
            ctx.strokeStyle = skinDark; ctx.lineWidth = 1.6; ctx.lineCap = 'round';
            // Lower lid
            ctx.beginPath(); ctx.ellipse(ex, eyeY + eyeHf*0.1, eyeW, eyeHf, side * eyeRot, 0, Math.PI); ctx.stroke();
            // Upper lid — thicker for female
            ctx.lineWidth = isFemale ? 2.6 : 2.0;
            ctx.beginPath();
            if (rf.eyeShape === 'almond') {
                ctx.moveTo(ex - side * eyeW, eyeY + eyeHf*0.1);
                ctx.quadraticCurveTo(ex, eyeY - eyeHf - eyeLid*FH*0.25, ex + side*eyeW*0.9, eyeY - eyeHf*0.4);
            } else {
                ctx.moveTo(ex - eyeW, eyeY);
                ctx.quadraticCurveTo(ex, eyeY - eyeHf - eyeLid*FH*0.25, ex + eyeW, eyeY);
            }
            ctx.stroke();
            // Lashes — longer/more for female and Elf
            const lashLen = isFemale ? 7 : (rf.eyeShape === 'almond' ? 5 : 4);
            const lashCount = isFemale ? 4 : 3;
            ctx.lineWidth = 1.4;
            for (let l = -lashCount; l <= lashCount; l++) {
                const lx = ex + l * eyeW/(lashCount+1);
                const ly = eyeY - eyeHf*0.7 - eyeLid*FH*0.1;
                const angle = -Math.PI/2 + (l * 0.22);
                ctx.beginPath();
                ctx.moveTo(lx, ly);
                ctx.lineTo(lx + Math.cos(angle)*lashLen, ly + Math.sin(angle)*lashLen);
                ctx.stroke();
            }
        });

        // Eyepatch from physicalTraits
        if (hasEyepatch) {
            const patchSide = rng() > 0.5 ? -1 : 1;
            const px = cx + patchSide * eyeSpread;
            ctx.fillStyle = '#1A0A04';
            ctx.beginPath(); ctx.ellipse(px, eyeY, eyeW + 5, eyeHf + 4, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#4A2010'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.ellipse(px, eyeY, eyeW + 5, eyeHf + 4, 0, 0, Math.PI*2); ctx.stroke();
            // Strap
            ctx.strokeStyle = '#2A1008'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(px - eyeW - 5, eyeY); ctx.lineTo(cx - FW/2 - 4, eyeY - 3); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(px + eyeW + 5, eyeY); ctx.lineTo(cx + FW/2 + 4, eyeY - 2); ctx.stroke();
        }

        // Bags under eyes for old
        if (isOld) {
            ctx.strokeStyle = alpha(skinDark, 0.2); ctx.lineWidth = 1;
            [-1,1].forEach(side => {
                const ex = cx + side * eyeSpread;
                ctx.beginPath(); ctx.arc(ex, eyeY + eyeHf + 3, eyeW*0.7, 0, Math.PI); ctx.stroke();
            });
        }
    }
    drawEyes();

    // ---------- NOSE ----------
    function drawNose() {
        if (rf.snout) return;
        const noseY  = headCY + FH*0.1;
        const noseW  = rf.bigNose ? 18 : (rf.wide ? 15 : (isFemale ? 10 : 13));
        const noseH  = 26;

        // Bridge
        ctx.strokeStyle = alpha(skinMid, 0.6); ctx.lineWidth = 1; ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(cx - 4, noseY - noseH*0.6);
        ctx.quadraticCurveTo(cx - noseW*0.55, noseY - noseH*0.1, cx - noseW*0.55, noseY + 2);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(cx + 4, noseY - noseH*0.6);
        ctx.quadraticCurveTo(cx + noseW*0.55, noseY - noseH*0.1, cx + noseW*0.55, noseY + 2);
        ctx.stroke();

        // Tip / ball
        const tipG = ctx.createRadialGradient(cx - noseW*0.1, noseY, 2, cx, noseY + 2, noseW*0.7);
        tipG.addColorStop(0, skinLight); tipG.addColorStop(1, skinMid);
        ctx.fillStyle = tipG;
        ctx.beginPath(); ctx.ellipse(cx, noseY, noseW*0.58, noseW*0.42, 0, 0, Math.PI*2); ctx.fill();

        // Nostrils
        ctx.fillStyle = alpha(skinDark, 0.55);
        ctx.beginPath(); ctx.ellipse(cx - noseW*0.5, noseY + 2, noseW*0.32, noseW*0.22, -0.2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(cx + noseW*0.5, noseY + 2, noseW*0.32, noseW*0.22, 0.2, 0, Math.PI*2); ctx.fill();

        // Highlight
        ctx.fillStyle = alpha(skinLight, 0.5);
        ctx.beginPath(); ctx.ellipse(cx - noseW*0.2, noseY - 3, 4, 5, -0.3, 0, Math.PI*2); ctx.fill();
    }
    drawNose();

    // ---------- MOUTH ----------
    function drawMouth() {
        if (rf.snout) {
            // Dragonborn nostrils on snout
            ctx.fillStyle = alpha(skinDark, 0.7);
            ctx.beginPath(); ctx.ellipse(cx - 10, headCY + FH*0.25, 6, 5, -0.2, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(cx + 10, headCY + FH*0.25, 6, 5, 0.2, 0, Math.PI*2); ctx.fill();
            return;
        }
        const mY = headCY + FH*0.3;
        const mW = rf.wide ? 30 : rf.small ? 20 : (isFemale ? 24 : 28);
        const lipColor = isFemale ? blendHex(skinColor,'#C06060',0.4) : blendHex(skinColor,'#804040',0.2);
        const lipDark  = blendHex(lipColor,'#000000',0.3);

        // Expression curve
        const smile = isKindPersonality ? 8 : (isAngryPersonality ? -4 : (isSlyPersonality ? 3 : ri(-1, 5)));

        // Upper lip
        ctx.fillStyle = lipColor;
        ctx.beginPath();
        ctx.moveTo(cx - mW*0.9, mY);
        ctx.quadraticCurveTo(cx - mW*0.5, mY - 6, cx - mW*0.18, mY - 3);
        ctx.lineTo(cx, mY - 4);
        ctx.lineTo(cx + mW*0.18, mY - 3);
        ctx.quadraticCurveTo(cx + mW*0.5, mY - 6, cx + mW*0.9, mY);
        ctx.quadraticCurveTo(cx, mY + smile/2, cx - mW*0.9, mY);
        ctx.fill();

        // Lower lip
        ctx.fillStyle = blendHex(lipColor,'#FFFFFF',0.08);
        ctx.beginPath();
        ctx.moveTo(cx - mW*0.9, mY);
        ctx.quadraticCurveTo(cx, mY + smile + 10, cx + mW*0.9, mY);
        ctx.quadraticCurveTo(cx, mY + smile + 4, cx - mW*0.9, mY);
        ctx.fill();

        // Lip highlight
        ctx.fillStyle = alpha('#FFFFFF', 0.25);
        ctx.beginPath(); ctx.ellipse(cx, mY + smile/2 + 5, mW*0.32, 3, 0, 0, Math.PI*2); ctx.fill();

        // Mouth line
        ctx.strokeStyle = lipDark; ctx.lineWidth = 1.5; ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(cx - mW*0.9, mY);
        ctx.quadraticCurveTo(cx, mY + smile, cx + mW*0.9, mY);
        ctx.stroke();

        // Corner indents
        ctx.strokeStyle = alpha(lipDark, 0.6); ctx.lineWidth = 1;
        [-1,1].forEach(side => {
            ctx.beginPath(); ctx.arc(cx + side*mW*0.9, mY, 2, 0, Math.PI*2); ctx.stroke();
        });

        // Tusks (Half-Orc)
        if (rf.tusks) {
            ctx.fillStyle = blendHex('#F8F0D0','#000000',0.05);
            [-1,1].forEach(side => {
                ctx.beginPath();
                ctx.moveTo(cx + side*6, mY + 2);
                ctx.bezierCurveTo(cx + side*9, mY + 8, cx + side*8, mY + 18, cx + side*5, mY + 22);
                ctx.bezierCurveTo(cx + side*3, mY + 18, ctx.side*4 || cx + side*4, mY + 8, cx + side*3, mY + 2);
                ctx.closePath(); ctx.fill();
                ctx.strokeStyle = alpha('#C0A070', 0.5); ctx.lineWidth = 0.8; ctx.stroke();
            });
        }
        // Fangs (Dragonborn)
        if (rf.fangs) {
            ctx.fillStyle = '#F0ECD0';
            [-1,1].forEach(side => {
                ctx.beginPath();
                ctx.moveTo(cx + side*10, mY);
                ctx.lineTo(cx + side*14, mY + 14);
                ctx.lineTo(cx + side*6, mY);
                ctx.closePath(); ctx.fill();
            });
        }
    }
    drawMouth();

    // ---------- FINE FACIAL DETAILS ----------
    function drawFineDetails() {
        if (rf.snout) return;
        const eyeY = headCY - FH*0.08;
        const noseY = headCY + FH*0.1;
        const mY = headCY + FH*0.3;

        // Philtrum (groove above lip)
        ctx.strokeStyle = alpha(skinDark, 0.22); ctx.lineWidth = 1; ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(cx - 4, noseY + 8);
        ctx.lineTo(cx - 5, mY - 5);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(cx + 4, noseY + 8);
        ctx.lineTo(cx + 5, mY - 5);
        ctx.stroke();

        // Chin dimple / cleft (male more often)
        if (rng() > (isFemale ? 0.85 : 0.6)) {
            ctx.strokeStyle = alpha(skinDark, 0.18); ctx.lineWidth = 1.2;
            ctx.beginPath(); ctx.arc(cx, headCY + FH*0.48, 6, 0.2, Math.PI-0.2); ctx.stroke();
        }

        // Cheekbone highlight
        [-1, 1].forEach(side => {
            const chX = cx + side * FW * 0.34;
            const chY = headCY - FH * 0.02;
            const chG = ctx.createRadialGradient(chX, chY, 2, chX, chY, isFemale ? 18 : 14);
            chG.addColorStop(0, alpha('#FFFFFF', isFemale ? 0.14 : 0.08));
            chG.addColorStop(1, 'transparent');
            ctx.fillStyle = chG; ctx.fillRect(0, 0, W, H);
        });

        // Under-eye shadow
        [-1, 1].forEach(side => {
            const ex = cx + side * FW * 0.24;
            const ueSh = ctx.createRadialGradient(ex, eyeY + 10, 2, ex, eyeY + 12, 14);
            ueSh.addColorStop(0, alpha(skinDark, isOld ? 0.18 : 0.08));
            ueSh.addColorStop(1, 'transparent');
            ctx.fillStyle = ueSh; ctx.fillRect(0, 0, W, H);
        });

        // Female makeup: eye shadow
        if (isFemale) {
            const makeupColor = rp(['#6040A0','#204080','#802040','#408040','#804020','#208080']);
            [-1, 1].forEach(side => {
                const ex = cx + side * FW * 0.24;
                const esG = ctx.createRadialGradient(ex, eyeY - 4, 2, ex, eyeY - 6, 16);
                esG.addColorStop(0, alpha(makeupColor, 0.22));
                esG.addColorStop(1, 'transparent');
                ctx.fillStyle = esG; ctx.fillRect(0, 0, W, H);
            });
            // Female lip gloss highlight
            const lipGloss = ctx.createLinearGradient(cx - 14, mY + 3, cx + 14, mY + 10);
            lipGloss.addColorStop(0, 'transparent');
            lipGloss.addColorStop(0.5, alpha('#FFFFFF', 0.35));
            lipGloss.addColorStop(1, 'transparent');
            ctx.fillStyle = lipGloss;
            ctx.beginPath(); ctx.ellipse(cx, mY + 7, 14, 4, 0, 0, Math.PI*2); ctx.fill();
        }

        // Fine skin pores / micro texture
        ctx.globalAlpha = 0.025;
        for (let i = 0; i < 80; i++) {
            const px = cx + ri(-FW*0.42, FW*0.42);
            const py = headCY + ri(-FH*0.45, FH*0.5);
            const dist = Math.abs((px-cx)/(FW*0.5)) + Math.abs((py-headCY)/(FH*0.52));
            if (dist < 1.0) {
                ctx.fillStyle = rng() > 0.5 ? skinDark : skinLight;
                ctx.fillRect(px, py, 1, 1);
            }
        }
        ctx.globalAlpha = 1;

        // Nose bridge shadow line
        ctx.strokeStyle = alpha(skinMid, 0.3); ctx.lineWidth = 0.8;
        ctx.beginPath();
        ctx.moveTo(cx, headCY - FH*0.28);
        ctx.lineTo(cx, noseY - 8);
        ctx.stroke();

        // Brow bone shadow
        [-1, 1].forEach(side => {
            const bx = cx + side * FW * 0.18;
            const bSh = ctx.createLinearGradient(bx, headCY - FH*0.2, bx, headCY - FH*0.08);
            bSh.addColorStop(0, alpha(skinDark, 0.12));
            bSh.addColorStop(1, 'transparent');
            ctx.fillStyle = bSh; ctx.fillRect(0, 0, W, H);
        });

        // Jawline definition — heavier for square jaw races, softer for female
        const jawSh = ctx.createLinearGradient(cx, headCY + FH*0.38, cx, headCY + FH*0.58);
        jawSh.addColorStop(0, 'transparent');
        jawSh.addColorStop(1, alpha(skinDark, jawTypeEff === 'square' ? 0.25 : (isFemale ? 0.08 : 0.16)));
        ctx.fillStyle = jawSh; ctx.fillRect(0, 0, W, H);
        // Square jaw corner accents (Dwarf/Half-Orc)
        if (jawTypeEff === 'square') {
            [-1,1].forEach(side => {
                const jx = cx + side * FW * 0.42;
                const jy = headCY + FH * 0.46;
                const jG = ctx.createRadialGradient(jx, jy, 1, jx, jy, 14);
                jG.addColorStop(0, alpha(skinDark, 0.22));
                jG.addColorStop(1, 'transparent');
                ctx.fillStyle = jG; ctx.fillRect(0, 0, W, H);
            });
        }
        // Pointed chin highlight for female/Elf
        if (jawTypeEff === 'pointed' || isFemale) {
            const chinG = ctx.createRadialGradient(cx, headCY + FH*0.55, 1, cx, headCY + FH*0.54, 10);
            chinG.addColorStop(0, alpha(skinLight, 0.25));
            chinG.addColorStop(1, 'transparent');
            ctx.fillStyle = chinG; ctx.fillRect(0, 0, W, H);
        }

        // Subtle cheek hollow (more pronounced on thin/angular faces)
        if (!rf.wide && rng() > 0.5) {
            [-1, 1].forEach(side => {
                const hX = cx + side * FW * 0.38;
                const hY = headCY + FH * 0.16;
                const hG = ctx.createRadialGradient(hX, hY, 2, hX, hY, 20);
                hG.addColorStop(0, alpha(skinDark, 0.12));
                hG.addColorStop(1, 'transparent');
                ctx.fillStyle = hG; ctx.fillRect(0, 0, W, H);
            });
        }
    }
    drawFineDetails();

    // ---------- BEARD ----------
    function drawBeard() {
        if (isFemale) return; // females don't have beards
        const doBeard = rf.beard_chance > 0 && rng() < rf.beard_chance;
        if (!doBeard) return;
        const styles = rf.wide ? ['full','braided_dwarf','forked','long'] : ['stubble','goatee','mustache','short_beard','full','circle'];
        const bStyle = rp(styles);
        const bColor = isOld ? blendHex(hairColor,'#FFFFFF',0.7) : hairColor;
        const bDark  = blendHex(bColor,'#000000',0.3);
        const mY = headCY + FH*0.3;

        ctx.fillStyle = bColor; ctx.strokeStyle = bDark; ctx.lineWidth = 1; ctx.lineCap = 'round';

        if (bStyle === 'stubble') {
            ctx.globalAlpha = 0.35;
            for (let i = 0; i < 120; i++) {
                const bx = cx + ri(-FW*0.38, FW*0.38);
                const by = mY + ri(-8, 22);
                if (Math.abs(bx - cx)/FW*2 + Math.abs(by - mY)/(FH*0.35) < 1) {
                    ctx.fillStyle = bColor;
                    ctx.fillRect(bx, by, 1.2, ri(2,4));
                }
            }
            ctx.globalAlpha = 1;
        } else if (bStyle === 'goatee') {
            ctx.beginPath(); ctx.ellipse(cx, mY + 14, 14, 17, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx-18,mY-2); ctx.quadraticCurveTo(cx-9,mY-8,cx,mY-2); ctx.quadraticCurveTo(cx+9,mY-8,cx+18,mY-2); ctx.lineTo(cx+18,mY+2); ctx.quadraticCurveTo(cx,mY+5,cx-18,mY+2); ctx.fill(); ctx.stroke();
        } else if (bStyle === 'mustache') {
            ctx.beginPath();
            ctx.moveTo(cx-22,mY-2); ctx.bezierCurveTo(cx-12,mY-10,cx-5,mY-4,cx,mY-2);
            ctx.bezierCurveTo(cx+5,mY-4,cx+12,mY-10,cx+22,mY-2);
            ctx.quadraticCurveTo(cx+14,mY+5,cx,mY+3); ctx.quadraticCurveTo(cx-14,mY+5,cx-22,mY-2);
            ctx.fill(); ctx.stroke();
        } else if (bStyle === 'braided_dwarf') {
            ctx.beginPath();
            ctx.moveTo(cx - FW*0.42, mY - 4);
            ctx.bezierCurveTo(cx - FW*0.5, mY + 25, cx - FW*0.3, mY + 50, cx, mY + 68);
            ctx.bezierCurveTo(cx + FW*0.3, mY + 50, cx + FW*0.5, mY + 25, cx + FW*0.42, mY - 4);
            ctx.quadraticCurveTo(cx, mY - 12, cx - FW*0.42, mY - 4);
            ctx.fill(); ctx.stroke();
            // Braid weave
            ctx.strokeStyle = bDark; ctx.lineWidth = 2;
            for (let ys = mY + 8; ys < mY + 65; ys += 12) {
                ctx.beginPath(); ctx.moveTo(cx - 16, ys); ctx.lineTo(cx + 16, ys + 6); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx + 16, ys); ctx.lineTo(cx - 16, ys + 6); ctx.stroke();
            }
            // Beads
            [mY+22, mY+40, mY+58].forEach(by => {
                ctx.fillStyle = rp([cc.a,'#FFD700','#CC2020','#2020CC']);
                ctx.beginPath(); ctx.arc(cx, by, 5, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = alpha('#000',0.3); ctx.lineWidth=1; ctx.stroke();
            });
        } else { // full, short, circle
            const bH = bStyle==='circle' ? 20 : (bStyle==='short_beard' ? 30 : 55);
            ctx.beginPath();
            ctx.moveTo(cx - FW*0.44, mY - 5);
            ctx.bezierCurveTo(cx - FW*0.52, mY + bH*0.4, cx - FW*0.3, mY + bH, cx, mY + bH + 10);
            ctx.bezierCurveTo(cx + FW*0.3, mY + bH, cx + FW*0.52, mY + bH*0.4, cx + FW*0.44, mY - 5);
            ctx.quadraticCurveTo(cx, mY - 10, cx - FW*0.44, mY - 5);
            ctx.fill(); ctx.stroke();
            // Strands
            ctx.strokeStyle = alpha(bDark, 0.4); ctx.lineWidth = 1.5;
            for (let i = 0; i < 8; i++) {
                const bx = cx - FW*0.32 + i * FW*0.08;
                ctx.beginPath(); ctx.moveTo(bx, mY + 5); ctx.lineTo(bx + ri(-10,10), mY + bH + ri(5,15)); ctx.stroke();
            }
        }
    }
    drawBeard();

    // ---------- HAIR FRONT ----------
    function drawHairFront() {
        if (hairStyle === 'bald') return;
        ctx.fillStyle = hairColor;
        const topY = headCY - FH*0.5;

        const hairG = ctx.createLinearGradient(cx - FW*0.2, topY, cx + FW*0.2, topY + 25);
        hairG.addColorStop(0, blendHex(hairColor,'#FFFFFF',0.18));
        hairG.addColorStop(1, hairColor);

        if (hairStyle === 'shaved') {
            // Just a shadow of short growth
            ctx.globalAlpha = 0.15;
            ctx.fillStyle = hairColor;
            ctx.beginPath(); ctx.ellipse(cx, topY + 10, FW/2 + 5, 18, 0, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1;
        } else if (hairStyle === 'mohawk') {
            ctx.fillStyle = hairG;
            ctx.beginPath();
            ctx.moveTo(cx - 10, topY + 12);
            ctx.lineTo(cx - 12, topY - 42);
            ctx.lineTo(cx, topY - 65);
            ctx.lineTo(cx + 12, topY - 42);
            ctx.lineTo(cx + 10, topY + 12);
            ctx.closePath(); ctx.fill();
        } else if (hairStyle === 'topknot') {
            ctx.fillStyle = hairG;
            ctx.beginPath(); ctx.ellipse(cx, topY + 2, FW/2 + 6, 14, 0, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(cx, topY - 20, 18, 26, 0, 0, Math.PI*2); ctx.fill();
            // Bun wrap
            ctx.strokeStyle = hairDark; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.ellipse(cx, topY - 20, 18, 26, 0, 0, Math.PI*2); ctx.stroke();
        } else if (hairStyle === 'afro') {
            ctx.fillStyle = hairColor;
            ctx.beginPath(); ctx.ellipse(cx, topY - 5, FW/2 + 30, FH*0.55, 0, 0, Math.PI*2); ctx.fill();
            // Texture dots
            ctx.fillStyle = hairDark;
            for (let i = 0; i < 80; i++) {
                const ax = cx + ri(-FW/2-25, FW/2+25);
                const ay = topY - 5 + ri(-FH*0.5, FH*0.45);
                const d = ((ax-cx)/(FW/2+30))**2 + ((ay-topY+5)/(FH*0.55))**2;
                if (d < 0.9) { ctx.beginPath(); ctx.arc(ax,ay,2,0,Math.PI*2); ctx.fill(); }
            }
        } else if (hairStyle === 'curly_short') {
            ctx.fillStyle = hairG;
            ctx.beginPath(); ctx.ellipse(cx, topY + 5, FW/2 + 8, 20, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = hairDark;
            for (let ci = 0; ci < 20; ci++) {
                const cx2 = cx + ri(-FW*0.35, FW*0.35);
                const cy2 = topY + ri(-2, 18);
                ctx.beginPath(); ctx.arc(cx2, cy2, ri(4,8), 0, Math.PI*2); ctx.fill();
            }
        } else if (hairStyle === 'dreadlocks') {
            ctx.fillStyle = hairG;
            ctx.beginPath(); ctx.ellipse(cx, topY + 5, FW/2 + 8, 18, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = hairDark; ctx.lineWidth = 5; ctx.lineCap = 'round';
            for (let d = 0; d < 8; d++) {
                const dx = cx - FW*0.35 + d * FW*0.1;
                ctx.beginPath();
                ctx.moveTo(dx, topY + 14);
                ctx.bezierCurveTo(dx + ri(-10,10), topY + 50, dx + ri(-15,15), topY + 80, dx + ri(-8,8), topY + 110);
                ctx.stroke();
            }
        } else if (hairStyle === 'swept_back') {
            ctx.fillStyle = hairG;
            ctx.beginPath();
            ctx.moveTo(cx - FW/2 - 4, topY + 22);
            ctx.bezierCurveTo(cx - FW/2 - 12, topY, cx + FW*0.1, topY - 22, cx + FW/2 + 2, topY + 8);
            ctx.lineTo(cx + FW/2 + 4, topY + 22);
            ctx.bezierCurveTo(cx + FW*0.2, topY + 6, cx - FW*0.3, topY + 12, cx - FW/2 - 4, topY + 22);
            ctx.fill();
        } else if (hairStyle === 'undercut') {
            ctx.fillStyle = hairG;
            ctx.beginPath();
            ctx.moveTo(cx - FW/2, topY + 22);
            ctx.bezierCurveTo(cx - FW/2 - 5, topY, cx - FW*0.2, topY - 18, cx + FW*0.1, topY + 5);
            ctx.lineTo(cx + FW/2, topY + 22);
            ctx.quadraticCurveTo(cx, topY + 10, cx - FW/2, topY + 22);
            ctx.fill();
        } else if (hairStyle === 'medium_wavy') {
            ctx.fillStyle = hairG;
            ctx.beginPath();
            ctx.moveTo(cx - FW/2 - 4, topY + 25);
            let wx = -FW/2 - 4;
            while (wx < FW/2 + 4) {
                const wave = Math.sin((wx + FW/2) * 0.12) * 8;
                ctx.lineTo(cx + wx, topY - 8 + wave);
                wx += 6;
            }
            ctx.lineTo(cx + FW/2 + 4, topY + 25);
            ctx.bezierCurveTo(cx + FW*0.3, topY + 10, cx - FW*0.3, topY + 10, cx - FW/2 - 4, topY + 25);
            ctx.fill();
        } else {
            // Default generic top
            ctx.fillStyle = hairG;
            ctx.beginPath();
            ctx.moveTo(cx - FW/2 - 4, topY + 22);
            ctx.bezierCurveTo(cx - FW/2 - 8, topY - 5, cx - FW*0.1, topY - 16, cx, topY - 14);
            ctx.bezierCurveTo(cx + FW*0.1, topY - 16, cx + FW/2 + 8, topY - 5, cx + FW/2 + 4, topY + 22);
            ctx.bezierCurveTo(cx + FW*0.45, topY + 6, cx - FW*0.45, topY + 6, cx - FW/2 - 4, topY + 22);
            ctx.fill();
        }

        // Hair sheen line
        ctx.strokeStyle = alpha(blendHex(hairColor,'#FFFFFF',0.5), 0.28); ctx.lineWidth = 3; ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(cx - FW*0.18, topY - 5);
        ctx.quadraticCurveTo(cx - FW*0.08, topY + 8, cx + FW*0.06, topY + 18);
        ctx.stroke();

        // Fine hair strands for realism
        ctx.strokeStyle = alpha(blendHex(hairColor,'#FFFFFF',0.25), 0.22); ctx.lineWidth = 1; ctx.lineCap = 'round';
        for (let hs = 0; hs < 12; hs++) {
            const hsx = cx + ri(-FW*0.38, FW*0.38);
            ctx.beginPath();
            ctx.moveTo(hsx, topY + ri(0, 20));
            ctx.quadraticCurveTo(hsx + ri(-12,12), topY + ri(5,22), hsx + ri(-8,8), topY + ri(10, 28));
            ctx.stroke();
        }
        // Dark strand shadows
        ctx.strokeStyle = alpha(hairDark, 0.18); ctx.lineWidth = 1.2;
        for (let hs = 0; hs < 8; hs++) {
            const hsx = cx + ri(-FW*0.3, FW*0.3);
            ctx.beginPath();
            ctx.moveTo(hsx, topY + ri(2, 18));
            ctx.lineTo(hsx + ri(-6,6), topY + ri(12, 26));
            ctx.stroke();
        }

        // Hairline / widow's peak
        if (!['bald','shaved','mohawk','topknot','afro'].includes(hairStyle) && rng() > 0.55) {
            ctx.fillStyle = hairColor;
            ctx.beginPath();
            ctx.moveTo(cx, topY + 15);
            ctx.lineTo(cx - 10, topY + 23);
            ctx.lineTo(cx + 10, topY + 23);
            ctx.closePath(); ctx.fill();
        }
    }
    drawHairFront();

    // ---------- ACCESSORIES / CLASS FEATURES ----------
    function drawAccessories() {
        const topY = headCY - FH*0.5;

        if (npc.class === 'Wizard' && rng() > 0.45) {
            // Tall hat
            ctx.fillStyle = cc.p;
            const hatBrimW = FW*0.6 + 12, hatH = FH*0.65;
            ctx.beginPath(); ctx.moveTo(cx - 14, topY + 12); ctx.lineTo(cx - hatBrimW/2 + 8, topY - hatH); ctx.lineTo(cx + hatBrimW/2 - 8, topY - hatH); ctx.lineTo(cx + 14, topY + 12); ctx.closePath(); ctx.fill();
            ctx.fillStyle = cc.s;
            ctx.beginPath(); ctx.ellipse(cx, topY + 12, hatBrimW/2, 12, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = alpha(cc.a, 0.7); ctx.lineWidth = 2;
            ctx.beginPath(); ctx.ellipse(cx, topY + 12, hatBrimW/2, 12, 0, 0, Math.PI*2); ctx.stroke();
            // Stars
            ctx.fillStyle = alpha(cc.a, 0.8); ctx.font = '12px serif';
            ['✦','★','✧','⊕'].forEach((s,i) => ctx.fillText(s, cx + ri(-20,20), topY - ri(10, hatH*0.8)));
        }
        if ((npc.class === 'Paladin' || npc.class === 'Cleric') && rng() > 0.45) {
            if (rng() > 0.5) {
                // Halo
                ctx.strokeStyle = alpha(cc.a, 0.85); ctx.lineWidth = 4;
                ctx.shadowColor = cc.a; ctx.shadowBlur = 14;
                ctx.beginPath(); ctx.ellipse(cx, topY - 6, FW*0.54 + 4, 11, 0, 0, Math.PI*2); ctx.stroke();
                ctx.shadowBlur = 0;
            } else {
                // Helmet
                ctx.fillStyle = cc.p;
                ctx.beginPath(); ctx.ellipse(cx, topY, FW/2 + 12, 26, 0, Math.PI, Math.PI*2); ctx.fill();
                ctx.fillStyle = cc.s;
                ctx.beginPath(); ctx.rect(cx - 5, topY - 24, 10, 28); ctx.fill();
                // Rim
                ctx.strokeStyle = alpha(cc.a, 0.6); ctx.lineWidth = 2;
                ctx.beginPath(); ctx.ellipse(cx, topY, FW/2 + 12, 26, 0, Math.PI, Math.PI*2); ctx.stroke();
            }
        }
        if (['Ranger','Rogue','Druid'].includes(npc.class) && rng() > 0.45) {
            // Hood
            ctx.fillStyle = alpha(cc.s, 0.88);
            ctx.beginPath();
            ctx.moveTo(cx - FW/2 - 14, topY + 28);
            ctx.bezierCurveTo(cx - FW/2 - 18, topY - 8, cx - FW*0.2, topY - 32, cx, topY - 20);
            ctx.bezierCurveTo(cx + FW*0.2, topY - 32, cx + FW/2 + 18, topY - 8, cx + FW/2 + 14, topY + 28);
            ctx.bezierCurveTo(cx + FW*0.5, topY + 8, cx - FW*0.5, topY + 8, cx - FW/2 - 14, topY + 28);
            ctx.fill();
            ctx.strokeStyle = alpha(cc.p, 0.5); ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(cx, topY - 20); ctx.lineTo(cx, topY + 32); ctx.stroke();
        }
        if (npc.class === 'Barbarian' && rng() > 0.4) {
            // War paint
            const wpColor = rp(['#CC2020','#2020CC','#204020','#CC6020','#602060']);
            ctx.fillStyle = alpha(wpColor, 0.55);
            const patterns = ri(1,4);
            if (patterns === 1) { // horizontal stripe
                ctx.beginPath(); ctx.rect(cx - FW*0.42, headCY - FH*0.06, FW*0.84, 8); ctx.fill();
            } else if (patterns === 2) { // diagonal
                ctx.lineWidth = 5; ctx.strokeStyle = alpha(wpColor, 0.55); ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(cx - FW*0.38, headCY - FH*0.25); ctx.lineTo(cx + FW*0.15, headCY + FH*0.1); ctx.stroke();
            } else if (patterns === 3) { // dots
                for (let d = 0; d < 5; d++) {
                    ctx.beginPath(); ctx.arc(cx - FW*0.3 + d*FW*0.15, headCY - FH*0.05, 4, 0, Math.PI*2); ctx.fill();
                }
            } else { // cross on forehead
                ctx.lineWidth = 6; ctx.strokeStyle = alpha(wpColor, 0.55); ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(cx, headCY - FH*0.4); ctx.lineTo(cx, headCY - FH*0.2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx - 12, headCY - FH*0.3); ctx.lineTo(cx + 12, headCY - FH*0.3); ctx.stroke();
            }
        }
        if (npc.class === 'Druid' && rng() > 0.5) {
            // Leaf crown
            const leafColors = ['#1A4A2A','#2D6A4F','#52B788','#40916C','#1B4332'];
            for (let l = 0; l < 9; l++) {
                const lx = cx - FW*0.44 + l * FW*0.11;
                const ly = topY + ri(-18, -2);
                ctx.fillStyle = rp(leafColors);
                ctx.beginPath(); ctx.ellipse(lx, ly, ri(7,11), ri(14,22), -0.5 + l*0.12, 0, Math.PI*2); ctx.fill();
            }
            // Vines
            ctx.strokeStyle = '#2D6A4F'; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(cx - FW*0.44, topY + 4); ctx.bezierCurveTo(cx - FW*0.2, topY - 5, cx + FW*0.2, topY - 5, cx + FW*0.44, topY + 4); ctx.stroke();
        }
        if (isBoss && rng() > 0.35) {
            // Crown
            ctx.fillStyle = '#B8860B';
            const cw = FW*0.52, ch = 26, cy2 = topY - 4;
            ctx.beginPath();
            ctx.moveTo(cx - cw/2, cy2 + ch/2);
            for (let pt = 0; pt <= 6; pt++) {
                const px = cx - cw/2 + pt * cw/6;
                const py = pt % 2 === 0 ? cy2 + ch/2 : cy2 - ch/2;
                ctx.lineTo(px, py);
            }
            ctx.lineTo(cx + cw/2, cy2 + ch/2);
            ctx.closePath(); ctx.fill();
            ctx.strokeStyle = '#8B6900'; ctx.lineWidth = 1.5; ctx.stroke();
            // Jewels
            [{x:cx,c:'#FF0000'},{x:cx-cw/3,c:'#0000AA'},{x:cx+cw/3,c:'#00AA00'}].forEach(({x,c}) => {
                ctx.fillStyle = c; ctx.beginPath(); ctx.arc(x, cy2 - ch/2 + 6, 5, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = alpha('#FFFFFF',0.5); ctx.beginPath(); ctx.arc(x-2, cy2-ch/2+4, 2, 0, Math.PI*2); ctx.fill();
            });
        }
        if (npc.class === 'Warlock') {
            // Arcane eye glow
            const eyeY = headCY - FH*0.08;
            [-1,1].forEach(side => {
                const eg = ctx.createRadialGradient(cx+side*FW*0.24, eyeY, 3, cx+side*FW*0.24, eyeY, 20);
                eg.addColorStop(0, alpha(cc.a, isBoss ? 0.5 : 0.25)); eg.addColorStop(1,'transparent');
                ctx.fillStyle = eg; ctx.fillRect(0,0,W,H);
            });
        }
        // Facial tattoo from physicalTraits
        if (hasTattoo) {
            const tColor = rp(['#1A2A5A','#1A5A2A','#5A1A1A','#2A1A5A']);
            ctx.strokeStyle = alpha(tColor, 0.6); ctx.lineWidth = 1.8; ctx.lineCap = 'round';
            const tSide = rng() > 0.5 ? -1 : 1;
            const tx = cx + tSide * FW*0.3;
            // Dragon tattoo winding up
            ctx.beginPath();
            ctx.moveTo(tx, headCY + FH*0.1);
            for (let ty = headCY + FH*0.1; ty > headCY - FH*0.4; ty -= 10) {
                ctx.lineTo(tx + Math.sin((headCY + FH*0.1 - ty) * 0.18) * 12 * tSide, ty);
            }
            ctx.stroke();
            // Small scales
            ctx.strokeStyle = alpha(tColor, 0.4); ctx.lineWidth = 1;
            for (let sr = 0; sr < 5; sr++) {
                ctx.beginPath(); ctx.arc(tx + ri(-8,8), headCY - FH*0.05 - sr*14, 4, 0.4, Math.PI-0.4); ctx.stroke();
            }
        }
        // Scar from physicalTraits
        if (hasScar) {
            ctx.strokeStyle = alpha(blendHex(skinColor,'#CC6060',0.55), 0.65);
            ctx.lineWidth = 2.5; ctx.lineCap = 'round';
            const scarType = rng();
            if (scarType < 0.33) {
                // Diagonal face scar
                const sx1 = cx + FW*0.1, sy1 = headCY - FH*0.3;
                ctx.beginPath(); ctx.moveTo(sx1, sy1); ctx.lineTo(sx1 + 22, sy1 + 38); ctx.stroke();
                ctx.lineWidth = 1; ctx.strokeStyle = alpha('#FFFFFF', 0.3);
                ctx.beginPath(); ctx.moveTo(sx1 + 1, sy1); ctx.lineTo(sx1 + 23, sy1 + 38); ctx.stroke();
            } else if (scarType < 0.66) {
                // X scar
                const sx = cx - FW*0.2, sy = headCY;
                ctx.beginPath(); ctx.moveTo(sx - 12, sy - 16); ctx.lineTo(sx + 12, sy + 16); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(sx + 12, sy - 16); ctx.lineTo(sx - 12, sy + 16); ctx.stroke();
            } else {
                // Burn scar
                ctx.strokeStyle = alpha(blendHex(skinColor,'#A05020',0.45), 0.5);
                for (let bs = 0; bs < 8; bs++) {
                    ctx.beginPath();
                    ctx.moveTo(cx - FW*0.35 + ri(-5,5), headCY + FH*0.15 + ri(-10,10));
                    ctx.lineTo(cx - FW*0.15 + ri(-8,8), headCY + FH*0.25 + ri(-10,10));
                    ctx.stroke();
                }
            }
        }
        // Neck jewellery
        if (rng() > 0.7) {
            const njColor = rp([cc.a,'#FFD700','#C0C0C0','#CC2020']);
            ctx.strokeStyle = njColor; ctx.lineWidth = 1.8;
            const nyY = headCY + FH*0.44 + 10;
            ctx.beginPath(); ctx.arc(cx, nyY, 18, Math.PI * 0.15, Math.PI * 0.85); ctx.stroke();
            ctx.fillStyle = njColor;
            ctx.beginPath(); ctx.arc(cx, nyY + 18, 4, 0, Math.PI*2); ctx.fill();
        }
        // Forehead gem / marking
        if (npc.race === 'Tiefling' && rng() > 0.5) {
            ctx.fillStyle = rp([cc.a,'#FF2020','#8020FF','#20A0FF']);
            ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.arc(cx, headCY - FH*0.38, 5, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
        }
    }
    drawAccessories();

    // ---------- ORNATE BORDER / FRAME ----------
    // Outer dark border
    ctx.strokeStyle = alpha('#000000', 0.7); ctx.lineWidth = 8;
    ctx.beginPath(); ctx.roundRect(2, 2, W-4, H-4, 6); ctx.stroke();
    // Second dark ring
    ctx.strokeStyle = alpha('#000000', 0.4); ctx.lineWidth = 3;
    ctx.beginPath(); ctx.roundRect(5, 5, W-10, H-10, 5); ctx.stroke();

    // Accent inner frame (class colored)
    const frameG = ctx.createLinearGradient(0,0,W,H);
    frameG.addColorStop(0, alpha(cc.a, 0.95));
    frameG.addColorStop(0.25, alpha(blendHex(cc.a,'#FFD700',0.4), 0.8));
    frameG.addColorStop(0.5, alpha(blendHex(cc.a,'#FFFFFF',0.2), 0.75));
    frameG.addColorStop(0.75, alpha(blendHex(cc.a,'#FFD700',0.4), 0.8));
    frameG.addColorStop(1, alpha(cc.a, 0.95));
    ctx.strokeStyle = frameG; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.roundRect(8, 8, W-16, H-16, 4); ctx.stroke();

    // Inner thin gold line
    ctx.strokeStyle = alpha('#B8860B', 0.5); ctx.lineWidth = 1;
    ctx.beginPath(); ctx.roundRect(12, 12, W-24, H-24, 3); ctx.stroke();

    // Side ornament lines with tick marks
    ctx.strokeStyle = alpha(cc.a, 0.4); ctx.lineWidth = 1;
    // Top and bottom center tick clusters
    [H*0.03, H*0.97].forEach(ty => {
        [cx-30, cx, cx+30].forEach(tx => {
            ctx.beginPath(); ctx.moveTo(tx, ty-3); ctx.lineTo(tx, ty+3); ctx.stroke();
        });
    });
    // Side tick clusters
    [W*0.03, W*0.97].forEach(tx => {
        [headCY-30, headCY, headCY+30].forEach(ty => {
            ctx.beginPath(); ctx.moveTo(tx-3, ty); ctx.lineTo(tx+3, ty); ctx.stroke();
        });
    });

    // Corner filigree - enhanced with multiple elements
    [[8,8],[W-8,8],[8,H-8],[W-8,H-8]].forEach(([ox,oy]) => {
        const isLeft = ox < W/2;
        const isTop  = oy < H/2;
        // Outer corner gem
        const gemG = ctx.createRadialGradient(ox, oy, 1, ox, oy, 7);
        gemG.addColorStop(0, blendHex(cc.a,'#FFFFFF',0.5));
        gemG.addColorStop(0.6, cc.a);
        gemG.addColorStop(1, blendHex(cc.a,'#000000',0.4));
        ctx.fillStyle = gemG;
        ctx.beginPath(); ctx.arc(ox,oy,7,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = alpha('#000000',0.5); ctx.lineWidth=1.2;
        ctx.beginPath(); ctx.arc(ox,oy,7,0,Math.PI*2); ctx.stroke();
        // Gem highlight
        ctx.fillStyle = alpha('#FFFFFF', 0.55);
        ctx.beginPath(); ctx.arc(ox - 2, oy - 2, 2.5, 0, Math.PI*2); ctx.fill();
        // Decorative arms extending from corner
        ctx.strokeStyle = alpha(cc.a, 0.7); ctx.lineWidth = 2; ctx.lineCap = 'round';
        const dx = isLeft ? 1 : -1, dy = isTop ? 1 : -1;
        ctx.beginPath(); ctx.moveTo(ox+dx*9, oy+dy*4); ctx.lineTo(ox+dx*30, oy+dy*4); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(ox+dx*4, oy+dy*9); ctx.lineTo(ox+dx*4, oy+dy*30); ctx.stroke();
        // Secondary arm (thinner)
        ctx.strokeStyle = alpha(cc.a, 0.4); ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(ox+dx*10, oy+dy*7); ctx.lineTo(ox+dx*24, oy+dy*7); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(ox+dx*7, oy+dy*10); ctx.lineTo(ox+dx*7, oy+dy*24); ctx.stroke();
        // Small diamond at arm ends
        ctx.fillStyle = alpha(cc.a, 0.7);
        [[ox+dx*30, oy+dy*4],[ox+dx*4, oy+dy*30]].forEach(([ex, ey]) => {
            ctx.beginPath();
            ctx.moveTo(ex, ey - 3); ctx.lineTo(ex + 3, ey); ctx.lineTo(ex, ey + 3); ctx.lineTo(ex - 3, ey); ctx.closePath();
            ctx.fill();
        });
    });

    // Mid-side decorative elements
    ctx.strokeStyle = alpha(cc.a, 0.35); ctx.lineWidth = 1.5; ctx.lineCap = 'round';
    // Left side
    ctx.beginPath(); ctx.moveTo(5, headCY - 20); ctx.lineTo(5, headCY + 20); ctx.stroke();
    ctx.beginPath(); ctx.arc(6, headCY, 4, 0, Math.PI*2);
    ctx.fillStyle = alpha(cc.a, 0.6); ctx.fill();
    // Right side
    ctx.beginPath(); ctx.moveTo(W-5, headCY - 20); ctx.lineTo(W-5, headCY + 20); ctx.stroke();
    ctx.beginPath(); ctx.arc(W-6, headCY, 4, 0, Math.PI*2);
    ctx.fill();

    // Vignette
    const vig = ctx.createRadialGradient(cx, H*0.42, H*0.15, cx, H*0.5, H*0.82);
    vig.addColorStop(0,'transparent'); vig.addColorStop(0.7, 'rgba(0,0,0,0.2)'); vig.addColorStop(1,'rgba(0,0,0,0.75)');
    ctx.fillStyle = vig; ctx.fillRect(0,0,W,H);

    // Boss lightning aura
    if (isBoss) {
        ctx.strokeStyle = alpha(cc.a, 0.18); ctx.lineWidth = 1.5;
        for (let li = 0; li < 6; li++) {
            let lx = ri(0, W), ly = 0;
            ctx.beginPath(); ctx.moveTo(lx, ly);
            for (let ls = 0; ls < 10; ls++) { lx += ri(-22,22); ly += ri(30,60); ctx.lineTo(lx, ly); }
            ctx.stroke();
        }
        // Boss aura glow on frame
        ctx.strokeStyle = alpha(cc.a, 0.3); ctx.lineWidth = 3;
        ctx.shadowColor = cc.a; ctx.shadowBlur = 12;
        ctx.beginPath(); ctx.roundRect(4, 4, W-8, H-8, 5); ctx.stroke();
        ctx.shadowBlur = 0;
    }

    return canvas.toDataURL('image/png');
}




console.log("✨ All features loaded: Damage rolling, quest generation, enhanced equipment!");

/* ══════════════════════════════════════════════════════════════════════
   BACKGROUND PARTICLE SYSTEM (main app)
   ══════════════════════════════════════════════════════════════════════ */
(function() {
    const bc   = document.getElementById('bg-particles');
    if (!bc) return;
    const bctx = bc.getContext('2d');
    let bparts = [];
    let bW = 0, bH = 0;

    function bresize() {
        bW = bc.width  = window.innerWidth;
        bH = bc.height = window.innerHeight;
    }
    bresize();
    window.addEventListener('resize', bresize);

    for (let i = 0; i < 55; i++) {
        bparts.push({
            x: Math.random() * window.innerWidth,
            y: Math.random() * window.innerHeight,
            r: Math.random() * 1.6 + 0.3,
            vx: (Math.random() - 0.5) * 0.18,
            vy: -(Math.random() * 0.28 + 0.06),
            alpha: Math.random() * 0.45 + 0.08,
            color: Math.random() > 0.6 ? '#b8860b' : (Math.random() > 0.5 ? '#8b0000' : '#daa520'),
            life: Math.random(), decay: Math.random() * 0.0015 + 0.0005
        });
    }

    function bframe() {
        bctx.clearRect(0, 0, bW, bH);
        bparts.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life -= p.decay;
            if (p.life <= 0 || p.y < -8) {
                bparts[i] = {
                    x: Math.random() * bW, y: bH + 5,
                    r: Math.random() * 1.6 + 0.3,
                    vx: (Math.random() - 0.5) * 0.18,
                    vy: -(Math.random() * 0.28 + 0.06),
                    alpha: Math.random() * 0.45 + 0.08,
                    color: Math.random() > 0.6 ? '#b8860b' : (Math.random() > 0.5 ? '#8b0000' : '#daa520'),
                    life: 1, decay: Math.random() * 0.0015 + 0.0005
                };
                return;
            }
            bctx.save();
            bctx.globalAlpha = p.alpha * p.life;
            bctx.fillStyle = p.color;
            bctx.shadowColor = p.color;
            bctx.shadowBlur = 4;
            bctx.beginPath();
            bctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            bctx.fill();
            bctx.restore();
        });
        requestAnimationFrame(bframe);
    }
    bframe();
})();

/* ══════════════════════════════════════════════════════════════════════
   BUTTON RIPPLE EFFECT
   ══════════════════════════════════════════════════════════════════════ */
document.addEventListener('click', function(e) {
    const btn = e.target.closest('button.btn-gen, button.btn-small');
    if (!btn) return;
    const rect = btn.getBoundingClientRect();
    const ripple = document.createElement('span');
    ripple.className = 'btn-ripple-overlay';
    const size = Math.max(rect.width, rect.height) * 1.4;
    ripple.style.cssText = `width:${size}px;height:${size}px;left:${e.clientX-rect.left-size/2}px;top:${e.clientY-rect.top-size/2}px`;
    btn.style.overflow = 'hidden';
    btn.appendChild(ripple);
    setTimeout(() => ripple.remove(), 650);
});


/* ════════════════════════════════════════════════════════════════════════
   NEW FEATURES — All added cleanly. Original code untouched.
   1.  Alignment generation + display
   2.  Languages per race
   3.  Dark / Light mode toggle
   4.  Roll History Log panel
   5.  NPC Search & Filter bar
   6.  NPC Edit Modal (stats, name, HP, AC etc.)
   7.  Encounter Difficulty Calculator
   8.  Random Encounter Generator
   9.  Party Tracker sidebar
   10. Session Notes / Campaign Log
   11. Legendary Resistance / Action tracker for bosses
   ════════════════════════════════════════════════════════════════════════ */

/* ── 1 & 2: Alignment + Languages ────────────────────────────────────── */
const ALIGNMENT_FULL = {
    LG:'Lawful Good', NG:'Neutral Good', CG:'Chaotic Good',
    LN:'Lawful Neutral', TN:'True Neutral', CN:'Chaotic Neutral',
    LE:'Lawful Evil',  NE:'Neutral Evil',  CE:'Chaotic Evil'
};

const CLASS_ALIGNMENT_BIAS = {
    Paladin:   ['LG','LG','NG','LG','NG','LG'],
    Cleric:    ['LG','NG','LG','LN','NG','TN'],
    Fighter:   ['LN','LG','TN','CN','LN','TN'],
    Wizard:    ['LN','TN','NG','LG','LN','TN'],
    Rogue:     ['CN','TN','NE','CN','TN','CN'],
    Ranger:    ['NG','CG','TN','NG','CN','NG'],
    Barbarian: ['CN','TN','CE','CN','CG','CN'],
    Bard:      ['CG','CN','TN','NG','CG','TN'],
    Druid:     ['TN','NG','CN','TN','NG','TN'],
    Monk:      ['LN','LG','LN','TN','LN','LG'],
    Sorcerer:  ['CN','TN','NE','CE','CN','TN'],
    Warlock:   ['CN','NE','TN','LE','CE','NE'],
};

function generateAlignment(classKey, isBoss) {
    if (isBoss) return pick(['LE','NE','CE','CE','LE','NE','CN','LE']);
    const bias = CLASS_ALIGNMENT_BIAS[classKey];
    return bias ? pick(bias) : pick(Object.keys(ALIGNMENT_FULL));
}

const RACE_BASE_LANGUAGES = {
    'Human':     ['Common'],
    'Elf':       ['Common','Elvish'],
    'Half-Elf':  ['Common','Elvish'],
    'Dwarf':     ['Common','Dwarvish'],
    'Halfling':  ['Common','Halfling'],
    'Gnome':     ['Common','Gnomish'],
    'Half-Orc':  ['Common','Orc'],
    'Orc':       ['Common','Orc'],
    'Tiefling':  ['Common','Infernal'],
    'Dragonborn':['Common','Draconic'],
};

const EXTRA_LANGUAGES = ['Abyssal','Celestial','Deep Speech','Draconic','Dwarvish',
    'Elvish','Giant','Gnomish','Goblin','Infernal','Orc','Primordial','Sylvan','Undercommon'];

function generateLanguages(raceKey) {
    const base = RACE_BASE_LANGUAGES[raceKey]
        ? [...RACE_BASE_LANGUAGES[raceKey]]
        : ['Common'];
    if (Math.random() < 0.35) {
        const extras = EXTRA_LANGUAGES.filter(l => !base.includes(l));
        if (extras.length) base.push(pick(extras));
    }
    return base;
}

/* ── Patch createNPC to inject alignment + languages ─────────────────── */
/* We wrap it so original createNPC still runs; we just post-process */
(function() {
    const _orig = window.createNPC;
    if (!_orig) return;
    window.createNPC = function(forceBoss) {
        const npc = _orig(forceBoss);
        if (npc && !npc.alignment)  npc.alignment  = generateAlignment(npc.class, npc.isBoss);
        if (npc && !npc.languages)  npc.languages  = generateLanguages(npc.race);
        if (npc && npc.isBoss) {
            if (npc.legendaryResistances  === undefined) npc.legendaryResistances  = 3;
            if (npc.legendaryResistancesUsed === undefined) npc.legendaryResistancesUsed = 0;
            if (npc.legendaryActions      === undefined) npc.legendaryActions      = 3;
            if (npc.legendaryActionsUsed  === undefined) npc.legendaryActionsUsed  = 0;
        }
        return npc;
    };
})();

/* ── 3: Dark / Light Mode ─────────────────────────────────────────────── */
function toggleDarkMode() {
    document.body.classList.toggle('light-mode');
    const btn = document.getElementById('darkModeToggle');
    const isLight = document.body.classList.contains('light-mode');
    if (btn) btn.textContent = isLight ? '☀️ Light' : '🌙 Dark';
    localStorage.setItem('npcgen_theme', isLight ? 'light' : 'dark');
}

(function initTheme() {
    if (localStorage.getItem('npcgen_theme') === 'light') {
        document.body.classList.add('light-mode');
    }
})();

/* ── 4: Roll History Log ──────────────────────────────────────────────── */
const _rollHistory = [];
let _rollLogOpen = false;

function _addRollLog(entry) {
    const now = new Date();
    const t = now.getHours().toString().padStart(2,'0') + ':' +
              now.getMinutes().toString().padStart(2,'0') + ':' +
              now.getSeconds().toString().padStart(2,'0');
    _rollHistory.unshift({ ...entry, time: t });
    if (_rollHistory.length > 60) _rollHistory.pop();
    _renderRollLog();
}

function _renderRollLog() {
    const list = document.getElementById('rollLogList');
    if (!list) return;
    if (!_rollHistory.length) {
        list.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.3);padding:20px;font-size:0.85em;font-style:italic;">No rolls yet</div>';
        return;
    }
    list.innerHTML = _rollHistory.map(r => {
        const cls = r.isCrit ? 'roll-log-entry crit' : r.isFumble ? 'roll-log-entry fumble' : 'roll-log-entry';
        return `<div class="${cls}">
            <div class="roll-log-name">${r.who || ''} — ${r.type || ''}</div>
            <div class="roll-log-result">${r.result}</div>
            ${r.detail ? `<div style="font-size:0.78em;color:rgba(255,255,255,0.45);margin-top:1px;">${r.detail}</div>` : ''}
            <div class="roll-log-time">${r.time}</div>
        </div>`;
    }).join('');
}

function toggleRollLog() {
    _rollLogOpen = !_rollLogOpen;
    const panel = document.getElementById('rollLogPanel');
    if (panel) {
        panel.style.transform = _rollLogOpen ? 'translateX(0)' : 'translateX(calc(100% - 36px))';
    }
}

function clearRollLog() {
    _rollHistory.length = 0;
    _renderRollLog();
}

function dmRollDice(sides) {
    var roll = Math.floor(Math.random() * sides) + 1;
    var isCrit = sides === 20 && roll === 20;
    var isFumble = sides === 20 && roll === 1;
    if (typeof _addRollLog === 'function') _addRollLog({
        who: 'Dice',
        type: 'd' + sides,
        result: String(roll) + (isCrit ? ' (Critical!)' : '') + (isFumble ? ' (Fumble!)' : ''),
        detail: '1d' + sides,
        isCrit: isCrit,
        isFumble: isFumble
    });
    if (typeof toggleRollLog === 'function' && !_rollLogOpen) toggleRollLog();
}

function dmRollDiceFormula() {
    var inp = document.getElementById('dmDiceFormulaInput');
    var raw = (inp && inp.value) ? inp.value.trim() : '';
    var m = raw.match(/^(\d*)d(\d+)([+-]\d+)?$/i);
    if (!m) {
        if (typeof showToast === 'function') showToast('Use format like 2d6+3 or d20', 'warning');
        return;
    }
    var num = Math.min(100, Math.max(1, parseInt(m[1] || '1', 10)));
    var sides = Math.min(1000, Math.max(2, parseInt(m[2], 10)));
    var mod = m[3] ? parseInt(m[3], 10) : 0;
    var rolls = [];
    var total = mod;
    for (var i = 0; i < num; i++) {
        var r = Math.floor(Math.random() * sides) + 1;
        rolls.push(r);
        total += r;
    }
    var formula = (num === 1 ? '' : num) + 'd' + sides + (mod !== 0 ? (mod > 0 ? '+' : '') + mod : '');
    if (typeof _addRollLog === 'function') _addRollLog({
        who: 'Dice',
        type: formula,
        result: String(total),
        detail: (rolls.length <= 10 ? '(' + rolls.join(' + ') + ')' : num + ' rolls') + (mod !== 0 ? ' ' + (mod > 0 ? '+' : '') + mod : '')
    });
    if (typeof toggleRollLog === 'function' && !_rollLogOpen) toggleRollLog();
}

/* ── Spell List Panel Functions ──────────────────────────────────────────────── */
let _spellListOpen = false;
let _spellFavorites = JSON.parse(localStorage.getItem('dm_spell_favorites') || '[]');
let _allSpells = []; // Will be populated with spell data

function toggleSpellList() {
    _spellListOpen = !_spellListOpen;
    const panel = document.getElementById('spellListPanel');
    if (panel) {
        panel.style.transform = _spellListOpen ? 'translateX(0)' : 'translateX(calc(100% - 36px))';
    }
    if (_spellListOpen && _allSpells.length === 0) {
        loadSpellDatabase();
    }
    if (_spellListOpen) {
        renderSpellList();
        renderSpellFavorites();
    }
}

function loadSpellDatabase() {
    /* Prefer external SRD spell database when available */
    if (window.__SRD_SPELLS__ && Array.isArray(window.__SRD_SPELLS__) && window.__SRD_SPELLS__.length) {
        _allSpells = window.__SRD_SPELLS__;
        return;
    }
    // Basic spell database - can be expanded with full D&D 5e spells
    _allSpells = [
        {name:'Fireball',level:3,school:'Evocation',castingTime:'1 action',range:'150 feet',components:'V,S,M',duration:'Instantaneous',description:'A bright streak flashes from your pointing finger to a point you choose within range and then blossoms with a low roar into an explosion of flame. Each creature in a 20-foot-radius sphere centered on that point must make a Dexterity saving throw. A target takes 8d6 fire damage on a failed save, or half as much damage on a successful one.'},
        {name:'Magic Missile',level:1,school:'Evocation',castingTime:'1 action',range:'120 feet',components:'V,S',duration:'Instantaneous',description:'You create three glowing darts of magical force. Each dart hits a creature of your choice that you can see within range. A dart deals 1d4+1 force damage to its target. The darts all strike simultaneously, and you can direct them to hit one creature or several.'},
        {name:'Cure Wounds',level:1,school:'Evocation',castingTime:'1 action',range:'Touch',components:'V,S',duration:'Instantaneous',description:'A creature you touch regains a number of hit points equal to 1d8 + your spellcasting ability modifier. This spell has no effect on undead or constructs.'},
        {name:'Mage Armor',level:1,school:'Abjuration',castingTime:'1 action',range:'Touch',components:'V,S,M',duration:'8 hours',description:'You touch a willing creature who isn\'t wearing armor, and a protective magical force surrounds it until the spell ends. The target\'s base AC becomes 13 + its Dexterity modifier. The spell ends if the target dons armor or if you dismiss the spell as an action.'},
        {name:'Shield',level:1,school:'Abjuration',castingTime:'1 reaction',range:'Self',components:'V,S',duration:'1 round',description:'An invisible barrier of magical force appears and protects you. Until the start of your next turn, you have a +5 bonus to AC, including against the triggering attack, and you take no damage from magic missile.'},
        {name:'Eldritch Blast',level:0,school:'Evocation',castingTime:'1 action',range:'120 feet',components:'V,S',duration:'Instantaneous',description:'A beam of crackling energy streaks toward a creature within range. Make a ranged spell attack against the target. On a hit, the target takes 1d10 force damage.'},
        {name:'Light',level:0,school:'Evocation',castingTime:'1 action',range:'Touch',components:'V,M',duration:'1 hour',description:'You touch one object that is no larger than 10 feet in any dimension. Until the spell ends, the object sheds bright light in a 20-foot radius and dim light for an additional 20 feet.'},
        {name:'Mage Hand',level:0,school:'Conjuration',castingTime:'1 action',range:'30 feet',components:'V,S',duration:'1 minute',description:'A spectral, floating hand appears at a point you choose within range. The hand lasts for the duration or until you dismiss it as an action.'},
        {name:'Prestidigitation',level:0,school:'Transmutation',castingTime:'1 action',range:'10 feet',components:'V,S',duration:'Up to 1 hour',description:'This spell is a minor magical trick that novice spellcasters use for practice. You create one of the following magical effects within range.'},
        {name:'Counterspell',level:3,school:'Abjuration',castingTime:'1 reaction',range:'60 feet',components:'S',duration:'Instantaneous',description:'You attempt to interrupt a creature in the process of casting a spell. If the creature is casting a spell of 3rd level or lower, its spell fails and has no effect. If it is casting a spell of 4th level or higher, make an ability check using your spellcasting ability.'},
        {name:'Wish',level:9,school:'Conjuration',castingTime:'1 action',range:'Self',components:'V',duration:'Instantaneous',description:'Wish is the mightiest spell a mortal creature can cast. By simply speaking aloud, you can alter the very foundations of reality in accordance with your desires.'},
        {name:'Power Word Kill',level:9,school:'Enchantment',castingTime:'1 action',range:'60 feet',components:'V',duration:'Instantaneous',description:'You utter a word of power that can compel one creature you can see within range to die instantly. If the creature you choose has 100 hit points or fewer, it dies. Otherwise, the spell has no effect.'}
    ];
    // Add more spells as needed - this is a basic set
}

function renderSpellList() {
    const content = document.getElementById('spellListContent');
    if (!content) return;
    
    const searchTerm = (document.getElementById('spellListSearch') || {}).value.toLowerCase() || '';
    const levelFilter = (document.getElementById('spellListLevelFilter') || {}).value || '';
    
    let filtered = _allSpells.filter(spell => {
        const matchesSearch = spell.name.toLowerCase().includes(searchTerm);
        const matchesLevel = !levelFilter || (levelFilter === 'cantrip' && spell.level === 0) || (levelFilter !== 'cantrip' && spell.level === parseInt(levelFilter));
        return matchesSearch && matchesLevel;
    });
    
    if (filtered.length === 0) {
        content.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.3);padding:20px;font-size:0.85em;font-style:italic;">No spells found</div>';
        return;
    }
    
    content.innerHTML = filtered.map(spell => {
        const levelText = spell.level === 0 ? 'Cantrip' : 'Level ' + spell.level;
        return `<div class="spell-list-item" onclick="showSpellCard(decodeURIComponent('${encodeURIComponent(spell.name)}'))">
            <div class="spell-list-item-name">${spell.name}</div>
            <div class="spell-list-item-meta">${levelText} · ${spell.school}</div>
        </div>`;
    }).join('');

    if (typeof window.dmApplyStaggerReveal === 'function') {
        window.dmApplyStaggerReveal('spellListContent', '.spell-list-item', 16);
    }
}

var _spellListFilterTimer = null;
function filterSpellList(immediate) {
    if (immediate === true) {
        if (_spellListFilterTimer) {
            clearTimeout(_spellListFilterTimer);
            _spellListFilterTimer = null;
        }
        renderSpellList();
        return;
    }
    if (_spellListFilterTimer) clearTimeout(_spellListFilterTimer);
    _spellListFilterTimer = setTimeout(function() {
        _spellListFilterTimer = null;
        renderSpellList();
    }, 90);
}

function showSpellCard(spellName) {
    const spell = _allSpells.find(s => s.name === spellName);
    if (!spell) return;
    
    const modal = document.getElementById('spellModal');
    if (!modal) return;
    
    document.getElementById('modalSpellName').textContent = spell.name;
    document.getElementById('modalSpellType').textContent = spell.school;
    
    const detailsGrid = document.getElementById('spellDetailsGrid');
    if (detailsGrid) {
        detailsGrid.innerHTML = `
            <div class="spell-detail-item"><span class="spell-detail-label">Level:</span><span class="spell-detail-value">${spell.level === 0 ? 'Cantrip' : spell.level}</span></div>
            <div class="spell-detail-item"><span class="spell-detail-label">Casting Time:</span><span class="spell-detail-value">${spell.castingTime}</span></div>
            <div class="spell-detail-item"><span class="spell-detail-label">Range:</span><span class="spell-detail-value">${spell.range}</span></div>
            <div class="spell-detail-item"><span class="spell-detail-label">Components:</span><span class="spell-detail-value">${spell.components}</span></div>
            <div class="spell-detail-item"><span class="spell-detail-label">Duration:</span><span class="spell-detail-value">${spell.duration}</span></div>
        `;
    }
    
    const description = document.getElementById('modalSpellDescription');
    if (description) {
        description.textContent = spell.description;
    }
    
    // Add favorite button
    const isFavorite = _spellFavorites.includes(spell.name);
    const favBtn = document.createElement('button');
    favBtn.className = 'spell-modal-favorite' + (isFavorite ? ' active' : '');
    favBtn.textContent = isFavorite ? '⭐' : '☆';
    favBtn.onclick = function(e) { e.stopPropagation(); toggleSpellFavorite(spell.name); };
    
    const header = document.querySelector('.spell-modal-header');
    if (header && !header.querySelector('.spell-modal-favorite')) {
        header.appendChild(favBtn);
    }
    
    modal.classList.add('active');
}

function toggleSpellFavorite(spellName) {
    const idx = _spellFavorites.indexOf(spellName);
    if (idx >= 0) {
        _spellFavorites.splice(idx, 1);
    } else {
        _spellFavorites.push(spellName);
    }
    localStorage.setItem('dm_spell_favorites', JSON.stringify(_spellFavorites));
    renderSpellFavorites();
    const favBtn = document.querySelector('.spell-modal-favorite');
    if (favBtn) {
        favBtn.textContent = _spellFavorites.includes(spellName) ? '⭐' : '☆';
        favBtn.classList.toggle('active', _spellFavorites.includes(spellName));
    }
}

function renderSpellFavorites() {
    const favEl = document.getElementById('spellListFavorites');
    if (!favEl) return;
    
    if (_spellFavorites.length === 0) {
        favEl.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.3);padding:10px;font-size:0.8em;font-style:italic;">No favorites yet</div>';
        return;
    }
    
    favEl.innerHTML = _spellFavorites.map(name => {
        const spell = _allSpells.find(s => s.name === name);
        if (!spell) return '';
        const levelText = spell.level === 0 ? 'Cantrip' : 'Level ' + spell.level;
        return `<div class="spell-list-item" onclick="showSpellCard('${spell.name}')">
            <div class="spell-list-item-name">${spell.name}</div>
            <div class="spell-list-item-meta">${levelText} · ${spell.school}</div>
        </div>`;
    }).join('');
}

/* Patch roll functions to feed the log */
(function patchRolls() {
    /* rollWeaponAttack */
    const _origAtk = window.rollWeaponAttack;
    window.rollWeaponAttack = function(npcId, atkIdx) {
        const npc = getNPCById(npcId);
        const atk = npc && npc.attacks ? npc.attacks[atkIdx] : null;
        /* Replicate the d20 roll so we can log it */
        const d20 = Math.floor(Math.random() * 20) + 1;
        const bonus = atk ? parseInt((atk.roll || '+0').replace('+','')) : 0;
        const total = d20 + bonus;
        _addRollLog({
            who: npc ? npc.name : '?',
            type: (atk ? atk.name : 'Attack'),
            result: String(total),
            detail: `d20(${d20}) ${bonus >= 0 ? '+' : ''}${bonus}`,
            isCrit: d20 === 20,
            isFumble: d20 === 1
        });
        if (_origAtk) _origAtk(npcId, atkIdx);
    };

    /* rollStat */
    const _origStat = window.rollStat;
    window.rollStat = function(npcId, statName) {
        const npc = getNPCById(npcId);
        if (npc) {
            const mod = Math.floor((npc.stats[statName] - 10) / 2);
            const d20 = Math.floor(Math.random() * 20) + 1;
            _addRollLog({
                who: npc.name,
                type: statName + ' Check',
                result: String(d20 + mod),
                detail: `d20(${d20}) ${mod >= 0 ? '+' : ''}${mod}`,
                isCrit: d20 === 20,
                isFumble: d20 === 1
            });
        }
        if (_origStat) _origStat(npcId, statName);
    };

    /* rollInit */
    const _origInit = window.rollInit;
    window.rollInit = function(id) {
        const npc = getNPCById(id);
        if (npc) {
            const mod = Math.floor((npc.stats.DEX - 10) / 2);
            const d20 = Math.floor(Math.random() * 20) + 1;
            _addRollLog({
                who: npc.name,
                type: 'Initiative',
                result: String(d20 + mod),
                detail: `d20(${d20}) ${mod >= 0 ? '+' : ''}${mod}`
            });
        }
        if (_origInit) _origInit(id);
    };

    /* rollWeaponDamage */
    const _origDmg = window.rollWeaponDamage;
    window.rollWeaponDamage = function(npcId, atkIdx) {
        const npc = getNPCById(npcId);
        const atk = npc && npc.attacks ? npc.attacks[atkIdx] : null;
        if (atk) {
            _addRollLog({
                who: npc ? npc.name : '?',
                type: (atk.name || 'Damage') + ' Damage',
                result: atk.dmg || '?',
                detail: atk.dmgType || ''
            });
        }
        if (_origDmg) _origDmg(npcId, atkIdx);
    };
})();

/* ── 5: NPC Search & Filter ───────────────────────────────────────────── */
let _npcActiveFilter = 'all';

function toggleNPCSearch() {
    const bar = document.getElementById('npcSearchBar');
    if (!bar) return;
    const showing = bar.style.display !== 'none';
    bar.style.display = showing ? 'none' : 'flex';
    bar.style.flexDirection = 'column';
}

function filterNPCs() {
    const q = (document.getElementById('npcSearchInput') || {}).value || '';
    const query = q.toLowerCase().trim();
    /* NPC cards are rendered in #displayArea */
    const cards = document.querySelectorAll('#displayArea .npc-card');
    cards.forEach(card => {
        const id = (card.id || '').replace('card-','');
        const npc = getNPCById(id);
        if (!npc) { card.style.display = ''; return; }
        let show = true;
        if (query) {
            const haystack = [npc.name, npc.race, npc.class, npc.occupation||''].join(' ').toLowerCase();
            if (!haystack.includes(query)) show = false;
        }
        if (_npcActiveFilter === 'boss'   && !npc.isBoss)         show = false;
        if (_npcActiveFilter === 'bounty' && !npc.isBountyTarget) show = false;
        if (_npcActiveFilter === 'combat' && !npc.isCombat)       show = false;
        card.style.display = show ? '' : 'none';
    });
}

function setNPCFilter(filterName, btn) {
    _npcActiveFilter = filterName;
    document.querySelectorAll('.npc-filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    filterNPCs();
}

/* ── 6: NPC Edit Modal ────────────────────────────────────────────────── */
function openNPCEdit(npcId) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    const modal = document.getElementById('npcEditModal');
    if (!modal) return;

    /* Populate race & class dropdowns freshly */
    const rSel = document.getElementById('editRace');
    const cSel = document.getElementById('editClass');
    if (rSel && window.DB) {
        rSel.innerHTML = Object.keys(DB.races)
            .map(r => `<option value="${r}"${r===npc.race?' selected':''}>${r}</option>`).join('');
    }
    if (cSel && window.DB) {
        cSel.innerHTML = Object.keys(DB.classes)
            .map(c => `<option value="${c}"${c===npc.class?' selected':''}>${c}</option>`).join('');
    }

    document.getElementById('editNpcId').value   = npcId;
    document.getElementById('editName').value    = npc.name || '';
    document.getElementById('editLevel').value   = npc.level || 1;
    document.getElementById('editHPMax').value   = npc.hpMax || 10;
    document.getElementById('editAC').value      = npc.ac || 10;
    document.getElementById('editSpeed').value   = npc.speed || 30;
    document.getElementById('editGold').value    = npc.gold || 0;
    document.getElementById('editDmNotes').value = npc.dmNotes || '';

    const alSel = document.getElementById('editAlignment');
    if (alSel && npc.alignment) alSel.value = npc.alignment;

    /* Stat inputs */
    const grid = document.getElementById('editStatsGrid');
    if (grid) {
        grid.innerHTML = ['STR','DEX','CON','INT','WIS','CHA'].map(s => `
            <div class="edit-stat-box">
                <label>${s}</label>
                <input type="number" id="editStat_${s}" value="${(npc.stats||{})[s]||10}" min="1" max="30">
            </div>`).join('');
    }

    modal.classList.add('active');
}

function closeNPCEdit() {
    const m = document.getElementById('npcEditModal');
    if (m) m.classList.remove('active');
}

function saveNPCEdit() {
    const npcId = (document.getElementById('editNpcId') || {}).value;
    const npc = getNPCById(npcId);
    if (!npc) return;

    const g = id => (document.getElementById(id) || {}).value;

    npc.name      = g('editName')  || npc.name;
    npc.race      = g('editRace')  || npc.race;
    npc.class     = g('editClass') || npc.class;
    npc.level     = parseInt(g('editLevel'))  || npc.level;
    npc.hpMax     = parseInt(g('editHPMax'))  || npc.hpMax;
    npc.hpCurr    = Math.min(npc.hpCurr, npc.hpMax);
    npc.ac        = parseInt(g('editAC'))     || npc.ac;
    npc.speed     = parseInt(g('editSpeed'))  || npc.speed;
    npc.gold      = parseInt(g('editGold'))   || 0;
    npc.alignment = g('editAlignment') || npc.alignment;
    npc.dmNotes   = g('editDmNotes');
    npc.languages = generateLanguages(npc.race);

    ['STR','DEX','CON','INT','WIS','CHA'].forEach(s => {
        const el = document.getElementById('editStat_' + s);
        if (el) npc.stats[s] = Math.max(1, Math.min(30, parseInt(el.value) || 10));
    });

    closeNPCEdit();
    if (typeof refreshNPCCard === 'function') refreshNPCCard(npcId);
    if (typeof showToast === 'function') showToast(`${npc.name} updated`, 'success');
}

/* ── 7: Encounter Difficulty Calculator ──────────────────────────────── */
/* D&D 5e XP thresholds per character */
const _ENC_THRESH = {
    1:[25,50,75,100],       2:[50,100,150,200],    3:[75,150,225,400],
    4:[125,250,375,500],    5:[250,500,750,1100],   6:[300,600,900,1400],
    7:[350,750,1100,1700],  8:[450,900,1400,2100],  9:[550,1100,1600,2400],
    10:[600,1200,1900,2800],11:[800,1600,2400,3600],12:[1000,2000,3000,4500],
    13:[1100,2200,3400,5100],14:[1250,2500,3800,5700],15:[1400,2800,4300,6400],
    16:[1600,3200,4800,7200],17:[2000,3900,5900,8800],18:[2100,4200,6300,9500],
    19:[2400,4900,7300,10900],20:[2800,5700,8500,12700]
};
const _CR_XP = {
    0:10, 0.125:25, 0.25:50, 0.5:100,
    1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5000,
    10:5900,11:7200,12:8400,13:10000,14:11500,15:13000,16:15000,
    17:18000,18:20000,19:22000,20:25000,21:33000,22:41000,23:50000,
    24:62000,30:155000
};

function openEncounterCalc() {
    const m = document.getElementById('encounterCalcModal');
    if (m) m.classList.add('active');
}
function closeEncounterCalc() {
    const m = document.getElementById('encounterCalcModal');
    if (m) { m.classList.remove('active'); m.style.display = ''; }
}

function loadGeneratedNPCsIntoCalc() {
    /* Pull currently visible NPC cards */
    const cards = document.querySelectorAll('#displayArea .npc-card');
    let count = 0, totalLevel = 0;
    cards.forEach(card => {
        const id = (card.id || '').replace('card-','');
        const npc = getNPCById(id);
        if (npc) { count++; totalLevel += npc.level; }
    });
    if (!count) { showToast('No NPCs loaded yet', 'success'); return; }
    document.getElementById('encEnemyCount').value = count;
    document.getElementById('encEnemyCR').value    = Math.round(totalLevel / count);
    showToast(`Loaded ${count} NPC(s) as enemies (avg CR ${Math.round(totalLevel/count)})`, 'success');
}

function calculateEncounterDifficulty() {
    const partySize  = Math.max(1, parseInt(document.getElementById('encPartySize').value)  || 4);
    const partyLevel = Math.min(20, Math.max(1, parseInt(document.getElementById('encPartyLevel').value) || 5));
    const enemyCount = Math.max(1, parseInt(document.getElementById('encEnemyCount').value) || 1);
    const enemyCR    = parseFloat(document.getElementById('encEnemyCR').value) || 1;

    const thresh = _ENC_THRESH[partyLevel] || _ENC_THRESH[5];
    const [easy, medium, hard, deadly] = thresh.map(t => t * partySize);

    /* Find closest CR */
    const crKeys = Object.keys(_CR_XP).map(Number).sort((a,b)=>a-b);
    const bestCR = crKeys.reduce((p,c) => Math.abs(c-enemyCR)<Math.abs(p-enemyCR) ? c : p);
    const xpEach = _CR_XP[bestCR] || 200;

    /* Multiplier table */
    const multTable = [[1,1],[2,1.5],[3,2],[7,2.5],[11,3],[15,4]];
    let mult = 1;
    for (const [threshold, m] of multTable) if (enemyCount >= threshold) mult = m;
    if (partySize < 3) mult = Math.min(4, mult * 1.5);
    if (partySize > 5) mult = Math.max(0.5, mult * 0.75);

    const rawXP  = xpEach * enemyCount;
    const adjXP  = Math.round(rawXP * mult);

    let label, cls, emoji;
    if      (adjXP < easy)   { label='TRIVIAL'; cls='difficulty-easy';   emoji='😴'; }
    else if (adjXP < medium) { label='EASY';    cls='difficulty-easy';   emoji='✅'; }
    else if (adjXP < hard)   { label='MEDIUM';  cls='difficulty-medium'; emoji='⚠️'; }
    else if (adjXP < deadly) { label='HARD';    cls='difficulty-hard';   emoji='💀'; }
    else                     { label='DEADLY';  cls='difficulty-deadly'; emoji='☠️'; }

    const el = document.getElementById('encounterResult');
    if (!el) return;
    el.style.display = 'block';
    el.innerHTML = `
        <div class="difficulty-result ${cls}">
            <div style="font-size:2em;margin-bottom:4px;">${emoji}</div>
            <div class="difficulty-label">${label}</div>
            <div class="difficulty-detail">
                Adjusted XP: <strong>${adjXP.toLocaleString()}</strong>
                &nbsp;(raw ${rawXP.toLocaleString()} × ${mult}× multiplier)<br>
                Easy: ${easy.toLocaleString()} &nbsp;·&nbsp;
                Medium: ${medium.toLocaleString()} &nbsp;·&nbsp;
                Hard: ${hard.toLocaleString()} &nbsp;·&nbsp;
                Deadly: ${deadly.toLocaleString()}
            </div>
        </div>
        <div style="margin-top:8px;text-align:center;font-size:0.85em;opacity:0.7;">
            ${partySize} players (Level ${partyLevel}) vs ${enemyCount} enemy
            (CR ${enemyCR})
        </div>`;
}

/* ── 8: Random Encounter Generator ───────────────────────────────────── */
const _ENC_TABLES = {
    combat: {
        dungeon: [
            'Skeletons activated by a pressure plate — they have been waiting in the dark for 200 years',
            'Goblin scouts returning to a warband two rooms ahead. They spot the party first.',
            'A zombie clutching a still-lit torch. The flame has not gone out in weeks.',
            'An ogre chained to the wall. The chain is old. The ogre is hungry.',
            'Cultists mid-ritual. The summoning must not be completed.'
        ],
        city: [
            'Street gang demanding a toll on the bridge',
            'A city guard pursuing a thief — the thief is innocent',
            'Mercenaries hired to silence witnesses to a crime the party witnessed',
            'An assassin who has mistaken one party member for their target',
            'Rival bounty hunters after the same mark'
        ],
        wilderness: [
            'Wolves circling an overturned wagon. Survivors inside. Wolves are patient.',
            'Bandits with a downed tree blocking the road and crossbows in the trees',
            'A warband from a nearby orc settlement — this is their territory',
            'Giant spiders descending from the treeline as dusk falls',
            'An owlbear with a broken leg. Wounded, cornered, and furious.'
        ],
        tavern: [
            'A drunk mercenary draws steel over an imagined insult',
            'A card game ends when cheating is discovered — by the wrong person',
            'A bounty hunter corners their mark in the common room',
            'Chairs start flying from the corner before anyone knows why',
            'An escaped prisoner bursts through the door begging for help'
        ],
        road: [
            'Highwaymen with a spike trap stretched across the road',
            'A military patrol with orders to check all travel papers — and they mean it',
            'A wounded knight fleeing something faster than horses',
            'Crossbow bolts from the tree line — ambush, no warning',
            'Prison convoy with an escaped prisoner still running alongside it'
        ],
        sea: [
            'Pirates boarding under cover of a sudden fog bank',
            'A sea creature dragged up in a net — and very unhappy about it',
            'A rival trading company ship with hostile intent',
            'Desperate sailors from a sinking vessel who need this ship more than you do',
            'Smugglers who cannot afford witnesses to their route'
        ]
    },
    social: {
        dungeon: [
            'A ghost who does not know they are dead — still trying to complete an errand from three centuries ago',
            'A cursed adventurer trapped inside a mirror, begging to be freed',
            'A demon bound by an ancient contract who wants to renegotiate terms',
            'Rival explorers at a standoff — neither group will back down first',
            'A speaking door that demands a riddle before it will open'
        ],
        city: [
            'A noble hires the party on the spot for a sensitive retrieval — their missing daughter',
            'The city\'s most respected fence wants to sell information, not goods',
            'A priest is blackmailing someone important. He wants the party to make the delivery.',
            'An elderly innkeeper knows where the fugitive is hiding — and will not say',
            'A street child has been following the party. They saw something they should not have.'
        ],
        wilderness: [
            'A hermit who has not spoken to another person in eleven years — and has critical information',
            'Travelling merchants with a cartload of contraband and an extremely convincing story',
            'A druid who will only let the party pass if they complete one task for the forest first',
            'Two feuding clans blocking the road — both want the party as witnesses',
            'A wounded enemy soldier carrying a message that must reach the other side'
        ],
        tavern: [
            'The barkeep runs a gambling operation where the same people always win',
            'A bard performing a song about the party — the details are wrong in a dangerous way',
            'Someone at the bar recognises a party member from their past',
            'A hooded figure passes a note to one party member: "We need to talk. Alone."',
            'The innkeeper offers free rooms in exchange for one small, completely reasonable favour'
        ],
        road: [
            'A merchant offers a deal on magical items that is far too good to be real',
            'Two children claim to be lost. They are not children.',
            'A pilgrim on a holy journey asks to walk with the party for safety',
            'A royal courier horse returns riderless — the saddlebag is still attached and sealed',
            'Refugees fleeing a town ahead give conflicting stories about what happened there'
        ],
        sea: [
            'A vessel flying a neutral flag wants to trade — the cargo is strange',
            'A message in a bottle dated three weeks ago from a ship that supposedly sank last year',
            'Merfolk surface to deliver a warning the party may not fully understand',
            'A lighthouse keeper alone for six months signals desperately — they are not well',
            'A prisoner aboard a slaver ship that the party has just intercepted'
        ]
    },
    trap: {
        dungeon: [
            'A pressure-plate room — every tile alternates, wrong step fires crossbow bolts from the walls',
            'A door that opens onto a 40ft drop with no warning and no ledge',
            'A tripwire at knee height across a dark corridor — the wire is attached to a scythe blade',
            'Ceiling slowly lowers when a key item is lifted from an altar',
            'A room that seals and begins filling with water the moment the door closes'
        ],
        city: [
            'A locked alley gate that requires a combination — city watch patrol approaching',
            'An invitation to dinner at a noble estate — the food is poisoned for guests who ask too many questions',
            'A forged city permit puts the party before a magistrate who is deeply unsympathetic',
            'A market stall selling stolen goods — the real owner arrives with the watch',
            'The contact they were sent to meet is already dead — someone has framed the party for it'
        ],
        wilderness: [
            'A covered pit on a game trail — 20ft deep, sharpened stakes at the bottom',
            'A beehive deliberately moved to block the only pass through the ridge',
            'A mushroom ring with no visible trap — but nothing within it is alive',
            'A river crossing where the bridge is intact but the anchor pins have been half-sawn through',
            'A false campfire used to silhouette travellers for archers in the dark'
        ],
        tavern: [
            'Drinks spiked with a sleeping draught — rooms searched at 3am',
            'A card game where the party is being set up to take a very public fall',
            'A job offer that turns out to involve delivering something illegal without knowing it',
            'The party\'s lodgings have already been searched — someone knows where they sleep',
            'A friendly patron who is a spy and has been noting every word since they sat down'
        ],
        road: [
            'A fake checkpoint with convincing forgeries — they want the papers in the party\'s bag',
            'A bridge that will hold two people but not a loaded cart',
            'An apparently abandoned wagon blocking the road — driver under the cart with a crossbow',
            'Toll collectors charging double, backed by someone the local authority owes a favour',
            'A road sign turned the wrong way — leads into a dangerous area instead of toward town'
        ],
        sea: [
            'A navigation buoy marking safe passage has been moved to sit over rocks',
            'Cargo loaded secretly includes a stowaway with a knife and a specific target',
            'A slow leak below decks — ignorable for now, lethal before reaching port',
            'A harbour pilot who deliberately guides ships into shallow water',
            'A locked chest in the hold that is ticking'
        ]
    },
    mystery: {
        dungeon: [
            'Three explorers entered a week ago. Their camps are intact. Their food is fresh. They are not here.',
            'Every monster in this area has retreated to one corner and will not move. Something else has them afraid.',
            'The walls of this corridor are moving closer. A measuring mark confirms it started recently.',
            'A room of adventurer bodies posed sitting around a table. No wounds. No decay. No cause.',
            'Every map of this dungeon shows the same layout — except one room that appears on none of them'
        ],
        city: [
            'Three merchants robbed the same night in three different parts of the city at the same time',
            'A statue in the square has moved. Every citizen insists it was always in its new position.',
            'Notices posted around the city describe a crime that has not happened yet — with accurate detail',
            'A child goes missing every new moon. The watch says they always come back. They will not describe how.',
            'A building empty for ten years shows candlelight in the upstairs window at 2am'
        ],
        wilderness: [
            'Every animal in a two-mile radius has fled — except the birds, motionless for three days',
            'A perfect circle in dense forest. Nothing grows inside. No tracks enter or leave.',
            'A farmstead with hot food on the table, livestock in the pens, and no people anywhere',
            'Every traveller from the north describes a light on the horizon — always to the north, moving south',
            'A path that leads to the same clearing no matter which direction you take it'
        ],
        tavern: [
            'The same stranger has sat at the same table for eleven years. Same drink. They have not aged.',
            'A bard performs a song describing in detail an event that has not yet happened',
            'Three unconnected patrons all had the same dream last night',
            'The cellar door is locked from the inside — the innkeeper swears they have not opened it in years',
            'A room on the third floor — every guest who has booked it has not checked out'
        ],
        road: [
            'A crossroads shrine that every traveller describes differently — never the same figure twice',
            'Wagon tracks beginning from nowhere and ending nowhere across open plains',
            'A dead horse and its rider walking in circles a hundred yards away, speaking quietly',
            'Two villages each certain the road between them passes through their town first',
            'Milestones counting down — each one shows one fewer mile than it should'
        ],
        sea: [
            'A ghost ship running before the wind under full sail — no crew visible anywhere',
            'Fish swimming in the same direction, away, for two days straight',
            'A stretch of open ocean where compasses spin and stars are not where they should be',
            'A perfectly intact rowboat drifting — full of fresh provisions and a single locked journal',
            'Fog that follows this ship and only this ship — clears within fifty feet, solid beyond'
        ]
    },
    travel: {
        dungeon: [
            'The passage splits — one way sounds like distant sobbing, the other smells of blood',
            'A section of floor sounds hollow. Checking reveals only solid stone a foot below.',
            'Writing on the wall in a language no one speaks — except one party member who does not remember learning it',
            'A draft from a sealed wall suggests a room that does not appear on any map',
            'Bare footprints in the dust heading deeper in — none coming back out'
        ],
        city: [
            'Heavy rain floods the quickest route — the long way passes through a rough neighbourhood',
            'A city festival has closed all main roads — only path runs through the restricted temple district',
            'A building collapse traps workers — helping gains a guild favour, leaving saves an hour',
            'The party is recognised by someone from a past adventure — now a city official with a long memory',
            'A new law posted overnight makes something a party member was planning illegal'
        ],
        wilderness: [
            'A herd of elk crossing the trail — thousands, steady. Will take three hours to pass.',
            'An unexpected river crossing — ford passable but current far stronger than it looks',
            'Forest fire visible to the south. Wind currently heads north. Toward the party.',
            'Night falls faster than expected in unfamiliar terrain',
            'An injured traveller on the road — help and gain information, pass and travel faster'
        ],
        tavern: [
            'All rooms are full. Another party took the last ones and are being very loud about it.',
            'The stables burned last night — horses are spooked and will not be moved without calming',
            'An overnight snowstorm seals all exits — party snowed in with the other guests for a day',
            'The innkeeper needs an urgent delivery to the next town — rooms and meals in exchange',
            'A rumour overheard at the bar may change the party\'s destination entirely'
        ],
        road: [
            'Bridge washed out — must find another crossing or improvise one',
            'A customs checkpoint conducting thorough searches — one party member is carrying something questionable',
            'Road gang charging triple tolls, backed by someone the local authority owes',
            'A shortcut through private land offered by a farmer — genuinely shorter, privately problematic',
            'Good weather breaks mid-journey — the party arrives later and considerably wetter than planned'
        ],
        sea: [
            'Storm forces a detour to an unplanned port — the port has something the party needed',
            'Calm water and no wind for two days — provisions hold but tempers start to fray',
            'A faster ship offers a race — winner takes the loser\'s cargo manifest',
            'A lighthouse goes dark at the worst possible moment — navigation becomes dangerous',
            'The destination port is under quarantine — nothing in or out until the harbormaster is satisfied'
        ]
    }
};

const _QTE_TRIGGER = [
    'A bystander grabs the nearest hero and points at a developing problem.',
    'A sudden noise cuts through the scene and everyone looks to the same place.',
    'A familiar contact appears unexpectedly with urgent body language.',
    'Something important starts moving away from the party right now.',
    'Two groups collide in front of the party and tension spikes fast.',
    'A visible warning sign appears: smoke, sparks, cracking, or magical static.',
    'Someone makes a desperate accusation and nearby people react immediately.',
    'A small mistake triggers a bigger chain reaction in the area.',
    'The easiest route suddenly becomes unsafe or politically dangerous.',
    'A time-sensitive opportunity opens for only a brief moment.'
];
const _QTE_PRESSURE = [
    'If nobody acts in the next moments, innocent people get caught in the fallout.',
    'If delayed, the key person or object will be gone and hard to trace.',
    'If mishandled, local trust drops and future cooperation gets harder.',
    'If ignored, rivals gain control of the narrative first.',
    'If rushed without a plan, resources will be burned for little progress.',
    'If loud force is used, the wider area will lock down quickly.',
    'If split-second coordination fails, the party loses tactical position.',
    'If no one takes point, everyone else hesitates and panic spreads.',
    'If this goes public badly, a useful faction turns hostile for now.',
    'If the window closes, the next chance comes with steeper risk.'
];
const _QTE_FIRST_CALL = [
    'Choose one hero to take point and state exactly what they do first.',
    'Pick one immediate approach: protect people, secure evidence, or pursue the mover.',
    'Name a fast plan in one sentence so every player can support it.',
    'Decide whether this is handled quietly, publicly, or by controlled force.',
    'Call who leads and who assists before the scene fragments.',
    'Commit to either speed or precision; you cannot maximize both here.',
    'Pick the first target of action: person, route, object, or rumor source.',
    'State what the party is willing to sacrifice: time, stealth, or goodwill.',
    'Choose the immediate priority and let one backup plan exist.',
    'Say the opening move out loud now; hesitation changes the scene.'
];
const _QTE_CHECK_PAIRS = [
    ['Athletics','Acrobatics'],
    ['Perception','Investigation'],
    ['Insight','Persuasion'],
    ['Stealth','Deception'],
    ['Arcana','Religion'],
    ['Survival','Perception'],
    ['Intimidation','Persuasion'],
    ['Sleight of Hand','Acrobatics'],
    ['Medicine','Insight'],
    ['History','Investigation']
];
const _QTE_SUCCESS = [
    'You stabilize the situation and keep initiative for the next beat.',
    'You secure useful leverage and can ask one strong follow-up question.',
    'You prevent collateral damage and gain local goodwill.',
    'You keep the trail hot and skip one delay in the next scene.',
    'You lock in a reliable witness, contact, or material clue.',
    'You preserve resources and move with better positioning.',
    'You turn chaos into order and set terms of the next interaction.',
    'You uncover intent, not just surface facts, and can act on it immediately.',
    'You keep pressure on the true opposition before they reset.',
    'You create momentum the table can feel and capitalize on right away.'
];
const _QTE_FAIL_FORWARD = [
    'You still move forward, but the opposition chooses where the next clash happens.',
    'You get partial truth, but someone important now mistrusts the party.',
    'You protect the immediate scene, but the larger threat advances off-screen.',
    'You keep the objective alive, but spend time/resources you wanted later.',
    'You avoid the worst outcome, but the clean solution is no longer available.',
    'You secure progress, but your methods become visible to rivals.',
    'You hold control locally, but lose leverage with a nearby faction.',
    'You get what you need, but at the cost of future convenience.',
    'You survive the moment, but inherit a ticking consequence next beat.',
    'You succeed enough to continue, but now from a weaker posture.'
];

function swBuildQuickTimeEvent(roll, storyCtx) {
    var major = Math.floor(roll / 10) % 10;
    var minor = roll % 10;
    var trigger = _QTE_TRIGGER[major];
    var pressure = _QTE_PRESSURE[minor];
    var firstCall = _QTE_FIRST_CALL[(major + minor) % 10];
    var pair = _QTE_CHECK_PAIRS[(major + 3) % 10];
    var primarySkill = pair[0];
    var supportSkill = pair[1];
    var payoff = _QTE_SUCCESS[(minor + 5) % 10];
    var failForward = _QTE_FAIL_FORWARD[(major + 7) % 10];
    var baseDC = 11 + ((major + minor) % 8);
    var hardDC = baseDC + 3;
    var timer = 1 + (minor % 3);
    var speakNow = trigger + ' ' + pressure;
    var storyLine = '';
    if (storyCtx) {
        var sTitle = storyCtx.title || 'active story';
        var sGoal = storyCtx.goal || 'current objective';
        storyLine = 'Story Link: Fold this into "' + sTitle + '" and connect the outcome to goal: ' + sGoal + '.';
    }
    return {
        number: roll + 1,
        title: 'Quick Time Event #' + String(roll + 1).padStart(3, '0'),
        speakNow: speakNow,
        firstCall: firstCall,
        checks: primarySkill + ' (DC ' + baseDC + ') or ' + supportSkill + ' (DC ' + hardDC + ')',
        timer: timer,
        payoff: payoff,
        failForward: failForward,
        storyLine: storyLine
    };
}

function swGenerateQuickTimeEvent() {
    var out = document.getElementById('swQTEOutput');
    var body = document.getElementById('swQTEBody');
    if (!out || !body) return;
    var storyCtx = (window._swStoryLinked && window._swCurrentStory) ? window._swCurrentStory : null;
    var roll = Math.floor(Math.random() * 100);
    var qte = swBuildQuickTimeEvent(roll, storyCtx);
    out.style.display = 'block';
    body.style.display = 'block';
    body.innerHTML = ''
        + '<div style="font-family:\'Cinzel\',serif;color:#ffd7c3;font-size:0.74em;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">⚡ ' + qte.title + ' · 1 of 100</div>'
        + '<div style="background:rgba(255,130,90,0.08);border:1px solid rgba(255,170,130,0.35);border-radius:7px;padding:9px 10px;margin-bottom:8px;color:#ffe8dc;font-size:0.9em;line-height:1.6;"><strong>Say this now:</strong> ' + qte.speakNow + '</div>'
        + '<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,170,130,0.28);border-radius:6px;padding:7px 9px;margin-bottom:7px;color:#ffe8dc;font-size:0.86em;"><strong>DM first call:</strong> ' + qte.firstCall + '</div>'
        + '<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,170,130,0.35);border-radius:6px;padding:7px 9px;margin-bottom:7px;color:#ffe8dc;font-size:0.86em;"><strong>Checks:</strong> ' + qte.checks + '</div>'
        + '<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,170,130,0.25);border-radius:6px;padding:7px 9px;margin-bottom:7px;color:#ffe3d6;font-size:0.84em;"><strong>Timer:</strong> Resolve in ' + qte.timer + ' round(s) / beat(s)</div>'
        + '<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,170,130,0.25);border-radius:6px;padding:7px 9px;margin-bottom:7px;color:#ffe3d6;font-size:0.84em;"><strong>Success:</strong> ' + qte.payoff + '</div>'
        + '<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,170,130,0.25);border-radius:6px;padding:7px 9px;margin-bottom:7px;color:#ffd5c5;font-size:0.84em;"><strong>Fail Forward:</strong> ' + qte.failForward + '</div>'
        + (qte.storyLine ? '<div style="background:rgba(120,60,200,0.15);border:1px solid rgba(180,120,255,0.4);border-radius:6px;padding:7px 9px;margin-bottom:7px;color:#e6d2ff;font-size:0.84em;"><strong>🔗 Story Link:</strong> ' + qte.storyLine + '</div>' : '')
        + '<div style="display:flex;gap:6px;justify-content:flex-end;">'
        + '<button onclick="swGenerateQuickTimeEvent()" style="padding:5px 9px;background:rgba(255,130,90,0.18);border:1px solid rgba(255,130,90,0.45);border-radius:6px;color:#ffd7c3;font-family:\'Cinzel\',serif;font-size:0.66em;cursor:pointer;font-weight:700;">Reroll</button>'
        + '<button onclick="swCloseQTEPopup()" style="padding:5px 9px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#e8d8cf;font-family:\'Cinzel\',serif;font-size:0.66em;cursor:pointer;font-weight:700;">Close</button>'
        + '</div>';
    var collapseBtn = document.getElementById('swQTECollapseBtn');
    if (collapseBtn) collapseBtn.textContent = 'Collapse';
    if (typeof showToast === 'function') showToast('Quick Time Event #' + qte.number + ' generated', 'success');
}

function swToggleQTEPopupCollapse() {
    var body = document.getElementById('swQTEBody');
    var btn = document.getElementById('swQTECollapseBtn');
    if (!body || !btn) return;
    var collapsed = body.style.display === 'none';
    body.style.display = collapsed ? 'block' : 'none';
    btn.textContent = collapsed ? 'Collapse' : 'Expand';
}

function swCloseQTEPopup() {
    var wrap = document.getElementById('swQTEOutput');
    var body = document.getElementById('swQTEBody');
    var btn = document.getElementById('swQTECollapseBtn');
    if (wrap) wrap.style.display = 'none';
    if (body) body.style.display = 'block';
    if (btn) btn.textContent = 'Collapse';
}

function openEncounterGen() {
    if (typeof swSwitchTab === 'function') swSwitchTab('location');
    if (window._swLastLoc) {
        swGenerateLocationEncounterPopup();
        return;
    }
    var panel = document.getElementById('swLocOutput');
    if (panel && panel.scrollIntoView) panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    if (typeof showToast === 'function') showToast('Generate a location first, then use Generate Encounter', 'warning');
}
function closeEncounterGen() {
    var panel = document.getElementById('swLocOutput');
    if (panel && panel.scrollIntoView) panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function swGenerateLocationEncounterPopup() {
    var loc = window._swLastLoc;
    if (!loc) {
        if (typeof showToast === 'function') showToast('Generate or load a location first', 'warning');
        return;
    }

    var envMap = {
        tavern: 'tavern',
        dungeon_entrance: 'dungeon',
        cave: 'dungeon',
        ruins: 'dungeon',
        city: 'city',
        market: 'city',
        guild_hall: 'city',
        noble_manor: 'city',
        docks: 'sea',
        forest_clearing: 'wilderness',
        graveyard: 'wilderness'
    };

    var levelEl = document.getElementById('encGenLevel');
    var typeEl = document.getElementById('encGenType');
    var envEl = document.getElementById('encGenEnv');
    var intensityEl = document.getElementById('encGenIntensity');

    if (levelEl && !levelEl.value) levelEl.value = '5';
    if (typeEl) typeEl.value = '';
    if (envEl) envEl.value = envMap[loc.type] || '';
    if (intensityEl) intensityEl.value = '';

    generateRandomEncounter();

    var holder = document.getElementById('encounterGenResult');
    if (!holder || !holder.innerHTML) {
        if (typeof showToast === 'function') showToast('Failed to generate encounter', 'warning');
        return;
    }

    var popupTitle = '🎲 Encounter · ' + (loc.name || 'Location');
    var popupBody = _swSanitizePopupHtml(holder.innerHTML)
        + '<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">'
        + '<button onclick="swPinLocationEncounter()" style="padding:7px 12px;background:linear-gradient(145deg,#4a3a1a,#6a5a2a);color:#ffe8b0;border:1px solid rgba(218,165,32,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;">📌 Pin encounter</button>'
        + '<button onclick="swGenerateLocationEncounterPopup()" style="padding:7px 12px;background:linear-gradient(145deg,#1f6f4a,#2e8b57);color:#d8ffe8;border:1px solid rgba(90,220,150,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;">🎲 Reroll Encounter</button>'
        + '<button onclick="closeContentPopup()" style="padding:7px 12px;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.7);border:1px solid rgba(255,255,255,0.2);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.78em;">Close</button>'
        + '</div>';

    window._lastEncounterPopupContent = { title: popupTitle, body: popupBody };
    openContentPopup(popupTitle, popupBody);
}

window._pinnedLocationEncounter = null;

function swGetLocationEncounterButtonHtml() {
    if (window._pinnedLocationEncounter && window._pinnedLocationEncounter.title && window._pinnedLocationEncounter.body) {
        return '<span style="display:inline-flex;align-items:center;gap:6px;">'
            + '<button onclick="swOpenPinnedEncounter()" style="padding:8px 16px;background:linear-gradient(145deg,#4a3a1a,#6a5a2a);color:#ffe8b0;border:1px solid rgba(218,165,32,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 8px rgba(180,120,0,0.35);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#5a4a2a,#7a6a3a)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#4a3a1a,#6a5a2a)\'">📌 Pinned encounter</button>'
            + '<button onclick="swUnpinLocationEncounter()" style="padding:6px 10px;background:rgba(139,0,0,0.25);color:rgba(255,180,180,0.9);border:1px solid rgba(139,0,0,0.45);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;transition:all 0.15s;" title="Remove pinned encounter">✕</button>'
            + '</span>';
    }
    return '<button onclick="swGenerateLocationEncounterPopup()" style="padding:8px 16px;background:linear-gradient(145deg,#1a4a1a,#2a6a2a);color:#d8ffd8;border:1px solid rgba(110,200,110,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 8px rgba(20,120,20,0.35);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#2a5a2a,#3a7a3a)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#1a4a1a,#2a6a2a)\'">🎲 Generate Encounter</button>';
}

function swRefreshLocationEncounterButton() {
    var wrap = document.getElementById('swLocEncounterBtnWrap');
    if (wrap) wrap.innerHTML = swGetLocationEncounterButtonHtml();
}

function swPinLocationEncounter() {
    var cur = window._lastEncounterPopupContent;
    if (!cur || !cur.body) {
        if (typeof showToast === 'function') showToast('Open an encounter popup first, then click Pin.', 'warning');
        return;
    }
    window._pinnedLocationEncounter = { title: cur.title || '🎲 Encounter', body: cur.body };
    swRefreshLocationEncounterButton();
    if (typeof showToast === 'function') showToast('Encounter pinned. Use "Pinned encounter" in the location bar to reopen.', 'success');
}

function swOpenPinnedEncounter() {
    if (!window._pinnedLocationEncounter || !window._pinnedLocationEncounter.body) {
        if (typeof showToast === 'function') showToast('No pinned encounter', 'warning');
        return;
    }
    var body = window._pinnedLocationEncounter.body;
    var unpinRow = '<div style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.12);display:flex;gap:8px;flex-wrap:wrap;align-items:center;">'
        + '<span style="font-size:0.8em;color:rgba(255,255,255,0.5);">Pinned ·</span>'
        + '<button onclick="swUnpinLocationEncounter(); closeContentPopup();" style="padding:7px 12px;background:rgba(139,0,0,0.3);color:#f0b0b0;border:1px solid rgba(139,0,0,0.5);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;" title="Remove pinned encounter">📌 Unpin encounter</button>'
        + '</div>';
    openContentPopup(window._pinnedLocationEncounter.title, body + unpinRow);
}

function swUnpinLocationEncounter() {
    window._pinnedLocationEncounter = null;
    swRefreshLocationEncounterButton();
    if (typeof showToast === 'function') showToast('Pinned encounter removed.', 'success');
}

function generateRandomEncounter() {
    const levelEl = document.getElementById('encGenLevel');
    const typeEl = document.getElementById('encGenType');
    const envEl = document.getElementById('encGenEnv');
    const intensityEl = document.getElementById('encGenIntensity');
    const level = levelEl ? (parseInt(levelEl.value, 10) || 5) : 5;
    let type = typeEl ? typeEl.value : '';
    let env = envEl ? envEl.value : '';
    let intensity = intensityEl ? intensityEl.value : '';
    var storyCtx = (window._swStoryLinked && window._swCurrentStory) ? window._swCurrentStory : null;

    const types = ['combat','social','trap','mystery','travel'];
    const envs  = ['dungeon','city','wilderness','tavern','road','sea'];
    var locType = (window._swLastLoc && window._swLastLoc.type) || '';
    var envByGenre = {
        epic_fantasy: ['wilderness','dungeon','road'],
        dark_fantasy: ['dungeon','wilderness','city'],
        political: ['city','tavern','road'],
        horror: ['dungeon','wilderness','tavern'],
        mystery: ['city','road','tavern'],
        war: ['road','city','wilderness'],
        redemption: ['road','city','tavern'],
        heist: ['city','tavern','road'],
        cosmic: ['sea','dungeon','wilderness'],
        romance: ['city','tavern','road'],
        noir: ['city','tavern','road'],
        exploration: ['wilderness','road','dungeon'],
        survival: ['wilderness','road','dungeon']
    };
    if (storyCtx && !type) {
        var typeByGenre = {
            epic_fantasy: ['combat','travel','mystery'],
            dark_fantasy: ['mystery','trap','combat'],
            political: ['social','mystery','trap'],
            horror: ['mystery','trap','combat'],
            mystery: ['mystery','social','trap'],
            war: ['combat','travel','social'],
            redemption: ['social','travel','mystery'],
            heist: ['trap','social','mystery'],
            cosmic: ['mystery','combat','social'],
            romance: ['social','mystery','travel'],
            noir: ['social','mystery','trap'],
            exploration: ['travel','mystery','combat'],
            survival: ['travel','combat','trap']
        };
        type = pick(typeByGenre[storyCtx.genre] || types);
    }
    if (!type) type = pick(types);
    if (!env) {
        var locMap = {
            tavern: 'tavern',
            dungeon_entrance: 'dungeon',
            cave: 'dungeon',
            ruins: 'dungeon',
            city: 'city',
            market: 'city',
            guild_hall: 'city',
            noble_manor: 'city',
            docks: 'sea',
            forest_clearing: 'wilderness',
            graveyard: 'wilderness'
        };
        if (locMap[locType]) env = locMap[locType];
        else if (storyCtx) env = pick(envByGenre[storyCtx.genre] || envs);
        else env = pick(envs);
    }
    if (!intensity) intensity = pick(['low', 'medium', 'high']);

    const table    = (_ENC_TABLES[type] || {})[env] || [];
    const scenario = table.length ? pick(table) : 'The road ahead holds something unexpected.';

    const typeCls = {
        combat:'enc-type-combat', social:'enc-type-social', trap:'enc-type-trap',
        mystery:'enc-type-mystery', travel:'enc-type-travel'
    };
    const typeIcon = { combat:'⚔️', social:'🗣️', trap:'🪤', mystery:'🔍', travel:'🛤️' };

    const complications = [
        'Time pressure — something bad happens in 10 minutes if unresolved',
        'An innocent bystander is directly caught in the middle',
        'The obvious solution creates a second, worse problem',
        'A party member\'s backstory is unexpectedly relevant',
        'The enemy holds information the party urgently needs',
        'The environment itself becomes a complicating factor halfway through',
        'A third party is watching and waiting for the right moment to act',
        'The situation is not what it first appears to be',
        'A previous party decision has consequences here',
        'A countdown timer is imposed by external circumstances'
    ];
    const openings = [
        'Open with a vivid first image, then ask each player what their character notices first.',
        'Start in motion: someone runs in, shouts, or collapses into the scene.',
        'Begin with a choice under pressure before giving full context.',
        'Frame it as a consequence of the party\'s last decision and call back that moment.'
    ];
    const twists = [
        'The apparent villain is trying to prevent something worse.',
        'The objective is not to win the fight, but to protect a fragile objective.',
        'A known ally is tied to this event in a compromising way.',
        'A second faction arrives with conflicting goals mid-scene.'
    ];
    const stakes = [
        'Reputation stake: witnesses will shape how this region views the party.',
        'Resource stake: failure costs time, supplies, and momentum before the next objective.',
        'Political stake: whichever side the party helps gains leverage in the local power struggle.',
        'Personal stake: this event touches a party backstory thread directly.'
    ];
    var suggestedCreatures = {
        combat: { dungeon: ['skeletons', 'cultists', 'gelatinous cube', 'darkmantles', 'giant spiders'], city: ['guards', 'thugs', 'spies', 'watch patrol'], wilderness: ['wolves', 'bandits', 'owlbear', 'dryad'], tavern: ['drunken brawlers', 'cheat', 'off-duty soldiers'], road: ['bandits', 'wolves', 'mercenaries'], sea: ['sahuagin', 'pirates', 'sea hag'] },
        social: { dungeon: ['prisoner', 'traitor', 'informant'], city: ['noble', 'merchant', 'guard captain', 'street urchin'], wilderness: ['hermit', 'ranger', 'druid'], tavern: ['barkeep', 'regular', 'stranger with a secret'], road: ['traveling merchant', 'pilgrim', 'refugee'], sea: ['ship captain', 'smuggler', 'fisher'] },
        trap: { dungeon: ['pit', 'pressure plate', 'glyph'], city: ['alarm', 'locked door', 'witness'], wilderness: ['snare', 'ambush point', 'natural hazard'], tavern: ['poison', 'pickpocket', 'slippery stairs'], road: ['roadblock', 'fake distress', 'bridge'], sea: ['net', 'boarding trap', 'leak'] },
        mystery: { dungeon: ['clue', 'journal', 'witness'], city: ['rumor', 'ledger', 'witness'], wilderness: ['tracks', 'campsite', 'left behind item'], tavern: ['overheard conversation', 'stranger\'s story'], road: ['abandoned cart', 'footprints'], sea: ['flotsam', 'survivor', 'ship log'] },
        travel: { dungeon: ['collapsed passage', 'flooded section', 'split path'], city: ['crowd', 'patrol', 'closed gate'], wilderness: ['storm', 'river', 'thick brush'], tavern: ['closed road', 'guide offer'], road: ['fork', 'bridge out', 'caravan'], sea: ['fog', 'reef', 'current'] }
    };
    var creatureList = (suggestedCreatures[type] && suggestedCreatures[type][env]) ? suggestedCreatures[type][env] : ['varies by scene'];
    var suggestedCreatureText = Array.isArray(creatureList) ? pick(creatureList) : creatureList;
    var environmentDetails = {
        dungeon: ['Dim light; uneven footing; echoes carry. Possible hazards: loose stones, water, narrow passages.'],
        city: ['Streets busy or deserted depending on time. Witnesses possible. Guards may respond in 1d4 rounds.'],
        wilderness: ['Weather and terrain matter. Cover and line of sight vary. Wildlife may interfere.'],
        tavern: ['Cramped; breakables; bystanders. Noise can mask or draw attention.'],
        road: ['Open sight lines or ambush points. Travelers or patrols may pass by.'],
        sea: ['Unstable footing; wind and spray. Swimming or drowning risk if things go wrong.']
    };
    var envDetail = (environmentDetails[env] && environmentDetails[env][0]) ? environmentDetails[env][0] : 'Consider light, cover, and bystanders.';
    var locationHooks = (window._swLastLoc && window._swLastLoc.name) ? [
        'This encounter ties directly to ' + (window._swLastLoc.name || 'the current location') + ': use the place\'s history or NPCs.',
        'A local secret or feature of ' + (window._swLastLoc.name || 'here') + ' becomes relevant during the scene.',
        'Someone here has a connection to ' + (window._swLastLoc.name || 'this place') + '; use it as a hook or complication.'
    ] : [];
    var locationHookText = locationHooks.length ? pick(locationHooks) : '';

    const failForward = [
        'If they fail, allow progress with a cost: alarm raised, pursuit begins, or debt incurred.',
        'If they fail, reveal one critical clue anyway but attach a new timer.',
        'If they fail, the scene ends but creates a stronger follow-up encounter.',
        'If they fail, success is still possible by spending resources or making a hard bargain.'
    ];
    const rewards = [
        `${Math.round(level * 80 * (1 + Math.random())).toLocaleString()} gp + potential ongoing alliance`,
        `Rare intelligence + ${Math.round(level * 50).toLocaleString()} gp`,
        'A significant favour from a local power',
        'A unique item recovered from the scene',
        `${Math.round(level * 100).toLocaleString()} gp bounty upon full resolution`
    ];
    const dcBase = Math.min(20, 10 + Math.floor(level / 2));
    const dcSoft = Math.max(8, dcBase - 2);
    const dcHard = Math.min(25, dcBase + 3);
    const intensityLabel = { low: 'Low Pressure', medium: 'Core Scene', high: 'High Stakes' };
    const threatBand = level <= 4 ? 'Tier I (Local Heroes)' : (level <= 10 ? 'Tier II (Regional Stakes)' : (level <= 16 ? 'Tier III (Realm Stakes)' : 'Tier IV (Legendary Stakes)'));
    var storyTie = '';
    if (storyCtx) {
        storyTie = 'Linked to "' + (storyCtx.title || 'Active Story') + '". Tie this scene to goal: ' + (storyCtx.goal || 'current objective') + '. Opposing pressure: ' + (storyCtx.antagonist || 'current antagonist') + '.';
    }

    const result = document.getElementById('encounterGenResult');
    if (!result) return;
    result.innerHTML = `
        <div class="encounter-card">
            <span class="encounter-type-badge ${typeCls[type]||''}">${typeIcon[type]||''} ${type.charAt(0).toUpperCase()+type.slice(1)} — ${env.charAt(0).toUpperCase()+env.slice(1)}</span>
            <div style="font-family:'Cinzel',serif;font-size:0.78em;color:var(--gold-light);margin-bottom:8px;font-weight:700;">Party Level ${level} • ${threatBand} • ${intensityLabel[intensity] || 'Variable Intensity'}</div>
            <div style="font-size:1em;line-height:1.6;margin-bottom:12px;">${scenario}</div>
            <div style="background:rgba(40,60,100,0.12);border-left:3px solid rgba(110,170,255,0.7);padding:8px 11px;border-radius:0 4px 4px 0;margin-bottom:8px;">
                <strong style="font-family:'Cinzel',serif;font-size:0.78em;color:#a8d0ff;">🎬 OPENING BEAT</strong><br>
                <span style="font-size:0.92em;">${pick(openings)}</span>
            </div>
            <div style="background:rgba(139,0,0,0.07);border-left:3px solid var(--red);padding:8px 11px;border-radius:0 4px 4px 0;margin-bottom:8px;">
                <strong style="font-family:'Cinzel',serif;font-size:0.78em;color:var(--red);">⚠ COMPLICATION</strong><br>
                <span style="font-size:0.92em;">${pick(complications)}</span>
            </div>
            <div style="background:rgba(80,40,120,0.1);border-left:3px solid rgba(180,120,255,0.8);padding:8px 11px;border-radius:0 4px 4px 0;margin-bottom:8px;">
                <strong style="font-family:'Cinzel',serif;font-size:0.78em;color:#cfafff;">🧭 STAKES & TWIST</strong><br>
                <span style="font-size:0.92em;"><strong>${pick(stakes)}</strong><br>${pick(twists)}</span>
            </div>
            <div style="background:rgba(60,80,40,0.12);border-left:3px solid rgba(140,200,100,0.75);padding:8px 11px;border-radius:0 4px 4px 0;margin-bottom:8px;">
                <strong style="font-family:'Cinzel',serif;font-size:0.78em;color:#a8d8a0;">👤 SUGGESTED FOES / ELEMENTS</strong><br>
                <span style="font-size:0.92em;">${suggestedCreatureText}</span>
            </div>
            <div style="background:rgba(40,60,80,0.12);border-left:3px solid rgba(100,160,200,0.7);padding:8px 11px;border-radius:0 4px 4px 0;margin-bottom:8px;">
                <strong style="font-family:'Cinzel',serif;font-size:0.78em;color:#a0d0e8;">🌍 ENVIRONMENT</strong><br>
                <span style="font-size:0.92em;">${envDetail}</span>
            </div>
            ${locationHookText ? `<div style="background:rgba(100,80,40,0.1);border-left:3px solid rgba(200,160,80,0.75);padding:8px 11px;border-radius:0 4px 4px 0;margin-bottom:8px;"><strong style="font-family:'Cinzel',serif;font-size:0.78em;color:#e8c890;">📍 LOCATION HOOK</strong><br><span style="font-size:0.92em;">${locationHookText}</span></div>` : ''}
            ${storyTie ? `<div style="background:rgba(120,60,200,0.12);border-left:3px solid rgba(180,120,255,0.85);padding:8px 11px;border-radius:0 4px 4px 0;margin-bottom:8px;"><strong style="font-family:'Cinzel',serif;font-size:0.78em;color:#dab6ff;">🔗 STORY LINK</strong><br><span style="font-size:0.92em;">${storyTie}</span></div>` : ''}
            <div style="background:rgba(184,134,11,0.08);border-left:3px solid var(--gold);padding:8px 11px;border-radius:0 4px 4px 0;">
                <strong style="font-family:'Cinzel',serif;font-size:0.78em;color:var(--gold);">💰 REWARD</strong><br>
                <span style="font-size:0.92em;">${pick(rewards)}</span>
            </div>
            <div style="margin-top:8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:8px 11px;">
                <strong style="font-family:'Cinzel',serif;font-size:0.78em;color:rgba(255,255,255,0.8);">🛠 DM RUN NOTES</strong><br>
                <span style="font-size:0.9em;color:rgba(230,240,255,0.86);display:block;margin-top:4px;">Suggested DCs: Easy ${dcSoft}, Standard ${dcBase}, Hard ${dcHard}</span>
                <span style="font-size:0.9em;color:rgba(230,240,255,0.78);display:block;margin-top:4px;">Fail Forward: ${pick(failForward)}</span>
            </div>
        </div>
        <button onclick="generateRandomEncounter()"
            style="width:100%;margin-top:6px;padding:9px;background:linear-gradient(145deg,#2a4a2a,#1a3a1a);
                   color:#b0ffb0;border:1px solid #4a8a4a;border-radius:5px;cursor:pointer;
                   font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;">
            🎲 Generate Another
        </button>`;
}

/* ── 9: Party Tracker ─────────────────────────────────────────────────── */
let _sessionTags = [];
try { _sessionTags = JSON.parse(localStorage.getItem('npcgen_tags') || '[]'); } catch(e) { _sessionTags=[]; }

function toggleSessionNotes() {
    const panel = document.getElementById('sessionNotesPanel');
    if (!panel) return;
    const showing = panel.classList.toggle('visible');
    if (showing) {
        const area = document.getElementById('sessionNotesArea');
        if (area) area.value = localStorage.getItem('npcgen_session_notes') || '';
        _renderSessionTags();
    }
}

function saveSessionNotes() {
    if (window._isOneShot) return;
    const area = document.getElementById('sessionNotesArea');
    if (area) localStorage.setItem('npcgen_session_notes', area.value);
}

function addSessionTag() {
    const inp = document.getElementById('sessionTagInput');
    const tag = inp ? inp.value.trim() : '';
    if (!tag) return;
    if (!_sessionTags.includes(tag)) {
        _sessionTags.push(tag);
        if (!window._isOneShot) localStorage.setItem('npcgen_tags', JSON.stringify(_sessionTags));
    }
    inp.value = '';
    _renderSessionTags();
}

function removeSessionTag(tag) {
    _sessionTags = _sessionTags.filter(t => t !== tag);
    if (!window._isOneShot) localStorage.setItem('npcgen_tags', JSON.stringify(_sessionTags));
    _renderSessionTags();
}

function _renderSessionTags() {
    const container = document.getElementById('sessionTagContainer');
    if (!container) return;
    container.innerHTML = _sessionTags.map(t =>
        `<span class="session-tag" onclick="removeSessionTag('${t.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}')">🏷 ${t} ×</span>`
    ).join('');
}

/* ── 11: Legendary Resource Tracker ──────────────────────────────────── */
function useLegendaryResource(npcId, resourceType, index) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    if (resourceType === 'resistance') {
        const used = npc.legendaryResistancesUsed || 0;
        npc.legendaryResistancesUsed = used > index ? index : index + 1;
    } else {
        const used = npc.legendaryActionsUsed || 0;
        npc.legendaryActionsUsed = used > index ? index : index + 1;
    }
    _refreshLegTracker(npcId);
}

function resetLegendaryActions(npcId) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    npc.legendaryActionsUsed = 0;
    _refreshLegTracker(npcId);
    if (typeof showToast === 'function') showToast(`${npc.name} — Legendary Actions reset`, 'success');
}

function _refreshLegTracker(npcId) {
    const npc = getNPCById(npcId);
    if (!npc) return;
    const resEl = document.getElementById('legres-' + npcId);
    const actEl = document.getElementById('legact-' + npcId);
    const maxRes = npc.legendaryResistances || 3;
    const maxAct = npc.legendaryActions || 3;
    const usedRes = npc.legendaryResistancesUsed || 0;
    const usedAct = npc.legendaryActionsUsed || 0;
    if (resEl) {
        resEl.innerHTML = Array.from({length: maxRes}, (_, i) =>
            `<div class="leg-pip${usedRes > i ? ' used' : ''}"
                  onclick="useLegendaryResource('${npcId}','resistance',${i})"
                  title="Click to use/restore"></div>`
        ).join('');
    }
    if (actEl) {
        actEl.innerHTML = Array.from({length: maxAct}, (_, i) =>
            `<div class="leg-pip${usedAct > i ? ' used' : ''}"
                  onclick="useLegendaryResource('${npcId}','action',${i})"
                  title="Click to use/restore"></div>`
        ).join('');
    }
}

/* ── Boot: init everything once the page is ready ────────────────────── */
document.addEventListener('DOMContentLoaded', function() {
    renderPartyTracker();
    _renderRollLog();
    _renderSessionTags();
});

/* ── When opened as HTML file (no installer): show install banner ─────── */
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.protocol !== 'file:' || window.desktopApp) return;
    var banner = document.createElement('div');
    banner.id = 'dm-install-banner';
    banner.setAttribute('role', 'alert');
    banner.style.cssText = 'position:sticky;top:0;z-index:9999;background:linear-gradient(90deg,#5a0000,#8b0000);color:#ffeca0;padding:14px 20px;text-align:center;font-family:\'Cinzel\',serif;font-size:0.95em;line-height:1.5;box-shadow:0 4px 12px rgba(0,0,0,0.4);border-bottom:3px solid #b8860b;';
    banner.innerHTML = '<strong>You opened the web page file.</strong> To use the full app with AI and all features: close this page, then in this folder double-click <strong>DND DM Helper Installer 1.0.0.exe</strong> to install. After installing, open <strong>DND DM Helper</strong> from the Start Menu. &nbsp; <a href="#" onclick="document.getElementById(\'dm-install-banner\').style.display=\'none\';return false;" style="color:#ffeca0;text-decoration:underline;">Dismiss</a>';
    var body = document.body;
    if (body && body.firstChild) body.insertBefore(banner, body.firstChild);
});

/* ═══════════════════════════════════════════════════════════════════════════
   DND DM HELPER — NEW FEATURES BLOCK
   1. Title renamed, emojis cleaned
   2. Party Tracker — starts empty, modal player sheets
   3. Player Sheet Modal
   4. Nemesis system
   5. Quest Generator — main quests, side quests, random side quests
   6. NPC generation hooks in quests
   ═══════════════════════════════════════════════════════════════════════════ */

/* ── ONE-SHOT MODE: no data persisted; session keys cleared on exit ─── */
window._isOneShot = false;
window._SESSION_STORAGE_KEYS = ['npcgen_npcs','npcgen_quests','npcgen_party','dm_notes','dm_quick_notes','npcgen_nemesis','dm_saved_notes','npcgen_killed','dm_vault','dm_active_quest','dm_active_revenge','dm_saved_revenge_quests','dm_locations','dm_sw_stories','dm_sw_locs','dm_live_tools','npcgen_tags','npcgen_session_notes','npcgen_notes_v2'];
function _clearSessionStorage() { try { (window._SESSION_STORAGE_KEYS||[]).forEach(function(k){ localStorage.removeItem(k); }); } catch(e){} }

/* ── Central AI helper: one place for Ollama calls, errors, and "not configured" ─── */
window.appAIGenerate = function(opts) {
    var payload = opts || {};
    var prompt = (payload.prompt != null) ? String(payload.prompt).trim() : '';
    var system = (payload.system != null) ? String(payload.system).trim() : '';
    var model = (payload.model != null && String(payload.model).trim()) ? String(payload.model).trim() : (localStorage.getItem('dm_story_ai_model') || 'llama2').trim() || 'llama2';
    var baseUrl = (payload.baseUrl != null && String(payload.baseUrl).trim()) ? String(payload.baseUrl).trim().replace(/\/+$/, '') : (localStorage.getItem('dm_story_ai_url') || 'http://127.0.0.1:11434').trim().replace(/\/+$/, '');
    var options = payload.options || {};
    if (!window.desktopApp || typeof window.desktopApp.ollamaGenerate !== 'function') {
        if (typeof showToast === 'function') showToast('AI needs the desktop app. Use Options → AI to set up Ollama.', 'success');
        return Promise.resolve({ ok: false, error: 'Desktop app / Ollama not available' });
    }
    var req = { prompt: prompt, system: system || undefined, model: model, baseUrl: baseUrl };
    if (Object.keys(options).length) req.options = options;
    return window.desktopApp.ollamaGenerate(req).then(function(result) {
        if (result && result.ok && result.response != null) return { ok: true, response: String(result.response).trim() };
        return { ok: false, error: (result && result.error) ? String(result.error) : 'AI request failed' };
    }).catch(function(err) {
        var msg = (err && err.message) ? err.message : String(err);
        return { ok: false, error: msg };
    });
};
window.appAIIsAvailable = function() { return !!(window.desktopApp && typeof window.desktopApp.ollamaGenerate === 'function'); };
window._appAIBusy = false;
window.appAIGenerateWithBusy = function(opts) {
    if (window._appAIBusy) { if (typeof showToast === 'function') showToast('AI is busy. Wait for the current request.', 'success'); return Promise.resolve({ ok: false, error: 'Busy' }); }
    window._appAIBusy = true;
    return (window.appAIGenerate || function(){ return Promise.resolve({ ok: false, error: 'AI not available' }); })(opts).then(function(r) { window._appAIBusy = false; return r; }).catch(function(e) { window._appAIBusy = false; throw e; });
};

/* ── PARTY TRACKER (replaces prompt-based version with modal) ────────── */
let _party = [];
try { _party = JSON.parse(localStorage.getItem('npcgen_party') || '[]'); } catch(e) { _party = []; }
/* Migration: clear sample/demo party players from old versions */
(function() {
    var sampleNames = ['Bob', 'Player 2', 'Player 3', 'Player 4', 'Player 5'];
    if (_party.length && _party.every(function(p) { return sampleNames.indexOf(p.name) !== -1; })) {
        _party = [];
        localStorage.removeItem('npcgen_party');
    }
})();

function clearAllPartyMembers() {
    if (!_party.length) { if (typeof showToast === 'function') showToast('Party is already empty', 'success'); return; }
    if (!confirm('Remove ALL players from the party tracker?')) return;
    var prevParty = JSON.parse(JSON.stringify(_party || []));
    _party = [];
    _saveParty();
    renderPartyTracker();
    if (typeof _renderPartyInitInputs === 'function') _renderPartyInitInputs();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    dmPushUndoAction('Clear party', function() {
        _party = JSON.parse(JSON.stringify(prevParty || []));
        _saveParty();
        renderPartyTracker();
        if (typeof _renderPartyInitInputs === 'function') _renderPartyInitInputs();
        if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    });
    if (typeof showToast === 'function') showToast('All players removed', 'success');
}

function _saveParty() { if (window._isOneShot) return; try { localStorage.setItem('npcgen_party', JSON.stringify(_party)); } catch(e){} }

function renderPartyTracker() {
    const el = document.getElementById('partyMemberList');
    if (!el) return;
    if (!_party.length) {
        el.innerHTML = '<div style="color:rgba(184,134,11,0.45);font-size:0.83em;text-align:center;padding:12px 6px;line-height:1.5;">No players added.<br>Click <strong>+ Add Player</strong> to begin.</div>';
        return;
    }
    // Group players by a simple party banner
    const partyHTML = _party.map(p => {
        const pct = Math.max(0, Math.min(100, Math.round((p.hpCurr / (p.hpMax || 1)) * 100)));
        const barColor = pct <= 25 ? '#c0392b' : pct <= 50 ? '#e67e22' : '#27ae60';
        const fillCls  = pct <= 25 ? 'critical' : pct <= 50 ? 'hurt' : '';
        const nemCount = (p.nemeses || []).length;
        const condStr = (p.conditions||[]).length ? ' &nbsp;·&nbsp; <span style="color:#e74c3c;">' + p.conditions.join(', ') + '</span>' : '';
        const huntedStr = (p.isHunted && p.isHunted.length) ? `<div class="hunted-badge">☠ HUNTED — ${p.isHunted.slice(0,2).map(n=>`Allies of ${n}`).join(', ')}${p.isHunted.length>2?' + more':''}</div>` : '';
        return `<div class="party-member-row" title="Click to edit">
            <div style="flex:1;min-width:0;cursor:pointer;" onclick="openPlayerSheet('${p.id}')">
                <div class="party-member-name">
                    ${p.name || 'Unnamed'}
                    <span style="font-weight:400;font-size:0.78em;color:var(--gold-light);">${p.cls||''} ${p.level||1}</span>
                    ${p.insp ? '<span style="color:#ffd700;font-size:0.78em;margin-left:4px;" title="Inspiration">&#9733;</span>' : ''}
                    ${nemCount ? `<span class="nemesis-badge-inline" title="${nemCount} nemesis relationship(s)">NEMESIS x${nemCount}</span>` : ''}
                </div>
                ${huntedStr}
                <div class="party-hp-bar"><div class="party-hp-fill ${fillCls}" style="width:${pct}%;background:${barColor};"></div></div>
                <div style="font-size:0.72em;color:rgba(255,255,255,0.5);margin-top:2px;">
                    <span style="color:${barColor};font-weight:700;">${p.hpCurr||0}/${p.hpMax||0} HP</span>
                    &nbsp;·&nbsp; AC ${p.ac||10}${condStr}
                </div>
            </div>
            <div class="party-hp-controls" onclick="event.stopPropagation()">
                <button style="padding:2px 7px;background:linear-gradient(145deg,var(--gold),#966f0a);color:white;border:none;border-radius:4px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.65em;font-weight:700;white-space:nowrap;margin-bottom:3px;" onclick="openPlayerSheet('${p.id}')">✏ Edit</button>
                <div style="display:flex;gap:2px;">
                    <button class="party-hp-btn minus" onclick="quickHP('${p.id}',-1)">&#8722;</button>
                    <button class="party-hp-btn plus"  onclick="quickHP('${p.id}',+1)">+</button>
                    <button class="party-hp-btn" onclick="removePartyMember('${p.id}')" title="Remove player" style="background:var(--red);color:white;font-size:0.85em;padding:0 6px;margin-left:2px;">✕</button>
                </div>
            </div>
        </div>`;
    }).join('');
    el.innerHTML = `<div class="party-group-header">The Party &mdash; ${_party.length} member${_party.length!==1?'s':''}</div>` + partyHTML;
}

function quickHP(pid, dir) {
    const p = _party.find(m => m.id === pid);
    if (!p) return;
    p.hpCurr = Math.max(0, Math.min(p.hpMax||1, (p.hpCurr||0) + dir));
    _saveParty(); renderPartyTracker();
    if (typeof lpRefreshParty === 'function') lpRefreshParty();
}

/* Open player sheet — create new if no ID */
function openPlayerSheet(pid) {
    let p = _party.find(m => m.id === pid);
    const isNew = !p;
    const effectivePid = pid || ('p' + Date.now());
    const modal = document.getElementById('playerSheetModal');
    if (!modal) return;

    /* Title */
    document.getElementById('psModalTitle').textContent = isNew ? 'New Player Character' : ('Edit — ' + (p ? p.name : ''));
    document.getElementById('psId').value = effectivePid;

    /* Populate fields */
    const g = (id, def) => { const el = document.getElementById(id); if(el) el.value = p ? (p[id.replace('ps','')] ?? p[id.toLowerCase().replace('ps','')] ?? def) : def; };

    document.getElementById('psName').value    = p?.name       || '';
    document.getElementById('psClass').value   = p?.cls        || 'Fighter';
    document.getElementById('psRace').value    = p?.race       || 'Human';
    document.getElementById('psLevel').value   = p?.level      || 1;
    document.getElementById('psBackground').value = p?.background || '';
    document.getElementById('psAlignment').value  = p?.alignment  || 'TN';
    document.getElementById('psHpCurr').value  = p?.hpCurr     || 20;
    document.getElementById('psHpMax').value   = p?.hpMax      || 20;
    document.getElementById('psAC').value      = p?.ac         || 10;
    document.getElementById('psSpeed').value   = p?.speed      || 30;
    var _psLegacySlots = document.getElementById('psSpellSlots');
    if (_psLegacySlots) _psLegacySlots.value = '';
    document.getElementById('psNotes').value   = p?.notes      || '';
    document.getElementById('psInsp').checked  = p?.insp       || false;
    ['STR','DEX','CON','INT','WIS','CHA'].forEach(s => {
        const el = document.getElementById('psstat_' + s);
        if (el) el.value = (p?.stats || {})[s] || 10;
    });

    /* Conditions */
    _renderPsConditions(effectivePid, p?.conditions || []);
    if (typeof psEnsureSpellPickerReady === 'function') psEnsureSpellPickerReady();
    if (typeof psLoadKnownSpellsFromPlayer === 'function') psLoadKnownSpellsFromPlayer(p || null);
    modal.classList.add('active');
}

function _renderPsConditions(pid, active) {
    const el = document.getElementById('psConditionsList');
    if (!el) return;
    const ALL = ['Blinded','Charmed','Deafened','Exhaustion','Frightened','Grappled',
        'Incapacitated','Invisible','Paralyzed','Petrified','Poisoned','Prone',
        'Restrained','Stunned','Unconscious','Concentrating'];
    el.innerHTML = ALL.map(c => {
        const on = active.includes(c);
        return `<span onclick="_togglePsCond('${pid}','${c}',this)"
            style="display:inline-block;padding:2px 9px;border-radius:9px;font-size:0.75em;margin:2px;cursor:pointer;border:1px solid;
            ${on ? 'background:#8b0000;color:#fff8dc;border-color:#8b0000;' : 'background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.55);border-color:rgba(255,255,255,0.18);'}">
            ${c}</span>`;
    }).join('');
}

function _togglePsCond(pid, cond, el) {
    /* Toggle visual immediately; actual save happens on Save button */
    const on = el.style.background.includes('8b0000');
    el.style.background = on ? 'rgba(255,255,255,0.08)' : '#8b0000';
    el.style.color = on ? 'rgba(255,255,255,0.55)' : '#fff8dc';
    el.style.borderColor = on ? 'rgba(255,255,255,0.18)' : '#8b0000';
    /* Store pending state on the element */
    el.dataset.active = on ? '' : '1';
}

function closePlayerSheet() {
    const m = document.getElementById('playerSheetModal');
    if (m) {
        m.classList.remove('active');
        m.style.display = '';
        m.style.zIndex = '';
    }
}

function savePlayerSheet() {
    const pid  = document.getElementById('psId').value;
    let p = _party.find(m => m.id === pid);
    const isNew = !p;
    if (isNew) { p = { id: pid, nemeses: [], conditions: [] }; _party.push(p); }

    p.name       = document.getElementById('psName').value.trim() || 'Unnamed';
    p.cls        = document.getElementById('psClass').value;
    p.race       = document.getElementById('psRace').value;
    p.level      = parseInt(document.getElementById('psLevel').value) || 1;
    p.background = document.getElementById('psBackground').value;
    p.alignment  = document.getElementById('psAlignment').value;
    p.hpMax      = parseInt(document.getElementById('psHpMax').value)  || 10;
    p.hpCurr     = parseInt(document.getElementById('psHpCurr').value) ?? p.hpMax;
    p.ac         = parseInt(document.getElementById('psAC').value)     || 10;
    p.speed      = parseInt(document.getElementById('psSpeed').value)  || 30;
    /* Known spells */
    (function(){
        var arr = Array.isArray(window._psKnownSpellsDraft) ? window._psKnownSpellsDraft.slice() : [];
        if (!arr.length) {
            var el = document.getElementById('psKnownSpellsJson');
            try { arr = el ? JSON.parse(el.value || '[]') : []; } catch(e) { arr = []; }
        }
        if (!Array.isArray(arr)) arr = [];
        p.knownSpells = arr
            .map(function(s){ return (s && typeof s === 'object') ? (s.name || '') : String(s || ''); })
            .map(function(s){ return String(s).trim(); })
            .filter(Boolean);
    })();
    p.notes      = document.getElementById('psNotes').value;
    p.insp       = document.getElementById('psInsp').checked;
    p.stats = {};
    ['STR','DEX','CON','INT','WIS','CHA'].forEach(s => {
        const el = document.getElementById('psstat_' + s);
        p.stats[s] = el ? (parseInt(el.value) || 10) : 10;
    });
    /* Read conditions from DOM state */
    const condEls = document.querySelectorAll('#psConditionsList span');
    p.conditions = Array.from(condEls)
        .filter(el => el.dataset.active === '1' || el.style.background.includes('8b0000'))
        .map(el => el.textContent.trim());

    _saveParty();
    closePlayerSheet();
    renderPartyTracker();
    /* Also refresh the modal party list if it's open */
    if (typeof lpRefreshParty === 'function') lpRefreshParty();
    /* Refresh header health bars */
    if (typeof renderHeaderPartyHealth === 'function') renderHeaderPartyHealth();
    if (typeof showToast === 'function') showToast(p.name + ' saved', 'success');
}

function removePartyMember(pid) {
    if (!confirm('Remove this player from the tracker?')) return;
    _party = _party.filter(m => m.id !== pid);
    _saveParty();
    const modal = document.getElementById('playerSheetModal');
    if (modal && modal.classList.contains('active')) closePlayerSheet();
    renderPartyTracker();
    if (typeof lpRefreshParty === 'function') lpRefreshParty();
    if (typeof renderHeaderPartyHealth === 'function') renderHeaderPartyHealth();
    if (typeof _renderPartyInitInputs === 'function') _renderPartyInitInputs();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
}

function addPartyMember() {
    var newPid = 'p' + Date.now();
    /* Ensure playerSheetModal is accessible - force it on top of everything */
    var modal = document.getElementById('playerSheetModal');
    if (modal) {
        modal.style.zIndex = '100000';
        modal.style.position = 'fixed';
        modal.style.inset = '0';
        modal.style.background = 'rgba(0,0,0,0.92)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'flex-start';
        modal.style.justifyContent = 'center';
        modal.style.padding = '20px';
        modal.style.overflowY = 'auto';
        modal.classList.add('active');
    }
    openPlayerSheet(newPid);
}

/* ── NEMESIS SYSTEM ─────────────────────────────────────────────────── */
/* Global nemesis registry: npcId -> { reason, playerIds: [] } */
let _nemesisRegistry = {};
try { _nemesisRegistry = JSON.parse(localStorage.getItem('npcgen_nemesis') || '{}'); } catch(e) { _nemesisRegistry={}; }
function _saveNemesis() { if (window._isOneShot) return; try { localStorage.setItem('npcgen_nemesis', JSON.stringify(_nemesisRegistry)); } catch(e){} }

const NEMESIS_REASONS = ['Killed / Defeated', 'Betrayed / Deceived', 'Insulted / Humiliated',
    'Stole from them', 'Attacked unprovoked', 'Destroyed property', 'Caused death of ally',
    'Broke an oath', 'Framed them', 'Refused to help when needed'];

function openNemesisModal(npcId) {
    const npc = (typeof getNPCById === 'function') ? getNPCById(npcId) : null;
    if (!npc) { showToast('NPC not found', 'warning'); return; }
    const modal = document.getElementById('nemesisModal');
    if (!modal) return;
    document.getElementById('nemesisNpcId').value = npcId;
    document.getElementById('nemesisSelectedReason').value = '';
    document.getElementById('nemesisSelectedPlayer').value = '';

    document.getElementById('nemesisContent').innerHTML =
        `<strong style="color:#dc143c;">${npc.name}</strong> (${npc.race} ${npc.class}) will become hostile toward the responsible player and any allied NPCs will distrust them.`;

    /* Reason buttons */
    document.getElementById('nemesisReasonBtns').innerHTML = NEMESIS_REASONS.map(r =>
        `<button onclick="selectNemesisReason('${r.replace(/'/g,"\\'")}',this)"
            style="padding:4px 10px;border:1px solid #8b0000;background:none;color:#f0a0a0;border-radius:4px;cursor:pointer;font-size:0.8em;font-family:'Crimson Text',serif;">${r}</button>`
    ).join('');

    /* Player list */
    const listEl = document.getElementById('nemesisPlayerList');
    if (!_party.length) {
        listEl.innerHTML = '<div style="color:#888;font-size:0.85em;font-style:italic;">No players in tracker. Add players first.</div>';
    } else {
        listEl.innerHTML = _party.map(p =>
            `<button onclick="selectNemesisPlayer('${p.id}',this)"
                style="padding:6px 10px;border:1px solid #5a0000;background:rgba(139,0,0,0.1);color:#f0d0d0;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;text-align:left;">
                ${p.name} <span style="font-weight:400;font-size:0.85em;opacity:0.7;">${p.cls||''} ${p.level||1}</span>
            </button>`
        ).join('');
    }

    modal.classList.add('active');
}

function selectNemesisReason(reason, btn) {
    document.getElementById('nemesisSelectedReason').value = reason;
    document.querySelectorAll('#nemesisReasonBtns button').forEach(b => b.style.background = 'none');
    btn.style.background = '#8b0000';
    btn.style.color = '#fff8dc';
}

function selectNemesisPlayer(pid, btn) {
    document.getElementById('nemesisSelectedPlayer').value = pid;
    document.querySelectorAll('#nemesisPlayerList button').forEach(b => {
        b.style.background = 'rgba(139,0,0,0.1)'; b.style.borderColor = '#5a0000';
    });
    btn.style.background = '#8b0000';
    btn.style.borderColor = '#dc143c';
}

function confirmNemesis() {
    const npcId    = document.getElementById('nemesisNpcId').value;
    const reason   = document.getElementById('nemesisSelectedReason').value;
    const playerId = document.getElementById('nemesisSelectedPlayer').value;

    if (!reason)   { showToast('Please select a reason', 'success'); return; }
    if (!playerId && _party.length) { showToast('Please select a player', 'success'); return; }

    const npc = (typeof getNPCById === 'function') ? getNPCById(npcId) : null;
    const player = _party.find(p => p.id === playerId);

    /* Register nemesis */
    if (!_nemesisRegistry[npcId]) _nemesisRegistry[npcId] = { npcName: npc?.name || 'Unknown', reason, playerIds: [] };
    if (playerId && !_nemesisRegistry[npcId].playerIds.includes(playerId))
        _nemesisRegistry[npcId].playerIds.push(playerId);
    _nemesisRegistry[npcId].reason = reason;
    _saveNemesis();

    /* Mark on player */
    if (player) {
        if (!player.nemeses) player.nemeses = [];
        if (!player.nemeses.find(n => n.npcId === npcId))
            player.nemeses.push({ npcId, npcName: npc?.name || 'Unknown', reason });
        _saveParty();
        renderPartyTracker();
    }

    /* Mark on NPC */
    if (npc) {
        npc.isNemesisOf = npc.isNemesisOf || [];
        if (playerId && !npc.isNemesisOf.includes(playerId)) npc.isNemesisOf.push(playerId);
        npc.nemesisReason = reason;
        /* Propagate hostility to related NPCs */
        _propagateNemesisToRelated(npcId, playerId);
        if (typeof refreshNPCCard === 'function') refreshNPCCard(npcId);
    }

    closeNemesisModal();
    showToast(`${npc?.name || 'NPC'} is now a nemesis of ${player?.name || 'the player'} (${reason})`, 'success');
}

function _propagateNemesisToRelated(sourceNpcId, playerId) {
    if (typeof generatedNPCs === 'undefined') return;
    /* Any NPC in the same group, or a relative of the nemesis, will distrust the player */
    const sourceNpc = (typeof getNPCById === 'function') ? getNPCById(sourceNpcId) : null;
    if (!sourceNpc) return;
    generatedNPCs.forEach(npc => {
        if (npc.id === sourceNpcId) return;
        const related = (npc.groupName && npc.groupName === sourceNpc.groupName) ||
                        (npc.masterOf && npc.masterOf.id === sourceNpcId) ||
                        (sourceNpc.masterOf && sourceNpc.masterOf.id === npc.id);
        if (related) {
            if (!npc.distrustPlayers) npc.distrustPlayers = [];
            if (playerId && !npc.distrustPlayers.includes(playerId)) npc.distrustPlayers.push(playerId);
        }
    });
}

function closeNemesisModal() {
    const m = document.getElementById('nemesisModal');
    if (m) m.classList.remove('active');
}

/* Show nemesis warning on NPC card when a distrusted player is in party */
function getNemesisWarning(npc) {
    if (!npc) return '';
    const playerNemeses = _party.filter(p =>
        (p.nemeses||[]).some(n => n.npcId === npc.id) ||
        (npc.distrustPlayers||[]).includes(p.id)
    );
    if (!playerNemeses.length) return '';
    const names = playerNemeses.map(p => p.name).join(', ');
    const reason = (_nemesisRegistry[npc.id] || {}).reason || '';
    return `<div class="nemesis-warning-box">
        <strong>NEMESIS ALERT:</strong> ${npc.name} is hostile toward <strong>${names}</strong>
        ${reason ? ` (${reason})` : ''}.
        Nearby allies also distrust these players.
        <button onclick="openNemesisModal('${npc.id}')" style="margin-left:8px;padding:2px 8px;background:var(--red);color:white;border:none;border-radius:4px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;font-weight:700;">Edit</button>
    </div>`;
}

/* ── QUEST GENERATOR ─────────────────────────────────────────────────── */
function toggleQuestGen() {
    const body   = document.getElementById('questGenBody');
    const toggle = document.getElementById('questGenToggle');
    if (!body) return;
    const open = body.classList.toggle('open');
    if (toggle) toggle.classList.toggle('open', open);
}

/* ─ Master Quest Database ─ */
const QUEST_DB = {
    assassination: [
        { name: 'The Tyrant\'s Last Breath', setting_hint: 'city',
          hook: 'A powerful guild master has been systematically eliminating rival merchants, framing the deaths as accidents. Three families have lost everything. The guild master surrounds himself with a rotating team of mercenary guards and never leaves his heavily fortified estate except during the monthly tax ceremony.',
          objective: 'Assassinate Guild Master Varro Fen during the tax ceremony procession without implicating the party\'s employers. The death must look accidental or be pinned on a rival faction.',
          obstacles: 'Varro travels with six elite guards, a personal mage who detects lies, and a shield guardian. His route is announced only one hour in advance. Several merchants actually support him out of fear.',
          twist: 'Varro has a legitimate grievance — the city\'s ruling council framed him years ago, destroying his honest business. He became what they made him. His ledger, hidden in his estate, contains evidence that could topple the council.',
          resolution: 'The party may kill, expose, or even ally with Varro depending on what they discover. The council will send their own operatives to silence the party if they find the ledger.',
          reward_gp: '800-1200', reward_extra: 'Political favour from one of three rival factions + access to the black market',
          npc_hooks: ['villain_boss', 'contact', 'rival_group'] },

        { name: 'Blood on the Altar', setting_hint: 'dungeon',
          hook: 'A high priest of a death cult has been abducting people for ritual sacrifice. Authorities look the other way — the cult pays enormous bribes. Families of the missing have pooled their life savings to fund a private contract.',
          objective: 'Enter the cult\'s subterranean temple, reach the inner sanctum, and eliminate the high priest before the next blood moon — three days away.',
          obstacles: 'The temple has three descending layers guarded by fanatics, traps, and summoned undead. The high priest can sense life force and knows the party is coming from the moment they enter. Several captives complicate escape.',
          twist: 'One of the missing people is a cultist who went too deep and is now trying to escape from the inside. They have a map of the temple but will only share it if the party agrees to free all captives, not just complete the contract.',
          resolution: 'Freeing all captives takes extra time. The party must choose between a clean extraction and leaving some behind, or risking the blood moon ritual beginning mid-escape.',
          reward_gp: '600-900', reward_extra: 'Cult\'s ritual treasury + one uncommon magic item',
          npc_hooks: ['villain_boss', 'shopkeeper', 'relative'] },

        { name: 'The General Who Wouldn\'t Fall', setting_hint: 'war',
          hook: 'A military general is secretly negotiating the surrender of a fortress to enemy forces in exchange for personal wealth. The army\'s intelligence division has evidence but cannot act without triggering a political crisis. The party is contracted as deniable assets.',
          objective: 'Reach the general inside an active military camp, eliminate him before he opens the gates at midnight, and escape without being identified.',
          obstacles: 'The general is surrounded by loyal soldiers who do not know of his treachery. Killing him openly would cause chaos. His personal bodyguard — a disgraced paladin seeking redemption — is genuinely loyal and combat-exceptional.',
          twist: 'The bodyguard knows something is wrong but cannot bring herself to act against her sworn duty. If the party explains the truth and can provide even partial evidence, she will stand aside — or assist.',
          resolution: 'The general dead, the party must still escape a camp on high alert. The intelligence contact who hired them is captured in the chaos and must be freed or left behind.',
          reward_gp: '1200-1800', reward_extra: 'Military commendation (secret) + safe house in capital city',
          npc_hooks: ['villain_boss', 'rival_group', 'contact'] },
    ],
    retrieve: [
        { name: 'The Crown Beneath the City', setting_hint: 'dungeon',
          hook: 'The royal crown — a powerful artifact that legitimises the throne — was stolen during a palace coup eighteen months ago. The legitimate heir, currently in exile, has located it: buried in the catacombs beneath the occupied capital, held by the usurper\'s chief archivist.',
          objective: 'Enter the catacombs via a forgotten smuggler\'s tunnel, retrieve the crown from the archivist\'s vault, and deliver it to the heir\'s envoy waiting outside the city walls.',
          obstacles: 'The catacombs are patrolled by undead the archivist uses as security. The vault has a magical lock that requires a specific blood key — the archivist carries it. Above, the city is under martial law with frequent patrols.',
          twist: 'The archivist is not loyal to the usurper — she has been protecting the crown, waiting for the right moment. She will hand it over willingly if convinced the heir is ready. But she is also dying of a curse and needs a cure the party may or may not have.',
          resolution: 'Delivering the crown triggers the heir\'s return and a city-wide uprising. The party is caught in the middle and must choose a side or escape the chaos.',
          reward_gp: '1500-2500', reward_extra: 'Titles + land grant from the restored monarchy',
          npc_hooks: ['contact', 'villain_boss', 'shopkeeper'] },

        { name: 'Stolen Proof', setting_hint: 'city',
          hook: 'A corrupt magistrate is about to sentence an innocent man to death. The only exonerating evidence — a signed confession from the real killer — was stolen from the defence attorney\'s office by agents unknown. Trial resumes in forty-eight hours.',
          objective: 'Find who stole the document and retrieve it intact within two days.',
          obstacles: 'The thief is a professional information broker who sold it to three different buyers. Only one buyer actually has the original; the others have copies. The magistrate\'s private security is watching the attorney. The real killer is still in the city.',
          twist: 'The real killer is the magistrate\'s nephew. The magistrate knows his nephew is guilty. He is not corrupt from greed but from love — and is breaking under the weight of it.',
          resolution: 'The party can expose both or leverage the confession to force the magistrate to recuse himself and free the prisoner. The magistrate may become an asset or enemy depending on how the confrontation goes.',
          reward_gp: '400-600', reward_extra: 'Debt from a senior attorney + access to court records',
          npc_hooks: ['contact', 'shopkeeper', 'relative'] },

        { name: 'The Merchant\'s Debt', setting_hint: 'sea',
          hook: 'A shipping manifest detailing massive smuggling operations — enough to destroy several noble families — was intercepted at sea and is now aboard a pirate vessel anchored off a remote island. Both the nobles and the crown want it. The party is hired by the crown.',
          objective: 'Board the pirate vessel, locate the manifest in the captain\'s locked cabin, and return with it before the nobles\' agents reach the island.',
          obstacles: 'The pirate crew is forty strong and not hostile to the party yet — they don\'t know what everyone wants. The captain is paranoid and has already moved the manifest twice. The noble agents arrive one day after the party.',
          twist: 'The pirate captain is a former crown agent who went rogue after being betrayed. She knows far more than the manifest — she has memorised its contents. She may be the more valuable asset.',
          resolution: 'Returning the manifest ends the smuggling ring but destroys three noble families and several hundred of their servants\' livelihoods. The captain offers an alternative: let her expose the nobles herself, in exchange for a full pardon.',
          reward_gp: '900-1400', reward_extra: 'Naval safe passage + letter of marque',
          npc_hooks: ['villain_boss', 'contact', 'shopkeeper', 'group'] },
    ],
    escort: [
        { name: 'The Last Witness', setting_hint: 'city',
          hook: 'A young woman named Tessaly witnessed a high-ranking official commit murder. She agreed to testify but the trial is in a city three days\' journey away. Three assassination attempts in two days. The city watch is compromised.',
          objective: 'Escort Tessaly safely to the court city and ensure she can testify. Every faction with something to hide will try to stop her.',
          obstacles: 'Tessaly is traumatised and prone to panicking, making stealth travel difficult. She has a chronic illness requiring a specific medicine available only in towns along the route. One pursuer group is willing to burn down an inn to reach her.',
          twist: 'Tessaly is not entirely innocent — she was originally an accomplice who was double-crossed. Her testimony is true but incomplete. The official she is testifying against does not know this and is acting disproportionately out of paranoia rather than actual guilt for murder.',
          resolution: 'The actual murderer is a third party who manipulated both Tessaly and the official. If the party investigates, they can expose the true killer — but only if they keep Tessaly alive and cooperating.',
          reward_gp: '500-800', reward_extra: 'Immunity from prosecution in the city + safe house',
          npc_hooks: ['contact', 'rival_group', 'relative'] },

        { name: 'The Pilgrim Road', setting_hint: 'wilderness',
          hook: 'A group of forty pilgrims must reach the Shrine of the Undying Flame for the Solstice ceremony — which only occurs once every seven years. The route crosses lands controlled by three different hostile factions, each with their own reasons for stopping the pilgrimage.',
          objective: 'Get all forty pilgrims to the shrine alive before the solstice in five days.',
          obstacles: 'The pilgrims include elderly members who cannot move fast, a family with a sick child, and a young man secretly fleeing a gang who will pursue the whole group. One hostile faction controls the fastest route.',
          twist: 'The gang pursuing the young man is actually a thieves\' guild trying to recover stolen holy artefacts the young man has hidden on his person — artefacts belonging to the very shrine the pilgrims are trying to reach.',
          resolution: 'Returning the artefacts to the shrine may actually require the party to take them from a scared young man who believed he was rescuing them from the guild. The truth is more complicated than either story.',
          reward_gp: '350-550', reward_extra: 'Blessed by the shrine (attunement bonus for one month) + pilgrim network safe passage across three regions',
          npc_hooks: ['relative', 'contact', 'shopkeeper'] },
    ],
    investigate: [
        { name: 'The Vanishing Quarter', setting_hint: 'city',
          hook: 'In a prosperous merchant district, six businesses have gone silent in three weeks. No violence. No signs of struggle. Owners, staff, stock — all gone. The buildings are empty but locked from the inside. No one is reporting missing persons because no one agrees on who is missing.',
          objective: 'Determine what is happening in the vanishing quarter and stop it before more businesses disappear.',
          obstacles: 'Witnesses give contradictory accounts. City records show some of the missing businesses never existed. A strange sigil keeps appearing on the doors of businesses the night before they vanish.',
          twist: 'A wizard\'s failed pocket dimension experiment has been slowly consuming portions of the district, trapping people in a demi-plane adjacent to reality. The victims are alive, confused, and running out of food.',
          resolution: 'Rescuing the victims requires finding the wizard (who is also trapped inside), repairing the rift from within, and collapsing it without destroying the buildings it has consumed — which now house the victims.',
          reward_gp: '600-950', reward_extra: 'Grateful merchant consortium membership + wizard\'s laboratory contents',
          npc_hooks: ['villain_boss', 'contact', 'shopkeeper', 'group'] },

        { name: 'The Truthless Oracle', setting_hint: 'dungeon',
          hook: 'An oracle renowned for absolute accuracy has given three consecutive false prophecies. Kingdoms made decisions based on those prophecies. Two of those decisions led to disasters. The oracle insists the prophecies were true. Someone is altering events to make the prophecies false — or altering the prophecies themselves.',
          objective: 'Discover whether the oracle has been corrupted, is being manipulated, or is genuinely prophesying futures that are being deliberately sabotaged.',
          obstacles: 'The oracle\'s chamber is magically sealed against deception-detection. Records of the original prophecies may have been altered. At least two separate factions have a motive to sabotage the oracle.',
          twist: 'The oracle is not a person but an entity sustained by collective belief. As more people doubt it, its visions become less reliable. The sabotage is not physical but psychological — a disinformation campaign deliberately designed to destroy faith in the oracle and thereby destroy the oracle itself.',
          resolution: 'The party must simultaneously expose the disinformation, restore public trust, and protect the oracle from a physical assault planned to coincide with its moment of maximum weakness.',
          reward_gp: '800-1300', reward_extra: 'One true prophecy (DM decides) + rare divination components',
          npc_hooks: ['villain_boss', 'contact', 'group'] },

        { name: 'Dead Letters', setting_hint: 'city',
          hook: 'A post master has been murdered — the third in six months in different cities along a major trade route. All three deaths occurred after the victims intercepted and delayed the same type of sealed diplomatic letter. The current post master has received one such letter this morning.',
          objective: 'Protect the current post master and uncover why these letters are deadly to anyone who delays them.',
          obstacles: 'The party cannot read the letters (magically sealed and self-destructing if tampered with). The killer is a professional who has so far left no evidence. The diplomatic parties sending the letters are powerful enough to cause an incident if interfered with.',
          twist: 'The letters contain activation codes for sleeper agents embedded in each city. Each time a letter was delayed, the sleeper agent in that city was burned — murdered by the organisation to prevent exposure. The killers are not the letter senders but the sleeper network itself, eliminating loose ends.',
          resolution: 'The current sleeper agent in this city is a beloved local figure who does not yet know they are about to be killed. The party must find them before the assassin does — then decide what to do with the information.',
          reward_gp: '500-750', reward_extra: 'Intelligence service contacts + information on two other active conspiracies',
          npc_hooks: ['contact', 'relative', 'villain_boss', 'shopkeeper'] },

        { name: 'The Portrait Gallery', setting_hint: 'dungeon',
          hook: 'A wealthy collector\'s estate has been found abandoned. Every room is perfectly maintained. Dinner is half-eaten on the table. But every portrait in the famous gallery has changed — all the painted figures now face a different direction, and three paintings depict scenes that were not there before.',
          objective: 'Determine what happened to the collector and the dozen staff and guests who were in the estate.',
          obstacles: 'The paintings seem to respond to observation — moving only when not directly watched. A sense of being watched pervades every room. Some paintings now depict recognisable people from local history who died violently.',
          twist: 'The collector purchased a cursed painting that acts as a portal to a dimension of pure artistic representation. Everyone in the estate has been absorbed into the paintings — alive but flattened into two dimensions, experiencing time differently. The paintings change because the trapped people are trying to send messages.',
          resolution: 'Reversing the curse requires entering one of the paintings voluntarily and navigating a two-dimensional world of impossible geometry to find and free the original cursed painting from within. The collector knows how — but the party must find his portrait first.',
          reward_gp: '700-1100', reward_extra: 'Estate contents + a portrait that can show the future of one person (one use)',
          npc_hooks: ['villain_boss', 'contact', 'shopkeeper'] },
    ],
    rescue: [
        { name: 'Below the Salt Flats', setting_hint: 'dungeon',
          hook: 'Twelve miners were trapped when a salt mine partially collapsed seven days ago. Rescue teams report strange sounds from below — chanting — and two rescue workers have vanished. The mine company wants silence. The miners\' families want them back.',
          objective: 'Reach the trapped miners, determine why rescue efforts keep failing, and bring everyone out alive.',
          obstacles: 'The collapsed section created a pocket the miners survived in, but they are not alone. Something was already down there when the collapse happened. The mine company secretly knows this and is hoping the miners die before they can talk.',
          twist: 'The miners discovered an ancient sealed chamber two days before the collapse — and opened it. The "chanting" is the miners responding to whatever they found. They are not in danger from the creature in the chamber; they are protecting it from the surface.',
          resolution: 'The creature is an ancient elemental bound by a forgotten civilisation. The mine company knew it was there and deliberately induced the collapse to prevent the miners exposing it — because controlling it would be worth more than the mine.',
          reward_gp: '400-650', reward_extra: 'Miners\' lifelong loyalty + exposure of mine company corruption',
          npc_hooks: ['villain_boss', 'contact', 'relative', 'group'] },

        { name: 'The Debtor\'s Prison', setting_hint: 'city',
          hook: 'A renowned scholar was arrested for debts she does not owe — fabricated by a rival who wants her research. She has been imprisoned in a private debtor\'s facility (technically legal, practically a dungeon) where guards do not ask questions.',
          objective: 'Extract the scholar from the facility before her rival extracts her research knowledge by other means.',
          obstacles: 'The facility is private property — breaking in is technically criminal. The legal route will take weeks. The scholar\'s rival has friends in the city judiciary. The facility warden is not cruel but is strictly by-the-book.',
          twist: 'The scholar has already given up most of her knowledge under psychological pressure. What remains — the crucial final piece — is encoded in a cipher only she can read. Her rival knows this and is not done with her.',
          resolution: 'Freeing the scholar is only half the mission. Her rival has already acted on the partial knowledge and is enacting something dangerous. The scholar must be kept safe while the party determines what her research was actually about and what is now being unleashed.',
          reward_gp: '500-800', reward_extra: 'Rare research access + magical formulae worth 400gp',
          npc_hooks: ['contact', 'villain_boss', 'shopkeeper'] },
    ],
    explore: [
        { name: 'The Cartographer\'s Last Map', setting_hint: 'wilderness',
          hook: 'A legendary cartographer died leaving one final map — of a location she called "the place where the world forgot to end." Scholars believe it points to a ruin from a civilisation predating recorded history. Two expeditions have already gone and not returned.',
          objective: 'Follow the map, reach the location, survive it, and return with whatever you find.',
          obstacles: 'The map uses a measurement system no longer in use, causing navigation errors. The wilderness route crosses three separate territories, each with their own dangers and political considerations. The previous expeditions left traces that suggest they reached the location.',
          twist: 'The civilisation did not fall — it deliberately made itself forgotten using mass-scale memory magic. Portions of that magic are still active. The party members will begin forgetting details of the location the further in they go. Notes become essential.',
          resolution: 'The civilisation\'s remnant population is still alive, sustained in a form of magical stasis, waiting for the memory-erasure to fade. They have knowledge of magic lost to the world. Whether to wake them, exploit them, or leave them is entirely the party\'s choice.',
          reward_gp: '900-1600', reward_extra: 'Historical artefacts (value varies by choices) + lost spell scrolls',
          npc_hooks: ['contact', 'group', 'shopkeeper'] },

        { name: 'The Drowned Archive', setting_hint: 'sea',
          hook: 'A great library sank into the sea two centuries ago during a catastrophe. Recent geological activity has pushed portions of it back near the surface — accessible via a network of partially flooded chambers. Scholars are desperate to recover texts before tidal cycles submerge it again in thirty days.',
          objective: 'Dive into the partially flooded library, navigate its dangerous chambers, and recover as many texts as possible before the tide window closes.',
          obstacles: 'The library was sealed against theft — traps still function. Sea creatures have nested in the outer sections. Some chambers are fully flooded requiring breath-hold or magic. Rival scholars from another institution are also racing to recover texts.',
          twist: 'The catastrophe was not an accident. The library was deliberately sunk by its own librarians to prevent a specific set of texts from reaching the surface. Those texts describe a ritual the librarians discovered would be misused. They are still correct to have hidden it.',
          resolution: 'Recovering the hidden texts means deciding what to do with genuinely dangerous knowledge. The rival scholars want everything. The texts could help someone — or arm someone catastrophically. The ghost of the lead librarian appears to explain why they sank the library and begs the party to respect the decision.',
          reward_gp: '800-2000', reward_extra: 'Historical texts (value by rarity) + breathing apparatus (magic)',
          npc_hooks: ['contact', 'rival_group', 'villain_boss'] },
    ],
    defend: [
        { name: 'The Siege That Cannot Be Won', setting_hint: 'wilderness',
          hook: 'A remote village of two hundred people is about to be overrun by a mercenary company hired to clear them from land that a powerful noble wants. The village has three days before the mercenaries arrive. It cannot be evacuated in time and cannot win a direct fight.',
          objective: 'Protect the village through three days until a legal intervention can be arranged — without losing more than fifty lives.',
          obstacles: 'The mercenaries are professional and disciplined. The village has no wall. Two of three days will have rain reducing visibility for both sides. The noble has a legal claim to the land (though obtained by fraud).',
          twist: 'The mercenary company commander is operating under false pretences — she was told the land is empty, not occupied. If she learns the truth, she will refuse the contract. But her employers anticipated this and sent their own agent to ensure she never finds out.',
          resolution: 'The party must simultaneously defend the village, get the truth to the mercenary commander, and intercept the noble\'s agent — all while managing village morale and preventing locals from doing something catastrophically heroic.',
          reward_gp: '600-1000', reward_extra: 'Village land rights + community construction support + hidden family heirloom (minor magic item)',
          npc_hooks: ['villain_boss', 'contact', 'group', 'relative'] },

        { name: 'Last Night of the Festival', setting_hint: 'city',
          hook: 'A city-wide festival draws thousands of visitors — and provides cover for a terrorist attack planned by a radical faction. City guard intelligence has intercepted fragments of the plan but not the target or method. They have twelve hours before the festival climaxes.',
          objective: 'Identify the target, locate the faction\'s operatives hidden among tens of thousands of festival-goers, and prevent the attack without causing a panic that would itself cause deaths.',
          obstacles: 'Operatives are disguised as festival workers and merchants. The intelligence fragments point to three possible targets simultaneously. Creating a public alert would cause the operatives to abort and scatter, losing them entirely.',
          twist: 'The faction is not trying to kill anyone. The "attack" is a large-scale ritual to break a magical seal in the city\'s foundations — one placed centuries ago by a tyrant. Breaking the seal frees a bound entity that the faction believes will save the city. The entity will not.',
          resolution: 'Stopping the ritual requires understanding what the seal actually does and what it holds. The faction\'s intelligence is partly correct and partly wrong. A more targeted intervention — working with the faction rather than against them — may be possible.',
          reward_gp: '700-1200', reward_extra: 'City guardianship title + access to sealed city records',
          npc_hooks: ['villain_boss', 'contact', 'group', 'rival_group'] },
    ],
    political: [
        { name: 'The Peace That Breaks Everything', setting_hint: 'city',
          hook: 'Two rival noble houses are about to sign a peace treaty after forty years of conflict. The treaty is genuine — both patriarchs actually want peace. But within both houses are factions who have built power on the war and will do anything to prevent the signing.',
          objective: 'Ensure the peace treaty is signed in five days by protecting both negotiators from their own people.',
          obstacles: 'The party cannot know who within each house is part of the anti-peace faction. Assassination attempts must be prevented without exposing the treaty process to the public. One negotiator is in poor health and the stress is dangerous.',
          twist: 'A third party — a merchant consortium — has funded the conflict for decades and is funding the saboteurs on both sides simultaneously. They have no preference which house wins; they profit from war itself.',
          resolution: 'Exposing the consortium requires evidence they have deliberately hidden. Getting it means the party must infiltrate a neutral party — the merchant consortium — while simultaneously protecting the peace negotiations. Success ends the war and creates a powerful enemy.',
          reward_gp: '1000-2000', reward_extra: 'Noble house favours from both parties + appointment as official mediators',
          npc_hooks: ['villain_boss', 'contact', 'rival_group', 'shopkeeper'] },
    ],
    curse: [
        { name: 'The Town That Dreams', setting_hint: 'wilderness',
          hook: 'A market town of eight hundred people has fallen into an unnatural sleep. They breathe, they are warm, but nothing wakes them. It has been eleven days. Food and water left in mouths is consumed overnight. Something is keeping them alive and keeping them asleep.',
          objective: 'Discover the source of the curse and break it before the thirteenth night — when, according to a warning left on the town gate, the sleepers will dream themselves to death.',
          obstacles: 'Entering the dream state voluntarily is possible via a rare herb found in the local forest — but navigating a shared dream of eight hundred people is disorienting and dangerous. The curse\'s origin is in a memory shared by all the sleepers simultaneously.',
          twist: 'The town is dreaming collectively about something that actually happened — something they all agreed to forget. The curse is self-inflicted: a deal made with a fey entity to forget a terrible communal act they committed fifty years ago. The forgetting is unravelling.',
          resolution: 'The party must enter the dream, witness what the town did, and then confront the fey entity. Breaking the curse means the town remembers. What they remember is not simple evil — it was a terrible choice made under terrible circumstances. Justice is ambiguous.',
          reward_gp: '600-1000', reward_extra: 'Fey bond (one request from local fey court) + grateful town resources',
          npc_hooks: ['villain_boss', 'contact', 'shopkeeper', 'relative'] },
    ],
    war: [
        { name: 'The Long Retreat', setting_hint: 'wilderness',
          hook: 'A retreating army column of four hundred soldiers and five hundred civilians is being tracked by an enemy force three times its size. The column commander has been killed. The surviving officers are arguing. The column has twelve days before it reaches safety.',
          objective: 'Keep the column together, resolve the leadership crisis, and get the civilians to safety while slowing the pursuing force without stopping it (a full engagement would be suicidal).',
          obstacles: 'The column has three days of food. The route crosses a river that floods unpredictably. Two of the surviving officers are actively sabotaging each other\'s plans. The enemy has cavalry and will catch the column if it stops for more than four hours.',
          twist: 'The enemy commander is actively trying to capture, not destroy, the column — specifically because a civilian among the refugees is a person of enormous value to the enemy. They do not know which civilian. Neither does the party.',
          resolution: 'Figuring out who the enemy wants — and why — changes the calculus entirely. The person the enemy wants is not an enemy; they are a defector who was carrying crucial information. What happens with that information determines the outcome of the broader war.',
          reward_gp: '900-1500', reward_extra: 'Military rank + access to war council + magical supply cache',
          npc_hooks: ['contact', 'villain_boss', 'group', 'rival_group'] },
    ],
    divine: [
        { name: 'The God That Stopped Listening', setting_hint: 'dungeon',
          hook: 'Clerics of a major deity have lost all connection to their god simultaneously — spells fail, visions stop, divine symbols go dark. It has been three weeks. No scripture covers this. The church hierarchy is fracturing between those who believe the god is testing them and those who believe the god is dead.',
          objective: 'Discover what has severed the divine connection and restore it — or confirm the truth of what has happened.',
          obstacles: 'The church is not unified — factions will try to prevent the party from discovering the truth if it contradicts their position. The physical location of the severance is in a demi-plane accessible only via a ritual the party must reconstruct from fragments.',
          twist: 'The god is not dead and not testing the church. The god is occupied — fighting something else entirely, something that attacked the divine plane itself. The connection was severed deliberately by the god to prevent the attack from using mortal connections as vectors.',
          resolution: 'The party can reach the edge of the divine plane and witness what is happening. They cannot fix it — but they may be able to provide aid in a way that accelerates the god\'s victory. The church must then be told the truth: their god is fighting for its life.',
          reward_gp: '1000-2000', reward_extra: 'Direct divine favour (equivalent to a 5th-level divine spell, one use) + church resources',
          npc_hooks: ['contact', 'villain_boss', 'group'] },
    ],
    criminal: [
        { name: 'The Underground Exchange', setting_hint: 'city',
          hook: 'A major criminal organisation is about to sell a stolen magical weapon — one capable of levelling city blocks — to the highest bidder at an underground auction. Three factions want it: a foreign military, a nihilist cult, and a collector who may or may not be trustworthy. The city guard cannot be involved.',
          objective: 'Attend the auction undercover, identify all buyers, and prevent the weapon from leaving with anyone who will use it destructively — ideally retrieving it.',
          obstacles: 'Entry to the auction requires a voucher from an existing client. Weapons checks at the door. The auction has its own security force. All buyers have their own agents present. The weapon\'s power makes it unstable — any incident risks detonation.',
          twist: 'The "collector" who seems trustworthy is actually the weapon\'s original designer who thought it was destroyed. They want to dismantle it — but they also want to confirm whether their theoretical design worked, which means activating it once.',
          resolution: 'Getting the weapon out safely requires the designer\'s cooperation, which means trusting their stated intentions under time pressure in a room full of people who want to kill everyone else. The weapon works. The question is what they do with that knowledge.',
          reward_gp: '1200-2500', reward_extra: 'Underworld contacts + one faction\'s resources + the designer\'s workshop',
          npc_hooks: ['villain_boss', 'contact', 'rival_group', 'shopkeeper'] },
    ],
};

/* Side quest database — can relate to main quest themes */
const SIDE_QUEST_DB = [
    { name: 'The Innkeeper\'s Son',
      summary: 'The innkeeper where the party is staying is quietly desperate. Her teenage son ran away three days ago after a fight, and she has heard he fell in with a local criminal gang who use runaway children as lookouts.',
      detail: 'The gang is small and non-violent with the boy — he is actually being treated reasonably well and does not want to leave. He ran away for real reasons. The mother and son both need to be heard before anything can be resolved.',
      complication: 'The gang is currently hiding someone the city watch is looking for — not a criminal, but a political refugee. Interfering brings the watch into a situation that was not their business.',
      resolution: 'The son can be recovered but only if someone addresses the root issue — the mother\'s controlling behaviour — or at least acknowledges it. The political refugee is a separate problem the party can engage with or ignore.',
      reward: '100-200gp + innkeeper\'s loyalty (free lodging, reliable information source)',
      npc_hooks: ['relative', 'contact'] },

    { name: 'The Old Soldier\'s Request',
      summary: 'A decorated veteran, old and unwell, approaches the party. She has one request before she dies: retrieve a specific item from a battle site three days\' travel away — the last place she saw her company before they were wiped out.',
      detail: 'The item is a regimental standard. The battle site is now occupied by the descendants of the enemy soldiers who won that battle — now a farming settlement with no hostility toward the party. The standard is in their community hall as a trophy.',
      complication: 'The farmers know what the standard is and why it was taken. They are willing to return it, but they have a counter-request: acknowledgement from the veteran\'s side that the battle involved a war crime committed by her unit, not just honourable defeat.',
      resolution: 'The veteran knows about the war crime. She has carried it for forty years. She wanted the standard not as a trophy but to burn it — to finally put it down. The farmers do not know this.',
      reward: '150gp + veteran\'s family sword (a +1 weapon) + community contact in the farming settlement',
      npc_hooks: ['relative', 'contact'] },

    { name: 'The Wrong Map',
      summary: 'A local cartographer sells the party a map to a location they mention — but the map is wrong in a very specific way. When confronted, the cartographer admits she altered it deliberately. She will not say why.',
      detail: 'The correct route passes through land the cartographer sold to a development consortium after being pressured. She redirected travellers to cover the fact that she has not disclosed an active hazard on the land — a magical instability she knew about.',
      complication: 'The consortium has already begun construction. Workers are in danger. The cartographer has been receiving threats to stay quiet from consortium representatives.',
      resolution: 'Exposing the consortium saves the workers but costs the cartographer her business and potentially her freedom. Finding another way to protect the workers — without exposing her — requires creative problem-solving and may not be possible.',
      reward: '200-300gp from consortium victims + corrected map collection (valuable) + grateful workers',
      npc_hooks: ['shopkeeper', 'contact'] },

    { name: 'A Debt in Blood',
      summary: 'A person approaches the party claiming to have information relevant to their current quest — but only if the party first helps them settle a specific and personal grievance.',
      detail: 'The grievance involves a former employer who cheated them out of three years of wages by technically legal but deeply dishonest means. The employer is wealthy, well-connected, and insulated from normal legal remedy.',
      complication: 'The information the contact has is real and valuable. The employer is also doing something genuinely illegal that the authorities would want to know about — but revealing it would implicate the contact in the initial fraud since they witnessed it and said nothing.',
      resolution: 'There is a resolution that satisfies everyone except the employer, but it requires careful negotiation and accepting moral complexity. The employer is not entirely wrong either — the contact made a mistake they have not admitted to.',
      reward: 'Critical information for main quest + 150gp + contact as recurring ally',
      npc_hooks: ['contact', 'shopkeeper'] },

    { name: 'The Herbalist\'s Garden',
      summary: 'A renowned herbalist\'s garden has been dying over three weeks despite her best efforts. Several rare plants she cultivates are the only local source of a specific medicinal ingredient many in the region depend on.',
      detail: 'The cause is magical contamination seeping up through the soil from below — from something buried in the garden generations ago. The herbalist does not know what it is. Digging reveals a sealed chest with a family crest.',
      complication: 'The chest belongs to an old noble family — or rather, to a branch of that family thought to be extinct. The contents are a magical weapon wrapped in a contract. The contract is with a devil, still technically active.',
      resolution: 'The weapon must be moved — but every option has a downside. Destroying it voids the contract but may release whatever the contract was containing. Returning it to the family requires finding the family. Selling it makes the problem someone else\'s.',
      reward: '200gp + medicinal supplies (equivalent to 10 healing potions) + herbalist contacts',
      npc_hooks: ['shopkeeper', 'relative'] },

    { name: 'The Apprentice\'s Mistake',
      summary: 'A young wizard\'s apprentice, trying to impress their master, cast a spell far beyond their ability. Something went wrong. Now a specific part of the city — about four city blocks — is stuck in a two-hour time loop.',
      detail: 'People inside the loop have noticed but cannot escape it. They have been cycling through the same two hours for an unknown number of repetitions. Some have given up. Some have gone a little mad. The apprentice is terrified and hiding.',
      complication: 'The master wizard knows the apprentice did this and is covering it up to avoid professional embarrassment. This is making the fix harder because the master won\'t provide the necessary ritual components.',
      resolution: 'Breaking the loop requires the master\'s cooperation, which requires either exposing them or finding a way to give them a face-saving exit. The people inside the loop have some say in the resolution — several of them have used the loop time productively.',
      reward: '250-400gp from grateful loop-victims + wizard\'s grudging magical assistance once + locked spell components',
      npc_hooks: ['contact', 'shopkeeper'] },

    { name: 'Missing at the Crossroads',
      summary: 'Four travellers have gone missing at the same crossroads over six weeks, all travelling the same direction. No bodies. No signs of struggle. A merchant\'s guild has posted a bounty.',
      detail: 'A creature — not hostile by nature — has been drawing travellers off the road out of curiosity and then cannot return them because it cannot re-enter the material plane. The travellers are alive and annoyed in a pocket of the ethereal plane.',
      complication: 'The creature is a juvenile entity that does not understand what it is doing is harmful. Its parent — a much larger entity — is looking for it and is not pleased that mortals are in the vicinity of its child.',
      resolution: 'Freeing the travellers requires communicating with the creature, which requires magic or creative problem-solving. Avoiding conflict with the parent requires not harming the juvenile. If the party harms either entity, the parent becomes a real problem.',
      reward: '300gp bounty + 4 grateful former captives (one has a relevant skill) + ethereal navigation knowledge',
      npc_hooks: ['contact', 'relative', 'group'] },

    { name: 'The Retiring Thief',
      summary: 'A master thief has decided to go legitimate and is trying to return items they stole over a thirty-year career. They need discreet help because several items rightfully belong to people who would have the thief arrested on sight.',
      detail: 'The returns are emotionally complex. One item is a family portrait from a house destroyed in a fire — the only surviving piece, and the family that owned it no longer exists. One item is a confession letter that would destroy an innocent person if revealed.',
      complication: 'The thief does not know what is in the confession letter. They stole it without reading it. Whoever they return it to may use it in ways the thief would not approve of. And one of the items is not actually stolen — it was given, and the thief\'s memory of that moment is not accurate.',
      resolution: 'Helping the thief requires making judgment calls about what \'return\' means for each item. The letter is the most fraught — the innocent person whose reputation it would destroy is now a powerful official who has made enemies who would exploit the letter.',
      reward: '200gp + thief\'s network access + one favour from a master lockpick + one legitimate deed returned to its rightful owner (valuable property)',
      npc_hooks: ['contact', 'shopkeeper', 'relative'] },

    { name: 'The Census Taker',
      summary: 'A census official working through a remote rural district has not reported back in two weeks. Her district supervisor has had no luck getting anyone to investigate. The census is legally required and politically sensitive.',
      detail: 'The census taker entered a village that officially does not exist on any records. The village has been hidden for three generations by an enchantment placed by a reclusive mage — the villagers did not want to pay taxes or serve in wars.',
      complication: 'The census taker is alive, comfortable, and has decided she likes this village and is not particularly inclined to report it — but she also cannot leave due to the enchantment\'s effect on her memory. She keeps forgetting the way out.',
      resolution: 'The village must decide whether to be found, which means losing the protections of obscurity. The mage who cast the enchantment is long dead, but their descendant maintains it. That descendant has their own reasons for the hiding, and those reasons are not about taxes.',
      reward: '150-250gp + secret community contact + access to truly off-grid safe haven',
      npc_hooks: ['contact', 'relative', 'shopkeeper'] },

    { name: 'The Bard\'s Debt',
      summary: 'A bard who helped the party in a past town shows up unexpectedly in their current location. They are being pursued by members of a performers\' guild for breach of contract — specifically for performing a song the guild owns without paying royalties, forty-seven times.',
      detail: 'The guild\'s claim is technically legitimate but morally absurd — the song was composed by the bard\'s deceased teacher, who gave it to the bard personally before dying. The guild acquired rights to the song via a legal sleight of hand after the teacher\'s death.',
      complication: 'The guild has political connections and has already had a warrant issued. Fighting them in court would take months and the bard cannot afford it. The guild\'s representative is not a bad person — they are simply doing their job and are privately uncomfortable with this one.',
      resolution: 'Finding an alternative resolution requires creative legal or political thinking, or finding evidence the guild\'s acquisition of the rights was fraudulent. The bard\'s teacher may have left documentation that was overlooked.',
      reward: 'Bard joins party temporarily (helpful skills) + guild enemy/ally depending on resolution + 100gp in performance income',
      npc_hooks: ['contact', 'relative'] },

    { name: 'The Haunted Landmark',
      summary: 'A well-known local landmark — a bridge, a tower, a crossroads statue — has become genuinely dangerous. Three people have been hurt (none fatally) by apparent poltergeist activity in the past week. Locals are afraid and avoiding it.',
      detail: 'The haunting is real but the ghost is not malicious — it is confused and distressed. A construction project nearby disturbed the grave of a person who died violently on the site, and their unfinished business is specifically tied to the landmark.',
      complication: 'The construction project is legally permitted and well underway. Stopping it to resolve the haunting would cost the construction company significant money. The company is not evil — they simply did not know.',
      resolution: 'The ghost\'s unfinished business involves someone still living — a descendant of the person who caused their death. That descendant knows about their ancestor\'s act and has been quietly trying to make amends for years. They just did not know how or to whom.',
      reward: '200-350gp from local council + ghost\'s gratitude (minor blessing) + information from the descendant',
      npc_hooks: ['contact', 'relative', 'shopkeeper'] },

    { name: 'Three Funerals',
      summary: 'Three prominent community members have died in one week. Officially, natural causes for all three. Unofficially, people are scared. There has not been a suspicious death in this community in living memory.',
      detail: 'All three had one thing in common: they were the last surviving witnesses to an event thirty years ago that was ruled an accident but was not. Someone has returned to close loose ends.',
      complication: 'A fourth potential witness exists and does not know they are in danger. Finding them requires reconstructing the event from thirty-year-old memories and records. The killer is not what the party expects — they are not acting from personal gain but from what they believe is justice.',
      resolution: 'The killer\'s grievance is legitimate — the three victims did cause real harm thirty years ago and faced no consequences. The fourth witness is more complicated: they were a child at the time and did not truly understand what they were part of. What justice looks like here is entirely ambiguous.',
      reward: '250-400gp + access to community records + complex moral resolution',
      npc_hooks: ['contact', 'relative', 'villain_boss'] },

    { name: 'The Middleman',
      summary: 'A merchant who deals in information rather than goods approaches the party with a proposition: there is something in their current area they do not know they are sitting on, and she will tell them what it is in exchange for a retrieval service.',
      detail: 'The retrieval service involves collecting a sealed package from a specific location — a location that turns out to be a rival information broker\'s safehouse. The package contains intelligence the merchant bought and paid for but the rival is refusing to hand over.',
      complication: 'The rival has not refused out of dishonesty — the intelligence has become more valuable since the sale and is now dangerous to release. It names a specific person who has since become very powerful and very protective of that secret.',
      resolution: 'The party is now holding intelligence that: the original merchant wants, the powerful person will kill to suppress, and the rival believes should be publicly released. What they do with it has major ripple effects and three different people will owe or hate them depending on the choice.',
      reward: 'Information relevant to current main quest + 300gp + information broker network access',
      npc_hooks: ['shopkeeper', 'contact', 'villain_boss'] },
];

/* Completely random side quests — short, punchy, unconnected to main quest */
const RANDOM_SIDE_QUESTS = [
    { name: 'Someone\'s Chicken',
      text: 'A child is crying in the street because her chicken, Buttons, escaped from its pen and is now somewhere in the market district. The chicken has an uncanny ability to get into locked places, knows it is being chased, and has been seen entering the house of the most irritable person in town.',
      reward: '1 silver + child\'s gratitude + a very good egg for breakfast' },
    { name: 'The Duelist\'s Honour',
      text: 'A young noble challenges one party member to a duel at dawn over a perceived slight that the party member definitely did not commit. The actual culprit is someone who looks slightly like the party member. The noble will not hear reason. The duel is first blood and the noble is actually quite good.',
      reward: '50gp if won diplomatically + noble contact + the real culprit owes a favour' },
    { name: 'Counterfeit Kindness',
      text: 'A merchant is furious to discover that the generous donation made to a local orphanage in his name — something he did not do — has made everyone think he is a good person. He is now forced to maintain the reputation or look worse than before. He wants to find out who did it.',
      reward: '120gp + merchant\'s grudging respect + mystery donor\'s identity (interesting person)' },
    { name: 'The Fastest Route',
      text: 'A courier offers the party double rate to carry an urgent package to a location one hour away, refusing to explain what is inside. The package is ticking. Loudly. Actually, it is just a very elaborate music box, but that does not become clear until the party decides how to handle it.',
      reward: '80gp + courier network contact + music box (worth 200gp to the right buyer)' },
    { name: 'Wrong Address',
      text: 'A package arrives at the party\'s lodgings addressed to a name none of them go by. Inside is a very detailed letter about a crime that has not happened yet, clearly intended for someone who was supposed to stop it. The sender is already dead.',
      reward: 'Leads to a secondary investigation + 100gp for acting on the information' },
    { name: 'The Betting Pool',
      text: 'The party has been entered, without their knowledge, into a local betting pool about whether they will succeed in their current quest. The odds are not flattering. The person who organised the pool is the innkeeper. A local organized crime figure has bet heavily against them.',
      reward: 'If they win the pool pays out 300gp to the party + the crime figure becomes a mild antagonist' },
    { name: 'Borrowed Without Asking',
      text: 'An item belonging to one party member — nothing critical — has been borrowed by a local teenager who needed it for a very specific reason they will not fully explain. The item was returned before the party noticed, but they left something behind by accident: evidence of a local conspiracy they are clearly unaware of.',
      reward: '150gp + accidental conspiracy information + teenager as informant' },
    { name: 'The Pet Project',
      text: 'A wizard\'s experimental familiar — neither animal nor construct — has escaped and is following the party. It has selected one member as its new owner and will not leave. It is not dangerous but it is extremely opinionated, communicates in complex gestures, and has already eaten something it found in the party\'s bags.',
      reward: 'Unconventional familiar if accepted + wizard\'s gratitude + wizard\'s discount on components' },
    { name: 'One Unpaid Tab',
      text: 'An old adventurer left a significant unpaid tab at a tavern years ago. The tavern owner has somehow concluded that one of the party members is related to the adventurer and is refusing to serve them until the debt (12gp) is settled. The actual debt turns out to have a very complicated history involving a drinking contest, a wizard, and a goat.',
      reward: '12gp cost + full story (valuable as entertainment) + the original adventurer\'s stored equipment (worth it)' },
    { name: 'The Town Play',
      text: 'The town\'s annual theatrical production has lost its lead actor to a sprained ankle two days before the performance. The director has decided, through logic they will not justify, that one party member is the right replacement. The play is historically inaccurate, politically sensitive, and very long.',
      reward: '75gp performance fee + town favour + one audience member is a person of note who enjoyed the show' },
    { name: 'Found: One Dragon Scale',
      text: 'A child brings the party a large iridescent scale she found near the river. It is real. It is fresh. There are no other dragons known to be in this region. The child wants to keep it but her parents want it gone. There are three competing explanations for where it came from and only one of them is safe.',
      reward: 'Dragon scale (valuable) + leads to regional dragon situation + child contacts (useful family)' },
    { name: 'The Missing Night',
      text: 'One party member wakes up with a full day they cannot account for. Everyone else experienced the day normally. The missing person was seen, spoken to, and apparently behaved entirely normally — they just have no memory of it. What they apparently did during the missing day was impressive, helpful, and completely out of character.',
      reward: 'Mystery + one completed task from the missing day + one confused NPC who thinks they are now friends with that party member' },
    { name: 'The Generous Bequest',
      text: 'A will is being read in the next town and one party member has been named as a beneficiary. No one knows why. The bequest is not money but a house, a cat, and an extensive library. The cat does not trust strangers. The library contains something that was not supposed to survive.',
      reward: 'Property deed + cat (opinionated, possibly magical) + rare book collection including one prohibited text' },
    { name: 'Competition Day',
      text: 'The party arrives in town on the day of the annual skills competition. Entry is open. Events include archery, cooking, herb identification, arm wrestling, and an oration competition on the topic "the most important quality in a leader." First place in each event wins a surprisingly useful prize.',
      reward: 'Event prizes (varied, DM selects) + town renown + competition champion receives a standing invitation to the governor\'s table' },
    { name: 'Just Passing Through',
      text: 'A very large creature — not aggressive, clearly migrating — passes through the region during the party\'s travel. It causes enormous disruption simply by existing near settlements: buildings shake, wells go murky, livestock scatter. Several local attempts to "deal with it" risk provoking something that would be catastrophic if actually provoked.',
      reward: '200gp from local council for keeping the peace + creature\'s incidental favour (it noticed who helped)' },
];

/* Difficulty gold ranges */
const DIFF_GOLD = {
    easy: [150, 400], medium: [400, 900], hard: [900, 1800],
    deadly: [1800, 4000], legendary: [4000, 10000]
};
const DIFF_LABELS = {
    easy: 'Easy', medium: 'Medium', hard: 'Hard', deadly: 'Deadly', legendary: 'Legendary'
};
const DIFF_COLORS = {
    easy: 'q-diff-easy', medium: 'q-diff-medium', hard: 'q-diff-hard',
    deadly: 'q-diff-deadly', legendary: 'q-diff-legendary'
};

function _pickQuestFromType(type) {
    const pool = QUEST_DB[type];
    return pool ? pick(pool) : pick(Object.values(QUEST_DB).flat());
}

function _goldRange(diff) {
    const [lo, hi] = DIFF_GOLD[diff] || [200, 600];
    const val = Math.round((lo + Math.random() * (hi - lo)) / 50) * 50;
    return val.toLocaleString() + 'gp';
}

/* ─ Render a quest card ─ */
function _renderQuestCard(q, type, diff, isMain, relatedSideQuests) {
    const typeBadge = isMain ? '<span class="q-badge q-main-badge">MAIN QUEST</span>'
        : '<span class="q-badge q-side-badge">SIDE QUEST</span>';
    const diffBadge = `<span class="q-badge ${DIFF_COLORS[diff]||'q-diff-medium'}">${DIFF_LABELS[diff]||diff}</span>`;
    const typeName = type.charAt(0).toUpperCase() + type.slice(1);
    const gold = _goldRange(diff);

    let npcBtns = '';
    const npcTypes = q.npc_hooks || [];
    if (npcTypes.includes('villain_boss'))  npcBtns += `<button class="q-npc-btn" onclick="questGenNPC('boss')">Generate Villain / Boss</button>`;
    if (npcTypes.includes('contact'))       npcBtns += `<button class="q-npc-btn" onclick="questGenNPC('npc')">Generate Quest Contact</button>`;
    if (npcTypes.includes('shopkeeper'))    npcBtns += `<button class="q-npc-btn" onclick="questGenShop()">Generate Shopkeeper / Merchant</button>`;
    if (npcTypes.includes('relative'))      npcBtns += `<button class="q-npc-btn" onclick="questGenRelative()">Generate Relative / Ally</button>`;
    if (npcTypes.includes('rival_group'))   npcBtns += `<button class="q-npc-btn" onclick="questGenGroup()">Generate Rival Group</button>`;
    if (npcTypes.includes('group'))         npcBtns += `<button class="q-npc-btn" onclick="questGenGroup()">Generate NPC Group</button>`;

    const cardClass = isMain ? 'qtype-main' : 'qtype-side';

    /* Extra DM-facing detail blocks (read-aloud, scenes, clues) */
    const extra = _questExtraBlocks(q);

    let sideHtml = '';
    if (isMain && relatedSideQuests && relatedSideQuests.length) {
        sideHtml = '<div style="margin-top:20px;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.85em;font-weight:700;color:#1a3a6a;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;border-bottom:2px solid #2a5aaa;padding-bottom:6px;">Related Side Quests</div>'
            + relatedSideQuests.map(sq => _renderSideCard(sq, diff)).join('')
            + '</div>';
    }

    return `<div class="quest-card ${cardClass}">
        <div class="quest-card-head">
            <div class="quest-card-head-left">
                <div class="quest-card-title">${q.name}</div>
                <div class="quest-card-sub">${typeName} &nbsp;·&nbsp; ${gold} reward</div>
            </div>
            <div class="quest-badges">${typeBadge}${diffBadge}</div>
        </div>
        <div class="quest-card-body">
            <div class="q-section"><div class="q-label">Hook</div><div class="q-text">${q.hook}</div></div>
            <div class="q-section"><div class="q-label">Objective</div><div class="q-text">${q.objective}</div></div>
            <div class="q-section"><div class="q-label">Obstacles &amp; Complications</div><div class="q-text">${q.obstacles}</div></div>
            <div class="q-section"><div class="q-label">Hidden Truth / Twist</div><div class="q-text">${q.twist}</div></div>
            <div class="q-section"><div class="q-label">Resolution Paths</div><div class="q-text">${q.resolution}</div></div>
            <div class="q-section"><div class="q-label">Rewards</div><div class="q-text">${gold} gold &nbsp;·&nbsp; ${q.reward_extra || 'Varies by resolution'}</div></div>
            ${extra}
            ${npcBtns ? `<div class="q-npc-actions">${npcBtns}</div>` : ''}
        </div>
        ${sideHtml}
    </div>`;
}

function _questExtraBlocks(q) {
    try {
        const hook = String(q && q.hook ? q.hook : '').trim();
        const readAloud = (q && q.readAloud && String(q.readAloud).trim())
            ? String(q.readAloud).trim()
            : (hook ? `Read aloud: "${hook.replace(/"/g,"'")}"` : 'Read aloud: "The situation is urgent, unclear, and pulling you forward."');

        const beatsPool = [
            'A clear lead points to a person who is scared to talk.',
            'A place of interest looks ordinary — until one detail is wrong.',
            'A complication forces a choice: speed vs safety, truth vs advantage, mercy vs certainty.',
            'The antagonist makes a move that changes the situation immediately.',
            'A clue reframes what the party thought the job was.'
        ];
        const cluePool = [
            'A witness statement that is mostly true — except for one critical omission.',
            'A written note, invoice, or symbol that links two factions.',
            'A rumor that becomes useful once the party has a name.',
            'A physical trace: mud, ash, salt, perfume, strange pollen, or unusual coinage.',
            'A magical residue or holy sign that implies a specific school or patron.'
        ];
        const pressurePool = [
            'A ticking clock: someone will flee, be moved, or be harmed by dawn.',
            'The party is watched; their questions are reported to someone.',
            'Doing the right thing costs money, time, or reputation.',
            'A rival group attempts the same job with a different method.',
            'The client’s request is precise for a reason they won’t explain.'
        ];

        const b1 = pick(beatsPool), b2 = pick(beatsPool), b3 = pick(beatsPool);
        const c1 = pick(cluePool), c2 = pick(cluePool);
        const p1 = pick(pressurePool);

        return `
        <div class="q-section">
            <div class="q-label">DM Read-Aloud</div>
            <div class="q-text" style="background:rgba(0,0,0,0.04);border-left:3px solid rgba(184,134,11,0.45);padding:10px 12px;border-radius:0 6px 6px 0;">
                <em>${readAloud}</em>
            </div>
        </div>
        <div class="q-section">
            <div class="q-label">3 Scene Beats (run it live)</div>
            <div class="q-text" style="line-height:1.9;">
                • ${b1}<br>
                • ${b2}<br>
                • ${b3}
            </div>
        </div>
        <div class="q-section">
            <div class="q-label">Clues to Drop</div>
            <div class="q-text">
                • ${c1}<br>
                • ${c2}
            </div>
        </div>
        <div class="q-section">
            <div class="q-label">Pressure / Timing</div>
            <div class="q-text">${p1}</div>
        </div>`;
    } catch(e) {
        return '';
    }
}

function _renderSideCard(sq, diff) {
    const gold = _goldRange(diff || 'easy');
    const npcTypes = sq.npc_hooks || [];
    let npcBtns = '';
    if (npcTypes.includes('contact'))    npcBtns += `<button class="q-npc-btn" onclick="questGenNPC('npc')">Generate Contact</button>`;
    if (npcTypes.includes('shopkeeper'))npcBtns += `<button class="q-npc-btn" onclick="questGenShop()">Generate Merchant</button>`;
    if (npcTypes.includes('relative'))  npcBtns += `<button class="q-npc-btn" onclick="questGenRelative()">Generate Relative</button>`;
    if (npcTypes.includes('villain_boss')) npcBtns += `<button class="q-npc-btn" onclick="questGenNPC('boss')">Generate Antagonist</button>`;
    if (npcTypes.includes('group'))     npcBtns += `<button class="q-npc-btn" onclick="questGenGroup()">Generate Group</button>`;

    return `<div class="quest-card qtype-side" style="margin-bottom:12px;">
        <div class="quest-card-head">
            <div class="quest-card-head-left">
                <div class="quest-card-title">${sq.name}</div>
                <div class="quest-card-sub">Side Quest &nbsp;·&nbsp; ${gold}</div>
            </div>
            <div class="quest-badges"><span class="q-badge q-side-badge">SIDE QUEST</span></div>
        </div>
        <div class="quest-card-body">
            <div class="q-section"><div class="q-label">Overview</div><div class="q-text">${sq.summary}</div></div>
            <div class="q-section"><div class="q-label">Full Detail</div><div class="q-text">${sq.detail}</div></div>
            <div class="q-section"><div class="q-label">Complication</div><div class="q-text">${sq.complication}</div></div>
            <div class="q-section"><div class="q-label">Resolution</div><div class="q-text">${sq.resolution}</div></div>
            <div class="q-section"><div class="q-label">Reward</div><div class="q-text">${sq.reward}</div></div>
            ${npcBtns ? `<div class="q-npc-actions">${npcBtns}</div>` : ''}
        </div>
    </div>`;
}

function _renderRandSideCard(rsq) {
    return `<div class="quest-card qtype-rand">
        <div class="quest-card-head">
            <div class="quest-card-head-left">
                <div class="quest-card-title">${rsq.name}</div>
                <div class="quest-card-sub">Random Side Quest &nbsp;·&nbsp; ${rsq.reward}</div>
            </div>
            <div class="quest-badges"><span class="q-badge q-rand-badge">RANDOM</span></div>
        </div>
        <div class="quest-card-body">
            <div class="q-section"><div class="q-text">${rsq.text}</div></div>
        </div>
    </div>`;
}

/* ─ Main generate functions ─ */
function generateFullQuest() {
    let type = document.getElementById('questType').value;
    let diff = document.getElementById('questDiff').value;
    const sideCount = parseInt(document.getElementById('questSideCount').value) || 2;

    /* Handle revenge type specially */
    if (type === 'revenge') { generateRevengeQuestFromKilled(); return; }

    const allTypes = Object.keys(QUEST_DB);
    if (!type || !QUEST_DB[type]) type = pick(allTypes);
    if (!diff) diff = pick(['easy','medium','hard','deadly','legendary']);

    const mainQuest = _pickQuestFromType(type);

    /* Pick related side quests — shuffle and take N */
    const shuffledSides = [...SIDE_QUEST_DB].sort(() => Math.random() - 0.5).slice(0, sideCount);

    const area = document.getElementById('questArea');
    area.innerHTML = _renderQuestCard(mainQuest, type, diff, true, shuffledSides);
}

function generateSideQuestsOnly() {
    let diff = document.getElementById('questDiff').value || pick(['easy','medium','hard']);
    const sideCount = parseInt(document.getElementById('questSideCount').value) || 2;
    const sides = [...SIDE_QUEST_DB].sort(() => Math.random() - 0.5).slice(0, Math.max(1, sideCount));

    const area = document.getElementById('questArea');
    area.innerHTML = sides.map(sq => _renderSideCard(sq, diff)).join('');
}

function generateRandomSideQuests() {
    const count = parseInt(document.getElementById('questSideCount').value) || 3;
    const randoms = [...RANDOM_SIDE_QUESTS].sort(() => Math.random() - 0.5).slice(0, Math.max(1, count));

    const area = document.getElementById('questArea');
    area.innerHTML = randoms.map(rsq => _renderRandSideCard(rsq)).join('');
}

/* ─ NPC generation from quest buttons ─ */
function questGenNPC(mode) {
    /* Set boss mode if needed, then generate */
    const bossEl = document.getElementById('bossMode');
    if (bossEl) bossEl.checked = (mode === 'boss');
    if (typeof generateBatch === 'function') generateBatch();
    showToast(mode === 'boss' ? 'Generating villain / boss NPC...' : 'Generating quest contact NPC...', 'success');
    /* Scroll to NPC area */
    const tabs = document.getElementById('npcTabsContainer');
    if (tabs) tabs.scrollIntoView({ behavior: 'smooth' });
}

function questGenShop() {
    if (typeof generateStorefront === 'function') generateStorefront();
    showToast('Generating quest merchant...', 'success');
    const tabs = document.getElementById('npcTabsContainer');
    if (tabs) tabs.scrollIntoView({ behavior: 'smooth' });
}

function questGenRelative() {
    /* Generate a standalone NPC first if none exist */
    if (typeof generatedNPCs !== 'undefined' && generatedNPCs.length === 0) {
        if (typeof generateBatch === 'function') generateBatch();
    }
    if (typeof generateRelative === 'function') generateRelative();
    showToast('Generating related character...', 'success');
    const tabs = document.getElementById('npcTabsContainer');
    if (tabs) tabs.scrollIntoView({ behavior: 'smooth' });
}

function questGenGroup() {
    if (typeof generateGroup === 'function') generateGroup();
    showToast('Generating NPC group...', 'success');
    const tabs = document.getElementById('npcTabsContainer');
    if (tabs) tabs.scrollIntoView({ behavior: 'smooth' });
}

/* ── BOOT: init on DOMContentLoaded ────────────────────────────────── */
document.addEventListener('DOMContentLoaded', function() {
    /* Party tracker */
    renderPartyTracker();
    /* Open quest panel by default */
    const questBody = document.getElementById('questGenBody');
    const questToggle = document.getElementById('questGenToggle');
    if (questBody) { questBody.classList.add('open'); }
    if (questToggle) { questToggle.classList.add('open'); }
});

/* ════════════════════════════════════════════════════════════════════════
   MEGA FEATURE BLOCK — All new additions, zero original code touched
   ════════════════════════════════════════════════════════════════════════

   1.  Session Notes v2 — titled notes, save/load/delete, NPC tags
   2.  NPC Dialog Options — personality-driven, quest-linked
   3.  Battle Map Generator — canvas-based, quest/boss aware
   4.  Quest Save / Print system
   5.  Initiative Player Input — add party to initiative order
   ════════════════════════════════════════════════════════════════════════ */

/* ─── 1: SESSION NOTES v2 ──────────────────────────────────────────── */
let _notes = [];
let _currentNoteId = null;
try { _notes = JSON.parse(localStorage.getItem('npcgen_notes_v2') || '[]'); } catch(e) { _notes = []; }

function _saveNotes() { if (window._isOneShot) return; try { localStorage.setItem('npcgen_notes_v2', JSON.stringify(_notes)); } catch(e){} }

function _refreshNotesDropdown() {
    const sel = document.getElementById('notesDropdown');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Previous Notes --</option>'
        + _notes.map(n => `<option value="${n.id}">${n.title || 'Untitled'} (${n.date || ''})</option>`).join('');
    if (_currentNoteId) sel.value = _currentNoteId;
}

function _refreshNotesNpcTags() {
    const area = document.getElementById('notesNpcTagArea');
    if (!area) return;
    let saved = [];
    try { saved = JSON.parse(localStorage.getItem('dm_vault') || '[]'); } catch(e){}
    const note = _notes.find(n => n.id === _currentNoteId);
    const tagged = note ? (note.taggedNpcs || []) : [];
    area.innerHTML = saved.slice(0,20).map(npc =>
        `<span class="notes-npc-tag" onclick="_toggleNpcNoteTag('${npc.id}','${(npc.name||'NPC').replace(/'/g,"\\'").replace(/"/g,'&quot;')}',this)"
              style="${tagged.includes(npc.id) ? 'background:var(--red);color:white;' : ''}"
              data-npc-id="${npc.id}">${npc.name || 'NPC'}</span>`
    ).join('') || '<span style="font-size:0.78em;color:#aaa;">No saved NPCs yet</span>';
    _refreshTaggedNpcPills();
}

function _refreshTaggedNpcPills() {
    const area = document.getElementById('notesTaggedNpcs');
    if (!area) return;
    const note = _notes.find(n => n.id === _currentNoteId);
    const tagged = note ? (note.taggedNpcs || []) : [];
    const taggedNames = note ? (note.taggedNpcNames || []) : [];
    if (!tagged.length) { area.innerHTML = ''; return; }
    area.innerHTML = tagged.map((id,i) =>
        `<span class="notes-npc-tag" style="background:var(--red);color:white;"
              onclick="_openTaggedNpc('${id}')">${taggedNames[i] || id} &rarr;</span>`
    ).join('');
}

function _toggleNpcNoteTag(npcId, npcName, el) {
    if (!_currentNoteId) { showToast('Save this note first before tagging NPCs', 'success'); return; }
    const note = _notes.find(n => n.id === _currentNoteId);
    if (!note) return;
    if (!note.taggedNpcs) note.taggedNpcs = [];
    if (!note.taggedNpcNames) note.taggedNpcNames = [];
    const idx = note.taggedNpcs.indexOf(npcId);
    if (idx > -1) {
        note.taggedNpcs.splice(idx,1);
        note.taggedNpcNames.splice(idx,1);
        el.style.background = ''; el.style.color = '';
    } else {
        note.taggedNpcs.push(npcId);
        note.taggedNpcNames.push(npcName);
        el.style.background = 'var(--red)'; el.style.color = 'white';
    }
    _saveNotes();
    _refreshTaggedNpcPills();
}

function _openTaggedNpc(npcId) {
    let saved = [];
    try { saved = JSON.parse(localStorage.getItem('dm_vault') || '[]'); } catch(e){}
    const npc = saved.find(n => n.id === npcId);
    if (!npc) { showToast('NPC not found in vault', 'warning'); return; }
    if (typeof loadNPC === 'function') loadNPC(npcId);
    else showToast('Opening ' + (npc.name || 'NPC'), 'success');
}

function loadNoteFromDropdown() {
    const sel = document.getElementById('notesDropdown');
    if (!sel || !sel.value) return;
    const note = _notes.find(n => n.id === sel.value);
    if (!note) return;
    _currentNoteId = note.id;
    document.getElementById('notesTitleInput').value = note.title || '';
    document.getElementById('notesTextArea').value = note.text || '';
    _refreshNotesNpcTags();
}

function saveCurrentNote() {
    const title = (document.getElementById('notesTitleInput').value || '').trim() || 'Untitled Note';
    const text  = document.getElementById('notesTextArea').value || '';
    const now   = new Date();
    const date  = now.toLocaleDateString();
    if (!_currentNoteId) _currentNoteId = 'note_' + Date.now();
    let note = _notes.find(n => n.id === _currentNoteId);
    if (!note) { note = { id: _currentNoteId, taggedNpcs: [], taggedNpcNames: [] }; _notes.unshift(note); }
    note.title = title; note.text = text; note.date = date;
    _saveNotes();
    _refreshNotesDropdown();
    _refreshNotesNpcTags();
    showToast('Note saved: ' + title, 'success');
}

function newNote() {
    _currentNoteId = null;
    document.getElementById('notesTitleInput').value = '';
    document.getElementById('notesTextArea').value = '';
    _refreshNotesNpcTags();
    _refreshTaggedNpcPills();
    _refreshNotesDropdown();
    showToast('New note ready', 'success');
}

function deleteCurrentNote() {
    if (!_currentNoteId) return;
    _notes = _notes.filter(n => n.id !== _currentNoteId);
    _saveNotes();
    newNote();
    showToast('Note deleted', 'success');
}

/* Patch toggleSessionNotes to refresh notes UI */
const _origToggleSessionNotes = window.toggleSessionNotes;
window.toggleSessionNotes = function() {
    if (_origToggleSessionNotes) _origToggleSessionNotes();
    setTimeout(() => {
        _refreshNotesDropdown();
        _refreshNotesNpcTags();
    }, 50);
};

/* ─── 2: NPC DIALOG OPTIONS ─────────────────────────────────────────── */
const _DIALOG_BY_PERSONALITY = {
    Aggressive: [
        { label: 'Greeting',     text: '"What do you want? Make it quick — I have no patience for time-wasters."' },
        { label: 'Quest Info',   text: '"You want information? Then prove you\'re worth talking to. What\'s in it for me, and why shouldn\'t I just take what I want from you instead?"' },
        { label: 'Threatened',   text: '"You think that scares me? I\'ve put down people twice your size. Don\'t push your luck."' },
        { label: 'Ally Request', text: '"Work with you? Maybe. But I lead, you follow. I don\'t take orders from anyone."' },
    ],
    Charming: [
        { label: 'Greeting',     text: '"My, what interesting company. Please — sit, sit. Can I offer you something? A drink, a story, a favour perhaps?"' },
        { label: 'Quest Info',   text: '"Of course I know something about that. But darling, good information is like good wine — it deserves the right setting. Walk with me."' },
        { label: 'Threatened',   text: '"Violence? How terribly unimaginative. I\'m sure we can find something we both want without anyone getting hurt."' },
        { label: 'Ally Request', text: '"Oh, I\'d love to help. And I will — just as soon as we agree on what I get out of this little arrangement."' },
    ],
    Suspicious: [
        { label: 'Greeting',     text: '"Stop right there. Who sent you? And before you answer — I already know you\'re lying, so try the truth this time."' },
        { label: 'Quest Info',   text: '"Why are you asking about that? Who else have you asked? No — answer my question first."' },
        { label: 'Threatened',   text: '"Interesting. You\'d threaten me here, in public. That tells me you either don\'t know who I am or you do. Which is it?"' },
        { label: 'Ally Request', text: '"Allies. Right. Last three people who used that word to me needed something. What is it you actually want?"' },
    ],
    Wise: [
        { label: 'Greeting',     text: '"You\'ve travelled far to stand here. Rest for a moment. There\'s no conversation worth rushing."' },
        { label: 'Quest Info',   text: '"I know the path you\'re asking about. But knowing and surviving are different things. Let me ask you something first — why do you really want this?"' },
        { label: 'Threatened',   text: '"I\'ve lived long enough to know that most threats come from fear. What are you afraid of? That\'s the real question here."' },
        { label: 'Ally Request', text: '"You need my help. I understand. But I\'ve learned to ask what a person values before agreeing to anything. Tell me — what matters most to you?"' },
    ],
    Nervous: [
        { label: 'Greeting',     text: '"Oh — I didn\'t hear you come in. Sorry, I just — can I help you? Please don\'t make this take long."' },
        { label: 'Quest Info',   text: '"I shouldn\'t be talking about this. People who talk about this tend to — look, I know something, but you didn\'t hear it from me. Agreed?"' },
        { label: 'Threatened',   text: '"Please — please, there\'s no need for that. I\'ll tell you what I know. Just... keep your voice down."' },
        { label: 'Ally Request', text: '"You want me to help? I — I want to help, I do. But there are people watching and if they see me with you..."' },
    ],
    Greedy: [
        { label: 'Greeting',     text: '"Let\'s skip the pleasantries. You\'ve got something you need and I\'ve got something you want. How much are you offering?"' },
        { label: 'Quest Info',   text: '"That information? Very valuable. The price just went up, by the way, just for making me wait. What are you paying?"' },
        { label: 'Threatened',   text: '"You\'re threatening the person who has what you need. Interesting strategy. The price just doubled."' },
        { label: 'Ally Request', text: '"Loyalty is expensive. Give me a number and I\'ll tell you if it\'s in the right direction."' },
    ],
    Honourable: [
        { label: 'Greeting',     text: '"Well met, traveller. I am at your service — within the bounds of my code, of course. What brings you here?"' },
        { label: 'Quest Info',   text: '"I know of it. And if you pursue it, pursue it with integrity. There are no shortcuts on a worthy path."' },
        { label: 'Threatened',   text: '"Draw if you must. But know that I will not yield to threats, and I will not attack without cause. Choose carefully."' },
        { label: 'Ally Request', text: '"I will stand with you. But I need your word — your actual word — that our methods will be ones I can answer for."' },
    ],
    Mysterious: [
        { label: 'Greeting',     text: '"You found me. Or perhaps I found you. These things are rarely accidental. What is it you\'ve been looking for?"' },
        { label: 'Quest Info',   text: '"What you seek is closer than you think and farther than you\'re prepared for. The real question is whether you want to know before you go."' },
        { label: 'Threatened',   text: '"You\'re certain I should be afraid right now? Interesting. Most people sense something before they try this."' },
        { label: 'Ally Request', text: '"Allies. Yes. I\'ve been expecting this particular conversation. What took you so long?"' },
    ],
    Cowardly: [
        { label: 'Greeting',     text: '"I — yes? What? Sorry, I thought you were someone else. Can I help you with something? Quickly?"' },
        { label: 'Quest Info',   text: '"Oh, that. I know something about that and I\'d really rather I didn\'t. Fine. Fine — but if anyone asks, you didn\'t hear it from me."' },
        { label: 'Threatened',   text: '"No, no, please — I\'ll cooperate, I always cooperate. Whatever you need. Just please don\'t."' },
        { label: 'Ally Request', text: '"Help? Me? I\'m not — I mean, I could, theoretically. If it\'s genuinely not that dangerous. Define dangerous."' },
    ],
    Cruel: [
        { label: 'Greeting',     text: '"You\'re interrupting something. Make this worth my time or I\'ll make the interruption worth yours."' },
        { label: 'Quest Info',   text: '"Oh, I know exactly where that is. I was there. I\'ll tell you — for a price. Not gold. Something more interesting."' },
        { label: 'Threatened',   text: '"Go ahead. Do it. And then watch what happens to everyone you\'ve spoken to in the last week. I have a very long reach."' },
        { label: 'Ally Request', text: '"Work with you? Certainly. Just understand that if this goes wrong, you take the fall. That\'s the arrangement."' },
    ],
};

const _DIALOG_QUEST_CONTACT = [
    { label: 'Quest Offer',   text: '"I\'ve heard you\'re people who get things done — discreetly. I have a job. It pays well and asks no questions. Are you interested?"' },
    { label: 'Quest Update',  text: '"There\'s been a development. The situation is more complicated than I first described. I need you to hear this before you go any further."' },
    { label: 'Quest Warning', text: '"Listen carefully. What I\'m about to tell you doesn\'t leave this conversation. The person you\'re going after — they\'re not who you think they are."' },
    { label: 'Reward Discussion', text: '"The reward stands. Bring me proof and the gold is yours, no questions asked. I appreciate people who keep their word."' },
];

const _DIALOG_VILLAIN = [
    { label: 'Monologue',       text: '"You\'ve come very far. I\'ll give you that much credit. Most people who reach this point don\'t leave it. You\'re about to understand why."' },
    { label: 'Ultimatum',       text: '"Here\'s what\'s going to happen. You\'re going to stand aside, and I\'m going to finish what I started. The only choice you have is how much this hurts."' },
    { label: 'False Bargain',   text: '"I can be reasonable. Lay down your weapons and walk away. I\'ll let you live. You have my word." (This is a lie.)' },
    { label: 'Villain Reveal',  text: '"You still don\'t understand, do you? Everything you\'ve been told about this — about me — is wrong. They lied to you. I\'ll tell you why."' },
    { label: 'During Combat',   text: '"Is that the best you can do? I\'ve been waiting years for a real challenge. This is disappointing."' },
    { label: 'Near Defeat',     text: '"Impossible. You can\'t have — no. This isn\'t over. I have contingencies. You\'ll find out what they are."' },
];

const _DIALOG_SHOPKEEPER = [
    { label: 'Welcome',          text: '"Come in, come in — browse as long as you like. If you break anything, you bought it, but I suspect you\'re not the breaking type."' },
    { label: 'Bargaining',       text: '"That\'s the price and it\'s a fair one. I\'ll tell you what — buy two and I\'ll knock a coin off the third. That\'s as generous as I get."' },
    { label: 'Rare Item',        text: '"That one? Not for sale. Well — everything has a price, but that price would take the breath out of you. Still interested?"' },
    { label: 'Gathering Info',   text: '"I hear things in this trade. A merchant sees everything and everyone. What is it you\'re trying to find out?"' },
];

const _DIALOG_RELATIVE = [
    { label: 'Initial Meeting',  text: '"You know them? Then you know me — or you will. Anything they told you about our history, assume it\'s half true and missing the important part."' },
    { label: 'Seeking Help',     text: '"I don\'t ask for help. I never ask for help. But this — this is different. They\'re in danger and I can\'t reach them myself. Will you help me or not?"' },
    { label: 'Complex Feelings', text: '"My relationship with them is... it\'s not simple. It never has been. But whatever happens, they\'re mine to look after. Mine to worry about."' },
];

function _generateDialogOptions(npc) {
    if (!npc) return '';
    let options = [];
    let sectionTitle = 'Dialog Options';

    if (npc.isBoss) {
        options = _DIALOG_VILLAIN;
        sectionTitle = 'Villain Dialog — ' + (npc.name || 'Boss');
    } else if (npc.isRelative || npc.relativeOf) {
        options = [...(_DIALOG_BY_PERSONALITY[npc.personality] || _DIALOG_BY_PERSONALITY['Charming']).slice(0,2), ..._DIALOG_RELATIVE.slice(0,2)];
        sectionTitle = 'Family Ties Dialog — ' + (npc.name || 'NPC');
    } else if (npc.questRole === 'contact') {
        options = [...(_DIALOG_BY_PERSONALITY[npc.personality] || _DIALOG_BY_PERSONALITY['Charming']).slice(0,2), ..._DIALOG_QUEST_CONTACT.slice(0,2)];
        sectionTitle = 'Quest Contact Dialog — ' + (npc.name || 'NPC');
    } else if (npc.isShopkeeper || npc.shopType) {
        options = _DIALOG_SHOPKEEPER;
        sectionTitle = 'Merchant Dialog — ' + (npc.name || 'NPC');
    } else {
        const personality = npc.personality || Object.keys(_DIALOG_BY_PERSONALITY)[0];
        const pool = _DIALOG_BY_PERSONALITY[personality] || _DIALOG_BY_PERSONALITY['Charming'];
        options = pool;
        sectionTitle = personality + ' — Dialog Options';
    }

    return `<div class="dialog-section">
        <div class="dialog-section-header">${sectionTitle}</div>
        ${options.map(o => `<div class="dialog-option">
            <div class="dialog-label">${o.label}</div>
            <div class="dialog-text">${o.text}</div>
        </div>`).join('')}
    </div>`;
}

/* Inject dialog into NPC cards via MutationObserver */
(function patchDialogInjection() {
    const observer = new MutationObserver(mutations => {
        mutations.forEach(m => {
            m.addedNodes.forEach(node => {
                if (node.nodeType !== 1) return;
                const cards = node.classList && node.classList.contains('npc-card')
                    ? [node] : Array.from(node.querySelectorAll('.npc-card'));
                cards.forEach(card => _injectDialogIntoCard(card));
            });
        });
    });
    const area = document.getElementById('displayArea');
    if (area) observer.observe(area, { childList: true, subtree: true });
})();

function _injectDialogIntoCard(card) {
    if (!card || card.dataset.dialogInjected) return;
    card.dataset.dialogInjected = '1';
    const npcId = (card.id || '').replace('card-','');
    const npc = typeof getNPCById === 'function' ? getNPCById(npcId) : null;
    if (!npc) return;
    const toolbar = card.querySelector('.card-toolbar');
    if (!toolbar) return;
    const dialogHtml = _generateDialogOptions(npc);
    if (!dialogHtml) return;
    const div = document.createElement('div');
    div.innerHTML = dialogHtml;
    toolbar.parentNode.insertBefore(div, toolbar);
}

/* ─── 3: BATTLE MAP GENERATOR ──────────────────────────────────────── */
const _MAP_THEMES = {
    dungeon:    { floor:'#2a2030', wall:'#1a1020', accent:'#4a3850', water:'#0a1820', obj:'#6a5870', name:'Stone Dungeon' },
    wilderness: { floor:'#1a2810', wall:'#0a1808', accent:'#2a4020', water:'#0a2030', obj:'#3a5030', name:'Forest Clearing' },
    city:       { floor:'#2a2018', wall:'#1a1408', accent:'#3a3020', water:'#0a1828', obj:'#4a3828', name:'City District' },
    cave:       { floor:'#1a1828', wall:'#100c18', accent:'#2a2038', water:'#080c18', obj:'#302040', name:'Underground Cave' },
    sea:        { floor:'#082030', wall:'#041018', accent:'#0a2840', water:'#0a2838', obj:'#104050', name:'Coastal or Ship' },
    planar:     { floor:'#1a0828', wall:'#0c0414', accent:'#2a0840', water:'#0a0418', obj:'#380c50', name:'Otherworldly Plane' },
    temple:     { floor:'#281810', wall:'#180c08', accent:'#382010', water:'#0a1010', obj:'#483020', name:'Ancient Temple' },
    tavern:     { floor:'#2a1808', wall:'#180e04', accent:'#3a2010', water:'#0a0808', obj:'#482810', name:'Tavern Interior' },
    boss:       { floor:'#1a0820', wall:'#0c0410', accent:'#3a0020', water:'#040008', obj:'#580030', name:'Boss Chamber' },
};

function _getMapThemeFromQuest(questText) {
    if (!questText) return _MAP_THEMES['dungeon'];
    const t = questText.toLowerCase();
    if (/sea|ship|coast|ocean|port|island/.test(t)) return _MAP_THEMES['sea'];
    if (/wilderness|forest|jungle|swamp|mountain|road/.test(t)) return _MAP_THEMES['wilderness'];
    if (/city|town|street|market|urban/.test(t)) return _MAP_THEMES['city'];
    if (/tavern|inn|bar/.test(t)) return _MAP_THEMES['tavern'];
    if (/cave|cavern|underground/.test(t)) return _MAP_THEMES['cave'];
    if (/temple|shrine|church|divine/.test(t)) return _MAP_THEMES['temple'];
    if (/planar|otherworldly|realm|demon|devil|celestial/.test(t)) return _MAP_THEMES['planar'];
    return _MAP_THEMES['dungeon'];
}

function _drawBattleMap(canvas, theme, title, isBoss) {
    if (!canvas) return [];
    const W = canvas.width, H = canvas.height;
    const ctx = canvas.getContext('2d');
    const th = theme || _MAP_THEMES['dungeon'];
    const detailMode = (window._dmAppSettings && window._dmAppSettings.mapDetail) || 'balanced';
    const detailMul = detailMode === 'high' ? 1.35 : (detailMode === 'low' ? 0.75 : 1);
    const CELL = 32;
    const COLS = Math.floor(W / CELL);
    const ROWS = Math.floor(H / CELL);

    ctx.fillStyle = th.wall;
    ctx.fillRect(0,0,W,H);

    const rooms = [];
    const numRooms = isBoss ? 1 : Math.floor(3 + Math.random() * 4);

    if (isBoss) {
        const rw = Math.floor(COLS * 0.65), rh = Math.floor(ROWS * 0.65);
        const rx = Math.floor((COLS - rw) / 2), ry = Math.floor((ROWS - rh) / 2);
        rooms.push({ x:rx, y:ry, w:rw, h:rh, main:true });
    } else {
        for (let i = 0; i < numRooms; i++) {
            const rw = Math.floor(4 + Math.random() * 7);
            const rh = Math.floor(3 + Math.random() * 6);
            const rx = Math.floor(1 + Math.random() * (COLS - rw - 2));
            const ry = Math.floor(1 + Math.random() * (ROWS - rh - 2));
            rooms.push({ x:rx, y:ry, w:rw, h:rh, main:i===0 });
        }
    }

    rooms.forEach(r => {
        ctx.fillStyle = th.floor;
        ctx.fillRect(r.x*CELL, r.y*CELL, r.w*CELL, r.h*CELL);
        ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 0.5;
        for (let gx = r.x; gx < r.x + r.w; gx++) {
            for (let gy = r.y; gy < r.y + r.h; gy++) {
                ctx.strokeRect(gx*CELL, gy*CELL, CELL, CELL);
            }
        }
        ctx.strokeStyle = th.accent; ctx.lineWidth = 2;
        ctx.strokeRect(r.x*CELL, r.y*CELL, r.w*CELL, r.h*CELL);
    });

    const corridors = [];
    for (let i = 1; i < rooms.length; i++) {
        const a = rooms[i-1], b = rooms[i];
        const ax = Math.floor(a.x + a.w/2), ay = Math.floor(a.y + a.h/2);
        const bx = Math.floor(b.x + b.w/2), by = Math.floor(b.y + b.h/2);
        const minX = Math.min(ax,bx), maxX = Math.max(ax,bx);
        const minY = Math.min(ay,by), maxY = Math.max(ay,by);
        ctx.fillStyle = th.floor;
        ctx.fillRect(minX*CELL, ay*CELL, (maxX-minX+1)*CELL, CELL);
        ctx.fillRect(bx*CELL, minY*CELL, CELL, (maxY-minY+1)*CELL);
        ctx.strokeStyle = th.accent; ctx.lineWidth = 1;
        ctx.strokeRect(minX*CELL, ay*CELL, (maxX-minX+1)*CELL, CELL);
        ctx.strokeRect(bx*CELL, minY*CELL, CELL, (maxY-minY+1)*CELL);
        corridors.push({ ax:ax, ay:ay, bx:bx, by:by });
    }

    const legend = [];
    const mainRoom = rooms.find(r=>r.main) || rooms[0];

    if (isBoss) {
        const bx = (mainRoom.x + Math.floor(mainRoom.w/2)) * CELL;
        const by = (mainRoom.y + 2) * CELL;
        ctx.fillStyle = '#8b0000'; ctx.fillRect(bx-CELL, by, CELL*2, CELL);
        ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2; ctx.strokeRect(bx-CELL, by, CELL*2, CELL);
        ctx.fillStyle = '#ffd700'; ctx.font = 'bold 14px serif'; ctx.textAlign='center';
        ctx.fillText('B', bx, by + CELL*0.65);
        legend.push({ color:'#8b0000', label:'Boss Starting Position' });

        [[mainRoom.x+1, mainRoom.y+1],[mainRoom.x+mainRoom.w-2, mainRoom.y+1],
         [mainRoom.x+1, mainRoom.y+mainRoom.h-2],[mainRoom.x+mainRoom.w-2, mainRoom.y+mainRoom.h-2]].forEach(([px,py]) => {
            ctx.fillStyle = th.obj;
            ctx.beginPath(); ctx.arc(px*CELL+CELL/2, py*CELL+CELL/2, CELL*0.4, 0,Math.PI*2); ctx.fill();
            ctx.strokeStyle = th.accent; ctx.lineWidth=1; ctx.stroke();
        });
        legend.push({ color:th.obj, label:'Pillars / Obstacles' });

        const ex = (mainRoom.x + Math.floor(mainRoom.w/2)) * CELL;
        const ey = (mainRoom.y + mainRoom.h - 1) * CELL;
        ctx.fillStyle = '#27ae60'; ctx.fillRect(ex-CELL/2, ey, CELL, CELL);
        ctx.fillStyle='white'; ctx.font='10px serif'; ctx.textAlign='center'; ctx.fillText('IN', ex, ey+CELL*0.65);
        legend.push({ color:'#27ae60', label:'Party Entrance' });

        /* Boss aura rings */
        ctx.strokeStyle = 'rgba(139,0,0,0.3)'; ctx.lineWidth = 1;
        [CELL*2, CELL*3.5].forEach(r => {
            ctx.beginPath(); ctx.arc(bx, by+CELL/2, r, 0, Math.PI*2); ctx.stroke();
        });
    } else {
        const sx = (mainRoom.x + 1) * CELL;
        const sy = (mainRoom.y + mainRoom.h - 2) * CELL;
        for (let p = 0; p < Math.min(4, COLS); p++) {
            ctx.fillStyle = 'rgba(46,204,113,0.7)';
            ctx.beginPath(); ctx.arc(sx + p*CELL + CELL/2, sy+CELL/2, CELL*0.35, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle='white'; ctx.font='bold 10px serif'; ctx.textAlign='center';
            ctx.fillText('P'+(p+1), sx+p*CELL+CELL/2, sy+CELL/2+4);
        }
        legend.push({ color:'rgba(46,204,113,0.7)', label:'Player Spawn' });

        rooms.slice(1).forEach(r => {
            const ex = (r.x + Math.floor(r.w/2)) * CELL;
            const ey = (r.y + Math.floor(r.h/2)) * CELL;
            ctx.fillStyle = 'rgba(231,76,60,0.8)';
            ctx.beginPath(); ctx.arc(ex+CELL/2, ey+CELL/2, CELL*0.38, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle='white'; ctx.font='bold 11px serif'; ctx.textAlign='center';
            ctx.fillText('E', ex+CELL/2, ey+CELL/2+4);
        });
        legend.push({ color:'rgba(231,76,60,0.8)', label:'Enemy Position' });

        rooms.forEach(r => {
            if (Math.random() > 0.5) {
                const ox = r.x + Math.floor(Math.random()*(r.w-1));
                const oy = r.y + Math.floor(Math.random()*(r.h-1));
                ctx.fillStyle = th.obj;
                ctx.fillRect(ox*CELL+4, oy*CELL+4, CELL-8, CELL-8);
            }
        });
        legend.push({ color:th.obj, label:'Obstacles / Cover' });

        if (Math.random() > 0.5 && rooms.length) {
            const wr = rooms[Math.floor(Math.random()*rooms.length)];
            ctx.fillStyle = th.water;
            ctx.fillRect((wr.x+1)*CELL, (wr.y+Math.floor(wr.h/2))*CELL, CELL*2, CELL);
            legend.push({ color:th.water, label:'Water / Hazard' });
        }
    }

    /* Door markers on corridors */
    corridors.forEach(function(c) {
        if (Math.random() > 0.72) return;
        const dx = Math.floor((c.ax + c.bx) / 2) * CELL;
        const dy = Math.floor((c.ay + c.by) / 2) * CELL;
        ctx.fillStyle = 'rgba(101,67,33,0.95)';
        ctx.fillRect(dx + 6, dy + 12, CELL - 12, 8);
        ctx.strokeStyle = '#d2b48c';
        ctx.lineWidth = 1;
        ctx.strokeRect(dx + 6, dy + 12, CELL - 12, 8);
    });
    if (corridors.length) legend.push({ color:'rgba(101,67,33,0.95)', label:'Doors / Chokepoints' });

    /* Difficult terrain patches */
    const terrainPatches = Math.max(1, Math.floor((rooms.length / 2) * detailMul));
    for (let i = 0; i < terrainPatches; i++) {
        const rr = rooms[Math.floor(Math.random() * rooms.length)];
        if (!rr) continue;
        const tx = rr.x + Math.floor(Math.random() * Math.max(1, rr.w - 1));
        const ty = rr.y + Math.floor(Math.random() * Math.max(1, rr.h - 1));
        ctx.fillStyle = 'rgba(245,180,66,0.22)';
        ctx.fillRect(tx * CELL + 2, ty * CELL + 2, CELL - 4, CELL - 4);
        ctx.strokeStyle = 'rgba(255,220,150,0.5)';
        ctx.strokeRect(tx * CELL + 4, ty * CELL + 4, CELL - 8, CELL - 8);
    }
    legend.push({ color:'rgba(245,180,66,0.22)', label:'Difficult Terrain' });

    /* Trap or objective nodes */
    const trapCount = isBoss ? Math.max(3, Math.floor(3 * detailMul)) : Math.max(2, Math.floor((rooms.length / 2) * detailMul));
    for (let i = 0; i < trapCount; i++) {
        const rr = rooms[Math.floor(Math.random() * rooms.length)];
        if (!rr) continue;
        const tx = (rr.x + Math.floor(Math.random() * Math.max(1, rr.w))) * CELL + CELL / 2;
        const ty = (rr.y + Math.floor(Math.random() * Math.max(1, rr.h))) * CELL + CELL / 2;
        ctx.strokeStyle = 'rgba(255,90,90,0.85)';
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(tx - 6, ty - 6); ctx.lineTo(tx + 6, ty + 6); ctx.moveTo(tx + 6, ty - 6); ctx.lineTo(tx - 6, ty + 6); ctx.stroke();
    }
    legend.push({ color:'rgba(255,90,90,0.85)', label:'Traps / Objectives' });

    /* Subtle lighting vignette */
    const glow = ctx.createRadialGradient(W / 2, H / 2, Math.min(W, H) * 0.12, W / 2, H / 2, Math.max(W, H) * 0.65);
    glow.addColorStop(0, 'rgba(255,255,255,0)');
    glow.addColorStop(1, 'rgba(0,0,0,0.22)');
    ctx.fillStyle = glow;
    ctx.fillRect(0, 0, W, H);

    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.font = '9px monospace'; ctx.textAlign='center';
    for (let gx = 0; gx < COLS; gx += 4) { ctx.fillText(gx, gx*CELL+CELL/2, 10); }
    ctx.textAlign='left';
    for (let gy = 0; gy < ROWS; gy += 4) { ctx.fillText(gy, 2, gy*CELL+CELL/2+3); }

    if (title) {
        ctx.fillStyle = 'rgba(0,0,0,0.65)'; ctx.fillRect(0, H-28, W, 28);
        ctx.fillStyle = '#daa520'; ctx.font = 'bold 13px serif'; ctx.textAlign='center';
        ctx.fillText(th.name + (title ? ' — ' + title.slice(0,50) : ''), W/2, H-10);
    }
    return legend;
}

function dmRunReadinessCheck() {
    var checks = [];
    var ok = 0;
    function mark(name, pass, detail) {
        checks.push((pass ? '✅ ' : '❌ ') + name + (detail ? (' — ' + detail) : ''));
        if (pass) ok++;
    }

    mark('LocalStorage', (function(){ try { localStorage.setItem('_dm_probe','1'); localStorage.removeItem('_dm_probe'); return true; } catch(e){ return false; } })());
    mark('Canvas 2D', !!document.createElement('canvas').getContext('2d'));
    mark('Homebrew Core', typeof hbInit === 'function' && typeof hbRebuildAll === 'function');
    mark('Story/Quest/Location', typeof swGenerateStory === 'function' && typeof swGenerateQuest === 'function' && typeof swGenerateLocation === 'function');
    mark('Battlemap Engine', typeof _drawBattleMap === 'function' && typeof swGenerateLocationBattleMap === 'function');
    mark('Portrait Engine', typeof generateNPCPortrait === 'function');
    mark('UI Popups', typeof openContentPopup === 'function' && typeof closeContentPopup === 'function');
    mark('Desktop Bridge', !window.desktopApp || typeof window.desktopApp.getVersion === 'function');

    var missingHandlers = [];
    document.querySelectorAll('[onclick]').forEach(function(el) {
        var raw = (el.getAttribute('onclick') || '').trim();
        if (!raw) return;
        var m = raw.match(/^\s*([A-Za-z_$][\w$]*)\s*\(/);
        if (!m) return;
        var fn = m[1];
        if (typeof window[fn] !== 'function' && missingHandlers.indexOf(fn) === -1) missingHandlers.push(fn);
    });
    mark('Button Handlers', missingHandlers.length === 0, missingHandlers.length ? ('Missing: ' + missingHandlers.slice(0, 10).join(', ') + (missingHandlers.length > 10 ? '…' : '')) : 'All onclick targets resolved');

    var total = checks.length;
    var summary = '<div style="margin-bottom:8px;"><strong>Readiness:</strong> ' + ok + ' / ' + total + ' checks passing</div>' + checks.join('<br>');
    if (typeof openContentPopup === 'function') {
        openContentPopup('🧪 App Readiness Check', '<div style="font-family:\'Crimson Text\',serif;line-height:1.7;">' + summary + '</div>', {});
    }
    if (typeof showToast === 'function') showToast('Readiness check complete: ' + ok + '/' + total, ok === total ? 'success' : 'warning');
}

function dmCollectDiagnostics() {
    var packs = (window._hbState && Array.isArray(window._hbState.packages)) ? window._hbState.packages : [];
    var enabled = packs.filter(function(p){ return p && p.enabled; }).length;
    return {
        generatedAt: new Date().toISOString(),
        appSettings: JSON.parse(JSON.stringify(window._dmAppSettings || {})),
        campaignName: (window._currentCampaign && window._currentCampaign.name) || null,
        counts: {
            npcs: Array.isArray(window.generatedNPCs) ? window.generatedNPCs.length : 0,
            activeHomebrewPackages: enabled,
            allHomebrewPackages: packs.length
        },
        runtime: {
            userAgent: navigator.userAgent,
            language: navigator.language,
            platform: navigator.platform,
            screen: { width: window.screen.width, height: window.screen.height }
        },
        desktopBuildInfo: window._dmDesktopBuildInfo || null
    };
}

function dmExportDiagnostics() {
    var payload = dmCollectDiagnostics();
    var json = JSON.stringify(payload, null, 2);
    var blob = new Blob([json], { type: 'application/json' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'dm-diagnostics-' + new Date().toISOString().replace(/[:.]/g, '-') + '.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){
        URL.revokeObjectURL(a.href);
        a.remove();
    }, 1000);
    if (typeof showToast === 'function') showToast('Diagnostics exported', 'success');
}

function generateQuestBattleMap() {
    const questArea = document.getElementById('questArea');
    const questText = questArea ? questArea.innerText : '';
    const theme = _getMapThemeFromQuest(questText);
    const titleEl = questArea ? questArea.querySelector('.quest-card-title') : null;
    const questName = titleEl ? titleEl.textContent : 'Quest Location';
    const canvas = document.getElementById('questMapCanvas');
    const mapArea = document.getElementById('questBattleMapArea');
    if (!canvas || !mapArea) return;
    mapArea.style.display = 'block';
    const legend = _drawBattleMap(canvas, theme, questName, false);
    const legendEl = document.getElementById('questMapLegend');
    if (legendEl && legend) {
        legendEl.innerHTML = legend.map(l =>
            `<div class="battlemap-legend-item">
                <div class="battlemap-legend-swatch" style="background:${l.color};"></div>
                <span>${l.label}</span>
            </div>`
        ).join('');
    }
    mapArea.scrollIntoView({ behavior:'smooth' });
    showToast('Battle map generated!', 'success');
}

function generateBossNPCBattleMap(npcId) {
    const npc = typeof getNPCById === 'function' ? getNPCById(npcId) : null;
    const theme = _MAP_THEMES['boss'];
    const card = document.getElementById('card-' + npcId);
    if (!card) return;
    let bossMapDiv = card.querySelector('.boss-battlemap-area');
    if (!bossMapDiv) {
        bossMapDiv = document.createElement('div');
        bossMapDiv.className = 'battlemap-section boss-battlemap-area';
        bossMapDiv.style.marginTop = '16px';
        bossMapDiv.innerHTML = `<div class="battlemap-header" style="color:var(--boss-gold);">Boss Battle Map — ${npc ? npc.name : 'Boss Chamber'}</div>
            <div class="battlemap-canvas-wrap" style="border-color:var(--boss-gold);">
                <canvas class="battlemap-canvas boss-map-canvas" width="640" height="480"></canvas>
            </div>
            <div class="boss-map-legend battlemap-legend"></div>
            <button class="battlemap-btn boss-map-btn" onclick="generateBossNPCBattleMap('${npcId}')">Regenerate Boss Map</button>`;
        const toolbar = card.querySelector('.card-toolbar');
        if (toolbar) toolbar.parentNode.insertBefore(bossMapDiv, toolbar);
        else card.appendChild(bossMapDiv);
    }
    const canvas = bossMapDiv.querySelector('.boss-map-canvas');
    const legend = _drawBattleMap(canvas, theme, npc ? npc.name : 'Boss Fight', true);
    const legendEl = bossMapDiv.querySelector('.boss-map-legend');
    if (legendEl && legend) {
        legendEl.innerHTML = legend.map(l =>
            `<div class="battlemap-legend-item" style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.2);">
                <div class="battlemap-legend-swatch" style="background:${l.color};border:1px solid rgba(255,255,255,0.2);"></div>
                <span style="color:rgba(255,255,255,0.8)">${l.label}</span>
            </div>`
        ).join('');
    }
    bossMapDiv.scrollIntoView({ behavior:'smooth' });
    showToast('Boss battle map generated!', 'boss');
}

/* Inject boss battle map button into boss cards */
(function patchBossMapButton() {
    const observer = new MutationObserver(mutations => {
        mutations.forEach(m => {
            m.addedNodes.forEach(node => {
                if (node.nodeType !== 1) return;
                const cards = node.classList && node.classList.contains('npc-card')
                    ? [node] : Array.from(node.querySelectorAll('.npc-card'));
                cards.forEach(card => {
                    if (!card.classList.contains('boss-card')) return;
                    if (card.dataset.bossMapInjected) return;
                    card.dataset.bossMapInjected = '1';
                    const npcId = (card.id||'').replace('card-','');
                    const toolbar = card.querySelector('.card-toolbar');
                    if (!toolbar) return;
                    const btn = document.createElement('div');
                    btn.style.cssText = 'margin-top:10px;margin-bottom:4px;';
                    btn.innerHTML = `<button class="battlemap-btn boss-map-btn" onclick="generateBossNPCBattleMap('${npcId}')">Generate Boss Battle Map</button>`;
                    toolbar.parentNode.insertBefore(btn, toolbar);
                });
            });
        });
    });
    const area = document.getElementById('displayArea');
    if (area) observer.observe(area, { childList:true, subtree:true });
})();

/* ─── 4: QUEST SAVE / PRINT ─────────────────────────────────────────── */
let _savedQuests = [];
try { _savedQuests = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e) { _savedQuests = []; }

function _saveSavedQuests() { if (window._isOneShot) return; try { localStorage.setItem('npcgen_quests', JSON.stringify(_savedQuests)); } catch(e){} }

function _refreshSavedQuestsList() {
    const el = document.getElementById('savedQuestsList');
    const sec = document.getElementById('savedQuestsSection');
    if (!el || !sec) return;
    if (!_savedQuests.length) { sec.style.display='none'; return; }
    sec.style.display = 'block';
    el.innerHTML = _savedQuests.map(q => `
        <div class="saved-quest-item">
            <div>
                <div class="saved-quest-name">${q.title || 'Quest'}</div>
                <div class="saved-quest-meta">${q.type||''} · ${q.diff||''} · ${q.date||''}</div>
            </div>
            <div style="display:flex;gap:4px;">
                <button class="btn-mini btn-load" onclick="loadSavedQuest('${q.id}')">Load</button>
                <button class="btn-mini btn-delete" onclick="deleteSavedQuest('${q.id}')">Del</button>
            </div>
        </div>`).join('');
}

function saveCurrentQuest() {
    const qa = document.getElementById('questArea');
    if (!qa || !qa.innerHTML.trim()) { showToast('No quest to save — generate one first!', 'success'); return; }
    const titleEl = qa.querySelector('.quest-card-title');
    const title = titleEl ? titleEl.textContent : 'Quest';
    const type = (document.getElementById('questType') || {}).value || '';
    const diff = (document.getElementById('questDiff') || {}).value || '';
    const id = 'q_' + Date.now();
    _savedQuests.unshift({ id, title, type, diff, date: new Date().toLocaleDateString(), html: qa.innerHTML });
    if (_savedQuests.length > 20) _savedQuests.pop();
    _saveSavedQuests();
    _refreshSavedQuestsList();
    _refreshSavedQuestsSidebar();
    showToast('Quest saved: ' + title, 'success');
}

function loadSavedQuest(qid) {
    const q = _savedQuests.find(x => x.id === qid);
    if (!q) return;
    const qa = document.getElementById('questArea');
    if (qa) { qa.innerHTML = q.html; _showQuestActionBar(); }
    _showRevengeQuestUI(false);
    // Switch to quest mode if in NPC mode
    if (document.getElementById('modeNPC') && document.getElementById('modeNPC').style.display !== 'none') {
        switchMode('quest');
    }
    showToast('Quest loaded: ' + q.title, 'success');
}

function deleteSavedQuest(qid) {
    _savedQuests = _savedQuests.filter(x => x.id !== qid);
    _saveSavedQuests();
    _refreshSavedQuestsList();
    _refreshSavedQuestsSidebar();
    showToast('Quest deleted', 'success');
}

function _showQuestActionBar() {
    const bar = document.getElementById('questActionBar');
    if (bar) bar.style.display = 'flex';
}

function _showRevengeQuestUI(isRevenge) {
    var qa = document.getElementById('questArea');
    if (qa) {
        if (isRevenge) qa.classList.add('is-revenge'); else qa.classList.remove('is-revenge');
    }
    var d = isRevenge ? '' : 'none';
    var revengeNpcsBtn = document.getElementById('questActBtnRevengeNPCs');
    var saveRevengeBtn = document.getElementById('questActBtnSaveRevenge');
    var setActiveBtn = document.getElementById('questActBtnSetActiveRevenge');
    if (revengeNpcsBtn) revengeNpcsBtn.style.display = d;
    if (saveRevengeBtn) saveRevengeBtn.style.display = d;
    if (setActiveBtn) setActiveBtn.style.display = d;
    var swRevengeNpcs = document.getElementById('swQuestActBtnRevengeNPCs');
    var swSaveRevenge = document.getElementById('swQuestActBtnSaveRevenge');
    var swSetActive = document.getElementById('swQuestActBtnSetActiveRevenge');
    if (swRevengeNpcs) swRevengeNpcs.style.display = d;
    if (swSaveRevenge) swSaveRevenge.style.display = d;
    if (swSetActive) swSetActive.style.display = d;
}

function clearCurrentQuest() {
    const qa  = document.getElementById('questArea');
    const bar = document.getElementById('questActionBar');
    if (qa) qa.innerHTML = '';
    if (bar) bar.style.display = 'none';
    _showRevengeQuestUI(false);
    if (typeof showToast === 'function') showToast('Quest area cleared', 'success');
}

function printCurrentQuest() {
    const qa = document.getElementById('questArea');
    if (!qa || !qa.innerHTML.trim()) { showToast('No quest to print!', 'success'); return; }
    const w = window.open('', '_blank');
    if (!w) return;
    w.document.write(`<!DOCTYPE html><html><head><title>Quest Sheet</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root{--red:#8b0000;--gold:#b8860b;--gold-light:#daa520;}
        body{font-family:'Crimson Text',serif;background:#f4e4bc;padding:30px;color:#1a1a1a;}
        h2{font-family:'Cinzel',serif;color:var(--red);border-bottom:2px solid var(--gold);padding-bottom:8px;}
        .quest-card{background:#fff8dc;border:2px solid var(--gold);border-radius:8px;padding:20px;margin-bottom:20px;break-inside:avoid;}
        .quest-card-title{font-family:'Cinzel',serif;font-size:1.3em;font-weight:700;color:#5a0000;margin-bottom:6px;}
        .quest-card-sub{font-size:0.88em;color:#666;margin-bottom:10px;font-style:italic;}
        .q-label{font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:var(--red);text-transform:uppercase;margin-top:12px;margin-bottom:3px;border-bottom:1px solid rgba(139,0,0,0.2);padding-bottom:3px;}
        .q-text{font-size:0.95em;line-height:1.7;color:#333;}
        .q-badge{display:inline-block;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;margin-right:5px;}
        .q-main-badge{background:#8b0000;color:white;}
        .q-side-badge{background:#1a6b5a;color:white;}
        .q-rand-badge{background:#555;color:white;}
        .q-diff-easy{background:#27ae60;color:white;}
        .q-diff-medium{background:#e67e22;color:white;}
        .q-diff-hard{background:#e74c3c;color:white;}
        .q-diff-deadly{background:#8b0000;color:white;}
        .q-diff-legendary{background:#4a0080;color:#ffd700;}
        .qtype-main{border-left:5px solid #8b0000;}
        .qtype-side{border-left:5px solid #1a6b5a;}
        .quest-card-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid rgba(184,134,11,0.3);}
        .quest-badges{display:flex;gap:4px;flex-wrap:wrap;}
        .q-section{margin-bottom:10px;}
        .q-npc-actions,.q-npc-btn{display:none;}
        @media print{body{padding:10px;background:white;}@page{margin:1cm;}}
    </style></head><body>
    <h2>Quest Record — ${new Date().toLocaleDateString()}</h2>
    ${qa.innerHTML}
    <script>window.onload=()=>setTimeout(()=>window.print(),500);<\u002fscript>
    </body></html>`);
    w.document.close();
}

/* Hook quest generators to show action bar */
(function patchQuestGenerators() {
    ['generateFullQuest','generateSideQuestsOnly','generateRandomSideQuests'].forEach(fn => {
        const orig = window[fn];
        if (!orig) return;
        window[fn] = function(...args) {
            orig.apply(this, args);
            setTimeout(_showQuestActionBar, 100);
            setTimeout(_refreshSavedQuestsList, 100);
        };
    });
})();

/* ─── 5: PARTY INITIATIVE INPUT ─────────────────────────────────────── */
window._playerInitState = window._playerInitState || {};
window._playerInitActive = window._playerInitActive || {};

function _renderPartyInitInputs() {
    const container = document.getElementById('partyInitRows');
    if (!container) return;
    const party = Array.isArray(window._party) ? window._party : (typeof _party !== 'undefined' && Array.isArray(_party) ? _party : []);
    if (!party.length) {
        container.innerHTML = '<div style="font-size:0.75em;color:rgba(255,255,255,0.3);text-align:center;padding:4px;">Add players in Party Tracker first</div>';
        return;
    }
    container.innerHTML = party.map(p => {
        const raw = window._playerInitState[p.id];
        const val = Number.isFinite(raw) ? raw : '';
        return `
        <div class="player-init-row">
            <div class="player-init-name">${p.name || 'Player'} <span style="opacity:0.5;font-weight:400;">${p.cls||''}</span></div>
            <input type="number" class="player-init-input" id="pinit_${p.id}" placeholder="Roll" min="1" max="30" value="${val}" oninput="updatePlayerInitiativeRoll('${p.id}', this.value)">
        </div>`;
    }).join('');
}

function updatePlayerInitiativeRoll(playerId, rawValue) {
    window._playerInitState = window._playerInitState || {};
    window._playerInitActive = window._playerInitActive || {};
    var val = parseInt(rawValue, 10);
    window._playerInitState[playerId] = Number.isFinite(val) && val > 0 ? val : null;
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    if (typeof refreshPlayersGroupDisplay === 'function') refreshPlayersGroupDisplay();
}

function refreshPlayersGroupDisplay() {
    const row = document.getElementById('playersGroupMembers');
    if (!row) return;
    const party = (typeof _party !== 'undefined' && Array.isArray(_party)) ? _party : [];
    if (!party.length) return;
    const stateMap = window._playerInitState || {};
    const members = party.map(p => ({
        id: p.id,
        name: p.name || 'Player',
        cls: p.cls || '',
        hpCurr: p.hpCurr || 0,
        hpMax: p.hpMax || 0,
        roll: Number.isFinite(stateMap[p.id]) ? stateMap[p.id] : null
    })).sort((a, b) => {
        if (a.roll != null && b.roll != null) return b.roll - a.roll;
        if (a.roll != null) return -1;
        if (b.roll != null) return 1;
        return 0;
    });
    let html = '';
    members.forEach((m, idx) => {
        const rank = m.roll != null ? (idx + 1) : '?';
        const rankStyle = rank === 1 ? 'background:var(--gold);color:#111;' : 'background:rgba(80,80,80,0.6);color:#eee;';
        html += '<div class="player-init-row" style="display:flex;align-items:center;gap:8px;padding:6px 10px;margin:4px 0;background:rgba(0,0,0,0.2);border-radius:6px;border:1px solid rgba(46,204,113,0.35);">' +
            '<span style="min-width:22px;height:22px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75em;' + rankStyle + '">' + rank + '</span>' +
            '<span style="flex:1;color:#a8e8a8;font-weight:700;">' + (m.name || 'Player') + '</span>' +
            '<span style="font-size:0.75em;opacity:0.8;">' + (m.cls || '') + ' · HP ' + m.hpCurr + '/' + m.hpMax + '</span>' +
            '<input type="number" class="player-init-input" min="1" max="30" value="' + (m.roll != null ? m.roll : '') + '" placeholder="Init" oninput="updatePlayerInitiativeRoll(\'' + m.id + '\', this.value); if(typeof refreshPlayersGroupDisplay===\'function\')refreshPlayersGroupDisplay();" style="width:52px;padding:4px;">' +
            '</div>';
    });
    row.innerHTML = html;
}

function _renderPlayersGroupOnly(tabsDiv, party) {
    if (!tabsDiv || !party.length) return;
    const stateMap = window._playerInitState || {};
    const members = party.map(p => ({
        id: p.id,
        name: p.name || 'Player',
        cls: p.cls || '',
        hpCurr: p.hpCurr || 0,
        hpMax: p.hpMax || 0,
        roll: Number.isFinite(stateMap[p.id]) ? stateMap[p.id] : null
    })).sort((a, b) => {
        if (a.roll != null && b.roll != null) return b.roll - a.roll;
        if (a.roll != null) return -1;
        if (b.roll != null) return 1;
        return 0;
    });
    const bracket = document.createElement('div');
    bracket.className = 'npc-tab-group-bracket';
    bracket.style.cssText = 'border: 2px solid rgba(46,204,113,0.7);';
    const header = document.createElement('div');
    header.className = 'npc-tab-group-header';
    header.style.cssText = 'background:linear-gradient(135deg,rgba(46,160,80,0.9),rgba(30,100,50,0.95));';
    header.innerHTML = '<span style="font-family:\'Cinzel\',serif;font-weight:700;color:white;font-size:0.82em;">🧑 Players</span><span style="font-size:0.72em;color:rgba(255,255,255,0.8);margin-left:auto;">' + members.length + ' member' + (members.length !== 1 ? 's' : '') + '</span>';
    bracket.appendChild(header);
    const membersRow = document.createElement('div');
    membersRow.className = 'npc-tab-group-members';
    membersRow.id = 'playersGroupMembers';
    membersRow.style.cssText = 'background:rgba(46,204,113,0.12);';
    let html = '';
    members.forEach((m, idx) => {
        const rank = m.roll != null ? (idx + 1) : '?';
        const rankStyle = rank === 1 ? 'background:var(--gold);color:#111;' : 'background:rgba(80,80,80,0.6);color:#eee;';
        html += '<div class="player-init-row" style="display:flex;align-items:center;gap:8px;padding:6px 10px;margin:4px 0;background:rgba(0,0,0,0.2);border-radius:6px;border:1px solid rgba(46,204,113,0.35);">' +
            '<span style="min-width:22px;height:22px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75em;' + rankStyle + '">' + rank + '</span>' +
            '<span style="flex:1;color:#a8e8a8;font-weight:700;">' + (m.name || 'Player') + '</span>' +
            '<span style="font-size:0.75em;opacity:0.8;">' + (m.cls || '') + ' · HP ' + m.hpCurr + '/' + m.hpMax + '</span>' +
            '<input type="number" class="player-init-input" min="1" max="30" value="' + (m.roll != null ? m.roll : '') + '" placeholder="Init" oninput="updatePlayerInitiativeRoll(\'' + m.id + '\', this.value); if(typeof refreshPlayersGroupDisplay===\'function\')refreshPlayersGroupDisplay();" style="width:52px;padding:4px;">' +
            '</div>';
    });
    membersRow.innerHTML = html;
    bracket.appendChild(membersRow);
    tabsDiv.appendChild(bracket);
}

function removePlayerFromInitiative(playerId) {
    window._playerInitActive = window._playerInitActive || {};
    delete window._playerInitActive[playerId];
    updateInitiativeOrderPanel();
}

function addPartyToInitiative() {
    const party = typeof _party !== 'undefined' ? _party : [];
    if (!party.length) { showToast('No players in party tracker', 'warning'); return; }

    window._playerInitState = window._playerInitState || {};
    window._playerInitActive = window._playerInitActive || {};

    let added = 0;
    party.forEach(p => {
        if (!window._playerInitActive[p.id]) added++;
        window._playerInitActive[p.id] = true;
        const el = document.getElementById('pinit_' + p.id);
        const roll = el ? parseInt(el.value, 10) : NaN;
        if (Number.isFinite(roll) && roll > 0) window._playerInitState[p.id] = roll;
        else if (!Number.isFinite(window._playerInitState[p.id])) window._playerInitState[p.id] = null;
    });

    updateInitiativeOrderPanel();
    if (added) showToast(`${added} player(s) added to initiative order`, 'success');
    else showToast('Players already in initiative. Edit numbers to re-sort.', 'success');
}

/* Watch party changes to refresh init inputs and initiative panel */
(function() {
    const origRender = window.renderPartyTracker;
    if (origRender) {
        window.renderPartyTracker = function(...args) {
            origRender.apply(this, args);
            setTimeout(function() {
                _renderPartyInitInputs();
                if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
            }, 50);
        };
    }
})();

/* ═══════════════════════════════════════════════════════════════
   CAMPAIGN START SCREEN
   ═══════════════════════════════════════════════════════════════ */
let _currentCampaign = null;
(function(){
    var raw = localStorage.getItem('dm_current_campaign');
    if (!raw) return;
    try {
        var parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object') _currentCampaign = parsed;
        else if (typeof parsed === 'string' && parsed.trim()) _currentCampaign = { id:'', name: parsed.trim() };
    } catch(e) {
        var t = String(raw || '').trim();
        if (t) _currentCampaign = { id:'', name: t };
    }
})();

function dmGetCurrentCampaignName() {
    if (_currentCampaign && _currentCampaign.name) return String(_currentCampaign.name).trim();
    var raw = localStorage.getItem('dm_current_campaign');
    if (!raw) return '';
    try {
        var parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object' && parsed.name) return String(parsed.name).trim();
        if (typeof parsed === 'string') return String(parsed).trim();
    } catch(e) {
        return String(raw || '').trim();
    }
    return '';
}

/* Saved Campaigns: stored under one key so data is separate from session and per-campaign */
function _saveCampaigns(list) { try { localStorage.setItem('dm_saved_campaigns', JSON.stringify(list)); } catch(e){} }
function _getCampaigns() {
    try {
        var saved = localStorage.getItem('dm_saved_campaigns');
        var legacy = localStorage.getItem('dm_campaigns');
        if (!saved && legacy) { localStorage.setItem('dm_saved_campaigns', legacy); saved = legacy; }
        return JSON.parse(saved || '[]');
    } catch(e){ return []; }
}

function csShowNew() {
    document.getElementById('csMainOptions').style.display = 'none';
    document.getElementById('csNewPanel').classList.add('active');
    document.getElementById('csBackLink').style.display = 'block';
    setTimeout(() => document.getElementById('csNewCampaignName').focus(), 100);
}

function csShowOpen() {
    document.getElementById('csMainOptions').style.display = 'none';
    document.getElementById('csOpenPanel').classList.add('active');
    document.getElementById('csBackLink').style.display = 'block';
    _renderCampaignList();
}

function csOpenHomebrewImport() {
    if (typeof hbOpenManager === 'function') hbOpenManager();
}

function csBack() {
    // If choice panel is active, go back to main
    document.getElementById('csMainOptions').style.display = 'flex';
    document.getElementById('csNewPanel').classList.remove('active');
    document.getElementById('csOpenPanel').classList.remove('active');
    document.getElementById('csChoicePanel').classList.remove('active');
    document.getElementById('csBackLink').style.display = 'none';
    var inp = document.getElementById('csNewCampaignName');
    if (inp) inp.value = '';
}

function _renderCampaignList() {
    const list = _getCampaigns();
    const el = document.getElementById('csCampaignList');
    const none = document.getElementById('csNoCampaigns');
    if (!list.length) { el.innerHTML = ''; none.style.display = 'block'; return; }
    none.style.display = 'none';
    el.innerHTML = list.slice().reverse().map(c => {
        var npcCount = Array.isArray(c.npcs) ? c.npcs.length : (parseInt(c.npcs, 10) || 0);
        return `
        <div class="cs-campaign-item" onclick="csLoadCampaign('${c.id}')">
            <div>
                <div class="cs-campaign-name">📖 ${c.name}</div>
                <div class="cs-campaign-meta">Created ${c.date || 'Unknown'} &nbsp;·&nbsp; ${npcCount} NPCs saved</div>
            </div>
            <button class="cs-campaign-del" onclick="event.stopPropagation();csDeleteCampaign('${c.id}')">✕</button>
        </div>`;
    }).join('');
}

function csCreateNewCampaign() {
    window._isOneShot = false;
    const nameEl = document.getElementById('csNewCampaignName');
    const name = nameEl.value.trim() || 'Unnamed Campaign';
    const id = 'camp_' + Date.now();
    const campaign = { id, name, date: new Date().toLocaleDateString(), npcs: 0, created: Date.now() };
    const list = _getCampaigns();
    list.push(campaign);
    _saveCampaigns(list);
    _currentCampaign = campaign;
    try { localStorage.setItem('dm_current_campaign', JSON.stringify(campaign)); } catch(e){}
    /* Clear old NPCs/party for fresh campaign */
    try { localStorage.removeItem('npcgen_npcs'); } catch(e){}
    _party = []; _saveParty();
    
    /* Show the choice panel instead of launching immediately */
    document.getElementById('csNewPanel').classList.remove('active');
    document.getElementById('csChoicePanel').classList.add('active');
    document.getElementById('csBackLink').style.display = 'none';
    var nameDisplay = document.getElementById('csChoiceCampaignName');
    if (nameDisplay) nameDisplay.textContent = '⚔ ' + name;
}

function csLaunchWithMode(mode) {
    _launchApp(mode);
}

function csLoadCampaign(id) {
    window._isOneShot = false;
    const list = _getCampaigns();
    const campaign = list.find(c => c.id === id);
    if (!campaign) return;
    _currentCampaign = campaign;
    try { localStorage.setItem('dm_current_campaign', JSON.stringify(campaign)); } catch(e){}
    /* Restore all session data from this campaign only (keeps campaigns separate) */
    try { localStorage.setItem('npcgen_npcs', JSON.stringify(campaign.npcs || [])); } catch(e){}
    try { localStorage.setItem('npcgen_quests', JSON.stringify(campaign.quests || [])); } catch(e){}
    try { localStorage.setItem('npcgen_party', JSON.stringify(campaign.party || [])); } catch(e){}
    try { localStorage.setItem('dm_notes', String(campaign.notes || '')); } catch(e){}
    try { localStorage.setItem('dm_quick_notes', String(campaign.quickNotes || '')); } catch(e){}
    try { localStorage.setItem('npcgen_nemesis', JSON.stringify(campaign.nemesis || {})); } catch(e){}
    try { localStorage.setItem('dm_saved_notes', JSON.stringify(campaign.sessionNotes || [])); } catch(e){}
    try { localStorage.setItem('npcgen_killed', JSON.stringify(campaign.killed || [])); } catch(e){}
    try { localStorage.setItem('dm_vault', JSON.stringify(campaign.vault || [])); } catch(e){}
    try { localStorage.setItem('dm_active_quest', JSON.stringify(campaign.activeQuest != null ? campaign.activeQuest : 'null')); } catch(e){}
    try { localStorage.setItem('dm_active_revenge', JSON.stringify(campaign.activeRevenge != null ? campaign.activeRevenge : 'null')); } catch(e){}
    try { localStorage.setItem('dm_saved_revenge_quests', JSON.stringify(campaign.savedRevengeQuests || [])); } catch(e){}
    try { localStorage.setItem('dm_locations', JSON.stringify(campaign.locations || [])); } catch(e){}
    try { localStorage.setItem('dm_sw_stories', JSON.stringify(campaign.swStories || [])); } catch(e){}
    try { localStorage.setItem('dm_sw_locs', JSON.stringify(campaign.swLocs || [])); } catch(e){}
    try { localStorage.setItem('dm_live_tools', JSON.stringify(campaign.liveTools != null ? campaign.liveTools : 'null')); } catch(e){}
    try { localStorage.setItem('npcgen_tags', JSON.stringify(campaign.tags || [])); } catch(e){}
    try { localStorage.setItem('npcgen_session_notes', String(campaign.sessionNotesText || '')); } catch(e){}
    try { localStorage.setItem('npcgen_notes_v2', JSON.stringify(campaign.notesV2 || [])); } catch(e){}
    /* Sync in-memory globals from localStorage */
    try { _party = JSON.parse(localStorage.getItem('npcgen_party') || '[]'); } catch(e){ _party = []; }
    try { _killedNPCsLog = JSON.parse(localStorage.getItem('npcgen_killed') || '[]'); } catch(e){ _killedNPCsLog = []; }
    try { _savedQuests = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e){ _savedQuests = []; }
    try { _activeRevenge = JSON.parse(localStorage.getItem('dm_active_revenge') || 'null'); } catch(e){}
    try { _savedRevengeQuests = JSON.parse(localStorage.getItem('dm_saved_revenge_quests') || '[]'); } catch(e){}
    try { _savedLocations = JSON.parse(localStorage.getItem('dm_locations') || '[]'); } catch(e){}
    try { _swSavedStories = JSON.parse(localStorage.getItem('dm_sw_stories') || '[]'); } catch(e){}
    try { _swSavedLocs = JSON.parse(localStorage.getItem('dm_sw_locs') || '[]'); } catch(e){}
    try { _notes = JSON.parse(localStorage.getItem('npcgen_notes_v2') || '[]'); } catch(e){}
    _launchApp('npc');
}

function csDeleteCampaign(id) {
    if (!confirm('Delete this campaign? This cannot be undone.')) return;
    const before = _getCampaigns();
    const list = before.filter(c => c.id !== id);
    _saveCampaigns(list);
    dmPushUndoAction('Delete campaign', function() {
        _saveCampaigns(before);
        _renderCampaignList();
    });
    _renderCampaignList();
}

function _launchApp(startMode) {
    startMode = startMode || 'npc';
    const screen = document.getElementById('campaignStartScreen');
    /* Ensure we can cancel the delayed hide when returning to Main Menu */
    try { if (window._csGoneTimer) clearTimeout(window._csGoneTimer); } catch(e){}
    if (screen) {
        document.body.classList.remove('start-screen-only');
        screen.classList.add('hidden');
        window._csGoneTimer = setTimeout(() => {
            try { screen.classList.add('gone'); } catch(e){}
        }, 900);
    }
    /* Update header badge */
    if (_currentCampaign) {
        const badge = document.getElementById('campaignBadge');
        const badgeName = document.getElementById('campaignBadgeName');
        if (badge && badgeName) { badgeName.textContent = _currentCampaign.name; badge.classList.add('visible'); }
    }
    /* Render party, notes etc */
    renderPartyTracker();
    if (typeof _refreshNotesDropdown === 'function') _refreshNotesDropdown();
    if (typeof _refreshNotesNpcTags === 'function') _refreshNotesNpcTags();
    if (typeof _renderPartyInitInputs === 'function') _renderPartyInitInputs();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    if (startMode === 'npc' && typeof _party !== 'undefined' && _party && _party.length > 0) {
        var initContainer = document.getElementById('npcTabsContainer');
        if (initContainer) initContainer.classList.add('active');
    }
    if (typeof _refreshSavedQuestsList === 'function') _refreshSavedQuestsList();
    if (typeof _refreshSavedQuestsSidebar === 'function') _refreshSavedQuestsSidebar();
    switchMode(startMode);
    /* If quest mode, open the quest generator automatically */
    if (startMode === 'quest') {
        setTimeout(function() {
            var gb = document.getElementById('questGenBody');
            var gt = document.getElementById('questGenToggle');
            if (gb) gb.classList.add('open');
            if (gt) gt.classList.add('open');
        }, 300);
    }
    /* Collapse Story & World Generator so app looks clean on entry */
    var swContent = document.getElementById('storyWorldContent');
    var swIcon = document.getElementById('swToggleIcon');
    if (swContent) swContent.style.display = 'none';
    if (swIcon) swIcon.textContent = '▶';
    /* Refresh all left panels */
    setTimeout(lpRefreshAll, 400);
}

function csStartOneShot() {
    /* One-shot: no data is saved; nothing persists when user exits */
    window._isOneShot = true;
    _currentCampaign = null;
    /* Clear in-memory state only (do not write to localStorage) */
    _party = [];
    if (typeof window.generatedNPCs !== 'undefined') window.generatedNPCs = [];
    if (typeof _savedQuests !== 'undefined') _savedQuests = [];
    if (typeof _killedNPCsLog !== 'undefined') _killedNPCsLog = [];
    if (typeof _notes !== 'undefined') _notes = [];
    if (typeof _nemesisRegistry !== 'undefined') _nemesisRegistry = {};
    if (typeof _activeQuest !== 'undefined') _activeQuest = null;
    if (typeof _activeRevenge !== 'undefined') _activeRevenge = null;
    if (typeof _savedRevengeQuests !== 'undefined') _savedRevengeQuests = [];
    if (typeof _savedLocations !== 'undefined') _savedLocations = [];
    if (typeof _swSavedStories !== 'undefined') _swSavedStories = [];
    if (typeof _swSavedLocs !== 'undefined') _swSavedLocs = [];
    /* Show one-shot badge instead of campaign badge */
    const badge = document.getElementById('campaignBadge');
    const badgeName = document.getElementById('campaignBadgeName');
    if (badge && badgeName) {
        badgeName.textContent = '⚡ One Shot Session';
        badge.style.borderColor = 'rgba(160,0,255,0.5)';
        badge.style.color = '#c080ff';
        badge.classList.add('visible');
    }
    const screen = document.getElementById('campaignStartScreen');
    if (screen) {
        document.body.classList.remove('start-screen-only');
        screen.classList.add('hidden');
        setTimeout(() => screen.classList.add('gone'), 900);
    }
    renderPartyTracker();
    if (typeof _refreshNotesDropdown === 'function') _refreshNotesDropdown();
    if (typeof _refreshNotesNpcTags === 'function') _refreshNotesNpcTags();
    if (typeof _renderPartyInitInputs === 'function') _renderPartyInitInputs();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    /* Collapse Story & World Generator so app looks clean on entry */
    var swContent = document.getElementById('storyWorldContent');
    var swIcon = document.getElementById('swToggleIcon');
    if (swContent) swContent.style.display = 'none';
    if (swIcon) swIcon.textContent = '▶';
    switchMode('npc');
    setTimeout(lpRefreshAll, 400);
    showToast('⚡ One Shot mode — nothing will be saved to campaigns.', 'success');
}

/* Enter key on campaign name field */
document.addEventListener('DOMContentLoaded', function() {
    if (window.desktopApp) {
        if (!localStorage.getItem('dm_story_ai_url')) localStorage.setItem('dm_story_ai_url', 'http://127.0.0.1:11434');
        if (!localStorage.getItem('dm_story_ai_enabled')) localStorage.setItem('dm_story_ai_enabled', '1');
        setTimeout(function() { if (typeof refreshCsOllamaStatus === 'function') refreshCsOllamaStatus(); }, 500);
        setTimeout(function() { showAISetupBannerIfNeeded(); }, 500);
    }
    const inp = document.getElementById('csNewCampaignName');
    if (inp) inp.addEventListener('keydown', function(e){ if(e.key==='Enter') csCreateNewCampaign(); });

    /* If campaigns exist, highlight Open Campaign */
    var campaigns = _getCampaigns();
    if (campaigns.length > 0) {
        var openCard = document.querySelector('.cs-card.cs-open');
        if (openCard) {
            openCard.style.borderColor = 'rgba(100,200,150,0.7)';
            openCard.style.boxShadow = '0 0 20px rgba(100,200,150,0.2)';
        }
    }
});

/* ═══════════════════════════════════════════════════════════════
   QUEST POPUP (in NPC mode)
   ═══════════════════════════════════════════════════════════════ */
let _qpmCurrentQuest = null;

function openQuestPopup() {
    document.getElementById('questPopupModal').classList.add('active');
    document.getElementById('qpmQuestOutput').style.display = 'none';
    document.getElementById('qpmQuestActions').style.display = 'none';
    _qpmCurrentQuest = null;
}

function closeQuestPopup() {
    document.getElementById('questPopupModal').classList.remove('active');
}

function qpmGenerateQuest(mode) {
    /* Sync selectors to the main quest generator selectors */
    const type = document.getElementById('qpmQuestType').value;
    const diff = document.getElementById('qpmQuestDiff').value;
    const setting = document.getElementById('qpmQuestSetting').value;

    /* Sync to main quest selectors if they exist */
    ['questType','questDiff','questSetting'].forEach((id,i) => {
        const el = document.getElementById(id);
        const val = [type,diff,setting][i];
        if (el && val) el.value = val;
    });

    /* Use the existing quest generation functions */
    if (typeof generateFullQuest === 'function') {
        generateFullQuest();
    }

    /* Pull generated quest HTML and display it in popup */
    setTimeout(() => {
        const qaEl = document.getElementById('questArea');
        if (qaEl && qaEl.innerHTML.trim()) {
            const out = document.getElementById('qpmQuestOutput');
            out.innerHTML = qaEl.innerHTML;
            out.style.display = 'block';
            const acts = document.getElementById('qpmQuestActions');
            acts.style.display = 'flex';
            _qpmCurrentQuest = { type: type||'random', diff: diff||'random', setting: setting||'random', html: qaEl.innerHTML };
        } else {
            /* Fallback: build a quick quest inline */
            _qpmBuildQuickQuest(type, diff, setting, mode);
        }
    }, 120);
}

function _qpmBuildQuickQuest(type, diff, setting, mode) {
    /* Simple inline quest builder as fallback */
    if (typeof QUEST_DB === 'undefined') { showToast('Quest data not loaded', 'success'); return; }
    const types = type ? [type] : Object.keys(QUEST_DB);
    const pickedType = types[Math.floor(Math.random()*types.length)];
    const pool = QUEST_DB[pickedType] || [];
    if (!pool.length) { showToast('No quests available for that type', 'success'); return; }
    const q = pool[Math.floor(Math.random()*pool.length)];
    const diffLabel = diff || ['easy','medium','hard','deadly','legendary'][Math.floor(Math.random()*5)];
    const diffColors = {easy:'#27ae60',medium:'#e67e22',hard:'#e74c3c',deadly:'#8b0000',legendary:'#4a0080'};
    const col = diffColors[diffLabel] || '#555';
    const html = `
        <div style="border-left:5px solid ${col};padding-left:14px;margin-bottom:10px;">
            <div style="font-family:'Cinzel',serif;font-size:1.3em;font-weight:700;color:#5a0000;margin-bottom:4px;">${q.name}</div>
            <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
                <span style="background:${col};color:white;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;text-transform:uppercase;">${mode||'Quest'}</span>
                <span style="background:${col};color:white;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;text-transform:uppercase;">${diffLabel}</span>
                <span style="background:#555;color:white;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;">${pickedType}</span>
            </div>
        </div>
        ${[['🎣 Hook',q.hook],['🎯 Objective',q.objective],['⚔ Obstacles',q.obstacles],['🌀 Twist',q.twist],['📜 Resolution',q.resolution],['💰 Reward',`${q.reward_gp} gp &nbsp;·&nbsp; ${q.reward_extra||''}`]]
            .map(([label,text])=>text?`<div style="margin-bottom:12px;"><div style="font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:#8b0000;text-transform:uppercase;margin-bottom:4px;border-bottom:1px solid rgba(139,0,0,0.2);padding-bottom:3px;">${label}</div><div style="line-height:1.7;color:#333;">${text}</div></div>`:'').join('')}`;

    _qpmCurrentQuest = { name: q.name, type: pickedType, diff: diffLabel, setting, html, raw: q };
    const out = document.getElementById('qpmQuestOutput');
    out.innerHTML = html;
    out.style.display = 'block';
    const acts = document.getElementById('qpmQuestActions');
    acts.style.display = 'flex';
}

function qpmSaveQuest() {
    if (!_qpmCurrentQuest) { showToast('No quest to save', 'success'); return; }
    try {
        const qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]');
        qs.push({ id: 'q'+Date.now(), title: _qpmCurrentQuest.name||'Quest', type: _qpmCurrentQuest.type, diff: _qpmCurrentQuest.diff, date: new Date().toLocaleDateString(), html: _qpmCurrentQuest.html });
        localStorage.setItem('npcgen_quests', JSON.stringify(qs));
        showToast('Quest saved!', 'success');
        if (typeof _refreshSavedQuestsSidebar === 'function') _refreshSavedQuestsSidebar();
    } catch(e) { showToast('Could not save quest', 'success'); }
}

function qpmGenerateNPCsForQuest() {
    /* Generate NPCs relevant to the quest type and close popup */
    const q = _qpmCurrentQuest;
    closeQuestPopup();
    
    const isBoss = q && (q.diff === 'deadly' || q.diff === 'legendary');
    const bossCheck = document.getElementById('bossMode');
    const qty = document.getElementById('qtyInput');

    /* Determine how many to generate based on quest difficulty */
    let count = 2;
    if (q && q.diff === 'easy') count = 1;
    if (q && (q.diff === 'hard' || q.diff === 'deadly')) count = 3;
    if (q && q.diff === 'legendary') count = 4;

    if (bossCheck) bossCheck.checked = isBoss;
    if (qty) qty.value = String(count);

    if (typeof generateBatch === 'function') {
        generateBatch();
        showToast(`Generated ${count} quest NPC${count>1?'s':''} for your ${q?q.type||'quest':'quest'}!`, 'success');
    } else {
        showToast('NPC generator not ready — try clicking Generate NPCs manually.', 'success');
    }
}

/* ═══════════════════════════════════════════════════════════════
   KILL → REVENGE QUEST SYSTEM
   ═══════════════════════════════════════════════════════════════ */
const REVENGE_QUEST_TEMPLATES = [
    {
        title: 'Blood Oath',
        description: '{relation} was {npc}\'s closest ally — sibling, spouse, or sworn brother-in-arms. The news of {npc}\'s death at {killer}\'s hands did not bring grief alone; it brought a vow. In front of witnesses, {relation} swore a blood oath: no rest, no mercy, until {killer} is dead or kneeling before them in chains. They have already sent out hunters and offered gold to any blade willing to bring {killer} in — or bring {killer}\'s head.',
        hook: 'Word of {npc}\'s death has reached their allies. {relation} has sworn a blood oath and dispatched hunters.',
        objective: 'The hunters will not stop until {killer} is dead or brought before {relation} for judgement.',
        twist: 'One of the hunters was once a friend of {killer} — forced into service under threat to their family.'
    },
    {
        title: 'The Price on Your Head',
        description: '{relation} — a wealthy or well-connected figure who loved or depended on {npc} — has opened their coffers. A substantial bounty is now on {killer}\'s head: dead or alive, with a premium for alive so {relation} can "pass sentence" personally. Posters have gone up in every town and every guild hall. Bounty hunters, retired soldiers, and desperate adventurers are already tracking {killer}\'s movements. The sum is high enough that even former allies might be tempted.',
        hook: '{relation}, enraged by the death of {npc}, has put a bounty on {killer}\'s head. Every bounty hunter and desperate mercenary in the region now knows the name.',
        objective: 'Survive the onslaught, find {relation}, and either eliminate them or negotiate a ceasefire.',
        twist: 'The bounty paperwork contains information about {relation}\'s own crimes — leverage, if the party can use it.'
    },
    {
        title: 'Shadows of Grief',
        description: '{relation} and {npc} were bound by more than duty — they were family or lifelong friends. {relation} has not declared war in the open. Instead they move in the shadows: hiring assassins, poisoning reputations, and turning innkeepers and road-wardens against {killer}. The goal is not a fair fight; it is a knife in the dark or an "accident" on the road. {relation} wants {killer} to feel the same helplessness {npc} felt.',
        hook: '{npc}\'s death shattered their circle. {relation} grieves openly but plots privately — sending assassins rather than soldiers.',
        objective: 'Identify and stop the assassination attempts before {killer} is caught alone.',
        twist: '{relation} doesn\'t actually want {killer} dead — they want {killer} to suffer. The assassins have orders to maim, not kill.'
    },
    {
        title: 'The Last Wish',
        description: 'In {npc}\'s final moments, they named who had killed them. {relation} — the person {npc} trusted most — heard that name and has not forgotten. They have called in every favour, every debt, and every blade they ever lent. A coordinated strike is being planned: not a random bounty, but a targeted operation to corner {killer} and end the debt of blood.',
        hook: 'Before dying, {npc} told {relation} who was responsible. {relation} has called in every favour they are owed.',
        objective: 'A coordinated strike is coming. The party must either prepare defences, go on the offensive, or find a diplomatic solution.',
        twist: '{npc} actually gave {relation} false information — they named the wrong person out of spite, or were confused in their final moments.'
    },
    {
        title: 'Family Honor',
        description: '{npc} belonged to a family — or a clan, house, or order — that takes blood and honour seriously. {relation} speaks for that family. They have declared {killer} an enemy of their bloodline: no treaty, no law, and no gold will settle this. It is vendetta. The family will use every resource: guards, spies, and loyal retainers. Until honour is satisfied, {killer} will never be safe in any territory that family touches.',
        hook: '{npc}\'s family — connected, proud, and now furious — has declared {killer} an enemy of their bloodline. This is not about law. It is about honour.',
        objective: 'The family will not rest until honour is satisfied. The party can fight, flee, or find a way to make amends.',
        twist: 'The family patriarch privately agrees {npc} deserved their fate but cannot say so publicly without losing face.'
    },
    {
        title: 'Wanted: Dead or Alive',
        description: 'A formal bounty has been posted by {relation} in response to {npc}\'s death. The notice names {killer} as the murderer and offers a large reward — enough to draw professional bounty hunters and guild assassins. In some towns, showing {killer}\'s face may lead to arrest or a knife in the back. The bounty is "dead or alive," but {relation} has let it be known they prefer {killer} delivered alive so they can witness justice.',
        hook: 'Wanted posters bearing {killer}\'s name and likeness have appeared in every major settlement. {relation} has funded the bounty and is spreading the word.',
        objective: 'Clear your name, remove the bounty, or eliminate {relation} — before the next hunter finds you.',
        twist: 'A rival of {relation} is secretly offering to cancel the bounty if {killer} does one dangerous job for them first.'
    },
    {
        title: 'A Parent\'s Vow',
        description: '{relation} is {npc}\'s parent — or the closest thing to it. They raised {npc}, buried their hopes in them, and now they have buried {npc} too. {relation} has sworn that {killer} will pay. They may not have an army, but they have a lifetime of contacts, grudges, and the kind of patience that outlasts caution. They will turn allies against {killer}, sabotage supplies, and wait for the moment to strike.',
        hook: '{relation}, {npc}\'s parent, has vowed that {killer} will not outlive their child. No amount of gold or apology will buy peace.',
        objective: 'Survive the long game {relation} is playing: turn the tables, win over or silence {relation}, or flee beyond their reach.',
        twist: '{relation} is dying. They are rushing their plans and making mistakes — or they are more dangerous than ever because they have nothing left to lose.'
    },
    {
        title: 'The Guild Contract',
        description: '{relation} did not only grieve — they went to the kind of people who solve problems with steel. A contract has been placed with a thieves\' guild, assassins\' league, or mercenary company. {killer} is now a mark. The first team may fail; the second may not. Until the contract is cancelled or the one who placed it is removed, {killer} will be hunted by professionals who know how to find and kill.',
        hook: 'A contract on {killer}\'s life has been taken up by skilled killers. {relation} paid for it with the coin that {npc} left behind — or with their own fortune.',
        objective: 'Break the contract: find and deal with {relation}, or destroy the organisation that took the job.',
        twist: 'The contract allows for a "buyout": if {killer} pays double the contract price to the right person, the hunt stops — but {relation} may simply place another.'
    }
];

function openKillQuestModal(npcId) {
    const npc = (typeof getNPCById === 'function') ? getNPCById(npcId) : null;
    if (!npc) { showToast('NPC not found', 'warning'); return; }
    document.getElementById('kqmNpcId').value = npcId;
    document.getElementById('kqmSelectedPlayer').value = '';
    document.getElementById('kqmNpcName').textContent = npc.name;
    document.getElementById('kqmNpcSub').textContent = `${npc.race} · ${npc.class} · Level ${npc.level}`;
    document.getElementById('kqmResult').classList.remove('visible');
    document.getElementById('kqmResult').innerHTML = '';

    const btnsEl = document.getElementById('kqmPlayerBtns');
    if (!_party.length) {
        btnsEl.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-style:italic;font-size:0.85em;padding:8px;">No players in party tracker. Add players first.</div>';
    } else {
        btnsEl.innerHTML = _party.map(p =>
            `<button class="kqm-player-btn" data-pid="${p.id}" onclick="kqmSelectPlayer('${p.id}',this)">
                ${p.name} <span style="opacity:0.55;font-size:0.85em;">${p.cls||''} Lvl ${p.level||1}</span>
            </button>`).join('');
    }
    document.getElementById('killQuestModal').classList.add('active');
}

function kqmSelectPlayer(pid, btn) {
    document.getElementById('kqmSelectedPlayer').value = pid;
    document.querySelectorAll('.kqm-player-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
}

function confirmKillAndGenerateQuest() {
    const npcId = document.getElementById('kqmNpcId').value;
    const playerId = document.getElementById('kqmSelectedPlayer').value;
    const npc = (typeof getNPCById === 'function') ? getNPCById(npcId) : null;
    const player = _party.find(p => p.id === playerId);

    if (!player && _party.length) { showToast('Please select a player', 'warning'); return; }
    if (!npc) { showToast('NPC not found', 'warning'); return; }

    /* Mark NPC as dead */
    npc.isDead = true;
    npc.killedBy = playerId;
    npc.killedByName = player ? player.name : 'Unknown';
    npc.killedAt = new Date().toLocaleDateString();

    /* Mark on player — add hunted status */
    if (player) {
        if (!player.nemeses) player.nemeses = [];
        player.nemeses.push({ npcId, npcName: npc.name, reason: 'Killed / Defeated' });
        if (!player.isHunted) player.isHunted = [];
        player.isHunted.push(npc.name);
        _saveParty();
        renderPartyTracker();
    }

    /* Propagate hostility to related NPCs */
    if (typeof _propagateNemesisToRelated === 'function') _propagateNemesisToRelated(npcId, playerId);

    /* Mark related NPCs as hostile in the tab UI */
    _markRelatedNPCsHostile(npc, player);

    /* Store revenge quest data on the NPC for future use */
    const tmpl = REVENGE_QUEST_TEMPLATES[Math.floor(Math.random() * REVENGE_QUEST_TEMPLATES.length)];
    const relation = _getRelatedNPCName(npc) || 'their allies';
    const killer = player ? player.name : 'the party';
    const fill = s => s.replace(/\{npc\}/g, npc.name).replace(/\{relation\}/g, relation).replace(/\{killer\}/g, killer);
    const rewardGP = (npc.level || 1) * 150;
    const sections = [];
    if (tmpl.description) sections.push(['📜 The Situation', fill(tmpl.description)]);
    sections.push(['🎣 Hook', fill(tmpl.hook)], ['🎯 Objective', fill(tmpl.objective)], ['🌀 Twist', fill(tmpl.twist)], ['⚠ Affected Parties', `<strong>${killer}</strong> is now hunted. ${relation} will send waves of enemies until resolved.`], ['💰 Reward', `${rewardGP} gp (from enemy treasury) + clearing your name`]);
    const questHtml = `
        <div style="border-left:5px solid rgba(255,120,120,0.8);padding-left:14px;">
            <div style="font-family:'Cinzel',serif;font-size:1.2em;font-weight:700;color:#ffb8b8;margin-bottom:4px;">☠ ${fill(tmpl.title)}</div>
            <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
                <span style="background:#8b0000;color:white;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;">REVENGE QUEST</span>
                <span style="background:#4a0080;color:#ffd700;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;">TRIGGERED</span>
                <span style="background:#555;color:white;padding:2px 10px;border-radius:8px;font-size:0.78em;">Killed: ${npc.name}</span>
                <span style="background:#444;color:#f08080;padding:2px 10px;border-radius:8px;font-size:0.78em;">Hunted: ${killer}</span>
            </div>
        </div>
        ${sections.filter(([,text])=>text).map(([label,text])=>`<div style="margin-bottom:12px;"><div style="font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;color:#ff9999;text-transform:uppercase;margin-bottom:4px;border-bottom:1px solid rgba(255,150,150,0.3);padding-bottom:3px;">${label}</div><div style="line-height:1.7;color:#e8d8d8;">${text}</div></div>`).join('')}`;
    npc._revengeQuestHtml = questHtml;
    npc._revengeQuestTitle = `☠ ${fill(tmpl.title)}`;

    /* Add to killed NPCs log */
    _addToKilledLog(npc, player);

    /* Remove NPC from the board (tabs and card) so they no longer appear on screen */
    if (Array.isArray(window.generatedNPCs)) {
        var idx = generatedNPCs.findIndex(function(n){ return n.id === npcId; });
        if (idx >= 0) {
            if (window.activeNPCId === npcId) {
                var next = generatedNPCs.length > 1 ? generatedNPCs[idx + 1] || generatedNPCs[idx - 1] : generatedNPCs[0];
                window.activeNPCId = next && next.id !== npcId ? next.id : null;
            }
            generatedNPCs = generatedNPCs.filter(function(n){ return n.id !== npcId; });
        }
    }
    if (typeof renderAllNPCs === 'function') renderAllNPCs();
    if (typeof updateAllNPCTabs === 'function') updateAllNPCTabs();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    if (typeof _refreshSavedQuestsList === 'function') _refreshSavedQuestsList();

    /* ── Close the kill modal immediately ── */
    closeKillQuestModal();
    showToast(`${npc.name} marked slain — removed from the board; added to Fallen NPCs log. ☠`, 'success');
}

/* ── Revenge quest text readable on dark UI ── */
function _revengeHtmlForDarkUI(html) {
    if (!html || typeof html !== 'string') return html;
    return html
        .replace(/color:\s*#333\b/g, 'color:#e8d8d8')
        .replace(/color:\s*#1a1a1a\b/g, 'color:#e8d8d8')
        .replace(/color:\s*#2a1a00\b/g, 'color:#e8d8d8')
        .replace(/color:\s*#5a0000\b/g, 'color:#ffb8b8')
        .replace(/color:\s*#8b0000\b/g, 'color:#ff9999');
}

/* ── Killed NPCs Log ── */
var _killedNPCsLog = [];
try { _killedNPCsLog = JSON.parse(localStorage.getItem('npcgen_killed') || '[]'); } catch(e){}

function _addToKilledLog(npc, killer) {
    var entry = {
        id: 'k' + Date.now(),
        npcName: npc.name,
        npcRace: npc.race,
        npcClass: npc.class,
        npcLevel: npc.level,
        isBoss: npc.isBoss,
        killedBy: killer ? killer.name : 'Unknown',
        killedAt: new Date().toLocaleDateString(),
        revengeQuestHtml: npc._revengeQuestHtml || null,
        revengeQuestTitle: npc._revengeQuestTitle || null
    };
    _killedNPCsLog.unshift(entry);
    if (!window._isOneShot) try { localStorage.setItem('npcgen_killed', JSON.stringify(_killedNPCsLog)); } catch(e){}
    _renderKilledLog();
}

function _renderKilledLog() {
    var el = document.getElementById('killedNPCsLogList');
    if (!el) return;
    if (!_killedNPCsLog.length) {
        el.innerHTML = '<div style="color:rgba(255,255,255,0.25);font-style:italic;text-align:center;padding:10px;font-size:0.82em;">No fallen NPCs yet.</div>';
        return;
    }
    el.innerHTML = _killedNPCsLog.map(function(e) {
        var revivedLabel = e.revived ? ' <span style="background:#1a4a1a;color:#80ff80;padding:1px 6px;border-radius:4px;font-size:0.7em;border:1px solid #80ff80;">✨ Revived</span>' : '';
        return '<div style="background:rgba(139,0,0,0.12);border:1px solid rgba(139,0,0,0.3);border-radius:6px;padding:10px 12px;margin-bottom:6px;">'
            + '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">'
            + '<div>'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.88em;font-weight:700;color:#f08080;">☠ ' + e.npcName + revivedLabel + (e.isBoss?' <span style="background:#4a0080;color:#ffd700;padding:1px 6px;border-radius:4px;font-size:0.7em;">BOSS</span>':'') + '</div>'
            + '<div style="font-size:0.72em;color:rgba(255,255,255,0.4);margin-top:2px;">' + e.npcRace + ' ' + e.npcClass + ' Lvl ' + e.npcLevel + ' · Killed by ' + e.killedBy + ' · ' + e.killedAt + '</div>'
            + '</div>'
            + '<div style="display:flex;gap:6px;flex-wrap:wrap;">'
            + (e.revengeQuestHtml ? '<button onclick="loadRevengeQuestFromLog(\'' + e.id + '\')" style="padding:4px 10px;background:linear-gradient(145deg,#8b0000,#5a0000);color:#fff8dc;border:none;border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.72em;font-weight:700;white-space:nowrap;">☠ View Revenge Quest</button>' : '')
            + (!e.revived ? '<button onclick="reviveNPCFromLog(\'' + e.id + '\')" style="padding:4px 10px;background:linear-gradient(145deg,#1a4a1a,#2a6a2a);color:#c8ffc8;border:none;border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.72em;font-weight:700;white-space:nowrap;">✨ Revive</button>' : '')
            + '<button onclick="deleteFallenNPC(\'' + e.id + '\')" style="padding:4px 10px;background:rgba(60,0,0,0.6);color:rgba(255,150,150,0.8);border:1px solid rgba(139,0,0,0.4);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.72em;font-weight:700;white-space:nowrap;" title="Remove from fallen log">🗑 Delete</button>'
            + '</div>'
            + '</div></div>';
    }).join('');
}

function reviveNPCFromLog(logId) {
    var entry = _killedNPCsLog.find(function(e){ return e.id === logId; });
    if (!entry) return;
    if (entry.revived) { showToast(entry.npcName + ' has already been revived!', 'success'); return; }

    /* Mark as revived in the log */
    entry.revived = true;
    if (!window._isOneShot) try { localStorage.setItem('npcgen_killed', JSON.stringify(_killedNPCsLog)); } catch(e){}

    /* Build a minimal NPC object and save to vault */
    var revivedNpc = {
        id: 'revived_' + Date.now(),
        name: entry.npcName + ' (Revived)',
        race: entry.npcRace || 'Unknown',
        class: entry.npcClass || 'Unknown',
        level: entry.npcLevel || 1,
        isBoss: entry.isBoss || false,
        hp: Math.max(1, Math.floor((entry.npcLevel || 1) * 5)),
        hpCurr: Math.max(1, Math.floor((entry.npcLevel || 1) * 5)),
        alignment: 'True Neutral',
        backstory: 'This NPC was killed in battle but was brought back from the dead. They carry the weight of their death with them.',
        personality: 'Changed by the experience of death and resurrection.',
        revived: true,
        revivedAt: new Date().toLocaleDateString()
    };

    /* Save to vault */
    var vault = [];
    try { vault = JSON.parse(localStorage.getItem('dm_vault') || '[]'); } catch(e){}
    vault.push(revivedNpc);
    if (!window._isOneShot) try { localStorage.setItem('dm_vault', JSON.stringify(vault)); } catch(e){}

    /* Refresh displays */
    _renderKilledLog();
    if (typeof loadSavedNPCs === 'function') loadSavedNPCs();

    showToast(entry.npcName + ' has been revived and added to Saved NPCs! ✨', 'success');
}

function deleteFallenNPC(logId) {
    var idx = _killedNPCsLog.findIndex(function(e){ return e.id === logId; });
    if (idx === -1) return;
    var name = _killedNPCsLog[idx].npcName;
    if (!confirm('Remove ' + name + ' from the Fallen NPCs log? This cannot be undone.')) return;
    _killedNPCsLog.splice(idx, 1);
    if (!window._isOneShot) try { localStorage.setItem('npcgen_killed', JSON.stringify(_killedNPCsLog)); } catch(e){}
    _renderKilledLog();
    showToast(name + ' removed from Fallen NPCs log.', 'success');
}

function loadRevengeQuestFromLog(logId) {
    var entry = _killedNPCsLog.find(function(e){ return e.id === logId; });
    if (!entry) return;

    /* Route through the Story & World Generator revenge system */
    /* Switch to Story & World mode and open the Quest tab */
    if (typeof swSwitchTab === 'function') {
        /* Make sure the story world container is visible */
        var swContent = document.getElementById('storyWorldContent');
        if (swContent) swContent.style.display = 'block';
        var swIcon = document.getElementById('swToggleIcon');
        if (swIcon) swIcon.textContent = '▼';

        swSwitchTab('quest');
    }

    /* Scroll to story world container */
    var swContainer = document.getElementById('storyWorldContainer');
    if (swContainer) setTimeout(function(){ swContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 150);

    /* If there is stored revenge quest HTML for this NPC, inject it into the quest output */
    setTimeout(function() {
        var outEl = document.getElementById('swQuestOutput');
        var actEl = document.getElementById('swQuestActions');

        if (entry.revengeQuestHtml) {
            /* Build a revenge quest card matching the SW generator style (light text for dark UI) */
            var html = '<div style="padding:18px;">'
                + '<div style="font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;color:#f08080;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;">☠ Revenge Quest</div>'
                + '<div style="font-family:\'Cinzel\',serif;font-size:1.3em;font-weight:700;color:#ffb8b8;margin-bottom:8px;">☠ Vengeance for: ' + entry.npcName + '</div>'
                + '<div style="background:rgba(139,0,0,0.15);border:1px solid rgba(139,0,0,0.4);border-radius:6px;padding:10px 14px;margin-bottom:14px;font-size:0.85em;color:rgba(255,220,220,0.9);font-style:italic;">'
                + '📜 ' + entry.npcRace + ' ' + entry.npcClass + ' Lvl ' + entry.npcLevel + (entry.isBoss ? ' · <span style="color:#ffd700;font-weight:700;">BOSS</span>' : '')
                + ' · Killed by <strong style="color:#f08080;">' + entry.killedBy + '</strong> · ' + entry.killedAt
                + '</div>'
                + entry.revengeQuestHtml
                + '</div>';
            if (outEl) { outEl.innerHTML = (typeof _revengeHtmlForDarkUI === 'function' ? _revengeHtmlForDarkUI(html) : html); outEl.style.display = 'block'; }
            if (actEl) { actEl.style.display = 'flex'; }

            /* Store as _swLastQuest so it can be saved */
            window._swLastQuest = {
                title: '☠ Revenge: ' + entry.npcName,
                type: 'revenge',
                diff: 'hard',
                html: html,
                fromFallenLog: true,
                fallenNpcName: entry.npcName
            };
            /* Also put in main quest area so "Generate NPCs for Quest" button is available */
            var qaEl = document.getElementById('questArea');
            var actionBar = document.getElementById('questActionBar');
            var mainHtml = '<div style="border-left:5px solid rgba(255,120,120,0.8);padding-left:14px;margin-bottom:10px;">'
                + '<div style="font-family:\'Cinzel\',serif;font-size:1.3em;font-weight:700;color:#ffb8b8;margin-bottom:4px;">☠ Revenge Quest: ' + entry.npcName + '</div>'
                + '<div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">'
                + '<span style="background:#8b0000;color:white;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;text-transform:uppercase;">Revenge Quest</span>'
                + '<span style="background:#444;color:#f08080;padding:2px 10px;border-radius:8px;font-size:0.78em;">Killed by: ' + entry.killedBy + '</span>'
                + '</div></div>' + entry.revengeQuestHtml;
            if (qaEl) { qaEl.innerHTML = (typeof _revengeHtmlForDarkUI === 'function' ? _revengeHtmlForDarkUI(mainHtml) : mainHtml); }
            if (actionBar) { actionBar.style.display = 'flex'; }
            window._currentQuestData = { title: '☠ Revenge: ' + entry.npcName, type: 'revenge', diff: 'hard', html: mainHtml, revengeKilledEntry: entry };
            _showRevengeQuestUI(true);
            showToast('☠ Revenge quest for ' + entry.npcName + ' loaded!', 'success');
        } else {
            /* No stored HTML — trigger the full revenge quest generator which picks from killed log */
            if (typeof generateRevengeQuestFromKilled === 'function') {
                generateRevengeQuestFromKilled();
            }
            showToast('Generating revenge quest…', 'success');
        }
    }, 300);
}

function _getHostileNPCNames(deadNpc) {
    if (typeof generatedNPCs === 'undefined') return null;
    const hostile = generatedNPCs.filter(n => n.id !== deadNpc.id && n.groupName && n.groupName === deadNpc.groupName && !n.isDead);
    if (!hostile.length) return null;
    return hostile.map(n => `<strong>${n.name}</strong> (${n.race} ${n.class})`).join(', ') + ' — all now hostile.';
}

function _markRelatedNPCsHostile(deadNpc, killer) {
    if (typeof generatedNPCs === 'undefined') return;
    generatedNPCs.forEach(n => {
        if (n.id !== deadNpc.id && n.groupName && n.groupName === deadNpc.groupName && !n.isDead) {
            n.isHostileToKiller = true;
            n.hostileReason = `${deadNpc.name} was killed by ${killer ? killer.name : 'the party'}`;
            n.huntingPlayer = killer ? killer.id : null;
            n.huntingPlayerName = killer ? killer.name : 'the party';
            /* Add hostile banner to the NPC tab */
            _addHostileBannerToTab(n.id);
        }
    });
}

function _addHostileBannerToTab(npcId) {
    const tab = document.querySelector(`.npc-tab[data-npc-id="${npcId}"]`);
    if (tab && !tab.querySelector('.hostile-dot')) {
        const dot = document.createElement('span');
        dot.className = 'hostile-dot';
        dot.style.cssText = 'display:inline-block;width:8px;height:8px;background:#dc143c;border-radius:50%;margin-left:4px;box-shadow:0 0 6px #dc143c;animation:huntedPulse 1.5s ease-in-out infinite;';
        dot.title = 'This NPC is now hostile!';
        tab.querySelector('.tab-name').appendChild(dot);
        tab.style.borderColor = '#dc143c';
    }
    /* Also add banner inside the card if it's active */
    const card = document.getElementById('card-' + npcId);
    if (card && !card.querySelector('.npc-hostile-banner')) {
        const npc = typeof getNPCById === 'function' ? getNPCById(npcId) : null;
        if (npc && npc.isHostileToKiller) {
            const banner = document.createElement('div');
            banner.className = 'npc-hostile-banner';
            banner.innerHTML = `☠ <span>HOSTILE — hunting ${npc.huntingPlayerName || 'party'} for killing ${npc.hostileReason ? npc.hostileReason.split(' was killed')[0] : 'their ally'}</span>`;
            card.insertBefore(banner, card.firstChild);
        }
    }
}

function _applyKilledOverlay(npcId) {
    const card = document.getElementById('card-' + npcId);
    if (card && !card.querySelector('.npc-killed-overlay')) {
        const overlay = document.createElement('div');
        overlay.className = 'npc-killed-overlay';
        overlay.innerHTML = '<div class="npc-killed-stamp">Slain</div>';
        card.style.position = 'relative';
        card.appendChild(overlay);
    }
    /* Grey out the tab */
    const tab = document.querySelector(`.npc-tab[data-npc-id="${npcId}"]`);
    if (tab) {
        tab.style.opacity = '0.5';
        tab.style.textDecoration = 'line-through';
        const name = tab.querySelector('.tab-name');
        if (name) name.textContent = '☠ ' + name.textContent.replace('☠ ','');
    }
}

function _getRelatedNPCName(npc) {
    if (!npc || typeof generatedNPCs === 'undefined') return null;
    /* Look for group members or relatives */
    const related = generatedNPCs.find(n => n.id !== npc.id && n.groupName && n.groupName === npc.groupName && (n.groupRole === 'Leader' || n.groupRole === 'Master'));
    if (related) return related.name;
    const relative = generatedNPCs.find(n => n.id !== npc.id && (n.masterOf?.id === npc.id || npc.masterOf?.id === n.id));
    if (relative) return relative.name;
    /* Fall back to any same-group NPC */
    const groupMate = generatedNPCs.find(n => n.id !== npc.id && n.groupName && n.groupName === npc.groupName);
    if (groupMate) return groupMate.name;
    return null;
}

function closeKillQuestModal() {
    document.getElementById('killQuestModal').classList.remove('active');
}

/* ─── BOOT override: show campaign screen instead of going straight to NPC mode ─── */

document.addEventListener('DOMContentLoaded', function() {
    _refreshNotesDropdown();
    _refreshNotesNpcTags();
    _renderPartyInitInputs();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    _refreshSavedQuestsList();
    _refreshSavedQuestsSidebar();
    // Sync quick notes
    var qn = document.getElementById('questQuickNotes');
    if (qn) { qn.value = localStorage.getItem('dm_quick_notes') || ''; qn.addEventListener('input', function() { localStorage.setItem('dm_quick_notes', qn.value); }); }
    // Pre-populate "open campaign" if campaigns exist
    var campaigns = _getCampaigns();
    if (campaigns.length > 0) {
        var openCard = document.querySelector('.cs-card.cs-open');
        if (openCard) {
            openCard.style.borderColor = 'rgba(100,200,150,0.7)';
            openCard.style.boxShadow = '0 0 20px rgba(100,200,150,0.2)';
        }
    }
    /* Restore NPC hostile/killed visual states after generation */
    document.addEventListener('npcsGenerated', function() {
        setTimeout(_restoreNPCStates, 200);
        setTimeout(lpRefreshAll, 250);
    });
    /* Sync left-panel selects whenever main selects are ready */
    setTimeout(lpSyncNPCSelects, 500);
});

function _restoreNPCStates() {
    if (typeof generatedNPCs === 'undefined') return;
    generatedNPCs.forEach(function(npc) {
        if (npc.isDead) _applyKilledOverlay(npc.id);
        if (npc.isHostileToKiller) _addHostileBannerToTab(npc.id);
    });
}

/* ─── 7: MODE SWITCHER ────────────────────────────────────────────── */
function switchMode(mode) {
    var npcMode = document.getElementById('modeNPC');
    var questMode = document.getElementById('modeQuest');
    var tabNPC = document.getElementById('modeTabNPC');
    var tabQuest = document.getElementById('modeTabQuest');
    if (!npcMode || !questMode) return;
    if (mode === 'npc') {
        npcMode.style.display = '';
        questMode.style.display = 'none';
        if (tabNPC) tabNPC.classList.add('active');
        if (tabQuest) tabQuest.classList.remove('active');
        if (typeof renderAllNPCs === 'function') renderAllNPCs();
        if (typeof _renderPartyInitInputs === 'function') _renderPartyInitInputs();
        if (typeof updateInitiativeOrderPanel === 'function') setTimeout(function() { updateInitiativeOrderPanel(); }, 50);
    } else {
        npcMode.style.display = 'none';
        questMode.style.display = '';
        if (tabQuest) tabQuest.classList.add('active');
        if (tabNPC) tabNPC.classList.remove('active');
        // Always expand quest generator
        var gb = document.getElementById('questGenBody');
        var gt = document.getElementById('questGenToggle');
        if (gb) { gb.classList.add('open'); }
        if (gt) { gt.classList.add('open'); }
        _refreshSavedQuestsSidebar();
    }
}

function _refreshSavedQuestsSidebar() {
    var el = document.getElementById('savedQuestsSidebar');
    if (!el) return;
    var qs = [];
    try { qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e){}
    if (!qs.length) { el.innerHTML = '<div style="color:rgba(184,134,11,0.45);font-size:0.8em;padding:6px;">No saved quests yet.</div>'; return; }
    el.innerHTML = qs.slice().reverse().map(function(q) {
        return '<div class="saved-quest-item" onclick="loadSavedQuest(\'' + q.id + '\')">'
            + '<div><div class="saved-quest-name">' + (q.title||'Unnamed Quest') + '</div>'
            + '<div class="saved-quest-meta">' + (q.type||'') + (q.diff ? ' · ' + q.diff : '') + ' · ' + (q.date||'') + '</div></div>'
            + '<button onclick="event.stopPropagation();deleteSavedQuest(\'' + q.id + '\')" style="background:none;border:1px solid var(--red);color:var(--red);padding:2px 7px;border-radius:4px;cursor:pointer;font-size:0.75em;flex-shrink:0;">✕</button>'
            + '</div>';
    }).join('');
}

/* ══════════════════════════════════════════════════════════════
   LEFT SLIDING PANELS — replaced by modal for Party
   ══════════════════════════════════════════════════════════════ */
var _lpOpen = { panelParty: false, panelNPC: false, panelQuest: false };

function openPartyModal() {
    var modal = document.getElementById('partyModal');
    if (!modal) return;
    modal.style.display = 'flex';
    var btn = document.getElementById('modeTabParty');
    if (btn) btn.classList.add('active');
    lpRefreshParty();
}

function closePartyModal() {
    var modal = document.getElementById('partyModal');
    if (modal) modal.style.display = 'none';
    var btn = document.getElementById('modeTabParty');
    if (btn) btn.classList.remove('active');
}

/* Keep toggleLeftPanel as no-op for any existing calls */
function toggleLeftPanel(id) {
    if (id === 'panelParty') { openPartyModal(); return; }
    /* NPC/Quest panels removed — no-op */
}

function closePartyPanel() { closePartyModal(); }

function lpRefreshAll() {
    if (_lpOpen.panelParty) lpRefreshParty();
    if (_lpOpen.panelNPC) lpSyncNPCSelects();
    if (_lpOpen.panelQuest) lpRefreshSavedQuests();
}

/* Sync the left-panel NPC selects with the main selects (copy options) */
function lpSyncNPCSelects() {
    ['Race','Class'].forEach(function(f) {
        var src = document.getElementById(f.toLowerCase() + 'Sel');
        var dst = document.getElementById('lp' + f + 'Sel');
        if (!src || !dst) return;
        var cur = dst.value;
        dst.innerHTML = src.innerHTML;
        dst.value = cur || src.value;
    });
}

/* Mirror LP selects to main selects on change */
function lpMirrorSelect(lpId, mainId) {
    var lp = document.getElementById(lpId);
    var main = document.getElementById(mainId);
    if (lp && main) main.value = lp.value;
}

function lpGenerateNPCs() {
    /* Sync LP selects to main selects then generate */
    var pairs = [['lpRaceSel','raceSel'],['lpClassSel','classSel'],['lpLvlSel','lvlSel'],['lpQtyInput','qtyInput'],['lpBossMode','bossMode'],['lpContentSource','npcContentSource'],['lpGenderPref','npcGenderPref'],['lpAlignmentPref','npcAlignmentPref'],['lpForceSpellcaster','npcForceSpellcaster'],['lpForceMartial','npcForceMartial']];
    pairs.forEach(function(p) {
        var src = document.getElementById(p[0]);
        var dst = document.getElementById(p[1]);
        if (!src || !dst) return;
        if (src.type === 'checkbox') dst.checked = src.checked;
        else dst.value = src.value;
    });
    if (typeof generateBatch === 'function') generateBatch();
    /* Close panel after generating */
    toggleLeftPanel('panelNPC');
    toggleLeftPanel('panelNPC'); /* close it */
    _lpOpen.panelNPC = false;
    var p = document.getElementById('panelNPC');
    if (p) p.classList.add('lp-collapsed');
    var ic = document.getElementById('panelNPCIcon');
    if (ic) ic.textContent = '▶';
}

function lpGenerateQuest(mode) {
    /* Sync LP quest selects to main quest selects */
    var lpType = document.getElementById('lpQuestType');
    var lpDiff = document.getElementById('lpQuestDiff');
    if (lpType) { var qt = document.getElementById('questType'); if(qt) qt.value = lpType.value; }
    if (lpDiff) { var qd = document.getElementById('questDiff'); if(qd) qd.value = lpDiff.value; }
    /* Make sure we're in quest mode and generate */
    switchMode('quest');
    setTimeout(function() {
        if (mode === 'main' && typeof generateFullQuest === 'function') generateFullQuest();
        else if (typeof generateSideQuestsOnly === 'function') generateSideQuestsOnly();
    }, 200);
    /* Close panel */
    _lpOpen.panelQuest = false;
    var p = document.getElementById('panelQuest');
    if (p) p.classList.add('lp-collapsed');
    var ic = document.getElementById('panelQuestIcon');
    if (ic) ic.textContent = '▶';
}

function lpGenerateNemesisQuest() {
    switchMode('quest');
    setTimeout(function() { generateNemesisQuest(); }, 200);
    _lpOpen.panelQuest = false;
    var p = document.getElementById('panelQuest');
    if (p) p.classList.add('lp-collapsed');
    var ic = document.getElementById('panelQuestIcon');
    if (ic) ic.textContent = '▶';
}

function lpRefreshParty() {
    /* Refresh the main player list in the modal */
    var el = document.getElementById('lpPartyList');
    if (el) {
        if (!_party.length) {
            el.innerHTML = '<div style="color:rgba(184,134,11,0.4);font-size:0.78em;text-align:center;padding:10px;">No players added yet. Click <strong>+ Add Player</strong> to begin.</div>';
        } else {
            el.innerHTML = _party.map(function(p) {
                var pct = Math.max(0, Math.min(100, Math.round(((p.hpCurr||0) / (p.hpMax||1)) * 100)));
                var barCol = pct <= 25 ? '#c0392b' : pct <= 50 ? '#e67e22' : '#27ae60';
                var huntStr = (p.isHunted && p.isHunted.length) ? '<div style="font-size:0.65em;color:#f08080;margin-top:2px;">☠ HUNTED</div>' : '';
                var condStr = (p.conditions||[]).length ? '<div style="font-size:0.65em;color:#e74c3c;margin-top:1px;">' + p.conditions.slice(0,3).join(', ') + '</div>' : '';
                var nemStr = (p.nemeses||[]).length ? '<span style="background:#8b0000;color:#fff8dc;padding:1px 5px;border-radius:6px;font-size:0.65em;font-family:\'Cinzel\',serif;margin-left:4px;">NEMESIS x' + p.nemeses.length + '</span>' : '';
                return '<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.04);border-radius:6px;margin-bottom:6px;border:1px solid rgba(184,134,11,0.15);">'
                    + '<div style="flex:1;min-width:0;cursor:pointer;" onclick="openPlayerSheet(\'' + p.id + '\')" title="Click to edit full sheet">'
                    + '<div style="font-family:\'Cinzel\',serif;font-size:0.82em;font-weight:700;color:#fff8dc;display:flex;align-items:center;gap:4px;">' + (p.name||'Unnamed') + nemStr + ' <span style="font-weight:400;font-size:0.78em;color:rgba(255,255,255,0.45);">' + (p.cls||'') + ' ' + (p.level||1) + '</span>' + (p.insp ? ' <span style="color:#ffd700;" title="Inspiration">★</span>' : '') + '</div>'
                    + huntStr + condStr
                    + '<div style="background:rgba(0,0,0,0.4);border-radius:3px;height:6px;margin:4px 0;overflow:hidden;"><div style="height:100%;width:' + pct + '%;background:' + barCol + ';border-radius:3px;transition:width 0.3s;"></div></div>'
                    + '<div style="font-size:0.72em;color:rgba(255,255,255,0.5);"><span style="color:' + barCol + ';font-weight:700;">' + (p.hpCurr||0) + '/' + (p.hpMax||0) + ' HP</span> &nbsp;· AC ' + (p.ac||10) + ' &nbsp;· Spd ' + (p.speed||30) + '</div>'
                    + '</div>'
                    + '<div style="display:flex;flex-direction:column;gap:3px;flex-shrink:0;">'
                    + '<button style="padding:3px 7px;background:linear-gradient(145deg,var(--gold),#966f0a);color:white;border:none;border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.68em;font-weight:700;white-space:nowrap;" onclick="openPlayerSheet(\'' + p.id + '\')">✏ Edit Stats</button>'
                    + '<div style="display:flex;gap:2px;">'
                    + '<button style="flex:1;height:22px;background:#c0392b;color:white;border:none;border-radius:3px;cursor:pointer;font-size:0.9em;font-weight:700;line-height:1;" onclick="quickHP(\'' + p.id + '\',-1)">−</button>'
                    + '<button style="flex:1;height:22px;background:#27ae60;color:white;border:none;border-radius:3px;cursor:pointer;font-size:0.9em;font-weight:700;line-height:1;" onclick="quickHP(\'' + p.id + '\',+1)">+</button>'
                    + '</div>'
                    + '</div>'
                    + '</div>';
            }).join('');
        }
    }

    /* Also refresh the health overview strip at top of modal */
    var ovEl = document.getElementById('partyHealthOverview');
    if (ovEl) {
        if (!_party.length) {
            ovEl.innerHTML = '<div style="color:rgba(184,134,11,0.4);font-size:0.8em;font-style:italic;">No players added yet.</div>';
        } else {
            ovEl.innerHTML = _party.map(function(p) {
                var pct = Math.max(0, Math.min(100, Math.round(((p.hpCurr||0) / (p.hpMax||1)) * 100)));
                var col = pct <= 25 ? '#c0392b' : pct <= 50 ? '#e67e22' : '#27ae60';
                return '<div style="background:rgba(0,0,0,0.3);border:1px solid ' + col + ';border-radius:5px;padding:4px 8px;min-width:80px;text-align:center;">'
                    + '<div style="font-family:\'Cinzel\',serif;font-size:0.62em;font-weight:700;color:#fff8dc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80px;">' + (p.name||'?') + '</div>'
                    + '<div style="background:rgba(0,0,0,0.3);border-radius:2px;height:4px;margin:2px 0;overflow:hidden;"><div style="height:100%;width:' + pct + '%;background:' + col + ';"></div></div>'
                    + '<div style="font-size:0.62em;color:' + col + ';font-weight:700;">' + (p.hpCurr||0) + '/' + (p.hpMax||0) + '</div>'
                    + '</div>';
            }).join('');
        }
    }
}

function lpRefreshSavedQuests() {
    var el = document.getElementById('lpSavedQuests');
    if (!el) return;
    var qs = [];
    try { qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e){}
    if (!qs.length) {
        el.innerHTML = '<div style="color:rgba(184,134,11,0.4);font-size:0.78em;text-align:center;padding:8px;">No saved quests yet.</div>';
        return;
    }
    el.innerHTML = qs.slice().reverse().map(function(q) {
        return '<div class="lp-quest-item" onclick="lpLoadQuest(\'' + q.id + '\')">'
            + '<div><div class="lp-quest-name">' + (q.title||'Unnamed Quest').substring(0,30) + '</div>'
            + '<div class="lp-quest-meta">' + (q.type||'quest') + (q.diff?' · '+q.diff:'') + '</div></div>'
            + '<button class="lp-quest-del" onclick="event.stopPropagation();lpDeleteQuest(\'' + q.id + '\')">✕</button>'
            + '</div>';
    }).join('');
}

function lpLoadQuest(id) {
    if (typeof loadSavedQuest === 'function') {
        switchMode('quest');
        setTimeout(function() { loadSavedQuest(id); }, 200);
    }
    /* Close panel */
    _lpOpen.panelQuest = false;
    var p = document.getElementById('panelQuest');
    if (p) p.classList.add('lp-collapsed');
    var ic = document.getElementById('panelQuestIcon');
    if (ic) ic.textContent = '▶';
}

function lpDeleteQuest(id) {
    if (typeof deleteSavedQuest === 'function') deleteSavedQuest(id);
    setTimeout(lpRefreshSavedQuests, 100);
}

/* ══════════════════════════════════════════════════════════════
   NEMESIS QUEST GENERATOR
   ══════════════════════════════════════════════════════════════ */
var NEMESIS_QUEST_DB = [
    {
        name: 'The Reckoning',
        hook: 'An old enemy has resurfaced — stronger, more cunning, and hungry for revenge. They have spent time preparing and now know the party\'s weaknesses. Their opening move arrives without warning.',
        objective: 'Track down the nemesis before they can execute their full plan. Time is against you — every delay costs someone their safety.',
        obstacles: 'The nemesis has allies positioned throughout the region. Ambushes, false information, and traps await at every step.',
        twist: 'The nemesis doesn\'t want to kill the party — not yet. They want the party to suffer first. Each encounter is designed to take something away.',
        resolution: 'A final confrontation in a location personally meaningful to the conflict — somewhere that underlines the history between the two sides.',
        reward_gp: 1200,
        reward_extra: '+ the nemesis\'s personal weapon or symbol of power'
    },
    {
        name: 'Sins of the Past',
        hook: 'Word spreads that someone has compiled detailed records on each party member — their real names, their histories, their secrets. The dossier is already being sold.',
        objective: 'Find who is selling the information, recover every copy, and eliminate the source before it reaches the wrong hands.',
        obstacles: 'The nemesis has eyes in every town, paid informants in the guilds, and a contingency plan for every route the party tries.',
        twist: 'The dossier reveals something about one party member that the others don\'t know — a secret they kept buried.',
        resolution: 'The nemesis is offered a choice: stand down, or face total destruction. Their response reveals who they truly are.',
        reward_gp: 900,
        reward_extra: '+ the dossier destroyed or turned into leverage'
    },
    {
        name: 'The Long Game',
        hook: 'A series of seemingly unrelated events — a fire, a theft, a disappearance — are revealed to be the work of one mind. Someone has been orchestrating chaos from the shadows for weeks.',
        objective: 'Connect the threads, identify the orchestrator, and put an end to the campaign before the final event — which will be catastrophic.',
        obstacles: 'Every person who might know the nemesis\'s identity turns up dead or terrified into silence before the party can reach them.',
        twist: 'The nemesis is someone the party trusted. They have been feeding information to both sides this entire time.',
        resolution: 'A race against time to stop the final event while bringing the nemesis to justice — or choosing a more permanent solution.',
        reward_gp: 1500,
        reward_extra: '+ reputation cleared and a powerful faction in your debt'
    },
    {
        name: 'A Price on Your Head',
        hook: 'A contract has been placed on the party — or one specific member. Professional hunters begin arriving in town, and local contacts start going quiet.',
        objective: 'Survive the wave of hired killers, find out who placed the contract, and deal with the source before the next wave arrives.',
        obstacles: 'The hunters are professional, well-equipped, and briefed on the party\'s combat style. And more are coming.',
        twist: 'The contract was placed not out of hatred but out of fear — the nemesis is terrified of what the party is becoming.',
        resolution: 'The party can let the nemesis live with the contract cancelled, turn them in, or settle the matter permanently.',
        reward_gp: 1000,
        reward_extra: '+ the hunters\' gear and the contract ledger as evidence'
    },
    {
        name: 'The Mirror',
        hook: 'A group calling themselves the nemesis\'s "solution" begins targeting innocents connected to the party — people they have helped, saved, or befriended.',
        objective: 'Protect the innocents, strike back at the agents, and confront the nemesis before anyone else is hurt.',
        obstacles: 'The nemesis is untouchable for now — protected by legal standing, powerful friends, or magical defences. The party must dismantle the shield first.',
        twist: 'One of the innocents is not innocent at all — they have been feeding information to the nemesis all along.',
        resolution: 'The nemesis is finally exposed and vulnerable. What the party does in that moment will define how history remembers them.',
        reward_gp: 1100,
        reward_extra: '+ restoration of reputation for those harmed + one powerful ally'
    }
];

function generateNemesisQuest() {
    /* Pull existing nemesis data if available */
    var nemesisNPCs = [];
    try {
        var reg = JSON.parse(localStorage.getItem('npcgen_nemesis') || '{}');
        Object.keys(reg).forEach(function(id) { nemesisNPCs.push(reg[id]); });
    } catch(e){}

    var tmpl = NEMESIS_QUEST_DB[Math.floor(Math.random() * NEMESIS_QUEST_DB.length)];
    var nemName = nemesisNPCs.length ? nemesisNPCs[0].npcName : 'your nemesis';
    var reason = nemesisNPCs.length ? nemesisNPCs[0].reason : 'a past conflict';
    var players = [];
    try {
        var party = JSON.parse(localStorage.getItem('npcgen_party') || '[]');
        players = party.map(function(p) { return p.name; });
    } catch(e){}
    var targets = players.length ? players.slice(0,2).join(' and ') : 'the party';

    var diff = (document.getElementById('questDiff') || {}).value || 'hard';
    var diffColors = {easy:'#27ae60',medium:'#e67e22',hard:'#e74c3c',deadly:'#8b0000',legendary:'#4a0080'};
    var col = diffColors[diff] || '#8b0000';

    var html = '<div style="border-left:5px solid #8b0000;padding-left:14px;margin-bottom:10px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:1.3em;font-weight:700;color:#5a0000;margin-bottom:4px;">☠ ' + tmpl.name + '</div>'
        + '<div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">'
        + '<span style="background:#8b0000;color:white;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;text-transform:uppercase;">Nemesis Quest</span>'
        + '<span style="background:' + col + ';color:white;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;text-transform:uppercase;">' + (diff||'Hard') + '</span>'
        + '<span style="background:#333;color:#f0c0c0;padding:2px 10px;border-radius:8px;font-size:0.78em;">Nemesis: ' + nemName + '</span>'
        + '<span style="background:#1a1a2e;color:#c0c0ff;padding:2px 10px;border-radius:8px;font-size:0.78em;">Targets: ' + targets + '</span>'
        + '</div></div>'
        + [
            ['🎣 Hook', tmpl.hook + (nemesisNPCs.length ? ' The nemesis — <strong>' + nemName + '</strong> — acts on a grudge born from <em>' + reason + '</em>.' : '')],
            ['🎯 Objective', tmpl.objective],
            ['⚔ Obstacles', tmpl.obstacles],
            ['🌀 Twist', tmpl.twist],
            ['📜 Resolution', tmpl.resolution],
            ['💰 Reward', tmpl.reward_gp + ' gp · ' + tmpl.reward_extra]
        ].map(function(pair) {
            return '<div style="margin-bottom:14px;">'
                + '<div style="font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;color:#8b0000;text-transform:uppercase;margin-bottom:4px;border-bottom:1px solid rgba(139,0,0,0.2);padding-bottom:3px;">' + pair[0] + '</div>'
                + '<div style="line-height:1.7;color:#333;">' + pair[1] + '</div>'
                + '</div>';
        }).join('');

    var qaEl = document.getElementById('questArea');
    if (qaEl) qaEl.innerHTML = html;
    var actionBar = document.getElementById('questActionBar');
    if (actionBar) actionBar.style.display = 'flex';

    /* Store for saving */
    window._currentQuestData = { title: '☠ ' + tmpl.name, type: 'nemesis', diff: diff || 'hard', html: html };
    _showRevengeQuestUI(false);
    showToast('Nemesis quest generated for ' + nemName + '!', 'success');
}

/* ══════════════════════════════════════════════════════════════
   SAVED QUESTS VIEWER MODAL
   ══════════════════════════════════════════════════════════════ */
function openSavedQuestsViewer() {
    var modal = document.getElementById('savedQuestsViewerModal');
    if (!modal) return;
    modal.style.display = 'flex';
    _renderSavedQuestsViewer();
}

function closeSavedQuestsViewer() {
    var modal = document.getElementById('savedQuestsViewerModal');
    if (modal) modal.style.display = 'none';
}

function _renderSavedQuestsViewer() {
    var list = document.getElementById('sqvList');
    var empty = document.getElementById('sqvEmpty');
    if (!list) return;
    var qs = [];
    try { qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e){}
    if (!qs.length) {
        list.innerHTML = '';
        if (empty) empty.style.display = 'block';
        return;
    }
    if (empty) empty.style.display = 'none';

    var typeColors = {
        revenge: '#8b0000', nemesis: '#5a0080', main: '#1a6b5a',
        side: '#2471a3', random: '#555'
    };
    list.innerHTML = qs.slice().reverse().map(function(q) {
        var col = typeColors[q.type] || '#444';
        var typeLabel = q.type ? q.type.charAt(0).toUpperCase() + q.type.slice(1) : 'Quest';
        return '<div style="background:linear-gradient(145deg,#1e1e3a,#181828);border:1px solid rgba(184,134,11,0.3);border-radius:8px;overflow:hidden;">'
            + '<div style="background:rgba(0,0,0,0.3);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">'
            + '<div>'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.95em;font-weight:700;color:var(--gold-light);">' + (q.title||'Unnamed Quest') + '</div>'
            + '<div style="font-size:0.75em;color:rgba(255,255,255,0.4);margin-top:2px;">'
            + '<span style="background:' + col + ';color:white;padding:1px 7px;border-radius:6px;font-size:0.88em;">' + typeLabel + '</span>'
            + (q.diff ? ' &nbsp;' + q.diff : '') + ' &nbsp;· &nbsp;' + (q.date||'') + '</div>'
            + '</div>'
            + '<div style="display:flex;gap:6px;">'
            + '<button onclick="sqvLoad(\'' + q.id + '\')" style="padding:5px 14px;background:linear-gradient(145deg,var(--gold),#7a5800);color:white;border:none;border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">Load</button>'
            + '<button onclick="sqvDelete(\'' + q.id + '\')" style="padding:5px 10px;background:none;border:1px solid rgba(139,0,0,0.5);color:rgba(220,20,60,0.7);border-radius:5px;cursor:pointer;font-size:0.8em;">✕</button>'
            + '</div></div>'
            + '<div style="padding:14px 16px;font-family:\'Crimson Text\',serif;font-size:0.9em;color:rgba(255,255,255,0.7);max-height:120px;overflow:hidden;position:relative;">'
            + (q.html ? '<div style="color:#e8d5b5;line-height:1.5;">' + q.html.replace(/<[^>]+>/g,'').substring(0,200) + (q.html.replace(/<[^>]+>/g,'').length>200?'…':'') + '</div>' : '')
            + '</div>'
            + '</div>';
    }).join('');
}

function sqvLoad(id) {
    if (typeof loadSavedQuest === 'function') {
        closeSavedQuestsViewer();
        /* If we're in NPC mode, load into the dropdown area */
        var npcMode = document.getElementById('modeNPC');
        var isNpcMode = npcMode && npcMode.style.display !== 'none';
        if (isNpcMode) {
            var qs = [];
            try { qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e){}
            var q = qs.find(function(q){ return q.id === id; });
            if (q) {
                var outputEl = document.getElementById('npcDropdownQuestOutput');
                var actionsEl = document.getElementById('npcDropdownQuestActions');
                if (outputEl) { outputEl.innerHTML = q.html || '<em>No content</em>'; outputEl.style.display = 'block'; }
                if (actionsEl) { actionsEl.style.display = 'flex'; }
                _npcDropdownCurrentQuest = q;
                swSwitchTab('quest');
                showToast('Quest loaded!', 'success');
            }
        } else {
            switchMode('quest');
            setTimeout(function() { loadSavedQuest(id); }, 200);
        }
    }
}

function sqvDelete(id) {
    if (typeof deleteSavedQuest === 'function') deleteSavedQuest(id);
    setTimeout(_renderSavedQuestsViewer, 100);
    setTimeout(lpRefreshSavedQuests, 150);
    setTimeout(function(){if(typeof _refreshSavedQuestsSidebar==='function')_refreshSavedQuestsSidebar();}, 200);
}

/* Patch renderPartyTracker to also refresh left panel party */
(function() {
    var _orig = window.renderPartyTracker;
    if (_orig) {
        window.renderPartyTracker = function() {
            _orig.apply(this, arguments);
            setTimeout(lpRefreshParty, 50);
        };
    }
})();

/* ══════════════════════════════════════════════════════════════
   SESSION / CAMPAIGN SAVE & MAIN MENU
   ══════════════════════════════════════════════════════════════ */

function saveCurrentSession() {
    return saveCurrentCampaign();
}

function saveCurrentCampaign() {
    if (window._isOneShot) return;
    try {
        var campaignName = dmGetCurrentCampaignName() || 'Unnamed Campaign';
        var campaigns = _getCampaigns();
        var existing = null;
        if (_currentCampaign && _currentCampaign.id) {
            existing = campaigns.find(function(c){ return c.id === _currentCampaign.id; }) || null;
        }
        if (!existing) existing = campaigns.find(function(c){ return c.name === campaignName; }) || null;
        var campaignData = {
            id: existing ? existing.id : 'camp_' + Date.now(),
            name: campaignName,
            date: (existing && existing.date) ? existing.date : new Date().toLocaleDateString(),
            created: (existing && existing.created) ? existing.created : Date.now(),
            lastPlayed: new Date().toISOString(),
            npcs: JSON.parse(localStorage.getItem('npcgen_npcs') || '[]'),
            quests: JSON.parse(localStorage.getItem('npcgen_quests') || '[]'),
            party: JSON.parse(localStorage.getItem('npcgen_party') || '[]'),
            notes: localStorage.getItem('dm_notes') || '',
            quickNotes: localStorage.getItem('dm_quick_notes') || '',
            nemesis: JSON.parse(localStorage.getItem('npcgen_nemesis') || '{}'),
            sessionNotes: JSON.parse(localStorage.getItem('dm_saved_notes') || '[]'),
            killed: JSON.parse(localStorage.getItem('npcgen_killed') || '[]'),
            vault: JSON.parse(localStorage.getItem('dm_vault') || '[]'),
            activeQuest: (function(){ try { return JSON.parse(localStorage.getItem('dm_active_quest') || 'null'); } catch(e){ return null; } })(),
            activeRevenge: (function(){ try { return JSON.parse(localStorage.getItem('dm_active_revenge') || 'null'); } catch(e){ return null; } })(),
            savedRevengeQuests: JSON.parse(localStorage.getItem('dm_saved_revenge_quests') || '[]'),
            locations: JSON.parse(localStorage.getItem('dm_locations') || '[]'),
            swStories: JSON.parse(localStorage.getItem('dm_sw_stories') || '[]'),
            swLocs: JSON.parse(localStorage.getItem('dm_sw_locs') || '[]'),
            liveTools: (function(){ try { return JSON.parse(localStorage.getItem('dm_live_tools') || 'null'); } catch(e){ return null; } })(),
            tags: JSON.parse(localStorage.getItem('npcgen_tags') || '[]'),
            sessionNotesText: localStorage.getItem('npcgen_session_notes') || '',
            notesV2: JSON.parse(localStorage.getItem('npcgen_notes_v2') || '[]')
        };
        if (existing) {
            var idx = campaigns.indexOf(existing);
            campaigns[idx] = campaignData;
        } else {
            campaigns.push(campaignData);
        }
        _saveCampaigns(campaigns);
        _currentCampaign = campaignData;
        localStorage.setItem('dm_current_campaign', JSON.stringify(campaignData));
        var badge = document.getElementById('campaignBadgeName');
        if (badge) badge.textContent = campaignName;
        showToast('Campaign "' + campaignName + '" saved!', 'success');
    } catch(e) {
        showToast('Failed to save campaign: ' + e.message, 'warning');
    }
}

function confirmMainMenu() {
    var modal = document.getElementById('mainMenuWarningModal');
    if (modal) modal.style.display = 'flex';
}

function openGlobalSearchModal() {
    var modal = document.getElementById('globalSearchModal');
    var inp = document.getElementById('globalSearchInput');
    if (modal) modal.style.display = 'flex';
    if (inp) { inp.value = ''; setTimeout(function(){ inp.focus(); runGlobalSearch(''); }, 50); }
}
function closeGlobalSearchModal() {
    var modal = document.getElementById('globalSearchModal');
    if (modal) modal.style.display = 'none';
}
function runGlobalSearch(q) {
    var container = document.getElementById('globalSearchResults');
    if (!container) return;
    q = (q || '').trim().toLowerCase();
    var results = [];
    try {
        var npcs = (typeof window.generatedNPCs !== 'undefined' && Array.isArray(window.generatedNPCs)) ? window.generatedNPCs : [];
        var savedNpcs = JSON.parse(localStorage.getItem('npcgen_npcs') || '[]');
        var locs = JSON.parse(localStorage.getItem('dm_locations') || '[]');
        var quests = JSON.parse(localStorage.getItem('npcgen_quests') || '[]');
        var notesV2 = JSON.parse(localStorage.getItem('npcgen_notes_v2') || '[]');
        var savedNotes = JSON.parse(localStorage.getItem('dm_saved_notes') || '[]');
        function match(s) { return !q || (s && String(s).toLowerCase().indexOf(q) !== -1); }
        npcs.forEach(function(n) {
            if (match(n.name) || match(n.race) || match(n.class)) results.push({ type: 'NPC', name: n.name || n.id, sub: (n.race || '') + ' ' + (n.class || ''), id: n.id, action: 'npc' });
        });
        savedNpcs.forEach(function(n) {
            if (match(n.name) || match(n.race) || match(n.class)) results.push({ type: 'Saved NPC', name: n.name || n.id, sub: (n.race || '') + ' ' + (n.class || ''), id: n.id, action: 'savednpc' });
        });
        locs.forEach(function(l) {
            if (match(l.name) || match(l.description)) results.push({ type: 'Location', name: l.name || 'Location', sub: (l.description || '').slice(0, 60), id: l.id, action: 'location' });
        });
        quests.forEach(function(qq) {
            var name = (qq && (qq.title || qq.name || qq.questTitle)); if (match(name) || match(qq.summary)) results.push({ type: 'Quest', name: name || 'Quest', sub: (qq.summary || '').slice(0, 60), id: qq.id, action: 'quest' });
        });
        notesV2.forEach(function(n) {
            if (match(n.title) || match(n.body)) results.push({ type: 'Note', name: n.title || 'Note', sub: (n.body || '').slice(0, 60), id: n.id, action: 'note' });
        });
        savedNotes.forEach(function(n) {
            var t = (n && n.title) || 'Session note'; if (match(t) || match(n.body)) results.push({ type: 'Session Note', name: t, sub: (n.body || '').slice(0, 60), action: 'sessionnote' });
        });
    } catch(e) {}
    if (!results.length) {
        container.innerHTML = '<div style="padding:20px;color:rgba(255,255,255,0.45);text-align:center;">' + (q ? 'No matches for "' + q.replace(/</g,'&lt;') + '"' : 'Type to search NPCs, locations, quests, and notes.') + '</div>';
        return;
    }
    container.innerHTML = results.slice(0, 80).map(function(r) {
        var sub = (r.sub || '').replace(/</g,'&lt;').slice(0, 50);
        var click = "closeGlobalSearchModal();";
        if (r.action === 'npc' && typeof switchToNPC === 'function') click += "switchMode('npc');switchToNPC('" + (r.id || '').replace(/'/g, "\\'") + "');";
        else if (r.action === 'location' && typeof swSwitchTab === 'function') click += "switchMode('quest');swSwitchTab('location');";
        else if (r.action === 'quest' && typeof swSwitchTab === 'function') click += "switchMode('quest');swSwitchTab('quest');";
        else if (r.action === 'note' && typeof _refreshNotesDropdown === 'function') click += "_refreshNotesDropdown();";
        return '<div onclick="' + click + '" style="padding:10px 12px;margin-bottom:6px;background:rgba(255,255,255,0.06);border:1px solid rgba(218,165,32,0.25);border-radius:8px;cursor:pointer;">' +
            '<div style="font-weight:700;color:#fff3c0;">' + (r.type + ': ') + (String(r.name).replace(/</g,'&lt;').slice(0, 40)) + '</div>' +
            (sub ? '<div style="font-size:0.85em;opacity:0.75;margin-top:2px;">' + sub + '</div>' : '') + '</div>';
    }).join('');
}

function closeMainMenuWarning() {
    var modal = document.getElementById('mainMenuWarningModal');
    if (modal) modal.style.display = 'none';
}

function goToMainMenu() {
    /* Close warning modal */
    var modal = document.getElementById('mainMenuWarningModal');
    if (modal) modal.style.display = 'none';

    /* Close any open modals that might block interaction */
    var partyModal = document.getElementById('partyModal');
    if (partyModal) partyModal.style.display = 'none';
    var playerSheetModal = document.getElementById('playerSheetModal');
    if (playerSheetModal) playerSheetModal.classList.remove('active');
    var questPopupModal = document.getElementById('questPopupModal');
    if (questPopupModal) questPopupModal.classList.remove('active');
    var spellModal = document.getElementById('spellModal');
    if (spellModal) spellModal.classList.remove('active');
    var itemModal = document.getElementById('itemModal');
    if (itemModal) itemModal.style.display = 'none';
    var bountyModal = document.getElementById('bountyBoardModal');
    if (bountyModal) bountyModal.style.display = 'none';
    var genModeDialog = document.getElementById('genModeDialog');
    if (genModeDialog) genModeDialog.classList.remove('active');
    var npcFieldEditModal = document.getElementById('npcFieldEditModal');
    if (npcFieldEditModal) npcFieldEditModal.classList.remove('active');
    var killQuestModal = document.getElementById('killQuestModal');
    if (killQuestModal) killQuestModal.classList.remove('active');
    var encounterCalcModal = document.getElementById('encounterCalcModal');
    if (encounterCalcModal) encounterCalcModal.classList.remove('active');
    var encounterGenModal = document.getElementById('encounterGenModal');
    if (encounterGenModal) encounterGenModal.classList.remove('active');
    if (typeof closeOptionsModal === 'function') closeOptionsModal();
    var optionsModal = document.getElementById('optionsModal');
    if (optionsModal) optionsModal.style.display = 'none';
    if (typeof closeGlobalSearchModal === 'function') closeGlobalSearchModal();
    if (typeof closeLiveDMTools === 'function') closeLiveDMTools();
    if (typeof closeMinigamesModal === 'function') closeMinigamesModal();
    if (typeof hbCloseManager === 'function') hbCloseManager();

    document.body.classList.add('start-screen-only');
    var campaignScreen = document.getElementById('campaignStartScreen');
    if (campaignScreen) {
        /* Cancel any pending "hide start screen" timer from _launchApp */
        try { if (window._csGoneTimer) { clearTimeout(window._csGoneTimer); window._csGoneTimer = null; } } catch(e){}

        /* Fully reset the screen - remove all inline styles and classes */
        campaignScreen.className = '';
        campaignScreen.removeAttribute('style');
        campaignScreen.style.position = 'fixed';
        campaignScreen.style.inset = '0';
        campaignScreen.style.zIndex = '25000';
        campaignScreen.style.background = 'radial-gradient(ellipse at center, #1a0a00 0%, #0d0d1a 60%, #000 100%)';
        campaignScreen.style.display = 'flex';
        campaignScreen.style.flexDirection = 'column';
        campaignScreen.style.alignItems = 'center';
        campaignScreen.style.justifyContent = 'center';
        campaignScreen.style.opacity = '1';
        campaignScreen.style.pointerEvents = 'auto';
        campaignScreen.style.fontFamily = "'Cinzel', serif";
        campaignScreen.style.transition = 'opacity 0.8s ease';
        campaignScreen.style.paddingBottom = '72px';
        campaignScreen.style.boxSizing = 'border-box';
        if (document.body.classList.contains('electron')) campaignScreen.style.paddingTop = '36px';
        /* Hard remove any leftover hidden/gone flags */
        try { campaignScreen.classList.remove('hidden','gone'); } catch(e){}

        /* Reset inner panels — force show main options, hide sub-panels */
        var opts    = document.getElementById('csMainOptions');
        var newP    = document.getElementById('csNewPanel');
        var openP   = document.getElementById('csOpenPanel');
        var choiceP = document.getElementById('csChoicePanel');
        var backLink = document.getElementById('csBackLink');

        if (opts)     { opts.removeAttribute('style'); opts.style.display = 'flex'; }
        if (newP)     { newP.classList.remove('active'); newP.removeAttribute('style'); }
        if (openP)    { openP.classList.remove('active'); openP.removeAttribute('style'); }
        if (choiceP)  { choiceP.classList.remove('active'); }
        if (backLink) { backLink.style.display = 'none'; }

        /* Clear inputs */
        var inp = document.getElementById('csNewCampaignName');
        if (inp) inp.value = '';

        /* Re-render saved campaign list */
        if (typeof _renderCampaignList === 'function') _renderCampaignList();
    }

    /* Hide campaign badge */
    var badge = document.getElementById('campaignBadge');
    if (badge) badge.classList.remove('visible');

    /* Clear header health display */
    var hph = document.getElementById('headerPartyHealth');
    if (hph) hph.innerHTML = '';

    /* If exiting one-shot: clear all session data so nothing from the one-shot persists */
    if (window._isOneShot && typeof _clearSessionStorage === 'function') {
        _clearSessionStorage();
        window._isOneShot = false;
    }
    /* Reload for a clean main menu; saved campaigns stay in dm_saved_campaigns */
    setTimeout(function() {
        try { window.location.reload(); } catch(e){}
    }, 50);
}

document.addEventListener('DOMContentLoaded', function() {
    var mmModal = document.getElementById('mainMenuWarningModal');
    if (mmModal && !mmModal._dismissPatched) {
        mmModal._dismissPatched = true;
        mmModal.addEventListener('click', function(e) {
            if (e.target === mmModal) closeMainMenuWarning();
        });
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key !== 'Escape') return;
    var mmModal = document.getElementById('mainMenuWarningModal');
    if (mmModal && mmModal.style.display !== 'none') closeMainMenuWarning();
});

/* New direct campaign launch - skips the choice panel */
function csCreateNewCampaignAndLaunch() {
    window._isOneShot = false;
    var nameInput = document.getElementById('csNewCampaignName');
    var name = (nameInput ? nameInput.value.trim() : '') || 'Unnamed Campaign';
    var id = 'camp_' + Date.now();
    var campaignData = { id: id, name: name, lastPlayed: new Date().toISOString(), npcs:[], quests:[], party:[] };
    /* Save campaign */
    var campaigns = _getCampaigns();
    campaigns.push(campaignData);
    _saveCampaigns(campaigns);
    /* Set as current */
    _currentCampaign = campaignData;
    localStorage.setItem('dm_current_campaign', JSON.stringify(campaignData));
    /* Update badge */
    var badge = document.getElementById('campaignBadgeName');
    if (badge) badge.textContent = name;
    /* Launch */
    _launchApp('npc');
}

/* ══════════════════════════════════════════════════════════════
   NPC-MODE QUEST DROPDOWN
   ══════════════════════════════════════════════════════════════ */

var _npcDropdownCurrentQuest = null;

function toggleNpcQuestDropdown() {
    /* Now controlled by tab system — switch to Quest tab */
    swSwitchTab('quest');
}

function npcDropdownGenerateQuest(mode) {
    /* Sync selects to main quest generator */
    var typeVal = (document.getElementById('npcQuestType') || {}).value || '';
    var diffVal = (document.getElementById('npcQuestDiff') || {}).value || '';
    var settingVal = (document.getElementById('npcQuestSetting') || {}).value || '';
    var sideVal = (document.getElementById('npcQuestSideCount') || {}).value || '2';

    /* Set values in the main quest generator selects */
    var qt = document.getElementById('questType'); if (qt) qt.value = typeVal;
    var qd = document.getElementById('questDiff'); if (qd) qd.value = diffVal;
    var qs = document.getElementById('questSetting'); if (qs) qs.value = settingVal;
    var qsc = document.getElementById('questSideCount'); if (qsc) qsc.value = sideVal;
    /* Also for popup */
    var pqt = document.getElementById('qpmQuestType'); if (pqt) pqt.value = typeVal;
    var pqd = document.getElementById('qpmQuestDiff'); if (pqd) pqd.value = diffVal;
    var pqs = document.getElementById('qpmQuestSetting'); if (pqs) pqs.value = settingVal;

    var outputEl = document.getElementById('npcDropdownQuestOutput');
    var actionsEl = document.getElementById('npcDropdownQuestActions');
    if (outputEl) { outputEl.style.display = 'block'; outputEl.innerHTML = '<div style="text-align:center;color:#8b0000;font-family:\'Cinzel\',serif;padding:20px;">⏳ Generating quest...</div>'; }

    /* Generate using existing functions then capture output */
    setTimeout(function() {
        try {
            if (mode === 'main' && typeof generateFullQuest === 'function') {
                generateFullQuest();
            } else if (mode === 'side' && typeof generateSideQuestsOnly === 'function') {
                generateSideQuestsOnly();
            } else if (mode === 'random' && typeof generateRandomSideQuests === 'function') {
                generateRandomSideQuests();
            }
            /* After generation, pull content from the main quest area */
            setTimeout(function() {
                var qa = document.getElementById('questArea');
                if (qa && outputEl) {
                    var html = qa.innerHTML;
                    if (html && html.trim()) {
                        outputEl.innerHTML = html;
                        outputEl.style.display = 'block';
                        if (actionsEl) actionsEl.style.display = 'flex';
                        _npcDropdownCurrentQuest = window._currentQuestData || { title: 'Quest', type: mode, diff: diffVal, html: html };
                        showToast('Quest generated!', 'success');
                    } else {
                        outputEl.innerHTML = '<div style="color:#8b0000;font-family:\'Cinzel\',serif;text-align:center;padding:20px;">No quest data. Try switching to Quest tab to generate.</div>';
                    }
                }
            }, 300);
        } catch(e) {
            if (outputEl) outputEl.innerHTML = '<div style="color:#8b0000;padding:10px;">Error: ' + e.message + '</div>';
        }
    }, 50);
}

function npcDropdownSaveQuest() {
    if (!_npcDropdownCurrentQuest) { showToast('No quest to save', 'warning'); return; }
    try {
        var qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]');
        _npcDropdownCurrentQuest.id = 'q' + Date.now();
        _npcDropdownCurrentQuest.date = new Date().toLocaleDateString();
        qs.push(_npcDropdownCurrentQuest);
        localStorage.setItem('npcgen_quests', JSON.stringify(qs));
        if (typeof _refreshSavedQuestsSidebar === 'function') _refreshSavedQuestsSidebar();
        if (typeof lpRefreshSavedQuests === 'function') lpRefreshSavedQuests();
        showToast('Quest saved!', 'success');
    }
    catch(e) { showToast('Failed to save', 'warning'); }
}

function npcDropdownGenerateNPCs() {
    /* Close the dropdown and trigger NPC generation */
    showToast('Generating NPCs for quest...', 'success');
    if (typeof generateBatch === 'function') generateBatch();
}

</script>

<!-- ══════════════════════════════════════════════════════════════
     ENHANCED FOOTER — Made by Conrajon
     ══════════════════════════════════════════════════════════════ -->
<!-- ══ QUEST POPUP MODAL (in NPC mode) ══ -->
<div id="questPopupModal">
  <div class="qpm-inner">
    <div class="qpm-header">
      <div class="qpm-title">📜 Quest Generator</div>
      <button class="qpm-close" onclick="closeQuestPopup()">✕ Close</button>
    </div>
    <div class="qpm-body">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:18px;">
        <div class="quest-ctrl">
          <label style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);display:block;margin-bottom:5px;">Quest Type</label>
          <select id="qpmQuestType" style="width:100%;padding:8px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;">
            <option value="">Random</option>
            <option value="assassination">Assassination</option>
            <option value="retrieve">Retrieve / Heist</option>
            <option value="escort">Escort / Protect</option>
            <option value="investigate">Investigate / Mystery</option>
            <option value="rescue">Rescue</option>
            <option value="explore">Explore / Clear</option>
            <option value="defend">Defend / Siege</option>
            <option value="political">Political Intrigue</option>
            <option value="curse">Curse / Corruption</option>
            <option value="war">War / Conflict</option>
            <option value="divine">Divine / Religious</option>
            <option value="criminal">Criminal Underworld</option>
          </select>
        </div>
        <div class="quest-ctrl">
          <label style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);display:block;margin-bottom:5px;">Difficulty</label>
          <select id="qpmQuestDiff" style="width:100%;padding:8px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;">
            <option value="">Random</option>
            <option value="easy">Easy (Lvl 1-4)</option>
            <option value="medium">Medium (Lvl 5-8)</option>
            <option value="hard">Hard (Lvl 9-12)</option>
            <option value="deadly">Deadly (Lvl 13-16)</option>
            <option value="legendary">Legendary (Lvl 17+)</option>
          </select>
        </div>
        <div class="quest-ctrl">
          <label style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);display:block;margin-bottom:5px;">Setting</label>
          <select id="qpmQuestSetting" style="width:100%;padding:8px;border:2px solid var(--gold);background:#fffdf0;border-radius:4px;font-family:'Crimson Text',serif;">
            <option value="">Random</option>
            <option value="city">City / Urban</option>
            <option value="dungeon">Dungeon / Underground</option>
            <option value="wilderness">Wilderness</option>
            <option value="sea">Sea / Coast</option>
            <option value="mountain">Mountain / Highlands</option>
            <option value="war">Warzone</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
        <button onclick="qpmGenerateQuest('main')" style="flex:1;padding:11px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff8dc;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.9em;font-weight:700;min-width:130px;">⚔ Main Quest</button>
        <button onclick="qpmGenerateQuest('side')" style="flex:1;padding:11px;background:linear-gradient(145deg,#1a6b5a,#104840);color:#a0e8d0;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.9em;font-weight:700;min-width:130px;">📋 Side Quest</button>
        <button onclick="qpmGenerateNPCsForQuest()" style="flex:1;padding:11px;background:linear-gradient(145deg,var(--gold),#966f0a);color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.9em;font-weight:700;min-width:130px;">🧙 Generate Quest NPCs</button>
      </div>
      <div id="qpmQuestOutput" style="display:none;background:linear-gradient(145deg,#f4e4bc,#e8dcc5);border:2px solid var(--gold);border-radius:8px;padding:20px;max-height:440px;overflow-y:auto;color:#1a1a1a;font-family:'Crimson Text',serif;"></div>
      <div id="qpmQuestActions" style="display:none;margin-top:12px;display:none;gap:10px;flex-wrap:wrap;">
        <button onclick="qpmSaveQuest()" style="padding:9px 18px;background:var(--gold);color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;">💾 Save Quest</button>
        <button onclick="qpmGenerateNPCsForQuest()" style="padding:9px 18px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff8dc;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;font-weight:700;">🧙 Generate NPCs for This Quest</button>
        <button onclick="closeQuestPopup()" style="padding:9px 18px;background:#555;color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ══ SAVED QUESTS VIEWER MODAL ══ -->
<div id="savedQuestsViewerModal" class="app-modal" style="display:none;position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding:30px 20px;overflow-y:auto;">
  <div style="background:linear-gradient(145deg,#1a1a2e,#16213e);border:2px solid var(--gold);border-radius:12px;width:100%;max-width:860px;box-shadow:0 20px 60px rgba(0,0,0,0.8);animation:slideDown 0.3s ease-out;">
    <div style="background:linear-gradient(145deg,var(--red),var(--red-dark));padding:18px 24px;border-radius:10px 10px 0 0;display:flex;align-items:center;justify-content:space-between;">
      <div style="font-family:'Cinzel',serif;font-size:1.15em;font-weight:700;color:#fff8dc;text-transform:uppercase;letter-spacing:2px;">📖 Saved Quests</div>
      <button onclick="closeSavedQuestsViewer()" style="background:none;border:1px solid rgba(255,248,220,0.3);color:#fff8dc;padding:4px 12px;border-radius:4px;cursor:pointer;font-family:'Cinzel',serif;">✕ Close</button>
    </div>
    <div style="padding:20px;">
      <div id="sqvList" style="display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow-y:auto;"></div>
      <div id="sqvEmpty" style="display:none;color:rgba(184,134,11,0.4);font-family:'Crimson Text',serif;font-style:italic;text-align:center;padding:30px;">No saved quests yet. Generate and save quests to see them here.</div>
    </div>
  </div>
</div>

<!-- ══ KILL → REVENGE QUEST MODAL ══ -->
<div id="killQuestModal">
  <div class="kqm-inner">
    <div class="kqm-title">☠ NPC Killed — Forge Consequences</div>
    <div class="kqm-npc-box">
      <div class="kqm-npc-name" id="kqmNpcName">Unknown NPC</div>
      <div class="kqm-npc-sub" id="kqmNpcSub">Race · Class · Level</div>
    </div>
    <input type="hidden" id="kqmNpcId">
    <input type="hidden" id="kqmSelectedPlayer">

    <div class="kqm-section-label">Which player killed this NPC?</div>
    <div class="kqm-player-btns" id="kqmPlayerBtns">
      <div style="color:rgba(255,255,255,0.3);font-style:italic;font-size:0.85em;">No players in party tracker.</div>
    </div>

    <div class="kqm-result" id="kqmResult"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button onclick="confirmKillOnly()" style="flex:1;padding:10px;background:linear-gradient(145deg,#8b0000,#5a0000);color:#fff8dc;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-weight:700;font-size:0.9em;">☠ Confirm Kill</button>
      <button onclick="closeKillQuestModal()" style="padding:10px 16px;background:#333;color:#bbb;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;">Cancel</button>
    </div>
  </div>
</div>

<!-- ══ NPC FIELD EDIT MODAL ══ -->
<div id="npcFieldEditModal">
  <div class="nfe-inner">
    <div class="nfe-title" id="nfeTitle">Edit Field</div>
    <input type="hidden" id="nfeNpcId">
    <input type="hidden" id="nfeField">
    <div class="nfe-label" id="nfeLabel">Value</div>
    <textarea class="nfe-textarea" id="nfeValue" rows="5"></textarea>
    <div style="display:flex;gap:8px;margin-top:14px;">
      <button onclick="saveNpcFieldEdit()" style="flex:1;padding:10px;background:linear-gradient(145deg,var(--gold),#7a5800);color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-weight:700;font-size:0.9em;">✓ Save</button>
      <button onclick="closeNpcFieldEdit()" style="padding:10px 16px;background:#333;color:#bbb;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;">Cancel</button>
    </div>
  </div>
</div>

<!-- ══ SPELL MANAGER MODAL ══ -->
<div id="spellManagerModal">
  <div class="spm-inner">
    <div class="spm-header">
      <div class="spm-title">✦ Spell &amp; Ability Manager</div>
      <button onclick="closeSpellManager()" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#d0e8ff;padding:5px 14px;border-radius:4px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.85em;">✕ Close</button>
    </div>
    <div class="spm-body">
      <input type="hidden" id="spmPlayerId">
      <!-- Class / Subclass / Race -->
      <div class="spm-section">
        <div class="spm-section-title">Character Details</div>
        <div class="spm-grid">
          <div class="spm-field">
            <label>Class</label>
            <select id="spmClass" class="spm-select" onchange="spmUpdateSubclasses();spmUpdateSpellList()">
              <option>Fighter</option><option>Wizard</option><option>Cleric</option><option>Rogue</option>
              <option>Ranger</option><option>Paladin</option><option>Barbarian</option><option>Bard</option>
              <option>Druid</option><option>Monk</option><option>Sorcerer</option><option>Warlock</option><option>Artificer</option>
              <option value="custom">✦ Custom...</option>
            </select>
          </div>
          <div class="spm-field" id="spmCustomClassField" style="display:none;">
            <label>Custom Class</label>
            <input id="spmCustomClass" class="spm-input" placeholder="Enter class name...">
          </div>
          <div class="spm-field">
            <label>Subclass</label>
            <select id="spmSubclass" class="spm-select" onchange="spmCheckCustomSubclass()">
              <option value="">None</option>
            </select>
          </div>
          <div class="spm-field" id="spmCustomSubclassField" style="display:none;">
            <label>Custom Subclass</label>
            <input id="spmCustomSubclass" class="spm-input" placeholder="Enter subclass name...">
          </div>
          <div class="spm-field">
            <label>Race</label>
            <select id="spmRace" class="spm-select" onchange="spmCheckCustomRace()">
              <option>Human</option><option>Elf</option><option>Dwarf</option><option>Halfling</option><option>Gnome</option>
              <option>Half-Elf</option><option>Half-Orc</option><option>Tiefling</option><option>Dragonborn</option>
              <option>Aasimar</option><option>Tabaxi</option><option>Genasi</option><option>Goliath</option>
              <option value="custom">✦ Custom Race...</option>
            </select>
          </div>
          <div class="spm-field" id="spmCustomRaceField" style="display:none;">
            <label>Custom Race</label>
            <input id="spmCustomRace" class="spm-input" placeholder="e.g. Kenku, Lizardfolk...">
          </div>
          <div class="spm-field" id="spmCustomRaceDetailsField" style="display:none;grid-column:1/-1;">
            <label>Custom Race Traits</label>
            <textarea id="spmCustomRaceDetails" class="spm-input" rows="2" style="resize:vertical;" placeholder="Racial traits, abilities, resistances..."></textarea>
          </div>
          <div class="spm-field">
            <label>Level</label>
            <input id="spmLevel" class="spm-input" type="number" min="1" max="20" value="1" onchange="spmAutoFillSlots()">
          </div>
        </div>
      </div>
      <!-- Spell Slots -->
      <div class="spm-section" id="spmSlotSection">
        <div class="spm-section-title">Spell Slots <span style="font-size:0.78em;color:rgba(255,255,255,0.35);font-family:serif;text-transform:none;font-weight:400;">(Current / Max per level)</span></div>
        <div class="spm-slot-grid">
          <div class="spm-slot-box"><div class="spm-slot-label">1st</div><div class="spm-slot-inputs"><input id="spmSlot1c" type="number" min="0" max="9" value="0"><span>/</span><input id="spmSlot1m" type="number" min="0" max="9" value="0"></div></div>
          <div class="spm-slot-box"><div class="spm-slot-label">2nd</div><div class="spm-slot-inputs"><input id="spmSlot2c" type="number" min="0" max="9" value="0"><span>/</span><input id="spmSlot2m" type="number" min="0" max="9" value="0"></div></div>
          <div class="spm-slot-box"><div class="spm-slot-label">3rd</div><div class="spm-slot-inputs"><input id="spmSlot3c" type="number" min="0" max="9" value="0"><span>/</span><input id="spmSlot3m" type="number" min="0" max="9" value="0"></div></div>
          <div class="spm-slot-box"><div class="spm-slot-label">4th</div><div class="spm-slot-inputs"><input id="spmSlot4c" type="number" min="0" max="9" value="0"><span>/</span><input id="spmSlot4m" type="number" min="0" max="9" value="0"></div></div>
          <div class="spm-slot-box"><div class="spm-slot-label">5th</div><div class="spm-slot-inputs"><input id="spmSlot5c" type="number" min="0" max="9" value="0"><span>/</span><input id="spmSlot5m" type="number" min="0" max="9" value="0"></div></div>
          <div class="spm-slot-box"><div class="spm-slot-label">6th</div><div class="spm-slot-inputs"><input id="spmSlot6c" type="number" min="0" max="9" value="0"><span>/</span><input id="spmSlot6m" type="number" min="0" max="9" value="0"></div></div>
          <div class="spm-slot-box"><div class="spm-slot-label">7th</div><div class="spm-slot-inputs"><input id="spmSlot7c" type="number" min="0" max="9" value="0"><span>/</span><input id="spmSlot7m" type="number" min="0" max="9" value="0"></div></div>
          <div class="spm-slot-box"><div class="spm-slot-label">8th</div><div class="spm-slot-inputs"><input id="spmSlot8c" type="number" min="0" max="9" value="0"><span>/</span><input id="spmSlot8m" type="number" min="0" max="9" value="0"></div></div>
          <div class="spm-slot-box"><div class="spm-slot-label">9th</div><div class="spm-slot-inputs"><input id="spmSlot9c" type="number" min="0" max="9" value="0"><span>/</span><input id="spmSlot9m" type="number" min="0" max="9" value="0"></div></div>
        </div>
        <div style="margin-top:6px;">
          <button onclick="spmAutoFillSlots()" style="padding:5px 14px;background:rgba(52,152,219,0.2);border:1px solid rgba(52,152,219,0.4);color:#a0d0ff;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">⚡ Auto-fill by Class &amp; Level</button>
        </div>
      </div>
      <!-- Spell List -->
      <div class="spm-section">
        <div class="spm-section-title">Known / Prepared Spells</div>
        <input type="text" class="spm-spell-search" id="spmSpellSearch" placeholder="🔍 Search spells by name, level, school..." oninput="spmFilterSpells()">
        <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
          <select id="spmSpellFilter" class="spm-select" style="flex:1;min-width:120px;" onchange="spmFilterSpells()">
            <option value="">All Levels</option>
            <option value="0">Cantrips</option>
            <option value="1">1st Level</option><option value="2">2nd Level</option>
            <option value="3">3rd Level</option><option value="4">4th Level</option>
            <option value="5">5th Level</option><option value="6">6th Level</option>
            <option value="7">7th Level</option><option value="8">8th Level</option>
            <option value="9">9th Level</option>
          </select>
          <button onclick="spmAddCustomSpell()" style="padding:5px 14px;background:rgba(52,152,219,0.15);border:1px solid rgba(52,152,219,0.4);color:#a0d0ff;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;">+ Custom Spell</button>
        </div>
        <div class="spm-spell-list" id="spmSpellList"></div>
      </div>
      <!-- Known Spells -->
      <div class="spm-section">
        <div class="spm-section-title">Current Spell List <span id="spmKnownCount" style="color:rgba(255,255,255,0.35);font-family:serif;text-transform:none;">(0 spells)</span></div>
        <div class="spm-known-spells" id="spmKnownSpells"><div style="color:rgba(255,255,255,0.25);font-size:0.82em;font-style:italic;">No spells added yet. Click spells above to add them.</div></div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="saveSpellManager()" style="flex:1;padding:11px;background:linear-gradient(145deg,#1a3a6a,#2a4a8a);color:#d0e8ff;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.95em;font-weight:700;">💾 Save</button>
        <button onclick="closeSpellManager()" style="padding:11px 18px;background:#333;color:#bbb;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ══ CHANGELOG PANEL ══ -->
<div id="changelogPanel">
  <div id="changelogBody">
    <div style="font-family:'Cinzel',serif;font-size:0.8em;font-weight:700;color:var(--gold);margin-bottom:10px;border-bottom:1px solid rgba(184,134,11,0.25);padding-bottom:6px;">📋 Changelog</div>
    <div id="changelogEntries"></div>
  </div>
  <button id="changelogToggleBtn" onclick="toggleChangelog()">📋 Changelog</button>
</div>

</div><!-- /.main-wrapper -->
<div class="app-footer">
    <div class="footer-main">DND DM Helper</div>
    <div class="footer-sub">Made by <span>Conrajon</span> &nbsp;·&nbsp; All Rights Reserved</div>
</div>

<script>
/* ══════════════════════════════════════════════════════════════
   SESSION NOTES POPOUT — JS Functions
   ══════════════════════════════════════════════════════════════ */
var _notesPopoutOpen = false;

var _soundBoardOpen = false;
var _soundBoardMasterVolume = 80;
var _soundBoardCustom = [];
try { _soundBoardCustom = JSON.parse(localStorage.getItem('dm_soundboard_custom') || '[]'); } catch(e) { _soundBoardCustom = []; }
var _soundBoardPlaying = {};
var SOUND_BOARD_BUILTIN = {
    tavern: [{ name: 'Tavern ambience', url: '', desc: 'Upload your own' }, { name: 'Crowd murmur', url: '', desc: 'Upload your own' }, { name: 'Fire crackle', url: '', desc: 'Upload your own' }],
    forest: [{ name: 'Birds', url: '', desc: 'Upload your own' }, { name: 'Wind', url: '', desc: 'Upload your own' }, { name: 'Stream', url: '', desc: 'Upload your own' }],
    combat: [{ name: 'Sword clash', url: '', desc: 'Upload your own' }, { name: 'Arrow', url: '', desc: 'Upload your own' }, { name: 'Spell impact', url: '', desc: 'Upload your own' }],
    town: [{ name: 'Market', url: '', desc: 'Upload your own' }, { name: 'Blacksmith', url: '', desc: 'Upload your own' }],
    dungeon: [{ name: 'Dripping water', url: '', desc: 'Upload your own' }, { name: 'Distant growl', url: '', desc: 'Upload your own' }],
    custom: []
};
function toggleSoundBoardPopout() {
    _soundBoardOpen = !_soundBoardOpen;
    var el = document.getElementById('soundBoardPopout');
    if (el) {
        if (_soundBoardOpen) { el.classList.remove('sb-collapsed'); el.classList.add('sb-open'); soundBoardRenderList(); }
        else { el.classList.remove('sb-open'); el.classList.add('sb-collapsed'); }
    }
}
function soundBoardSetMasterVolume(v) { _soundBoardMasterVolume = Math.max(0, Math.min(100, parseInt(v,10)||80)); }
function soundBoardRenderList() {
    var cat = (document.getElementById('soundBoardCategory')||{}).value || 'tavern';
    var list = document.getElementById('soundBoardList');
    if (!list) return;
    var items = cat === 'custom' ? _soundBoardCustom : (SOUND_BOARD_BUILTIN[cat] || []);
    list.innerHTML = items.map(function(s, i) {
        var id = (s.id || 'sb_' + cat + '_' + i);
        var canPlay = !!(s.url || s.dataUrl);
        var loopChecked = s.loop ? 'checked' : '';
        return '<div style="display:flex;align-items:center;gap:6px;padding:6px 8px;background:rgba(0,0,0,0.25);border-radius:6px;border:1px solid rgba(80,160,80,0.25);">' +
            (canPlay ? '<button type="button" onclick="soundBoardPlayByIndex(\'' + cat + '\', ' + i + ')" style="padding:4px 10px;background:rgba(80,160,80,0.4);color:#d0ffc0;border:none;border-radius:4px;cursor:pointer;font-size:0.78em;">▶</button>' : '') +
            '<span style="flex:1;font-size:0.85em;color:rgba(255,255,255,0.9);">' + (s.name || 'Sound ' + (i+1)) + '</span>' +
            (s.dataUrl || s.url ? '<label style="font-size:0.72em;color:rgba(255,255,255,0.6);"><input type="checkbox" ' + loopChecked + ' onchange="soundBoardSetLoopByIndex(\'' + cat + '\', ' + i + ', this.checked)"> Loop</label>' : '') +
            '</div>';
    }).join('');
    if (items.length === 0 && cat === 'custom') list.innerHTML = '<div style="padding:8px;color:rgba(255,255,255,0.5);font-size:0.85em;">No custom sounds. Use Upload above.</div>';
}
function soundBoardPlayByIndex(cat, idx) {
    var items = cat === 'custom' ? _soundBoardCustom : (SOUND_BOARD_BUILTIN[cat] || []);
    var s = items[idx];
    if (!s || (!s.url && !s.dataUrl)) return;
    var key = cat + '_' + idx;
    if (_soundBoardPlaying[key]) { _soundBoardPlaying[key].pause(); _soundBoardPlaying[key] = null; }
    var a = new Audio(s.dataUrl || s.url);
    a.volume = (_soundBoardMasterVolume / 100) || 0.8;
    a.loop = !!s.loop;
    a.play().catch(function() {});
    _soundBoardPlaying[key] = a;
    a.onended = function() { if (!a.loop) _soundBoardPlaying[key] = null; };
}
function soundBoardSetLoopByIndex(cat, idx, loop) {
    if (cat === 'custom' && _soundBoardCustom[idx]) { _soundBoardCustom[idx].loop = !!loop; localStorage.setItem('dm_soundboard_custom', JSON.stringify(_soundBoardCustom)); }
}
function soundBoardHandleUpload(ev) {
    var files = ev.target && ev.target.files;
    if (!files || !files.length) return;
    var file = files[0];
    if (!file.type || !file.type.startsWith('audio/')) { if (typeof showToast === 'function') showToast('Choose an audio file', 'success'); return; }
    var reader = new FileReader();
    reader.onload = function() {
        _soundBoardCustom.push({ id: 'sb_custom_' + Date.now(), name: file.name.replace(/\.[^.]*$/, ''), dataUrl: reader.result, loop: false });
        localStorage.setItem('dm_soundboard_custom', JSON.stringify(_soundBoardCustom));
        var sel = document.getElementById('soundBoardCategory');
        if (sel) sel.value = 'custom';
        soundBoardRenderList();
        if (typeof showToast === 'function') showToast('Sound added', 'success');
    };
    reader.readAsDataURL(file);
    ev.target.value = '';
}
function toggleSessionNotesPopout() {
    _notesPopoutOpen = !_notesPopoutOpen;
    var el = document.getElementById('sessionNotesPopout');
    if (el) {
        if (_notesPopoutOpen) {
            el.classList.remove('sn-collapsed');
            el.classList.add('sn-open');
        } else {
            el.classList.remove('sn-open');
            el.classList.add('sn-collapsed');
        }
    }
    if (_notesPopoutOpen) { refreshNotesPopout(); }
}

function refreshNotesPopout() {
    var sel = document.getElementById('notesDropdownPopout');
    if (!sel) return;
    var notes = [];
    try { notes = JSON.parse(localStorage.getItem('dm_saved_notes') || '[]'); } catch(e){}
    var current = sel.value;
    sel.innerHTML = '<option value="">-- New Note --</option>'
        + notes.map(function(n){ return '<option value="' + n.id + '">' + (n.title || 'Untitled Note') + '</option>'; }).join('');
    /* Restore selection if still valid */
    if (current && notes.find(function(n){ return n.id === current; })) sel.value = current;
}

function loadNotePopout() {
    var sel = document.getElementById('notesDropdownPopout');
    var titleEl = document.getElementById('notesTitlePopout');
    var textEl  = document.getElementById('notesTextareaPopout');
    if (!sel) return;
    var id = sel.value;
    if (!id) { if (titleEl) titleEl.value = ''; if (textEl) textEl.value = ''; return; }
    var notes = [];
    try { notes = JSON.parse(localStorage.getItem('dm_saved_notes') || '[]'); } catch(e){}
    var note = notes.find(function(n){ return n.id === id; });
    if (note) {
        if (titleEl) titleEl.value = note.title || '';
        if (textEl)  textEl.value  = note.body  || '';
    }
}

function saveNotePopout() {
    var sel     = document.getElementById('notesDropdownPopout');
    var titleEl = document.getElementById('notesTitlePopout');
    var textEl  = document.getElementById('notesTextareaPopout');
    if (!titleEl || !textEl) return;
    var title = titleEl.value.trim() || ('Note ' + new Date().toLocaleDateString());
    var body  = textEl.value;
    var notes = [];
    try { notes = JSON.parse(localStorage.getItem('dm_saved_notes') || '[]'); } catch(e){}
    var id = sel && sel.value ? sel.value : ('note_' + Date.now());
    var idx = notes.findIndex(function(n){ return n.id === id; });
    var note = { id: id, title: title, body: body, saved: new Date().toISOString() };
    if (idx >= 0) notes[idx] = note; else notes.push(note);
    try { localStorage.setItem('dm_saved_notes', JSON.stringify(notes)); } catch(e){}
    refreshNotesPopout();
    if (sel) sel.value = id;
    if (typeof showToast === 'function') showToast('Note saved!', 'success');
}

function newNotePopout() {
    var sel     = document.getElementById('notesDropdownPopout');
    var titleEl = document.getElementById('notesTitlePopout');
    var textEl  = document.getElementById('notesTextareaPopout');
    if (sel) sel.value = '';
    if (titleEl) titleEl.value = '';
    if (textEl)  textEl.value  = '';
}

function deleteNotePopout() {
    var sel = document.getElementById('notesDropdownPopout');
    if (!sel || !sel.value) { if (typeof showToast === 'function') showToast('No note selected.', 'success'); return; }
    var id = sel.value;
    var notes = [];
    try { notes = JSON.parse(localStorage.getItem('dm_saved_notes') || '[]'); } catch(e){}
    var beforeNotes = JSON.parse(JSON.stringify(notes || []));
    notes = notes.filter(function(n){ return n.id !== id; });
    try { localStorage.setItem('dm_saved_notes', JSON.stringify(notes)); } catch(e){}
    refreshNotesPopout();
    newNotePopout();
    dmPushUndoAction('Delete note', function() {
        try { localStorage.setItem('dm_saved_notes', JSON.stringify(beforeNotes || [])); } catch(e) {}
        refreshNotesPopout();
    });
    if (typeof showToast === 'function') showToast('Note deleted.', 'success');
}

/* ══════════════════════════════════════════════════════════════
   PARTY HEALTH OVERVIEW — renders compact HP bars in party modal
   ══════════════════════════════════════════════════════════════ */
function renderPartyHealthOverview() {
    var el = document.getElementById('partyHealthOverview');
    if (!el) return;
    if (!_party || !_party.length) {
        el.innerHTML = '<div style="color:rgba(184,134,11,0.4);font-size:0.8em;font-style:italic;">No players added yet.</div>';
        return;
    }
    el.innerHTML = _party.map(function(p) {
        var pct = Math.max(0, Math.min(100, Math.round(((p.hpCurr||0) / (p.hpMax||1)) * 100)));
        var col = pct <= 25 ? '#c0392b' : pct <= 50 ? '#e67e22' : '#27ae60';
        var bgCol = pct <= 25 ? 'rgba(139,0,0,0.15)' : pct <= 50 ? 'rgba(230,126,34,0.12)' : 'rgba(39,174,96,0.1)';
        return '<div style="background:' + bgCol + ';border:1px solid ' + col + ';border-radius:6px;padding:7px 10px;min-width:130px;flex:1;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.75em;font-weight:700;color:#fff8dc;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (p.name||'?') + '</div>'
            + '<div style="background:rgba(0,0,0,0.3);border-radius:4px;height:7px;overflow:hidden;margin-bottom:3px;">'
            + '<div style="height:100%;width:' + pct + '%;background:' + col + ';border-radius:4px;transition:width 0.3s;"></div></div>'
            + '<div style="font-size:0.7em;color:' + col + ';font-weight:700;">' + (p.hpCurr||0) + ' / ' + (p.hpMax||0) + ' HP &nbsp;·&nbsp; AC ' + (p.ac||10) + '</div>'
            + '<div style="display:flex;gap:4px;margin-top:4px;" onclick="event.stopPropagation()">'
            + '<button onclick="quickHP(\'' + p.id + '\',-1);renderPartyHealthOverview();" style="flex:1;padding:2px;background:#8b0000;color:white;border:none;border-radius:3px;cursor:pointer;font-size:0.8em;">−</button>'
            + '<button onclick="quickHP(\'' + p.id + '\',+1);renderPartyHealthOverview();" style="flex:1;padding:2px;background:#27ae60;color:white;border:none;border-radius:3px;cursor:pointer;font-size:0.8em;">+</button>'
            + '</div>'
            + '</div>';
    }).join('');
}

/* Render party tracker inside party modal (partyTrackerMerged div) */
function renderPartyTrackerMerged() {
    var el = document.getElementById('partyTrackerMerged');
    if (!el) return;
    if (!_party || !_party.length) {
        el.innerHTML = '<div style="color:rgba(184,134,11,0.4);font-size:0.82em;text-align:center;padding:10px;">No players added yet. Use + Add Player above.</div>';
        return;
    }
    /* Reuse lpRefreshParty but also call renderPartyHealthOverview */
    renderPartyHealthOverview();
}

/* Patch openPartyModal to always refresh health overview */
(function() {
    var _origOpen = window.openPartyModal;
    window.openPartyModal = function() {
        if (_origOpen) _origOpen.apply(this, arguments);
        setTimeout(function() {
            renderPartyHealthOverview();
            lpRefreshParty();
        }, 50);
    };
})();

/* Also patch quickHP to refresh overview */
(function() {
    var _origQHP = window.quickHP;
    window.quickHP = function(pid, dir) {
        if (_origQHP) _origQHP.apply(this, arguments);
        setTimeout(renderPartyHealthOverview, 30);
    };
})();

/* ══════════════════════════════════════════════════════════════
   KILLED NPCS LOG — toggle and refresh
   ══════════════════════════════════════════════════════════════ */
var _killedLogOpen = false;
function toggleKilledLog() {
    _killedLogOpen = !_killedLogOpen;
    var body = document.getElementById('killedNPCsLogList');
    var icon = document.getElementById('killedLogToggleIcon');
    if (body) body.style.display = _killedLogOpen ? 'block' : 'none';
    if (icon) icon.textContent = _killedLogOpen ? '▲' : '▼';
    if (_killedLogOpen) _renderKilledLog();
}

/* ══════════════════════════════════════════════════════════════
   REVENGE QUEST — for main quest mode button
   ══════════════════════════════════════════════════════════════ */
function generateRevengeQuestFromKilled() {
    var killed = [];
    try { killed = JSON.parse(localStorage.getItem('npcgen_killed') || '[]'); } catch(e){}
    /* Only use NPCs killed by an actual player (not 'Unknown') */
    var playerKilled = killed.filter(function(e){ return e.killedBy && e.killedBy !== 'Unknown'; });
    var withQuests = playerKilled.filter(function(e){ return e.revengeQuestHtml; });

    var qaEl = document.getElementById('questArea');
    var actionBar = document.getElementById('questActionBar');

    if (!playerKilled.length) {
        /* No NPCs killed by a player — block generation */
        var noKillMsg = '<div style="padding:30px;text-align:center;font-family:\'Cinzel\',serif;">'
            + '<div style="font-size:2em;margin-bottom:10px;">☠</div>'
            + '<div style="font-size:1.1em;font-weight:700;color:#ff9090;margin-bottom:8px;">No Fallen NPCs</div>'
            + '<div style="font-size:0.88em;color:rgba(255,255,255,0.55);font-family:\'Crimson Text\',serif;line-height:1.6;">A player must kill an NPC before a revenge quest can be generated.<br>Use the <strong style="color:#ff8080;">☠ Killed</strong> button on an NPC card and select the player who made the kill.</div>'
            + '</div>';
        if (qaEl) qaEl.innerHTML = noKillMsg;
        if (actionBar) actionBar.style.display = 'none';
        _showRevengeQuestUI(false);
        if (window._swActiveTab === 'revenge') {
            var swOut = document.getElementById('swQuestOutput');
            var swAct = document.getElementById('swQuestActions');
            if (swOut) { swOut.innerHTML = noKillMsg; swOut.style.display = 'block'; }
            if (swAct) swAct.style.display = 'none';
        }
        if (typeof showToast === 'function') showToast('A player must kill an NPC first to generate a revenge quest.', 'warning');
        return;
    }

    if (!withQuests.length) {
        /* NPCs were killed by players but none have revenge quest data attached */
        var noQuestMsg = '<div style="padding:30px;text-align:center;font-family:\'Cinzel\',serif;">'
            + '<div style="font-size:2em;margin-bottom:10px;">☠</div>'
            + '<div style="font-size:1.1em;font-weight:700;color:#ff9090;margin-bottom:8px;">No Revenge Quests Available</div>'
            + '<div style="font-size:0.88em;color:rgba(255,255,255,0.55);font-family:\'Crimson Text\',serif;line-height:1.6;">' + playerKilled.length + ' NPC(s) killed by players, but none generated revenge quest data.<br>Try killing a new NPC — revenge quest hooks are created automatically.</div>'
            + '</div>';
        if (qaEl) qaEl.innerHTML = noQuestMsg;
        if (actionBar) actionBar.style.display = 'none';
        _showRevengeQuestUI(false);
        if (window._swActiveTab === 'revenge') {
            var swOut = document.getElementById('swQuestOutput');
            var swAct = document.getElementById('swQuestActions');
            if (swOut) { swOut.innerHTML = noQuestMsg; swOut.style.display = 'block'; }
            if (swAct) swAct.style.display = 'none';
        }
        if (typeof showToast === 'function') showToast('Killed NPCs found but no revenge quest data. Kill a new NPC to generate one.', 'warning');
        return;
    }

    /* Pick random killed NPC with revenge quest */
    var entry = withQuests[Math.floor(Math.random() * withQuests.length)];
    var diff = (document.getElementById('questDiff') || {}).value || 'hard';

    var html = '<div style="border-left:5px solid rgba(255,120,120,0.8);padding-left:14px;margin-bottom:10px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:1.3em;font-weight:700;color:#ffb8b8;margin-bottom:4px;">☠ Revenge Quest: ' + entry.npcName + '</div>'
        + '<div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">'
        + '<span style="background:#8b0000;color:white;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;text-transform:uppercase;">Revenge Quest</span>'
        + '<span style="background:#444;color:#f08080;padding:2px 10px;border-radius:8px;font-size:0.78em;">Killed by: ' + entry.killedBy + '</span>'
        + '<span style="background:#1a1a2e;color:rgba(255,255,255,0.6);padding:2px 10px;border-radius:8px;font-size:0.78em;">' + entry.killedAt + '</span>'
        + (entry.isBoss ? '<span style="background:#4a0080;color:#ffd700;padding:2px 10px;border-radius:8px;font-size:0.78em;font-weight:700;">BOSS</span>' : '')
        + '</div></div>'
        + '<div style="background:linear-gradient(145deg,#2a0000,#1a0000);border:1px solid rgba(139,0,0,0.4);border-radius:8px;padding:12px 16px;margin-bottom:14px;">'
        + '<div style="font-size:0.8em;color:rgba(255,255,255,0.5);margin-bottom:3px;">The fallen:</div>'
        + '<div style="font-family:\'Cinzel\',serif;font-size:1em;font-weight:700;color:#f08080;">' + entry.npcName + ' — ' + (entry.npcRace||'') + ' ' + (entry.npcClass||'') + ' Lvl ' + (entry.npcLevel||'?') + '</div>'
        + '</div>'
        + entry.revengeQuestHtml;

    if (qaEl) qaEl.innerHTML = html;
    if (actionBar) actionBar.style.display = 'flex';
    window._currentQuestData = { title: '☠ Revenge: ' + entry.npcName, type: 'revenge', diff: diff, html: html, revengeKilledEntry: entry };
    _showRevengeQuestUI(true);
    if (window._swActiveTab === 'revenge') {
        var swOut = document.getElementById('swQuestOutput');
        var swAct = document.getElementById('swQuestActions');
        if (swOut) { swOut.innerHTML = (typeof _revengeHtmlForDarkUI === 'function' ? _revengeHtmlForDarkUI(html) : html); swOut.style.display = 'block'; }
        if (swAct) swAct.style.display = 'flex';
    }
    if (typeof showToast === 'function') showToast('Revenge quest generated for ' + entry.npcName + '!', 'success');
}

/* ══════════════════════════════════════════════════════════════
   REVENGE QUEST — generate from NPC dropdown using killed NPC data
   ══════════════════════════════════════════════════════════════ */
function npcDropdownGenerateRevengeQuest() {
    var outputEl  = document.getElementById('npcDropdownQuestOutput');
    var actionsEl = document.getElementById('npcDropdownQuestActions');

    /* Make sure quest tab is open */
    swSwitchTab('quest');

    /* Check if there are killed NPCs with revenge quests — only player kills count */
    var killed = [];
    try { killed = JSON.parse(localStorage.getItem('npcgen_killed') || '[]'); } catch(e){}
    var playerKilled = killed.filter(function(e){ return e.killedBy && e.killedBy !== 'Unknown'; });
    var withQuests = playerKilled.filter(function(e){ return e.revengeQuestHtml; });

    if (!playerKilled.length) {
        var msg = '<div style="padding:24px;text-align:center;font-family:\'Cinzel\',serif;">'
            + '<div style="font-size:1.8em;margin-bottom:8px;">☠</div>'
            + '<div style="font-size:1em;font-weight:700;color:#8b0000;margin-bottom:6px;">No Fallen NPCs</div>'
            + '<div style="font-size:0.85em;color:#888;font-family:\'Crimson Text\',serif;line-height:1.6;">A player must kill an NPC before a revenge quest can be generated.<br>Use the <strong>☠ Killed</strong> button on an NPC card and select the player who made the kill.</div>'
            + '</div>';
        if (outputEl) { outputEl.innerHTML = msg; outputEl.style.display = 'block'; }
        if (actionsEl) actionsEl.style.display = 'none';
        if (typeof showToast === 'function') showToast('A player must kill an NPC first to generate a revenge quest.', 'warning');
        return;
    }

    if (!withQuests.length) {
        var msg = '<div style="padding:24px;text-align:center;font-family:\'Cinzel\',serif;">'
            + '<div style="font-size:1.8em;margin-bottom:8px;">☠</div>'
            + '<div style="font-size:1em;font-weight:700;color:#8b0000;margin-bottom:6px;">No Revenge Quests Available</div>'
            + '<div style="font-size:0.85em;color:#888;font-family:\'Crimson Text\',serif;line-height:1.6;">' + playerKilled.length + ' NPC(s) killed by players, but none have revenge quest data.<br>Try killing a new NPC — revenge quest hooks are created automatically.</div>'
            + '</div>';
        if (outputEl) { outputEl.innerHTML = msg; outputEl.style.display = 'block'; }
        if (actionsEl) actionsEl.style.display = 'none';
        if (typeof showToast === 'function') showToast('Killed NPCs found but no revenge quest data.', 'warning');
        return;
    }

    /* Pick a random killed NPC with a revenge quest (or the most recent) */
    var entry = withQuests[Math.floor(Math.random() * withQuests.length)];

    var html = '<div style="background:linear-gradient(145deg,#2a0000,#1a0000);border:2px solid #8b0000;border-radius:8px;padding:12px 16px;margin-bottom:12px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;color:#f08080;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Triggered By</div>'
        + '<div style="color:#fff8dc;font-family:\'Cinzel\',serif;font-size:1em;font-weight:700;">☠ ' + entry.npcName + (entry.isBoss ? ' <span style="background:#4a0080;color:#ffd700;padding:1px 6px;border-radius:4px;font-size:0.72em;margin-left:4px;">BOSS</span>' : '') + '</div>'
        + '<div style="font-size:0.78em;color:rgba(255,255,255,0.45);margin-top:3px;">' + (entry.npcRace||'') + ' ' + (entry.npcClass||'') + ' · Lvl ' + (entry.npcLevel||'?') + ' · Killed by <strong style="color:#f08080;">' + entry.killedBy + '</strong> · ' + entry.killedAt + '</div>'
        + '</div>'
        + entry.revengeQuestHtml;

    if (outputEl) { outputEl.innerHTML = html; outputEl.style.display = 'block'; }
    if (actionsEl) actionsEl.style.display = 'flex';
    _npcDropdownCurrentQuest = { title: '☠ Revenge: ' + entry.npcName, type: 'revenge', diff: 'hard', html: html };
    if (typeof showToast === 'function') showToast('Revenge quest loaded for ' + entry.npcName + '!', 'success');
}

/* ══════════════════════════════════════════════════════════════
   BOOT — run on DOMContentLoaded to init new features
   ══════════════════════════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', function() {
    /* Render killed log if it has data */
    if (typeof _killedNPCsLog !== 'undefined' && _killedNPCsLog.length) _renderKilledLog();
    /* Refresh notes popout dropdown when it's opened */
    refreshNotesPopout();
    /* Render changelog */
    _renderChangelog();
    /* Log initial load */
    _clLog('DM Helper loaded — session started');
});

/* ══════════════════════════════════════════════════════════════
   SESSION TIMER (bottom-left: set time, start, pause, reset)
   ══════════════════════════════════════════════════════════════ */
window._sessionTimer = { seconds: 0, running: false, intervalId: null };
function sessionTimerUpdateDisplay() {
    var s = window._sessionTimer.seconds;
    var m = Math.floor(s / 60);
    var sec = s % 60;
    var el = document.getElementById('sessionTimerDisplay');
    if (el) el.textContent = m + ':' + (sec < 10 ? '0' : '') + sec;
}
function sessionTimerStartStop() {
    var t = window._sessionTimer;
    if (t.running) {
        t.running = false;
        if (t.intervalId) clearInterval(t.intervalId);
        t.intervalId = null;
        var btn = document.getElementById('sessionTimerStart');
        if (btn) btn.textContent = 'Start';
    } else {
        t.running = true;
        var btn = document.getElementById('sessionTimerStart');
        if (btn) btn.textContent = 'Pause';
        t.intervalId = setInterval(function() {
            window._sessionTimer.seconds++;
            sessionTimerUpdateDisplay();
        }, 1000);
    }
}
function sessionTimerReset() {
    var t = window._sessionTimer;
    t.running = false;
    if (t.intervalId) clearInterval(t.intervalId);
    t.intervalId = null;
    t.seconds = 0;
    sessionTimerUpdateDisplay();
    var btn = document.getElementById('sessionTimerStart');
    if (btn) btn.textContent = 'Start';
}
function sessionTimerStop() {
    var t = window._sessionTimer;
    t.running = false;
    if (t.intervalId) clearInterval(t.intervalId);
    t.intervalId = null;
    t.seconds = 0;
    sessionTimerUpdateDisplay();
    var btn = document.getElementById('sessionTimerStart');
    if (btn) btn.textContent = 'Start';
}
function sessionTimerSet() {
    var minInput = document.getElementById('sessionTimerMinutes');
    var secInput = document.getElementById('sessionTimerSeconds');
    var min = (minInput && minInput.value) ? parseInt(minInput.value, 10) : 0;
    var sec = (secInput && secInput.value) ? parseInt(secInput.value, 10) : 0;
    if (isNaN(min) || min < 0) min = 0;
    if (isNaN(sec) || sec < 0) sec = 0;
    window._sessionTimer.seconds = min * 60 + sec;
    sessionTimerUpdateDisplay();
}
sessionTimerUpdateDisplay();

/* ══════════════════════════════════════════════════════════════
   ONESHOT TOGGLE — syncs checkbox with hidden radio buttons
   ══════════════════════════════════════════════════════════════ */
(function() {
    var cb = document.getElementById('storyOneshotToggle');
    if (!cb) return;
    cb.addEventListener('change', function() {
        var oneshotRadio = document.getElementById('storyScope_oneshot');
        var campaignRadio = document.getElementById('storyScope_campaign');
        if (cb.checked) {
            if (oneshotRadio) oneshotRadio.checked = true;
        } else {
            if (campaignRadio) campaignRadio.checked = true;
        }
    });
})();

/* ══════════════════════════════════════════════════════════════
   CONFIRM KILL — simplified (just logs kill, no quest popup)
   ══════════════════════════════════════════════════════════════ */
function confirmKillOnly() {
    var npcId    = document.getElementById('kqmNpcId').value;
    var playerId = document.getElementById('kqmSelectedPlayer').value;
    var npc      = (typeof getNPCById === 'function') ? getNPCById(npcId) : null;
    var player   = _party.find(function(p){ return p.id === playerId; });

    if (!npc) { showToast('NPC not found', 'warning'); return; }
    if (!player && _party.length) { showToast('Please select a player first', 'warning'); return; }

    /* Mark NPC as dead */
    npc.isDead       = true;
    npc.killedBy     = playerId;
    npc.killedByName = player ? player.name : 'Unknown';
    npc.killedAt     = new Date().toLocaleDateString();

    /* Player tracking */
    if (player) {
        if (!player.nemeses) player.nemeses = [];
        player.nemeses.push({ npcId: npcId, npcName: npc.name, reason: 'Killed / Defeated' });
        if (!player.isHunted) player.isHunted = [];
        player.isHunted.push(npc.name);
        _saveParty();
        renderPartyTracker();
    }

    /* Propagate hostility */
    if (typeof _propagateNemesisToRelated === 'function') _propagateNemesisToRelated(npcId, playerId);
    _markRelatedNPCsHostile(npc, player);

    /* Generate revenge quest data silently (stored on NPC, NOT shown) */
    if (typeof REVENGE_QUEST_TEMPLATES !== 'undefined' && REVENGE_QUEST_TEMPLATES.length) {
        var tmpl     = REVENGE_QUEST_TEMPLATES[Math.floor(Math.random() * REVENGE_QUEST_TEMPLATES.length)];
        var relation = (typeof _getRelatedNPCName === 'function' ? _getRelatedNPCName(npc) : null) || 'their allies';
        var killer   = player ? player.name : 'the party';
        var fill     = function(s){ return s.replace(/\{npc\}/g,npc.name).replace(/\{relation\}/g,relation).replace(/\{killer\}/g,killer); };
        var rewardGP = (npc.level || 1) * 150;
        npc._revengeQuestHtml  = '<div style="border-left:5px solid #8b0000;padding-left:14px;"><div style="font-family:\'Cinzel\',serif;font-size:1.2em;font-weight:700;color:#5a0000;margin-bottom:4px;">☠ ' + fill(tmpl.title) + '</div></div>'
            + [['🎣 Hook',fill(tmpl.hook)],['🎯 Objective',fill(tmpl.objective)],['🌀 Twist',fill(tmpl.twist)],['💰 Reward',rewardGP + ' gp + clearing your name']]
                .map(function(pair){ return '<div style="margin-bottom:12px;"><div style="font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;color:#8b0000;text-transform:uppercase;margin-bottom:4px;border-bottom:1px solid rgba(139,0,0,0.2);padding-bottom:3px;">' + pair[0] + '</div><div style="line-height:1.7;color:#333;">' + pair[1] + '</div></div>'; }).join('');
        npc._revengeQuestTitle = '☠ ' + fill(tmpl.title);
    }

    /* Add to fallen log */
    _addToKilledLog(npc, player);

    /* Remove NPC from the board (tabs and card) so they no longer appear on screen */
    if (Array.isArray(window.generatedNPCs)) {
        var idx = generatedNPCs.findIndex(function(n){ return n.id === npcId; });
        if (idx >= 0) {
            if (window.activeNPCId === npcId) {
                var next = generatedNPCs.length > 1 ? generatedNPCs[idx + 1] || generatedNPCs[idx - 1] : generatedNPCs[0];
                window.activeNPCId = next && next.id !== npcId ? next.id : null;
            }
            generatedNPCs = generatedNPCs.filter(function(n){ return n.id !== npcId; });
        }
    }
    if (typeof renderAllNPCs === 'function') renderAllNPCs();
    if (typeof updateAllNPCTabs === 'function') updateAllNPCTabs();
    if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
    if (typeof _refreshSavedQuestsList === 'function') _refreshSavedQuestsList();

    /* Close modal */
    closeKillQuestModal();

    var killerName = player ? player.name : 'the party';
    showToast('☠ ' + npc.name + ' killed by ' + killerName + ' — removed from the board; added to Fallen NPCs log.', 'success');
    _clLog(npc.name + ' was killed by ' + killerName + '. Revenge quest generated and stored.');

    /* Auto-open fallen log if collapsed */
    if (!_killedLogOpen) {
        _killedLogOpen = true;
        var body = document.getElementById('killedNPCsLogList');
        var icon = document.getElementById('killedLogToggleIcon');
        if (body) body.style.display = 'block';
        if (icon) icon.textContent = '▲';
    }
}

/* ══════════════════════════════════════════════════════════════
   NPC FIELD EDIT MODAL
   ══════════════════════════════════════════════════════════════ */
function openNpcFieldEdit(npcId, field, label, currentValue) {
    document.getElementById('nfeNpcId').value    = npcId;
    document.getElementById('nfeField').value    = field;
    document.getElementById('nfeTitle').textContent = '✏ Edit — ' + label;
    document.getElementById('nfeLabel').textContent = label;
    document.getElementById('nfeValue').value    = currentValue || '';
    document.getElementById('npcFieldEditModal').classList.add('active');
    setTimeout(function(){ document.getElementById('nfeValue').focus(); }, 80);
}

function closeNpcFieldEdit() {
    document.getElementById('npcFieldEditModal').classList.remove('active');
}

function saveNpcFieldEdit() {
    var npcId  = document.getElementById('nfeNpcId').value;
    var field  = document.getElementById('nfeField').value;
    var value  = document.getElementById('nfeValue').value.trim();
    var npc    = (typeof getNPCById === 'function') ? getNPCById(npcId) : null;
    if (!npc) { closeNpcFieldEdit(); return; }

    /* Apply to correct field */
    switch(field) {
        case 'appearance': npc.physicalDesc = value; break;
        case 'clothing':  if (!npc.appearance) npc.appearance = {}; npc.appearance.clothing = value; break;
        case 'armor':     if (!npc.appearance) npc.appearance = {}; npc.appearance.armor    = value; break;
        case 'weapon':    if (!npc.appearance) npc.appearance = {}; npc.appearance.weapon   = value; break;
        case 'personality': if (!npc.personality) npc.personality = {}; npc.personality.summary = value; break;
        case 'flaw':      if (!npc.personality) npc.personality = {}; npc.personality.flaw   = value; break;
        case 'speech':    if (!npc.personality) npc.personality = {}; npc.personality.speech = value; break;
        case 'secret':    if (!npc.personality) npc.personality = {}; npc.personality.secret = value; break;
        case 'questHook': if (!npc.quest) npc.quest = {}; npc.quest.desc = value; break;
    }

    /* Update DOM directly (fast path, no full re-render) */
    var el;
    if (field === 'appearance') {
        el = document.getElementById('nfc-appearance-' + npcId);
        if (el) el.textContent = value;
    } else if (field === 'personality') {
        el = document.getElementById('nfc-personality-' + npcId);
        if (el) el.textContent = value;
    } else if (field === 'flaw') {
        el = document.getElementById('nfc-flaw-' + npcId);
        if (el) el.textContent = value;
    } else if (field === 'speech') {
        el = document.getElementById('nfc-speech-' + npcId);
        if (el) el.textContent = value;
    } else if (field === 'secret') {
        el = document.getElementById('nfc-secret-' + npcId);
        if (el) el.textContent = value;
    } else if (field === 'questHook') {
        el = document.getElementById('nfc-questHook-' + npcId);
        if (el) el.textContent = value;
    } else if (field === 'clothing') {
        el = document.getElementById('nfc-clothing-' + npcId);
        if (el) el.textContent = value || 'Common attire';
    } else if (field === 'armor') {
        el = document.getElementById('nfc-armor-' + npcId);
        if (el) el.textContent = value || 'Unarmored';
    } else if (field === 'weapon') {
        el = document.getElementById('nfc-weapon-' + npcId);
        if (el) el.textContent = value || 'No visible weapon';
    }

    /* Persist NPC changes */
    if (typeof saveNPCToStorage === 'function') saveNPCToStorage(npc);
    else {
        try {
            var npcs = JSON.parse(localStorage.getItem('npcgen_npcs') || '[]');
            var idx = npcs.findIndex(function(n){ return n.id === npcId; });
            if (idx >= 0) { npcs[idx] = Object.assign(npcs[idx], npc); localStorage.setItem('npcgen_npcs', JSON.stringify(npcs)); }
        } catch(e){}
    }

    closeNpcFieldEdit();
    showToast('NPC updated!', 'success');
    _clLog('NPC field edited: ' + field + ' on ' + (npc.name || npcId));
}

/* ══════════════════════════════════════════════════════════════
   PLAYER SHEET — Subclass / Custom Race helpers
   ══════════════════════════════════════════════════════════════ */
var PS_SUBCLASSES = {
    Fighter: [
        // PHB
        'Champion', 'Battle Master', 'Eldritch Knight',
        // SCAG
        'Purple Dragon Knight (Banneret)',
        // XGE
        'Arcane Archer', 'Cavalier', 'Samurai',
        // TCE
        'Psi Warrior', 'Rune Knight',
        // EGW
        'Echo Knight',
        // UA / Other
        'Brute', 'Gunslinger (Critical Role)', 'Monster Hunter'
    ],
    Wizard: [
        // PHB
        'School of Abjuration', 'School of Conjuration', 'School of Divination',
        'School of Enchantment', 'School of Evocation', 'School of Illusion',
        'School of Necromancy', 'School of Transmutation',
        // SCAG
        'Bladesinging',
        // XGE
        'War Magic',
        // EGW
        'Chronurgy Magic', 'Graviturgy Magic',
        // TCE
        'Order of Scribes',
        // Other
        'School of Invention', 'Lore Mastery'
    ],
    Cleric: [
        // PHB
        'Life Domain', 'Light Domain', 'Nature Domain', 'Knowledge Domain',
        'Tempest Domain', 'Trickery Domain', 'War Domain',
        // DMG
        'Death Domain',
        // SCAG
        'Arcana Domain',
        // XGE
        'Forge Domain', 'Grave Domain',
        // TCE
        'Order Domain', 'Peace Domain', 'Twilight Domain',
        // UA
        'Unity Domain', 'Ambition Domain', 'Solidarity Domain',
        'Strength Domain', 'Zeal Domain'
    ],
    Rogue: [
        // PHB
        'Thief', 'Arcane Trickster', 'Assassin',
        // SCAG
        'Mastermind', 'Swashbuckler',
        // XGE
        'Inquisitive', 'Scout',
        // TCE
        'Phantom', 'Soulknife'
    ],
    Ranger: [
        // PHB
        'Hunter', 'Beast Master',
        // XGE
        'Gloom Stalker', 'Horizon Walker', 'Monster Slayer',
        // TCE
        'Fey Wanderer', 'Swarmkeeper',
        // FTD
        'Drakewarden',
        // Other
        'Deep Stalker', 'Primeval Guardian'
    ],
    Paladin: [
        // PHB
        'Oath of Devotion', 'Oath of the Ancients', 'Oath of Vengeance',
        // DMG
        'Oathbreaker',
        // SCAG
        'Oath of the Crown',
        // XGE
        'Oath of Conquest', 'Oath of Redemption',
        // TCE
        'Oath of Glory', 'Oath of the Watchers',
        // EGW
        'Oath of the Open Sea',
        // FTD
        'Oath of Dragonlord'
    ],
    Barbarian: [
        // PHB
        'Path of the Berserker', 'Path of the Totem Warrior',
        // SCAG
        'Path of the Battlerager',
        // XGE
        'Path of the Ancestral Guardian', 'Path of the Storm Herald', 'Path of the Zealot',
        // TCE
        'Path of the Beast', 'Path of Wild Magic',
        // EGW
        'Path of the Juggernaut',
        // Other
        'Path of the Depths', 'Path of the Rage Mage', 'Path of the Giant'
    ],
    Bard: [
        // PHB
        'College of Lore', 'College of Valor',
        // SCAG
        'College of Swords', 'College of Whispers',
        // XGE
        'College of Glamour',
        // TCE
        'College of Creation', 'College of Eloquence',
        // SCC
        'College of Spirits',
        // Other
        'College of Satire', 'College of Tragedy'
    ],
    Druid: [
        // PHB
        'Circle of the Land', 'Circle of the Moon',
        // XGE
        'Circle of Dreams', 'Circle of the Shepherd',
        // TCE
        'Circle of Spores', 'Circle of Stars', 'Circle of Wildfire',
        // Other
        'Circle of Twilight', 'Circle of the Arctic', 'Circle of the Coast',
        'Circle of the Desert', 'Circle of the Forest', 'Circle of the Grassland',
        'Circle of the Mountain', 'Circle of the Swamp', 'Circle of the Underdark'
    ],
    Monk: [
        // PHB
        'Way of the Open Hand', 'Way of Shadow', 'Way of the Four Elements',
        // SCAG
        'Way of the Long Death', 'Way of the Sun Soul',
        // XGE
        'Way of the Drunken Master', 'Way of the Kensei', 'Way of the Tranquility',
        // TCE
        'Way of Mercy', 'Way of the Astral Self',
        // FTD
        'Way of the Ascendant Dragon',
        // Other
        'Way of the Cobalt Soul (Critical Role)', 'Way of the Unyielding'
    ],
    Sorcerer: [
        // PHB
        'Draconic Bloodline', 'Wild Magic',
        // SCAG
        'Storm Sorcery',
        // XGE
        'Divine Soul', 'Shadow Magic',
        // EGW
        'Aberrant Mind', 'Clockwork Soul',
        // TCE (same as EGW in final)
        'Lunar Sorcery',
        // Other
        'Phoenix Sorcery', 'Sea Sorcery', 'Stone Sorcery', 'Pyromancer', 'Giant Soul'
    ],
    Warlock: [
        // PHB
        'The Archfey', 'The Fiend', 'The Great Old One',
        // SCAG
        'The Undying',
        // XGE
        'The Celestial', 'The Hexblade',
        // TCE
        'The Fathomless', 'The Genie',
        // VRGtR
        'The Undead',
        // Other
        'The Seeker', 'The Raven Queen', 'The Ghost in the Machine', 'The Lurker in the Deep'
    ],
    Artificer: [
        // TCE
        'Alchemist', 'Armorer', 'Artillerist', 'Battle Smith',
        // Other
        'Maverick', 'Cannnoneer'
    ],
    custom: []
};

function psUpdateSubclasses() {
    var cls = document.getElementById('psClass').value;
    var sub = document.getElementById('psSubclass');
    var customClassField = document.getElementById('psCustomClassField');
    if (!sub) return;
    if (cls === 'custom') {
        customClassField.style.display = '';
        sub.innerHTML = '<option value="">None</option><option value="custom">✦ Custom Subclass...</option>';
        return;
    }
    customClassField.style.display = 'none';
    var subs = PS_SUBCLASSES[cls] || [];
    sub.innerHTML = '<option value="">None</option>'
        + subs.map(function(s){ return '<option value="'+s+'">'+s+'</option>'; }).join('')
        + '<option value="custom">✦ Custom Subclass...</option>';
}

function psCheckCustomSubclass() {
    var val = document.getElementById('psSubclass').value;
    var f = document.getElementById('psCustomSubclassField');
    if (f) f.style.display = val === 'custom' ? '' : 'none';
}

function psCheckCustomRace() {
    var val = document.getElementById('psRace').value;
    var f1 = document.getElementById('psCustomRaceField');
    var f2 = document.getElementById('psCustomRaceDetailsField');
    if (f1) f1.style.display = val === 'custom' ? '' : 'none';
    if (f2) f2.style.display = val === 'custom' ? '' : 'none';
}

function psRenderSpellSlots(p) {
    var grid = document.getElementById('psSpellSlotGrid');
    var preview = document.getElementById('psKnownSpellsPreview');
    if (!grid) return;
    var slots = (p && p.spellSlots) ? p.spellSlots : null;
    var hasSlots = slots && typeof slots === 'object' && Object.keys(slots).some(function(k){ return (slots[k].max||0)>0; });
    if (!hasSlots) { grid.innerHTML = ''; if (preview) preview.innerHTML = ''; return; }
    var ordinals = ['1st','2nd','3rd','4th','5th','6th','7th','8th','9th'];
    grid.innerHTML = ordinals.map(function(ord,i) {
        var lvl = i+1;
        var s = (slots && slots[lvl]) || {curr:0,max:0};
        if (!s.max) return '';
        var col = s.curr <= 0 ? '#e74c3c' : s.curr < s.max ? '#e67e22' : '#27ae60';
        return '<div style="background:rgba(52,152,219,0.08);border:1px solid rgba(52,152,219,0.25);border-radius:5px;padding:5px 8px;text-align:center;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.65em;color:#3498db;font-weight:700;margin-bottom:3px;">' + ord + '</div>'
            + '<div style="font-size:0.82em;font-weight:700;color:' + col + ';">' + s.curr + '/' + s.max + '</div>'
            + '</div>';
    }).filter(Boolean).join('');
    if (preview) {
        var spells = p.knownSpells || [];
        preview.innerHTML = spells.length ? spells.slice(0,8).map(function(sp){
            return '<span style="background:rgba(52,152,219,0.15);border:1px solid rgba(52,152,219,0.3);border-radius:8px;padding:2px 8px;font-size:0.72em;color:#a0d0ff;">' + sp.name + '</span>';
        }).join('') + (spells.length>8?'<span style="font-size:0.72em;color:rgba(255,255,255,0.3);margin-left:4px;">+' + (spells.length-8) + ' more</span>':'') : '';
    }
}

/* ══════════════════════════════════════════════════════════════
   SPELL MANAGER MODAL
   ══════════════════════════════════════════════════════════════ */
/* Spell table: class → spells array with {name,level,school,type,range,desc} */
var SPM_SPELL_DB = {
    Wizard:   [{name:'Fire Bolt',level:0,school:'Evocation',type:'Damage',range:'120ft',desc:'Ranged spell attack: 1d10 fire damage. Cantrip.'},{name:'Mage Hand',level:0,school:'Conjuration',type:'Utility',range:'30ft',desc:'Spectral hand, manipulate objects for 1 min. Cantrip.'},{name:'Prestidigitation',level:0,school:'Transmutation',type:'Utility',range:'10ft',desc:'Minor magical tricks for 1 hr. Cantrip.'},{name:'Shocking Grasp',level:0,school:'Evocation',type:'Damage',range:'Touch',desc:'Melee spell attack: 1d8 lightning, target can\'t take reactions until next turn. Cantrip.'},{name:'Magic Missile',level:1,school:'Evocation',type:'Damage',range:'120ft',desc:'3 darts each dealing 1d4+1 force damage. Auto-hits.'},{name:'Shield',level:1,school:'Abjuration',type:'Defense',range:'Self',desc:'+5 AC until start of next turn as reaction. Blocks Magic Missile.'},{name:'Burning Hands',level:1,school:'Evocation',type:'Damage',range:'Self (15ft cone)',desc:'3d6 fire damage in cone, DEX save for half.'},{name:'Detect Magic',level:1,school:'Divination',type:'Utility',range:'Self (30ft)',desc:'Sense magic within 30ft for 10 min. Concentration.'},{name:'Identify',level:1,school:'Divination',type:'Utility',range:'Touch',desc:'Learn properties of magic item or ongoing spell.'},{name:'Misty Step',level:2,school:'Conjuration',type:'Movement',range:'Self',desc:'Teleport up to 30ft to visible unoccupied space. Bonus action.'},{name:'Mirror Image',level:2,school:'Illusion',type:'Defense',range:'Self',desc:'3 illusory duplicates; each can absorb an attack.'},{name:'Scorching Ray',level:2,school:'Evocation',type:'Damage',range:'120ft',desc:'3 rays; each ranged spell attack deals 2d6 fire damage.'},{name:'Fireball',level:3,school:'Evocation',type:'Damage',range:'150ft',desc:'8d6 fire in 20ft radius. DEX save for half.'},{name:'Counterspell',level:3,school:'Abjuration',type:'Utility',range:'60ft',desc:'Interrupt a spell as reaction. Auto-counters spells ≤3rd; check for higher.'},{name:'Fly',level:3,school:'Transmutation',type:'Movement',range:'Touch',desc:'Flying speed 60ft for 10 min. Concentration.'},{name:'Polymorph',level:4,school:'Transmutation',type:'Control',range:'60ft',desc:'Transform creature into beast with CR ≤ target\'s level. Concentration.'},{name:'Greater Invisibility',level:4,school:'Illusion',type:'Utility',range:'Touch',desc:'Invisible even when attacking or casting for 1 min. Concentration.'},{name:'Wall of Fire',level:4,school:'Evocation',type:'Control',range:'120ft',desc:'Wall of fire; creatures entering or starting turn take 5d8 fire. Concentration.'},{name:'Animate Dead',level:3,school:'Necromancy',type:'Utility',range:'10ft',desc:'Create or control undead skeleton or zombie.'},{name:'Cone of Cold',level:5,school:'Evocation',type:'Damage',range:'Self (60ft cone)',desc:'8d8 cold damage in cone. CON save for half.'},{name:'Teleportation Circle',level:5,school:'Conjuration',type:'Utility',range:'10ft',desc:'Open a portal to a permanent teleportation circle.'},{name:'Disintegrate',level:6,school:'Transmutation',type:'Damage',range:'60ft',desc:'10d6+40 force damage. DEX save. 0HP: disintegrated.'},{name:'True Seeing',level:6,school:'Divination',type:'Utility',range:'Touch',desc:'See invisible, through illusions, into Ethereal Plane for 1 hr.'},{name:'Simulacrum',level:7,school:'Illusion',type:'Utility',range:'Touch',desc:'Create a half-HP illusion duplicate of a creature.'},{name:'Wish',level:9,school:'Conjuration',type:'Utility',range:'Self',desc:'Replicate any spell up to 8th level or alter reality itself.'}],
    Sorcerer: [{name:'Firebolt',level:0,school:'Evocation',type:'Damage',range:'120ft',desc:'Ranged spell attack: 1d10 fire damage. Cantrip.'},{name:'Chill Touch',level:0,school:'Necromancy',type:'Damage',range:'120ft',desc:'1d8 necrotic; target can\'t regain HP until next turn. Cantrip.'},{name:'Thunderclap',level:0,school:'Evocation',type:'Damage',range:'Self (5ft)',desc:'CON save or 1d6 thunder damage in 5ft around you. Cantrip.'},{name:'Chaos Bolt',level:1,school:'Evocation',type:'Damage',range:'120ft',desc:'2d8+1d6 damage; type depends on d8 roll. Can chain on matching.'},{name:'Chromatic Orb',level:1,school:'Evocation',type:'Damage',range:'90ft',desc:'Ranged spell attack: 3d8 damage; choose acid/cold/fire/lightning/poison/thunder.'},{name:'Thunderwave',level:1,school:'Evocation',type:'Damage',range:'Self (15ft cube)',desc:'CON save: 2d8 thunder + push 10ft. Success: half damage.'},{name:'Shatter',level:2,school:'Evocation',type:'Damage',range:'60ft',desc:'CON save or 3d8 thunder in 10ft sphere. Disadvantage if made of inorganic material.'},{name:'Haste',level:3,school:'Transmutation',type:'Buff',range:'30ft',desc:'+2 AC, advantage DEX saves, extra action. Concentration.'},{name:'Metamagic (Twin Spell)',level:0,school:'Special',type:'Utility',range:'Self',desc:'Spend sorcery points to target 2 creatures with a single-target spell.'}],
    Cleric:   [{name:'Sacred Flame',level:0,school:'Radiant',type:'Damage',range:'60ft',desc:'DEX save or 1d8 radiant damage. Cantrip.'},{name:'Guidance',level:0,school:'Divination',type:'Buff',range:'Touch',desc:'Concentration: +1d4 to one ability check. Cantrip.'},{name:'Toll the Dead',level:0,school:'Necromancy',type:'Damage',range:'60ft',desc:'WIS save: 1d8 necrotic (1d12 if already missing HP). Cantrip.'},{name:'Bless',level:1,school:'Enchantment',type:'Buff',range:'30ft',desc:'3 creatures: add 1d4 to attacks and saves for 1 min. Concentration.'},{name:'Cure Wounds',level:1,school:'Evocation',type:'Healing',range:'Touch',desc:'Heal 1d8 + spellcasting modifier HP. No effect on undead/constructs.'},{name:'Healing Word',level:1,school:'Evocation',type:'Healing',range:'60ft',desc:'Bonus action: heal 1d4 + modifier HP. Range 60ft.'},{name:'Guiding Bolt',level:1,school:'Evocation',type:'Damage',range:'120ft',desc:'Ranged spell attack: 4d6 radiant. Next attack on target has advantage.'},{name:'Spiritual Weapon',level:2,school:'Evocation',type:'Damage',range:'60ft',desc:'Bonus action summon weapon: 1d8 + modifier force per round.'},{name:'Prayer of Healing',level:2,school:'Evocation',type:'Healing',range:'30ft',desc:'10 min: heal up to 6 creatures 2d8 + modifier. Out of combat.'},{name:'Mass Cure Wounds',level:5,school:'Evocation',type:'Healing',range:'60ft',desc:'Heal up to 6 creatures 3d8 + modifier HP.'},{name:'Raise Dead',level:5,school:'Necromancy',type:'Utility',range:'Touch',desc:'Bring back dead creature up to 10 days. Creature loses 1 from all saving throws for 4 days.'}],
    Paladin:  [{name:'Bless',level:1,school:'Enchantment',type:'Buff',range:'30ft',desc:'3 creatures: +1d4 to attacks and saves. Concentration.'},{name:'Divine Smite',level:0,school:'Special',type:'Damage',range:'Self',desc:'Expend spell slot on hit: +2d8 radiant per slot level (max 5d8). +1d8 vs undead/fiends.'},{name:'Shield of Faith',level:1,school:'Abjuration',type:'Defense',range:'60ft',desc:'+2 AC to one creature for 10 min. Concentration.'},{name:'Wrathful Smite',level:1,school:'Evocation',type:'Damage',range:'Self',desc:'Next attack: +1d6 psychic + WIS save or frightened. Concentration.'},{name:'Branding Smite',level:2,school:'Evocation',type:'Damage',range:'Self',desc:'Next hit: +2d6 radiant, target glows (can\'t be invisible). Concentration.'},{name:'Magic Weapon',level:2,school:'Transmutation',type:'Buff',range:'Touch',desc:'Weapon becomes +1 magical for 1 hr. Concentration.'},{name:'Aura of Vitality',level:3,school:'Evocation',type:'Healing',range:'Self (30ft)',desc:'Bonus action: heal a creature 2d6 HP/round. Concentration.'},{name:'Aura of Courage',level:0,school:'Special',type:'Buff',range:'Self (10ft)',desc:'Class feature: nearby allies can\'t be frightened.'},{name:'Banishment',level:4,school:'Abjuration',type:'Control',range:'60ft',desc:'CHA save or banish creature to harmless demiplane. Concentration.'}],
    Ranger:   [{name:'Hunter\'s Mark',level:1,school:'Divination',type:'Buff',range:'90ft',desc:'Mark a creature: +1d6 damage per hit, advantage tracking. Bonus to switch. Concentration.'},{name:'Cure Wounds',level:1,school:'Evocation',type:'Healing',range:'Touch',desc:'Heal 1d8 + modifier HP.'},{name:'Speak with Animals',level:1,school:'Divination',type:'Utility',range:'Self',desc:'Communicate with beasts for 10 min.'},{name:'Pass Without Trace',level:2,school:'Abjuration',type:'Utility',range:'Self',desc:'+10 to Stealth checks, can\'t be tracked by non-magical means for 1 hr. Concentration.'},{name:'Spike Growth',level:2,school:'Transmutation',type:'Control',range:'150ft',desc:'20ft of ground becomes spiked; 2d4 piercing per 5ft movement. Concentration.'},{name:'Lightning Arrow',level:3,school:'Transmutation',type:'Damage',range:'Self',desc:'Next ranged attack: 4d8 lightning + 2d8 in 10ft splash. DEX save half splash.'}],
    Druid:    [{name:'Shillelagh',level:0,school:'Transmutation',type:'Damage',range:'Touch',desc:'Use WIS for melee attacks with club/quarterstaff: 1d8 + WIS. Cantrip.'},{name:'Thorn Whip',level:0,school:'Transmutation',type:'Damage',range:'30ft',desc:'Melee spell attack: 1d6 piercing + pull target 10ft. Cantrip.'},{name:'Healing Word',level:1,school:'Evocation',type:'Healing',range:'60ft',desc:'Bonus action: heal 1d4 + modifier HP.'},{name:'Entangle',level:1,school:'Conjuration',type:'Control',range:'90ft',desc:'Plants restrain creatures in 20ft for 1 min. STR save. Concentration.'},{name:'Moonbeam',level:2,school:'Evocation',type:'Damage',range:'120ft',desc:'5ft cylinder deals 2d10 radiant on entering/starting turn. CON save half. Concentration.'},{name:'Call Lightning',level:3,school:'Conjuration',type:'Damage',range:'120ft',desc:'Bonus action: 3d10 lightning bolt each round. Concentration.'},{name:'Polymorph',level:4,school:'Transmutation',type:'Control',range:'60ft',desc:'Transform creature into beast. Concentration.'},{name:'Wall of Thorns',level:6,school:'Conjuration',type:'Control',range:'120ft',desc:'Thorn wall: 7d8 piercing on contact or forcing through. Concentration.'}],
    Warlock:  [{name:'Eldritch Blast',level:0,school:'Evocation',type:'Damage',range:'120ft',desc:'1d10 force per beam (2 beams at 5th, 3 at 11th, 4 at 17th). Cantrip.'},{name:'Hex',level:1,school:'Enchantment',type:'Buff',range:'90ft',desc:'+1d6 necrotic per hit on hexed creature. Also disadvantage on one ability. Concentration.'},{name:'Arms of Hadar',level:1,school:'Conjuration',type:'Control',range:'Self (10ft)',desc:'STR save or 2d6 necrotic + no reactions until next turn.'},{name:'Hunger of Hadar',level:3,school:'Conjuration',type:'Control',range:'150ft',desc:'20ft sphere: blinds, 2d6 cold on start, 2d6 acid on end. Concentration.'},{name:'Misty Step',level:2,school:'Conjuration',type:'Movement',range:'Self',desc:'Bonus action teleport up to 30ft.'},{name:'Banishment',level:4,school:'Abjuration',type:'Control',range:'60ft',desc:'CHA save or banish creature. Concentration.'},{name:'Summon Shadowspawn',level:3,school:'Conjuration',type:'Summoning',range:'90ft',desc:'Summon a shadow spirit for 1 hr. Concentration.'}],
    Bard:     [{name:'Vicious Mockery',level:0,school:'Enchantment',type:'Damage',range:'60ft',desc:'WIS save: 1d4 psychic + disadvantage on next attack. Cantrip.'},{name:'Minor Illusion',level:0,school:'Illusion',type:'Utility',range:'30ft',desc:'Sound or small image for 1 min. Can\'t duplicate voices. Cantrip.'},{name:'Bardic Inspiration',level:0,school:'Special',type:'Buff',range:'60ft',desc:'Give creature a Bardic Inspiration die (d6–d12 based on level). Use on attack/check/save.'},{name:'Healing Word',level:1,school:'Evocation',type:'Healing',range:'60ft',desc:'Bonus action: heal 1d4 + modifier HP.'},{name:'Dissonant Whispers',level:1,school:'Enchantment',type:'Damage',range:'60ft',desc:'WIS save: 3d6 psychic + move away using reaction. Success: half damage.'},{name:'Hypnotic Pattern',level:3,school:'Illusion',type:'Control',range:'120ft',desc:'WIS save or incapacitated until damaged. Concentration.'},{name:'Polymorph',level:4,school:'Transmutation',type:'Control',range:'60ft',desc:'Transform creature into beast. Concentration.'},{name:'Mass Cure Wounds',level:5,school:'Evocation',type:'Healing',range:'60ft',desc:'Heal up to 6 creatures 3d8 + modifier.'}],
    Barbarian:[{name:'Rage',level:0,school:'Special',type:'Buff',range:'Self',desc:'Bonus action: resistance to bludg/piercing/slashing, +2 dmg on STR attacks, advantage STR checks/saves for 1 min.'},{name:'Reckless Attack',level:0,school:'Special',type:'Buff',range:'Self',desc:'Advantage on first STR attack this turn; attacks against you have advantage until next turn.'}],
    Fighter:  [{name:'Action Surge',level:0,school:'Special',type:'Buff',range:'Self',desc:'Take one additional action this turn. Short rest recharge.'},{name:'Second Wind',level:0,school:'Special',type:'Healing',range:'Self',desc:'Bonus action: regain 1d10 + fighter level HP. Short rest recharge.'},{name:'Battle Master: Trip Attack',level:0,school:'Special',type:'Control',range:'Self',desc:'Expend superiority die: add to dmg + STR save or prone.'}],
    Rogue:    [{name:'Sneak Attack',level:0,school:'Special',type:'Damage',range:'Self',desc:'Once per turn: +1d6/2 rogue levels damage if advantage on attack or ally adjacent to target.'},{name:'Cunning Action',level:0,school:'Special',type:'Utility',range:'Self',desc:'Bonus action: Dash, Disengage, or Hide.'},{name:'Uncanny Dodge',level:0,school:'Special',type:'Defense',range:'Self',desc:'Reaction: halve damage from one attack you can see.'}],
    Monk:     [{name:'Flurry of Blows',level:0,school:'Special',type:'Damage',range:'Self',desc:'Spend 1 ki: 2 additional unarmed strikes as bonus action.'},{name:'Patient Defense',level:0,school:'Special',type:'Defense',range:'Self',desc:'Spend 1 ki: Dodge as bonus action.'},{name:'Step of the Wind',level:0,school:'Special',type:'Movement',range:'Self',desc:'Spend 1 ki: Disengage or Dash as bonus action + jump distance doubled.'}],
    Artificer:[{name:'Artificer Infusions',level:0,school:'Special',type:'Utility',range:'Touch',desc:'Infuse magic into mundane items. Number increases with level.'},{name:'Thunderwave',level:1,school:'Evocation',type:'Damage',range:'Self (15ft cube)',desc:'CON save: 2d8 thunder + push 10ft.'},{name:'Cure Wounds',level:1,school:'Evocation',type:'Healing',range:'Touch',desc:'Heal 1d8 + modifier.'},{name:'Faerie Fire',level:1,school:'Evocation',type:'Utility',range:'60ft',desc:'Outline creatures in area: attacks against them have advantage.'},{name:'Enlarge/Reduce',level:2,school:'Transmutation',type:'Control',range:'30ft',desc:'Double or halve creature size. Concentration.'}]
};

var _spmCurrentPlayer = null;

function openSpellManager() {
var pid = document.getElementById('psId') ? document.getElementById('psId').value : null;
var p = pid ? _party.find(function(m){ return m.id === pid; }) : null;
_spmCurrentPlayer = p;

var m = document.getElementById('spellManagerModal');
if (m) m.style.zIndex = '99500';

/* Populate from player */
var cls = (p && p.cls) ? p.cls : 'Wizard';
var race = (p && p.race) ? p.race : 'Human';
var lvl = (p && p.level) ? p.level : 1;
    var lvlEl = document.getElementById('spmLevel');
    if (lvlEl) lvlEl.value = lvl;

    /* Populate subclass */
    if (p && p.subclass) {
        var sub = document.getElementById('spmSubclass');
        if (sub) { setTimeout(function(){ sub.value = p.subclass; }, 50); }
    }

    /* Spell slots */
    var slots = (p && p.spellSlots && typeof p.spellSlots === 'object') ? p.spellSlots : {};
    for (var i=1; i<=9; i++) {
        var sc = document.getElementById('spmSlot'+i+'c');
        var sm = document.getElementById('spmSlot'+i+'m');
        if (sc) sc.value = (slots[i]||{}).curr || 0;
        if (sm) sm.value = (slots[i]||{}).max  || 0;
    }

    /* Known spells */
    window._spmKnownSpells = (p && p.knownSpells) ? JSON.parse(JSON.stringify(p.knownSpells)) : [];
    spmRenderKnown();
    spmUpdateSpellList();

    document.getElementById('spellManagerModal').classList.add('active');
}

function closeSpellManager() {
    document.getElementById('spellManagerModal').classList.remove('active');
}

function spmUpdateSubclasses() {
    var cls  = (document.getElementById('spmClass')||{}).value || 'Wizard';
    var sub  = document.getElementById('spmSubclass');
    var ccf  = document.getElementById('spmCustomClassField');
    if (!sub) return;
    if (cls === 'custom') { if(ccf) ccf.style.display=''; sub.innerHTML='<option value="">None</option><option value="custom">✦ Custom...</option>'; return; }
    if(ccf) ccf.style.display='none';
    var subs = PS_SUBCLASSES[cls] || [];
    sub.innerHTML = '<option value="">None</option>' + subs.map(function(s){ return '<option>'+s+'</option>'; }).join('') + '<option value="custom">✦ Custom...</option>';
}

function spmCheckCustomSubclass() {
    var val = (document.getElementById('spmSubclass')||{}).value;
    var f = document.getElementById('spmCustomSubclassField');
    if (f) f.style.display = val === 'custom' ? '' : 'none';
}

function spmCheckCustomRace() {
    var val = (document.getElementById('spmRace')||{}).value;
    var f1 = document.getElementById('spmCustomRaceField');
    var f2 = document.getElementById('spmCustomRaceDetailsField');
    if (f1) f1.style.display = val==='custom'?'':'none';
    if (f2) f2.style.display = val==='custom'?'':'none';
}

function spmUpdateSpellList() {
    var cls = (document.getElementById('spmClass')||{}).value || 'Wizard';
    spmFilterSpells();
}

function spmFilterSpells() {
    var cls    = (document.getElementById('spmClass')||{}).value || 'Wizard';
    var search = ((document.getElementById('spmSpellSearch')||{}).value||'').toLowerCase();
    var lvlFil = (document.getElementById('spmSpellFilter')||{}).value;
    var allSpells = (SPM_SPELL_DB[cls] || []).concat(window._spmCustomSpells||[]);
    /* Also include custom user spells not tied to class */
    var filtered = allSpells.filter(function(sp) {
        var matchSearch = !search || sp.name.toLowerCase().includes(search) || (sp.school||'').toLowerCase().includes(search) || (sp.desc||'').toLowerCase().includes(search);
        var matchLevel  = lvlFil === '' ? true : (String(sp.level) === String(lvlFil));
        return matchSearch && matchLevel;
    });
    var el = document.getElementById('spmSpellList');
    if (!el) return;
    if (!filtered.length) { el.innerHTML='<div style="padding:14px;text-align:center;color:rgba(255,255,255,0.3);font-size:0.85em;">No spells found.</div>'; return; }
    var known = window._spmKnownSpells || [];
    var levelColors = {0:'#95a5a6',1:'#27ae60',2:'#2980b9',3:'#8e44ad',4:'#c0392b',5:'#e67e22',6:'#e74c3c',7:'#9b59b6',8:'#1abc9c',9:'#f39c12'};
    el.innerHTML = filtered.map(function(sp) {
        var isKnown = known.some(function(k){ return k.name === sp.name; });
        var lvlLabel = sp.level === 0 ? 'Cantrip' : sp.level+'th';
        return '<div class="spm-spell-item' + (isKnown?' selected':'') + '" onclick="spmToggleSpell(' + JSON.stringify(sp).replace(/"/g,'&quot;') + ')">'
            + '<div><div class="spm-spell-name">' + sp.name + '</div>'
            + '<div class="spm-spell-meta">' + sp.school + ' · ' + sp.range + ' · ' + sp.type + '</div>'
            + '<div class="spm-spell-meta" style="margin-top:2px;opacity:0.6;">' + (sp.desc||'').substring(0,80) + (sp.desc&&sp.desc.length>80?'…':'') + '</div></div>'
            + '<span class="spm-spell-badge" style="background:' + (levelColors[sp.level]||'#555') + ';color:white;">' + lvlLabel + '</span>'
            + '</div>';
    }).join('');
}

function spmToggleSpell(sp) {
    if (!window._spmKnownSpells) window._spmKnownSpells = [];
    var idx = window._spmKnownSpells.findIndex(function(k){ return k.name === sp.name; });
    if (idx >= 0) window._spmKnownSpells.splice(idx, 1);
    else window._spmKnownSpells.push(sp);
    spmRenderKnown();
    spmFilterSpells(); /* refresh highlight */
}

function spmRenderKnown() {
    var el = document.getElementById('spmKnownSpells');
    var cnt = document.getElementById('spmKnownCount');
    if (!el) return;
    var spells = window._spmKnownSpells || [];
    if (cnt) cnt.textContent = '(' + spells.length + ' spell' + (spells.length!==1?'s':'') + ')';
    if (!spells.length) { el.innerHTML='<div style="color:rgba(255,255,255,0.25);font-size:0.82em;font-style:italic;">No spells added yet.</div>'; return; }
    el.innerHTML = spells.map(function(sp) {
        return '<span class="spm-known-spell-tag">' + sp.name + ' <button onclick="spmRemoveSpell(\'' + sp.name.replace(/'/g,'\\\'') + '\')">×</button></span>';
    }).join('');
}

function spmRemoveSpell(name) {
    if (!window._spmKnownSpells) return;
    window._spmKnownSpells = window._spmKnownSpells.filter(function(k){ return k.name !== name; });
    spmRenderKnown();
    spmFilterSpells();
}

function spmAddCustomSpell() {
    var name   = prompt('Spell name?');
    if (!name) return;
    var levelStr = prompt('Spell level? (0 = cantrip, 1-9)','0');
    var level  = parseInt(levelStr)||0;
    var school = prompt('School of magic? (e.g. Evocation, Necromancy)', 'Custom');
    var type   = prompt('Type? (Damage/Healing/Utility/Buff/Control/Defense/Movement)','Utility');
    var range  = prompt('Range?','60ft');
    var desc   = prompt('Short description?','');
    if (!window._spmCustomSpells) window._spmCustomSpells = [];
    window._spmCustomSpells.push({name:name,level:level,school:school||'Custom',type:type||'Utility',range:range||'60ft',desc:desc||''});
    spmFilterSpells();
    showToast('Custom spell "' + name + '" added to list!', 'success');
}

/* Auto-fill slot maximums based on class/level (5e PHB table) */
function spmAutoFillSlots() {
    var cls = (document.getElementById('spmClass')||{}).value || '';
    var lvl = parseInt((document.getElementById('spmLevel')||{}).value)||1;
    /* Non-casters */
    var noCaster = ['Barbarian','Fighter','Rogue','Monk'];
    /* Half-casters (Paladin, Ranger, Artificer) */
    var halfCaster = ['Paladin','Ranger','Artificer'];
    /* Warlock (pact magic: fewer slots, all same level) */
    var isWarlock = cls === 'Warlock';

    /* Full caster slot table (indexed by level 1-20) */
    var fullTable = [
        [2,0,0,0,0,0,0,0,0], /* 1 */
        [3,0,0,0,0,0,0,0,0], /* 2 */
        [4,2,0,0,0,0,0,0,0], /* 3 */
        [4,3,0,0,0,0,0,0,0], /* 4 */
        [4,3,2,0,0,0,0,0,0], /* 5 */
        [4,3,3,0,0,0,0,0,0], /* 6 */
        [4,3,3,1,0,0,0,0,0], /* 7 */
        [4,3,3,2,0,0,0,0,0], /* 8 */
        [4,3,3,3,1,0,0,0,0], /* 9 */
        [4,3,3,3,2,0,0,0,0], /* 10 */
        [4,3,3,3,2,1,0,0,0], /* 11 */
        [4,3,3,3,2,1,0,0,0], /* 12 */
        [4,3,3,3,2,1,1,0,0], /* 13 */
        [4,3,3,3,2,1,1,0,0], /* 14 */
        [4,3,3,3,2,1,1,1,0], /* 15 */
        [4,3,3,3,2,1,1,1,0], /* 16 */
        [4,3,3,3,2,1,1,1,1], /* 17 */
        [4,3,3,3,3,1,1,1,1], /* 18 */
        [4,3,3,3,3,2,1,1,1], /* 19 */
        [4,3,3,3,3,2,2,1,1]  /* 20 */
    ];
    var halfTable = [ /* half-casters start at level 2 effectively */
        [0,0,0,0,0,0,0,0,0], /* 1 */
        [2,0,0,0,0,0,0,0,0], /* 2 */
        [3,0,0,0,0,0,0,0,0], /* 3 */
        [3,0,0,0,0,0,0,0,0], /* 4 */
        [4,2,0,0,0,0,0,0,0], /* 5 */
        [4,2,0,0,0,0,0,0,0], /* 6 */
        [4,3,0,0,0,0,0,0,0], /* 7 */
        [4,3,0,0,0,0,0,0,0], /* 8 */
        [4,3,2,0,0,0,0,0,0], /* 9 */
        [4,3,2,0,0,0,0,0,0], /* 10 */
        [4,3,3,0,0,0,0,0,0], /* 11 */
        [4,3,3,0,0,0,0,0,0], /* 12 */
        [4,3,3,1,0,0,0,0,0], /* 13 */
        [4,3,3,1,0,0,0,0,0], /* 14 */
        [4,3,3,2,0,0,0,0,0], /* 15 */
        [4,3,3,2,0,0,0,0,0], /* 16 */
        [4,3,3,3,1,0,0,0,0], /* 17 */
        [4,3,3,3,1,0,0,0,0], /* 18 */
        [4,3,3,3,2,0,0,0,0], /* 19 */
        [4,3,3,3,2,0,0,0,0]  /* 20 */
    ];
    /* Warlock pact magic */
    var warlockTable = [
        [1,0,0,0,0,0,0,0,0],[2,0,0,0,0,0,0,0,0],[0,2,0,0,0,0,0,0,0],[0,2,0,0,0,0,0,0,0],
        [0,0,2,0,0,0,0,0,0],[0,0,2,0,0,0,0,0,0],[0,0,0,2,0,0,0,0,0],[0,0,0,2,0,0,0,0,0],
        [0,0,0,0,2,0,0,0,0],[0,0,0,0,2,0,0,0,0],[0,0,0,0,3,0,0,0,0],[0,0,0,0,3,0,0,0,0],
        [0,0,0,0,3,0,0,0,0],[0,0,0,0,3,0,0,0,0],[0,0,0,0,3,0,0,0,0],[0,0,0,0,3,0,0,0,0],
        [0,0,0,0,4,0,0,0,0],[0,0,0,0,4,0,0,0,0],[0,0,0,0,4,0,0,0,0],[0,0,0,0,4,0,0,0,0]
    ];

    var table;
    if (noCaster.includes(cls)) table = [[0,0,0,0,0,0,0,0,0]]; /* all zero */
    else if (isWarlock) table = warlockTable;
    else if (halfCaster.includes(cls)) table = halfTable;
    else table = fullTable;

    var idx = Math.max(0, Math.min(19, lvl-1));
    var row = table[idx] || [0,0,0,0,0,0,0,0,0];
    for (var i=1; i<=9; i++) {
        var sm = document.getElementById('spmSlot'+i+'m');
        var sc = document.getElementById('spmSlot'+i+'c');
        if (sm) sm.value = row[i-1] || 0;
        if (sc) sc.value = row[i-1] || 0;
    }
    showToast('Spell slots auto-filled for ' + cls + ' level ' + lvl, 'success');
}

function saveSpellManager() {
    var pid = document.getElementById('spmPlayerId') ? document.getElementById('spmPlayerId').value : null;
    /* Get pid from main player sheet if open */
    if (!pid) {
        var psId = document.getElementById('psId');
        if (psId) pid = psId.value;
    }
    var p = pid ? _party.find(function(m){ return m.id === pid; }) : null;

    /* Pull all values */
    var cls     = (document.getElementById('spmClass')||{}).value||'';
    var subEl   = document.getElementById('spmSubclass');
    var subClsVal = subEl ? subEl.value : '';
    if (subClsVal === 'custom') {
        var custSub = document.getElementById('spmCustomSubclass');
        subClsVal = custSub ? custSub.value : '';
    }
    var raceEl  = document.getElementById('spmRace');
    var raceVal = raceEl ? raceEl.value : '';
    if (raceVal === 'custom') {
        var custRace = document.getElementById('spmCustomRace');
        raceVal = custRace ? custRace.value : raceVal;
    }
    var lvl = parseInt((document.getElementById('spmLevel')||{}).value)||1;

    /* Build spell slots object */
    var slots = {};
    for (var i=1; i<=9; i++) {
        var scEl = document.getElementById('spmSlot'+i+'c');
        var smEl = document.getElementById('spmSlot'+i+'m');
        var max  = smEl ? (parseInt(smEl.value)||0) : 0;
        var curr = scEl ? (parseInt(scEl.value)||0) : 0;
        if (max > 0) slots[i] = { curr: curr, max: max };
    }

    /* Save to player sheet fields if open */
    var psClsEl = document.getElementById('psClass');
    var psRaceEl = document.getElementById('psRace');
    var psLvlEl  = document.getElementById('psLevel');
    if (psClsEl && cls && cls !== 'custom') psClsEl.value = cls;
    if (psRaceEl && raceVal && raceVal !== 'custom') psRaceEl.value = raceVal;
    if (psLvlEl) psLvlEl.value = lvl;

    /* If player exists, update directly */
    if (p) {
        if (cls && cls !== 'custom') p.cls = cls;
        p.subclass    = subClsVal;
        if (raceVal && raceVal !== 'custom') p.race = raceVal;
        if (raceVal === 'custom') {
            var custRaceDetails = document.getElementById('spmCustomRaceDetails');
            p.customRaceDetails = custRaceDetails ? custRaceDetails.value : '';
        }
        p.level       = lvl;
        p.spellSlots  = slots;
        p.knownSpells = window._spmKnownSpells || [];
        _saveParty();
        renderPartyTracker();
        /* Refresh spell slot preview on player sheet */
        psRenderSpellSlots(p);
    }

    closeSpellManager();
    showToast('Spells saved!', 'success');
    _clLog('Spell list updated for ' + (p ? p.name : 'player'));
}

/* ══════════════════════════════════════════════════════════════
   CHANGELOG SYSTEM
   Auto-tracks changes; user can view via bottom-right panel
   ══════════════════════════════════════════════════════════════ */
var _changelog = [];
try { _changelog = JSON.parse(localStorage.getItem('dm_changelog') || '[]'); } catch(e){}

function _clLog(msg) {
    var entry = {
        ts: new Date().toLocaleTimeString(),
        date: new Date().toLocaleDateString(),
        msg: msg
    };
    _changelog.unshift(entry);
    if (_changelog.length > 50) _changelog = _changelog.slice(0, 50);
    try { localStorage.setItem('dm_changelog', JSON.stringify(_changelog)); } catch(e){}
    _renderChangelog();
    /* Flash button */
    var btn = document.getElementById('changelogToggleBtn');
    if (btn) {
        btn.style.color = 'var(--gold)';
        btn.style.borderColor = 'rgba(184,134,11,0.7)';
        setTimeout(function(){ btn.style.color=''; btn.style.borderColor=''; }, 1500);
    }
}

function _renderChangelog() {
    var el = document.getElementById('changelogEntries');
    if (!el) return;
    if (!_changelog.length) { el.innerHTML='<div style="color:rgba(184,134,11,0.35);font-size:0.8em;text-align:center;padding:8px;">No changes logged yet.</div>'; return; }
    el.innerHTML = _changelog.slice(0,30).map(function(e) {
        return '<div class="cl-entry"><div class="cl-date">' + e.date + ' · ' + e.ts + '</div><div class="cl-text">' + e.msg + '</div></div>';
    }).join('');
}

function toggleChangelog() {
    var body = document.getElementById('changelogBody');
    if (!body) return;
    var open = body.style.display !== 'none' && body.style.display !== '';
    body.style.display = open ? 'none' : 'block';
    if (!open) _renderChangelog();
}

/* Patch core actions to auto-log */
(function() {
    /* Patch savePlayerSheet */
    var _origSPS = window.savePlayerSheet;
    if (_origSPS) window.savePlayerSheet = function() {
        _origSPS.apply(this, arguments);
        var nm = (document.getElementById('psName')||{}).value||'Player';
        _clLog('Player character saved: ' + nm);
    };

    /* Patch addPartyMember */
    var _origAPM = window.addPartyMember;
    if (_origAPM) window.addPartyMember = function() {
        _origAPM.apply(this, arguments);
        _clLog('New party member added');
    };

    /* Patch generateBatch (NPC generation) */
    var _origGB  = window.generateBatch;
    if (_origGB) window.generateBatch = function() {
        _origGB.apply(this, arguments);
        _clLog('NPCs generated');
    };

    /* Patch generateFullQuest */
    var _origGFQ = window.generateFullQuest;
    if (_origGFQ) window.generateFullQuest = function() {
        var typeEl = document.getElementById('questType');
        var type = typeEl ? typeEl.value : 'quest';
        _origGFQ.apply(this, arguments);
        _clLog('Quest generated (type: ' + (type||'random') + ')');
    };

    /* Patch npcDropdownSaveQuest */
    var _origDSQ = window.npcDropdownSaveQuest;
    if (_origDSQ) window.npcDropdownSaveQuest = function() {
        _origDSQ.apply(this, arguments);
        _clLog('Quest saved to library');
    };

    /* Patch csCreateNewCampaignAndLaunch */
    var _origCNC = window.csCreateNewCampaignAndLaunch;
    if (_origCNC) window.csCreateNewCampaignAndLaunch = function() {
        var nm = (document.getElementById('csNewCampaignName')||{}).value||'Unnamed';
        _origCNC.apply(this, arguments);
        _clLog('New campaign started: ' + nm);
    };
})();

/* ══════════════════════════════════════════════════════════════
   HEADER PARTY HEALTH — always visible next to Players button
   ══════════════════════════════════════════════════════════════ */
function renderHeaderPartyHealth() {
    var el = document.getElementById('headerPartyHealth');
    if (!el) return;
    if (!_party || !_party.length) {
        el.innerHTML = '';
        el.style.display = 'none';
        return;
    }
    el.style.display = 'flex';
    el.innerHTML = _party.map(function(p) {
        var pct = Math.max(0, Math.min(100, Math.round(((p.hpCurr||0) / (p.hpMax||1)) * 100)));
        var healthClass = pct <= 25 ? 'health-critical' : pct <= 50 ? 'health-low' : 'health-good';
        var ac = p.ac || 10;
        return '<div class="player-health-tab ' + healthClass + '" onclick="openPlayerSheet(\'' + (p.id||'') + '\')" title="Click to edit ' + (p.name||'Player') + '">'
            + '<div class="player-name">' + (p.name||'Unknown') + ' <span style="opacity:0.72;">· AC ' + ac + '</span></div>'
            + '<div class="health-bar-container">'
            + '<div class="health-bar-fill" style="width:' + pct + '%;"></div>'
            + '</div>'
            + '<div class="health-text" onclick="event.stopPropagation()" style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;">'
            + '<span>' + (p.hpCurr||0) + '/' + (p.hpMax||0) + ' HP</span>'
            + '<span style="display:flex;gap:2px;"><button type="button" onclick="event.stopPropagation();quickHP(\'' + (p.id||'') + '\',-1);renderHeaderPartyHealth();" class="party-hp-btn minus" style="width:22px;height:22px;padding:0;font-size:1em;line-height:1;border-radius:3px;border:none;cursor:pointer;background:#8b0000;color:white;font-weight:700;">−</button>'
            + '<button type="button" onclick="event.stopPropagation();quickHP(\'' + (p.id||'') + '\',1);renderHeaderPartyHealth();" class="party-hp-btn plus" style="width:22px;height:22px;padding:0;font-size:1em;line-height:1;border-radius:3px;border:none;cursor:pointer;background:#27ae60;color:white;font-weight:700;">+</button></span>'
            + '</div>'
            + '</div>';
    }).join('');
}

/* Patch all party-changing functions to also refresh header health */
(function() {
    var _origRPT = window.renderPartyTracker;
    if (_origRPT) {
        window.renderPartyTracker = function() {
            _origRPT.apply(this, arguments);
            setTimeout(renderHeaderPartyHealth, 60);
        };
    }
    /* Also patch quickHP for instant header update */
    var _origQHP2 = window.quickHP;
    if (_origQHP2) {
        window.quickHP = function(pid, dir) {
            _origQHP2.apply(this, arguments);
            setTimeout(renderHeaderPartyHealth, 40);
        };
    }
})();

/* Initialize header health on app launch */
(function() {
    var _origLaunch = window._launchApp;
    window._launchApp = function(startMode) {
        if (_origLaunch) _origLaunch.apply(this, arguments);
        setTimeout(renderHeaderPartyHealth, 500);
    };
})();

/* ══════════════════════════════════════════════════════════════
   MAIN MENU — original function fully handles all restoration above
   ══════════════════════════════════════════════════════════════ */


(function() {
    var _origOPS = window.openPlayerSheet;
    if (_origOPS) window.openPlayerSheet = function(pid) {
        _origOPS.apply(this, arguments);
        /* Additional fields */
        var p = _party.find(function(m){ return m.id === pid; });
        /* Subclass */
        var subEl = document.getElementById('psSubclass');
        if (subEl && p && p.cls) {
            psUpdateSubclasses();
            setTimeout(function(){
                if (p.subclass) subEl.value = p.subclass;
            }, 30);
        }
        /* Custom race */
        if (p && p.race) {
            var raceEl = document.getElementById('psRace');
            if (raceEl) {
                /* Check if value exists in select */
                var opts = Array.from(raceEl.options).map(function(o){ return o.value; });
                if (!opts.includes(p.race) && p.race) {
                    raceEl.value = 'custom';
                    var custField = document.getElementById('psCustomRaceField');
                    var custInput = document.getElementById('psCustomRace');
                    if (custField) custField.style.display = '';
                    if (custInput) custInput.value = p.race;
                    var detailsField = document.getElementById('psCustomRaceDetailsField');
                    var detailsInput = document.getElementById('psCustomRaceDetails');
                    if (detailsField) detailsField.style.display = '';
                    if (detailsInput) detailsInput.value = p.customRaceDetails || '';
                }
            }
        }
        /* Render spell slots */
        psRenderSpellSlots(p);
        /* Set spmPlayerId */
        var spmPid = document.getElementById('spmPlayerId');
        if (spmPid) spmPid.value = pid;
    };
})();

/* Patch savePlayerSheet to save subclass & custom race */
(function() {
    var _origSPS = window.savePlayerSheet;
    if (_origSPS) window.savePlayerSheet = function() {
        /* Read extra fields before original saves */
        var pid = (document.getElementById('psId')||{}).value;
        var p   = _party.find(function(m){ return m.id === pid; });

        /* Subclass */
        var subEl = document.getElementById('psSubclass');
        var subVal = subEl ? subEl.value : '';
        if (subVal === 'custom') {
            var custSubEl = document.getElementById('psCustomSubclass');
            subVal = custSubEl ? custSubEl.value : '';
        }

        /* Custom class */
        var clsEl = document.getElementById('psClass');
        var clsVal = clsEl ? clsEl.value : '';
        var customClassVal = '';
        if (clsVal === 'custom') {
            var custClsEl = document.getElementById('psCustomClass');
            customClassVal = custClsEl ? custClsEl.value : '';
        }

        /* Custom race */
        var raceEl = document.getElementById('psRace');
        var raceVal = raceEl ? raceEl.value : '';
        var customRaceVal = '';
        var customRaceDetailsVal = '';
        if (raceVal === 'custom') {
            var custRaceEl = document.getElementById('psCustomRace');
            customRaceVal = custRaceEl ? custRaceEl.value : '';
            var custRaceDetEl = document.getElementById('psCustomRaceDetails');
            customRaceDetailsVal = custRaceDetEl ? custRaceDetEl.value : '';
        }

        /* Run original */
        _origSPS.apply(this, arguments);

        /* Now apply extra fields */
        var p2 = _party.find(function(m){ return m.id === pid; });
        if (p2) {
            p2.subclass = subVal;
            if (clsVal === 'custom' && customClassVal) p2.cls = customClassVal;
            if (raceVal === 'custom' && customRaceVal) { p2.race = customRaceVal; p2.customRaceDetails = customRaceDetailsVal; }
            _saveParty();
        }
    };
})();

/* ══════════════════════════════════════════════════════════════
   ACTIVE QUEST SYSTEM
   ══════════════════════════════════════════════════════════════ */
var _activeQuest = null;
try { _activeQuest = JSON.parse(localStorage.getItem('dm_active_quest') || 'null'); } catch(e){}

function _saveActiveQuest() {
    if (!window._isOneShot) try { localStorage.setItem('dm_active_quest', JSON.stringify(_activeQuest)); } catch(e){}
}

function toggleActiveQuestDropdown() {
    var dd = document.getElementById('activeQuestDropdown');
    if (!dd) return;
    var showing = dd.style.display !== 'none';
    dd.style.display = showing ? 'none' : 'block';
    if (!showing) {
        _renderActiveQuestList();
        setTimeout(function() {
            document.addEventListener('click', function _aqClose(e) {
                var btn = document.querySelector('[onclick*="toggleActiveQuestDropdown"]');
                if (!dd.contains(e.target) && !(btn && btn.contains(e.target))) {
                    dd.style.display = 'none';
                    document.removeEventListener('click', _aqClose);
                }
            });
        }, 50);
    }
}

/* Expand/collapse state stored outside _renderActiveQuestList so it persists across re-renders */
window._sqExpanded = window._sqExpanded || {};

window.sqToggle = function(qid) {
    window._sqExpanded[qid] = !window._sqExpanded[qid];
    _renderActiveQuestList();
};

window.sqSetActive = function(qid) {
    var qs = [];
    try { qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e) {}
    var q = qs.find(function(x) { return x.id === qid; });
    if (!q) return;
    _activeQuest = q;
    _saveActiveQuest();
    _renderActiveQuestList();
    _updateActiveQuestBanner();
    if (typeof showToast === 'function') showToast('\u26a1 Active quest: ' + (q.title || 'Quest'), 'success');
};

window.sqDeactivate = function() {
    _activeQuest = null;
    _saveActiveQuest();
    _renderActiveQuestList();
    _updateActiveQuestBanner();
    if (typeof showToast === 'function') showToast('Quest deactivated', 'success');
};

function _renderActiveQuestList() {
    var listEl = document.getElementById('activeQuestList');
    var indEl  = document.getElementById('activeQuestIndicator');
    if (!listEl) return;

    /* Indicator dot — only show when there IS an active quest */
    if (indEl) indEl.textContent = _activeQuest ? ' \u25cf ' : '';

    /* Load saved quests */
    var qs = [];
    try { qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e) {}

    /* Empty state — show a helpful message */
    if (!qs.length && !_activeQuest) {
        listEl.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-size:0.78em;text-align:center;padding:14px 8px;font-style:italic;line-height:1.6;">No quests saved yet.<br>Generate &amp; save a quest<br>in the Quests tab.</div>';
        return;
    }

    /* Build rows */
    var rows = qs.map(function(q) {
        var isActive   = _activeQuest && _activeQuest.id === q.id;
        var isExpanded = !!window._sqExpanded[q.id];
        var bg  = isActive ? 'rgba(0,60,160,0.35)' : 'rgba(255,255,255,0.03)';
        var bdr = isActive ? 'rgba(100,160,255,0.65)' : 'rgba(255,255,255,0.07)';
        var titleColor = isActive ? '#80c0ff' : '#fff8dc';

        /* Action button — uses global window functions so no inline string-quoting needed */
        var actionBtn = isActive
            ? '<button onclick="sqDeactivate()" style="flex-shrink:0;padding:3px 9px;background:rgba(120,0,0,0.5);color:#ffaaaa;border:1px solid rgba(220,20,60,0.6);border-radius:5px;cursor:pointer;font-family:Cinzel,serif;font-size:0.62em;font-weight:700;white-space:nowrap;">\u2715 Deactivate</button>'
            : '<button onclick="sqSetActive(\'' + q.id + '\')" style="flex-shrink:0;padding:3px 9px;background:linear-gradient(145deg,#1a3a7a,#2a5ab0);color:#d8eeff;border:1px solid rgba(100,160,255,0.6);border-radius:5px;cursor:pointer;font-family:Cinzel,serif;font-size:0.62em;font-weight:700;white-space:nowrap;">\u26a1 Set</button>';

        /* Expand toggle — title row is clickable */
        var arrow = isExpanded ? '\u25b2' : '\u25bc';
        var titleRow = '<div onclick="sqOpenQuestDetails(\'' + q.id + '\')" style="display:flex;align-items:center;gap:7px;padding:8px 10px;cursor:pointer;user-select:none;">'
            + '<div style="flex:1;min-width:0;">'
            + '<div style="font-family:Cinzel,serif;font-size:0.75em;font-weight:700;color:' + titleColor + ';white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (isActive ? '\u26a1 ' : '') + (q.title || 'Unnamed Quest') + '</div>'
            + '<div style="font-size:0.63em;color:rgba(255,255,255,0.38);margin-top:1px;">' + (q.type || 'quest') + (q.diff ? ' \u00b7 ' + q.diff : '') + ' \u00b7 ' + (q.date || '') + '</div>'
            + '</div>'
            + actionBtn
            + '<span style="color:rgba(255,255,255,0.35);font-size:0.65em;margin-left:4px;">👁</span>'
            + '</div>';

        /* Expanded content panel */
        var panel = '';
        if (isExpanded) {
            var body = q.html || '<div style="padding:12px;color:rgba(255,255,255,0.4);font-style:italic;">No content saved for this quest.</div>';
            panel = '<div style="border-top:1px solid rgba(255,255,255,0.08);max-height:300px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(100,160,255,0.3) transparent;">'
                + body + '</div>';
        }

        return '<div style="border:1px solid ' + bdr + ';background:' + bg + ';border-radius:7px;margin-bottom:5px;overflow:hidden;">'
            + titleRow + panel + '</div>';
    });

    /* Group headers */
    var mainQ   = qs.filter(function(q){ return q.isMain && !q.isBounty; });
    var otherQ  = qs.filter(function(q){ return !q.isMain && !q.isBounty; });
    var bountyQ = qs.filter(function(q){ return q.isBounty; });

    var html = '';
    if (mainQ.length) {
        html += '<div style="font-family:Cinzel,serif;font-size:0.62em;font-weight:700;color:#a060ff;text-transform:uppercase;letter-spacing:1px;padding:4px 4px 3px;margin-bottom:4px;border-bottom:1px solid rgba(160,100,255,0.25);">\ud83d\udcd6 Main Story</div>';
        html += mainQ.map(function(q){ return rows[qs.indexOf(q)]; }).join('');
    }
    if (otherQ.length) {
        html += '<div style="font-family:Cinzel,serif;font-size:0.62em;font-weight:700;color:rgba(184,134,11,0.85);text-transform:uppercase;letter-spacing:1px;padding:4px 4px 3px;margin-top:' + (mainQ.length?'8':'0') + 'px;margin-bottom:4px;border-bottom:1px solid rgba(184,134,11,0.2);">\ud83d\udcdc Other Quests</div>';
        html += otherQ.map(function(q){ return rows[qs.indexOf(q)]; }).join('');
    }
    if (bountyQ.length) {
        html += '<div style="font-family:Cinzel,serif;font-size:0.62em;font-weight:700;color:#daa520;text-transform:uppercase;letter-spacing:1px;padding:4px 4px 3px;margin-top:8px;margin-bottom:4px;border-bottom:1px solid rgba(218,165,32,0.25);">\ud83d\udccc Bounties</div>';
        html += bountyQ.map(function(q){ return rows[qs.indexOf(q)]; }).join('');
    }

    listEl.innerHTML = html;
}

function setActiveQuest(qid) { sqSetActive(qid); }

function clearActiveQuest() { sqDeactivate(); }

function _updateActiveQuestBanner() {
    var indEl = document.getElementById('activeQuestIndicator');
    if (indEl) indEl.textContent = _activeQuest ? ' \u25cf ' : '';
    /* Always show the Active Quests button — hide only hides quests with no list to show */
    var wrap = document.getElementById('activeQuestBtnWrap');
    if (wrap) wrap.style.display = 'block';
}

/* ══════════════════════════════════════════════════════════════
   ACTIVE REVENGE SYSTEM (saved revenge quests + active revenge dropdown)
   ══════════════════════════════════════════════════════════════ */
var _activeRevenge = null;
var _savedRevengeQuests = [];
try { _activeRevenge = JSON.parse(localStorage.getItem('dm_active_revenge') || 'null'); } catch(e){}
try { _savedRevengeQuests = JSON.parse(localStorage.getItem('dm_saved_revenge_quests') || '[]'); } catch(e){}

function _saveActiveRevenge() { if (window._isOneShot) return; try { localStorage.setItem('dm_active_revenge', JSON.stringify(_activeRevenge)); } catch(e){} }
function _saveSavedRevengeQuests() { if (window._isOneShot) return; try { localStorage.setItem('dm_saved_revenge_quests', JSON.stringify(_savedRevengeQuests)); } catch(e){} }

function saveRevengeQuest() {
    var data = window._currentQuestData;
    if (!data || data.type !== 'revenge') {
        if (typeof showToast === 'function') showToast('No revenge quest displayed — generate or load one first.', 'warning');
        return;
    }
    var id = 'rv_' + Date.now();
    var entry = { id: id, title: data.title || '☠ Revenge Quest', html: data.html, date: new Date().toLocaleDateString(), type: 'revenge', revengeKilledEntry: data.revengeKilledEntry || null };
    _savedRevengeQuests.unshift(entry);
    if (_savedRevengeQuests.length > 30) _savedRevengeQuests.pop();
    _saveSavedRevengeQuests();
    if (typeof _renderActiveRevengeList === 'function') _renderActiveRevengeList();
    if (typeof showToast === 'function') showToast('Revenge quest saved to Active Revenge list.', 'success');
}

function setActiveRevengeFromCurrent() {
    var data = window._currentQuestData;
    if (!data || data.type !== 'revenge') {
        if (typeof showToast === 'function') showToast('No revenge quest displayed — generate or load one first.', 'warning');
        return;
    }
    var id = 'rv_active_' + Date.now();
    _activeRevenge = { id: id, title: data.title || '☠ Revenge Quest', html: data.html, date: new Date().toLocaleDateString(), type: 'revenge', revengeKilledEntry: data.revengeKilledEntry || null };
    _saveActiveRevenge();
    _updateActiveRevengeBanner();
    if (typeof _renderActiveRevengeList === 'function') _renderActiveRevengeList();
    if (typeof showToast === 'function') showToast('Set as active revenge.', 'success');
}

function toggleActiveRevengeDropdown() {
    var dd = document.getElementById('activeRevengeDropdown');
    var btn = document.getElementById('activeRevengeTriggerBtn');
    if (!dd) return;
    if (dd.style.display !== 'none') { dd.style.display = 'none'; return; }
    dd.style.display = 'block';
    if (typeof _positionDropdownBelowBtn === 'function') _positionDropdownBelowBtn(dd, btn);
    if (typeof _renderActiveRevengeList === 'function') _renderActiveRevengeList();
    setTimeout(function() {
        document.addEventListener('click', function _arClose(e) {
            if (!dd.contains(e.target) && !(btn && btn.contains(e.target))) {
                dd.style.display = 'none';
                document.removeEventListener('click', _arClose);
            }
        });
    }, 50);
}

function _renderActiveRevengeList() {
    var listEl = document.getElementById('activeRevengeList');
    var displayEl = document.getElementById('activeRevengeCurrentDisplay');
    var clearBtn = document.getElementById('activeRevengeClearBtn');
    var indEl = document.getElementById('activeRevengeIndicator');
    if (indEl) indEl.textContent = _activeRevenge ? ' \u25cf ' : '';
    if (clearBtn) clearBtn.style.display = _activeRevenge ? 'inline-block' : 'none';
    if (displayEl) {
        displayEl.textContent = _activeRevenge ? ('☠ ' + (_activeRevenge.title || 'Revenge Quest')) : 'No active revenge set';
        displayEl.style.cursor = _activeRevenge ? 'pointer' : 'default';
        displayEl.onclick = _activeRevenge ? function() {
            var qa = document.getElementById('questArea');
            var bar = document.getElementById('questActionBar');
            if (qa) qa.innerHTML = _activeRevenge.html;
            if (bar) bar.style.display = 'flex';
            window._currentQuestData = { title: _activeRevenge.title, type: 'revenge', diff: 'hard', html: _activeRevenge.html, revengeKilledEntry: _activeRevenge.revengeKilledEntry || null };
            _showRevengeQuestUI(true);
            if (typeof showToast === 'function') showToast('Active revenge loaded into quest area.', 'success');
        } : null;
    }
    if (!listEl) return;
    if (!_savedRevengeQuests.length) {
        listEl.innerHTML = '<div style="color:rgba(255,255,255,0.35);font-size:0.78em;text-align:center;padding:14px;font-style:italic;">No saved revenge quests yet.<br>Generate a revenge quest, then use<br>💾 Save Revenge Quest or ⚡ Set as Active Revenge.</div>';
        return;
    }
    listEl.innerHTML = _savedRevengeQuests.map(function(r) {
        var isActive = _activeRevenge && _activeRevenge.id === r.id;
        var bg = isActive ? 'rgba(139,0,0,0.4)' : 'rgba(255,255,255,0.04)';
        var bdr = isActive ? 'rgba(255,150,150,0.7)' : 'rgba(255,255,255,0.08)';
        return '<div style="border:1px solid ' + bdr + ';background:' + bg + ';border-radius:6px;margin-bottom:5px;overflow:hidden;">' +
            '<div onclick="sqRevengeLoadAndSetActive(\'' + r.id.replace(/'/g, "\\'") + '\')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;user-select:none;">' +
            '<div style="flex:1;min-width:0;">' +
            '<div style="font-family:Cinzel,serif;font-size:0.75em;font-weight:700;color:#ffcccc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (isActive ? '\u25cf ' : '') + (r.title || 'Revenge Quest') + '</div>' +
            '<div style="font-size:0.63em;color:rgba(255,255,255,0.4);margin-top:2px;">' + (r.date || '') + '</div>' +
            '</div></div></div>';
    }).join('');
}

function sqRevengeLoadAndSetActive(rid) {
    var r = _savedRevengeQuests.find(function(x){ return x.id === rid; });
    if (!r) return;
    _activeRevenge = r;
    _saveActiveRevenge();
    var qa = document.getElementById('questArea');
    var bar = document.getElementById('questActionBar');
    if (qa) qa.innerHTML = r.html;
    if (bar) bar.style.display = 'flex';
    window._currentQuestData = { title: r.title, type: 'revenge', diff: 'hard', html: r.html, revengeKilledEntry: r.revengeKilledEntry || null };
    _showRevengeQuestUI(true);
    _updateActiveRevengeBanner();
    _renderActiveRevengeList();
    if (typeof showToast === 'function') showToast('Revenge quest loaded and set active.', 'success');
}

function clearActiveRevenge() {
    _activeRevenge = null;
    _saveActiveRevenge();
    _updateActiveRevengeBanner();
    if (typeof _renderActiveRevengeList === 'function') _renderActiveRevengeList();
    var dd = document.getElementById('activeRevengeDropdown');
    if (dd) dd.style.display = 'none';
    if (typeof showToast === 'function') showToast('Active revenge cleared', 'success');
}

function _updateActiveRevengeBanner() {
    var indEl = document.getElementById('activeRevengeIndicator');
    if (indEl) indEl.textContent = _activeRevenge ? ' \u25cf ' : '';
    var wrap = document.getElementById('activeRevengeBtnWrap');
    if (wrap) wrap.style.display = 'block';
}

function npcDropdownSetActiveQuest() {
    /* Set the currently generated quest as active */
    if (!_npcDropdownCurrentQuest) {
        if (typeof showToast === 'function') showToast('Generate a quest first!', 'success');
        return;
    }
    /* Save it if not already saved */
    npcDropdownSaveQuest();
    /* Small delay then set as active */
    setTimeout(function() {
        var qs = [];
        try { qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e){}
        if (qs.length) {
            _activeQuest = qs[0]; /* Most recently saved */
            _saveActiveQuest();
            _updateActiveQuestBanner();
            if (typeof showToast === 'function') showToast('Active quest set: ' + (_activeQuest.title || 'Quest'), 'success');
        }
    }, 300);
}

/* Add active quest banner below the quest generator header */
(function() {
    document.addEventListener('DOMContentLoaded', function() {
        _updateActiveQuestBanner();
        _renderActiveQuestList();
    });
})();

/* ══════════════════════════════════════════════════════════════
   LOCATIONS PANEL
   ══════════════════════════════════════════════════════════════ */
var _locationsOpen = false;
var _savedLocations = [];
try { _savedLocations = JSON.parse(localStorage.getItem('dm_locations') || '[]'); } catch(e){}
function _saveLocations() { if (window._isOneShot) return; try { localStorage.setItem('dm_locations', JSON.stringify(_savedLocations)); } catch(e){} }

function toggleLocationDropdown() {
    _locationsOpen = !_locationsOpen;
    var body   = document.getElementById('npcLocationDropdownBody');
    var toggle = document.getElementById('locationDropdownToggle');
    if (body)   body.style.display = _locationsOpen ? 'block' : 'none';
    if (toggle) toggle.style.transform = _locationsOpen ? 'rotate(180deg)' : '';
    if (_locationsOpen) _renderSavedLocationsList();
}

/* Legacy alias — any code that calls toggleLocationsPanel() will now open the inline dropdown */
function toggleLocationsPanel() {
    toggleLocationDropdown();
}

function _renderSavedLocationsList() {
    var el = document.getElementById('savedLocationsList');
    if (!el) return;
    if (!_savedLocations.length) {
        el.innerHTML = '<div style="color:rgba(100,180,100,0.4);font-size:0.72em;text-align:center;padding:4px;font-style:italic;">No saved locations.</div>';
        return;
    }
    el.innerHTML = _savedLocations.slice().reverse().slice(0, 8).map(function(loc) {
        return '<div onclick="loadSavedLocation(\'' + loc.id + '\')" style="display:flex;align-items:center;gap:4px;padding:3px 6px;border-radius:4px;cursor:pointer;border:1px solid rgba(100,180,100,0.15);background:rgba(100,180,100,0.05);margin-bottom:2px;font-size:0.73em;font-family:\'Cinzel\',serif;color:#a0d8a0;" onmouseover="this.style.background=\'rgba(100,180,100,0.15)\'" onmouseout="this.style.background=\'rgba(100,180,100,0.05)\'">'
            + '<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (loc.icon || '🏘') + ' ' + (loc.name || 'Location') + '</span>'
            + '<button onclick="event.stopPropagation();deleteSavedLocation(\'' + loc.id + '\')" style="background:none;border:none;color:rgba(139,0,0,0.6);cursor:pointer;font-size:0.9em;padding:0 2px;">✕</button>'
            + '</div>';
    }).join('');
}

function loadSavedLocation(id) {
    var loc = _savedLocations.find(function(l){ return l.id === id; });
    if (!loc) return;
    var el = document.getElementById('locationDisplay');
    if (el) el.innerHTML = loc.html;
}

function deleteSavedLocation(id) {
    _savedLocations = _savedLocations.filter(function(l){ return l.id !== id; });
    _saveLocations();
    _renderSavedLocationsList();
}

/* Location type data */
var _LOCATION_DATA = {
    tavern: {
        icon: '🍺', name: 'Tavern / Inn',
        names: ['The Broken Axe', 'The Gilded Goblin', 'The Wanderer\'s Rest', 'The Black Sheep', 'The Dragon\'s Breath', 'The Leaky Flagon', 'The Silver Stag', 'The Rusted Blade'],
        smells: ['stale ale and pipe smoke', 'roasting meat and sawdust', 'tallow candles and unwashed travelers', 'herbs and spilled mead', 'cedar smoke and old leather'],
        sounds: ['a bard playing off-key ballads', 'the crack of dice on wooden tables', 'loud arguing from a corner booth', 'laughter and the clinking of mugs', 'a fiddle and the thump of boots on floorboards'],
        rooms: ['a main taproom with long communal tables', 'a private booth screened by a moth-eaten curtain', 'a cramped kitchen behind a greasy door', 'six small rooms upstairs (3 sp/night)', 'a cellar stocked with local ale and a few rare wines'],
        items: ['wanted posters tacked above the bar', 'a stuffed owlbear head mounted on the wall', 'a locked strongbox behind the bar', 'a noticeboard with work postings', 'a dartboard riddled with holes', 'a large hearth with a spit', 'kegs stacked floor to ceiling'],
        secrets: ['The barkeep is an informant for the local thieves\' guild', 'The cellar contains a hidden passage to the sewers', 'A fugitive has been living in the attic for two weeks', 'The "special stew" contains ingredients the health inspector would not approve'],
        npcTypes: ['barkeep', 'barmaid', 'bard', 'local drunk', 'shady merchant', 'off-duty guard', 'traveling merchant'],
        races: ['Human', 'Halfling', 'Dwarf', 'Half-Elf'],
        classes: ['Commoner', 'Rogue', 'Bard', 'Fighter']
    },
    blacksmith: {
        icon: '⚒', name: 'Blacksmith',
        names: ['Ironveil Forge', 'The Anvil & Star', 'Hammerfall Works', 'The Red Forge', 'Dusksteel Smithy', 'The Burning Brand'],
        smells: ['coal smoke and hot metal', 'quenching oil and sweat', 'leather and forge ash', 'sulfur from the bellows coals'],
        sounds: ['the rhythmic ring of hammer on anvil', 'the hiss of metal in the quench bucket', 'the roar of the forge bellows', 'the scrape of a whetstone'],
        rooms: ['a open-front workshop facing the street', 'a display room with finished goods on wall hooks', 'a repair bench cluttered with broken equipment', 'a locked back room for special commissions', 'a yard with a horse trough for cooling metal'],
        items: ['racks of finished swords, axes, and daggers', 'horseshoes and farming tools hanging from rafters', 'a hand-lettered price list on a board', 'a half-finished suit of chainmail on a dummy', 'slag buckets and coal bins', 'a massive anvil scarred by decades of use'],
        secrets: ['The smith moonlights making weapons for the local criminal element', 'There is a hidden compartment in the floor under the anvil', 'The smith\'s apprentice is actually an assassin in hiding', 'The smith has discovered a rare alloy but will not say where the ore comes from'],
        npcTypes: ['master blacksmith', 'apprentice', 'customer', 'delivery boy'],
        races: ['Dwarf', 'Human', 'Half-Orc', 'Goliath'],
        classes: ['Commoner', 'Fighter', 'Artificer']
    },
    general_store: {
        icon: '🛒', name: 'General Store',
        names: ['Morley\'s Provisions', 'The Trading Post', 'All Things & More', 'Copperfoot Sundries', 'The Merchant\'s Rest', 'Bram\'s Goods'],
        smells: ['dried herbs and cured leather', 'lamp oil and sawdust', 'salted meat and soap', 'old paper and tallow'],
        sounds: ['the tinkle of a shop bell', 'the rustle of inventory being counted', 'a quill scratching in a ledger', 'a customer haggling over prices'],
        rooms: ['a main floor crowded with shelves', 'a back storeroom (staff only)', 'a small counter with a scale and till', 'a loft accessible by ladder, stocked with bulk goods'],
        items: ['rope (50 ft coils)', 'torches, lanterns, and oil flasks', 'trail rations and dried meat', 'basic tools (hammers, saws, shovels)', 'bolts of cloth and thread', 'candles, soap, and cookware', 'a locked glass case with unusual items', 'posted prices on a handwritten sign'],
        secrets: ['The owner keeps a second, secret ledger tracking black-market sales', 'The storeroom has a false wall concealing stolen goods', 'The owner is deeply in debt to a local crime lord', 'Several items in the locked case are actually magical'],
        npcTypes: ['shopkeeper', 'clerk', 'customer', 'delivery person'],
        races: ['Human', 'Halfling', 'Gnome', 'Half-Elf'],
        classes: ['Commoner', 'Rogue', 'Wizard']
    },
    temple: {
        icon: '⛪', name: 'Temple / Shrine',
        names: ['The Temple of the Eternal Flame', 'Shrine of the Silver Moon', 'The House of Oaths', 'The Sunward Chapel', 'The Thornward Sanctum', 'The Black Cathedral'],
        smells: ['incense and melted wax', 'stone dust and old parchment', 'holy oils and fresh flowers', 'iron and blood from a sacrifice pit'],
        sounds: ['chanting from within the nave', 'the toll of a distant bell', 'sandalled footsteps on stone', 'hymns being rehearsed by acolytes', 'complete silence, broken by dripping water'],
        rooms: ['a grand nave with pews facing an altar', 'a vestry where priests prepare', 'a reliquary housing sacred objects', 'underground catacombs (sealed)', 'a scriptorium where texts are copied', 'a healing wing with cots for the sick'],
        items: ['iron censers swinging with incense', 'votive candles in their hundreds', 'donation boxes fixed to pillars', 'a sealed reliquary the size of a coffin', 'carved iconography covering every surface', 'a font of holy water', 'a cracked stone sarcophagus in an alcove'],
        secrets: ['The high priest is secretly devoted to a rival deity', 'The catacombs house something that should not be there', 'The donations are being embezzled', 'The healing wing is used to dispose of inconvenient people'],
        npcTypes: ['high priest', 'acolyte', 'pilgrim', 'guard', 'healer'],
        races: ['Human', 'Half-Elf', 'Elf', 'Tiefling'],
        classes: ['Cleric', 'Paladin', 'Commoner', 'Ranger']
    },
    guild_hall: {
        icon: '🏛', name: 'Guild Hall',
        names: ['The Merchant\'s Exchange', 'The Cartographer\'s House', 'The Iron Brotherhood Hall', 'The Silver Thread Guild', 'The Scholar\'s Circle', 'The Cobblestone Union'],
        smells: ['pipe tobacco and expensive cologne', 'old paper and ink', 'wood polish and money', 'sweat and sawdust (labourers\' guild)'],
        sounds: ['heated debate from the main chamber', 'the stamp of a wax seal', 'quills scratching at long tables', 'coin counting and weight checking'],
        rooms: ['a grand meeting hall with a long table', 'a records room with floor-to-ceiling filing', 'private offices for senior members', 'a vault room (heavily locked)', 'a side room for negotiations', 'a noticeboard covered in contracts'],
        items: ['guild charter framed on the wall', 'a book of member signatures dating back 80 years', 'messenger pigeons in a cage by the window', 'a scale for weighing coin', 'a board covered in contracts and bounties', 'faction emblems on every door'],
        secrets: ['The guild is a front for organised crime', 'A rival faction is attempting a hostile takeover', 'The vault contains stolen goods from another city', 'A senior member is blackmailing the others'],
        npcTypes: ['guild master', 'secretary', 'senior member', 'petitioner', 'enforcer'],
        races: ['Human', 'Dwarf', 'Gnome', 'Half-Elf'],
        classes: ['Rogue', 'Wizard', 'Fighter', 'Commoner']
    },
    apothecary: {
        icon: '🧪', name: 'Apothecary / Alchemist',
        names: ['The Mortar & Moon', 'Greywick\'s Reagents', 'The Copper Alembic', 'Nightshade & Co.', 'The Painted Skull', 'Miravel\'s Cures'],
        smells: ['sharp sulfur and sweet herbs', 'vinegar and something burning', 'dried lavender and bone dust', 'a faint trace of something poisonous'],
        sounds: ['bubbling alembics', 'the crinkle of dried herb bundles', 'a scale being precisely balanced', 'something fizzing in a sealed flask'],
        rooms: ['a front shop with hanging herbs and labelled vials', 'a preparation room with a worktable and distillation equipment', 'a locked cabinet of controlled substances', 'a small cold room for perishable ingredients'],
        items: ['hundreds of labelled glass vials and jars', 'drying herb bundles from the ceiling', 'a mortar and pestle with residue', 'a locked iron cabinet (poisons and restricted reagents)', 'a hand-lettered list of available potions and prices', 'a bubbling alembic setup', 'an anatomy chart on the wall'],
        secrets: ['The apothecary sells poisons to both sides of the local conflict', 'Several labelled jars contain illegal substances', 'The back room is a fully equipped poison lab', 'The apothecary is the local poisoner for hire'],
        npcTypes: ['alchemist', 'apprentice', 'customer', 'herbalist supplier'],
        races: ['Gnome', 'Elf', 'Human', 'Tiefling'],
        classes: ['Wizard', 'Artificer', 'Commoner', 'Rogue']
    },
    market: {
        icon: '🏪', name: 'Market Square',
        names: ['The Grand Bazaar', 'The Copperstone Market', 'Ashveil Square', 'The Merchant Quarter', 'The Morning Market', 'The Coloured Stalls'],
        smells: ['fresh bread and spice', 'animal dung and sawdust', 'fruit and raw fish', 'perfume from a cloth stall'],
        sounds: ['hawkers calling their prices', 'a pickpocket working the crowd', 'a street performer drawing a crowd', 'the creak of cart wheels', 'haggling in three languages'],
        rooms: ['permanent stall rows with fixed vendor pitches', 'a central fountain used as a meeting point', 'a covered section for expensive goods', 'an alley behind the stalls used for shadier deals', 'a guard post at each entrance'],
        items: ['food stalls: bread, cheese, meat, vegetables', 'cloth merchants with bolts of fabric', 'a weapons dealer (nothing sharp, technically)', 'jewellers with locked display cases', 'livestock pens at the far end', 'a notice board with jobs and wanted posters'],
        secrets: ['A fence operates from one of the permanent stalls', 'The "merchant quarter" fence deals in stolen goods', 'The market is a known meeting point for a spy ring', 'A vendor is skimming from the market tax'],
        npcTypes: ['merchant', 'vendor', 'pickpocket', 'guard', 'buyer', 'street performer'],
        races: ['Human', 'Halfling', 'Gnome', 'Tiefling', 'Half-Elf'],
        classes: ['Commoner', 'Rogue', 'Fighter', 'Bard']
    },
    thieves_den: {
        icon: '🗡', name: 'Thieves Den',
        names: ['The Rat Hole', 'The Shadow Market', 'The Black Door', 'Under the Chandler\'s', 'The Sixth House', 'The Crooked Needle'],
        smells: ['mildew and old leather', 'cheap tallow and blood', 'tobacco and something metallic', 'unwashed bodies in a confined space'],
        sounds: ['hushed conversations that stop when you enter', 'the metallic click of a lock being picked', 'dice on a felt surface', 'the sharpening of blades'],
        rooms: ['a cramped entry room with two guards', 'a main common area for members', 'a back room for planning jobs', 'a vault with a complex lock', 'secret tunnels connecting to the sewers', 'an interrogation room the guild calls "the office"'],
        items: ['stolen goods piled in crates', 'lockpicks, thieves\' tools, and rope', 'a board covered in city maps and guard rotation notes', 'a fence\'s ledger', 'weapons stashed within easy reach', 'a contraband cache'],
        secrets: ['The guild is under new management after a violent coup', 'An undercover city guard has infiltrated the guild', 'The guild leader is secretly working with the city watch', 'The vault contains something belonging to a very dangerous person'],
        npcTypes: ['guild master', 'fence', 'rogue', 'lookout', 'enforcer', 'new recruit'],
        races: ['Human', 'Half-Elf', 'Halfling', 'Tiefling', 'Elf'],
        classes: ['Rogue', 'Ranger', 'Bard', 'Fighter']
    },
    noble_manor: {
        icon: '🏰', name: 'Noble Manor',
        names: ['Ashford Hall', 'The Crownspire Estate', 'Veltham Manor', 'Irongate House', 'The Goldthorn Estate', 'Moorfield Keep'],
        smells: ['fresh flowers and beeswax', 'expensive perfume and old money', 'roasting meat from the kitchen', 'the dusty pages of old books'],
        sounds: ['string music from a private concert', 'servants moving in the walls', 'the clink of crystal glassware', 'murmured political conversation'],
        rooms: ['a grand entrance hall with a heraldic coat of arms', 'a receiving room for guests', 'a dining hall that seats thirty', 'a private study (always locked)', 'servant quarters below stairs', 'a wine cellar', 'a garden with a locked gate'],
        items: ['family portraits with altered plaques', 'a writing desk with locked drawers', 'shelves of books no one has read', 'an accounting ledger for the estate', 'a weapons collection on the wall', 'a hidden safe behind a painting', 'a family seal used on correspondence'],
        secrets: ['The noble is bankrupt and desperately concealing it', 'The head servant knows every secret in the house', 'The private study contains evidence of treasonous correspondence', 'Someone in the household is a spy'],
        npcTypes: ['lord/lady', 'head butler', 'maid', 'guard captain', 'advisor', 'guest'],
        races: ['Human', 'Half-Elf', 'Elf', 'Tiefling'],
        classes: ['Fighter', 'Rogue', 'Paladin', 'Wizard', 'Commoner']
    },
    barracks: {
        icon: '⚔', name: 'Guard Barracks',
        names: ['The Watch House', 'Irongate Garrison', 'The Third Ward Post', 'The King\'s Men Barracks', 'The Shield Wall'],
        smells: ['weapon oil and unwashed uniforms', 'cooked porridge and steel', 'boot leather and sawdust'],
        sounds: ['the clang of practice swords in the yard', 'a sergeant dressing down recruits', 'the snap of a crossbow in the range', 'boots on flagstone'],
        rooms: ['a main hall with bunk beds and weapon racks', 'a commander\'s office', 'an armory (locked)', 'a jail block with six cells', 'a sparring yard', 'a mess hall'],
        items: ['rack of spears and crossbows', 'a duty roster on the wall', 'prisoner manifest on the commander\'s desk', 'a board with wanted posters', 'manacles hanging from hooks', 'training dummies in the yard'],
        secrets: ['Half the guards are on a crime lord\'s payroll', 'A prisoner in the cells knows something important', 'The commander is covering up a crime', 'The armory contains confiscated magic items that have gone missing'],
        npcTypes: ['guard captain', 'sergeant', 'recruit', 'prisoner', 'quartermaster'],
        races: ['Human', 'Half-Orc', 'Dwarf', 'Goliath'],
        classes: ['Fighter', 'Paladin', 'Ranger', 'Commoner']
    },
    library: {
        icon: '📚', name: 'Library / Archive',
        names: ['The Grand Archive', 'The Ashwood Collection', 'The Repository of Minds', 'The Dusty Word', 'The Scholar\'s Tower', 'The Sealed Stacks'],
        smells: ['old paper and ink', 'dust and leather bindings', 'sealing wax and candle smoke'],
        sounds: ['the soft scratch of quills', 'pages turning', 'the creak of rolling ladders', 'complete silence enforced by a stern librarian'],
        rooms: ['public reading room with long tables', 'the restricted stacks (invitation only)', 'an archivist\'s office', 'a map room', 'a restoration lab for damaged texts', 'a locked vault for rare manuscripts'],
        items: ['thousands of shelved books', 'scrolls in labeled tubes', 'a card catalogue of impossible complexity', 'a locked glass case for rare texts', 'a desk with a sign: "No food. No noise. No exceptions."', 'a large map of the region pinned to a frame'],
        secrets: ['The restricted stacks contain forbidden knowledge', 'The archivist is secretly selling access to dangerous texts', 'A book in the vault contains a summoning ritual', 'The library has been infiltrated by someone looking for a specific document'],
        npcTypes: ['head archivist', 'researcher', 'student', 'scribe', 'guard'],
        races: ['Human', 'Elf', 'Gnome', 'Half-Elf'],
        classes: ['Wizard', 'Cleric', 'Commoner', 'Bard']
    },
    docks: {
        icon: '⚓', name: 'Docks / Harbour',
        names: ['The Salt Wharf', 'Ironpier Docks', 'The Creaking Yard', 'Blackwater Harbour', 'The Fisher\'s Gate', 'The Merchant Pier'],
        smells: ['brine and fish guts', 'tar and wet rope', 'seawater and mold', 'smoke from a ship repair yard'],
        sounds: ['rigging snapping in wind', 'gulls screaming overhead', 'the slap of water on hulls', 'dockworkers calling to each other', 'a capstan being turned'],
        rooms: ['open dock front with multiple berths', 'a harbormaster\'s office', 'cargo warehouses (many guarded)', 'a ship chandler\'s supply shop', 'a fisherman\'s pier separate from merchant traffic'],
        items: ['crates stenciled with foreign markings', 'coiled rope and anchor chains', 'a duty manifest posted at the gate', 'a message board for crew looking for work', 'nets drying on frames', 'a caged live cargo hold (contents unknown)'],
        secrets: ['Smugglers use a hidden sea cave beneath the dock', 'The harbormaster is taking bribes to look away', 'A particular ship\'s manifest doesn\'t match its actual cargo', 'Slavers operate out of the easternmost pier after midnight'],
        npcTypes: ['harbormaster', 'dock worker', 'sailor', 'smuggler', 'fisherman', 'merchant captain'],
        races: ['Human', 'Half-Elf', 'Triton', 'Dwarf', 'Tortle'],
        classes: ['Fighter', 'Rogue', 'Ranger', 'Commoner', 'Bard']
    },
    graveyard: {
        icon: '💀', name: 'Graveyard',
        names: ['The Garden of Remembrance', 'Ashveil Rest', 'The Pale Yard', 'The Long Sleep', 'The Thorngate Cemetery', 'The Field of Stones'],
        smells: ['turned earth and old stone', 'decaying flowers and damp grass', 'candle wax from memorial shrines', 'something wrong — faintly sweet and organic'],
        sounds: ['the creak of a rusted gate', 'wind through stone monuments', 'an owl from somewhere in the dark', 'the distant toll of a chapel bell', 'silence — too complete'],
        rooms: ['the main burial ground with marked plots', 'an old mausoleum family vault', 'a groundskeeper\'s shed', 'a small chapel at the centre', 'catacombs beneath the oldest section (sealed — supposedly)', 'a new section and an old section separated by a crumbling wall'],
        items: ['crumbling headstones with worn inscriptions', 'a fresh grave with no name', 'wilted flowers and burned-out candles', 'a groundskeeper\'s tools (shovel, lantern)', 'a locked mausoleum', 'tracks in the mud that shouldn\'t be there'],
        secrets: ['Someone has been digging up the graves', 'The catacombs are not sealed — something got in, or out', 'A necromancer is using the site for experiments', 'One of the "bodies" is not dead'],
        npcTypes: ['groundskeeper', 'mourner', 'priest', 'suspicious figure', 'undead'],
        races: ['Human', 'Half-Elf', 'Undead', 'Tiefling'],
        classes: ['Cleric', 'Necromancer', 'Ranger', 'Commoner']
    },
    dungeon_entrance: {
        icon: '🕳', name: 'Dungeon Entrance',
        names: ['The Mouth of Greyspire', 'The Shattered Gate', 'The Sunken Keep Entry', 'The Old Mine Shaft', 'The Collapsed Tower Base', 'The Sealed Vault Door'],
        smells: ['damp stone and mold', 'cold air from below', 'old blood and rust', 'the mineral tang of underground water'],
        sounds: ['dripping water echoing in the dark', 'something shifting far below', 'the sound of wind through tunnels', 'silence — deep and absolute'],
        rooms: ['a collapsed guardhouse at the surface', 'a steep descent (stairs, rope, or collapsed floor)', 'a first chamber with signs of recent activity', 'a collapsed section requiring a detour', 'the first branching point'],
        items: ['camp debris from previous adventurers', 'a crude map scratched on a rock', 'bones — old and recent', 'a discarded backpack (contents interesting)', 'scratch marks on the walls — something counting', 'a door with no handles on this side'],
        secrets: ['Someone has been regularly visiting the dungeon recently', 'The dungeon is not abandoned — it\'s occupied and they know you\'re here', 'The map scratched on the rock is deliberately misleading', 'The first chamber is a trap'],
        npcTypes: ['desperate adventurer', 'dungeon denizen', 'cultist', 'monster guard'],
        races: ['Human', 'Dwarf', 'Goblin', 'Orc', 'Undead'],
        classes: ['Fighter', 'Rogue', 'Ranger', 'Barbarian']
    }
};

var _pick = function(arr) { return arr[Math.floor(Math.random() * arr.length)]; };

function generateLocation() {
    var typeKey = document.getElementById('locationTypeSelect').value;
    var setting = document.getElementById('locationSettingSelect').value;

    /* Pick random if not set */
    if (!typeKey) {
        var keys = Object.keys(_LOCATION_DATA);
        typeKey = _pick(keys);
    }
    var data = _LOCATION_DATA[typeKey];
    if (!data) return;

    var name = _pick(data.names);
    var settingStr = setting || _pick(['city','town','village','port','frontier']);
    var settingLabel = {city:'City',town:'Small Town',village:'Remote Village',port:'Port City',frontier:'Frontier Settlement',dungeon:'Underground'}[settingStr] || settingStr;

    /* Generate atmosphere text */
    var atmoItems = [];
    for (var i = 0; i < 3; i++) atmoItems.push(_pick(data.items));
    var roomsToShow = data.rooms.slice().sort(function(){ return Math.random()-0.5; }).slice(0, Math.min(4, data.rooms.length));

    var html = '<div style="font-family:\'Cinzel\',serif;">'
        /* Header */
        + '<div style="background:linear-gradient(145deg,#1a4a1a,#2a6a2a);padding:10px 12px;border-radius:6px 6px 0 0;margin-bottom:0;">'
        + '<div style="font-size:1em;font-weight:700;color:#c8ffc8;letter-spacing:1px;">' + data.icon + ' ' + name + '</div>'
        + '<div style="font-size:0.68em;color:rgba(200,255,200,0.6);margin-top:2px;text-transform:uppercase;letter-spacing:2px;">' + settingLabel + ' · ' + data.name + '</div>'
        + '</div>'
        /* Description */
        + '<div style="background:linear-gradient(145deg,#f4e4bc,#e8dcc5);padding:10px 12px;color:#1a1a1a;font-family:\'Crimson Text\',serif;">'
        + '<div style="font-size:0.88em;line-height:1.7;margin-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.1);padding-bottom:8px;">'
        + 'The air here carries <strong>' + _pick(data.smells) + '</strong>. As you enter, you hear <strong>' + _pick(data.sounds) + '</strong>. '
        + (_pick(['The place is busier than expected.', 'Only a handful of people are about.', 'The atmosphere is tense — heads turn when you arrive.', 'Nobody seems to notice you come in.', 'A brief silence falls as the door opens.']))
        + '</div>'
        /* Rooms */
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;color:#8b0000;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">📍 Areas & Rooms</div>'
        + '<div style="font-size:0.85em;line-height:1.8;margin-bottom:8px;">'
        + roomsToShow.map(function(r){ return '• ' + r; }).join('<br>') + '</div>'
        /* Notable items */
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;color:#8b0000;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">🔍 Notable Details</div>'
        + '<div style="font-size:0.85em;line-height:1.8;margin-bottom:8px;">'
        + atmoItems.map(function(item){ return '• ' + item; }).join('<br>') + '</div>'
        /* Secret */
        + '<div style="background:rgba(139,0,0,0.06);border-left:3px solid #8b0000;padding:6px 10px;border-radius:0 4px 4px 0;margin-bottom:8px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.68em;font-weight:700;color:#8b0000;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px;">🔒 GM Secret</div>'
        + '<div style="font-size:0.83em;line-height:1.6;">' + _pick(data.secrets) + '</div>'
        + '</div>'
        /* NPCs present */
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">👤 Typical Occupants</div>'
        + '<div style="font-size:0.82em;color:#555;margin-bottom:8px;">' + data.npcTypes.join(', ') + '</div>'
        + '</div>'
        /* Actions */
        + '<div style="background:#1a1a2e;padding:8px 10px;border-radius:0 0 6px 6px;display:flex;gap:6px;flex-wrap:wrap;">'
        + '<button onclick="generateLocationNPCs(\'' + typeKey + '\')" style="flex:1;padding:6px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff8dc;border:none;border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.72em;font-weight:700;min-width:80px;">🧙 Fill with NPCs</button>'
        + '<button onclick="generateLocationBattleMap()" style="flex:1;padding:6px;background:rgba(100,180,100,0.2);color:#a0d8a0;border:1px solid rgba(100,180,100,0.4);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.72em;min-width:80px;">🗺 Battle Map</button>'
        + '<button onclick="saveCurrentLocation(\'' + typeKey + '\',\'' + name.replace(/'/g,"\\'") + '\')" style="flex:1;padding:6px;background:rgba(184,134,11,0.2);color:var(--gold-light);border:1px solid rgba(184,134,11,0.4);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.72em;min-width:80px;">💾 Save</button>'
        + '</div>'
        + '</div>';

    var displayEl = document.getElementById('locationDisplay');
    if (displayEl) displayEl.innerHTML = html;

    /* Auto-open the dropdown so user can see the result */
    if (!_locationsOpen) toggleLocationDropdown();

    /* Store current location data for battle map etc */
    window._currentLocation = { type: typeKey, name: name, setting: settingStr, data: data, html: html };
}

function saveCurrentLocation(typeKey, name) {
    if (!window._currentLocation) return;
    var loc = {
        id: 'loc_' + Date.now(),
        type: typeKey,
        name: name,
        icon: (_LOCATION_DATA[typeKey] || {}).icon || '🏘',
        html: window._currentLocation.html,
        date: new Date().toLocaleDateString()
    };
    _savedLocations.unshift(loc);
    if (_savedLocations.length > 20) _savedLocations.pop();
    _saveLocations();
    _renderSavedLocationsList();
    if (typeof showToast === 'function') showToast(name + ' saved!', 'success');
}

function generateLocationNPCs(typeKey) {
    var data = _LOCATION_DATA[typeKey];
    if (!data) data = { races: ['Human'], classes: ['Commoner'] };

    /* Pick a random matching race and class */
    var race  = _pick(data.races);
    var cls   = _pick(data.classes);
    var qty   = 2;

    /* Set main NPC generator selects */
    var raceSel  = document.getElementById('raceSel');
    var classSel = document.getElementById('classSel');
    var qtyInp   = document.getElementById('qtyInput');
    var bossMode = document.getElementById('bossMode');

    if (raceSel)  raceSel.value  = race;
    if (classSel) classSel.value = cls;
    if (qtyInp)   qtyInp.value  = qty;
    if (bossMode) bossMode.checked = false;

    if (typeof generateBatch === 'function') {
        generateBatch();
        if (typeof showToast === 'function') showToast('Generating ' + qty + ' ' + cls + ' NPCs for ' + data.name + '...', 'success');
    }

    /* Close panel so user can see generated NPCs */
    setTimeout(function() { _locationsOpen = false; toggleLocationsPanel(); toggleLocationsPanel(); }, 800);
}

function generateLocationBattleMap() {
    /* Generate a battle map appropriate to the current location */
    var loc = window._currentLocation;
    var typeKey = loc ? loc.type : 'tavern';

    /* Map config per location type */
    var mapConfigs = {
        tavern:         { rooms: ['taproom','kitchen','cellar','alley'],       color: '#5a3010' },
        blacksmith:     { rooms: ['forge','display','storage','yard'],          color: '#3a3a3a' },
        general_store:  { rooms: ['shop floor','back room','loft','yard'],      color: '#8b7040' },
        temple:         { rooms: ['nave','vestry','catacombs','garden'],        color: '#e8dcc5' },
        guild_hall:     { rooms: ['main hall','offices','vault','courtyard'],   color: '#1a3a6a' },
        apothecary:     { rooms: ['shop','lab','cold room','alley'],            color: '#1a4a2a' },
        market:         { rooms: ['stalls','fountain','alley','warehouse'],     color: '#8b6030' },
        thieves_den:    { rooms: ['entry','common','planning','vault'],         color: '#1a1a1a' },
        noble_manor:    { rooms: ['hall','dining','study','garden'],            color: '#5a4010' },
        barracks:       { rooms: ['bunk hall','armory','yard','cells'],         color: '#3a4a2a' },
        library:        { rooms: ['reading room','stacks','vault','corridor'],  color: '#4a3820' },
        docks:          { rooms: ['pier','warehouse','office','water'],         color: '#1a2a4a' },
        graveyard:      { rooms: ['grounds','mausoleum','chapel','catacombs'], color: '#2a2a2a' },
        dungeon_entrance:{ rooms: ['surface','descent','chamber','tunnels'],    color: '#1a1a1a' }
    };
    var cfg = mapConfigs[typeKey] || mapConfigs.tavern;

    /* Use the existing battle map canvas if available */
    var canvas = document.getElementById('questMapCanvas');
    if (!canvas) {
        /* Create a modal with a canvas */
        var modalHtml = '<div id="locationMapModal" class="app-modal" style="position:fixed;inset:0;z-index:29500;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;padding:20px;">'
            + '<div style="background:#1a1a2e;border:2px solid var(--gold);border-radius:12px;padding:20px;max-width:700px;width:100%;">'
            + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">'
            + '<div style="font-family:\'Cinzel\',serif;color:var(--gold-light);font-size:1em;font-weight:700;">🗺 Battle Map — ' + (loc ? loc.name : 'Location') + '</div>'
            + '<button onclick="document.getElementById(\'locationMapModal\').remove()" style="background:none;border:1px solid rgba(255,255,255,0.3);color:white;padding:3px 10px;border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;">✕ Close</button>'
            + '</div>'
            + '<canvas id="locationMapCanvas" width="640" height="480" style="width:100%;border:2px solid rgba(184,134,11,0.3);border-radius:6px;display:block;"></canvas>'
            + '<div id="locationMapLegend" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;"></div>'
            + '<button onclick="generateLocationBattleMap()" style="margin-top:10px;width:100%;padding:8px;background:rgba(100,180,100,0.2);color:#a0d8a0;border:1px solid rgba(100,180,100,0.4);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.82em;font-weight:700;">🔄 Regenerate</button>'
            + '</div></div>';
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = modalHtml;
        document.body.appendChild(tempDiv.firstChild);
        canvas = document.getElementById('locationMapCanvas');
    }

    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    _drawLocationMap(ctx, canvas.width, canvas.height, cfg, loc ? loc.name : 'Location');
    _drawLocationLegend(cfg.rooms);
}

function _drawLocationMap(ctx, W, H, cfg, title) {
    ctx.clearRect(0, 0, W, H);
    /* Background */
    ctx.fillStyle = '#f4e4bc';
    ctx.fillRect(0, 0, W, H);
    /* Grid */
    ctx.strokeStyle = 'rgba(184,134,11,0.15)';
    ctx.lineWidth = 0.5;
    for (var x = 0; x < W; x += 30) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
    for (var y = 0; y < H; y += 30) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

    /* Room colors */
    var roomColors = ['rgba(139,80,0,0.25)','rgba(0,80,139,0.2)','rgba(0,100,50,0.2)','rgba(139,0,0,0.15)','rgba(80,0,139,0.2)'];
    var rooms = cfg.rooms;

    /* Layout: 2x2 or L-shape */
    var layouts = [
        [{x:20,y:20,w:250,h:200},{x:290,y:20,w:330,h:200},{x:20,y:240,w:200,h:220},{x:240,y:240,w:380,h:220}],
        [{x:20,y:20,w:580,h:150},{x:20,y:190,w:250,h:270},{x:290,y:190,w:310,h:120},{x:290,y:330,w:310,h:130}],
        [{x:20,y:20,w:180,h:440},{x:220,y:20,w:200,h:200},{x:220,y:240,w:200,h:220},{x:440,y:20,w:180,h:440}]
    ];
    var layout = layouts[Math.floor(Math.random() * layouts.length)];

    rooms.forEach(function(room, i) {
        if (i >= layout.length) return;
        var r = layout[i];
        /* Room fill */
        ctx.fillStyle = roomColors[i % roomColors.length];
        ctx.fillRect(r.x, r.y, r.w, r.h);
        /* Walls */
        ctx.strokeStyle = '#5a3010';
        ctx.lineWidth = 3;
        ctx.strokeRect(r.x, r.y, r.w, r.h);
        /* Door - random wall placement */
        ctx.fillStyle = '#f4e4bc';
        ctx.fillRect(r.x + Math.floor(r.w/2) - 10, r.y + r.h - 3, 20, 6);
        ctx.strokeStyle = '#8b6030';
        ctx.lineWidth = 2;
        ctx.strokeRect(r.x + Math.floor(r.w/2) - 10, r.y + r.h - 3, 20, 6);
        /* Label */
        ctx.fillStyle = 'rgba(30,20,10,0.8)';
        ctx.font = 'bold 11px serif';
        ctx.textAlign = 'center';
        ctx.fillText(room.toUpperCase(), r.x + r.w/2, r.y + 18);
        /* Add some scatter */
        for (var s = 0; s < 3; s++) {
            var sx = r.x + 20 + Math.random() * (r.w - 40);
            var sy = r.y + 30 + Math.random() * (r.h - 50);
            ctx.fillStyle = 'rgba(80,40,0,0.5)';
            ctx.beginPath();
            ctx.arc(sx, sy, 5, 0, Math.PI * 2);
            ctx.fill();
        }
    });

    /* Title */
    ctx.fillStyle = 'rgba(30,20,10,0.7)';
    ctx.font = 'bold 14px serif';
    ctx.textAlign = 'left';
    ctx.fillText(title, 8, H - 8);
    ctx.textAlign = 'right';
    ctx.font = '11px serif';
    ctx.fillStyle = 'rgba(139,0,0,0.5)';
    ctx.fillText('1 square = 5 ft', W - 8, H - 8);
}

function _drawLocationLegend(rooms) {
    var el = document.getElementById('locationMapLegend');
    if (!el) return;
    var cols = ['rgba(139,80,0,0.4)','rgba(0,80,139,0.35)','rgba(0,100,50,0.35)','rgba(139,0,0,0.3)'];
    el.innerHTML = rooms.map(function(r, i) {
        return '<div style="display:flex;align-items:center;gap:4px;font-family:\'Cinzel\',serif;font-size:0.68em;color:rgba(255,255,255,0.7);">'
            + '<div style="width:12px;height:12px;background:' + (cols[i%cols.length]) + ';border:1px solid rgba(255,255,255,0.3);border-radius:2px;flex-shrink:0;"></div>'
            + r + '</div>';
    }).join('');
}

/* ══════════════════════════════════════════════════════════════
   GENERATE LOCATIONS & NPCs FOR QUEST
   ══════════════════════════════════════════════════════════════ */
function npcDropdownGenerateLocationsAndNPCs() {
    /* Get current quest context to pick sensible locations */
    var questData = _npcDropdownCurrentQuest;
    var questType = questData ? (questData.type || '') : '';
    var outputEl  = document.getElementById('npcDropdownQuestOutput');

    /* Map quest types to likely location types */
    var questLocationMap = {
        assassination: ['tavern','noble_manor','guild_hall','barracks'],
        retrieve:      ['thieves_den','general_store','docks','guild_hall'],
        escort:        ['tavern','market','docks','temple'],
        investigate:   ['library','tavern','market','temple'],
        rescue:        ['dungeon_entrance','barracks','noble_manor','thieves_den'],
        explore:       ['dungeon_entrance','graveyard','docks','general_store'],
        defend:        ['barracks','tavern','noble_manor','temple'],
        political:     ['guild_hall','noble_manor','library','temple'],
        curse:         ['temple','graveyard','apothecary','dungeon_entrance'],
        divine:        ['temple','library','graveyard','apothecary'],
        criminal:      ['thieves_den','docks','tavern','market'],
        war:           ['barracks','blacksmith','general_store','docks'],
        revenge:       ['tavern','noble_manor','guild_hall','thieves_den']
    };
    var possibleTypes = questLocationMap[questType] || Object.keys(_LOCATION_DATA);
    var numLocations = 2 + Math.floor(Math.random() * 2); /* 2-3 locations */
    var chosenTypes = [];
    var shuffled = possibleTypes.slice().sort(function(){ return Math.random() - 0.5; });
    chosenTypes = shuffled.slice(0, Math.min(numLocations, shuffled.length));

    /* Generate each location */
    var locationsHtml = '<div style="font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;border-bottom:1px solid rgba(184,134,11,0.3);padding-bottom:6px;">🗺 Quest Locations</div>';

    chosenTypes.forEach(function(typeKey) {
        var data = _LOCATION_DATA[typeKey];
        if (!data) return;
        var name = _pick(data.names);
        var secret = _pick(data.secrets);
        var rooms = data.rooms.slice().sort(function(){ return Math.random()-0.5; }).slice(0, 3);
        var items = [];
        for (var i = 0; i < 2; i++) items.push(_pick(data.items));

        locationsHtml += '<div style="background:rgba(100,180,100,0.08);border:1px solid rgba(100,180,100,0.25);border-radius:6px;padding:10px;margin-bottom:8px;">'
            + '<div style="font-size:0.88em;font-weight:700;color:#a0d8a0;margin-bottom:4px;">' + data.icon + ' ' + name + ' <span style="font-weight:400;font-size:0.8em;color:rgba(160,216,160,0.6);">(' + data.name + ')</span></div>'
            + '<div style="font-family:\'Crimson Text\',serif;font-size:0.85em;line-height:1.65;color:rgba(255,255,255,0.75);margin-bottom:6px;">'
            + 'The air carries ' + _pick(data.smells) + '. ' + rooms.map(function(r){ return r; }).join(', ') + '.</div>'
            + '<div style="font-size:0.78em;color:rgba(200,200,200,0.6);margin-bottom:4px;">Notable: ' + items.join('; ') + '</div>'
            + '<div style="background:rgba(139,0,0,0.1);border-left:2px solid rgba(139,0,0,0.5);padding:4px 8px;font-size:0.78em;color:#f08080;font-family:\'Crimson Text\',serif;margin-bottom:6px;"><em>🔒 ' + secret + '</em></div>'
            + '<div style="display:flex;gap:4px;flex-wrap:wrap;">'
            + '<button onclick="generateLocationNPCs(\'' + typeKey + '\')" style="padding:4px 10px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff8dc;border:none;border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;">🧙 Generate NPCs</button>'
            + '<button onclick="(function(){document.getElementById(\'locationTypeSelect\').value=\'' + typeKey + '\';generateLocation();if(!_locationsOpen)toggleLocationDropdown();})()" style="padding:4px 10px;background:rgba(100,180,100,0.2);color:#a0d8a0;border:1px solid rgba(100,180,100,0.4);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.7em;">🏘 Full Detail</button>'
            + '</div>'
            + '</div>';
    });

    /* Also trigger NPC generation */
    if (questData) {
        locationsHtml += '<div style="margin-top:8px;padding:8px;background:rgba(184,134,11,0.08);border:1px solid rgba(184,134,11,0.2);border-radius:5px;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:var(--gold);font-weight:700;margin-bottom:4px;">🧙 Quest NPCs Auto-Generating...</div>'
            + '<div style="font-family:\'Crimson Text\',serif;font-size:0.8em;color:rgba(255,255,255,0.5);">Check the NPC tabs for generated characters matching these locations.</div>'
            + '</div>';
    }

    /* Show in quest output area */
    if (outputEl) {
        var existingContent = outputEl.innerHTML;
        outputEl.innerHTML = (existingContent ? existingContent + '<hr style="border-color:rgba(184,134,11,0.2);margin:12px 0;">' : '') + locationsHtml;
        outputEl.style.display = 'block';
    }

    /* Also generate NPCs based on location types */
    if (typeof generateBatch === 'function') {
        setTimeout(function() {
            var primaryType = chosenTypes[0];
            var data = _LOCATION_DATA[primaryType];
            if (data) {
                var raceSel  = document.getElementById('raceSel');
                var classSel = document.getElementById('classSel');
                var qtyInp   = document.getElementById('qtyInput');
                if (raceSel)  raceSel.value  = _pick(data.races);
                if (classSel) classSel.value = _pick(data.classes);
                if (qtyInp)   qtyInp.value   = 3;
                generateBatch();
            }
        }, 500);
    }

    if (typeof showToast === 'function') showToast('Quest locations & NPCs generated!', 'success');
}

/* ══════════════════════════════════════════════════════════════
   STORY & WORLD GENERATOR — SELF-CONTAINED ENGINE v4
   All generation is fully independent — no external dependencies
   ══════════════════════════════════════════════════════════════ */

/* ── State ── */
var _swActiveTab    = 'story';
var _swCurrentStory = null;
var _swStoryLinked  = false;
var _swSavedStories = [];
var _swSavedLocs    = [];
var _swLastQuest    = null;
var _swLastLoc      = null;
try { _swSavedStories = JSON.parse(localStorage.getItem('dm_sw_stories') || '[]'); } catch(e){}
try { _swSavedLocs    = JSON.parse(localStorage.getItem('dm_sw_locs')    || '[]'); } catch(e){}

function _swSave() {
    if (window._isOneShot) return;
    try { localStorage.setItem('dm_sw_stories', JSON.stringify(_swSavedStories)); } catch(e){}
    try { localStorage.setItem('dm_sw_locs',    JSON.stringify(_swSavedLocs));    } catch(e){}
}

/* ── Utility ── */
var _swSeedState = { enabled: false, seedText: '', state: 0 };

function _swHashSeed(str) {
    var h = 2166136261;
    var s = String(str || '');
    for (var i = 0; i < s.length; i++) {
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
    }
    return (h >>> 0) || 1;
}

function _swRand() {
    if (!_swSeedState.enabled) return Math.random();
    _swSeedState.state = (Math.imul(_swSeedState.state, 1664525) + 1013904223) >>> 0;
    return _swSeedState.state / 4294967296;
}

function _swBeginDeterministic(scope) {
    if (!_swSeedState.enabled) return;
    _swSeedState.state = _swHashSeed(_swSeedState.seedText + '|' + String(scope || 'default'));
}

function _swUpdateSeedStatus() {
    var status = document.getElementById('swSeedStatus');
    if (!status) return;
    status.textContent = _swSeedState.enabled ? ('Seeded: ' + _swSeedState.seedText) : 'Random mode';
}

function swApplySeedFromInput() {
    var inp = document.getElementById('swSeedInput');
    var txt = inp ? String(inp.value || '').trim() : '';
    if (!txt) {
        swClearSeed();
        return;
    }
    _swSeedState.enabled = true;
    _swSeedState.seedText = txt;
    _swSeedState.state = _swHashSeed(txt);
    try { localStorage.setItem('dm_sw_seed_v1', txt); } catch(e){}
    _swUpdateSeedStatus();
    if (typeof showToast === 'function') showToast('Seed applied: ' + txt, 'success');
}

function swClearSeed() {
    _swSeedState.enabled = false;
    _swSeedState.seedText = '';
    _swSeedState.state = 0;
    var inp = document.getElementById('swSeedInput');
    if (inp) inp.value = '';
    try { localStorage.removeItem('dm_sw_seed_v1'); } catch(e){}
    _swUpdateSeedStatus();
    if (typeof showToast === 'function') showToast('Seed cleared', 'success');
}

function swInitSeedUI() {
    var inp = document.getElementById('swSeedInput');
    var saved = '';
    try { saved = localStorage.getItem('dm_sw_seed_v1') || ''; } catch(e) {}
    if (saved) {
        _swSeedState.enabled = true;
        _swSeedState.seedText = saved;
        _swSeedState.state = _swHashSeed(saved);
        if (inp) inp.value = saved;
    } else {
        _swSeedState.enabled = false;
        _swSeedState.seedText = '';
        _swSeedState.state = 0;
    }
    _swUpdateSeedStatus();
}

function _swPick(arr) {
    if (!arr || !arr.length) return '';
    return arr[Math.floor(_swRand() * arr.length)];
}
function _swPickFrom(obj, key) {
    var arr = obj[key] || obj['epic_fantasy'] || [];
    return _swPick(arr);
}
function _swJoinSentences(parts) {
    return (parts || []).filter(function(x){ return !!x; }).join(' ');
}
function _swNarrativeParagraph(seed, options, count) {
    var picks = [];
    var pool = Array.isArray(options) ? options.slice() : [];
    var n = Math.max(1, Number(count || 2));
    while (pool.length && picks.length < n) {
        var idx = Math.floor(_swRand() * pool.length);
        picks.push(pool.splice(idx, 1)[0]);
    }
    return _swJoinSentences([seed].concat(picks));
}

function swAnalyzeNarrativeCoherence(kind, payload) {
    var p = payload || {};
    var issues = [];
    var warnings = [];

    var requiredByKind = {
        story: ['title', 'antagonist', 'goal'],
        quest: ['title', 'objective', 'twist'],
        location: ['name', 'type', 'setting'],
        bounty: ['name', 'crime', 'warning']
    };

    (requiredByKind[kind] || []).forEach(function(k) {
        if (!p[k] || !String(p[k]).trim()) issues.push('Missing key narrative anchor: ' + k + '.');
    });

    var blocks = Array.isArray(p.textBlocks) ? p.textBlocks.filter(Boolean) : [];
    var allText = blocks.join(' ').toLowerCase();

    if (!allText || allText.length < 280) {
        warnings.push('Narrative body is short; consider adding one more concrete consequence or scene beat.');
    }
    if (/\b(undefined|null|n\/a|tbd)\b/i.test(allText)) {
        issues.push('Contains placeholder-like terms that can break immersion.');
    }

    var contradictionPairs = [
        ['alive', 'dead'],
        ['trusted ally', 'traitor'],
        ['public', 'secret'],
        ['lawful', 'outlaw']
    ];
    contradictionPairs.forEach(function(pair) {
        if (allText.indexOf(pair[0]) >= 0 && allText.indexOf(pair[1]) >= 0) {
            warnings.push('Potential contradiction detected: "' + pair[0] + '" and "' + pair[1] + '" both appear.');
        }
    });

    var score = Math.max(0, 100 - (issues.length * 18) - (warnings.length * 8));
    var status = score >= 88 ? 'Strong' : score >= 70 ? 'Usable' : 'Needs Review';
    return {
        kind: kind,
        score: score,
        status: status,
        issues: issues,
        warnings: warnings,
        passed: issues.length === 0
    };
}

function swRenderCoherencePanel(report, accent) {
    if (!report) return '';
    var col = accent || '#9ecbff';
    var statusCol = report.score >= 88 ? '#78e08f' : report.score >= 70 ? '#ffd166' : '#ff8a80';
    var lines = [];
    (report.issues || []).forEach(function(x){ lines.push('<li style="margin-bottom:4px;">❗ ' + x + '</li>'); });
    (report.warnings || []).forEach(function(x){ lines.push('<li style="margin-bottom:4px;">⚠ ' + x + '</li>'); });
    if (!lines.length) lines.push('<li>✅ No coherence risks detected in this pass.</li>');

    return '<div style="background:rgba(12,20,30,0.42);border:1px solid ' + col + '44;border-radius:6px;padding:11px 13px;margin-top:10px;">'
        + '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:7px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:' + col + ';text-transform:uppercase;letter-spacing:1.4px;">🧠 Coherence Check</div>'
        + '<div style="display:flex;align-items:center;gap:6px;">'
        + '<span style="font-size:0.68em;color:rgba(230,240,255,0.8);font-family:\'Cinzel\',serif;">Score</span>'
        + '<span style="padding:2px 8px;border-radius:10px;border:1px solid ' + statusCol + ';color:' + statusCol + ';font-size:0.7em;font-family:\'Cinzel\',serif;font-weight:700;">' + report.score + '/100 · ' + report.status + '</span>'
        + '</div>'
        + '</div>'
        + '<ul style="margin:0 0 0 18px;padding:0;color:rgba(230,240,255,0.82);font-size:0.86em;line-height:1.55;">' + lines.join('') + '</ul>'
        + '</div>';
}

function swBuildSessionPrep(kind, payload) {
    var p = payload || {};
    var clocks = [
        'Clock (4): Enemy scouts identify the party\'s route and set a moving ambush.',
        'Clock (6): A trusted NPC is pressured into giving partial truths to the wrong faction.',
        'Clock (4): A legal authority declares the party\'s methods unlawful unless evidence is produced.',
        'Clock (8): Resource shortage forces a hard choice between speed, stealth, or safety.'
    ];
    var scenes = [
        'Open with a tense social scene where one ally and one rival both appear useful.',
        'Run a transition hazard that reveals new intel instead of only costing HP/resources.',
        'Use a midpoint reveal that changes what success means (not just how hard it is).',
        'End on a cliffhanger tied to a named person, place, or artifact from this result.'
    ];
    var twists = [
        'A "helpful" witness is accurate but intentionally omits one crucial detail.',
        'The opposition tries to negotiate first to buy setup time, not peace.',
        'A public event forces the party to choose reputation or tactical advantage.',
        'A false win triggers the real threat in a different location.'
    ];
    var fallbackAnchor = p.title || p.name || p.objective || p.goal || 'the current situation';
    return {
        objective: 'Keep the table focused on ' + fallbackAnchor + ' while escalating pressure every 20–30 minutes of play.',
        clock: _swPick(clocks),
        opener: _swPick(scenes),
        twist: _swPick(twists),
        payoff: 'Payoff target: resolve one major uncertainty and introduce one new consequence that carries into the next session.'
    };
}

function swRenderSessionPrepPanel(prep, accent) {
    if (!prep) return '';
    var col = accent || '#c5e1ff';
    return '<div style="background:rgba(10,16,24,0.45);border:1px solid ' + col + '55;border-radius:6px;padding:11px 13px;margin-top:10px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:' + col + ';text-transform:uppercase;letter-spacing:1.4px;margin-bottom:8px;">🧭 Phase 4: Session Prep</div>'
        + '<div style="font-size:0.9em;color:rgba(230,240,255,0.88);line-height:1.6;">'
        + '<div style="margin-bottom:5px;"><strong>Objective:</strong> ' + prep.objective + '</div>'
        + '<div style="margin-bottom:5px;"><strong>Pressure Clock:</strong> ' + prep.clock + '</div>'
        + '<div style="margin-bottom:5px;"><strong>Opening Scene:</strong> ' + prep.opener + '</div>'
        + '<div style="margin-bottom:5px;"><strong>Twist Option:</strong> ' + prep.twist + '</div>'
        + '<div><strong>Payoff:</strong> ' + prep.payoff + '</div>'
        + '</div>'
        + '</div>';
}

/* ── Tab Switcher ── */
function swSwitchTab(tab) {
    _swActiveTab = tab;
    var TABS = ['story','quest','bounty','revenge','location','questnpcs'];
    var COLORS = {
        story:     { bg:'linear-gradient(145deg,rgba(100,0,180,0.6),rgba(60,0,120,0.6))',   border:'#a060ff', color:'#d0a0ff' },
        quest:     { bg:'linear-gradient(145deg,rgba(139,0,0,0.6),rgba(80,0,0,0.6))',       border:'#ff6060', color:'#fff8dc' },
        bounty:    { bg:'linear-gradient(145deg,rgba(120,70,0,0.7),rgba(80,40,0,0.7))',     border:'#daa520', color:'#ffd700' },
        revenge:   { bg:'linear-gradient(145deg,rgba(100,0,0,0.7),rgba(60,0,0,0.8))',      border:'#cc4444', color:'#ffcccc' },
        location:  { bg:'linear-gradient(145deg,rgba(20,80,20,0.6),rgba(10,50,10,0.6))',    border:'#60c860', color:'#c8ffc8' },
        questnpcs: { bg:'linear-gradient(145deg,rgba(140,80,0,0.7),rgba(100,50,0,0.7))',   border:'#ffaa33', color:'#ffd080' }
    };
    var panelToShow = (tab === 'revenge') ? 'quest' : tab;
    TABS.forEach(function(t) {
        var btn = document.getElementById('swTab_' + t);
        var active = (t === tab);
        if (btn && COLORS[t]) {
            btn.style.background   = active ? COLORS[t].bg : 'transparent';
            btn.style.borderBottom = active ? '3px solid ' + COLORS[t].border : '3px solid transparent';
            btn.style.color        = active ? COLORS[t].color : 'rgba(255,255,255,0.35)';
            btn.style.opacity      = active ? '1' : '0.7';
        }
    });
    ['story','quest','bounty','location','questnpcs'].forEach(function(pid) {
        var panel = document.getElementById('swPanel_' + pid);
        if (panel) panel.style.display = (pid === panelToShow) ? 'block' : 'none';
    });
    if (tab === 'location')  swRenderSavedLocs();
    if (tab === 'quest' || tab === 'revenge') { if (typeof swRenderSavedQuests === 'function') swRenderSavedQuests(); }
    if (tab === 'story' && typeof swLoadStoryAISettings === 'function') swLoadStoryAISettings();
    var normalCtrl = document.getElementById('swQuestNormalControls');
    var revengeCtrl = document.getElementById('swRevengeTabControls');
    if (normalCtrl) normalCtrl.style.display = (tab === 'revenge') ? 'none' : 'block';
    if (revengeCtrl) revengeCtrl.style.display = (tab === 'revenge') ? 'block' : 'none';
    if (tab === 'bounty')    { if (typeof swRenderSavedBounties === 'function') swRenderSavedBounties(); }
    if (tab === 'questnpcs') { swRenderQuestNPCsPanel(); }
    swUpdateStoryLinkBars();
}

/* ── Toggle Story World Container ── */
function toggleStoryWorldContainer() {
    var content = document.getElementById('storyWorldContent');
    var icon = document.getElementById('swToggleIcon');
    if (content && icon) {
        var isCollapsed = content.style.display === 'none';
        content.style.display = isCollapsed ? 'block' : 'none';
        icon.textContent = isCollapsed ? '▼' : '▶';
    }
}

/* ── Clear Story Function ── */
function swClearStory() {
    if (!_swCurrentStory) {
        if (typeof showToast === 'function') showToast('No story to clear!', 'warning');
        return;
    }
    if (confirm('Clear the current story? This cannot be undone.')) {
        _swCurrentStory = null;
        var outEl = document.getElementById('swStoryOutput');
        if (outEl) { outEl.style.display = 'none'; outEl.innerHTML = ''; }
        ['swEvolveBtn','swAddSceneBtn','swClearStoryBtn'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
        var row2 = document.getElementById('swStoryActionRow2');
        if (row2) row2.style.display = 'none';
        swUpdateStoryLinkBars();
        if (typeof showToast === 'function') showToast('Story cleared', 'success');
    }
}

function swToggleStoryLink() {
    _swStoryLinked = !_swStoryLinked;
    _applyStoryLinkUI();
    if (typeof showToast === 'function') showToast(_swStoryLinked ? '🔗 Story Link enabled! All generation tied to your story.' : '🔗 Story Link disabled', 'success');
}

function _applyStoryLinkUI() {
    var btn      = document.getElementById('storyLinkToggleBtn');
    var badge    = document.getElementById('storyLinkBadge');
    var badgeNPC = document.getElementById('storyLinkBadgeNPC');
    var qteBtn   = document.getElementById('swQTEBtn');
    var bar      = document.getElementById('storyModeBar');
    var active   = !!_swStoryLinked;

    /* Button text + style */
    if (btn) {
        btn.textContent      = active ? 'Disable Story Link' : 'Enable Story Link';
        btn.style.background = active ? 'linear-gradient(145deg,rgba(120,60,220,0.8),rgba(80,30,160,0.9))' : 'rgba(80,40,140,0.5)';
        btn.style.borderColor= active ? '#c080ff' : 'rgba(160,100,255,0.4)';
        btn.style.color      = active ? '#fff8dc' : '#c0a0ff';
        btn.style.boxShadow  = active ? '0 0 14px rgba(160,100,255,0.5)' : 'none';
    }

    /* Story Mode bar glow */
    if (bar) {
        bar.style.borderColor = active ? 'rgba(160,100,255,0.75)' : 'rgba(160,100,255,0.35)';
        bar.style.background  = active ? 'linear-gradient(135deg,#140d2e,#1e1040)' : 'linear-gradient(135deg,#0e0c1a,#16122a)';
        bar.style.boxShadow   = active ? '0 0 18px rgba(100,50,200,0.25) inset' : 'none';
    }

    /* Header STORY LINKED badge */
    if (badge) badge.style.display = active ? 'block' : 'none';

    if (qteBtn) {
        qteBtn.style.borderColor = active ? 'rgba(200,140,255,0.8)' : 'rgba(255,130,90,0.65)';
        qteBtn.style.background = active ? 'linear-gradient(145deg,rgba(130,70,210,0.7),rgba(90,40,170,0.85))' : 'linear-gradient(145deg,rgba(180,60,30,0.65),rgba(130,30,20,0.8))';
        qteBtn.style.color = active ? '#f0e1ff' : '#ffd9c8';
    }

    /* NPC Settings badge — show whenever story link is on, regardless of active story */
    if (badgeNPC) badgeNPC.style.display = active ? 'inline-block' : 'none';

    /* Quest / Location link bars */
    ['questStoryLinkBar','locationStoryLinkBar'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.style.display = active ? 'block' : 'none';
    });
}

function swUpdateStoryLinkBars() {
    _applyStoryLinkUI();
}


/* ══ DATA ══ */
var _SWD = {
    antagonists: {
        epic_fantasy:['a fallen paladin consumed by a god of lies','a dragon ancient enough to remember the world\'s first age','a lich who traded his kingdom for immortality','a shadow council that has ruled from the dark for three centuries','a corrupted archdruid who wants to unmake civilisation'],
        dark_fantasy:['a plague-priest who believes suffering is salvation','a flesh-sculptor using the dead to build a new race','a noble house that has practiced blood magic in secret for generations','a demon bound to a child\'s body','a mirror-entity replacing important people one by one'],
        political:   ['a chancellor engineering a succession crisis','a foreign ambassador funding both sides of a civil war','a merchant consortium owning the debt of every major city','a spy network whose leader has been dead for ten years','a cult that has infiltrated the clergy and the court'],
        horror:      ['something that wears human faces but doesn\'t understand expressions','a sound that makes listeners forget who they love','a house that appears wherever someone is about to die','an entity from before names that is learning what names mean'],
        mystery:     ['the city\'s most beloved philanthropist','the investigating magistrate','the victim — who is not, in fact, dead','the party\'s own employer','the last surviving heir of a family everyone thought extinct'],
        war:         ['a general who wins by sacrificing his own men','a weapons-smith supplying both sides','a spy who has forgotten which nation she originally served','a child soldier who grew up and became a warlord'],
        redemption:  ['a former villain seeking to undo the harm they caused','the very party — their past actions set this in motion','a monster who was once a good person and remembers it'],
        heist:       ['the vault\'s architect, who built a second door','the fence who arranged the job and the actual client behind them','an insider on the crew who has been compromised'],
        cosmic:      ['a god that is not evil, just utterly alien in its priorities','something that has been asleep since before the world and is nearly awake','a cult whose ritual is the correct response to what they have seen'],
        romance:     ['circumstance, duty, and the cruelty of timing','a beloved rival who wants the same things but differently','the protagonist\'s own unwillingness to accept happiness'],
        martial_arts:['a grandmaster who believes the party must be broken to be worthy','a rival school hunting the last keeper of a forbidden technique','a warlord who has turned the sacred arts into a weapon of conquest','a former student who stole a killing form and now teaches it to outcasts','an immortal who has grown bored and pits disciples against each other'],
        sword_and_sorcery:['a sorcerer-queen who has already outlived three kingdoms','a barbarian warlord with a demon-bound blade','a thief-king who rules from the shadows of a dying city','a serpent-cult high priest drawing power from an ancient pit','a renegade wizard selling spells to the highest bidder'],
        urban_fantasy:['a hidden council that has run the city for centuries','a fae lord who believes mortals owe him a tithe','a vampire clan fighting a silent war over territory','a mage who has erased himself from memory but not from consequence','a detective who is not human and is closing in on the party'],
        fairy_tale:['a stepmother who made a deal with something old','a beast that was once a prince and prefers it this way','a witch who trades in names and has already taken one','a huntsman who serves the wrong master','the forest itself, which has grown tired of being crossed'],
        naval:       ['an admiral who has sold the fleet to privateers','a sea-witch who drowns ships that refuse her tribute','a rival captain with a letter of marque and no conscience','a mutinous first mate who has already chosen the next captain','a leviathan that has been awakened by deep-water mining'],
        western:     ['a railroad baron buying the law one town at a time','a gunslinger who has come back from the dead — literally','a sheriff who is the only thing standing between the town and chaos','a bandit king with a grudge and a map to something buried','a cult that has claimed the high desert and the water rights'],
        post_apocalyptic:['a warlord who has built an empire on rationed hope','a cult that worships the cause of the fall and wants to repeat it','a machine-mind in a bunker that has redefined \"survivor\"','a trader syndicate that controls the only clean water','a prophet who is right about the next catastrophe and wrong about the cure'],
        courtly_intrigue:['the queen\'s favourite, who has been playing both sides','a foreign ambassador with a poison that leaves no trace','the heir who is not the heir, and the proof is in a vault','a spymaster who reports to someone the court has never heard of','a jester who is the only one who speaks truth and is never believed'],
        dungeon_crawl:['whatever built the dungeon — and is still adding to it','a rival party that entered from another entrance','a curse that binds the dead to guard the depths','a patron who sent the party in to die for a reason','the dungeon itself, which is alive and testing intruders'],
        high_magic:  ['an archmage who has rewritten the local laws of magic','a cabal that trades in spell-components that should not exist','a sentient artifact that is choosing its next wielder','a plane-hopping entity that treats the world as a waystation','a wizard who has already seen the party\'s end and is working backward'],
        low_magic:   ['a witch-hunter who has found real magic at last','a noble house that hoards the last working rituals','a creature that feeds on spellcraft and has left the land barren','a scholar who has pieced together a ritual that could restore magic — at a cost','a curse that makes magic backfire on the caster'],
        no_magic:    ['a general who has never lost a battle and intends to keep it that way','a champion who has sworn to end the last remnant of the old magic','a bandit king with an army and a grudge','a corrupt magistrate who has sold the law to the highest bidder','a rebellion that has turned into something the party must choose sides in'],
        ritual_magic:['a circle that has been performing the same ritual for decades','a cult that needs one more sacrifice to complete the binding','a scholar who has found a ritual that works — and does something else','an entity that can only be reached by ritual and has been waiting','a village that has been paying a tithe in blood to keep something asleep']
    },
    goals:['uncover who murdered their mentor','save a city that has already lost hope','stop a ritual that will unmake the boundary between worlds','find the heir to a throne before rivals kill them','recover an artifact that holds a god\'s true name','prevent a war nobody in power wants to prevent','break a generational curse on their bloodline','find the truth behind a lie the entire world believes'],
    hooks:{
        epic_fantasy:  ['A letter arrives sealed with a crest that should not exist — the family it belongs to died out a century ago.','A travelling merchant offers something for sale: a map that ends at a door that cannot exist in the geography described.','The stars have shifted. Every astronomer and navigator in the city is quietly panicking.'],
        dark_fantasy:  ['Three priests of the same temple are found dead inside a locked sanctuary. The doors were bolted from inside. The candles are still burning.','Someone has been posting notices in the city listing people\'s secrets. Accurate ones. They appear faster than they can be torn down.','A healer\'s patients are recovering faster than medicine allows. The healer is delighted. The patients are changing.'],
        political:     ['The Prime Minister invites the party to a private dinner and is found dead at the table before the second course.','A document surfaces that would transfer ownership of the entire city to an entity that has been dead for sixty years.','The election results arrive. They match, impossibly precisely, with results published before voting began.'],
        horror:        ['You wake and cannot remember yesterday. Neither can anyone else. The date on every calendar is wrong by one day.','The animals left town three days ago. Nobody noticed until now.','Someone knocks. When you open the door, nobody is there. When you close it, the knock comes again.'],
        mystery:       ['A body in a locked room with no sign of entry, no sign of struggle, and a smile on its face.','Twelve people all dream the same dream on the same night. One of them is missing in the morning.','A famous painting has been replaced with a perfect forgery — except the forgery shows a scene that hasn\'t happened yet.'],
        war:           ['The ceasefire has held for six months. Both sides are quietly furious about it.','A supply convoy carrying only medicine is attacked and burned. No witnesses. No survivors. No demands.'],
        redemption:    ['A letter arrives from someone who should not be able to write it. It says only: I know what you did. I forgive you. Come.','An old enemy appears, alone and unarmed, and asks for help with something that would benefit everyone.'],
        heist:         ['A job offer arrives via a method that should have been impossible. The money is extraordinary. The target officially doesn\'t exist.','A client arrives with the blueprint of a vault, the guard schedule, and a confession: they built it.'],
        cosmic:        ['A scholar discovers that recorded history ends in a specific way at a specific date — in every library, in every language.','Every oracle, prophet, and seer in the world goes silent on the same day. Three days later, they all say the same thing.'],
        romance:       ['A letter misdelivered. Read by accident. Too late to unread.','Two people reach for the same book in a library of ten thousand volumes.'],
        martial_arts:  ['A scroll containing the final form of a lost style has surfaced. Three schools have already sent assassins.','The grandmaster is dying. The succession will be decided by trial — and the party is invited.','A disgraced disciple has returned, stronger than before. The technique they use was forbidden for a reason.'],
        sword_and_sorcery:['A gem that can bind a demon is missing from the temple. The buyer is already using it.','The barbarian horde is not random. Someone is guiding them toward the one city that can stop them.','A map leads to a vault that should not exist. The map is correct.'],
        urban_fantasy:  ['The veil between worlds is thin in one district. Something is crossing over — and not by accident.','A missing person case leads to a list of names. The party is on it.','The council has declared someone guilty. The evidence is real. So is the frame.'],
        fairy_tale:    ['A curse can be broken by a single act — but the curse has forgotten what that act is.','The forest has taken someone. The path in changes every time.','A bargain was made generations ago. The other party has come to collect.'],
        naval:         ['A ship went down with something that should not have been on the manifest. Someone is still paying to keep it quiet.','The admiralty has ordered a convoy through waters that have already claimed three ships.','A captain has gone rogue with a hold full of prisoners and a destination that is not on any chart.'],
        western:       ['The railroad is coming. So is the man who has bought every deed in its path.','A wanted poster goes up. The face is familiar. The crime is not.','Someone has been digging in the old mine. What they found is still moving.'],
        post_apocalyptic:['A broadcast from the old world repeats every night. The date is in the future.','The water supply has been poisoned. The antidote exists — in a vault that was sealed when the world ended.','A convoy is coming. They are not traders. They are recruiters.'],
        courtly_intrigue:['The heir has been challenged. The proof of legitimacy is in a document that has just been stolen.','A dinner is planned. The guest list includes someone who is already dead.','The treaty was signed. One of the signatories was not who they claimed to be.'],
        dungeon_crawl:  ['The entrance was sealed for a reason. Something inside has found another way out.','A previous party left markers. They lead to a chamber that is not on any map.','The dungeon has a keeper. They have just invited the party in.'],
        high_magic:     ['A spell was cast that has no known counter. The caster is missing.','The ley-lines have shifted. Every mage in the city felt it. One of them caused it.','An artifact has chosen a new bearer. The previous one is not pleased.'],
        low_magic:      ['The last working ritual is in the hands of someone who does not understand it.','A witch-hunter has found a real witch. The witch has found something worse.','Magic is returning. The thing that ate it is returning first.'],
        no_magic:       ['The general has never lost. The next battle will be the last — unless someone changes the board.','A champion has sworn to end the last remnant of the old world. The party is in the way.','The law has been bought. The only evidence that can undo it is in the hands of the guilty.'],
        ritual_magic:   ['The ritual requires a component that no longer exists — or so everyone thought.','A circle has been performing the same ritual for years. Last night something answered.','The binding is failing. The entity inside has made an offer to the one who can complete it.']
    },
    plots:{
        epic_fantasy:  ['The antagonist is assembling fragments of a weapon that, legend says, killed a god. They are three pieces away.','A sleeping army waits beneath a mountain. The ritual to wake them requires something the party currently possesses.'],
        dark_fantasy:  ['Someone is methodically eliminating everyone who knows a specific truth. The party has just learned it.','A plague that only affects people with a specific bloodline is being deliberately spread. Someone wants that bloodline gone.'],
        political:     ['The succession is compromised. Every legitimate heir is dead, missing, or compromised. Someone engineered this.','An alliance treaty gives a foreign power rights that, with the right interpretation of one clause, amount to ownership.'],
        horror:        ['The town\'s missing persons reports go back thirty years. The descriptions are always the same. So is the location they were last seen.','People are disappearing from their beds. They return three days later with no memory — and no shadow.'],
        mystery:       ['Every lead points to the same man. He has been dead for eleven years. The evidence is fresh.','The witnesses all agree on every detail. That\'s the problem. Nobody remembers the same event the same way.'],
        war:           ['Both sides believe they are winning. Neither has accurate intelligence. The real enemy is watching both.','The battle that started this war never happened. The records were forged. Someone needs it to stay forgotten.'],
        redemption:    ['The person who wronged the party is now the only one who can save them.','Fixing the harm means confessing to it first — publicly, completely, with full consequences.'],
        heist:         ['The item doesn\'t exist in the vault. It never did. The vault itself is what they\'re really after.','The crew\'s inside contact has been playing both sides for months. They\'re not entirely wrong to.'],
        cosmic:        ['The ritual will work. That is the problem. The thing it summons is the answer to something even worse.','The entity isn\'t hostile. It simply has no concept that other things have interiority. That is what makes it dangerous.'],
        romance:       ['They want the same thing. They cannot both have it.','Every attempt to resolve this has made it worse. They both know it. Neither can stop.'],
        martial_arts:  ['The final trial is not a duel. It is a choice that will define the school for a generation.','The forbidden technique can be neutralised — but only by someone who has mastered it.','The grandmaster\'s killer is still in the compound. So is the heir they came for.'],
        sword_and_sorcery:['The sorcerer-queen is not the real threat. The thing she serves is.','The demon-bound blade can be broken — in a place that no mortal has returned from.','The thief-king has already stolen what the party came for. They have to steal it back from him.'],
        urban_fantasy:  ['The council\'s law is absolute. The party has just broken it. The punishment is not death — it is service.','The fae lord\'s tithe can be paid with something the party does not know they have.','The detective is not closing in on the party. They are closing in on what the party is protecting.'],
        fairy_tale:    ['The curse can be broken. The cost is that someone else must take it on.','The forest has not taken someone. It has been waiting for someone. The party fits.','The bargain can be voided — if the party can prove it was made under duress. No one has managed that yet.'],
        naval:         ['What went down with the ship is still down there. And it has been growing.','The admiralty\'s order is a trap. The real mission is to find out who gave it.','The rogue captain is not running. They are leading something back to port.'],
        western:       ['The railroad baron has already bought the law. The only thing left is to change the facts.','The gunslinger came back for a reason. The reason is in the town.','The cult does not want the water. They want what is under it.'],
        post_apocalyptic:['The broadcast is not from the past. It is a countdown.','The vault was sealed for a reason. What is inside is the only thing that can stop what is coming.','The recruiters are not building an army. They are building a sacrifice.'],
        courtly_intrigue:['The document was not stolen. It was never written. The forger is still at court.','The dead guest is the key. Someone needed them to be seen at that dinner.','The signatory was an imposter. The real one is in a cell — or a grave.'],
        dungeon_crawl:  ['What is adding to the dungeon is also what sealed the entrance. It wants the party inside.','The rival party did not enter from another entrance. They were never meant to leave.','The keeper is not hostile. They are the only one who knows how to close the dungeon for good.'],
        high_magic:     ['The archmage\'s rewrite has a flaw. Finding it requires breaking a law that has never been broken.','The artifact has already chosen. The party is not the chosen. They are the trial.','The wizard is not working backward from the end. They are working toward it.'],
        low_magic:      ['The last ritual is incomplete. Completing it will restore magic — and wake the thing that ate it.','The witch-hunter has found a real witch. The witch has found a way to turn the hunt.','The curse can be transferred. The party has just become the only viable vessel.'],
        no_magic:       ['The general can be beaten. The cost is that someone must become what they hate.','The champion\'s oath can be fulfilled. The last remnant is not a thing — it is a person.','The rebellion has a leader. The party has just learned who they really are.'],
        ritual_magic:   ['The component exists. It is inside someone the party knows.','What answered the ritual was not what the circle was calling.','The entity\'s offer is genuine. Accepting it will save everyone — except the one who accepts.']
    },
    complications:['An ally reveals a conflicting agenda at the worst possible moment','The evidence points to someone the party trusts','The reward turns out to be contingent on something nobody disclosed','A time limit is introduced that changes the entire calculus','The enemy knows the party is coming — and has had time to prepare','Something the party did earlier created this problem','A third party intervenes with their own agenda','The method that would work is one the party swore never to use','Someone needs to be left behind','The information was wrong from the start — but not by accident'],
    climax:{
        epic_fantasy:  'The final confrontation takes place where the story began. The antagonist has already won one thing the party can never recover. The victory, if it comes, will cost something real.',
        dark_fantasy:  'The monster is stopped — but the conditions that created it remain. Someone in the party knows this. The celebration will feel hollow.',
        political:     'The vote is cast. The evidence is presented. The right person loses anyway. The party must decide what justice looks like when institutions fail.',
        horror:        'The threat is ended. But one party member remembers something the others don\'t. They are not certain it is a memory.',
        mystery:       'The culprit is named. They had a reason. Not a good one, but a human one. The party has to decide what to do with that.',
        war:           'The battle is won. The cost is tallied. The party discovers what their side did to win. It is not what they were told.',
        redemption:    'Redemption is possible. It requires giving up the one thing the character has been holding onto. They have to choose.',
        heist:         'The job is done. The score is split. One member of the crew got something nobody else knows about. They are not sure they want it.',
        cosmic:        'The entity is contained — for now. Someone reads what was written in the place it came from. The document predates human writing.',
        romance:       'The obstacle is gone. The characters still have to choose each other. That part was never the obstacle.',
        martial_arts:  'The final confrontation is not about winning. It is about what the victor chooses to do with the victory — and what they leave behind.',
        sword_and_sorcery:'The sorcerer falls. The blade breaks. Something that was bound to it is free. The party has to decide what to do with that.',
        urban_fantasy:  'The council is satisfied. The veil is restored. One party member knows the cost was not what was agreed. They have to live with it.',
        fairy_tale:    'The curse is broken. The forest remembers. The party has to decide whether to take the road back or the one that was never on the map.',
        naval:         'The ship is saved. The cargo is accounted for. What was in the hold was never on the manifest. Someone will come for it.',
        western:       'The railroad is stopped — or built. The town has changed either way. The party has to decide what they are when the dust settles.',
        post_apocalyptic:'The vault is open. The antidote is real. What else was in the vault has been loose for longer than anyone knew.',
        courtly_intrigue:'The document is produced. The heir is legitimised — or exposed. The court will believe what it chooses. The party has to live with what they did.',
        dungeon_crawl:  'The keeper is satisfied. The dungeon is sealed — or opened for good. What was inside has made its choice. So has the party.',
        high_magic:     'The archmage falls. The laws of magic shift. The party has to decide whether to restore what was or accept what is.',
        low_magic:      'Magic returns — or it does not. The cost has been paid. Someone in the party knows it was too high.',
        no_magic:       'The general is defeated. The champion\'s oath is fulfilled. What comes next has no script. The party writes it.',
        ritual_magic:   'The ritual is complete. What answered is bound — or binding. The circle has one choice left. So does the party.'
    },
    npcRoles:['a disgraced archivist who knows where the evidence is buried','a mercenary who has already taken money from the other side','a priest whose faith is intact but whose god is not listening','a noble child who witnessed something they cannot explain','a former spy who retired too early','a healer who keeps dangerous knowledge out of necessity','a magistrate who knows the verdict is wrong and will deliver it anyway','an innkeeper who has heard everything and told no one'],
    worldDetails:['The local calendar skips a week that historians cannot account for','A river here flows the wrong direction — has done so for three generations','The old quarter of the city was rebuilt from a blueprint nobody can find the original of','There is a law on the books that nobody enforces and nobody will repeal','The town\'s founding families all share one uncommon surname — nobody talks about why','A treaty signed here a century ago contains a clause that has never been triggered','The local dialect has a word for a specific kind of grief that no other language has borrowed'],
    dialogue:{
        confrontation:['\'You had every chance to stop this,\' she said. \'You chose to watch.\'','\'I didn\'t come here to be understood,\' he said. \'I came here because you owe me.\'','\'The question isn\'t whether you can,\' she said quietly. \'It\'s whether you will. Again.\''],
        revelation:   ['\'You already knew,\' she said. It wasn\'t a question.','\'I\'ve been waiting for someone to ask that,\' he said. \'For eleven years.\'','She set down the document. \'Read the last paragraph,\' she said. \'Then tell me what you think you\'re doing here.\''],
        quiet:        ['\'Some things you don\'t talk about. You just carry them.\'','\'I didn\'t know it was wrong until it was over,\' he said. \'That\'s the worst part.\'','\'I keep thinking there was a moment,\' she said. \'Where I could have done something different. I can\'t find it.\''],
        action:       ['\'Don\'t explain. Move.\'','\'If this works, we never speak of it.\'','\'How close to impossible are we talking?\'']
    },
    questTypes:{
        assassination: {label:'Assassination',icon:'🗡',color:'#dc143c'},
        retrieve:      {label:'Retrieve / Heist',icon:'💰',color:'#b8860b'},
        escort:        {label:'Escort / Protect',icon:'🛡',color:'#2e86ab'},
        investigate:   {label:'Investigate',icon:'🔍',color:'#6a0dad'},
        rescue:        {label:'Rescue',icon:'⚔',color:'#cc5500'},
        explore:       {label:'Explore / Clear',icon:'🗺',color:'#228b22'},
        defend:        {label:'Defend / Siege',icon:'🏰',color:'#8b4513'},
        political:     {label:'Political Intrigue',icon:'👑',color:'#4a0080'},
        curse:         {label:'Curse / Corruption',icon:'💀',color:'#2f4f4f'},
        war:           {label:'War / Conflict',icon:'⚔',color:'#8b0000'},
        divine:        {label:'Divine / Religious',icon:'✝',color:'#daa520'},
        criminal:      {label:'Criminal Underworld',icon:'🗡',color:'#363636'},
        revenge:       {label:'Revenge Quest',icon:'☠',color:'#8b0000'},
        infiltration:  {label:'Infiltration / Spycraft',icon:'🕶',color:'#3f4a5a'},
        diplomacy:     {label:'Diplomacy / Negotiation',icon:'🤝',color:'#4b7f8f'},
        ritual:        {label:'Ritual / Arcane Crisis',icon:'🜂',color:'#7a3ea8'},
        horror_hunt:   {label:'Horror Hunt',icon:'🩸',color:'#7a0000'},
        '':            {label:'Random Quest',icon:'🎲',color:'#b8860b'}
    },
    questClients:['a haunted merchant who won\'t say what they lost','the local magistrate, working outside their jurisdiction','a hooded figure who paid in advance','a dying noble with one last request','a child who found something they shouldn\'t have','an anonymous letter with an unusually specific map','a priest acting on behalf of their temple — without permission','a guild representative with a story that doesn\'t quite add up','a former adventurer who retired after losing something precious','a scholar who discovered something dangerous in ancient texts','a merchant whose caravan was attacked and needs protection','a town mayor desperate to solve a problem before elections','a mysterious benefactor who communicates only through intermediaries','a family member seeking revenge for a past wrong','a temple acolyte who believes their deity has given them a vision','a criminal who wants to go straight but needs one last favor','a noble house trying to maintain their reputation','a group of refugees who need help establishing a new settlement','a dragon who has taken human form to request assistance','a fey creature bound by ancient pacts','a ghost who cannot rest until a task is completed','a group of rebels planning to overthrow a corrupt government','a merchant guild trying to expand their influence','a religious order investigating heresy','a royal spy who needs deniable assets','a cursed individual seeking a cure','a parent searching for their missing child','a scholar who needs protection while researching dangerous magic','a group of veterans trying to prevent another war','a druid circle protecting a sacred grove'],
    questTwists:['The target is already dead — has been for weeks','The client is involved more deeply than they admitted','Someone on the inside is feeding information to the enemy','The reward was never real','A third party wants the same thing and got there first','The location has already been searched — recently','What they\'re looking for was moved. By the party. Two sessions ago.','The antagonist had the same information and the same reasons','The client is actually the villain testing the party','The quest is a trap designed to eliminate the party','The item they seek is cursed and will bring disaster','The client has been replaced by a doppelganger','The quest conflicts with another obligation the party has','The reward belongs to someone else who will want it back','The location is protected by something the client didn\'t mention','The target is actually innocent and the client knows it','The quest is part of a larger conspiracy','The client is being blackmailed into hiring the party','The reward is stolen property that will be recognized','The quest will start a war if completed','The client is working for the enemy','The item is a key to something much larger','The quest is a test of the party\'s morality','The client will betray the party once they succeed','The target is someone the party knows','The quest violates a law the party didn\'t know about','The reward is cursed and will bring misfortune','The client is actually multiple people working together','The quest is a distraction from the real threat','The location is a trap that will seal the party inside'],
    questRewards:['1d6 × 50 gp per character + a letter of introduction to a useful contact','A map with one location marked that the client claims they\'ve never visited','300–500 gp and first right of refusal on a future job','Access to a private vault with one item the client refuses to name in advance','Political favour worth more than coin — in the right circumstances','An item recovered during the job that the client says nothing about','A magical item appropriate to the quest difficulty','Information about a future threat or opportunity','A favor from a powerful organization','Membership in an exclusive guild or order','A deed to property in a strategic location','A contact who can provide rare services','A share in a profitable business venture','Training in a rare skill or technique','A boon from a powerful entity','Protection from a dangerous organization','A key to a hidden location','A secret that could change the political landscape','An introduction to someone important','A promise of future assistance when needed','A rare material component for spellcasting','A book containing lost knowledge','A weapon or armor of historical significance','A pet or companion with special abilities','A blessing that provides a minor permanent benefit','A curse removal service','A safe house in multiple cities','A network of informants','A title or rank in an organization','A magical contract that guarantees future cooperation'],
    sideQuests:[
        {type:'Personal',hook:'A party member\'s past catches up to them in an unexpected way.'},
        {type:'Local',hook:'Someone in the nearest settlement has a problem that isn\'t urgent — until it is.'},
        {type:'Discovery',hook:'Something found during the main quest opens a question that the quest didn\'t answer.'},
        {type:'Moral',hook:'The right thing and the useful thing are not the same thing. The party has to choose.'},
        {type:'Rival',hook:'Another group is working the same job for different reasons. They\'re not hostile. Yet.'},
        {type:'Consequence',hook:'Something the party did earlier has come back around. Not in a catastrophic way. Just inconveniently true.'}
    ],
    locTypes:{
        tavern:         {label:'Tavern / Inn',       icon:'🍺', color:'#8b4513'},
        blacksmith:     {label:'Blacksmith',          icon:'⚒',  color:'#696969'},
        general_store:  {label:'General Store',       icon:'🛒', color:'#8b6914'},
        temple:         {label:'Temple / Shrine',     icon:'⛪', color:'#daa520'},
        guild_hall:     {label:'Guild Hall',          icon:'🏛', color:'#4169e1'},
        market:         {label:'Market Square',       icon:'🏪', color:'#228b22'},
        library:        {label:'Library / Archive',   icon:'📚', color:'#6a0dad'},
        dungeon_entrance:{label:'Dungeon Entrance',   icon:'⚔',  color:'#8b0000'},
        noble_manor:    {label:'Noble Manor',         icon:'🏰', color:'#b8860b'},
        thieves_den:    {label:'Thieves Den',         icon:'🗡', color:'#2f2f2f'},
        barracks:       {label:'Barracks / Garrison', icon:'⚔',  color:'#8b0000'},
        magic_shop:     {label:'Magic Shop',          icon:'✨', color:'#6a0dad'},
        docks:          {label:'Docks / Harbour',     icon:'⚓', color:'#006994'},
        graveyard:      {label:'Graveyard',           icon:'💀', color:'#2f4f4f'},
        forest_clearing:{label:'Forest Clearing',     icon:'🌲', color:'#228b22'},
        cave:           {label:'Cave / Cavern',       icon:'🕳', color:'#4a3728'},
        ruins:          {label:'Ancient Ruins',       icon:'🏚', color:'#708090'},
        adventuring_guild:{label:'Adventuring Guild', icon:'⚔', color:'#b8860b'}
    },
    locDetails:{
        tavern:         ['The barkeep knows three things about everyone who walks in and will trade one for information','A fire has been burning in the hearth since the establishment opened — the owner considers it bad luck to let it go out','The back room is booked until next month. Nobody knows by whom.','The regulars have a betting pool on the party. They\'ve been watching since the door.'],
        blacksmith:     ['The anvil is older than the town. The smith refuses to discuss where it came from.','A sword is being held for collection — the customer hasn\'t returned in six weeks','The smith has a policy: no questions about what they\'ve made. No exceptions.','The smoke from this forge smells different. The smith says it\'s the coal.'],
        temple:         ['The offering box has been broken into twice this month. Nothing was taken.','One of the murals in the vestibule shows a scene that contradicts the official doctrine.','The head priest refuses to see anyone after sundown. The juniors will not explain why.','There is a door in the crypt that predates the temple by at least two centuries.'],
        library:        ['A section of the catalogue references books that aren\'t on the shelves — and haven\'t been for forty years','The archivist knows where everything is but will not write it down','One reading room is always occupied. Always the same figure. Never the same book.','There\'s a restricted section. The restriction order was signed by someone who died before the library was built.'],
        dungeon_entrance:['Fresh torch sconces. Someone was here recently.','A camp just outside the entrance — abandoned, but the fire is still warm','The inscription above the door is in a language that predates the civilisation that supposedly built this place','Something has been dragged out, not in. The tracks are recent.'],
        noble_manor:    ['The portraits in the gallery are all of the same person at different ages. The dates don\'t add up.','The staff answers every question politely and says nothing','The guest wing hasn\'t been opened in three years. The rooms are still made up.','A room on the third floor is locked. The current lord says he\'s never had a key.'],
        thieves_den:    ['Everyone here knows the party\'s names. Nobody will say how.','The back wall has a door that leads somewhere that shouldn\'t be there geographically','The bartender prices things differently depending on who\'s asking. The logic isn\'t clear.','A meeting just ended. The attendees left separately and quickly.'],
        market:         ['One stall sells things you didn\'t know you needed until you saw them. The vendor is never there twice.','A pickpocket who\'s very bad at it, but very persistent, and visibly desperate','The prices in this quarter are lower than they should be. Nobody talks about why.','There\'s a crowd gathered around nothing. It disperses before the party gets close.'],
        graveyard:      ['One section of headstones has had the names carefully removed','A fresh grave with no marker. The soil is still soft.','Someone has been leaving offerings at a grave that\'s been there for eighty years','The groundskeeper lives in a small house at the edge. They do not sleep at night.'],
        ruins:          ['The stonework was done by hands that didn\'t have five fingers','Writing on the walls — not inscribed, grown into the stone itself','A room that is perfectly clean. No dust. No debris. Just empty.','The deeper rooms are older than the surface ones. That\'s the wrong way around.'],
        cave:           ['The walls have been worn smooth by something that was never water','A sound from deeper in that stops exactly when you stop to listen','Someone has been living here recently. The signs are deliberate — a warning or an invitation','The air smells like the sea. The coast is thirty miles away.'],
        forest_clearing:['The trees at the edge of this clearing grow away from it, not toward it','Something has been sacrificed here recently. Ritually, not violently.','The grass here is a different colour than the grass ten feet away. Has been for generations.','A stone with no inscription, placed deliberately. The ground around it doesn\'t grow anything.'],
        magic_shop:     ['Everything is labelled. Nothing is priced.','The shopkeeper already knew what the party needed before they asked','One item in the back looks wrong — out of place, not quite real-looking','The shop was not here yesterday. The shopkeeper seems unsurprised you noticed.'],
        barracks:       ['Two soldiers are talking quietly and stop when the party enters','The duty roster has a name crossed out. Recently.','The armoury door is locked from the inside. Has been for three days.','Someone has drawn a map on the wall of the mess hall. It\'s accurate. Nobody knows who did it.'],
        docks:          ['A ship arrived last night with no crew. The cargo manifest lists nothing.','A captain is paying over the odds for a quick and quiet departure','The harbourmaster\'s log has pages missing — not torn, removed with a knife','Someone has been watching the docks from the same window for two days'],
        guild_hall:     ['The current contract board has one job that\'s been up for six months — crossed out twice and reposted','The senior members\' portraits have been rearranged. Nobody admits doing it.','There\'s a member on the roster who no one recognises and no one will question','The basement vault is guarded. Has been for three months. Nobody knows what\'s in it.']
    },
    npcNames:{m:['Aldric','Bram','Caius','Davan','Eryn','Falken','Gareth','Hadwin','Iorwen','Joren','Kael','Lorcan','Mattias','Neven','Oswyn','Pell','Rynn','Seren','Torvald','Vane','Wren','Zander'],f:['Aela','Brynn','Corra','Daya','Elara','Fern','Gwynn','Haela','Isra','Julla','Kira','Lira','Mira','Nora','Orla','Petra','Reva','Saya','Tessa','Vira','Willa','Zara'],sur:['Aldmoor','Blackthorn','Crestfall','Dunwood','Eldermarsh','Falcrest','Greywall','Holt','Ironmark','Jade','Kestrelmere','Longbow','Moorfield','Nighthollow','Oakenfall','Penn','Ravenwood','Stonemark','Thorn','Umbervale','Vale','Windhall']},
    npcRoleDetails:{
        ally:       {traits:['loyal but with conditions','protective of someone they\'ve never mentioned','owes a debt they haven\'t disclosed','was on the other side once'],secrets:['their loyalty has a price point they haven\'t reached yet','someone important to them is currently in the antagonist\'s hands','they know something about the party that the party doesn\'t']},
        villain:    {traits:['believes they are correct','has already tried the other options','is tired','had something taken from them first'],secrets:['their goal and the party\'s goal are the same','they know the party\'s weakness in detail','they\'ve already won something — they\'re just not done']},
        merchant:   {traits:['fair to people who are fair to them','has dealt with worse than the party','knows everyone\'s price','has had this conversation before'],secrets:['they fence goods they won\'t admit to','they\'re being extorted and won\'t say by whom','the thing they\'re selling isn\'t theirs to sell']},
        noble:      {traits:['polite as a weapon','never says what they mean directly','has already decided the outcome of this meeting','is under more pressure than they\'re showing'],secrets:['their position is inherited and they\'re not qualified for it','someone in their household is feeding information out','they have evidence of something they can\'t use without destroying themselves']},
        guard:      {traits:['tired','follows orders until they don\'t','has seen this end badly before','is being paid more than usual to be here'],secrets:['was told something specific about the party before they arrived','the orders they\'re following contradict an earlier set','they looked the other way once and haven\'t stopped thinking about it']},
        priest:     {traits:['genuinely believes — which makes them dangerous','knows things through confession they cannot use','is kind to people they don\'t approve of','has been waiting for something like this'],secrets:['their faith has been tested in a way their superiors don\'t know about','they performed a rite they don\'t have the authority to perform','the god they serve may have answered — they\'re not sure what that means']},
        scholar:    {traits:['right more often than is polite','has the information but will negotiate access','is working on something they won\'t name','considers the party\'s situation academically interesting'],secrets:['they\'re the source of knowledge the antagonist has been using','the research they\'re protecting has already caused harm','they\'ve known about the party\'s situation for longer than possible']},
        criminal:   {traits:['professional','has a code that is not the one you\'d expect','is currently working two jobs that don\'t know about each other','isn\'t paid enough for this'],secrets:['they were hired for this specifically — before the party was involved','they know who the real client is','they\'ve already been caught once and made a deal']},
        mysterious: {traits:['knows more than they should','asks questions instead of answering them','is always where they need to be','has been watching the party for longer than the party has been a party'],secrets:['they are what the antagonist is looking for','they\'ve done this before — in another city, with another group','they are not here by coincidence']},
        informant:  {traits:['nervous','accurate','expensive','will not put anything in writing'],secrets:['they\'re also informing on the party','the person they\'re protecting is the one the party is looking for','they know the endgame and they\'re buying time']}
    },
    npcAttitudes:{
        friendly:   'Warm — will share information freely, may ask a small favour in return',
        neutral:    'Cautious — will engage but measures every word. Wants to understand the angle.',
        suspicious: 'Guarded — assumes the worst until proven otherwise. Will test the party before helping.',
        hostile:    'Antagonistic — will not cooperate without significant leverage or a compelling reason.',
        desperate:  'Urgent — needs something badly enough to accept help from anyone. May not disclose the full situation.',
        secretive:  'Oblique — speaks in implication. What they don\'t say is as important as what they do.'
    },
    storyTitles: {
        epic_fantasy:['The Throne of Ash','The Shattered Crown','When Kingdoms Fall','Blood of the Old Kings','The Sundered Gate','The Weeping Citadel','The Last Oath','Where the Old Gods Sleep','The Crown of Embers','The Serpent Road'],
        dark_fantasy: ['What the Dark Remembers','The Pale City','In the House of Hours','The Quiet Wickedness','What Remains','The Drowning Hall','Bone and Shadow','The Price of Silence','No Dawn in the North','The Hollow Crown'],
        political:    ['The Third Candidate','Debts of State','Behind the Seal','What the Chancellor Knew','The Quiet Parliament','The Poisoned Accord','Heirs and Usurpers','The Empty Seat','A Knife at the Feast','The Regent\'s Gambit'],
        horror:       ['The Hollowing','What Knocks','Before the Face','The Repeating Dark','What Came Back','The House That Waits','Nothing Under the Stairs','The Last Dream','When the Lights Go Out','The Thing That Wore Her Face'],
        mystery:      ['The Smiling Dead','No Sign of Entry','The Second Map','The Correct Suspect','Before the Last Witness','The Locked Room','The Missing Hour','The Wrong Corpse','The Witness Who Wasn\'t There','The Letter That Wrote Itself'],
        war:          ['The Useful Dead','No Man\'s Orders','The Last Ceasefire','What the General Planned','The Patient Enemy','The Winter Siege','Broken Banners','The Deserters\' Road','One Battle Too Many','The Peace That Wasn\'t'],
        redemption:   ['What Can Be Repaid','The Long Walk Back','One Right Thing','After the Harm','Enough','The Debt of Blood','The Second Chance','What Was Taken','The Penitent Road','The Last Good Act'],
        heist:        ['The Architect\'s Second Door','The Perfect Job','No Witnesses','The Inside Client','The Real Score','The Unstealable Gem','Double Cross','The Vault Beneath the Vault','One Night in the Tower','The Getaway That Wasn\'t'],
        cosmic:       ['Before Names','What Sleeps Beneath','The Last Recorded Date','When It Arrives','Without Witnesses','The Stars That Lie','What the Void Remembers','The Geometry of Madness','The Dreamer in the Deep','When the Sky Forgets'],
        romance:      ['The Wrong Letter','The Same Book','What Was Almost Said','The Honest Answer','Despite Everything','The Masked Ball','The Rival\'s Blessing','What Love Costs','The Last Letter','The Choice at Dawn'],
        noir:         ['Rain Over Blackcourt','Ledger of Ghost Debts','City of Wet Alleys','The Fourth Alibi','Night Clerk\'s Secret','The Dame Who Knew Too Much','Blood on the Ledger','The Fixer\'s Last Job','Smoke and Mirrors','The Detective\'s Mistake'],
        exploration:  ['Beyond the Last Marker','The Cartographer\'s Debt','Where the Road Ends','Frontier of Broken Stars','The Seventh Horizon','The Map That Bleeds','First Contact','The Lost Colony','The Edge of the World','What the Scouts Didn\'t Return'],
        survival:     ['Cold Teeth of Dawn','No Fire Tonight','The Last Ration','Tracks in the White Dark','Only the Wind Answers','The Long Winter','Shelter or Speed','The Last Bullet','When the River Freezes','Nothing Left to Burn'],
        martial_arts: ['The Final Form','The Broken Scroll','The Grandmaster\'s Trial','The Forbidden Technique','The School of the Lost','The Disciple\'s Return','One Strike Too Many','The Empty Dojo','The Trial of the Heir','The Last Kata'],
        sword_and_sorcery:['The Demon-Bound Blade','The Sorcerer-Queen\'s Price','The Thief-King\'s Vault','The Serpent Pit','The Barbarian Road','Blood and Sand','The Dying City','The Renegade\'s Spell','The Gem That Binds','The Map That Leads Nowhere'],
        urban_fantasy: ['Where the Veil Thins','The Council\'s Law','The List of Names','The Frame','The Tithe','The District of Crossings','The Detective Who Wasn\'t','The Missing Evidence','The Hidden Council','The Fae Lord\'s Due'],
        fairy_tale:   ['The Curse That Forgot','The Path That Changes','The Bargain Come Due','What the Forest Took','The Huntsman\'s Master','The Name That Was Taken','The Beast\'s Choice','The Stepmother\'s Deal','The Single Act','The Road Not on the Map'],
        naval:        ['What Went Down With the Ship','The Admiral\'s Letter','The Rogue Captain','The Leviathan Awake','The Convoy Through the Dead Waters','The Hold That Was Not on the Manifest','The Mutinous First Mate','The Sea-Witch\'s Tribute','The Deep-Water Mine','The Destination Not on the Chart'],
        western:      ['The Railroad\'s Path','The Deed in the Mine','The Wanted Poster','The Man Who Bought the Law','The High Desert Cult','The Gunslinger\'s Return','The Bandit King\'s Grudge','The Sheriff\'s Town','What Was Buried','The Water Rights'],
        post_apocalyptic:['The Broadcast From the Future','The Sealed Vault','The Poisoned Water','The Recruiters','The Antidote in the Bunker','The Countdown','The Sacrifice They Are Building','The Machine-Mind\'s Survivors','The Next Catastrophe','The Prophet\'s Cure'],
        courtly_intrigue:['The Stolen Document','The Dead Guest','The Signatory Who Was Not','The Heir Challenged','The Queen\'s Favourite','The Poison That Leaves No Trace','The Spymaster\'s Master','The Jester\'s Truth','The Proof in the Vault','The Treaty\'s Forgery'],
        dungeon_crawl: ['What Is Still Adding to It','The Keeper\'s Invitation','The Rival Party\'s Markers','The Chamber Not on the Map','The Sealed Entrance','The Thing That Found Another Way','The Curse That Binds the Dead','The Patron\'s Reason','The Dungeon That Tests','The Living Depths'],
        high_magic:    ['The Archmage\'s Rewrite','The Ley-Lines Shifted','The Artifact\'s Choice','The Spell With No Counter','The Component That Should Not Exist','The Plane-Hopping Entity','The Wizard Who Saw the End','The Cabal\'s Trade','The Bearer Who Was Not Pleased','The Flaw in the Law'],
        low_magic:     ['The Last Working Ritual','The Witch-Hunter\'s Find','The Thing That Ate Magic','The Curse That Backfires','The Ritual That Could Restore','The Hoarded Rituals','The Real Witch','The Cost of Restoration','The Vessel','Magic Returning'],
        no_magic:      ['The General Who Never Lost','The Champion\'s Oath','The Law That Was Bought','The Last Remnant','The Rebellion\'s Leader','The Evidence in the Hands of the Guilty','The Board That Must Change','The Last Battle','What They Must Become','The Person Who Is the Remnant'],
        ritual_magic:  ['The Component That No Longer Exists','What Answered the Circle','The Binding That Is Failing','The Entity\'s Offer','The Ritual of Decades','The One More Sacrifice','The Scholar\'s Discovery','The Tithe in Blood','The Thing That Was Asleep','The Circle\'s Choice']
    }
};

function _swExtendUniqueArray(target, additions) {
    if (!Array.isArray(target) || !Array.isArray(additions)) return;
    additions.forEach(function(item) {
        if (!target.includes(item)) target.push(item);
    });
}

function swApplyMassiveContentPack() {
    if (window._swMassiveContentPackApplied) return;
    window._swMassiveContentPackApplied = true;

    _swExtendUniqueArray(_SWD.goals, [
        'secure a fragile peace treaty before one assassination unravels it',
        'keep a city alive through a winter engineered by enemy magic',
        'prove a condemned prisoner innocent before the execution bell rings',
        'prevent a god-fragment from being assembled into a mortal weapon',
        'escort a witness whose memory is magically degrading each day',
        'stop a famine by reopening trade routes controlled by warlords',
        'recover a missing royal heir without triggering a succession war',
        'disrupt a cult census that marks who will be taken next',
        'close a portal that only opens when specific lies are spoken',
        'decide who should inherit power when every claimant is flawed'
    ]);

    _swExtendUniqueArray(_SWD.complications, [
        'The party is offered a legal pardon in exchange for abandoning the objective.',
        'A trusted ally is technically in the right for opposing the party.',
        'The clean solution would expose civilians to immediate retaliation.',
        'Two objectives become mutually exclusive unless the party takes a personal risk.',
        'The evidence needed for justice is itself illegally obtained.',
        'A rival team mirrors the party but with opposite ethics.',
        'The antagonist is willing to negotiate honestly, but only once.',
        'The map is accurate, but the landmarks move each night.',
        'The quest objective can be completed only by breaking a sacred oath.',
        'Success now creates a debt payable in a later, darker chapter.'
    ]);

    _swExtendUniqueArray(_SWD.worldDetails, [
        'A bell tower rings every dawn despite having no bell rope or visible keeper.',
        'An old district map marks a street that exists only during rainfall.',
        'Court records contain cases judged by a magistrate who never lived.',
        'Children here play a game that reenacts a war no one admits happened.',
        'There are two public clocks in town and they never agree.',
        'A local proverb contains a name nobody can identify or translate.',
        'One bridge toll is paid in stories instead of coin after midnight.',
        'A nearby shrine grants answers, but only to questions you already regret asking.',
        'Ships leaving the harbor record fewer passengers than those who boarded.',
        'Street names change every year, but one alley never does.'
    ]);

    _swExtendUniqueArray(_SWD.goals, [
        'find the source of a curse that strikes only those who speak a certain name',
        'deliver a message that will start or stop a war depending on who receives it first',
        'recover a stolen relic before the holy day when its absence will be discovered',
        'infiltrate a masquerade where every guest is hiding a lethal secret',
        'protect a trial witness who is also the only person who can undo the verdict',
        'negotiate with a dragon, a duke, and a cult — each holds one piece of the solution',
        'trace a plague to its origin before the city seals its gates forever',
        'choose which of two doomed factions receives the only available rescue',
        'break a time loop that resets whenever the party fails to prevent one death',
        'uncover why the dead are returning with no memory of the afterlife',
        'secure an alliance with a nation that considers the party\'s people extinct',
        'retrieve a child who was swapped at birth and is now the heir to an enemy house',
        'stop a ritual that will rewrite the past — and erase the party from it',
        'convince a tyrant to step down using only words and one piece of proof',
        'escort a fugitive to sanctuary while being hunted by both law and outlaw',
        'reclaim a fortress that has been occupied by something that thinks in centuries',
        'find the real killer before an innocent is executed at dawn',
        'prevent a wedding that would merge two houses into an unstoppable power',
        'discover what lies at the centre of a forest that has no centre on any map',
        'survive the night in a place that exists only between midnight and first light'
    ]);
    _swExtendUniqueArray(_SWD.complications, [
        'The only way forward requires trusting someone who has already betrayed the party once.',
        'A key resource is controlled by someone who will not sell, only trade — for something the party cannot give.',
        'The deadline is real, but meeting it means leaving someone behind.',
        'The antagonist has a sympathetic motive that makes violence feel like murder.',
        'Success requires the party to commit an act that will haunt them publicly.',
        'An ally\'s plan is sound but depends on the party not knowing the full risk.',
        'The evidence that would end the conflict would also destroy an innocent reputation.',
        'Two factions both have a legitimate claim; supporting one makes an enemy of the other.',
        'The safest path is also the one that strengthens a future threat.',
        'A witness will talk only if the party first does something they have sworn never to do.',
        'The objective is a test; the real mission will be revealed only after it is completed.',
        'Completing the goal will invalidate the reason the party was hired.',
        'The party must choose between saving one person and saving many who will never know.',
        'The antagonist has already won something the party did not know was at stake.',
        'The only person who can help is the same person the party was sent to stop.'
    ]);
    _swExtendUniqueArray(_SWD.worldDetails, [
        'The oldest building in town has a foundation that predates the town by centuries.',
        'A well in the square is said to grant one true answer per lifetime — but the price is never stated.',
        'The local currency bears the face of a ruler who was never crowned.',
        'Every year one resident leaves and is never mentioned again by anyone.',
        'The garrison has a standing order never to enter the woods after dark.',
        'A monument lists the names of the dead from a battle that officially never occurred.',
        'The temple\'s holiest relic is a copy; the original was lost before living memory.',
        'Children are taught a rhyme that adults refuse to explain or finish.',
        'The river runs in both directions depending on the phase of the moon.',
        'A single tree in the grove bears fruit that tastes like whatever the eater fears most.',
        'The inn has a room that is always reserved; the reservation has no name.',
        'The border was drawn to exclude a village that no longer appears on any map.',
        'The crown has a successor line that is never named in official documents.',
        'A festival is held to honour an event that historians say did not happen.',
        'The harbour master logs every ship that leaves but not every ship that returns.'
    ]);

    _swExtendUniqueArray(_SWD.npcRoles, [
        'a retired executioner who now keeps meticulous records of who deserved mercy',
        'a courier who memorizes messages and burns every written copy',
        'a clockmaker who claims time itself is misbehaving in this district',
        'an oathbound bodyguard whose employer died months ago',
        'a playwright whose comedies are coded political warnings',
        'a ship surgeon with a ledger of unclaimed names',
        'a war refugee who can identify uniforms by stitching pattern alone',
        'a disgraced inquisitor trying to dismantle the institution that made them'
    ]);

    _swExtendUniqueArray(_SWD.questClients, [
        'a burned-out commander trying to save civilians from his own side',
        'a city coroner with autopsy notes that imply a supernatural conspiracy',
        'a monastery librarian who found a prophecy written in yesterday\'s ink',
        'a theater director whose cast keeps disappearing before opening night',
        'a dock foreman who is secretly protecting undocumented refugees',
        'a noble widow who wants truth more than revenge and may get neither',
        'a prison chaplain who can prove a confession was coerced',
        'a veteran scout who mapped enemy routes and then vanished from records',
        'a healer running a free clinic in a district controlled by gang tribute',
        'a village teacher safeguarding children targeted by a recruitment cult'
    ]);

    _swExtendUniqueArray(_SWD.questTwists, [
        'The person to be rescued refuses extraction for a reason that is morally defensible.',
        'The artifact works exactly as promised, and that is far worse than if it were fake.',
        'The employer intends to stage your success as proof for a false narrative.',
        'The villain expected the party and prepared a truthful confession as bait.',
        'A key witness can only testify if the party grants asylum to their enemy.',
        'The true target is not a person but a rumor sustaining a fragile peace.',
        'Finishing the job reveals that the previous quest\'s reward was a planted liability.',
        'The objective is complete, but the payment source is blood money from innocents.',
        'A trusted patron has already signed the opposing faction\'s contract.',
        'The party can win publicly or win correctly, but not both.'
    ]);

    _swExtendUniqueArray(_SWD.questRewards, [
        'A notarized writ granting emergency authority in one jurisdiction for 30 days.',
        'A rotating safehouse network with verified dead-drop locations.',
        'A chartered vessel and crew for one major voyage with no questions asked.',
        'Legal immunity for one prior offense tied to the quest\'s jurisdiction.',
        'A spell scroll archive access pass for restricted but supervised research.',
        'An heirloom banner whose display grants leverage with a border clan.',
        'A masterwork instrument that doubles as a coded message key.',
        'A treaty clause amendment favoring the party\'s allies for one season.',
        'A cryptic prophecy fragment validated by three independent seers.',
        'A permanent contact in the royal post capable of discreet priority delivery.'
    ]);

    _swExtendUniqueArray(_SWD.sideQuests, [
        {type:'Diplomatic',hook:'Two hostile families agree to meet only if neutral mediators ensure no one loses face.'},
        {type:'Logistics',hook:'The main quest fails unless mundane supplies arrive first through dangerous roads.'},
        {type:'Memory',hook:'A witness can help only if the party reconstructs a lost memory ritual.'},
        {type:'Reputation',hook:'An old rumor about the party must be corrected before doors reopen.'},
        {type:'Humanitarian',hook:'A refugee convoy needs protection while political leaders debate whether they count.'},
        {type:'Counterintel',hook:'Someone is leaking plans; finding them fast matters more than proving motive.'}
    ]);

    _swExtendUniqueArray(_SWD.dialogue.confrontation, [
        '\'You keep saying there was no choice,\' he said. \'There were choices. You just hated all of them.\'',
        '\'If you want justice,\' she said, \'you\'ll have to survive what justice costs.\'',
        '\'Draw if you must,\' the captain said. \'But understand this is the easiest part of what comes next.\''
    ]);
    _swExtendUniqueArray(_SWD.dialogue.revelation, [
        '\'The signature is real,\' she whispered. \'The person who signed it died two years before this date.\'',
        '\'I lied because the truth would have gotten children killed,\' he said. \'I can live with your hatred.\'',
        '\'You weren\'t hired to solve this,\' she said. \'You were hired to bless the outcome.\''
    ]);
    _swExtendUniqueArray(_SWD.dialogue.quiet, [
        '\'I learned the city by listening through walls,\' she said. \'Now the walls are listening back.\'',
        '\'Some nights,\' he said, \'I recite the names so I don\'t make new ghosts.\'',
        '\'You can forgive someone and still refuse to trust them,\' she said. \'People forget that.\''
    ]);
    _swExtendUniqueArray(_SWD.dialogue.action, [
        '\'Left stair, blind corner, two archers — move now.\'',
        '\'If the gate closes, don\'t be heroic. Be early.\'',
        '\'Smoke first, arguments later.\''
    ]);

    _swExtendUniqueArray(_SWD.npcNames.m, ['Theron','Lucan','Bastien','Orin','Marek','Ilias','Renwick','Cassian']);
    _swExtendUniqueArray(_SWD.npcNames.f, ['Selka','Ilyra','Maelis','Corinne','Ysolda','Neris','Talin','Brise']);
    _swExtendUniqueArray(_SWD.npcNames.sur, ['Marrowind','Vossen','Candlemere','Stormvale','Rookhart','Ashbourne','Crowley','Fenmarch']);

    Object.keys(_SWD.antagonists).forEach(function(g){
        _swExtendUniqueArray(_SWD.antagonists[g], [
            'a celebrated public hero who quietly orchestrates controlled disasters to consolidate power',
            'a coalition of lesser enemies united by one shared grievance against the establishment'
        ]);
    });
    Object.keys(_SWD.hooks).forEach(function(g){
        _swExtendUniqueArray(_SWD.hooks[g], [
            'A courier collapses at the party\'s feet carrying a sealed tube addressed to one of them by name and title they have never used.',
            'A public notice offers a reward for information about an event the party participated in — with details no witness should know.'
        ]);
    });
    Object.keys(_SWD.plots).forEach(function(g){
        _swExtendUniqueArray(_SWD.plots[g], [
            'The apparent conflict is a distraction shielding a slower, more consequential takeover.',
            'The villain\'s plan can be stopped quickly or understood fully, but not both on the same timeline.'
        ]);
    });

    Object.keys(_SWD.locDetails).forEach(function(k){
        _swExtendUniqueArray(_SWD.locDetails[k], [
            'A local insists this place has changed recently, but every official record denies any alteration.',
            'There is one area everyone avoids politely, regardless of rank, faith, or profession.'
        ]);
    });
}

swApplyMassiveContentPack();

function swApplyGenreToneExpansion() {
    if (window._swGenreToneExpansionApplied) return;
    window._swGenreToneExpansionApplied = true;

    _SWD.antagonists.noir = _SWD.antagonists.noir || ['a magistrate who owns every witness through debt ledgers','a crime syndicate run like a legal bureaucracy','a celebrated detective staging crimes to control outcomes'];
    _SWD.antagonists.exploration = _SWD.antagonists.exploration || ['a colonial charter house rewriting maps to erase people','a rival expedition willing to sabotage rescue lines','an ancient sentinel awakening against all trespassers'];
    _SWD.antagonists.survival = _SWD.antagonists.survival || ['a winter cult feeding blizzards with ritual sacrifices','a warband that hunts supply caravans for sport','a parasitic intelligence mimicking lost companions'];

    _SWD.hooks.noir = _SWD.hooks.noir || ['A witness vanishes minutes before testimony, leaving one blood-stained glove.','A payoff ledger appears listing the party by aliases they never used.'];
    _SWD.hooks.exploration = _SWD.hooks.exploration || ['A map edge redraws itself every dawn, revealing one more landmark.','A returning survey crew arrives without memories of the last ten days.'];
    _SWD.hooks.survival = _SWD.hooks.survival || ['Supply caches are empty in a pattern that predicts the next raid.','A safe route becomes lethal overnight as weather and wildlife shift unnaturally.'];

    _SWD.plots.noir = _SWD.plots.noir || ['The truth exists in paperwork, not confession, and every office is compromised.','Every faction wants justice publicly and impunity privately.'];
    _SWD.plots.exploration = _SWD.plots.exploration || ['A frontier corridor is open briefly before terrain collapses into hazard season.','The expedition\'s stated goal is fake; the real objective is hidden in navigation codes.'];
    _SWD.plots.survival = _SWD.plots.survival || ['The environment itself is escalating according to ritual timing, not weather.','The party can save everyone, supplies, or speed — choose two.'];

    _SWD.climax.noir = _SWD.climax.noir || 'The final confrontation is a public hearing where one truthful document can end a regime or start a purge.';
    _SWD.climax.exploration = _SWD.climax.exploration || 'At the map\'s edge, the party must decide what to bring home: proof, people, or power.';
    _SWD.climax.survival = _SWD.climax.survival || 'The storm breaks only if someone stays behind to hold the line long enough for others to escape.';
}

swApplyGenreToneExpansion();

function swApplyWideRangeStoryPack() {
    if (window._swWideRangeStoryPackApplied) return;
    window._swWideRangeStoryPackApplied = true;
    _swExtendUniqueArray(_SWD.goals, [
        'rescue a prisoner who does not want to be rescued', 'close a planar rift before the wrong thing steps through',
        'deliver a message that will start or stop a war', 'find out why the dead have stopped staying dead in one district',
        'protect a trial witness who is lying under oath', 'retrieve a stolen relic before its curse spreads',
        'negotiate with a faction that has already decided to betray you', 'survive a night in a place that does not exist by day',
        'unmask a doppelganger before it reaches someone irreplaceable', 'break a contract that was signed in blood — literally',
        'escort a child who is the last vessel of a dying god', 'prevent a coronation that would crown the wrong heir',
        'recover a memory that was stolen from the party', 'stop a ritual that would rewrite one moment in history',
        'choose which of two allied nations will receive a weapon that could end the war'
    ]);
    _swExtendUniqueArray(_SWD.complications, [
        'The party\'s best option requires betraying someone who trusts them.',
        'The antagonist is acting on orders from someone the party cannot touch.',
        'Success will create a martyr; failure will create a tyrant.',
        'The only person who can help is the person the party came to stop.',
        'The timeline is shorter than anyone admitted — and someone knew.',
        'The party\'s presence has made the situation worse; leaving might fix it.',
        'Two allies need opposite outcomes and the party can only back one.',
        'The truth would destroy an institution that is still doing good.',
        'The safest path requires a sacrifice the party cannot make.',
        'Someone the party cares about is on the other side — and is not wrong.'
    ]);
    _swExtendUniqueArray(_SWD.npcRoles, [
        'a forger who only makes documents that become true', 'a soldier who has seen this war from both sides',
        'a scholar who is one discovery away from heresy', 'a thief who steals only to return things to the "right" owner',
        'a priest whose god has gone silent', 'a noble who is running out of money and options',
        'a child who remembers a life they never lived', 'a guard who knows the prison is wrong but needs the job',
        'a merchant who trades in secrets and never writes them down', 'a bard who is writing the story before it happens'
    ]);
    _swExtendUniqueArray(_SWD.worldDetails, [
        'The oldest building in town is newer than the foundation it stands on.',
        'One well in the district gives water that tastes like memory.',
        'A law from two reigns ago was never repealed and has just been invoked.',
        'The local currency has a face on it that nobody can identify.',
        'Children here are taught a song that adults refuse to sing.',
        'The graveyard has one headstone that changes name every year.',
        'A bridge was built to span a gap that did not exist before — or after.',
        'The town\'s founding document is written in a language that has no alphabet.',
        'One street is always one step ahead of the rest of the city.',
        'The stars above this region do not match any known chart.'
    ]);
    Object.keys(_SWD.antagonists).forEach(function(g){
        _swExtendUniqueArray(_SWD.antagonists[g], [
            'a hero from a previous age who cannot accept that the world has moved on',
            'a collective of ordinary people who have made an extraordinary bad decision',
            'someone who is right about the problem but wrong about the solution',
            'a victim of the party\'s past actions who has had years to plan'
        ]);
    });
    Object.keys(_SWD.hooks).forEach(function(g){
        _swExtendUniqueArray(_SWD.hooks[g], [
            'A stranger hands one of the party a sealed message and then collapses — dead before they hit the ground.',
            'The job offer is perfect. The client is not. The client knows the party\'s real name.',
            'Something the party thought was resolved has returned, and it is not alone.',
            'A festival is in three days. By then, something that is currently dormant will wake.'
        ]);
    });
    Object.keys(_SWD.plots).forEach(function(g){
        _swExtendUniqueArray(_SWD.plots[g], [
            'The real conflict is not between two sides but between the past and the future.',
            'The villain has already won the first round; the party is cleaning up the consequences.',
            'What looks like a single plot is two separate plans that have accidentally aligned.',
            'The only way to stop the threat is to become something the party fears.'
        ]);
    });
}

swApplyWideRangeStoryPack();

/* ══ STORY GENERATION ══ */
function swComposeStoryPressureReadable() {
    return _swNarrativeParagraph(
        'What makes this story breathe at the table is pressure that keeps changing shape.',
        [
            'Every faction involved believes they are running out of time, which means the party is constantly asked to commit before they have complete information.',
            'Rumors move faster than facts, so the party may succeed tactically while losing the public narrative unless they actively manage witnesses and consequences.',
            'Each success closes one problem and opens another, creating a chain of decisions that should feel cumulative instead of episodic.',
            'Give each NPC a threshold where fear, pride, or grief changes their behavior so scenes evolve naturally under stress.'
        ],
        3
    );
}
function swComposeStoryStakesReadable() {
    return _swNarrativeParagraph(
        'If the party does nothing, events do not pause; they harden.',
        [
            'Allies lose leverage, institutions choose expediency over justice, and ordinary people begin adapting to the new danger as if it were normal.',
            'The antagonist gains legitimacy by appearing inevitable, not merely powerful, which is much harder to undo than a battlefield loss.',
            'Private tragedies become public policy, and by the time the party intervenes later, the moral cost of fixing things has risen sharply.'
        ],
        2
    );
}
function swComposeStoryReadAloud() {
    return _swNarrativeParagraph(
        'Read-aloud frame: describe what the characters sense before they understand—who is watching, what detail does not fit, and what silence follows important names.',
        [
            'Let the first minute of scene description focus on texture and intention: doors that open too quickly, people who avoid eye contact, and routines performed with visible strain.',
            'When players ask questions, answer with useful specifics and one unsettling implication so curiosity drives the next action naturally.',
            'Close each major beat with a concrete choice: who to trust, what to risk, or what truth to reveal now versus later.'
        ],
        2
    );
}
function swRegenStoryReadAloud() {
    var el = document.getElementById('swStoryReadAloudText');
    if (!el) return;
    el.textContent = swComposeStoryReadAloud();
    if (typeof showToast === 'function') showToast('Story read-aloud refreshed', 'success');
}
function swRegenStoryPressureStakes() {
    var p = document.getElementById('swStoryPressureText');
    var s = document.getElementById('swStoryStakesText');
    if (!p || !s) return;
    p.textContent = swComposeStoryPressureReadable();
    s.textContent = swComposeStoryStakesReadable();
    if (typeof showToast === 'function') showToast('Story pressure/stakes refreshed', 'success');
}

function _swEscapeHtml(v) {
    return String(v == null ? '' : v)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function swGetStoryRunConfig() {
    var minutes = parseInt((document.getElementById('storySessionLength') || {}).value, 10);
    if (!Number.isFinite(minutes) || minutes < 120) minutes = 240;
    var tier = parseInt((document.getElementById('storyPartyTier') || {}).value, 10);
    if (!Number.isFinite(tier) || tier < 1 || tier > 4) tier = 2;
    var frame = ((document.getElementById('storyCampaignFrame') || {}).value || '').trim();
    var focusGoal = ((document.getElementById('storyPlayerGoal') || {}).value || '').trim();
    var openingPrompt = ((document.getElementById('storyOpeningPrompt') || {}).value || '').trim();
    var magicLevel = ((document.getElementById('storyMagicLevel') || {}).value || '').trim();
    var conflictStyle = ((document.getElementById('storyConflictStyle') || {}).value || '').trim();
    var scopeEl = document.querySelector('input[name="storyScope"]:checked');
    var scope = (scopeEl && scopeEl.value) ? scopeEl.value : 'oneshot';
    return { minutes: minutes, tier: tier, frame: frame, focusGoal: focusGoal, openingPrompt: openingPrompt, magicLevel: magicLevel, conflictStyle: conflictStyle, scope: scope };
}

function swBuildStoryRunbookHtml(cfg, context) {
    var ctx = context || {};
    var scenes = cfg.minutes >= 300 ? 10 : cfg.minutes >= 240 ? 8 : cfg.minutes >= 180 ? 6 : 5;
    var labels = ['Cold Open','Investigation Pulse','Social Pressure','Travel/Transition','Revelation Scene','Set-Piece Clash','Complication Spike','Finale Decision','Aftermath Choice','Debrief Hook'];
    var beatFocus = [
        'Present an urgent problem and force immediate action.',
        'Reveal two leads: one easy, one dangerous.',
        'Pressure alliances with a public social encounter.',
        'Use a hazard that costs time, resources, or trust.',
        'Deliver a truth that reframes the party\'s assumptions.',
        'Stage a high-energy conflict with terrain consequences.',
        'Escalate stakes with a betrayal or ticking clock advance.',
        'Ask for a hard final choice with no perfect answer.',
        'Show consequences and survivors reacting in-world.',
        'Plant the next session hook through fallout and rumor.'
    ];
    var checkTypes = ['Persuasion or Intimidation','Investigation or Insight','Stealth or Deception','Arcana or Religion','Perception or Survival','Athletics or Acrobatics'];
    var tierDCBase = { 1: 11, 2: 14, 3: 17, 4: 19 };
    var baseDC = tierDCBase[cfg.tier] || 14;

    var cards = [];
    for (var i = 0; i < scenes; i++) {
        var minStart = Math.floor((cfg.minutes / scenes) * i);
        var minEnd = Math.floor((cfg.minutes / scenes) * (i + 1));
        var sceneLabel = labels[i] || ('Scene ' + (i + 1));
        var challenge = _swPick(_SWD.complications);
        var dialogue = _swPick(_SWD.dialogue[(i % 3 === 0) ? 'revelation' : (i % 2 === 0 ? 'confrontation' : 'quiet')]);
        var skillLine = _swPick(checkTypes);
        var dc = baseDC + (i >= scenes - 2 ? 2 : 0);
        var failForward = 'Fail-forward: progress still happens, but add one consequence (lost ally confidence, spent resource, or enemy advantage).';

        cards.push('<div style="background:rgba(20,16,38,0.92);border:1px solid rgba(160,100,255,0.24);border-radius:8px;padding:12px 13px;margin-bottom:9px;">'
            + '<div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:6px;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.74em;color:#dcbcff;font-weight:700;letter-spacing:1px;">🎬 ' + sceneLabel + '</div>'
            + '<div style="font-size:0.72em;color:rgba(210,190,255,0.72);">Minute ' + minStart + '–' + minEnd + '</div>'
            + '</div>'
            + '<div style="font-size:0.92em;color:rgba(240,232,255,0.88);line-height:1.7;margin-bottom:5px;"><strong>Beat Goal:</strong> ' + beatFocus[i % beatFocus.length] + '</div>'
            + '<div style="font-size:0.9em;color:rgba(255,228,190,0.84);line-height:1.65;margin-bottom:5px;"><strong>Conflict Twist:</strong> ' + challenge + '</div>'
            + '<div style="font-size:0.88em;color:rgba(210,195,255,0.84);line-height:1.65;margin-bottom:5px;"><strong>GM Dialogue Cue:</strong> &ldquo;' + _swEscapeHtml(dialogue) + '&rdquo;</div>'
            + '<div style="font-size:0.86em;color:rgba(198,220,255,0.82);line-height:1.6;margin-bottom:4px;"><strong>Check Prompt:</strong> ' + skillLine + ' (DC ' + dc + ')</div>'
            + '<div style="font-size:0.84em;color:rgba(190,210,255,0.72);line-height:1.6;">' + failForward + '</div>'
            + '</div>');
    }

    return '<div style="background:rgba(12,10,28,0.75);border:1px solid rgba(160,100,255,0.35);border-radius:7px;padding:12px 13px;margin-bottom:14px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:#e0c0ff;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">🕰 Guided Session Runbook (' + cfg.minutes + ' min)</div>'
        + '<div style="font-size:0.9em;line-height:1.7;color:rgba(235,220,255,0.9);margin-bottom:10px;">'
        + '<strong>How to run it:</strong> move scene-by-scene, advancing roughly every ' + Math.round(cfg.minutes / scenes) + ' minutes. If players skip a scene, jump to the next one and carry one unresolved consequence forward.'
        + '</div>'
        + cards.join('')
        + '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">'
        + '<button onclick="if(typeof swSwitchTab===\'function\')swSwitchTab(\'quest\');if(typeof swGenerateQuest===\'function\')swGenerateQuest();" style="padding:6px 10px;background:rgba(139,0,0,0.24);border:1px solid rgba(220,20,60,0.44);border-radius:5px;color:#ffd8d8;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;">⚔ Generate Linked Quest Beat</button>'
        + '<button onclick="if(typeof swSwitchTab===\'function\')swSwitchTab(\'location\');if(typeof swGenerateLocation===\'function\')swGenerateLocation();" style="padding:6px 10px;background:rgba(20,90,20,0.24);border:1px solid rgba(70,190,90,0.44);border-radius:5px;color:#d8ffd8;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;">🗺 Generate Scene Location</button>'
        + '<button onclick="if(typeof swGenerateLocationNPCs===\'function\')swGenerateLocationNPCs();" style="padding:6px 10px;background:rgba(120,70,0,0.24);border:1px solid rgba(220,170,70,0.44);border-radius:5px;color:#ffe7c5;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;">👥 Populate NPCs for Scene</button>'
        + '</div>'
        + '</div>';
}

function swBuildStoryDialogueBankHtml(context) {
    var ctx = context || {};
    var speakers = [
        'Antagonist',
        'Trusted Ally',
        'Panicked Witness',
        'Rival Faction Agent',
        'Morally Conflicted Guard',
        'Final Scene Monologue'
    ];
    var pools = [
        _SWD.dialogue.confrontation,
        _SWD.dialogue.quiet,
        _SWD.dialogue.action,
        _SWD.dialogue.revelation,
        _SWD.dialogue.quiet,
        _SWD.dialogue.revelation.concat(_SWD.dialogue.confrontation)
    ];
    var lines = speakers.map(function(name, idx) {
        return '<div style="margin-bottom:8px;padding:8px 10px;background:rgba(28,22,46,0.85);border:1px solid rgba(170,120,255,0.22);border-radius:6px;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.68em;color:#d7b3ff;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">' + name + '</div>'
            + '<div style="font-size:0.95em;color:rgba(235,220,255,0.9);font-style:italic;line-height:1.7;">&ldquo;' + _swEscapeHtml(_swPick(pools[idx] || _SWD.dialogue.quiet)) + '&rdquo;</div>'
            + '</div>';
    }).join('');

    return '<div style="background:rgba(22,14,36,0.72);border:1px solid rgba(160,100,255,0.28);border-radius:7px;padding:11px 12px;margin-bottom:14px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:#d7b3ff;text-transform:uppercase;letter-spacing:1.4px;margin-bottom:8px;">🗣 Big Dialogue Pack</div>'
        + '<div style="font-size:0.9em;color:rgba(220,205,250,0.84);line-height:1.65;margin-bottom:8px;">Use these as table-ready lines. Swap names/locations to match your live scene.</div>'
        + lines
        + '</div>';
}

function swGenerateStory() {
    var genre = (document.getElementById('storyGenre')||{}).value || 'epic_fantasy';
    var tone  = (document.getElementById('storyTone') ||{}).value || 'grim';
    var stage = 'beginning'; /* Stage removed from UI — always starts at the beginning */
    _swBeginDeterministic('story|' + genre + '|' + tone + '|' + stage);

    var toneWords   = {grim:'grim and unsparing',heroic:'heroic and hopeful',mysterious:'layered and uncertain',tense:'urgent and pressurised',tragic:'tragic and elegiac',action:'kinetic and relentless',mythic:'mythic and larger-than-life',paranoid:'paranoid and conspiratorial',melancholic:'melancholic and reflective',hopeful:'bright and resilient',epic:'epic and grand',gritty:'gritty and grounded',pulp:'pulp and swashbuckling',dark_comedy:'darkly comic',whimsical:'whimsical',solemn:'solemn and reverent',dread:'dread and unease',intimate:'intimate and personal'};
    var stageLabels = {beginning:'Act I — The World Before',rising:'Act II — Rising Action',midpoint:'Act II — The Midpoint Crisis',climax:'Act III — The Climax',resolution:'Act III — Resolution & Aftermath'};

    var runCfg     = swGetStoryRunConfig();
    var antagonist = _swPickFrom(_SWD.antagonists, genre);
    var goal       = (runCfg.focusGoal && runCfg.focusGoal.length > 0) ? runCfg.focusGoal : _swPick(_SWD.goals);
    var hook       = (runCfg.openingPrompt && runCfg.openingPrompt.length > 0) ? runCfg.openingPrompt : _swPickFrom(_SWD.hooks, genre);
    var plot       = _swPickFrom(_SWD.plots, genre);
    if (runCfg.frame && runCfg.frame.length > 0) plot = 'Campaign context: ' + runCfg.frame + '. ' + plot;
    var comp1      = _swPick(_SWD.complications);
    var comp2      = _swPick(_SWD.complications.filter(function(c){return c!==comp1;}));
    var climax     = _SWD.climax[genre] || _SWD.climax.epic_fantasy;
    var npc1       = _swPick(_SWD.npcRoles);
    var npc2       = _swPick(_SWD.npcRoles.filter(function(r){return r!==npc1;}));
    var worldD1    = _swPick(_SWD.worldDetails);
    var worldD2    = _swPick(_SWD.worldDetails.filter(function(d){return d!==worldD1;}));
    var dial       = _swPick(_SWD.dialogue.quiet.concat(_SWD.dialogue.revelation));
    var dial2      = _swPick(_SWD.dialogue.confrontation);

    var titles = (_SWD.storyTitles && Object.keys(_SWD.storyTitles).length) ? _SWD.storyTitles : { epic_fantasy:['The Throne of Ash','The Shattered Crown','When Kingdoms Fall'] };
    var title = _swPick(titles[genre] || titles.epic_fantasy || ['Untitled Story']);
    var storyId = 'story_' + Date.now();
    var genreLabel = genre.replace(/_/g,' ').replace(/\b\w/g,function(l){return l.toUpperCase();});
    var stageColors = {beginning:'#6a80ff',rising:'#ffaa00',midpoint:'#ff6030',climax:'#cc0000',resolution:'#40cc80'};
    var sc = stageColors[stage] || '#a060ff';

    // Campaign context and opening prompt have major effect: weave frame into situation; opening prompt used as read-aloud when provided (set below)
    var framePrefix = (runCfg.frame && runCfg.frame.length > 0) ? 'In this campaign: ' + runCfg.frame + '. ' : '';
    // Enhanced descriptions for DM to read out
    var hookReadable = hook + ' This is how your players first learn about the situation. Read this aloud to set the scene and hook them into the adventure.';
    var plotReadable = framePrefix + plot + ' This is the main conflict or situation the party finds themselves in. Explain this clearly to your players so they understand what they\'re dealing with.';
    var goalReadable = 'The party\'s main objective is: ' + goal + '. Make sure your players understand this goal clearly, as it will guide their decisions throughout the adventure.';
    var antagonistReadable = 'The primary threat or opposition comes from: ' + antagonist + '. This is who or what stands in the way of the party achieving their goal. Consider how this antagonist will interact with the players and what motivates them.';
    var comp1Readable = comp1 + ' This complication adds depth and challenge to the adventure. Think about how this affects the party\'s plans and what obstacles it creates.';
    var comp2Readable = comp2 + ' This second complication ensures the adventure isn\'t straightforward. Consider how this interacts with the first complication to create interesting scenarios.';
    var npc1Readable = 'The party will encounter someone who is: ' + npc1 + '. This character will play an important role in the story. Think about how they relate to the main plot and what information or assistance they might provide.';
    var npc2Readable = 'They will also interact with: ' + npc2 + '. This second character adds another layer to the narrative. Consider their relationship to the first character and how they might help or hinder the party.';
    var worldD1Readable = worldD1 + ' This detail about the world helps establish the setting and atmosphere. Use this to paint a vivid picture for your players.';
    var worldD2Readable = worldD2 + ' This additional world detail adds richness to the environment. Consider how this affects the mood and feel of the locations the party will visit.';
    var dialReadable = 'Sample dialogue: "' + dial + '" Use this as inspiration for how characters might speak. Adapt it to fit your NPCs and the situation.';
    var dial2Readable = 'Another dialogue example: "' + dial2 + '" This shows the tone and style of conversations the party might have. Use these as templates for your own dialogue.';
    var climaxReadable = climax + ' This is how the story might conclude. Keep this in mind as you guide the adventure, but remember that player choices will ultimately determine the outcome.';

    var storyPressureReadable = swComposeStoryPressureReadable();
    var storyStakesReadable = swComposeStoryStakesReadable();
    var storyReadAloud = swComposeStoryReadAloud();
    var readAloudOpening = (runCfg.openingPrompt && runCfg.openingPrompt.length > 0) ? runCfg.openingPrompt : storyReadAloud;
    var storyCoherence = swAnalyzeNarrativeCoherence('story', {
        title: title,
        antagonist: antagonist,
        goal: goal,
        plot: plot,
        textBlocks: [hookReadable, plotReadable, goalReadable, antagonistReadable, comp1Readable, comp2Readable, storyReadAloud, storyPressureReadable, storyStakesReadable]
    });
    var storyCoherenceHtml = swRenderCoherencePanel(storyCoherence, '#b5d2ff');
    var storyPrep = swBuildSessionPrep('story', { title: title, goal: goal, antagonist: antagonist });
    var storyPrepHtml = swRenderSessionPrepPanel(storyPrep, '#c7b0ff');
    var safeFrame = _swEscapeHtml(runCfg.frame || 'Use the generated world details as your campaign frame.');
    var safeFocusGoal = _swEscapeHtml(runCfg.focusGoal || goal);
    var safeOpeningPrompt = _swEscapeHtml(runCfg.openingPrompt || hook);
    var magicLabel = { high_magic:'High magic', low_magic:'Low magic', no_magic:'No magic', ritual_only:'Ritual only', mixed:'Mixed' }[runCfg.magicLevel] || '';
    var conflictLabel = { martial:'Martial arts & duels', military:'Military & sieges', skirmish:'Skirmishes & raids', heist:'Heists & stealth', social:'Social & intrigue', mixed:'Mixed' }[runCfg.conflictStyle] || '';
    var worldRulesLine = (magicLabel || conflictLabel) ? '<div style="font-size:0.84em;color:rgba(210,185,255,0.78);margin-top:6px;"><strong>Live-play rules:</strong> ' + [magicLabel, conflictLabel].filter(Boolean).join(' · ') + '.</div>' : '';
    var runbookHtml = swBuildStoryRunbookHtml(runCfg, { title:title, antagonist:antagonist, goal:goal, hook:hook, plot:plot, genre:genre, tone:tone });
    var dialogueBankHtml = swBuildStoryDialogueBankHtml({ antagonist:antagonist, goal:goal, npc1:npc1, npc2:npc2, tone:tone, genre:genre });
    
    /* ── D&D Adventure Book Layout ── */
    var _e = _swEscapeHtml;
    var scopeLabel = (runCfg.scope === 'campaign') ? 'Campaign Arc' : 'One-Shot Adventure';
    var toneLabel = toneWords[tone] || tone || 'grim';
    var tierLabel = 'Tier ' + runCfg.tier + ' (Levels ' + ((runCfg.tier-1)*4+1) + '–' + (runCfg.tier*4+((runCfg.tier===4)?0:0)) + ')';

    var html = '<div class="dnd-book" style="margin-bottom:10px;">'
        /* ── COVER PAGE ── */
        + '<div class="dnd-book-cover">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.6em;color:#8b4513;letter-spacing:4px;text-transform:uppercase;margin-bottom:6px;position:relative;">A Fifth Edition Adventure</div>'
        + '<div class="dnd-book-title">' + _e(title) + '</div>'
        + '<div class="dnd-book-subtitle">' + _e(scopeLabel) + ' for ' + _e(tierLabel) + '</div>'
        + '<div class="dnd-book-tags">'
        + '<span class="dnd-book-tag">' + _e(genreLabel) + '</span>'
        + '<span class="dnd-book-tag">' + _e(toneLabel) + '</span>'
        + '<span class="dnd-book-tag">' + _e(runCfg.minutes) + ' min runtime</span>'
        + (magicLabel ? '<span class="dnd-book-tag">' + _e(magicLabel) + '</span>' : '')
        + (conflictLabel ? '<span class="dnd-book-tag">' + _e(conflictLabel) + '</span>' : '')
        + '</div>'
        + '</div>'
        + '<hr class="dnd-book-divider">'

        /* ── ADVENTURE BACKGROUND ── */
        + '<div class="dnd-book-body">'
        + '<div class="dnd-chapter">'
        + '<div class="dnd-chapter-header">Adventure Background</div>'
        + '<div class="dnd-chapter-title">The Story So Far</div>'
        + '<div class="dnd-chapter-text">'
        + '<p style="margin:0 0 10px;">' + _e(safeFrame || 'A new threat has emerged in the realm, drawing adventurers from across the land.') + '</p>'
        + '<p style="margin:0 0 10px;">' + plotReadable + '</p>'
        + '</div>'
        + '<div class="dnd-sidebar">'
        + '<div class="dnd-sidebar-title">DM Overview</div>'
        + '<div><strong>Hook:</strong> ' + _e(hook) + '</div>'
        + '<div style="margin-top:4px;"><strong>Goal:</strong> ' + _e(goal) + '</div>'
        + '<div style="margin-top:4px;"><strong>Antagonist:</strong> ' + _e(antagonist) + '</div>'
        + '<div style="margin-top:4px;"><strong>Complications:</strong> ' + _e(comp1) + ' &mdash; ' + _e(comp2) + '</div>'
        + '<div style="margin-top:4px;"><strong>Climax:</strong> ' + _e(climax) + '</div>'
        + '</div>'
        + '</div>'
        + '<hr class="dnd-section-rule">'

        /* ── CHAPTER 1: THE CALL TO ADVENTURE ── */
        + '<div class="dnd-chapter">'
        + '<div class="dnd-chapter-header">Chapter 1</div>'
        + '<div class="dnd-chapter-title">The Call to Adventure</div>'
        + '<div class="dnd-chapter-text">'
        + '<p style="margin:0 0 12px;">' + hookReadable + '</p>'
        + '</div>'
        + '<div class="dnd-read-aloud" style="position:relative;">'
        + '<div style="text-align:right;margin-bottom:6px;"><button onclick="swRegenStoryReadAloud()" style="padding:3px 8px;background:rgba(139,69,19,0.3);color:#daa520;border:1px solid rgba(218,165,32,0.5);border-radius:3px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.6em;font-weight:700;">Regenerate</button></div>'
        + '<p id="swStoryReadAloudText">' + _e(readAloudOpening) + '</p>'
        + '</div>'
        + '<div class="dnd-chapter-text" style="margin-top:12px;">'
        + '<p style="margin:0;">' + goalReadable + '</p>'
        + '</div>'
        + '<div class="dnd-sidebar">'
        + '<div class="dnd-sidebar-title">Adventure Hook</div>'
        + '<p>' + _e(safeOpeningPrompt || hook) + '</p>'
        + '</div>'
        + '</div>'
        + '<hr class="dnd-section-rule">'

        /* ── CHAPTER 2: THE ANTAGONIST ── */
        + '<div class="dnd-chapter">'
        + '<div class="dnd-chapter-header">Chapter 2</div>'
        + '<div class="dnd-chapter-title">Forces of Opposition</div>'
        + '<div class="dnd-encounter-box">'
        + '<div class="dnd-encounter-title">The Antagonist</div>'
        + '<div class="dnd-chapter-text"><p style="margin:0;">' + antagonistReadable + '</p></div>'
        + '</div>'
        + '<div class="dnd-chapter-text" style="margin-top:12px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.75em;color:#daa520;font-weight:700;margin-bottom:8px;">Complications</div>'
        + '<p style="margin:0 0 8px;padding-left:12px;border-left:3px solid rgba(139,69,19,0.5);">' + comp1Readable + '</p>'
        + '<p style="margin:0;padding-left:12px;border-left:3px solid rgba(139,69,19,0.5);">' + comp2Readable + '</p>'
        + '</div>'
        + '<div class="dnd-sidebar" style="margin-top:12px;">'
        + '<div class="dnd-sidebar-title">Pressure &amp; Stakes <button onclick="swRegenStoryPressureStakes()" style="padding:2px 6px;background:rgba(139,69,19,0.3);color:#daa520;border:1px solid rgba(218,165,32,0.4);border-radius:3px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.85em;font-weight:700;margin-left:6px;">Regenerate</button></div>'
        + '<p id="swStoryPressureText" style="margin:0 0 8px;">' + storyPressureReadable + '</p>'
        + '<p id="swStoryStakesText" style="margin:0;">' + storyStakesReadable + '</p>'
        + '</div>'
        + '</div>'
        + '<hr class="dnd-section-rule">'

        /* ── CHAPTER 3: KEY FIGURES ── */
        + '<div class="dnd-chapter">'
        + '<div class="dnd-chapter-header">Chapter 3</div>'
        + '<div class="dnd-chapter-title">Allies &amp; Rivals</div>'
        + '<div class="dnd-npc-block">'
        + '<div class="dnd-npc-name">Key Figure</div>'
        + '<div class="dnd-npc-desc">' + npc1Readable + '</div>'
        + '</div>'
        + '<div class="dnd-npc-block">'
        + '<div class="dnd-npc-name">Key Figure</div>'
        + '<div class="dnd-npc-desc">' + npc2Readable + '</div>'
        + '</div>'
        + '<div class="dnd-read-aloud">'
        + '<p>&ldquo;' + _e(dial) + '&rdquo;</p>'
        + '</div>'
        + '<div style="margin-top:8px;padding:10px 14px;background:rgba(30,20,15,0.5);border-left:3px solid rgba(139,69,19,0.4);border-radius:0 4px 4px 0;">'
        + '<div style="font-style:italic;font-size:0.95em;color:#d4c4a8;line-height:1.8;">&ldquo;' + _e(dial2) + '&rdquo;</div>'
        + '</div>'
        + '</div>'
        + '<hr class="dnd-section-rule">'

        /* ── CHAPTER 4: THE WORLD ── */
        + '<div class="dnd-chapter">'
        + '<div class="dnd-chapter-header">Chapter 4</div>'
        + '<div class="dnd-chapter-title">The World</div>'
        + '<div class="dnd-chapter-text">'
        + '<p style="margin:0 0 8px;">' + worldD1Readable + '</p>'
        + '<p style="margin:0;">' + worldD2Readable + '</p>'
        + '</div>'
        + (worldRulesLine ? '<div class="dnd-sidebar"><div class="dnd-sidebar-title">World Rules</div>' + worldRulesLine + '</div>' : '')
        + '</div>'
        + '<hr class="dnd-section-rule">'

        /* ── CHAPTER 5: THE CLIMAX ── */
        + '<div class="dnd-chapter">'
        + '<div class="dnd-chapter-header">Chapter 5</div>'
        + '<div class="dnd-chapter-title">The Final Confrontation</div>'
        + '<div class="dnd-encounter-box">'
        + '<div class="dnd-encounter-title">Climax</div>'
        + '<div class="dnd-chapter-text"><p style="margin:0;">' + climaxReadable + '</p></div>'
        + '</div>'
        + '</div>'
        + '<hr class="dnd-section-rule">'

        /* ── APPENDIX A: SESSION RUNBOOK ── */
        + '<div class="dnd-chapter">'
        + '<div class="dnd-appendix-header">Appendix A</div>'
        + '<div class="dnd-appendix-title">Session Runbook</div>'
        + runbookHtml
        + '</div>'
        + '<hr class="dnd-section-rule">'

        /* ── APPENDIX B: DIALOGUE BANK ── */
        + '<div class="dnd-chapter">'
        + '<div class="dnd-appendix-header">Appendix B</div>'
        + '<div class="dnd-appendix-title">Dialogue Bank</div>'
        + dialogueBankHtml
        + '</div>'
        + '<hr class="dnd-section-rule">'

        /* ── APPENDIX C: DM RESOURCES ── */
        + '<div class="dnd-chapter">'
        + '<div class="dnd-appendix-header">Appendix C</div>'
        + '<div class="dnd-appendix-title">DM Resources</div>'
        + storyCoherenceHtml
        + storyPrepHtml
        + '</div>'

        + '</div></div>';


    _swCurrentStory = {id:storyId,title:title,genre:genre,tone:tone,stage:stage,antagonist:antagonist,goal:goal,plot:plot,coherence:storyCoherence,prep:storyPrep,runConfig:runCfg,chapters:[{stage:stage,html:html,date:new Date().toLocaleDateString()}],created:new Date().toLocaleDateString()};

    /* Sticky activate bar styled to match D&D book theme */
    var storyActivateBar = ''
        + '<div style="background:linear-gradient(90deg,#1a0e0a,#2a1a10,#1a0e0a);border-bottom:3px solid #8b4513;padding:11px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:10;">'
        + '<button onclick="swSaveAndActivateStory()" style="padding:8px 20px;background:linear-gradient(145deg,#5a3000,#8b4513);color:#ffe8c0;border:1px solid #daa520;border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 10px rgba(139,69,19,0.4);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#7a4500,#a06020)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#5a3000,#8b4513)\'">⚡ Set as Active Story</button>'
        + '<button onclick="swViewFullCampaign()" style="padding:8px 16px;background:rgba(60,80,40,0.5);color:#c0e8a0;border:1px solid rgba(100,160,60,0.6);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">📖 View Full Campaign</button>'
        + '<button onclick="swSaveStory()" style="padding:8px 16px;background:rgba(40,30,20,0.7);color:#daa520;border:1px solid rgba(139,69,19,0.7);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(60,45,30,0.8)\'" onmouseout="this.style.background=\'rgba(40,30,20,0.7)\'">💾 Save Story</button>'
        + '<button onclick="swGenerateVillainsFromStory()" style="padding:8px 18px;background:linear-gradient(145deg,#5a0000,#8b0000);color:#ffd0d0;border:1px solid rgba(200,50,50,0.8);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 10px rgba(139,0,0,0.4);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#7a0000,#aa0000)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#5a0000,#8b0000)\'">☠ Generate Villains</button>'
        + '<button onclick="swPrintOutput(\'swStoryOutput\')" style="padding:8px 14px;background:rgba(40,30,20,0.5);color:#c4a882;border:1px solid rgba(139,69,19,0.4);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(60,45,30,0.6)\'" onmouseout="this.style.background=\'rgba(40,30,20,0.5)\'">🖨 Print</button>'
        + '<button onclick="swClearStoryOutput()" style="padding:8px 12px;background:rgba(80,0,0,0.25);color:rgba(255,120,120,0.8);border:1px solid rgba(139,0,0,0.35);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(120,0,0,0.35)\'" onmouseout="this.style.background=\'rgba(80,0,0,0.25)\'">✕</button>'
        + '</div>';

    var outEl = document.getElementById('swStoryOutput');
    if (outEl) { outEl.style.display='block'; outEl.innerHTML=storyActivateBar+html; }
    ['swEvolveBtn','swAddSceneBtn'].forEach(function(id){var el=document.getElementById(id);if(el)el.style.display='inline-block';});
    var row2=document.getElementById('swStoryActionRow2'); if(row2) row2.style.display='flex';
    swRenderSavedStories();
    if (typeof swUpdateBuildOnStoryButtonVisibility === 'function') swUpdateBuildOnStoryButtonVisibility();
    swUpdateStoryLinkBars(); // Update badges when story is generated
    if (typeof showToast==='function') showToast('Story generated! ✨','success');
}

function swEvolveStory() {
    if (!_swCurrentStory) { if(typeof showToast==='function')showToast('Generate a story first!','success'); return; }
    var genre = _swCurrentStory.genre;
    var stage = _swCurrentStory.stage;
    var stages=['beginning','rising','midpoint','climax','resolution'];
    var idx=stages.indexOf(stage); var newStage=stages[Math.min(idx+1,stages.length-1)];
    _swCurrentStory.stage=newStage;
    var stageLabels={beginning:'Act I',rising:'Act II — Rising',midpoint:'Act II — Midpoint',climax:'Act III — Climax',resolution:'Resolution'};
    var comp=_swPick(_SWD.complications);
    var npc=_swPick(_SWD.npcRoles);
    var worldD=_swPick(_SWD.worldDetails);
    var dial=_swPick(_SWD.dialogue.confrontation.concat(_SWD.dialogue.action));
    var climax=newStage==='climax'?(_SWD.climax[genre]||_SWD.climax.epic_fantasy):null;
    var html='<div style="background:rgba(20,15,35,0.9);border:1px solid rgba(160,100,255,0.2);border-radius:8px;padding:14px;margin-bottom:10px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.65em;color:#a060ff;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;">📖 New Chapter — '+stageLabels[newStage]+'</div>'
        +'<div style="background:rgba(255,160,96,0.08);border-left:2px solid rgba(255,160,96,0.4);padding:8px 12px;border-radius:0 4px 4px 0;margin-bottom:12px;font-size:0.88em;">⚠ New development: '+comp+'</div>'
        +'<div style="margin-bottom:10px;font-size:0.88em;color:rgba(255,248,180,0.75);">👤 A new figure enters: <em>'+npc+'</em>.</div>'
        +'<div style="margin-bottom:10px;font-size:0.87em;color:rgba(200,200,255,0.7);">🌍 '+worldD+'</div>'
        +'<div style="background:rgba(30,20,50,0.6);border:1px solid rgba(160,100,255,0.2);border-radius:6px;padding:10px 14px;margin-bottom:'+(climax?'12':'0')+'px;"><div style="font-style:italic;color:rgba(220,200,255,0.85);font-size:0.9em;border-left:2px solid rgba(160,100,255,0.4);padding-left:10px;">'+dial+'</div></div>'
        +(climax?'<div style="background:rgba(80,0,0,0.2);border:1px solid rgba(200,0,0,0.3);border-radius:6px;padding:12px 14px;"><div style="font-family:\'Cinzel\',serif;font-size:0.65em;color:#ff8080;text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;">⚡ The Climax</div><div style="font-size:0.88em;color:rgba(255,220,220,0.85);">'+climax+'</div></div>':'')
        +'</div>';
    _swCurrentStory.chapters.push({stage:newStage,html:html,date:new Date().toLocaleDateString()});
    var outEl=document.getElementById('swStoryOutput');
    if(outEl){outEl.style.display='block';outEl.innerHTML+=html;outEl.scrollTop=outEl.scrollHeight;}
    if(typeof showToast==='function')showToast('Story evolved to '+stageLabels[newStage]+'!','success');
}

function swAddScene() {
    if(!_swCurrentStory){if(typeof showToast==='function')showToast('Generate a story first!','success');return;}
    var types=['investigation','confrontation','revelation','alliance','escape','discovery'];
    var t=_swPick(types);
    var descs={investigation:'The party follows a lead. What they find raises more questions.',confrontation:'A face-to-face encounter with someone who has been a background presence.',revelation:'Information surfaces that reframes something the party thought they understood.',alliance:'An unexpected offer of cooperation — from someone with their own agenda.',escape:'Circumstances shift suddenly. The party must move fast with incomplete information.',discovery:'Something is found. Its significance is not immediately clear.'};
    var dial=_swPick(_SWD.dialogue[t==='confrontation'?'confrontation':t==='revelation'?'revelation':t==='escape'?'action':'quiet']);
    var worldD=_swPick(_SWD.worldDetails);
    var comp=_swPick(_SWD.complications);
    var html='<div style="background:rgba(20,15,35,0.9);border:1px solid rgba(160,100,255,0.2);border-radius:8px;padding:14px;margin-bottom:10px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.65em;color:#9060cc;text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;">🎭 Added Scene — '+t.charAt(0).toUpperCase()+t.slice(1)+'</div>'
        +'<div style="font-family:\'Crimson Text\',serif;font-size:0.9em;color:rgba(220,200,255,0.85);margin-bottom:10px;">'+(descs[t]||'')+'</div>'
        +'<div style="background:rgba(255,160,96,0.07);border-left:2px solid rgba(255,160,96,0.35);padding:7px 10px;border-radius:0 4px 4px 0;margin-bottom:8px;font-size:0.85em;color:rgba(255,220,180,0.75);">• '+comp+'</div>'
        +'<div style="font-size:0.85em;color:rgba(200,200,255,0.65);margin-bottom:8px;">🌍 '+worldD+'</div>'
        +'<div style="font-style:italic;color:rgba(220,200,255,0.8);font-size:0.88em;border-left:2px solid rgba(160,100,255,0.35);padding-left:10px;">'+dial+'</div>'
        +'</div>';
    _swCurrentStory.chapters.push({stage:'scene_'+t,html:html,date:new Date().toLocaleDateString()});
    var outEl=document.getElementById('swStoryOutput');
    if(outEl){outEl.style.display='block';outEl.innerHTML+=html;outEl.scrollTop=outEl.scrollHeight;}
    if(typeof showToast==='function')showToast('Scene added — '+t+'! 🎭','success');
}

function swSaveStory() {
    if(!_swCurrentStory){if(typeof showToast==='function')showToast('Nothing to save!','success');return;}
    var idx=_swSavedStories.findIndex(function(s){return s.id===_swCurrentStory.id;});
    if(idx>=0)_swSavedStories[idx]=_swCurrentStory; else _swSavedStories.push(_swCurrentStory);
    _swSave(); swRenderSavedStories();
    if(typeof showToast==='function')showToast('Story saved: '+_swCurrentStory.title,'success');
}

function swLoadStory(id) {
    var s=_swSavedStories.find(function(x){return x.id===id;});
    if(!s)return;
    _swCurrentStory=s;
    var outEl=document.getElementById('swStoryOutput');
    if(outEl){outEl.style.display='block';outEl.innerHTML=(s.chapters||[]).map(function(c){return c.html;}).join('');}
    ['swEvolveBtn','swAddSceneBtn'].forEach(function(id){var el=document.getElementById(id);if(el)el.style.display='inline-block';});
    var row2=document.getElementById('swStoryActionRow2');if(row2)row2.style.display='flex';
    if (typeof swUpdateBuildOnStoryButtonVisibility === 'function') swUpdateBuildOnStoryButtonVisibility();
    swSwitchTab('story');
    if(typeof showToast==='function')showToast('Story loaded: '+s.title,'success');
}

function swDeleteStory(id) {
    var beforeStories = JSON.parse(JSON.stringify(_swSavedStories || []));
    _swSavedStories=_swSavedStories.filter(function(s){return s.id!==id;});
    _swSave(); swRenderSavedStories();
    dmPushUndoAction('Delete story', function() {
        _swSavedStories = JSON.parse(JSON.stringify(beforeStories || []));
        _swSave();
        swRenderSavedStories();
    });
    if(typeof showToast==='function')showToast('Story deleted','success');
}

function swRenderSavedStories() {
    var section=document.getElementById('swSavedStoriesSection');
    var list=document.getElementById('swSavedStoriesList');
    if(!list)return;
    if(!_swSavedStories.length){if(section)section.style.display='none';return;}
    if(section)section.style.display='block';
    list.innerHTML=_swSavedStories.map(function(s){
        return '<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:5px;cursor:pointer;border:1px solid rgba(160,100,255,0.2);background:rgba(100,50,180,0.1);margin-bottom:4px;" onmouseover="this.style.background=\'rgba(100,50,180,0.25)\'" onmouseout="this.style.background=\'rgba(100,50,180,0.1)\'">'
            +'<div onclick="swLoadStory(\''+s.id+'\')"><div style="font-family:\'Cinzel\',serif;font-size:0.78em;color:#d0a0ff;font-weight:700;">'+( s.title||'Untitled')+'</div>'
            +'<div style="font-size:0.7em;color:rgba(200,160,255,0.5);">'+(s.genre||'').replace(/_/g,' ')+' · '+(s.chapters||[]).length+' chapters · '+(s.created||'')+'</div></div>'
            +'<button onclick="event.stopPropagation();swDeleteStory(\''+s.id+'\')" style="background:none;border:1px solid rgba(139,0,0,0.5);color:rgba(240,128,128,0.7);padding:2px 8px;border-radius:4px;cursor:pointer;font-size:0.75em;">✕</button>'
            +'</div>';
    }).join('');
    swUpdateBuildOnStoryButtonVisibility();
}

function swToggleStoryAIPanel() {
    var panel = document.getElementById('swStoryAIPanel');
    var btn = document.getElementById('swStoryAIToggle');
    if (!panel || !btn) return;
    var isOpen = panel.style.display === 'block';
    panel.style.display = isOpen ? 'none' : 'block';
    btn.textContent = isOpen ? '▸ Advanced: Story link, seed, AI endpoint' : '▾ Advanced: Story link, seed, AI endpoint';
    var fileWarn = document.getElementById('swStoryAIFileWarning');
    if (fileWarn) fileWarn.style.display = (window.location.protocol === 'file:' && !window.desktopApp && !isOpen) ? 'block' : 'none';
}

function swOpenOllamaDownload() {
    var url = 'https://ollama.com/download';
    if (window.desktopApp && typeof window.desktopApp.runOllamaSetup === 'function') {
        window.desktopApp.runOllamaSetup().then(function (result) {
            if (result && result.ok) {
                if (typeof showToast === 'function') showToast('Running Ollama installer…', 'success');
            } else {
                if (typeof showToast === 'function') showToast('Installer not found. Opening download page…', 'warning');
                if (typeof window.open === 'function') { var w = window.open(url, '_blank', 'noopener,noreferrer'); if (w) w.opener = null; }
            }
        }).catch(function () {
            if (typeof window.open === 'function') { var w = window.open(url, '_blank', 'noopener,noreferrer'); if (w) w.opener = null; }
            if (typeof showToast === 'function') showToast('Opening Ollama download page…', 'success');
        });
        return;
    }
    if (typeof window.open === 'function') {
        var w = window.open(url, '_blank', 'noopener,noreferrer');
        if (w) w.opener = null;
    }
    if (typeof showToast === 'function') showToast('Opening Ollama download page…', 'success');
}

function swSaveStoryAISettings() {
    try {
        var enabled = document.getElementById('swStoryAIEnabled');
        var url = document.getElementById('swStoryAIUrl');
        var model = document.getElementById('swStoryAIModel');
        if (enabled) localStorage.setItem('dm_story_ai_enabled', enabled.checked ? '1' : '0');
        if (url) localStorage.setItem('dm_story_ai_url', (url.value || '').trim());
        if (model) localStorage.setItem('dm_story_ai_model', (model.value || '').trim());
    } catch (e) {}
}

function swTestStoryAIConnection() {
    var statusEl = document.getElementById('swStoryAIConnectionStatus');
    if (statusEl) statusEl.innerHTML = '<span style="color:rgba(255,248,220,0.8);">Testing…</span>';
    if (window.location.protocol === 'file:' && !window.desktopApp) {
        if (statusEl) statusEl.innerHTML = '<span style="color:#ffb380;">⚠ You opened the HTML file. To use AI: close this, double-click <strong>DND DM Helper Installer 1.0.0.exe</strong> in this folder to install, then open the app from the Start Menu.</span>';
        return;
    }
    swCallLocalAI('Reply with only the word OK.', null, function(err, text) {
        if (statusEl) {
            if (err) statusEl.innerHTML = '<span style="color:#f08080;">' + (err.message || String(err)) + '</span>';
            else statusEl.innerHTML = '<span style="color:#80e080;">✓ AI is working. You can generate story with AI.</span>';
        }
    });
}

function swSyncStoryScopeCardStyle() {
    var scope = document.querySelector('input[name="storyScope"]:checked');
    var val = (scope && scope.value) ? scope.value : 'oneshot';
    document.querySelectorAll('.sw-story-scope-option').forEach(function(el) {
        var radio = el.querySelector('input[name="storyScope"]');
        if (!radio) return;
        if (radio.value === val) {
            el.style.borderColor = 'rgba(160,100,255,0.65)';
            el.style.background = 'linear-gradient(145deg,rgba(40,32,65,0.95),rgba(55,45,85,0.95))';
        } else {
            el.style.borderColor = 'rgba(160,100,255,0.3)';
            el.style.background = 'linear-gradient(145deg,rgba(30,25,50,0.9),rgba(45,35,70,0.9))';
        }
    });
}
function swLoadStoryAISettings() {
    try {
        var defaultUrl = 'http://127.0.0.1:11434';
        if (window.desktopApp) {
            if (!localStorage.getItem('dm_story_ai_url')) localStorage.setItem('dm_story_ai_url', defaultUrl);
            if (!localStorage.getItem('dm_story_ai_enabled')) localStorage.setItem('dm_story_ai_enabled', '1');
        }
        var enabled = document.getElementById('swStoryAIEnabled');
        var url = document.getElementById('swStoryAIUrl');
        var model = document.getElementById('swStoryAIModel');
        if (enabled) enabled.checked = localStorage.getItem('dm_story_ai_enabled') === '1';
        if (url) url.value = (localStorage.getItem('dm_story_ai_url') || defaultUrl).trim();
        if (model) model.value = (localStorage.getItem('dm_story_ai_model') || 'llama2').trim();
        var howEl = document.getElementById('swStoryAIHowItWorks');
        if (howEl) {
            howEl.innerHTML = window.desktopApp
                ? '<strong>How local AI works:</strong> This app sends your prompt to <strong>Ollama</strong> on your computer. Install Ollama (Options → AI or ollama.com), then pull a model: <code style="background:rgba(0,0,0,0.3);padding:1px 4px;border-radius:3px;">ollama pull llama2</code>. The app can try to start Ollama when you open it.'
                : '<strong>To use AI:</strong> Install the app first. In this folder, double-click <strong>DND DM Helper Installer 1.0.0.exe</strong>, then open the app from the Start Menu. In the app, go to Options → AI to install Ollama if needed. Do not use the HTML file for AI.';
        }
        if (typeof swSyncStoryScopeCardStyle === 'function') swSyncStoryScopeCardStyle();
        document.querySelectorAll('input[name="storyScope"]').forEach(function(r) {
            r.removeEventListener('change', window._swStoryScopeChange);
        });
        window._swStoryScopeChange = function() { if (typeof swSyncStoryScopeCardStyle === 'function') swSyncStoryScopeCardStyle(); };
        document.querySelectorAll('input[name="storyScope"]').forEach(function(r) {
            r.addEventListener('change', window._swStoryScopeChange);
        });
        var statusEl = document.getElementById('swStoryAIConnectionStatus');
        if (statusEl && window.desktopApp && typeof window.desktopApp.getOllamaStatus === 'function') {
            window.desktopApp.getOllamaStatus().then(function(s) {
                if (s.connected) {
                    statusEl.innerHTML = '<span style="color:#80c080;">Ollama connected. You can generate stories and use the DM chatbot.</span>';
                } else {
                    statusEl.innerHTML = '<span style="color:#f0a060;">Ollama not running. Go to <strong>Options → AI</strong> to install Ollama and pull a model (e.g. llama2).</span>';
                }
            }).catch(function() {
                statusEl.innerHTML = '<span style="color:#f0a060;">Could not detect Ollama. Go to <strong>Options → AI</strong> to install and set up.</span>';
            });
        }
    } catch (e) {}
}

function swUpdateBuildOnStoryButtonVisibility() {
    var btn = document.getElementById('swBuildOnStoryAIBtn');
    if (btn) btn.style.display = (window._swCurrentStory && window._swCurrentStory.chapters && window._swCurrentStory.chapters.length) ? 'inline-block' : 'none';
}

function swCallLocalAI(prompt, systemPrompt, callback, options) {
    var urlEl = document.getElementById('swStoryAIUrl');
    var modelEl = document.getElementById('swStoryAIModel');
    var optUrl = document.getElementById('optionsAIUrl');
    var optModel = document.getElementById('optionsAIModel');
    var baseUrl = (urlEl && urlEl.value ? urlEl.value : (optUrl && optUrl.value ? optUrl.value : null) || localStorage.getItem('dm_story_ai_url') || 'http://127.0.0.1:11434').trim().replace(/\/+$/, '');
    var model = (modelEl && modelEl.value ? modelEl.value : (optModel && optModel.value ? optModel.value : null) || localStorage.getItem('dm_story_ai_model') || 'llama2').trim() || 'llama2';
    var fullPrompt = (systemPrompt ? (systemPrompt + '\n\n') : '') + prompt;
    var timeoutMs = 180000;
    var aborter = typeof AbortController !== 'undefined' ? new AbortController() : null;
    var timeoutId = aborter ? window.setTimeout(function() { if (aborter) aborter.abort(); }, timeoutMs) : null;
    var opts = (options && typeof options === 'object') ? options : {};

    function done(err, text) {
        if (timeoutId) window.clearTimeout(timeoutId);
        if (typeof callback === 'function') callback(err, text);
    }

    function isNetworkError(err) {
        var msg = (err && err.message) ? err.message : String(err);
        return !msg || /failed to fetch|NetworkError|Load failed|CORS|ERR_CONNECTION_REFUSED|ERR_CONNECTION_RESET|Failed to fetch|TypeError/i.test(msg);
    }

    // Prefer main-process proxy when in desktop app (avoids CORS / fetch blocking)
    if (window.desktopApp && typeof window.desktopApp.ollamaGenerate === 'function') {
        var doGenerate = function() {
            var payload = { baseUrl: baseUrl, model: model, prompt: prompt, system: systemPrompt || '' };
            if (Object.keys(opts).length) payload.options = opts;
            window.desktopApp.ollamaGenerate(payload)
                .then(function(result) {
                    if (result && result.ok) {
                        done(null, (result.response != null) ? String(result.response).trim() : '');
                    } else {
                        done(new Error((result && result.error) ? result.error : 'AI request failed'), null);
                    }
                })
                .catch(function(err) {
                    done(err && err.message ? err : new Error(String(err)), null);
                });
        };
        if (typeof window.desktopApp.ensureOllamaRunning === 'function') {
            window.desktopApp.ensureOllamaRunning().then(function(r) { doGenerate(); }).catch(function() { doGenerate(); });
        } else {
            doGenerate();
        }
        return;
    }

    function tryOllamaGenerate() {
        var apiUrl = baseUrl + '/api/generate';
        var body = { model: model, prompt: prompt, stream: false };
        if (systemPrompt && String(systemPrompt).trim()) body.system = String(systemPrompt).trim();
        if (Object.keys(opts).length) body.options = opts;
        return fetch(apiUrl, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
            signal: aborter ? aborter.signal : undefined
        }).then(function(r) {
            if (!r.ok) throw new Error('Server returned ' + r.status + '. Check the model name ("' + model + '") and that Ollama is running.');
            return r.json();
        }).then(function(data) {
            var text = (data && data.response) ? data.response : (data && data.message && data.message.content) ? data.message.content : '';
            done(null, String(text).trim());
        });
    }

    function tryOpenAIChat() {
        var apiUrl = baseUrl + '/v1/chat/completions';
        var body = {
            model: model,
            messages: [
                systemPrompt ? { role: 'system', content: systemPrompt } : null,
                { role: 'user', content: prompt }
            ].filter(Boolean),
            max_tokens: 2048
        };
        return fetch(apiUrl, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
            signal: aborter ? aborter.signal : undefined
        }).then(function(r) {
            if (!r.ok) throw new Error('Server returned ' + r.status);
            return r.json();
        }).then(function(data) {
            var text = (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? data.choices[0].message.content : '';
            done(null, String(text).trim());
        });
    }

    var connectionHint = (window.desktopApp ? 'Fix: 1) Start Ollama (run "ollama serve" or open Ollama app). 2) Pull a model: ollama pull llama2' : 'You opened the HTML file. To use AI: 1) Close this page. 2) In this folder, double-click DND DM Helper Installer 1.0.0.exe to install. 3) Open the app from the Start Menu. 4) In the app, use Options → AI to install Ollama if needed.');
    tryOllamaGenerate().catch(function(err) {
        if (err && err.name === 'AbortError') {
            done(new Error('Request timed out after ' + (timeoutMs / 1000) + ' seconds.'), null);
            return;
        }
        var msg = (err && err.message) ? err.message : String(err);
        if (isNetworkError(err) || isNetworkError({ message: msg })) {
            done(new Error('Cannot reach AI. ' + connectionHint), null);
            return;
        }
        tryOpenAIChat().catch(function(err2) {
            if (err2 && err2.name === 'AbortError') { done(new Error('Request timed out.'), null); return; }
            if (isNetworkError(err2)) {
                done(new Error('Cannot reach AI at ' + baseUrl + '. ' + connectionHint), null);
                return;
            }
            var msg2 = (err2 && err2.message) ? err2.message : String(err2);
            done(err2 || new Error(msg2 || 'AI request failed'), null);
        });
    });
}

function campaignImportFromFile(ev) {
    var f = ev.target && ev.target.files[0];
    if (!f) return;
    var ta = document.getElementById('campaignImportText');
    if (!ta) return;
    var isPdf = (f.type === 'application/pdf' || /\.pdf$/i.test(f.name || ''));
    if (isPdf) {
        if (typeof showToast === 'function') showToast('PDF: paste extracted text into the box below.', 'success');
        ev.target.value = ''; return;
    }
    var r = new FileReader();
    r.onload = function() { ta.value = r.result || ''; if (typeof showToast === 'function') showToast('File loaded', 'success'); };
    r.readAsText(f);
    ev.target.value = '';
}
function campaignAIAdaptContent() {
    var ta = document.getElementById('campaignImportText');
    var text = (ta && ta.value) ? ta.value.trim() : '';
    if (!text) { if (typeof showToast === 'function') showToast('Paste or import your campaign first', 'success'); return; }
    if (!window.appAIIsAvailable || !window.appAIIsAvailable()) { if (typeof showToast === 'function') showToast('Set up AI in Options → AI (Ollama)', 'success'); return; }
    if (typeof showToast === 'function') showToast('AI adapting content…', 'success');
    var sys = 'You are a D&D 5e expert. Given the campaign document below, output a short CAMPAIGN CONTEXT (2–4 sentences) for the DM to paste into "Campaign context", then 3 quest ideas, 2 bounty ideas, and 2 location ideas — each one line. Format: CAMPAIGN CONTEXT: ... QUEST IDEAS: 1. ... 2. ... 3. ... BOUNTY IDEAS: 1. ... 2. ... LOCATION IDEAS: 1. ... 2. ...';
    (window.appAIGenerateWithBusy || window.appAIGenerate || function(opts){ return (window.desktopApp && window.desktopApp.ollamaGenerate) ? window.desktopApp.ollamaGenerate(opts).then(function(r){ return r && r.ok ? { ok: true, response: r.response } : { ok: false, error: r && r.error || 'AI failed' }; }) : Promise.resolve({ ok: false, error: 'AI not available' }); })({ prompt: text, system: sys }).then(function(r) {
        if (r && r.ok && r.response) {
            var frameEl = document.getElementById('storyCampaignFrame');
            var m = String(r.response).match(/CAMPAIGN CONTEXT:\s*([^\n]+(?:\n(?!QUEST)[^\n]+)*)/i);
            if (frameEl && m && m[1]) frameEl.value = m[1].trim();
            if (typeof showToast === 'function') showToast('Context updated. See output for quest/bounty/location ideas.', 'success');
            ta.value = '--- AI summary ---\n' + r.response + '\n\n--- Your original ---\n' + text;
        } else { if (typeof showToast === 'function') showToast(r && r.error ? r.error : 'AI failed', 'success'); }
    });
}
function campaignAIFinishStory() {
    var ta = document.getElementById('campaignImportText');
    var text = (ta && ta.value) ? ta.value.trim() : '';
    if (!text) { if (typeof showToast === 'function') showToast('Paste your half-done story first', 'success'); return; }
    if (!window.appAIIsAvailable || !window.appAIIsAvailable()) { if (typeof showToast === 'function') showToast('Set up AI in Options → AI (Ollama)', 'success'); return; }
    if (typeof showToast === 'function') showToast('AI finishing story…', 'success');
    var sys = 'You are a D&D 5e dungeon master. The user has pasted a campaign or story that is incomplete. Continue and finish it in the same tone and style. Write the next section(s) so the DM can run it. Use plain text; no markdown.';
    (window.appAIGenerateWithBusy || window.appAIGenerate || function(opts){ return (window.desktopApp && window.desktopApp.ollamaGenerate) ? window.desktopApp.ollamaGenerate(opts).then(function(r){ return r && r.ok ? { ok: true, response: r.response } : { ok: false, error: r && r.error || 'AI failed' }; }) : Promise.resolve({ ok: false, error: 'AI not available' }); })({ prompt: text, system: sys }).then(function(r) {
        if (r && r.ok && r.response) { ta.value = text + '\n\n--- AI continuation ---\n\n' + r.response; if (typeof showToast === 'function') showToast('Story continued below', 'success'); }
        else { if (typeof showToast === 'function') showToast(r && r.error ? r.error : 'AI failed', 'success'); }
    });
}
function swViewFullCampaign() {
    var cur = window._swCurrentStory;
    var saved = (typeof window._swSavedStories !== 'undefined' && window._swSavedStories) ? window._swSavedStories : [];
    var html = '<div style="padding:16px;font-family:\'Crimson Text\',serif;">';
    html += '<h3 style="font-family:\'Cinzel\',serif;color:#e0c0ff;">📖 Full campaign view</h3>';
    if (cur && cur.chapters && cur.chapters.length) {
        html += '<div style="margin-bottom:16px;"><strong style="color:#c0a0ff;">Main story:</strong> ' + (cur.title || 'Untitled') + '</div>';
        cur.chapters.forEach(function(ch, i) { html += '<div style="background:rgba(20,15,40,0.6);border:1px solid rgba(160,100,255,0.3);border-radius:8px;padding:12px;margin-bottom:10px;">' + (ch.html || '').replace(/<script[\s\S]*?<\/script>/gi,'') + '</div>'; });
    }
    if (saved && saved.length) {
        html += '<div style="margin-top:16px;"><strong style="color:#b090e8;">Saved / linked stories:</strong></div>';
        saved.slice(0, 10).forEach(function(s) { html += '<div style="padding:8px;margin:6px 0;background:rgba(30,25,50,0.5);border-radius:6px;">' + (s.title || s.id || 'Story') + '</div>'; });
    }
    html += '</div>';
    var w = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
    if (w) { w.document.write('<!DOCTYPE html><html><head><title>Full campaign</title><style>body{background:#0a0a14;color:#e0e0e0;}</style></head><body>' + html + '</body></html>'); w.document.close(); }
}
function swCancelStoryAIGeneration() {
    window._swStoryAIGenId = 0;
    if (window._swStoryAIProgressStop) { window._swStoryAIProgressStop(false); window._swStoryAIProgressStop = null; }
    var btn = document.getElementById('swGenerateStoryWithAIBtn');
    var cancelBtn = document.getElementById('swCancelStoryAIBtn');
    var statusEl = document.getElementById('swStoryAIConnectionStatus');
    if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
    if (cancelBtn) cancelBtn.style.display = 'none';
    if (statusEl) statusEl.innerHTML = '<span style="color:#f0a060;">Cancelled.</span>';
    if (typeof showToast === 'function') showToast('AI story generation cancelled', 'success');
}

function swGenerateStoryWithAI() {
    if (!window.desktopApp) {
        var enabled = document.getElementById('swStoryAIEnabled');
        if (enabled && !enabled.checked) {
            if (typeof showToast === 'function') showToast('Enable "Use local AI" and set endpoint (e.g. http://127.0.0.1:11434 for Ollama)', 'success');
            return;
        }
    }
    var statusEl = document.getElementById('swStoryAIConnectionStatus');
    var btn = document.getElementById('swGenerateStoryWithAIBtn');
    var cancelBtn = document.getElementById('swCancelStoryAIBtn');
    var genId = Date.now();
    window._swStoryAIGenId = genId;
    if (statusEl) statusEl.innerHTML = '<span style="color:#c0a0ff;">Generating story… 5%</span> <span style="color:rgba(255,255,255,0.45);font-size:0.9em;">(typically 1–3 min)</span><div style="margin-top:6px;height:4px;background:rgba(0,0,0,0.3);border-radius:2px;overflow:hidden;"><div id="swStoryProgressFill" style="height:100%;width:5%;background:linear-gradient(90deg,#4a0080,#a060ff);transition:width 0.25s;"></div></div>';
    if (btn) { btn.disabled = true; btn.style.opacity = '0.7'; }
    if (cancelBtn) cancelBtn.style.display = 'inline-block';
    window._swStoryAIProgressStop = startAILoadingProgress({
        label: 'Generating story…',
        cap: 92,
        updateStatus: function(p, lbl) {
            var el = document.getElementById('swStoryAIConnectionStatus');
            if (el) el.innerHTML = '<span style="color:#c0a0ff;">' + lbl + ' ' + p + '%</span> <span style="color:rgba(255,255,255,0.45);font-size:0.9em;">(typically 1–3 min)</span><div style="margin-top:6px;height:4px;background:rgba(0,0,0,0.3);border-radius:2px;overflow:hidden;"><div id="swStoryProgressFill" style="height:100%;width:' + p + '%;background:linear-gradient(90deg,#4a0080,#a060ff);transition:width 0.25s;"></div></div>';
        }
    });
    var runCfg = typeof swGetStoryRunConfig === 'function' ? swGetStoryRunConfig() : {};
    var genre = (document.getElementById('storyGenre') || {}).value || 'epic_fantasy';
    var tone = (document.getElementById('storyTone') || {}).value || 'grim';
    var frame = (document.getElementById('storyCampaignFrame') || {}).value || '';
    var goal = (document.getElementById('storyPlayerGoal') || {}).value || '';
    var opening = (document.getElementById('storyOpeningPrompt') || {}).value || '';
    var aiPromptEl = document.getElementById('swStoryAIPrompt');
    var aiPrompt = (aiPromptEl && aiPromptEl.value) ? aiPromptEl.value.trim() : '';
    var magicLevel = runCfg.magicLevel || (document.getElementById('storyMagicLevel') || {}).value || '';
    var conflictStyle = runCfg.conflictStyle || (document.getElementById('storyConflictStyle') || {}).value || '';
    var genreLabel = (genre || 'epic_fantasy').replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
    var hasUserInput = !!(frame || goal || opening || aiPrompt);
    var systemPrompt = 'D&D 5e session-ready story. Plain text only. Use ONLY these labels (one per line), then one short paragraph or bullets under each:\n'
        + 'TITLE / HOOK / GOAL / ANTAGONIST / COMPLICATION 1 / COMPLICATION 2 / OPENING SCENE / KEY NPCs / SCENE BEATS / CLIMAX\n'
        + 'Keep fantasy tone, clear goals and opposition. '
        + (hasUserInput ? 'Build the whole story around the user\'s prompt and campaign context.' : 'Invent a complete story for the given genre and tone; no placeholders.');
    var userPrompt = '';
    var scope = (runCfg && runCfg.scope) ? runCfg.scope : 'oneshot';
    var scopeLabel = scope === 'campaign' ? 'campaign (ongoing arc, multi-session)' : 'one-shot (single session, self-contained)';
    if (aiPrompt) {
        userPrompt = 'STORY REQUEST (this is the main instruction — build the whole story around it): ' + aiPrompt + '\n\n';
    } else {
        userPrompt = 'No specific story idea was given — create a fresh, random story using your creativity. ';
    }
    userPrompt += 'Generate a ' + scopeLabel + ' ' + genreLabel + ' story. Tone: ' + (tone || 'grim') + '.';
    if (magicLevel) userPrompt += ' Magic level: ' + (magicLevel.replace(/_/g, ' ') || magicLevel) + '.';
    if (conflictStyle) userPrompt += ' Conflict style: ' + (conflictStyle.replace(/_/g, ' ') || conflictStyle) + '.';
    if (frame) userPrompt += ' CAMPAIGN CONTEXT (use this as the world and situation): ' + frame + '.';
    if (goal) userPrompt += ' PLAYER FOCUS GOAL (the story must center on this objective): ' + goal + '.';
    if (opening) userPrompt += ' OPENING SCENE PROMPT (the hook and first scene must follow from this): ' + opening + '.';
    var partyNames = (typeof _party !== 'undefined' && _party && _party.length) ? _party.map(function(p){ return p.name || ''; }).filter(Boolean) : [];
    if (partyNames.length) userPrompt += ' USE THESE PLAYER CHARACTER NAMES IN THE STORY: ' + partyNames.join(', ') + '. Include a dramatic INTRO PARAGRAPH that the DM reads aloud to open the session, and a "How the party met" section that uses these names.';
    if (hasUserInput) userPrompt += ' Do not ignore the story request or context above — build the entire story around them.';
    userPrompt += '\n\nFormat like a D&D one-shot or campaign book: full narrative, big intro to read aloud, then how the players met (using the names above), then structured sections: TITLE, HOOK, GOAL, ANTAGONIST, COMPLICATION 1, COMPLICATION 2, OPENING SCENE, KEY NPCs, SCENE BEATS, CLIMAX.';
    if (typeof showToast === 'function') showToast('Calling local AI…', 'success');
    swCallLocalAI(userPrompt, systemPrompt, function(err, text) {
        var statusEl = document.getElementById('swStoryAIConnectionStatus');
        var btn = document.getElementById('swGenerateStoryWithAIBtn');
        var cancelBtn = document.getElementById('swCancelStoryAIBtn');
        try {
            if (window._swStoryAIProgressStop) { window._swStoryAIProgressStop(!err); window._swStoryAIProgressStop = null; }
            if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
            if (cancelBtn) cancelBtn.style.display = 'none';
            if (window._swStoryAIGenId !== genId) return;
            if (err) {
                if (statusEl) statusEl.innerHTML = '<span style="color:#f08080;">' + (typeof _swEscapeHtml === 'function' ? _swEscapeHtml(err.message || String(err)) : String(err).replace(/</g,'&lt;').replace(/>/g,'&gt;')) + '</span>';
                if (typeof showToast === 'function') showToast('AI error: ' + (err.message || err), 'success');
                return;
            }
            if (!text || String(text).trim() === '') {
                if (statusEl) statusEl.innerHTML = '<span style="color:#f0a060;">No story text returned.</span> <span style="color:rgba(255,255,255,0.6);font-size:0.9em;">Check Options → AI: Ollama running, model name (e.g. llama2) correct. Try a shorter prompt or a smaller model (e.g. llama3.2:1b) for faster results.</span>';
                if (typeof showToast === 'function') showToast('No text returned from AI – check Options → AI', 'success');
                return;
            }
            var rawText = String(text).trim();
            var maxLen = 120000;
            var displayText = rawText.length > maxLen ? rawText.slice(0, maxLen) + '\n\n[... truncated for display ...]' : rawText;
            var storyId = 'story_ai_' + Date.now();
            var title = 'AI Story — ' + new Date().toLocaleDateString();
            var titleMatch = rawText.match(/^\s*TITLE:\s*(.+?)(?:\n|$)/im);
            if (titleMatch && titleMatch[1]) title = titleMatch[1].trim();
            var scopeLabelOut = (runCfg && runCfg.scope === 'campaign') ? 'Campaign Arc' : 'One-Shot Adventure';
            var esc = typeof _swEscapeHtml === 'function' ? _swEscapeHtml : function(s) { return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;'); };

            /* Parse AI text into labelled sections for D&D book layout */
            var aiSections = {};
            var sectionOrder = ['TITLE','HOOK','GOAL','ANTAGONIST','COMPLICATION 1','COMPLICATION 2','OPENING SCENE','KEY NPCS','SCENE BEATS','CLIMAX'];
            var currentKey = '_intro';
            aiSections['_intro'] = '';
            displayText.split('\n').forEach(function(line) {
                var trimmed = line.replace(/^\s+/,'');
                var matched = false;
                sectionOrder.forEach(function(key) {
                    var re = new RegExp('^' + key.replace(/ /g,'\\s*') + '\\s*[:\\-–]?\\s*', 'i');
                    if (re.test(trimmed)) { currentKey = key; aiSections[key] = trimmed.replace(re, ''); matched = true; }
                });
                if (!matched) { aiSections[currentKey] = (aiSections[currentKey] || '') + '\n' + line; }
            });
            /* Clean up parsed sections */
            Object.keys(aiSections).forEach(function(k) { aiSections[k] = (aiSections[k] || '').trim(); });

            var html = '<div class="dnd-book" style="margin-bottom:10px;">'
                /* Cover */
                + '<div class="dnd-book-cover">'
                + '<div style="font-family:\'Cinzel\',serif;font-size:0.6em;color:#8b4513;letter-spacing:4px;text-transform:uppercase;margin-bottom:6px;position:relative;">A Fifth Edition Adventure · AI Generated</div>'
                + '<div class="dnd-book-title">' + esc(title) + '</div>'
                + '<div class="dnd-book-subtitle">' + esc(scopeLabelOut) + '</div>'
                + '<div class="dnd-book-tags">'
                + '<span class="dnd-book-tag">' + esc(genreLabel) + '</span>'
                + '<span class="dnd-book-tag">' + esc(tone || 'grim') + '</span>'
                + '<span class="dnd-book-tag">AI Generated</span>'
                + '</div></div>'
                + '<hr class="dnd-book-divider">'
                + '<div class="dnd-book-body">';

            /* Intro / Background */
            if (aiSections['_intro']) {
                html += '<div class="dnd-chapter">'
                    + '<div class="dnd-chapter-header">Adventure Background</div>'
                    + '<div class="dnd-chapter-title">The Story So Far</div>'
                    + '<div class="dnd-chapter-text"><p style="margin:0;">' + esc(aiSections['_intro']) + '</p></div>'
                    + '</div><hr class="dnd-section-rule">';
            }

            /* Chapter 1: The Hook & Opening */
            html += '<div class="dnd-chapter">'
                + '<div class="dnd-chapter-header">Chapter 1</div>'
                + '<div class="dnd-chapter-title">The Call to Adventure</div>';
            if (aiSections['HOOK']) {
                html += '<div class="dnd-chapter-text"><p style="margin:0 0 12px;">' + esc(aiSections['HOOK']) + '</p></div>';
            }
            if (aiSections['OPENING SCENE']) {
                html += '<div class="dnd-read-aloud"><p>' + esc(aiSections['OPENING SCENE']) + '</p></div>';
            }
            if (aiSections['GOAL']) {
                html += '<div class="dnd-sidebar"><div class="dnd-sidebar-title">Adventure Goal</div><p>' + esc(aiSections['GOAL']) + '</p></div>';
            }
            html += '</div><hr class="dnd-section-rule">';

            /* Chapter 2: Forces of Opposition */
            html += '<div class="dnd-chapter">'
                + '<div class="dnd-chapter-header">Chapter 2</div>'
                + '<div class="dnd-chapter-title">Forces of Opposition</div>';
            if (aiSections['ANTAGONIST']) {
                html += '<div class="dnd-encounter-box"><div class="dnd-encounter-title">The Antagonist</div>'
                    + '<div class="dnd-chapter-text"><p style="margin:0;">' + esc(aiSections['ANTAGONIST']) + '</p></div></div>';
            }
            if (aiSections['COMPLICATION 1'] || aiSections['COMPLICATION 2']) {
                html += '<div class="dnd-chapter-text" style="margin-top:12px;">'
                    + '<div style="font-family:\'Cinzel\',serif;font-size:0.75em;color:#daa520;font-weight:700;margin-bottom:8px;">Complications</div>';
                if (aiSections['COMPLICATION 1']) html += '<p style="margin:0 0 8px;padding-left:12px;border-left:3px solid rgba(139,69,19,0.5);">' + esc(aiSections['COMPLICATION 1']) + '</p>';
                if (aiSections['COMPLICATION 2']) html += '<p style="margin:0;padding-left:12px;border-left:3px solid rgba(139,69,19,0.5);">' + esc(aiSections['COMPLICATION 2']) + '</p>';
                html += '</div>';
            }
            html += '</div><hr class="dnd-section-rule">';

            /* Chapter 3: Key NPCs */
            if (aiSections['KEY NPCS']) {
                html += '<div class="dnd-chapter">'
                    + '<div class="dnd-chapter-header">Chapter 3</div>'
                    + '<div class="dnd-chapter-title">Allies &amp; Rivals</div>'
                    + '<div class="dnd-npc-block"><div class="dnd-npc-name">Key Figures</div>'
                    + '<div class="dnd-npc-desc">' + esc(aiSections['KEY NPCS']) + '</div></div>'
                    + '</div><hr class="dnd-section-rule">';
            }

            /* Chapter 4: Scene Beats */
            if (aiSections['SCENE BEATS']) {
                html += '<div class="dnd-chapter">'
                    + '<div class="dnd-chapter-header">Chapter 4</div>'
                    + '<div class="dnd-chapter-title">Adventure Progression</div>'
                    + '<div class="dnd-chapter-text"><p style="margin:0;white-space:pre-wrap;">' + esc(aiSections['SCENE BEATS']) + '</p></div>'
                    + '</div><hr class="dnd-section-rule">';
            }

            /* Chapter 5: Climax */
            if (aiSections['CLIMAX']) {
                html += '<div class="dnd-chapter">'
                    + '<div class="dnd-chapter-header">Chapter 5</div>'
                    + '<div class="dnd-chapter-title">The Final Confrontation</div>'
                    + '<div class="dnd-encounter-box"><div class="dnd-encounter-title">Climax</div>'
                    + '<div class="dnd-chapter-text"><p style="margin:0;">' + esc(aiSections['CLIMAX']) + '</p></div></div>'
                    + '</div>';
            }

            html += '</div></div>';
            window._swCurrentStory = {
                id: storyId,
                title: title,
                genre: genre,
                tone: tone,
                stage: 'beginning',
                antagonist: '',
                goal: goal || '',
                plot: '',
                chapters: [{ stage: 'beginning', html: html, date: new Date().toLocaleDateString() }],
                created: new Date().toLocaleDateString()
            };
            var outEl = document.getElementById('swStoryOutput');
            var activateBar = '<div style="background:linear-gradient(90deg,#1a0e0a,#2a1a10,#1a0e0a);border-bottom:3px solid #8b4513;padding:11px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:10;">'
                + '<button onclick="swSaveAndActivateStory()" style="padding:8px 20px;background:linear-gradient(145deg,#5a3000,#8b4513);color:#ffe8c0;border:1px solid #daa520;border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">⚡ Set as Active Story</button>'
                + '<button onclick="swViewFullCampaign()" style="padding:8px 16px;background:rgba(60,80,40,0.5);color:#c0e8a0;border:1px solid rgba(100,160,60,0.6);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">📖 View Full Campaign</button>'
                + '<button onclick="swSaveStory()" style="padding:8px 16px;background:rgba(40,30,20,0.7);color:#daa520;border:1px solid rgba(139,69,19,0.7);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">💾 Save Story</button>'
                + '<button onclick="swPrintOutput(\'swStoryOutput\')" style="padding:8px 14px;background:rgba(40,30,20,0.5);color:#c4a882;border:1px solid rgba(139,69,19,0.4);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">🖨 Print</button>'
                + '<button onclick="swClearStoryOutput()" style="padding:8px 12px;background:rgba(80,0,0,0.25);color:rgba(255,120,120,0.8);border:1px solid rgba(139,0,0,0.35);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">✕</button></div>';
            if (typeof swSwitchTab === 'function') swSwitchTab('story');
            if (outEl) {
                outEl.style.display = 'block';
                outEl.innerHTML = activateBar + html;
                setTimeout(function() { try { outEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch (_) {} }, 100);
            }
            ['swEvolveBtn', 'swAddSceneBtn', 'swClearStoryBtn'].forEach(function(id) { var el = document.getElementById(id); if (el) el.style.display = 'inline-block'; });
            var row2 = document.getElementById('swStoryActionRow2'); if (row2) row2.style.display = 'flex';
            if (typeof swRenderSavedStories === 'function') swRenderSavedStories();
            if (typeof swUpdateBuildOnStoryButtonVisibility === 'function') swUpdateBuildOnStoryButtonVisibility();
            if (statusEl) statusEl.innerHTML = '<span style="color:#80c080;">✓ Story generated.</span>';
            if (typeof showToast === 'function') showToast('Story generated with AI', 'success');
        } catch (e) {
            if (window._swStoryAIProgressStop) { try { window._swStoryAIProgressStop(false); } catch (_) {} window._swStoryAIProgressStop = null; }
            if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
            if (cancelBtn) cancelBtn.style.display = 'none';
            if (statusEl) statusEl.innerHTML = '<span style="color:#f08080;">Something went wrong.</span> <span style="color:rgba(255,255,255,0.6);font-size:0.9em;">' + (e && e.message ? String(e.message).replace(/</g,'&lt;') : 'Try again or check Options → AI.') + '</span>';
            if (typeof showToast === 'function') showToast('Story generation error', 'success');
            console.error('swGenerateStoryWithAI', e);
        }
    }, { temperature: 0.85, num_predict: 2048, num_ctx: 4096 });
}

function swBuildOnStoryWithAI() {
    if (!window._swCurrentStory || !window._swCurrentStory.chapters || !window._swCurrentStory.chapters.length) {
        if (typeof showToast === 'function') showToast('Generate or load a story first', 'success');
        return;
    }
    if (!window.desktopApp) {
        var enabled = document.getElementById('swStoryAIEnabled');
        if (enabled && !enabled.checked) {
            if (typeof showToast === 'function') showToast('Enable "Use local AI" and set endpoint', 'success');
            return;
        }
    }
    var cur = window._swCurrentStory;
    var title = cur.title || 'Current Story';
    var goal = cur.goal || '';
    var antagonist = cur.antagonist || '';
    var lastChapter = cur.chapters[cur.chapters.length - 1];
    var lastHtml = (lastChapter && lastChapter.html) ? lastChapter.html : '';
    var summary = 'Story: "' + (title || 'Untitled') + '". Goal: ' + (goal || '—') + '. Antagonist: ' + (antagonist || '—') + '.';
    var systemPrompt = 'You are an expert D&D 5e dungeon master. Continue or expand the story in a coherent way. Write what happens next: new developments, twists, or a new scene that a DM can run at the table. Keep tone, stakes, and character names consistent with the existing story. Use plain text; no markdown. Stay within fantasy/D&D tone. Your continuation should feel like the next chapter, not a summary—include concrete details the DM can read or adapt.';
    var lastText = (lastHtml || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim().slice(0, 1800);
    var userPrompt = summary + '\n\nLast part of the story (for context):\n' + lastText + '\n\nContinue or expand this story. What happens next? Keep it coherent, engaging, and consistent with the story above.';
    if (typeof showToast === 'function') showToast('Building on story with AI…', 'success');
    var statusElBuild = document.getElementById('swStoryAIConnectionStatus');
    if (statusElBuild) statusElBuild.innerHTML = '<span style="color:#c0a0ff;">Expanding story… 5%</span><div style="margin-top:6px;height:4px;background:rgba(0,0,0,0.3);border-radius:2px;overflow:hidden;"><div id="swBuildProgressFill" style="height:100%;width:5%;background:linear-gradient(90deg,#4a0080,#a060ff);transition:width 0.25s;"></div></div>';
    var stopBuildProgress = startAILoadingProgress({
        label: 'Expanding story…',
        cap: 92,
        updateStatus: function(p, lbl) {
            var el = document.getElementById('swStoryAIConnectionStatus');
            if (el) el.innerHTML = '<span style="color:#c0a0ff;">' + lbl + ' ' + p + '%</span><div style="margin-top:6px;height:4px;background:rgba(0,0,0,0.3);border-radius:2px;overflow:hidden;"><div id="swBuildProgressFill" style="height:100%;width:' + p + '%;background:linear-gradient(90deg,#4a0080,#a060ff);transition:width 0.25s;"></div></div>';
        }
    });
    swCallLocalAI(userPrompt, systemPrompt, function(err, text) {
        stopBuildProgress(!err);
        if (err) {
            if (statusElBuild) statusElBuild.innerHTML = '<span style="color:#f08080;">' + (err.message || String(err)) + '</span>';
            if (typeof showToast === 'function') showToast('AI error: ' + (err.message || err), 'success');
            return;
        }
        if (!text) {
            if (statusElBuild) statusElBuild.innerHTML = '<span style="color:#f0a060;">No text returned from AI.</span>';
            if (typeof showToast === 'function') showToast('No text returned from AI', 'success');
            return;
        }
        if (statusElBuild) statusElBuild.innerHTML = '<span style="color:#80c080;">Story expanded.</span>';
        var html = '<div style="background:rgba(20,15,35,0.9);border:1px solid rgba(160,100,255,0.25);border-radius:8px;padding:14px;margin-bottom:10px;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.65em;color:#9060cc;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;">📖 Continued with AI — ' + new Date().toLocaleDateString() + '</div>'
            + '<div style="font-family:\'Crimson Text\',serif;font-size:0.95em;line-height:1.9;color:rgba(220,200,255,0.9);white-space:pre-wrap;">' + _swEscapeHtml(text) + '</div></div>';
        if (window._swCurrentStory) window._swCurrentStory.chapters.push({ stage: 'ai_continue', html: html, date: new Date().toLocaleDateString() });
        var outEl = document.getElementById('swStoryOutput');
        if (outEl) { outEl.innerHTML += html; outEl.scrollTop = outEl.scrollHeight; }
        if (typeof swUpdateBuildOnStoryButtonVisibility === 'function') swUpdateBuildOnStoryButtonVisibility();
        if (typeof showToast === 'function') showToast('Story expanded with AI', 'success');
    }, { temperature: 0.8, num_predict: 1024, num_ctx: 4096 });
}

/* ══ QUEST GENERATION ══ */
function swComposeQuestOppositionReadable() {
    return _swNarrativeParagraph(
        'Opposition profile: this job is protected by people with conflicting loyalties, not a single clean enemy line.',
        [
            'Some adversaries are ideological and will not bargain; others are pragmatic and may fold if shown a safer off-ramp.',
            'At least one obstacle should be social or legal rather than martial so the party must choose between speed and legitimacy.',
            'The opposition should adapt after first contact—moving assets, changing routes, and forcing the party to verify old assumptions.'
        ],
        2
    );
}
function swComposeQuestReadAloud() {
    return _swNarrativeParagraph(
        'Read-aloud prompt: start with what is urgent right now, then reveal who benefits if the party hesitates.',
        [
            'Name two concrete details the characters can act on immediately (a location, a person, a timestamp) so momentum starts without guesswork.',
            'End your briefing with a difficult decision point instead of a summary sentence; players engage faster when the choice is explicit.'
        ],
        2
    );
}
function swComposeQuestFalloutReadable() {
    return _swNarrativeParagraph(
        'Aftermath guidance: whether the party succeeds, fails, or compromises, show the world reacting within a day.',
        [
            'News spreads through taverns, notices, and whispered warnings, shaping the next quest before the current one feels finished.',
            'Reward generosity, ruthlessness, and restraint differently so choices feel morally distinct rather than cosmetically different.',
            'Let one unresolved thread survive the finale as a living consequence the players can revisit.'
        ],
        2
    );
}
function swRegenQuestReadAloud() {
    var el = document.getElementById('swQuestReadAloudText');
    if (!el) return;
    el.innerHTML = swComposeQuestReadAloud();
    if (typeof showToast === 'function') showToast('Quest read-aloud refreshed', 'success');
}
function swRegenQuestOpposition() {
    var el = document.getElementById('swQuestOppositionText');
    if (!el) return;
    el.innerHTML = swComposeQuestOppositionReadable();
    if (typeof showToast === 'function') showToast('Quest opposition refreshed', 'success');
}
function swRegenQuestFallout() {
    var el = document.getElementById('swQuestFalloutText');
    if (!el) return;
    el.innerHTML = swComposeQuestFalloutReadable();
    if (typeof showToast === 'function') showToast('Quest consequences refreshed', 'success');
}

function swGenerateQuest(mode) {
    var typeVal    = (document.getElementById('swQuestType')     ||{}).value || '';
    var diffVal    = (document.getElementById('swQuestDiff')     ||{}).value || '';
    var settingVal = (document.getElementById('swQuestSetting')  ||{}).value || '';
    var sideCount  = parseInt((document.getElementById('swQuestSideCount')||{}).value || '2');

    var types = ['assassination','retrieve','escort','investigate','rescue','explore','defend','political','curse','war','divine','criminal','revenge','infiltration','diplomacy','ritual','horror_hunt'];
    var diffs  = ['easy','medium','hard','deadly','legendary'];
    var settings = ['city','dungeon','wilderness','sea','mountain','war'];

    _swBeginDeterministic('quest|' + mode + '|' + typeVal + '|' + diffVal + '|' + settingVal + '|' + sideCount);
    var qtype   = typeVal    || (mode==='revenge'?'revenge':_swPick(types));
    var qdiff   = diffVal    || _swPick(diffs);
    var qset    = settingVal || _swPick(settings);
    var isSide  = (mode === 'side');
    var isRev   = (mode === 'revenge' || qtype === 'revenge');

    var typeInfo = _SWD.questTypes[qtype] || _SWD.questTypes[''];
    var client   = _swPick(_SWD.questClients);
    var twist    = _swPick(_SWD.questTwists);
    var reward   = _swPick(_SWD.questRewards);
    var diffLabels={easy:'Easy (Lvl 1–4)',medium:'Medium (Lvl 5–8)',hard:'Hard (Lvl 9–12)',deadly:'Deadly (Lvl 13–16)',legendary:'Legendary (Lvl 17+)'};
    var setLabels={city:'City / Urban',dungeon:'Dungeon / Underground',wilderness:'Wilderness',sea:'Sea / Coast',mountain:'Mountain / Highlands',war:'Warzone'};

    /* Build main quest body */
    var objectiveMap = {
        assassination:'Eliminate a specific target. The client has reasons they aren\'t sharing fully.',
        retrieve:     'Recover or steal a specific item. Custody is the only thing that matters.',
        escort:       'Get someone from here to there. The journey is the problem.',
        investigate:  'Find out what happened. The truth may be preferable to some parties remaining hidden.',
        rescue:       'Extract a person from a situation they cannot leave on their own.',
        explore:      'Map, clear, or surveil a location. What\'s there is the real question.',
        defend:       'Hold something or someone against incoming threat. Resources are limited.',
        political:    'Navigate a situation where the real conflict is between agendas, not people.',
        curse:        'Deal with something that has taken root in a place, person, or object.',
        war:          'A military objective with civilian implications neither side wants to acknowledge.',
        divine:       'A task with religious or planar significance. The divine party may have its own conditions.',
        criminal:     'Work inside or against the criminal network. Everyone has leverage on someone.',
        revenge:      'Someone wronged someone. The party is the instrument of consequence — or its obstacle.',
        infiltration: 'Enter a secured organization or site and extract proof, leverage, or a person without alerting full response.',
        diplomacy:    'Force a fragile agreement between hostile parties before violence becomes the default language.',
        ritual:       'Interrupt, redirect, or complete a major ritual where timing and components matter more than brute force.',
        horror_hunt:  'Track and confront a terror that changes behavior when observed and punishes predictable tactics.'
    };

    var revBlock = '';
    if (isRev) {
        var targets = ['the noble who signed the order','the magistrate who looked the other way','the merchant guild that cut the supply lines','the captain who gave the command','the informant who gave the wrong name','the healer who refused to help'];
        var costs   = ['the target\'s family is innocent','the information came from someone the party trusts','completing this creates a new injustice','the person who hired them is also responsible','the target has information that dies with them','the target has already suffered enough — just not visibly'];
        revBlock = '<div style="background:rgba(80,0,0,0.2);border:1px solid rgba(200,0,0,0.3);border-radius:6px;padding:12px;margin-bottom:12px;">'
            +'<div style="font-family:\'Cinzel\',serif;font-size:0.68em;color:#ff6060;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">☠ THE WRONG TO BE ANSWERED</div>'
            +'<div style="font-size:0.9em;color:rgba(255,200,200,0.9);margin-bottom:6px;">Target: <strong>'+_swPick(targets)+'</strong></div>'
            +'<div style="font-size:0.85em;color:rgba(255,160,160,0.75);">Complication: '+_swPick(costs)+'</div>'
            +'</div>';
    }

    /* Side quests */
    var sideHtml = '';
    if (!isSide && sideCount > 0) {
        var picked = [];
        for(var i=0;i<sideCount;i++){
            var sq = _swPick(_SWD.sideQuests.filter(function(s){return picked.indexOf(s)<0;}));
            picked.push(sq);
            sideHtml += '<div style="background:rgba(0,0,0,0.15);border:1px solid rgba(184,134,11,0.2);border-radius:6px;padding:10px;margin-bottom:8px;">'
                +'<div style="font-family:\'Cinzel\',serif;font-size:0.65em;color:var(--gold-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">'+sq.type+' Side Quest</div>'
                +'<div style="font-size:0.88em;color:rgba(255,255,255,0.7);">'+sq.hook+'</div>'
                +'</div>';
        }
    }

    var objective = objectiveMap[qtype] || objectiveMap.retrieve;
    // Enhanced quest descriptions for DM to read out — rich, detailed text for player-facing info
    var objectiveReadable = objective + ' Present this objective clearly to your players so they understand exactly what they need to accomplish. Break it down into actionable steps if needed.';
    var clientReadable = client + ' This is who is hiring the party. Consider their motivations and what they might not be telling the party. Use this character to provide information and drive the quest forward.';
    var twistReadable = twist + ' This twist adds complexity to the quest. Reveal it at an appropriate moment to create tension and force the party to adapt their plans. Consider how this changes the stakes.';
    var rewardReadable = reward + ' Make sure your players understand what they\'re working toward. This reward should feel meaningful and appropriate for the difficulty of the quest.';
    var detailsReadable = 'Setting: ' + (setLabels[qset]||qset) + '. Client: ' + clientReadable + ' Opposition and complications will emerge from the situation and the twist.';

    var urgencyArr = [
        'There\'s a deadline, and it\'s real: the window closes at sundown on the third day.',
        'The opposition is already moving. Every hour the party waits, the enemy gets more prepared.',
        'A fragile opportunity exists: a festival, a prisoner transfer, a storm-front, or a shift change.',
        'The client\'s leverage is fading. If the party stalls, the client may disappear or be silenced.',
        'A rival crew has been hired for the same job with a simpler brief: do it first.',
        'A natural or political event will close the only viable route in forty-eight hours.',
        'The target is about to leave the region permanently — or be moved beyond reach.',
        'Each day of delay increases the chance that evidence will be destroyed or witnesses silenced.',
        'A truce or ceasefire expires soon; after that, the situation becomes open war.',
        'The client is under direct threat and will not survive more than a few days without results.'
    ];
    var scenesArr = [
        'Lead 1: an interview that turns into a lie-detection game with consequences.',
        'Scene: a contested location where two factions both claim authority.',
        'Turning point: evidence that reframes the client\'s story (true, incomplete, or fabricated).',
        'Complication: an ally makes a mistake publicly, forcing the party to act fast.',
        'Final approach: a guarded threshold (social, magical, or physical) that demands a choice.',
        'Discovery: a location or person that should not exist according to official records.',
        'Confrontation: a face-off where words matter as much as steel — and someone is lying.',
        'Escape or assault: a timed sequence where the party must breach, extract, or hold.',
        'Negotiation: a three-way parley where each side has something the others need.',
        'Revelation: the true scope of the job becomes clear — and it is larger than the brief.'
    ];
    var cluesArr = [
        'A ledger with careful gaps—missing names that imply bribes or blackmail.',
        'A witness who will talk only in a crowded place where they feel safe.',
        'A symbol repeated in unrelated places, marking influence rather than ownership.',
        'A note written in plain sight: mundane words, coded meaning.',
        'A tool, key, or component that proves someone was present even if they deny it.',
        'A scar, tattoo, or marking that links multiple suspects to a single event.',
        'A discrepancy in dates or locations that only makes sense if someone moved the evidence.',
        'A phrase or gesture that recurs in witness statements — a signal or password.',
        'An object that belongs in another city or era, suggesting travel or theft.',
        'A child or dependent who has overheard more than the adults realise.'
    ];
    var complicationsReadable = _swPick(urgencyArr) + ' Use this to push momentum if the table slows down.';
    var questSummaryReadable = 'The party has been hired to ' + objective.toLowerCase() + '. Their client is ' + client + '. The catch: ' + twist + ' Pressure: ' + _swPick(urgencyArr) + ' Reward on completion: ' + reward;
    var scenesReadable = 'Suggested beats (use or ignore):<br>• ' + _swPick(scenesArr) + '<br>• ' + _swPick(scenesArr) + '<br>• ' + _swPick(scenesArr);
    var cluesReadable = 'Clues you can drop without railroading:<br>• ' + _swPick(cluesArr) + '<br>• ' + _swPick(cluesArr) + '<br>• ' + _swPick(cluesArr);
    var dialogHooks = [
        'Client: "I am paying for results, not comfort. Decide quickly."',
        'Contact: "You did not hear this from me, and if asked I was never here."',
        'Rival: "We can help each other once. After that, we are a problem again."',
        'Witness: "I can identify them, but only if my family disappears first."',
        'Antagonist: "You call it villainy. I call it arithmetic with ugly numbers."',
        'Authority: "If you succeed quietly, I can protect you. Loudly, I cannot."',
        'Client: "The person who hired you is not the person who will thank you. Remember that."',
        'Innocent: "I did not ask for any of this. But I will not forget who stood in the way."',
        'Guard: "My orders say to stop you. My conscience says to look the other way. You have until I choose."',
        'Traitor: "I sold you out. I would do it again. Ask me why before you draw."',
        'Victim: "They took everything. I have one name. After that, I have nothing left to give."',
        'Mastermind: "You have been useful. That is the only reason you are still breathing."'
    ];
    var dialogReadable = 'Use these lines to launch scenes or push negotiations:<br>• '
        + _swPick(dialogHooks) + '<br>• ' + _swPick(dialogHooks) + '<br>• ' + _swPick(dialogHooks);
    var oppositionReadable = swComposeQuestOppositionReadable();
    var questReadAloud = swComposeQuestReadAloud();
    var falloutReadable = swComposeQuestFalloutReadable();
    var questCoherence = swAnalyzeNarrativeCoherence('quest', {
        title: typeInfo.label + ' in ' + (setLabels[qset]||qset),
        objective: objective,
        twist: twist,
        textBlocks: [objectiveReadable, detailsReadable, twistReadable, complicationsReadable, questReadAloud, oppositionReadable, falloutReadable, scenesReadable, cluesReadable]
    });
    var questCoherenceHtml = swRenderCoherencePanel(questCoherence, '#a9d2ff');
    var questPrep = swBuildSessionPrep('quest', { title: typeInfo.label + ' in ' + (setLabels[qset]||qset), objective: objectiveReadable, twist: twistReadable });
    var questPrepHtml = swRenderSessionPrepPanel(questPrep, '#b9dcff');
    
    var html = '<div style="font-family:\'Cinzel\',serif;font-size:0.9em;font-weight:700;color:'+typeInfo.color+';text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;">'+typeInfo.icon+' '+typeInfo.label+'</div>'
        +'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;">'
        +'<span style="padding:4px 12px;border-radius:10px;font-size:0.8em;font-family:\'Cinzel\',serif;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.7);font-weight:700;">'+diffLabels[qdiff]+'</span>'
        +'<span style="padding:4px 12px;border-radius:10px;font-size:0.8em;font-family:\'Cinzel\',serif;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.7);font-weight:700;">'+setLabels[qset]+'</span>'
        +(isSide?'<span style="padding:4px 12px;border-radius:10px;font-size:0.8em;font-family:\'Cinzel\',serif;background:rgba(26,107,90,0.4);border:1px solid rgba(160,232,208,0.4);color:#a0e8d0;font-weight:700;">Side Quest</span>':'')
        +'</div>'
        + revBlock
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.75em;color:rgba(184,134,11,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">📋 One-Paragraph Brief (read this to your players)</div>'
        +'<p style="margin-bottom:14px;font-size:1.02em;line-height:1.85;color:rgba(255,248,220,0.95);padding:10px 12px;background:rgba(30,25,10,0.4);border-left:3px solid rgba(184,134,11,0.6);border-radius:0 6px 6px 0;">'+_swEscapeHtml(questSummaryReadable)+'</p>'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.75em;color:rgba(184,134,11,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">📋 The Job</div>'
        +'<p style="margin-bottom:14px;font-size:1.05em;line-height:1.8;color:rgba(255,255,255,0.9);">'+objectiveReadable+'</p>'
        +'<div style="background:rgba(0,0,0,0.25);border-left:3px solid rgba(184,134,11,0.6);padding:12px 14px;border-radius:0 6px 6px 0;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(184,134,11,0.8);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">The Client</div>'
        +'<div style="font-size:1.0em;color:rgba(255,248,220,0.9);line-height:1.8;">'+clientReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(139,0,0,0.15);border:1px solid rgba(139,0,0,0.3);border-radius:6px;padding:12px 14px;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(220,60,60,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">⚠ The Twist</div>'
        +'<div style="font-size:1.0em;color:rgba(255,200,200,0.9);line-height:1.8;">'+twistReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(20,20,40,0.35);border:1px solid rgba(100,160,255,0.25);border-radius:6px;padding:12px 14px;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(120,180,255,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">⏳ Pressure & Urgency</div>'
        +'<div style="font-size:1.0em;color:rgba(210,230,255,0.9);line-height:1.8;">'+complicationsReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(30,18,8,0.38);border:1px solid rgba(255,170,110,0.25);border-radius:6px;padding:12px 14px;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(255,190,140,0.92);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">🎬 DM Read-Aloud Hook</div>'
        +'<div style="text-align:right;margin-bottom:6px;"><button onclick="swRegenQuestReadAloud()" style="padding:4px 10px;background:rgba(255,170,110,0.18);color:#ffe8d6;border:1px solid rgba(255,190,130,0.45);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.64em;font-weight:700;">↻ Regenerate</button></div>'
        +'<div id="swQuestReadAloudText" style="font-size:1.0em;color:rgba(255,232,210,0.9);line-height:1.85;">'+questReadAloud+'</div>'
        +'</div>'
        +'<div style="background:rgba(55,20,25,0.35);border:1px solid rgba(220,100,110,0.28);border-radius:6px;padding:12px 14px;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(255,150,160,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">🛡 Opposition Behavior</div>'
        +'<div style="text-align:right;margin-bottom:6px;"><button onclick="swRegenQuestOpposition()" style="padding:4px 10px;background:rgba(220,100,110,0.18);color:#ffd9de;border:1px solid rgba(220,120,130,0.45);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.64em;font-weight:700;">↻ Regenerate</button></div>'
        +'<div id="swQuestOppositionText" style="font-size:1.0em;color:rgba(255,215,220,0.88);line-height:1.8;">'+oppositionReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(0,0,0,0.18);border:1px solid rgba(184,134,11,0.22);border-radius:6px;padding:12px 14px;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(184,134,11,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">🧭 Scenes & Beats</div>'
        +'<div style="font-size:1.0em;color:rgba(255,248,220,0.85);line-height:1.8;">'+scenesReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(0,0,0,0.18);border:1px solid rgba(120,200,120,0.22);border-radius:6px;padding:12px 14px;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(140,220,140,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">🕵 Clues to Seed</div>'
        +'<div style="font-size:1.0em;color:rgba(220,255,220,0.85);line-height:1.8;">'+cluesReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(58,22,62,0.34);border:1px solid rgba(210,140,230,0.25);border-radius:6px;padding:12px 14px;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(225,170,240,0.92);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">💬 Dialogue & Negotiation Starters</div>'
        +'<div style="font-size:1.0em;color:rgba(245,220,255,0.86);line-height:1.8;">'+dialogReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(184,134,11,0.15);border:1px solid rgba(184,134,11,0.3);border-radius:6px;padding:12px 14px;margin-bottom:'+(sideHtml?'16':'0')+'px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(184,134,11,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">💰 Reward</div>'
        +'<div style="font-size:1.0em;color:rgba(255,248,180,0.9);line-height:1.8;">'+rewardReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(18,36,22,0.32);border:1px solid rgba(120,220,150,0.25);border-radius:6px;padding:12px 14px;margin-bottom:'+(sideHtml?'16':'14')+'px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(160,240,185,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">🧾 Consequences After Completion</div>'
        +'<div style="text-align:right;margin-bottom:6px;"><button onclick="swRegenQuestFallout()" style="padding:4px 10px;background:rgba(120,220,150,0.18);color:#ddffe8;border:1px solid rgba(140,230,165,0.45);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.64em;font-weight:700;">↻ Regenerate</button></div>'
        +'<div id="swQuestFalloutText" style="font-size:1.0em;color:rgba(220,255,230,0.88);line-height:1.8;">'+falloutReadable+'</div>'
        +'</div>'
        +questCoherenceHtml
        +questPrepHtml
        +(sideHtml?'<div style="font-family:\'Cinzel\',serif;font-size:0.75em;color:rgba(160,200,160,0.8);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;">📋 Side Quests</div>'+sideHtml:'');

    _swLastQuest = {title: typeInfo.label + ' in ' + (setLabels[qset]||qset), type:qtype, diff:qdiff, coherence:questCoherence, prep:questPrep, html:html};

    /* Build full output: sticky activate bar on top, content below */
    var questActivateBar = ''
        + '<div style="background:rgba(10,15,35,0.98);border-bottom:2px solid rgba(184,134,11,0.4);padding:11px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:10;">'
        + '<button onclick="swSaveAndActivateQuest()" style="padding:8px 20px;background:linear-gradient(145deg,#1a3a7a,#2a5ab0);color:#d8eeff;border:1px solid rgba(100,160,255,0.8);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 10px rgba(0,80,200,0.4);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#2a4a8a,#3a6ad0)\';this.style.boxShadow=\'0 4px 16px rgba(0,100,255,0.5)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#1a3a7a,#2a5ab0)\';this.style.boxShadow=\'0 2px 10px rgba(0,80,200,0.4)\'">⚡ Set as Active Quest</button>'
        + '<button onclick="swGenerateQuestNPCs()" style="padding:8px 16px;background:linear-gradient(145deg,#5a0000,#8b0000);color:#ffd0d0;border:1px solid rgba(200,50,50,0.8);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 8px rgba(139,0,0,0.35);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#7a0000,#aa0000)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#5a0000,#8b0000)\'">👥 Generate Quest NPCs</button>'
        + '<button onclick="swSaveQuest()" style="padding:8px 16px;background:linear-gradient(145deg,rgba(160,120,0,0.6),rgba(120,90,0,0.8));color:#ffe88a;border:1px solid rgba(218,165,32,0.7);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,rgba(200,150,0,0.7),rgba(160,110,0,0.9))\'" onmouseout="this.style.background=\'linear-gradient(145deg,rgba(160,120,0,0.6),rgba(120,90,0,0.8))\'">💾 Save Quest</button>'
        + '<button onclick="swPrintOutput(\'swQuestOutput\')" style="padding:8px 14px;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.2);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(255,255,255,0.15)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.08)\'">🖨 Print</button>'
        + '<button onclick="swClearQuest()" style="padding:8px 12px;background:rgba(139,0,0,0.25);color:rgba(255,120,120,0.8);border:1px solid rgba(139,0,0,0.45);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(180,0,0,0.4)\'" onmouseout="this.style.background=\'rgba(139,0,0,0.25)\'">✕</button>'
        + '</div>'
        + '<div style="padding:16px;">';
    var questFullHtml = questActivateBar + html + '</div>';

    var outEl  = document.getElementById('swQuestOutput');
    var actEl  = document.getElementById('swQuestActions');
    if (outEl) { outEl.style.display='block'; outEl.innerHTML=questFullHtml; }
    if (actEl) { actEl.style.display='flex'; }
    if (typeof showToast==='function') showToast('Quest generated!','success');
}

function swSaveQuest() {
    if(!_swLastQuest){if(typeof showToast==='function')showToast('No quest to save','success');return;}
    try {
        var qs=JSON.parse(localStorage.getItem('npcgen_quests')||'[]');
        var isMain = !!(_swStoryLinked && _swCurrentStory);
        var storyTitle = isMain ? (_swCurrentStory.title || 'Current Story') : '';
        _swLastQuest.id='q'+Date.now();
        _swLastQuest.date=new Date().toLocaleDateString();
        _swLastQuest.isMain = isMain;
        _swLastQuest.storyTitle = storyTitle;
        qs.push(_swLastQuest);
        localStorage.setItem('npcgen_quests',JSON.stringify(qs));
        if(typeof _refreshSavedQuestsSidebar==='function')_refreshSavedQuestsSidebar();
        swRenderSavedQuests();
        if(typeof showToast==='function')showToast('Quest saved' + (isMain ? ' (Main Story)' : '') + '!','success');
    } catch(e){if(typeof showToast==='function')showToast('Failed to save','warning');}
}

function swRenderSavedQuests() {
    var section = document.getElementById('swSavedQuestsSection');
    var list = document.getElementById('swSavedQuestsList');
    if (!list) return;
    var qs = [];
    try { qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e) {}
    // Filter out bounty entries
    qs = qs.filter(function(q){ return !q.isBounty; });
    if (!qs.length) { if (section) section.style.display = 'none'; return; }
    if (section) section.style.display = 'block';
    list.innerHTML = qs.slice().reverse().slice(0, 10).map(function(q) {
        return '<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:5px;border:1px solid rgba(184,134,11,0.25);background:rgba(184,134,11,0.07);margin-bottom:4px;" onmouseover="this.style.background=\'rgba(184,134,11,0.18)\'" onmouseout="this.style.background=\'rgba(184,134,11,0.07)\'">'
            + '<div style="flex:1;min-width:0;cursor:pointer;" onclick="swLoadQuest(\'' + q.id + '\')">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.75em;color:#e8d070;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+(q.isMain?'📖 ':'')+( q.title||'Unnamed Quest')+'</div>'
            + '<div style="font-size:0.68em;color:rgba(218,165,32,0.5);">'+(q.type||'').replace(/_/g,' ')+' · '+(q.date||'')+'</div>'
            + '</div>'
            + '<button onclick="event.stopPropagation();swDeleteQuest(\'' + q.id + '\')" style="background:none;border:1px solid rgba(139,0,0,0.5);color:rgba(240,128,128,0.7);padding:2px 8px;border-radius:4px;cursor:pointer;font-size:0.75em;flex-shrink:0;margin-left:6px;">✕</button>'
            + '</div>';
    }).join('');
}

function swDeleteQuest(id) {
    try {
        var qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]');
        var beforeQs = JSON.parse(JSON.stringify(qs || []));
        qs = qs.filter(function(q){ return q.id !== id; });
        localStorage.setItem('npcgen_quests', JSON.stringify(qs));
        swRenderSavedQuests();
        if (typeof _refreshSavedQuestsSidebar === 'function') _refreshSavedQuestsSidebar();
        dmPushUndoAction('Delete quest', function() {
            localStorage.setItem('npcgen_quests', JSON.stringify(beforeQs || []));
            swRenderSavedQuests();
            if (typeof _refreshSavedQuestsSidebar === 'function') _refreshSavedQuestsSidebar();
        });
        if (typeof showToast === 'function') showToast('Quest deleted', 'success');
    } catch(e) {}
}

function swLoadQuest(id) {
    try {
        var qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]');
        var q = qs.find(function(x){ return x.id === id; });
        if (!q || !q.html) { if (typeof showToast === 'function') showToast('Quest not found', 'warning'); return; }
        var outEl = document.getElementById('swQuestOutput');
        var actEl = document.getElementById('swQuestActions');
        if (outEl) { outEl.style.display = 'block'; outEl.innerHTML = q.html; }
        if (actEl) { actEl.style.display = 'flex'; }
        _swLastQuest = q;
    } catch(e) {}
}

function swSaveAndActivateQuest() {
    if(!_swLastQuest){if(typeof showToast==='function')showToast('No quest to activate','success');return;}
    swSaveQuest();
    setTimeout(function() {
        var qs = [];
        try { qs = JSON.parse(localStorage.getItem('npcgen_quests')||'[]'); } catch(e){}
        if (qs.length) {
            var q = qs[qs.length - 1];
            _activeQuest = q;
            if(typeof _saveActiveQuest==='function') _saveActiveQuest();
            if(typeof _updateActiveQuestBanner==='function') _updateActiveQuestBanner();
            if(typeof showToast==='function') showToast('⚡ Active quest set: ' + (q.title||'Quest'), 'success');
        }
    }, 200);
}

function swSaveAndActivateStory() {
    if(!_swCurrentStory){if(typeof showToast==='function')showToast('No story to activate','success');return;}
    if(typeof swSaveStory==='function') swSaveStory();
    if(typeof setActiveStory==='function') setActiveStory(_swCurrentStory.id);
    if(typeof showToast==='function') showToast('⚡ Active story set: ' + (_swCurrentStory.title||'Story'), 'success');
}

function swClearQuest() {
    if(!_swLastQuest) {
        if(typeof showToast==='function') showToast('No quest to clear!', 'warning');
        return;
    }
    if(confirm('Clear the current quest? This cannot be undone.')) {
        _swLastQuest = null;
        var outEl = document.getElementById('swQuestOutput');
        var actEl = document.getElementById('swQuestActions');
        if(outEl) { outEl.style.display = 'none'; outEl.innerHTML = ''; }
        if(actEl) { actEl.style.display = 'none'; }
        if(typeof showToast==='function') showToast('Quest cleared', 'success');
    }
}

/* ══ LOCATION GENERATION ══ */
function swBuildLocationRollTable(locKey) {
    var baseRows = [
        'A local asks for help with a practical problem that quietly ties into bigger trouble.',
        'A rumor spreads through the area, and two groups disagree violently about whether it is true.',
        'An official inspection is underway; everyone becomes guarded and unusually polite.',
        'A minor accident reveals evidence that someone has been lying about recent events.'
    ];

    var byType = {
        tavern: [
            'A card game turns into a dispute when someone recognizes a marked deck.',
            'A drunk patron loudly names a person who was supposed to be dead.',
            'The barkeep receives a sealed note and immediately changes who is allowed upstairs.',
            'A traveling performer sings a ballad containing coded warnings for one table only.'
        ],
        blacksmith: [
            'A customer demands rush work for weapons clearly intended for illegal use.',
            'A blade cracks under light testing, suggesting sabotage in materials.',
            'A crate of ore arrives with the wrong guild seal and no paperwork.',
            'The smith asks discreetly for escorts to deliver a locked commission.'
        ],
        general_store: [
            'Essential goods vanish from shelves after a suspicious bulk purchase.',
            'A child tries to pay with old military scrip no longer in circulation.',
            'A ledger mismatch suggests someone inside is skimming supply stock.',
            'A desperate customer asks for banned items under a false story.'
        ],
        temple: [
            'A supplicant claims a miracle occurred and demands immediate recognition.',
            'A relic goes missing, and two clergy accuse each other quietly.',
            'Confession records hint at a coordinated crime ring nearby.',
            'A funeral procession arrives carrying a body with forbidden warding marks.'
        ],
        guild_hall: [
            'A contract board posting vanishes moments after being noticed.',
            'Two guild delegates dispute jurisdiction over the same assignment.',
            'A veteran member asks the party to verify a forged credential.',
            'An emergency vote is called after a key sponsor withdraws funding.'
        ],
        market: [
            'A public auction item is identified as stolen from a recent raid.',
            'A pickpocket drops a coded message meant for someone else.',
            'Price spikes on one commodity suggest planned scarcity manipulation.',
            'A street vendor disappears after seeing the party approach.'
        ],
        library: [
            'A requested volume has been replaced with a convincing but altered copy.',
            'A scholar offers help if the party retrieves notes from restricted stacks.',
            'An index entry references a room that does not appear on official maps.',
            'A quiet reading patron is transcribing pages far faster than humanly plausible.'
        ],
        dungeon_entrance: [
            'Fresh tracks indicate a second expedition entered within the last hour.',
            'A warning marker has been moved to point toward a deadlier path.',
            'Camp supplies are intact, but the camp occupants are gone without signs of struggle.',
            'A magical pulse briefly reveals hidden inscriptions near the threshold.'
        ],
        noble_manor: [
            'A servant requests help exposing blackmail without implicating innocents.',
            'A guest list includes an alias tied to prior political murders.',
            'A private dinner is postponed after a suspicious food-taster illness.',
            'A family heirloom is replaced with a perfect replica overnight.'
        ],
        thieves_den: [
            'A fixer offers a profitable job with terms that are intentionally vague.',
            'A fence refuses certain goods because a syndicate war is beginning.',
            'A messenger demands immediate relocation of everyone present.',
            'A bounty notice appears here before the city guard posts it publicly.'
        ],
        barracks: [
            'A patrol fails to report in, and command minimizes concern.',
            'A locked evidence chest is found tampered with from the inside.',
            'A recruitment officer asks for discreet help vetting new hires.',
            'A standing order conflicts with a recent magistrate directive.'
        ],
        magic_shop: [
            'An unstable item activates briefly when the party enters.',
            'A client tries to sell a cursed object as a harmless curio.',
            'A missing shipment of reagents stalls multiple local spellcasters.',
            'The proprietor offers a discount for retrieving a stolen focus crystal.'
        ],
        docks: [
            'A vessel arrives early under false registry and refuses inspection.',
            'Dockworkers strike over unexplained disappearances on night shifts.',
            'Contraband is moved under cover of legitimate grain unloading.',
            'A harbor bell rings an emergency code no captain claims to have called.'
        ],
        graveyard: [
            'Fresh soil appears on an old grave with no sign of authorized digging.',
            'A mourner leaves offerings at multiple unrelated headstones in sequence.',
            'Caretakers hear movement in sealed crypt passages after midnight.',
            'A memorial marker bears a name still listed as living in city records.'
        ],
        forest_clearing: [
            'Animal tracks form a circle and abruptly stop at the center point.',
            'A druidic marker is found broken, signaling territorial conflict.',
            'A campfire burns smokeless and cold, yet was lit moments ago.',
            'A hidden cache contains supplies for a group larger than expected.'
        ],
        cave: [
            'A narrow tunnel opens recently, exposing older worked stone beneath.',
            'An echo answers one specific phrase with different words.',
            'Glow-moss outlines footprints that lead deeper but never return.',
            'A mineral seam draws prospectors who are not telling the full story.'
        ],
        ruins: [
            'A collapsed wall reveals fresher construction behind ancient stone.',
            'An inscription changes meaning when read at different times of day.',
            'A scavenger crew offers to share maps for protection during extraction.',
            'A central chamber has been swept clean for an upcoming ritual use.'
        ]
    };

    var rows = (byType[locKey] || []).concat(baseRows).slice(0, 8);
    var body = rows.map(function(text, idx) {
        return '<div style="display:grid;grid-template-columns:50px 1fr;gap:8px;padding:7px 0;border-bottom:' + (idx < rows.length - 1 ? '1px solid rgba(100,180,100,0.14)' : 'none') + ';">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:#9ae39a;opacity:0.95;">' + (idx + 1) + '</div>'
            + '<div style="font-size:0.92em;color:rgba(220,255,220,0.86);line-height:1.65;">' + text + '</div>'
            + '</div>';
    }).join('');

    return '<div style="background:rgba(0,0,0,0.22);border:1px solid rgba(100,180,100,0.22);border-radius:6px;padding:12px 14px;margin-bottom:16px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(120,220,120,0.88);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">🎲 Location Roll Table (1d8)</div>'
        + '<div style="font-size:0.85em;color:rgba(170,230,170,0.75);margin-bottom:8px;">Roll when the party spends time here, asks around, or returns later.</div>'
        + body
        + '</div>';
}

function swComposeLocationReadAloud() {
    return _swNarrativeParagraph(
        'Read-aloud opener: begin with movement and texture before naming threats.',
        [
            'Describe one person who freezes when the party enters and one person who pretends not to notice them.',
            'Mark a physical detail that implies recent change—fresh repair, hurried cleanup, or a locked door that should be open.',
            'End with a social invitation or interruption so roleplay starts immediately instead of stalling in observation mode.'
        ],
        2
    );
}
function swComposeLocationLivingSystems() {
    return _swNarrativeParagraph(
        'This location functions like a small ecosystem with routines, dependencies, and fault lines.',
        [
            'Trade, gossip, and fear pass through predictable channels; learning those channels is often more valuable than drawing steel.',
            'When the party applies pressure, the place reacts in layers—workers, managers, then whoever truly controls outcomes from the shadows.',
            'Returning later should reveal change: increased security, altered prices, missing faces, or new symbols of authority.'
        ],
        2
    );
}
function swComposeLocationEscalation() {
    return _swNarrativeParagraph(
        'Escalation idea: if the party lingers, let one hidden tension surface in public.',
        [
            'A private dispute spills into the room, forcing bystanders to choose sides and exposing alliances the party can exploit.',
            'A messenger arrives with orders that contradict local custom, making everyone look to the party for an immediate response.',
            'An unseen observer takes direct action—warning, bribe, or threat—signaling the location is part of a larger network.'
        ],
        2
    );
}
function swRegenLocationReadAloud() {
    var el = document.getElementById('swLocReadAloudText');
    if (!el) return;
    el.innerHTML = swComposeLocationReadAloud();
    if (typeof showToast === 'function') showToast('Location read-aloud refreshed', 'success');
}
function swRegenLocationSystems() {
    var a = document.getElementById('swLocSystemsText');
    var b = document.getElementById('swLocEscalationText');
    if (!a || !b) return;
    a.innerHTML = swComposeLocationLivingSystems();
    b.innerHTML = swComposeLocationEscalation();
    if (typeof showToast === 'function') showToast('Location systems refreshed', 'success');
}

function swGenerateLocation() {
    var typeVal    = (document.getElementById('swLocType')   ||{}).value;
    var settingVal = (document.getElementById('swLocSetting')||{}).value;
    _swBeginDeterministic('location|' + typeVal + '|' + settingVal);

    var allTypes = Object.keys(_SWD.locTypes);
    var questType = ((window._swLastQuest && window._swLastQuest.type) || (window._activeQuest && window._activeQuest.type) || '').toLowerCase();
    var qWeights = {
        assassination: ['noble_manor','guild_hall','thieves_den','docks'],
        retrieve: ['dungeon_entrance','ruins','cave','magic_shop'],
        escort: ['docks','market','barracks','tavern'],
        investigate: ['library','temple','market','guild_hall'],
        rescue: ['dungeon_entrance','cave','noble_manor','barracks'],
        explore: ['forest_clearing','ruins','cave','dungeon_entrance'],
        defend: ['barracks','temple','guild_hall','dungeon_entrance'],
        political: ['guild_hall','noble_manor','temple','market'],
        curse: ['graveyard','ruins','temple','cave'],
        war: ['barracks','docks','dungeon_entrance','ruins'],
        divine: ['temple','graveyard','ruins','library'],
        criminal: ['thieves_den','docks','market','tavern'],
        revenge: ['thieves_den','noble_manor','graveyard','docks'],
        infiltration: ['guild_hall','noble_manor','barracks','thieves_den'],
        diplomacy: ['guild_hall','temple','market','noble_manor'],
        ritual: ['temple','ruins','cave','graveyard'],
        horror_hunt: ['graveyard','cave','ruins','forest_clearing']
    };
    var weighted = qWeights[questType] || [];
    var weightedPool = allTypes.slice();
    weighted.forEach(function(k) {
        if (allTypes.indexOf(k) !== -1) {
            weightedPool.push(k);
            weightedPool.push(k);
        }
    });
    var locKey   = typeVal || _swPick(weightedPool);
    var typeInfo = _SWD.locTypes[locKey] || {label:locKey,icon:'🏛',color:'#b8860b'};
    var settings = ['city','town','village','dungeon','port','frontier'];
    var settingLabels={city:'City',town:'Small Town',village:'Remote Village',dungeon:'Underground',port:'Port City',frontier:'Frontier / Wilderness'};
    var setting   = settingVal || _swPick(settings);

    var details = _SWD.locDetails[locKey] || ['This place has a history the locals don\'t discuss.','Something here is not what it appears.','Someone left recently — and recently means something different here.'];
    var d1 = _swPick(details);
    var d2 = _swPick(details.filter(function(d){return d!==d1;})) || d1;

    /* Generate names */
    var nameAdjectives=['Silver','Black','Broken','Gilded','Hollow','Iron','Crimson','Pale','Golden','Stone','Whispering','Rusted'];
    var nameNouns={tavern:['Flagon','Anchor','Hearthstone','Crossroads','Lantern','Boot'],blacksmith:['Anvil','Forge','Hammer','Ironworks','Blade'],temple:['Sanctuary','Altar','Vigil','Light','Covenant'],guild_hall:['Compact','Assembly','Accord','Register'],library:['Archive','Codex','Repository','Records'],dungeon_entrance:['Gate','Descent','Maw','Threshold'],noble_manor:['House','Estate','Hall','Keep'],thieves_den:['Den','Exchange','Hole','Network'],market:['Exchange','Bazaar','Quarter','Row'],graveyard:['Rest','Vale','Crossing','Grounds'],ruins:['Remnants','Stones','Foundations','Collapse'],cave:['Hollow','Depths','Tunnels','Dark'],forest_clearing:['Glade','Circle','Opening','Green'],magic_shop:['Curiosities','Oddities','Wonders','Emporium'],barracks:['Post','Station','Keep','Garrison'],docks:['Quay','Wharf','Landing','Moorings'],general_store:['Trading Post','Supplies','Provisions','Goods']};
    var noun=_swPick(nameNouns[locKey]||['Place','Establishment','Location']);
    var adj=_swPick(nameAdjectives);
    var locName=adj+' '+noun;

    // Enhanced location descriptions for DM to read out
    var sensorySmells = ['smoke and wet wood','spilled ale and pipe-leaf','salt, tar, and rotting rope','incense and old stone','hot iron and quenched steel','damp parchment and candle wax','blood, cheap perfume, and fear','fresh soil and wilted flowers'];
    var sensorySounds = ['murmured deals behind half-closed doors','boots on stone and distant shouting','creaking timbers and gull-calls','prayer under breath and soft bells','hammer on anvil like a heartbeat','quills scratching in uncomfortable silence','whispers that stop when you look','wind moving where there should be no draft'];
    var sensoryFeel = ['a watchful tension in the air','a warmth that feels practiced, not genuine','a cold spot that does not match the season','a feeling of being evaluated and priced','the sense that you\'ve been here before (you haven\'t)','a comfort that is almost suspicious','a subtle pressure like standing near deep water'];
    var secrets = [
        'Secret: one person here is an informant, but not for the side you expect.',
        'Secret: this place is a front; the real business happens after midnight.',
        'Secret: a hidden room exists, sealed by an old ward keyed to a forgotten name.',
        'Secret: the owner is paying protection to the very people they publicly oppose.',
        'Secret: something valuable is stored here because nobody would think to look.'
    ];
    var hooks = [
        'Hook: someone mistakes the party for the expected contact and hands over a message.',
        'Hook: a public argument erupts, revealing a clue the party didn\'t know they needed.',
        'Hook: an NPC offers a trade—information for a favour that sounds easy (it isn\'t).',
        'Hook: the party witnesses a crime that forces a choice: intervene or leverage it.',
        'Hook: a posted notice references the party by description, not name.'
    ];

    var smell = _swPick(sensorySmells);
    var sound = _swPick(sensorySounds);
    var feel  = _swPick(sensoryFeel);
    var secretReadable = _swPick(secrets) + ' Use it if the players dig, or keep it as a lever for later.';
    var hookReadable   = _swPick(hooks) + ' This can be your immediate reason to roleplay the location rather than pass through it.';

    var settingDescReadable = 'Located in a '+settingLabels[setting].toLowerCase()+', this '+typeInfo.label.toLowerCase()+' sits at the intersection of several interests. It smells like <strong>'+smell+'</strong>, and you can hear <strong>'+sound+'</strong>. The place carries <strong>'+feel+'</strong>. Use this to anchor your read-aloud: what the characters notice first, who notices them back, and what feels slightly off.';
    var d1Readable = d1 + ' This detail adds depth and intrigue to the location. Consider how the party might discover this information and what it means for their adventure.';
    var d2Readable = d2 + ' This second notable detail helps make the location memorable. Think about how this interacts with the first detail to create a richer environment.';
    var npcsReadable = _buildLocNPCs() + ' These characters can provide information, quests, or complications. Consider how they interact with each other and with the party.';
    var locRollTableHtml = swBuildLocationRollTable(locKey);
    var locationReadAloud = swComposeLocationReadAloud();
    var locationLivingSystems = swComposeLocationLivingSystems();
    var locationEscalation = swComposeLocationEscalation();
    var locationCoherence = swAnalyzeNarrativeCoherence('location', {
        name: locName,
        type: typeInfo.label,
        setting: settingLabels[setting],
        textBlocks: [settingDescReadable, d1Readable, d2Readable, npcsReadable, secretReadable, hookReadable, locationReadAloud, locationLivingSystems, locationEscalation]
    });
    var locationCoherenceHtml = swRenderCoherencePanel(locationCoherence, '#9ee2b4');
    var locationPrep = swBuildSessionPrep('location', { name: locName, type: typeInfo.label, setting: settingLabels[setting] });
    var locationPrepHtml = swRenderSessionPrepPanel(locationPrep, '#a8edc8');

    var html='<div style="background:linear-gradient(145deg,#0a140a,#0d1a0d);border:1px solid rgba(100,180,100,0.3);border-radius:10px;overflow:hidden;">'
        +'<div style="background:linear-gradient(145deg,#0a1a0a,#142a14);padding:14px 16px;border-bottom:1px solid rgba(100,180,100,0.2);">'
        +'<div style="font-size:1.4em;margin-bottom:4px;">'+typeInfo.icon+'</div>'
        +'<div style="font-family:\'Cinzel\',serif;font-size:1.1em;font-weight:700;color:#c8ffc8;letter-spacing:2px;">'+locName+'</div>'
        +'<div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;">'
        +'<span style="background:rgba(100,180,100,0.25);color:#a0d8a0;padding:3px 12px;border-radius:8px;font-size:0.75em;font-family:\'Cinzel\',serif;border:1px solid rgba(100,180,100,0.4);font-weight:700;">'+typeInfo.label+'</span>'
        +'<span style="background:rgba(100,180,100,0.15);color:#80b880;padding:3px 12px;border-radius:8px;font-size:0.75em;font-family:\'Cinzel\',serif;font-weight:700;">'+settingLabels[setting]+'</span>'
        +'</div></div>'
        +'<div style="padding:16px;font-family:\'Crimson Text\',serif;font-size:0.95em;line-height:1.9;color:rgba(200,255,200,0.9);">'
        +'<p style="margin-bottom:14px;color:rgba(200,255,200,0.85);font-size:1.05em;line-height:1.9;">'+settingDescReadable+'</p>'
        +'<div style="background:rgba(26,32,18,0.45);border:1px solid rgba(130,210,130,0.28);border-radius:6px;padding:12px 14px;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(160,235,160,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">🎬 DM Read-Aloud</div>'
        +'<div style="text-align:right;margin-bottom:6px;"><button onclick="swRegenLocationReadAloud()" style="padding:4px 10px;background:rgba(140,220,140,0.16);color:#e8ffe8;border:1px solid rgba(150,230,150,0.45);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.64em;font-weight:700;">↻ Regenerate</button></div>'
        +'<div id="swLocReadAloudText" style="font-size:1.0em;line-height:1.85;color:rgba(225,255,225,0.9);">'+locationReadAloud+'</div>'
        +'</div>'
        +'<div style="background:rgba(10,24,10,0.35);border:1px solid rgba(100,180,100,0.24);border-radius:6px;padding:12px 14px;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(140,220,140,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;">⚙ How This Place Works</div>'
        +'<div style="text-align:right;margin-bottom:6px;"><button onclick="swRegenLocationSystems()" style="padding:4px 10px;background:rgba(100,180,100,0.16);color:#ddffdd;border:1px solid rgba(120,200,120,0.45);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.64em;font-weight:700;">↻ Regenerate</button></div>'
        +'<div id="swLocSystemsText" style="font-size:0.98em;line-height:1.8;color:rgba(214,250,214,0.86);margin-bottom:8px;">'+locationLivingSystems+'</div>'
        +'<div id="swLocEscalationText" style="font-size:0.98em;line-height:1.8;color:rgba(210,245,210,0.84);">'+locationEscalation+'</div>'
        +'</div>'
        +'<div style="margin-bottom:16px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(100,200,100,0.9);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;border-bottom:2px solid rgba(100,180,100,0.2);padding-bottom:6px;">📍 What\'s Notable</div>'
        +'<div style="background:rgba(100,180,100,0.1);border-left:3px solid rgba(100,180,100,0.5);padding:10px 14px;border-radius:0 4px 4px 0;margin-bottom:10px;font-size:1.0em;line-height:1.8;">'+d1Readable+'</div>'
        +'<div style="background:rgba(100,180,100,0.1);border-left:3px solid rgba(100,180,100,0.5);padding:10px 14px;border-radius:0 4px 4px 0;font-size:1.0em;line-height:1.8;">'+d2Readable+'</div>'
        +'</div>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">'
        +'<div style="background:rgba(0,0,0,0.25);border:1px solid rgba(100,180,100,0.22);border-radius:6px;padding:12px 14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(120,220,120,0.85);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">🗝 Secret</div>'
        +'<div style="font-size:0.95em;line-height:1.75;color:rgba(220,255,220,0.85);">'+secretReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(0,0,0,0.25);border:1px solid rgba(100,180,100,0.22);border-radius:6px;padding:12px 14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(120,220,120,0.85);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">🎯 Immediate Hook</div>'
        +'<div style="font-size:0.95em;line-height:1.75;color:rgba(220,255,220,0.85);">'+hookReadable+'</div>'
        +'</div>'
        +'</div>'
        +'<div style="background:rgba(0,0,0,0.3);border:1px solid rgba(100,180,100,0.2);border-radius:6px;padding:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(100,200,100,0.8);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;">👤 Who\'s Here</div>'
        +'<div style="font-size:1.0em;color:rgba(200,255,200,0.85);line-height:1.9;">'+npcsReadable+'</div>'
        +'</div>'
        +'<div style="background:rgba(20,20,40,0.35);border:1px solid rgba(100,160,255,0.25);border-radius:6px;padding:12px 14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(120,180,255,0.85);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">🎭 Local Hooks</div>'
        +'<div style="font-size:0.95em;line-height:1.75;color:rgba(220,235,255,0.85);">'+hookReadable+'</div>'
        +'</div>'
        +locationCoherenceHtml
        +locationPrepHtml
        +locRollTableHtml
        +'</div></div>';

    _swLastLoc = {id:'loc_'+Date.now(), name:locName, icon:typeInfo.icon, type:locKey, setting:setting, coherence:locationCoherence, prep:locationPrep, html:html, date:new Date().toLocaleDateString()};
    var outEl=document.getElementById('swLocOutput');

    var locStickyBar = '<div style="background:rgba(10,20,10,0.98);border-bottom:2px solid rgba(100,180,100,0.4);padding:11px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:10;">'
        + '<button onclick="swSaveLocation()" style="padding:8px 16px;background:rgba(100,180,100,0.2);color:#a0d8a0;border:1px solid rgba(100,180,100,0.5);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(100,180,100,0.35)\'" onmouseout="this.style.background=\'rgba(100,180,100,0.2)\'">💾 Save Location</button>'
        + '<button onclick="swActivateLocation()" style="padding:8px 16px;background:linear-gradient(145deg,#1a3a6a,#2a5ab0);color:#d0e8ff;border:1px solid rgba(100,160,255,0.7);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 10px rgba(0,80,200,0.3);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#2a4a8a,#3a6ad0)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#1a3a6a,#2a5ab0)\'">⚡ Set Active Location</button>'
        + '<button onclick="swGenerateLocationNPCs()" style="padding:8px 16px;background:linear-gradient(145deg,#5a0000,#8b0000);color:#ffd0d0;border:1px solid rgba(200,50,50,0.7);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 8px rgba(139,0,0,0.35);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#7a0000,#aa0000)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#5a0000,#8b0000)\'">👥 Generate Location NPCs</button>'
        + '<span id="swLocEncounterBtnWrap">' + (typeof swGetLocationEncounterButtonHtml === 'function' ? swGetLocationEncounterButtonHtml() : '<button onclick="swGenerateLocationEncounterPopup()" style="padding:8px 16px;background:linear-gradient(145deg,#1a4a1a,#2a6a2a);color:#d8ffd8;border:1px solid rgba(110,200,110,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">🎲 Generate Encounter</button>') + '</span>'
        + '<button onclick="swPrintOutput(\'swLocOutput\')" style="padding:8px 14px;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.2);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;letter-spacing:0.5px;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(255,255,255,0.15)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.08)\'">🖨 Print</button>'
        + '<button onclick="swClearLocOutput()" style="padding:8px 12px;background:rgba(139,0,0,0.25);color:rgba(255,120,120,0.8);border:1px solid rgba(139,0,0,0.45);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(180,0,0,0.4)\'" onmouseout="this.style.background=\'rgba(139,0,0,0.25)\'">✕</button>'
        + '</div>'
        + '<div style="padding:0;">';

    if(outEl){outEl.style.display='block';outEl.innerHTML=locStickyBar+html+'</div>';}
    setTimeout(function(){ if (typeof swGenerateLocationBattleMap === 'function') swGenerateLocationBattleMap(); }, 80);
    if(typeof showToast==='function')showToast('Location generated: '+locName,'success');
}

function _buildLocNPCs() {
    var roles=[['the owner','has been here longer than anyone can remember and will not say why'],['a regular who hasn\'t left in three days','is waiting for something'],['a newcomer','is asking the wrong questions in the wrong order'],['someone working here','is not what their employment suggests']];
    var r=_swPick(roles); var r2=_swPick(roles.filter(function(x){return x!==r;}));
    return '• '+r[0].charAt(0).toUpperCase()+r[0].slice(1)+' '+r[1]+'.<br>• '+r2[0].charAt(0).toUpperCase()+r2[0].slice(1)+' '+r2[1]+'.';
}

function swSaveLocation() {
    if(!_swLastLoc){if(typeof showToast==='function')showToast('No location to save','success');return;}
    var idx=_swSavedLocs.findIndex(function(l){return l.id===_swLastLoc.id;});
    if(idx>=0)_swSavedLocs[idx]=_swLastLoc; else _swSavedLocs.push(_swLastLoc);
    if(_swSavedLocs.length>20)_swSavedLocs=_swSavedLocs.slice(-20);
    _swSave(); swRenderSavedLocs();
    if(typeof showToast==='function')showToast('Location saved: '+_swLastLoc.name,'success');
}

function swRenderSavedLocs() {
    var el = document.getElementById('swSavedLocsList');
    if (!el) return;
    if (!_swSavedLocs.length) {
        el.innerHTML = '<div style="color:rgba(100,180,100,0.4);font-size:0.75em;text-align:center;padding:6px;font-style:italic;">No saved locations yet.</div>';
        return;
    }
    el.innerHTML = '';
    _swSavedLocs.slice().reverse().slice(0, 8).forEach(function(loc) {
        var row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:5px 8px;background:rgba(100,180,100,0.08);border:1px solid rgba(100,180,100,0.25);border-radius:5px;margin-bottom:4px;cursor:pointer;';
        row.onmouseover = function(){this.style.background='rgba(100,180,100,0.18)';};
        row.onmouseout  = function(){this.style.background='rgba(100,180,100,0.08)';};

        var info = document.createElement('div');
        info.style.cssText = 'flex:1;min-width:0;';
        info.innerHTML = '<div style="font-family:\'Cinzel\',serif;font-size:0.73em;font-weight:700;color:#c8ffc8;">'+(loc.icon||'🏘')+' '+loc.name+'</div>'
            +'<div style="font-size:0.65em;color:rgba(200,255,200,0.45);">'+loc.date+'</div>';
        info.onclick = (function(l) {
            return function() {
                var outEl = document.getElementById('swLocOutput');
                if (outEl) {
                    var stickyBar = '<div style="background:rgba(10,20,10,0.98);border-bottom:2px solid rgba(100,180,100,0.4);padding:11px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:10;">'
                        + '<button onclick="swSaveLocation()" style="padding:8px 16px;background:rgba(100,180,100,0.2);color:#a0d8a0;border:1px solid rgba(100,180,100,0.5);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">💾 Save Location</button>'
                        + '<button onclick="swActivateLocation()" style="padding:8px 16px;background:linear-gradient(145deg,#1a3a6a,#2a5ab0);color:#d0e8ff;border:1px solid rgba(100,160,255,0.7);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">⚡ Set Active Location</button>'
                        + '<button onclick="swGenerateLocationNPCs()" style="padding:8px 16px;background:linear-gradient(145deg,#5a0000,#8b0000);color:#ffd0d0;border:1px solid rgba(200,50,50,0.7);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">👥 Generate Location NPCs</button>'
                        + '<span id="swLocEncounterBtnWrap">' + (typeof swGetLocationEncounterButtonHtml === 'function' ? swGetLocationEncounterButtonHtml() : '<button onclick="swGenerateLocationEncounterPopup()" style="padding:8px 16px;background:linear-gradient(145deg,#1a4a1a,#2a6a2a);color:#d8ffd8;border:1px solid rgba(110,200,110,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">🎲 Generate Encounter</button>') + '</span>'
                        + '<button onclick="swPrintOutput(\'swLocOutput\')" style="padding:8px 14px;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.2);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;">🖨 Print</button>'
                        + '</div><div style="padding:0;">';
                    outEl.style.display = 'block';
                    outEl.innerHTML = stickyBar + l.html + '</div>';
                }
                _swLastLoc = l;
                setTimeout(function(){ if (typeof swGenerateLocationBattleMap === 'function') swGenerateLocationBattleMap(); }, 80);
            };
        })(loc);

        var delBtn = document.createElement('button');
        delBtn.textContent = '✕';
        delBtn.style.cssText = 'background:none;border:1px solid rgba(139,0,0,0.4);color:rgba(240,128,128,0.6);padding:1px 6px;border-radius:3px;cursor:pointer;font-size:0.7em;flex-shrink:0;margin-left:4px;';
        delBtn.onclick = (function(id) {
            return function(e) {
                e.stopPropagation();
                _swSavedLocs = _swSavedLocs.filter(function(l){return l.id !== id;});
                _swSave(); swRenderSavedLocs();
                if (typeof showToast === 'function') showToast('Location deleted', 'success');
            };
        })(loc.id);

        row.appendChild(info);
        row.appendChild(delBtn);
        el.appendChild(row);
    });
}


function swGenerateNPC() {
    var roleVal = (document.getElementById('swNpcRole')    ||{}).value || '';
    var attVal  = (document.getElementById('swNpcAttitude')||{}).value || '';

    var roles=['ally','villain','merchant','noble','guard','priest','scholar','criminal','mysterious','informant'];
    var atts =['friendly','neutral','suspicious','hostile','desperate','secretive'];
    var role = roleVal || _swPick(roles);
    var att  = attVal  || _swPick(atts);

    var roleData = _SWD.npcRoleDetails[role] || _SWD.npcRoleDetails.mysterious;
    var attDesc  = _SWD.npcAttitudes[att]    || _SWD.npcAttitudes.neutral;
    var trait    = _swPick(roleData.traits);
    var secret   = _swPick(roleData.secrets);

    var genders=['m','f']; var g=_swPick(genders);
    var firstName=_swPick(_SWD.npcNames[g]);
    var surName  =_swPick(_SWD.npcNames.sur);
    var name=firstName+' '+surName;
    var roleLabel=role.charAt(0).toUpperCase()+role.slice(1);

    var races=['Human','Half-Elf','Tiefling','Dwarf','Elf','Halfling','Gnome','Goliath','Half-Orc'];
    var race=_swPick(races);
    var ageGroups=['young (early 20s)','middle-aged','older (50s–60s)','elderly','age unclear'];
    var age=_swPick(ageGroups);

    var openerPool = [
        'Opening line: "If you\'re here for answers, decide first whether you want the useful kind or the honest kind."',
        'Opening line: "I can help you quickly, cheaply, or quietly. Pick one and stop wasting daylight."',
        'Opening line: "Say your request once. If you repeat it, the price goes up."',
        'Opening line: "Everyone comes here pretending they have options. Sit. Let\'s skip that part."',
        'Opening line: "I\'ll tell you what I know after you tell me what you\'re willing to lose."'
    ];
    var pressurePool = [
        'Pressure point: They protect one specific person and will compromise nearly any plan to keep that person safe.',
        'Pressure point: Their livelihood depends on one patron whose reputation cannot survive public scandal.',
        'Pressure point: They are being watched by someone they cannot identify but clearly fear.',
        'Pressure point: They carry guilt tied to a prior case and overcompensate by controlling details.',
        'Pressure point: They owe a debt with a deadline measured in days, not weeks.'
    ];
    var bargainPool = [
        'Bargain they accept: protection for a witness in exchange for full access to their records.',
        'Bargain they accept: public credit and private deniability — they help if their name stays out.',
        'Bargain they accept: retrieval of a personal item currently held by an enemy faction.',
        'Bargain they accept: immunity for one accomplice who was coerced into participation.',
        'Bargain they accept: a written guarantee from the party before they reveal proof.'
    ];

    var opener = _swPick(openerPool);
    var pressure = _swPick(pressurePool);
    var bargain = _swPick(bargainPool);

    var html='<div style="background:linear-gradient(145deg,#140d00,#1e1400);border:1px solid rgba(255,160,96,0.3);border-radius:8px;padding:14px;margin-bottom:10px;">'
        +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;">'
        +'<div>'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.95em;font-weight:700;color:#ffe0a0;letter-spacing:1px;">'+name+'</div>'
        +'<div style="font-size:0.78em;color:rgba(255,200,120,0.65);margin-top:2px;">'+race+' · '+age+'</div>'
        +'</div>'
        +'<div style="text-align:right;">'
        +'<span style="padding:3px 10px;border-radius:8px;font-size:0.7em;font-family:\'Cinzel\',serif;background:rgba(255,160,96,0.2);border:1px solid rgba(255,160,96,0.4);color:#ffa060;">'+roleLabel+'</span>'
        +'</div></div>'
        +'<div style="background:rgba(0,0,0,0.2);border-left:3px solid rgba(255,160,96,0.4);padding:8px 12px;border-radius:0 5px 5px 0;margin-bottom:10px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.62em;color:rgba(255,160,96,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Attitude</div>'
        +'<div style="font-size:0.87em;color:rgba(255,248,220,0.8);">'+attDesc+'</div>'
        +'</div>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">'
        +'<div style="background:rgba(0,0,0,0.15);border:1px solid rgba(255,160,96,0.15);border-radius:6px;padding:8px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.62em;color:rgba(255,160,96,0.6);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Trait</div>'
        +'<div style="font-size:0.85em;color:rgba(255,240,200,0.75);">'+trait+'</div>'
        +'</div>'
        +'<div style="background:rgba(80,0,0,0.15);border:1px solid rgba(200,0,0,0.2);border-radius:6px;padding:8px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.62em;color:rgba(220,80,80,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Hidden</div>'
        +'<div style="font-size:0.85em;color:rgba(255,200,200,0.7);">'+secret+'</div>'
        +'</div></div>'
        +'<div style="background:rgba(20,20,40,0.35);border:1px solid rgba(100,160,255,0.25);border-radius:6px;padding:10px 12px;margin-bottom:8px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.62em;color:rgba(120,180,255,0.9);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">💬 Dialogue Prompt</div>'
        +'<div style="font-size:0.88em;color:rgba(220,235,255,0.86);font-style:italic;line-height:1.65;">'+opener+'</div>'
        +'</div>'
        +'<div style="background:rgba(0,0,0,0.2);border:1px solid rgba(255,160,96,0.2);border-radius:6px;padding:10px 12px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.62em;color:rgba(255,190,120,0.85);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">🎭 Roleplay Levers</div>'
        +'<div style="font-size:0.85em;color:rgba(255,240,210,0.82);line-height:1.7;">• '+pressure+'<br>• '+bargain+'</div>'
        +'</div>'
        +'</div>';

    _swNpcAccum.unshift(html);
    if(_swNpcAccum.length>6)_swNpcAccum=_swNpcAccum.slice(0,6);
    var outEl=document.getElementById('swNpcOutput');
    if(outEl){outEl.style.display='block';outEl.innerHTML=_swNpcAccum.join('');}
    if(typeof showToast==='function')showToast('NPC concept generated!','success');
}

/* ── Helper builders ── */
function _swBlock(col, label, content) {
    return '<div style="background:rgba(160,100,255,0.1);border-left:3px solid '+col+';padding:10px 14px;border-radius:0 6px 6px 0;margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.65em;color:'+col+';text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;">'+label+'</div>'
        +'<div style="font-style:italic;">'+content+'</div>'
        +'</div>';
}
function _swSection(label, col, content) {
    return '<div style="margin-bottom:14px;">'
        +'<div style="font-family:\'Cinzel\',serif;font-size:0.72em;font-weight:700;color:'+col+';text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;border-bottom:1px solid rgba(160,100,255,0.15);padding-bottom:4px;">'+label+'</div>'
        +content
        +'</div>';
}

/* ── DOMContentLoaded Init ── */
document.addEventListener('DOMContentLoaded', function() {
    swSwitchTab('story');
    swRenderSavedStories();
    swRenderSavedLocs();
    if (typeof swLoadStoryAISettings === 'function') swLoadStoryAISettings();
    if (typeof swUpdateBuildOnStoryButtonVisibility === 'function') swUpdateBuildOnStoryButtonVisibility();
    if (typeof renderHeaderPlayerCards === 'function') renderHeaderPlayerCards();
});



/* ═══════════════════════════════════════════════════════════════
   NPC / MONSTER TAB SWITCH
   ═══════════════════════════════════════════════════════════════ */
function switchGenMode(mode) {
    var npcPanel = document.getElementById('genPanel_npc');
    var monPanel = document.getElementById('genPanel_monster');
    var npcTab = document.getElementById('genModeTab_npc');
    var monTab = document.getElementById('genModeTab_monster');
    if (mode === 'npc') {
        if (npcPanel) npcPanel.style.display = '';
        if (monPanel) monPanel.style.display = 'none';
        if (npcTab) { npcTab.style.background = 'linear-gradient(145deg,var(--red),var(--red-dark))'; npcTab.style.color = '#fff8dc'; }
        if (monTab) { monTab.style.background = 'rgba(255,255,255,0.05)'; monTab.style.color = 'rgba(255,248,220,0.5)'; }
    } else {
        if (npcPanel) npcPanel.style.display = 'none';
        if (monPanel) monPanel.style.display = '';
        if (monTab) { monTab.style.background = 'linear-gradient(145deg,#8b0000,#5a0000)'; monTab.style.color = '#fff8dc'; }
        if (npcTab) { npcTab.style.background = 'rgba(255,255,255,0.05)'; npcTab.style.color = 'rgba(255,248,220,0.5)'; }
        if (typeof _populateMonsterDropdown === 'function') _populateMonsterDropdown();
    }
}

/* ═══════════════════════════════════════════════════════════════
   ENHANCEMENTS v3 — Complete Fixes
   ═══════════════════════════════════════════════════════════════ */

/* ─── FIX: Encounter Calc always on top ──────────────────────── */
(function() {
    var _origOpen = window.openEncounterCalc;
    window.openEncounterCalc = function() {
        var m = document.getElementById('encounterCalcModal');
        if (m) { m.style.zIndex = '99999'; m.style.display = 'flex'; m.classList.add('active'); }
    };
})();

/* ─── PLAYER SPELL PREVIEW ───────────────────────────────────── */
window.psPreviewSpells = function() {
    if (typeof psRenderKnownSpellsDraft === 'function') psRenderKnownSpellsDraft();
};

/* ─── PATCH savePlayerSheet — save spells + close + refresh ─── */
(function() {
    var _origSave = window.savePlayerSheet;
    window.savePlayerSheet = function() {
        if (_origSave) _origSave.apply(this, arguments);
        if (typeof renderHeaderPlayerCards === 'function') renderHeaderPlayerCards();
    };
})();

/* ─── PATCH openPlayerSheet — load spells into textarea ─────── */
(function() {
    var _origOpen = window.openPlayerSheet;
    window.openPlayerSheet = function(pid) {
        if (_origOpen) _origOpen.apply(this, arguments);
        setTimeout(function() {
            var p = window._party && window._party.find(function(m){ return m.id === pid; });
            if (typeof psLoadKnownSpellsFromPlayer === 'function') psLoadKnownSpellsFromPlayer(p || null);
        }, 60);
    };
})();

/* ─── PLAYER SPELL PICKER (inline, no modal) ─────────────────── */
window._psKnownSpellsDraft = window._psKnownSpellsDraft || [];
window.psEnsureSpellPickerReady = function() {
    var src = (typeof _allSpells !== 'undefined' && Array.isArray(_allSpells)) ? _allSpells : (window._allSpells || []);
    if (typeof loadSpellDatabase === 'function' && (!src || !src.length)) {
        loadSpellDatabase();
        src = (typeof _allSpells !== 'undefined' && Array.isArray(_allSpells)) ? _allSpells : (window._allSpells || []);
    }
    var sel = document.getElementById('psSpellSelect');
    if (!sel) return;
    var src = (typeof _allSpells !== 'undefined' && Array.isArray(_allSpells)) ? _allSpells : (window._allSpells || []);
    var srcLen = Array.isArray(src) ? src.length : 0;
    var builtLen = parseInt(sel.dataset.sourceLen || '0', 10) || 0;
    if (typeof psBuildSpellDropdown === 'function' && (sel.dataset.built !== '1' || builtLen !== srcLen)) {
        psBuildSpellDropdown();
    }
    sel.dataset.built = '1';
    sel.dataset.sourceLen = String(srcLen);
};

window.psBuildSpellDropdown = function() {
    var sel = document.getElementById('psSpellSelect');
    if (!sel) return;
    var src = (typeof _allSpells !== 'undefined' && Array.isArray(_allSpells)) ? _allSpells : (window._allSpells || []);
    var spells = (src || []).slice();
    spells.sort(function(a,b){
        var la = (typeof a.level === 'number') ? a.level : 99;
        var lb = (typeof b.level === 'number') ? b.level : 99;
        if (la !== lb) return la - lb;
        return String(a.name||'').localeCompare(String(b.name||''));
    });

    var base = '<option value="">— Select a spell —</option>';
    var options = spells.map(function(s){
        var lvl = (typeof s.level === 'number') ? s.level : '';
        var lvlTxt = (lvl === 0) ? 'Cantrip' : (lvl !== '' ? ('Lvl ' + lvl) : '');
        var school = s.school || s.type || '';
        var label = (lvlTxt ? ('[' + lvlTxt + '] ') : '') + (s.name||'') + (school ? (' — ' + school) : '');
        return '<option value="' + String(s.name||'').replace(/"/g,'&quot;') + '" data-level="' + lvl + '">' + String(label).replace(/</g,'&lt;') + '</option>';
    }).join('');
    sel.innerHTML = base + options;
};

window.psFilterSpellDropdown = function() {
    var searchEl = document.getElementById('psSpellSearch');
    var sel = document.getElementById('psSpellSelect');
    if (!searchEl || !sel) return;
    var q = (searchEl.value || '').trim().toLowerCase();
    // If not built yet, build it now.
    if (sel.dataset.built !== '1') {
        if (typeof psEnsureSpellPickerReady === 'function') psEnsureSpellPickerReady();
    }
    var firstVisible = '';
    Array.from(sel.options).forEach(function(opt, idx){
        if (idx === 0) return; // keep placeholder visible
        var txt = (opt.textContent || '').toLowerCase();
        opt.hidden = q ? (txt.indexOf(q) === -1) : false;
        if (!opt.hidden && !firstVisible) firstVisible = opt.value || '';
    });
    if (q && firstVisible && (!sel.value || sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].hidden)) {
        sel.value = firstVisible;
    }
    if (!q && !sel.value) sel.selectedIndex = 0;
    if (typeof psShowSelectedSpellDetails === 'function') psShowSelectedSpellDetails();
};

window.psShowSelectedSpellDetails = function() {
    var sel = document.getElementById('psSpellSelect');
    var box = document.getElementById('psSpellDetails');
    if (!sel || !box) return;
    var name = (sel.value || '').trim();
    if (!name) { box.style.display = 'none'; return; }
    var spells = (typeof _allSpells !== 'undefined' && Array.isArray(_allSpells)) ? _allSpells : (window._allSpells || []);
    var sp = spells.find(function(s){ return String(s.name||'') === name; }) || null;
    if (!sp) { box.style.display = 'none'; return; }

    var lvl = (typeof sp.level === 'number') ? sp.level : null;
    var lvlTxt = (lvl === 0) ? 'Cantrip' : (lvl != null ? ('Level ' + lvl) : '');
    var school = sp.school || '';
    var ct = sp.castingTime || sp.casting_time || '';
    var range = sp.range || '';
    var dur = sp.duration || '';
    var comp = sp.components || '';
    var desc = sp.description || sp.desc || '';

    var metaBits = [];
    if (lvlTxt) metaBits.push(lvlTxt);
    if (school) metaBits.push(school);
    if (ct) metaBits.push('Cast: ' + ct);
    if (range) metaBits.push('Range: ' + range);
    if (dur) metaBits.push('Duration: ' + dur);
    if (comp) metaBits.push('Components: ' + comp);

    var nameEl = document.getElementById('psSpellDetailsName');
    var metaEl = document.getElementById('psSpellDetailsMeta');
    var descEl = document.getElementById('psSpellDetailsDesc');
    if (nameEl) nameEl.textContent = sp.name || name;
    if (metaEl) metaEl.textContent = metaBits.join(' · ');
    if (descEl) descEl.textContent = desc;
    box.style.display = 'block';
};

window.psLoadKnownSpellsFromPlayer = function(p) {
    var arr = (p && Array.isArray(p.knownSpells)) ? p.knownSpells.slice() : [];
    arr = arr
        .map(function(s){ return (s && typeof s === 'object') ? (s.name || '') : String(s || ''); })
        .map(function(s){ return String(s).trim(); })
        .filter(Boolean);
    window._psKnownSpellsDraft = arr;
    var hid = document.getElementById('psKnownSpellsJson');
    if (hid) hid.value = JSON.stringify(arr);
    if (typeof psRenderKnownSpellsDraft === 'function') psRenderKnownSpellsDraft();
};

window.psRenderKnownSpellsDraft = function() {
    var el = document.getElementById('psKnownSpellsTags');
    var hid = document.getElementById('psKnownSpellsJson');
    if (!el || !hid) return;
    var arr = window._psKnownSpellsDraft || [];
    hid.value = JSON.stringify(arr);
    if (!arr.length) {
        el.innerHTML = '<div style="color:rgba(52,152,219,0.65);font-family:\'Crimson Text\',serif;font-style:italic;">No spells selected.</div>';
        return;
    }
    el.innerHTML = arr.map(function(s, idx) {
        return '<span style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:rgba(52,152,219,0.16);border:1px solid rgba(52,152,219,0.45);color:#1a6b9a;font-family:\'Crimson Text\',serif;">'
            + String(s)
            + '<button onclick="psRemoveKnownSpell(' + idx + ')" title="Remove" style="border:none;background:rgba(0,0,0,0.2);color:#1a6b9a;border-radius:999px;cursor:pointer;padding:0 7px;font-family:\'Cinzel\',serif;font-weight:900;">×</button>'
            + '</span>';
    }).join('');
};

window.psAddPickedSpell = function() {
    var sel = document.getElementById('psSpellSelect');
    if (!sel) return;
    var name = (sel.value || '').trim();
    if (!name) return;
    window._psKnownSpellsDraft = window._psKnownSpellsDraft || [];
    var exists = window._psKnownSpellsDraft.some(function(s){ return String(s||'').toLowerCase() === name.toLowerCase(); });
    if (!exists) window._psKnownSpellsDraft.push(name);
    if (typeof psRenderKnownSpellsDraft === 'function') psRenderKnownSpellsDraft();
};

window.psRemoveKnownSpell = function(idx) {
    window._psKnownSpellsDraft = window._psKnownSpellsDraft || [];
    if (idx < 0 || idx >= window._psKnownSpellsDraft.length) return;
    window._psKnownSpellsDraft.splice(idx, 1);
    psRenderKnownSpellsDraft();
};

window.psClearKnownSpells = function() {
    window._psKnownSpellsDraft = [];
    psRenderKnownSpellsDraft();
};

/* ─── PLAYER MINI CARDS IN HEADER ───────────────────────────── */
window.renderHeaderPlayerCards = function() {
    var el = document.getElementById('headerPlayerCards');
    if (!el) return;
    var party = window._party || [];
    if (!party.length) { el.innerHTML = ''; return; }
    el.innerHTML = party.map(function(p, idx) {
        var hp    = p.hpCurr || 0;
        var maxhp = p.hpMax  || 1;
        var ac    = p.ac     || 10;
        var pct   = Math.max(0, Math.min(100, Math.round((hp / maxhp) * 100)));
        var col   = pct <= 25 ? '#c0392b' : pct <= 50 ? '#e67e22' : '#27ae60';
        var bg    = pct <= 25 ? 'rgba(139,0,0,0.25)' : pct <= 50 ? 'rgba(230,126,34,0.18)' : 'rgba(39,174,96,0.15)';
        var cls   = p.cls || '';
        var lvl   = p.level || 1;
        var conds = (p.conditions || []).length;
        var spCnt = (p.spells || []).length;
        var insp  = p.insp ? ' ★' : '';
        var pid   = p.id;
        return ''
            + '<div onclick="openPlayerSheet(\'' + pid + '\')" '
            + 'title="Edit ' + (p.name||'Player') + '" '
            + 'style="background:' + bg + ';border:1px solid ' + col + ';border-radius:7px;padding:5px 10px;cursor:pointer;min-width:88px;max-width:128px;transition:transform 0.15s,box-shadow 0.15s;flex-shrink:0;" '
            + 'onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 5px 14px rgba(0,0,0,0.45)\'" '
            + 'onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\'">'

            + '<div style="font-family:\'Cinzel\',serif;font-size:0.66em;font-weight:700;color:#fff8dc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'
            + (p.name || '?') + insp + ' <span style="font-weight:700;color:rgba(255,255,255,0.55);">(AC ' + ac + ', ' + hp + '/' + maxhp + ')</span></div>'

            + '<div style="font-size:0.58em;color:rgba(255,255,255,0.48);margin-bottom:3px;">'
            + cls + (lvl ? ' ' + lvl : '')
            + (conds ? ' · <span style="color:#e74c3c;">' + conds + ' cond.</span>' : '')
            + '</div>'

            + '<div style="background:rgba(0,0,0,0.35);border-radius:3px;height:5px;overflow:hidden;margin-bottom:3px;">'
            + '<div style="height:100%;width:' + pct + '%;background:' + col + ';border-radius:3px;transition:width 0.4s;"></div>'
            + '</div>'

            + '<div style="display:flex;justify-content:space-between;align-items:center;">'
            + '<span style="font-size:0.62em;color:' + col + ';font-weight:700;">' + hp + '/' + maxhp + ' HP</span>'
            + '<div style="display:flex;gap:2px;" onclick="event.stopPropagation()">'
            + '<button onclick="quickHP(\'' + pid + '\',-1);renderHeaderPlayerCards()" style="width:17px;height:17px;background:#c0392b;color:white;border:none;border-radius:3px;cursor:pointer;font-size:0.75em;font-weight:700;line-height:1;padding:0;">−</button>'
            + '<button onclick="quickHP(\'' + pid + '\',+1);renderHeaderPlayerCards()" style="width:17px;height:17px;background:#27ae60;color:white;border:none;border-radius:3px;cursor:pointer;font-size:0.75em;font-weight:700;line-height:1;padding:0;">+</button>'
            + '</div></div>'

            + (spCnt ? '<div style="font-size:0.57em;color:rgba(120,190,255,0.85);margin-top:2px;">✦ ' + spCnt + ' spell' + (spCnt !== 1 ? 's' : '') + '</div>' : '')
            + '</div>';
    }).join('');
};

/* Patch renderHeaderPartyHealth to always also refresh cards */
(function() {
    var _orig = window.renderHeaderPartyHealth;
    window.renderHeaderPartyHealth = function() {
        if (_orig) _orig.apply(this, arguments);
        renderHeaderPlayerCards();
    };
})();

/* Patch quickHP to refresh cards */
(function() {
    var _orig = window.quickHP;
    window.quickHP = function(pid, dir) {
        if (_orig) _orig.apply(this, arguments);
        setTimeout(renderHeaderPlayerCards, 50);
    };
})();

/* Patch party-altering functions */
(function() {
    ['addPartyMember','removePartyMember','clearAllPartyMembers'].forEach(function(fn) {
        var _o = window[fn];
        if (_o) window[fn] = function() {
            _o.apply(this, arguments);
            setTimeout(renderHeaderPlayerCards, 200);
        };
    });
})();

/* ══════════════════════════════════════════════════════════════
   LIVE DM TOOLS (Round Tracker + Quick Ref + Backup)
   ══════════════════════════════════════════════════════════════ */
var _dmLiveTools = null;
function _dmLoadLiveTools() {
    try {
        _dmLiveTools = JSON.parse(localStorage.getItem('dm_live_tools') || 'null');
    } catch(e) {
        _dmLiveTools = null;
    }
    if (!_dmLiveTools || typeof _dmLiveTools !== 'object') {
        _dmLiveTools = { round: 1, turnIndex: 0, order: [], notes: '' };
    }
}
function _dmSaveLiveTools() {
    if (window._isOneShot) return;
    try { localStorage.setItem('dm_live_tools', JSON.stringify(_dmLiveTools)); } catch(e){}
}

var MINIGAME_TAVERN = [
    { name: 'Rumors table', desc: 'Roll 1d6: 1\u20132 false, 3\u20134 half-true, 5\u20136 true. Pick a rumor from your notes or generate one.' },
    { name: 'Drinking contest', desc: 'CON save each round, DC 10 + round number. Three fails = pass out. Winner gets a free room or info.' },
    { name: 'Bar brawl', desc: 'Non-lethal. First to 0 HP is out. Last standing wins the pot or settles the argument.' },
    { name: 'Bard duel', desc: 'Performance checks, audience votes (group Persuasion or Performance). Loser buys the next round.' },
    { name: 'Darts', desc: 'Each player rolls 1d20 three times. Highest total wins. Sleight of Hand check (DC 14) lets you reroll one throw.' },
    { name: 'Arm wrestling', desc: 'Contested STR checks, best of 3. Each win moves your arm one step closer. Nat 20 counts as two steps. Stake gold or a favor.' },
    { name: 'Knife throwing', desc: 'DEX (ranged attack) at targets across the room. DC 12 / 15 / 18 for inner ring / bullseye / split-the-arrow. Wager gold per round.' },
    { name: 'Mug slide', desc: 'Slide a tankard down the bar to land in the target zone. DEX check: DC 10 = on the bar, DC 14 = target zone, DC 18 = perfect stop. Loser drinks.' },
    { name: 'Liar\'s dice', desc: 'Each player rolls 5d6 hidden under a cup. Bid how many of a certain number exist among ALL dice. Next player raises or calls the bluff. Loser forfeits a die. Last player with dice wins.' },
    { name: 'Tavern trivia', desc: 'DM asks lore questions (History, Arcana, Religion, Nature). DC 12/15/18 for easy/medium/hard. First to 5 correct answers wins the pot.' },
    { name: 'Tall tales', desc: 'Each patron tells an outrageous story. Other players roll Insight vs the teller\'s Deception. If no one catches the lie, the teller wins a free drink.' },
    { name: 'Thumb war', desc: 'Quick contested DEX checks. Best of 3. Winner gets bragging rights or a small wager. Nat 1 = you poke yourself in the eye.' },
    { name: 'Song request challenge', desc: 'Crowd names a topic; bard/player must improvise a verse. Performance DC 13. Success = tips (1d6 gp). Failure = booing and thrown vegetables.' }
];
var MINIGAME_TOWN = [
    { name: 'Market haggling', desc: 'Persuasion vs merchant\'s Insight. Beat by 5+ = 25% off. Tie = normal price. Fail by 5+ = insulted, price goes up 10%.' },
    { name: 'Street encounter', desc: 'Pick a random NPC; roll on a "town event" table (stranger, thief, messenger, lost tourist, runaway cart, etc.).' },
    { name: 'Rumor mill', desc: 'Each player hears one rumor from a different NPC. One is false. Party votes which to believe and follow up on.' },
    { name: 'Guard checkpoint', desc: 'Persuasion or Deception to pass; or bribe (1d10 gp). Failure = delay, fine, or search of belongings.' },
    { name: 'Lost child / lost item', desc: 'Short skill challenge: find the owner or item in 3 successes before 2 failures. Investigation, Perception, Persuasion.' },
    { name: 'Archery contest', desc: 'Ranged attack rolls at 30/60/120 ft targets (AC 12/15/18). Three shots each, highest total score wins a prize or gold.' },
    { name: 'Foot race', desc: 'Three rounds of contested Athletics checks. Each win = one length ahead. Player furthest ahead at the end wins. Dash action = advantage but CON save DC 12 next round or gain exhaustion.' },
    { name: 'Pie eating contest', desc: 'CON saves each round, DC 10 + 2 per pie eaten. First to fail is out. Last one eating wins. Optional: one pie is spicy (DC +5 that round).' },
    { name: 'Tug of war', desc: 'Group contested STR check. Each side sums their rolls. Best of 3 pulls. Team with more total wins. Nat 20 counts double.' },
    { name: 'Pickpocket alley', desc: 'A shady NPC challenges a player to a Sleight of Hand contest. Contested checks, best of 3. Winner keeps a trinket or 2d6 gp from the loser.' },
    { name: 'Town crier audition', desc: 'Persuasion or Performance DC 14 to deliver a public announcement with flair. Success = 2d6 gp tip and a local contact. Failure = tomatoes thrown.' },
    { name: 'Courier run', desc: 'Deliver a package across town before a timer runs out. Three Athletics/Acrobatics checks (DC 12) to navigate crowds, alleys, and rooftops. 2+ successes = on time.' },
    { name: 'Busking', desc: 'A player performs in the town square. Performance check: DC 10 = 1d4 cp, DC 14 = 2d6 sp, DC 18 = 1d6 gp, Nat 20 = a noble drops 5 gp and offers a job.' }
];
var MINIGAME_CAMPFIRE = [
    { name: 'Would you rather', desc: 'DM asks: "Would you rather [fantasy dilemma]?" Each player answers in character. Great for revealing personality and sparking debate.' },
    { name: 'Story round', desc: 'Each player tells one true thing about their character\'s past (or a lie; others guess). Deception vs Insight if lying.' },
    { name: 'Two truths and a lie', desc: 'Each player says three things about their character; others guess the lie. Insight vs Deception to detect it.' },
    { name: 'Campfire tale', desc: 'One player starts a scary/funny story; next player continues. Pass around the circle. Best performance (group vote) earns Inspiration.' },
    { name: 'Confession', desc: 'Each player shares a secret their character has never told the party. Optional: one confession is false, others must guess.' },
    { name: 'Twenty questions', desc: 'One player thinks of a creature, place, or item from the campaign. Others ask yes/no questions. 20 questions to guess it. Winner picks next.' },
    { name: 'Ghost stories', desc: 'One player tells a horror tale (Performance DC 13). Listeners make WIS saves (DC = the Performance roll). Failures are Frightened until dawn. Fun for flavor.' },
    { name: 'Dream interpretation', desc: 'DM describes a strange dream one character had. Players roll Arcana/Religion/Insight (DC 14) to interpret it. Success reveals a cryptic clue about the plot.' },
    { name: 'Riddle contest', desc: 'DM poses a riddle. First player to solve it in-character gets Inspiration or a small reward. Alternatively, INT check DC 15 for a hint.' },
    { name: 'Star gazing', desc: 'Nature or Arcana check (DC 12). Success = the character reads an omen (DM gives a vague hint about upcoming events). Nat 20 = a clear prophetic vision.' },
    { name: 'Knife game', desc: 'Spread your fingers on a log, stab between them quickly. DEX check each round: DC 10, then DC 13, DC 16, DC 19. Failure = 1d4 piercing damage. Last player still going wins.' },
    { name: 'Wilderness bet', desc: 'Each player predicts something about tomorrow (weather, encounter, terrain). DM secretly notes predictions. Whoever is closest gets bragging rights or 1 gp from each loser.' },
    { name: 'What would you do?', desc: 'DM describes a moral dilemma. Each player says what their character would do and why. No dice, just roleplaying. Great for character development.' }
];
var MINIGAME_FESTIVAL = [
    { name: 'Apple bobbing', desc: 'Hold your breath (CON check DC 10) then grab an apple (DEX check DC 13). Fail the CON check = you come up sputtering. Grab a golden apple (DC 18) for the grand prize.' },
    { name: 'Bottle toss', desc: 'Knock down a pyramid of bottles with 3 throws. Ranged attack rolls vs AC 10/13/16 for bottom/middle/top. Knock all down for the big prize.' },
    { name: 'Greased pig chase', desc: 'Skill challenge: Athletics DC 13 to close in, then Animal Handling DC 15 to grab it, then STR DC 12 to hold on. First to complete all three wins the pig (or a prize).' },
    { name: 'Log chopping', desc: 'STR checks in a race against an NPC. DC 14 each swing. First to 5 successes chops through their log. Nat 20 = counts as 2 swings.' },
    { name: 'Dance-off', desc: 'Performance checks each round vs an NPC dancer. Best of 3. Crowd cheers louder for higher rolls. Winner gets a flower crown and 2d6 gp.' },
    { name: 'Three-legged race', desc: 'Paired with another player. Both roll Athletics simultaneously; use the LOWER result. DC 10/12/14 over 3 legs. Pair with most successes wins.' },
    { name: 'Pie judging', desc: 'Cook\'s Utensils check (DC 13) or Survival (DC 15) to prepare a dish. DM rolls a secret d20 for taste. Combined score vs other contestants determines placement.' },
    { name: 'Arm of champions', desc: 'Tournament-bracket arm wrestling. Contested STR checks vs increasingly strong NPCs (STR 10, 14, 18). Winning all three rounds earns a trophy and 10 gp.' },
    { name: 'Ring toss', desc: 'Toss rings onto pegs at increasing distance. DEX checks: DC 10 (close), DC 14 (medium), DC 18 (far). Each hit earns a small prize; all three = jackpot.' },
    { name: 'Jousting', desc: 'Mounted. Contested melee attack rolls, loser makes a DEX save (DC = attacker\'s roll) or is knocked off. Best of 3 passes. No real damage (padded lances).' },
    { name: 'Cheese wheel chase', desc: 'A cheese wheel rolls downhill. Athletics checks DC 12 each round for 3 rounds. Most successes catches it first. Tie = contested final DEX check.' },
    { name: 'Spin the wheel', desc: 'Pure luck! Roll 1d20: 1\u20135 = lose your bet, 6\u201310 = break even, 11\u201315 = win 2x, 16\u201319 = win 3x, 20 = jackpot (10x).' }
];
var MINIGAME_GAMBLING = [
    { name: 'Crown & Anchor', desc: 'Pick a number 1\u20136, then roll 3d6. If 1 die matches = win 1x your bet. 2 match = 2x. All 3 match = 3x. No match = lose your bet. Simple and fast.' },
    { name: 'Twenty-One', desc: 'Dice blackjack. You have a d4, d6, d8, d10, d12, d20. Roll dice of your choice one at a time, trying to total exactly 21. Go over and you bust. Closest to 21 wins the pot.' },
    { name: 'Dice poker', desc: 'Each player secretly rolls 2 dice, then a shared pool of d6+d8+d10 is revealed one at a time. Bet/raise/fold after each reveal. Best poker hand (pairs, straights, etc.) wins.' },
    { name: 'High-Low', desc: 'Dealer rolls 1d20 and hides it. Player guesses: higher or lower than 10? Correct = double your bet. Incorrect = lose it. Can go double-or-nothing up to 3 times.' },
    { name: 'Threes Away', desc: 'Everyone rolls 5d6. All numbers are face value except 3s which are worth 0. Lowest total wins the pot. Quick and chaotic.' },
    { name: 'Dragon\'s hoard', desc: 'Progressive risk game. Roll d4 (DC 3), d6 (DC 3), d8 (DC 3), d10 (DC 3), d12, d20 in order. Roll 3 or below to advance. Stop anytime to collect winnings. Roll 4+ = lose everything. Payouts: d4=2gp, d6=5gp, d8=20gp, d10=100gp, d12=500gp, d20=2000gp.' },
    { name: 'Wheel of misfortune', desc: 'Fantasy roulette. Bet on: odd/even (2:1), a range of 5 numbers (4:1), or a single number (20:1). Roll 1d20 to determine the winner.' },
    { name: 'Dead man\'s dice', desc: 'Each player rolls a d20, d12, d10, d8, d6, d4. Any 1s knock out your largest remaining die. Keep rolling each round. Last player with dice left wins the pot.' },
    { name: 'Bluff', desc: 'Each player rolls 5d6 hidden. First player bids a quantity of a face value among ALL dice on the table. Next player must raise or call bluff. If called, all reveal. Wrong bidder loses a die. Last player standing wins.' },
    { name: 'Copper toss', desc: 'Flip a coin (roll 1d2). Call it in the air. Win = double your bet. Lose = lose it. Simple, but offer it as best of 5 for bigger stakes and tension.' },
    { name: 'Pit fighter wager', desc: 'Two NPCs fight in a pit. Players bet on the winner. DM rolls combat secretly. Odds set by NPC stats. Pays 2:1 for the favorite, 5:1 for the underdog.' },
    { name: 'Knucklebones', desc: 'Ancient dice game. Roll 4d6. Score = sum of unique numbers only (duplicates score 0). Example: rolling 3,3,5,2 = 5+2 = 7. Highest score after 3 rounds wins.' }
];
function openMinigamesModal() {
    var m = document.getElementById('minigamesModal');
    if (m) { m.style.display = 'flex'; minigameTab('tavern'); }
}
function closeMinigamesModal() {
    var m = document.getElementById('minigamesModal');
    if (m) m.style.display = 'none';
}
function minigameTab(tab) {
    var allTabs = ['tavern','town','campfire','festival','gambling'];
    allTabs.forEach(function(t) {
        var btn = document.getElementById('minigameTab_' + t);
        var panel = document.getElementById('minigameContent_' + t);
        if (btn) { btn.style.background = t === tab ? 'rgba(160,100,255,0.2)' : 'rgba(255,255,255,0.05)'; btn.style.borderColor = t === tab ? 'rgba(160,100,255,0.4)' : 'rgba(255,255,255,0.2)'; btn.style.color = t === tab ? '#e0c0ff' : 'rgba(255,255,255,0.75)'; btn.style.fontWeight = t === tab ? '900' : 'normal'; }
        if (panel) panel.style.display = t === tab ? 'block' : 'none';
    });
    var colorMap = { tavern: ['rgba(218,165,32,0.25)','#daa520'], town: ['rgba(80,160,80,0.25)','#90ee90'], campfire: ['rgba(255,160,96,0.25)','#ffa060'], festival: ['rgba(240,192,96,0.25)','#f0c060'], gambling: ['rgba(255,128,160,0.25)','#ff80a0'] };
    var dataMap = { tavern: MINIGAME_TAVERN, town: MINIGAME_TOWN, campfire: MINIGAME_CAMPFIRE, festival: MINIGAME_FESTIVAL, gambling: MINIGAME_GAMBLING };
    var listMap = { tavern: 'minigameTavernList', town: 'minigameTownList', campfire: 'minigameCampfireList', festival: 'minigameFestivalList', gambling: 'minigameGamblingList' };
    var arr = dataMap[tab]; var elId = listMap[tab]; var colors = colorMap[tab];
    if (arr && elId && colors) {
        var el = document.getElementById(elId);
        if (el) el.innerHTML = arr.map(function(g) { return '<div style="padding:12px;background:rgba(0,0,0,0.25);border-radius:8px;border:1px solid ' + colors[0] + ';"><div style="font-weight:700;color:' + colors[1] + ';margin-bottom:4px;">' + g.name + '</div><div style="font-size:0.9em;color:rgba(255,255,255,0.8);line-height:1.5;">' + g.desc + '</div></div>'; }).join('');
    }
}
function openLiveDMTools() {
    _dmLoadLiveTools();
    var modal = document.getElementById('liveDMToolsModal');
    if (!modal) return;
    modal.style.display = 'flex';
    dmToolSwitch('round');
    dmRenderRoundTracker();
    dmRenderQuickConditions();
    dmRenderSkillPrompts();
}
function closeLiveDMTools() {
    var modal = document.getElementById('liveDMToolsModal');
    if (!modal) return;
    modal.style.display = 'none';
}

function refreshCsOllamaStatus() {
    var statusEl = document.getElementById('csOllamaStatus');
    var installBtn = document.getElementById('csOllamaInstallBtn');
    if (!statusEl) return;
    if (!window.desktopApp || typeof window.desktopApp.getOllamaStatus !== 'function') {
        statusEl.textContent = 'Ollama: Use desktop app for AI';
        statusEl.style.borderColor = 'rgba(218,165,32,0.35)';
        statusEl.style.background = 'rgba(0,0,0,0.35)';
        statusEl.style.color = 'rgba(255,255,255,0.6)';
        if (installBtn) installBtn.style.display = 'none';
        return;
    }
    window.desktopApp.getOllamaStatus().then(function(s) {
        if (s.connected) {
            statusEl.textContent = 'Ollama: \u2713 Ready';
            statusEl.style.borderColor = 'rgba(80,200,80,0.5)';
            statusEl.style.background = 'rgba(40,100,40,0.3)';
            statusEl.style.color = '#a0e8a0';
            if (installBtn) installBtn.style.display = 'none';
        } else {
            statusEl.textContent = 'Ollama: Not connected';
            statusEl.style.borderColor = 'rgba(218,165,32,0.35)';
            statusEl.style.background = 'rgba(0,0,0,0.35)';
            statusEl.style.color = 'rgba(255,255,255,0.7)';
            if (installBtn) installBtn.style.display = 'inline-block';
        }
    }).catch(function() {
        statusEl.textContent = 'Ollama: Not detected';
        if (installBtn) installBtn.style.display = 'inline-block';
    });
}

function showAISetupBannerIfNeeded() {
    if (!window.desktopApp || typeof window.desktopApp.getOllamaStatus !== 'function') return;
    if (localStorage.getItem('dm_ai_banner_dismissed') === '1') return;
    var bannerEl = document.getElementById('dmAISetupBanner');
    if (bannerEl) return;
    var wrapper = document.querySelector('.main-wrapper');
    if (!wrapper) return;
    function showBanner(msg, btnLabel, btnAction) {
        var banner = document.createElement('div');
        banner.id = 'dmAISetupBanner';
        banner.style.cssText = 'background:linear-gradient(90deg,rgba(80,40,140,0.4),rgba(60,20,100,0.3));border-bottom:1px solid rgba(160,100,255,0.4);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;font-family:\'Crimson Text\',serif;font-size:0.9em;color:#d0b0ff;';
        banner.innerHTML = '<span>' + msg + '</span><button type="button" onclick="' + btnAction + 'document.getElementById(\'dmAISetupBanner\').remove();localStorage.setItem(\'dm_ai_banner_dismissed\',\'1\');openOptionsModal(\'ai\');" style="padding:6px 12px;background:rgba(160,100,255,0.5);border:1px solid rgba(200,150,255,0.6);color:#fff;border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;">' + btnLabel + '</button><button type="button" onclick="document.getElementById(\'dmAISetupBanner\').remove();localStorage.setItem(\'dm_ai_banner_dismissed\',\'1\');" style="padding:6px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.8);border-radius:6px;cursor:pointer;font-size:0.85em;">Dismiss</button>';
        wrapper.insertBefore(banner, wrapper.firstChild);
    }
    window.desktopApp.getOllamaStatus().then(function(s) {
        if (!s.connected) {
            showBanner('\u2139 AI is not set up. Go to <strong>Options \u2192 AI</strong> to install Ollama and pull a model (e.g. <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;">ollama pull llama2</code>). Story generation and DM Assistant need this.', 'Set up AI', '');
            return;
        }
        if (typeof window.desktopApp.ollamaTags !== 'function') return;
        window.desktopApp.ollamaTags().then(function(r) {
            if (!r || !r.ok || !r.data || !r.data.models || !r.data.models.length) {
                showBanner('\u2139 Ollama is installed. Download the <strong>llama2</strong> model to enable story generation and DM Assistant chat.', 'Download model', '');
            }
        }).catch(function() {});
    }).catch(function() {});
}

function openOptionsModal(section) {
    var modal = document.getElementById('optionsModal');
    if (!modal) return;
    modal.style.display = 'flex';
    var theme = document.body.classList.contains('light-mode') ? 'light' : (localStorage.getItem('npcgen_theme') || 'dark');
    var radios = document.querySelectorAll('input[name="optTheme"]');
    radios.forEach(function(r) { r.checked = (r.value === theme); });
    if (typeof optionsSyncThemeCardStyle === 'function') optionsSyncThemeCardStyle(theme);
    var urlEl = document.getElementById('optionsAIUrl');
    var modelEl = document.getElementById('optionsAIModel');
    var enabledEl = document.getElementById('optionsStoryAIEnabled');
    if (urlEl) urlEl.value = (localStorage.getItem('dm_story_ai_url') || 'http://127.0.0.1:11434').trim();
    if (modelEl) modelEl.value = (localStorage.getItem('dm_story_ai_model') || 'llama2').trim();
    if (enabledEl) enabledEl.checked = localStorage.getItem('dm_story_ai_enabled') === '1';
    var fasterEl = document.getElementById('optionsAIFaster');
    if (fasterEl) fasterEl.checked = localStorage.getItem('dm_ai_faster') === '1';
    if (section === 'ai') optionsSwitchTab('ai');
    else optionsSwitchTab('display');
    optionsRefreshOllamaStatusInModal();
    setTimeout(function() {
        var first = modal.querySelector('button[onclick="closeOptionsModal()"], #optTabDisplay, #optTabAI, #optTabAbout');
        if (first) first.focus();
    }, 80);
}
function closeOptionsModal() {
    var modal = document.getElementById('optionsModal');
    if (modal) modal.style.display = 'none';
}
function optionsSwitchTab(tab) {
    var displayPanel = document.getElementById('optionsDisplayPanel');
    var aiPanel = document.getElementById('optionsAIPanel');
    var aboutPanel = document.getElementById('optionsAboutPanel');
    var btnD = document.getElementById('optTabDisplay');
    var btnA = document.getElementById('optTabAI');
    var btnAbout = document.getElementById('optTabAbout');
    var setInactive = function(btn) {
        if (btn) { btn.style.background = 'rgba(255,255,255,0.05)'; btn.style.borderColor = 'rgba(255,255,255,0.1)'; btn.style.color = 'rgba(255,255,255,0.7)'; }
    };
    var setActive = function(btn) {
        if (btn) { btn.style.background = 'rgba(218,165,32,0.2)'; btn.style.borderColor = 'rgba(218,165,32,0.35)'; btn.style.color = '#fff3c0'; }
    };
    if (displayPanel) displayPanel.style.display = (tab === 'display') ? 'block' : 'none';
    if (aiPanel) aiPanel.style.display = (tab === 'ai') ? 'block' : 'none';
    if (aboutPanel) aboutPanel.style.display = (tab === 'about') ? 'block' : 'none';
    setInactive(btnD); setInactive(btnA); setInactive(btnAbout);
    if (tab === 'display') setActive(btnD);
    else if (tab === 'ai') { setActive(btnA); optionsRefreshOllamaStatusInModal(); }
    else if (tab === 'about') { setActive(btnAbout); optionsRefreshAboutVersion(); }
}
function optionsRefreshAboutVersion() {
    var el = document.getElementById('optionsVersionText');
    if (!el) return;
    if (window.desktopApp && typeof window.desktopApp.getBuildInfo === 'function') {
        window.desktopApp.getBuildInfo().then(function(info) {
            el.textContent = (info.name || 'DND DM Helper') + ' v' + (info.version || '—') + (info.packaged ? ' (installed)' : ' (development)');
        }).catch(function() { el.textContent = 'DND DM Helper (version unknown)'; });
    } else {
        el.textContent = 'DND DM Helper (open in desktop app to see version)';
    }
    var resultEl = document.getElementById('optionsUpdateResult');
    if (resultEl) resultEl.textContent = '';
}
function optionsCheckForUpdates() {
    var btn = document.getElementById('optionsCheckUpdatesBtn');
    var downloadBtn = document.getElementById('optionsDownloadUpdateBtn');
    var restartBtn = document.getElementById('optionsRestartInstallBtn');
    var progressWrap = document.getElementById('optionsUpdateProgressWrap');
    var resultEl = document.getElementById('optionsUpdateResult');
    if (downloadBtn) downloadBtn.style.display = 'none';
    if (restartBtn) restartBtn.style.display = 'none';
    if (progressWrap) progressWrap.style.display = 'none';
    if (!window.desktopApp || typeof window.desktopApp.checkForUpdates !== 'function') {
        if (resultEl) resultEl.innerHTML = '<span style="color:rgba(255,255,255,0.5);">Only available in the installed app.</span>';
        return;
    }
    if (btn) btn.disabled = true;
    if (resultEl) resultEl.textContent = 'Checking…';
    window.desktopApp.checkForUpdates().then(function(r) {
        if (btn) btn.disabled = false;
        if (!resultEl) return;
        if (r.error) {
            resultEl.innerHTML = '<span style="color:#f08080;">' + (r.error || 'Check failed') + '</span>';
            return;
        }
        if (r.available && r.version) {
            var devNote = r.dev ? ' <small style="color:rgba(255,255,255,0.4);">(dev mode — build &amp; install to apply)</small>' : '';
            resultEl.innerHTML = '<span style="color:#80e080;">Update available: v' + r.version + '.' + devNote + ' Click <strong>Download update</strong> below; the app will download it, then you can restart to install.</span>';
            if (downloadBtn && !r.dev) { downloadBtn.style.display = 'inline-block'; downloadBtn.dataset.updateVersion = r.version; }
            if (typeof showToast === 'function') showToast('Update v' + r.version + ' available!' + (r.dev ? ' (dev mode)' : ' Go to Options → About to download.'), 'success');
        } else {
            var msg = r.dev ? 'You\u2019re up to date. (v' + document.getElementById('optionsVersionText').textContent.replace(/[^0-9.]/g,'') + ')' : 'You\u2019re up to date.';
            resultEl.innerHTML = '<span style="color:#80e080;">' + msg + '</span>';
            if (typeof showToast === 'function') showToast('You\u2019re up to date.', 'success');
        }
    }).catch(function(err) {
        if (btn) btn.disabled = false;
        if (resultEl) resultEl.innerHTML = '<span style="color:#f08080;">' + (err && err.message ? err.message : 'Check failed') + '</span>';
    });
}
function optionsDownloadUpdate() {
    var downloadBtn = document.getElementById('optionsDownloadUpdateBtn');
    var progressWrap = document.getElementById('optionsUpdateProgressWrap');
    var progressBar = document.getElementById('optionsUpdateProgressBar');
    var progressText = document.getElementById('optionsUpdateProgressText');
    var resultEl = document.getElementById('optionsUpdateResult');
    if (!window.desktopApp || typeof window.desktopApp.downloadUpdate !== 'function') return;
    if (downloadBtn) downloadBtn.disabled = true;
    if (progressWrap) progressWrap.style.display = 'block';
    if (progressBar) progressBar.style.width = '0%';
    if (progressText) progressText.textContent = 'Starting download…';
    if (resultEl) resultEl.textContent = '';
    window.desktopApp.downloadUpdate().then(function(r) {
        if (r && !r.ok && resultEl) { resultEl.innerHTML = '<span style="color:#f08080;">' + (r.error || 'Download failed') + '</span>'; if (downloadBtn) downloadBtn.disabled = false; }
    });
}
function optionsRestartToInstall() {
    if (window.desktopApp && typeof window.desktopApp.quitAndInstall === 'function') window.desktopApp.quitAndInstall();
}
function optionsUpdateUI_onDownloadProgress(percent, bytesPerSecond, transferred, total) {
    var progressBar = document.getElementById('optionsUpdateProgressBar');
    var progressText = document.getElementById('optionsUpdateProgressText');
    if (progressBar) progressBar.style.width = Math.min(100, Math.round(percent || 0)) + '%';
    if (progressText) {
        var pct = Math.min(100, Math.round(percent || 0));
        var speed = bytesPerSecond != null && bytesPerSecond > 0 ? (bytesPerSecond / 1024 / 1024).toFixed(1) + ' MB/s' : '';
        progressText.textContent = 'Downloading… ' + pct + '%' + (speed ? ' · ' + speed : '');
    }
}
function optionsUpdateUI_onDownloaded() {
    var downloadBtn = document.getElementById('optionsDownloadUpdateBtn');
    var restartBtn = document.getElementById('optionsRestartInstallBtn');
    var progressWrap = document.getElementById('optionsUpdateProgressWrap');
    var progressBar = document.getElementById('optionsUpdateProgressBar');
    var progressText = document.getElementById('optionsUpdateProgressText');
    var resultEl = document.getElementById('optionsUpdateResult');
    if (downloadBtn) { downloadBtn.style.display = 'none'; downloadBtn.disabled = false; }
    if (restartBtn) restartBtn.style.display = 'inline-block';
    if (progressBar) progressBar.style.width = '100%';
    if (progressText) progressText.textContent = 'Download complete.';
    if (resultEl) resultEl.innerHTML = '<span style="color:#80e080;">Update ready. Click <strong>Restart to install</strong> to close the app and install the new version.</span>';
    if (typeof showToast === 'function') showToast('Update ready. Click Restart to install in Options → About.', 'success');
}
function optionsUpdateUI_onError(message) {
    var downloadBtn = document.getElementById('optionsDownloadUpdateBtn');
    var progressWrap = document.getElementById('optionsUpdateProgressWrap');
    var resultEl = document.getElementById('optionsUpdateResult');
    if (downloadBtn) { downloadBtn.style.display = 'inline-block'; downloadBtn.disabled = false; }
    if (progressWrap) progressWrap.style.display = 'none';
    if (resultEl) resultEl.innerHTML = '<span style="color:#f08080;">' + (message || 'Update error') + '</span>';
}
function optionsApplyTheme(val) {
    localStorage.setItem('npcgen_theme', val);
    if (localStorage.getItem('npcgen_theme') === 'light') {
        document.body.classList.add('light-mode');
    } else {
        document.body.classList.remove('light-mode');
    }
    optionsSyncThemeCardStyle(val);
}
function optionsSyncThemeCardStyle(theme) {
    var darkCard = document.getElementById('optThemeCardDark');
    var lightCard = document.getElementById('optThemeCardLight');
    var t = theme || (document.body.classList.contains('light-mode') ? 'light' : 'dark');
    if (darkCard) {
        darkCard.style.borderColor = t === 'dark' ? 'rgba(160,100,255,0.65)' : 'rgba(255,255,255,0.12)';
        darkCard.style.background = t === 'dark' ? 'linear-gradient(145deg,rgba(35,28,55,0.98),rgba(50,40,75,0.98))' : 'linear-gradient(145deg,rgba(25,22,40,0.95),rgba(35,30,55,0.95))';
    }
    if (lightCard) {
        lightCard.style.borderColor = t === 'light' ? 'rgba(218,165,32,0.6)' : 'rgba(255,255,255,0.15)';
        lightCard.style.background = t === 'light' ? 'linear-gradient(145deg,rgba(55,50,75,0.98),rgba(70,62,95,0.98))' : 'linear-gradient(145deg,rgba(45,42,60,0.9),rgba(55,50,75,0.9))';
    }
}
function optionsRefreshOllamaStatusInModal() {
    var el = document.getElementById('optionsOllamaStatusText');
    if (!el) return;
    if (!window.desktopApp || typeof window.desktopApp.getOllamaStatus !== 'function') {
        el.textContent = 'Desktop app only.';
        return;
    }
    window.desktopApp.getOllamaStatus().then(function(s) {
        if (s.connected) el.textContent = 'Connected. Endpoint: http://127.0.0.1:11434' + (s.path ? ' \u2022 Ollama: ' + s.path : '');
        else el.textContent = (s.path ? 'Ollama found at: ' + s.path + ' but not running. Start it (e.g. run "ollama serve").' : 'Ollama not detected. Install it below or download from ollama.com.');
    }).catch(function() { el.textContent = 'Could not check Ollama.'; });
}
function optionsRunOllamaInstall() {
    if (!window.desktopApp || typeof window.desktopApp.runOllamaSetup !== 'function') return;
    window.desktopApp.runOllamaSetup().then(function(r) {
        if (r && r.ok) { if (typeof showToast === 'function') showToast('Ollama installer opened.', 'success'); optionsRefreshOllamaStatusInModal(); }
        else if (r && r.error && typeof showToast === 'function') showToast(r.error, 'warning');
    });
}
function optionsOpenOllamaDownload() {
    if (window.desktopApp && typeof window.desktopApp.openOllamaDownload === 'function') {
        window.desktopApp.openOllamaDownload().then(function() { if (typeof showToast === 'function') showToast('Opened Ollama download page.', 'success'); });
    } else if (typeof window.open === 'function') { window.open('https://ollama.com/download', '_blank', 'noopener,noreferrer'); }
}
function openAISetupWizard() {
    var modal = document.getElementById('aiSetupWizardModal');
    if (!modal) return;
    modal.style.display = 'flex';
    document.getElementById('aiSetupStep1Status').textContent = 'Run the installer to add Ollama to your PC.';
    document.getElementById('aiSetupStep2Status').textContent = 'Download the AI model (~4 GB). This runs in the app — no command prompt.';
    var wrap = document.getElementById('aiSetupProgressWrap');
    if (wrap) wrap.style.display = 'none';
    var bar = document.getElementById('aiSetupProgressBar');
    if (bar) bar.style.width = '0%';
    var txt = document.getElementById('aiSetupProgressText');
    if (txt) txt.textContent = '';
    var btn = document.getElementById('aiSetupPullLlamaBtn');
    if (btn) { btn.disabled = false; btn.textContent = 'Download llama2'; }
}
function closeAISetupWizard() {
    var modal = document.getElementById('aiSetupWizardModal');
    if (modal) modal.style.display = 'none';
    if (typeof optionsRefreshOllamaStatusInModal === 'function') optionsRefreshOllamaStatusInModal();
}
function aiSetupRunOllamaInstaller() {
    if (!window.desktopApp || typeof window.desktopApp.runOllamaSetup !== 'function') return;
    var status = document.getElementById('aiSetupStep1Status');
    if (status) status.textContent = 'Opening Ollama installer…';
    window.desktopApp.runOllamaSetup().then(function(r) {
        if (r && r.ok) { if (status) status.textContent = 'Installer opened. Complete the setup, then use Step 2 to download llama2.'; if (typeof showToast === 'function') showToast('Ollama installer opened.', 'success'); }
        else if (r && r.error) { if (status) status.textContent = r.error; if (typeof showToast === 'function') showToast(r.error, 'warning'); }
    });
}
var _aiSetupProgressUnsubscribe = null;
function aiSetupPullLlama2() {
    if (!window.desktopApp || typeof window.desktopApp.pullOllamaModelWithProgress !== 'function') {
        if (window.desktopApp && typeof window.desktopApp.pullOllamaModel === 'function') {
            window.desktopApp.pullOllamaModel('llama2').then(function(r) { if (r && r.message && typeof showToast === 'function') showToast(r.message, 'info'); });
        }
        return;
    }
    var btn = document.getElementById('aiSetupPullLlamaBtn');
    var wrap = document.getElementById('aiSetupProgressWrap');
    var bar = document.getElementById('aiSetupProgressBar');
    var txt = document.getElementById('aiSetupProgressText');
    var status = document.getElementById('aiSetupStep2Status');
    if (btn) { btn.disabled = true; btn.textContent = 'Downloading…'; }
    if (wrap) wrap.style.display = 'block';
    if (bar) bar.style.width = '0%';
    if (txt) txt.textContent = 'Starting…';
    if (_aiSetupProgressUnsubscribe) { _aiSetupProgressUnsubscribe(); _aiSetupProgressUnsubscribe = null; }
    _aiSetupProgressUnsubscribe = window.desktopApp.onOllamaPullProgress(function(data) {
        if (data.done && data.status === 'error') { if (txt) txt.textContent = 'Error'; if (btn) { btn.disabled = false; btn.textContent = 'Download llama2'; } return; }
        if (data.percent != null && bar) bar.style.width = data.percent + '%';
        if (data.status && txt) txt.textContent = data.status;
        if (data.done && data.status === 'success') {
            if (bar) bar.style.width = '100%';
            if (txt) txt.textContent = 'Done.';
            if (btn) { btn.disabled = false; btn.textContent = 'Download llama2'; }
            if (status) status.textContent = 'llama2 is ready. You can use DM Assistant now.';
            if (typeof showToast === 'function') showToast('llama2 is ready.', 'success');
            if (_aiSetupProgressUnsubscribe) { _aiSetupProgressUnsubscribe(); _aiSetupProgressUnsubscribe = null; }
        }
    });
    window.desktopApp.pullOllamaModelWithProgress('llama2').then(function(r) {
        if (!r.ok && btn) { btn.disabled = false; btn.textContent = 'Download llama2'; if (status) status.textContent = r.error || 'Download failed.'; if (typeof showToast === 'function') showToast(r.error || 'Download failed', 'warning'); }
        if (r.ok && bar) bar.style.width = '100%';
    });
}
function optionsSaveAISettings() {
    var urlEl = document.getElementById('optionsAIUrl');
    var modelEl = document.getElementById('optionsAIModel');
    var enabledEl = document.getElementById('optionsStoryAIEnabled');
    var fasterEl = document.getElementById('optionsAIFaster');
    if (urlEl) localStorage.setItem('dm_story_ai_url', (urlEl.value || '').trim() || 'http://127.0.0.1:11434');
    if (modelEl) localStorage.setItem('dm_story_ai_model', (modelEl.value || '').trim() || 'llama2');
    if (enabledEl) localStorage.setItem('dm_story_ai_enabled', enabledEl.checked ? '1' : '0');
    if (fasterEl) localStorage.setItem('dm_ai_faster', fasterEl.checked ? '1' : '0');
    if (typeof swLoadStoryAISettings === 'function') swLoadStoryAISettings();
}
function optionsTestAI() {
    var resultEl = document.getElementById('optionsAITestResult');
    if (resultEl) resultEl.textContent = 'Testing…';
    optionsSaveAISettings();
    var baseUrl = (localStorage.getItem('dm_story_ai_url') || 'http://127.0.0.1:11434').trim().replace(/\/+$/, '');
    var model = (localStorage.getItem('dm_story_ai_model') || 'llama2').trim() || 'llama2';
    if (window.desktopApp && typeof window.desktopApp.ollamaGenerate === 'function') {
        window.desktopApp.ollamaGenerate({ baseUrl: baseUrl, model: model, prompt: 'Reply OK' })
            .then(function(result) {
                if (resultEl) resultEl.innerHTML = (result && result.ok) ? '<span style="color:#80e080;">\u2713 AI is working.</span>' : '<span style="color:#f08080;">' + (result && result.error ? result.error : 'Connection failed') + '</span>';
            })
            .catch(function(err) {
                if (resultEl) resultEl.innerHTML = '<span style="color:#f08080;">' + (err && err.message ? err.message : 'Connection failed') + '</span>';
            });
        return;
    }
    fetch(baseUrl + '/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: model, prompt: 'Reply OK', stream: false }) }).then(function(r) {
        if (!r.ok) throw new Error('Status ' + r.status);
        return r.json();
    }).then(function(data) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#80e080;">\u2713 AI is working.</span>';
    }).catch(function(err) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f08080;">' + (err && err.message ? err.message : 'Connection failed') + '</span>';
    });
}

function dmAIChatCheckModel(cb) {
    var baseUrl = (localStorage.getItem('dm_story_ai_url') || 'http://127.0.0.1:11434').trim().replace(/\/+$/, '');
    var model = (localStorage.getItem('dm_story_ai_model') || 'llama2').trim() || 'llama2';
    setDMAIChatStatus('Checking for AI model…');
    function handleTags(data) {
        var models = (data && data.models) || [];
        var hasModel = models.some(function(m) {
            var n = (m && m.name) ? m.name : '';
            return n === model || n.indexOf(model + ':') === 0 || n.indexOf(model + ' ') === 0;
        });
        if (hasModel) {
            setDMAIChatStatus('Ready – type below and press Enter or Send.');
            if (typeof cb === 'function') cb({ hasModel: true, model: model });
        } else {
            setDMAIChatStatus('Model "' + model + '" not found. Download it below or use Options → AI.');
            var welcome = document.getElementById('dmAIChatWelcome');
            if (welcome) welcome.style.display = 'none';
            var wrap = document.getElementById('dmAIChatMessages');
            var alreadyHas = wrap && wrap.querySelector('button[data-dm-ai-download]');
            if (wrap && !alreadyHas) {
                var msg = document.createElement('div');
                msg.style.cssText = 'margin-bottom:12px;padding:10px 12px;border-radius:8px;background:rgba(0,0,0,0.25);border-left:3px solid rgba(46,204,113,0.6);color:rgba(255,255,255,0.9);';
                msg.innerHTML = '<strong>DM Assistant:</strong> The model "' + model + '" is not installed. Click the button below to download it (a terminal will open). When the download finishes, send a message to start chatting.';
                wrap.appendChild(msg);
                appendDMAIChatDownloadButton(model);
            }
            if (typeof cb === 'function') cb({ hasModel: false, model: model });
        }
    }
    if (window.desktopApp && typeof window.desktopApp.ollamaTags === 'function') {
        window.desktopApp.ollamaTags(baseUrl).then(function(r) {
            if (r && r.ok && r.data) handleTags(r.data);
            else {
                setDMAIChatStatus('Could not reach Ollama. Start Ollama or install from Options → AI.');
                if (typeof cb === 'function') cb({ hasModel: false, error: true });
            }
        }).catch(function() {
            setDMAIChatStatus('Could not reach Ollama. Start Ollama or install from Options → AI.');
            if (typeof cb === 'function') cb({ hasModel: false, error: true });
        });
        return;
    }
    fetch(baseUrl + '/api/tags', { method: 'GET', signal: AbortSignal.timeout(5000) })
        .then(function(r) { return r.ok ? r.json() : Promise.reject(new Error('Ollama not responding')); })
        .then(handleTags)
        .catch(function() {
            setDMAIChatStatus('Could not reach Ollama. Start Ollama or install it from Options → AI.');
            if (typeof cb === 'function') cb({ hasModel: false, error: true });
        });
}
function toggleDMAIChatPopout() {
    var el = document.getElementById('dmAIPopout');
    if (!el) return;
    var isOpen = el.classList.contains('dm-ai-open');
    if (isOpen) {
        el.classList.remove('dm-ai-open');
        el.classList.add('dm-ai-collapsed');
    } else {
        el.classList.remove('dm-ai-collapsed');
        el.classList.add('dm-ai-open');
        var inp = document.getElementById('dmAIChatInput');
        if (inp) inp.focus();
        setDMAIChatStatus('');
        if (window.desktopApp && typeof window.desktopApp.ensureOllamaRunning === 'function') {
            window.desktopApp.ensureOllamaRunning().then(function(r) { if (r && !r.ok) setDMAIChatStatus('Starting Ollama…'); dmAIChatCheckModel(); });
        } else { dmAIChatCheckModel(); }
    }
}
function openDMAIChat() {
    var popout = document.getElementById('dmAIPopout');
    if (popout) {
        popout.style.display = 'flex';
        popout.style.visibility = 'visible';
        popout.classList.remove('dm-ai-collapsed');
        popout.classList.add('dm-ai-open');
    }
    var inp = document.getElementById('dmAIChatInput');
    if (inp) {
        inp.focus();
        setTimeout(function() { if (inp) inp.focus(); }, 100);
    }
    setDMAIChatStatus('Checking…');
    if (window.desktopApp && typeof window.desktopApp.ensureOllamaRunning === 'function') {
        window.desktopApp.ensureOllamaRunning().then(function(r) {
            if (r && !r.ok) setDMAIChatStatus('Starting Ollama…');
            dmAIChatCheckModel();
        });
    } else {
        dmAIChatCheckModel();
    }
}
function closeDMAIChat() {
    var popout = document.getElementById('dmAIPopout');
    if (!popout) return;
    popout.classList.remove('dm-ai-open');
    popout.classList.add('dm-ai-collapsed');
    popout.style.display = 'none';
    popout.style.visibility = 'hidden';
}
(function dmAIPopoutResizeAndShortcut() {
    var popout = document.getElementById('dmAIPopout');
    var handle = document.getElementById('dmAIResizeHandle');
    var DM_AI_WIDTH_KEY = 'dm_ai_popout_width';
    var DM_AI_HEIGHT_KEY = 'dm_ai_popout_height';
    function applySize(w, h) {
        if (!popout) return;
        w = Math.min(520, Math.max(280, w));
        h = Math.min(window.innerHeight * 0.85, Math.max(280, h));
        popout.style.setProperty('--dm-ai-width', w + 'px');
        popout.style.setProperty('--dm-ai-height', h + 'px');
        try { localStorage.setItem(DM_AI_WIDTH_KEY, String(w)); localStorage.setItem(DM_AI_HEIGHT_KEY, String(h)); } catch(e) {}
    }
    function loadSavedSize() {
        try {
            var w = parseInt(localStorage.getItem(DM_AI_WIDTH_KEY), 10);
            var h = parseInt(localStorage.getItem(DM_AI_HEIGHT_KEY), 10);
            if (Number.isFinite(w) && Number.isFinite(h) && popout) applySize(w, h);
        } catch(e) {}
    }
    if (popout) loadSavedSize();
    if (handle && popout) {
        handle.addEventListener('mousedown', function(e) {
            e.preventDefault();
            var startX = e.clientX, startY = e.clientY;
            var rect = popout.getBoundingClientRect();
            var startW = rect.width, startH = rect.height;
            function onMove(ev) {
                var dw = ev.clientX - startX, dh = startY - ev.clientY;
                applySize(startW + dw, startH + dh);
            }
            function onUp() {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            }
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });
    }
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'D' || e.key === 'd')) {
            e.preventDefault();
            var el = document.getElementById('dmAIPopout');
            if (el && el.classList.contains('dm-ai-open')) closeDMAIChat();
            else openDMAIChat();
        }
    });
})();
/** Simulated AI loading progress (no real % from API). Call stop() when request finishes. */
function startAILoadingProgress(opts) {
    opts = opts || {};
    var label = opts.label || 'Thinking…';
    var updateStatus = opts.updateStatus || function() {};
    var updateBar = opts.updateBar || function() {};
    var intervalMs = opts.intervalMs || 380;
    var cap = typeof opts.cap === 'number' ? opts.cap : 90;
    var p = typeof opts.start === 'number' ? opts.start : 5;
    var tick = 0;
    updateStatus(p, label);
    updateBar(p);
    var iv = setInterval(function() {
        tick++;
        p = Math.min(cap, p + (cap - p) * 0.14 + 2);
        p = Math.min(cap, Math.round(p));
        updateStatus(p, label);
        updateBar(p);
    }, intervalMs);
    return function stop(completed) {
        clearInterval(iv);
        p = completed !== false ? 100 : p;
        updateStatus(p, completed !== false ? 'Done' : label);
        updateBar(p);
        if (opts.onStopped) opts.onStopped(completed);
    };
}
function setDMAIChatProgressBar(percent, visible) {
    var wrap = document.getElementById('dmAIChatProgressBar');
    var fill = document.getElementById('dmAIChatProgressFill');
    if (wrap) wrap.style.display = visible ? 'block' : 'none';
    if (fill) fill.style.width = (visible ? Math.min(100, Math.max(0, percent)) : 0) + '%';
}
function setDMAIChatStatus(txt) {
    var el = document.getElementById('dmAIChatStatus');
    if (el) el.textContent = txt;
}
function appendDMAIChatMessage(role, text) {
    var wrap = document.getElementById('dmAIChatMessages');
    var welcome = document.getElementById('dmAIChatWelcome');
    if (welcome) welcome.style.display = 'none';
    if (!wrap) return;
    var isUser = role === 'user';
    var div = document.createElement('div');
    div.style.cssText = 'margin-bottom:12px;padding:10px 12px;border-radius:8px;' + (isUser ? 'background:rgba(80,40,140,0.35);border-left:3px solid rgba(160,100,255,0.8);color:#e0c0ff;' : 'background:rgba(0,0,0,0.25);border-left:3px solid rgba(46,204,113,0.6);color:rgba(255,255,255,0.9);');
    div.innerHTML = (isUser ? '<strong>You:</strong> ' : '<strong>DM Assistant:</strong> ') + String(text).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    wrap.appendChild(div);
    wrap.scrollTop = wrap.scrollHeight;
}
function appendDMAIChatDownloadButton(modelName) {
    var wrap = document.getElementById('dmAIChatMessages');
    if (!wrap || !window.desktopApp || typeof window.desktopApp.pullOllamaModel !== 'function') return;
    var model = (modelName && String(modelName).trim()) || 'llama2';
    var div = document.createElement('div');
    div.style.cssText = 'margin-bottom:12px;padding:10px 12px;border-radius:8px;background:rgba(46,204,113,0.15);border-left:3px solid rgba(46,204,113,0.6);color:rgba(255,255,255,0.95);';
    var btn = document.createElement('button');
    btn.setAttribute('data-dm-ai-download', '1');
    btn.textContent = 'Download model (' + model + ') now – opens a terminal';
    btn.style.cssText = 'margin-top:8px;padding:8px 14px;background:rgba(46,204,113,0.35);border:1px solid rgba(46,204,113,0.6);color:#a0e8a0;border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.8em;font-weight:700;';
    btn.onclick = function() {
        btn.disabled = true;
        btn.textContent = 'Opening terminal…';
        window.desktopApp.pullOllamaModel(model).then(function(r) {
            if (r && r.ok && typeof showToast === 'function') showToast(r.message || 'Terminal opened. Wait for download to finish.', 'success');
            else if (r && r.error && typeof showToast === 'function') showToast(r.error, 'warning');
            btn.disabled = false;
            btn.textContent = 'Download model (' + model + ') now – opens a terminal';
        });
    };
    div.appendChild(document.createTextNode('You can download the AI model from inside the app:'));
    div.appendChild(document.createElement('br'));
    div.appendChild(btn);
    wrap.appendChild(div);
    wrap.scrollTop = wrap.scrollHeight;
}

function getDMAIChatContext() {
    var parts = [];
    function safeStr(v, maxLen) { try { var s = v == null ? '' : String(v).trim(); return maxLen ? s.slice(0, maxLen) + (s.length > maxLen ? '...' : '') : s; } catch (e) { return ''; } }
    try {
        var notesEl = document.getElementById('sessionNotesArea');
        var notes = (notesEl && notesEl.value) ? notesEl.value : (localStorage.getItem('npcgen_session_notes') || '');
        if (notes && safeStr(notes)) parts.push('SESSION NOTES (DM\'s current notes):\n' + safeStr(notes, 900) + (notes.length > 900 ? '\n[...]' : ''));
    } catch (e1) {}
    try {
        var story = window._swCurrentStory;
        if (story && (story.title || story.goal)) {
            var storyLine = 'ACTIVE STORY: "' + safeStr(story.title || 'Untitled') + '"' + (story.goal ? ' | Goal: ' + safeStr(story.goal, 80) : '') + (story.antagonist ? ' | Antagonist: ' + safeStr(story.antagonist, 60) : '') + (story.genre ? ' | Genre: ' + safeStr(story.genre) : '');
            if (story.chapters && story.chapters.length) storyLine += ' | Chapters: ' + story.chapters.length;
            parts.push(storyLine);
        }
    } catch (e2) {}
    try {
        var aq = (typeof _activeQuest !== 'undefined' && _activeQuest) ? _activeQuest : null;
        if (aq && (aq.title || aq.html)) parts.push('ACTIVE QUEST: ' + safeStr(aq.title || 'Active quest') + (aq.type ? ' (' + safeStr(aq.type) + ')' : ''));
    } catch (e3) {}
    try {
        var ab = window._activeBounty;
        if (ab && (ab.name || ab.id)) parts.push('ACTIVE BOUNTY: ' + safeStr(ab.name || 'Bounty') + (ab.cr != null ? ' CR ' + ab.cr : ''));
    } catch (e4) {}
    try {
        var ar = (typeof _activeRevenge !== 'undefined' && _activeRevenge) ? _activeRevenge : null;
        if (ar && (ar.title || ar.id)) {
            var revLine = 'ACTIVE REVENGE QUEST: ' + safeStr(ar.title || 'Revenge');
            if (ar.revengeKilledEntry && (ar.revengeKilledEntry.npcName || ar.revengeKilledEntry.killedBy)) revLine += ' | Fallen: ' + safeStr(ar.revengeKilledEntry.npcName) + ' (killed by ' + safeStr(ar.revengeKilledEntry.killedBy) + ')';
            parts.push(revLine);
        }
    } catch (e5) {}
    try {
        var loc = window._swLastLoc;
        if (loc && (loc.name || loc.title || loc.type)) parts.push('ACTIVE LOCATION: ' + safeStr(loc.name || loc.title || 'Location') + (loc.type ? ' (' + safeStr(loc.type).replace(/_/g, ' ') + ')' : ''));
    } catch (e6) {}
    try {
        var npcs = (typeof generatedNPCs !== 'undefined' && Array.isArray(generatedNPCs)) ? generatedNPCs : [];
        if (npcs.length) parts.push('NPCs ON SCREEN (' + npcs.length + '): ' + npcs.slice(0, 10).map(function(n){ return safeStr(n.name || n.id); }).filter(Boolean).join(', ') + (npcs.length > 10 ? ' ...' : ''));
    } catch (e7) {}
    try {
        var killed = (typeof _killedNPCsLog !== 'undefined' && Array.isArray(_killedNPCsLog)) ? _killedNPCsLog : [];
        if (killed.length) parts.push('FALLEN NPCs: ' + killed.slice(0, 8).map(function(e){ return (safeStr(e.npcName) || '?') + ' by ' + (safeStr(e.killedBy) || '?'); }).join('; '));
    } catch (e8) {}
    try {
        var party = (typeof _party !== 'undefined' && Array.isArray(_party)) ? _party : [];
        if (party.length) parts.push('PLAYERS: ' + party.map(function(p){ return safeStr(p.name || p.id); }).filter(Boolean).join(', '));
    } catch (e9) {}
    return parts.length ? '\n\n=== CURRENT APP STATE (use this to tailor suggestions and remind the DM) ===\n' + parts.join('\n') + '\n=== END APP STATE ===\n' : '';
}

function getDMAIChatSystemPrompt() {
    var base = [
        'DM Assistant for D&D 5e. Live play: give SHORT, table-ready answers. Lead with the answer.',
        'Rules: checks, saves, combat (actions/bonus/reaction), conditions, spellcasting (V/S/M, concentration), rests, death saves, exhaustion, surprise, cover, advantage. DCs: Easy 5, Med 10, Hard 15, VHard 20, Near 25. Name ability and skill (e.g. Wisdom (Insight)). One clear ruling + brief "rule of cool" if useful.',
        'App state below: use story/quest/location/NPC names for 1–2 concrete suggestions (next beat, complication, revenge hook). Keep replies brief so the DM can scan while players wait.'
    ].join('\n');
    return base + getDMAIChatContext();
}

function dmAIChatRunAction(actionId, params) {
    params = params || {};
    var raceSel = document.getElementById('raceSel');
    var classSel = document.getElementById('classSel');
    var lvlSel = document.getElementById('lvlSel');
    var qtyInput = document.getElementById('qtyInput');
    var bossMode = document.getElementById('bossMode');
    function setSel(el, val) { if (el && val != null && val !== '') { el.value = val; } }
    if (actionId === 'gen_npc' || actionId === 'open_npc') {
        if (typeof switchMode === 'function') switchMode('npc');
        if (actionId === 'gen_npc') {
            if (params.level != null) setSel(lvlSel, params.level);
            if (params.race != null) setSel(raceSel, params.race);
            if (params['class'] != null) setSel(classSel, params['class']);
            if (params.qty != null && qtyInput) qtyInput.value = Math.min(10, Math.max(1, parseInt(params.qty, 10) || 1));
            if (params.boss !== undefined && bossMode) bossMode.checked = !!params.boss;
            if (typeof generateBatch === 'function') generateBatch();
            setTimeout(function() {
                var d = document.getElementById('genModeDialog');
                if (d && d.classList.contains('active') && typeof confirmGenerate === 'function') confirmGenerate(false);
            }, 50);
        }
        return;
    }
    if (actionId === 'open_quest') {
        if (typeof switchMode === 'function') switchMode('quest');
        if (typeof swSwitchTab === 'function') swSwitchTab('quest');
        return;
    }
    if (actionId === 'gen_quest') {
        if (typeof switchMode === 'function') switchMode('quest');
        if (typeof swSwitchTab === 'function') swSwitchTab('quest');
        if (typeof generateQuest === 'function') generateQuest(false);
        return;
    }
    if (actionId === 'gen_quest_boss') {
        if (typeof switchMode === 'function') switchMode('quest');
        if (typeof swSwitchTab === 'function') swSwitchTab('quest');
        if (typeof generateQuest === 'function') generateQuest(true);
        return;
    }
    if (actionId === 'gen_story') {
        if (typeof switchMode === 'function') switchMode('quest');
        if (typeof swSwitchTab === 'function') swSwitchTab('story');
        if (typeof swGenerateStory === 'function') swGenerateStory();
        return;
    }
    if (actionId === 'gen_location') {
        if (typeof switchMode === 'function') switchMode('quest');
        if (typeof swSwitchTab === 'function') swSwitchTab('location');
        if (typeof swGenerateLocation === 'function') swGenerateLocation();
        return;
    }
    if (actionId === 'open_party') {
        if (typeof openPartyModal === 'function') openPartyModal();
        return;
    }
    if (actionId === 'open_live_tools') {
        if (typeof openLiveDMTools === 'function') openLiveDMTools();
        return;
    }
    if (actionId === 'gen_map') {
        if (typeof switchMode === 'function') switchMode('quest');
        if (typeof generateQuestBattleMap === 'function') generateQuestBattleMap();
        return;
    }
}

function dmAIChatParseAndRunCommands(reply) {
    var raw = (reply != null && typeof reply === 'string') ? reply : String(reply || '');
    var lines = raw.split(/\r?\n/);
    var seen = {};
    lines.forEach(function(line) {
        var m = line.match(/^\s*\[(GEN_NPC|OPEN_NPC|GEN_QUEST|GEN_QUEST_BOSS|OPEN_QUEST|GEN_STORY|GEN_LOCATION|OPEN_PARTY|OPEN_LIVE_TOOLS|GEN_MAP)\s*([^\]]*)\]\s*$/i);
        if (!m) return;
        var cmd = m[1].toUpperCase();
        var rest = (m[2] || '').trim();
        var key = cmd + '|' + rest;
        if (seen[key]) return;
        seen[key] = true;
        var params = {};
        rest.replace(/(\w+)=([^\s,]+)/g, function(_, k, v) { params[k.toLowerCase()] = v; return ''; });
        if (cmd === 'GEN_NPC') dmAIChatRunAction('gen_npc', params);
        else if (cmd === 'OPEN_NPC') dmAIChatRunAction('open_npc');
        else if (cmd === 'GEN_QUEST_BOSS') dmAIChatRunAction('gen_quest_boss');
        else if (cmd === 'GEN_QUEST') dmAIChatRunAction('gen_quest');
        else if (cmd === 'OPEN_QUEST') dmAIChatRunAction('open_quest');
        else if (cmd === 'GEN_STORY') dmAIChatRunAction('gen_story');
        else if (cmd === 'GEN_LOCATION') dmAIChatRunAction('gen_location');
        else if (cmd === 'OPEN_PARTY') dmAIChatRunAction('open_party');
        else if (cmd === 'OPEN_LIVE_TOOLS') dmAIChatRunAction('open_live_tools');
        else if (cmd === 'GEN_MAP') dmAIChatRunAction('gen_map');
    });
}

function dmAIOracle(kind) {
    var inp = document.getElementById('dmAIChatInput');
    if (!inp) return;
    var prompts = {
        yesno: 'For the current situation in play, answer only Yes or No. If you need a modifier (e.g. "Yes, but…"), add it in parentheses. One short line.',
        complication: 'Suggest one short complication for the current scene (one sentence, table-ready).',
        name: 'Generate one random fantasy name (person or place). Only the name, nothing else.'
    };
    var text = prompts[kind] || prompts.yesno;
    inp.value = text;
    sendDMAIChatMessage();
}

function sendDMAIChatMessage() {
    var inp = document.getElementById('dmAIChatInput');
    var btn = document.getElementById('dmAIChatSendBtn');
    if (!inp) return;
    var text = (inp.value || '').trim();
    if (!text) return;
    var baseUrl = (localStorage.getItem('dm_story_ai_url') || 'http://127.0.0.1:11434').trim().replace(/\/+$/, '');
    var model = (localStorage.getItem('dm_story_ai_model') || 'llama2').trim() || 'llama2';
    var systemPrompt = (typeof getDMAIChatSystemPrompt === 'function') ? getDMAIChatSystemPrompt() : '';
    var faster = localStorage.getItem('dm_ai_faster') === '1';
    var ollamaOptions = { num_ctx: 1024, temperature: 0.5 };
    if (faster) { ollamaOptions.num_predict = 200; ollamaOptions.temperature = 0.6; ollamaOptions.num_ctx = 768; } else { ollamaOptions.num_predict = 350; }
    inp.value = '';
    appendDMAIChatMessage('user', text);
    if (btn) btn.disabled = true;

    /* ── Streaming path (Electron desktop) ── */
    if (window.desktopApp && typeof window.desktopApp.ollamaGenerateStream === 'function') {
        setDMAIChatStatus('Thinking…');
        setDMAIChatProgressBar(30, true);
        var wrap = document.getElementById('dmAIChatMessages');
        var welcome = document.getElementById('dmAIChatWelcome');
        if (welcome) welcome.style.display = 'none';
        var streamDiv = document.createElement('div');
        streamDiv.style.cssText = 'margin-bottom:12px;padding:10px 12px;border-radius:8px;background:rgba(0,0,0,0.25);border-left:3px solid rgba(46,204,113,0.6);color:rgba(255,255,255,0.9);';
        streamDiv.innerHTML = '<strong>DM Assistant:</strong> <span class="dm-ai-stream-text" style="opacity:0.5;">…</span>';
        if (wrap) { wrap.appendChild(streamDiv); wrap.scrollTop = wrap.scrollHeight; }
        var streamSpan = streamDiv.querySelector('.dm-ai-stream-text');
        var fullText = '';
        var unsubStream = window.desktopApp.onOllamaStreamChunk(function(data) {
            if (data.token) {
                fullText += data.token;
                if (streamSpan) {
                    streamSpan.style.opacity = '1';
                    streamSpan.textContent = fullText;
                }
                if (wrap) wrap.scrollTop = wrap.scrollHeight;
                setDMAIChatProgressBar(Math.min(90, 30 + Math.round(fullText.length / 4)), true);
            }
            if (data.done) {
                setDMAIChatProgressBar(100, true);
                setTimeout(function() { setDMAIChatProgressBar(0, false); setDMAIChatStatus('Reply from ' + model + '.'); }, 400);
            }
        });
        var desktopPayload = { baseUrl: baseUrl, model: model, prompt: text, system: systemPrompt };
        if (ollamaOptions && Object.keys(ollamaOptions).length) desktopPayload.options = ollamaOptions;
        window.desktopApp.ollamaGenerateStream(desktopPayload)
            .then(function(result) {
                if (unsubStream) { unsubStream(); unsubStream = null; }
                if (result && result.ok) {
                    var raw = fullText.trim() || (result.response || '').trim();
                    dmAIChatParseAndRunCommands(raw);
                    var displayReply = raw.replace(/\s*\[(GEN_NPC|OPEN_NPC|GEN_QUEST|GEN_QUEST_BOSS|OPEN_QUEST|GEN_STORY|GEN_LOCATION|OPEN_PARTY|OPEN_LIVE_TOOLS|GEN_MAP)\s*[^\]]*\]\s*(\r?\n)?/gi, '').trim();
                    if (streamSpan) streamSpan.textContent = displayReply || raw || '(No reply)';
                } else {
                    var errMsg = (result && result.error) || 'AI request failed';
                    if (streamSpan) { streamSpan.style.color = '#ff8080'; streamSpan.textContent = errMsg; }
                    appendDMAIChatDownloadButton(model);
                }
            })
            .catch(function(err) {
                if (unsubStream) { unsubStream(); unsubStream = null; }
                var msg = (err && err.message) ? err.message : String(err);
                if (streamSpan) { streamSpan.style.color = '#ff8080'; streamSpan.textContent = 'Error: ' + msg; }
            })
            .finally(function() {
                if (unsubStream) { unsubStream(); unsubStream = null; }
                if (btn) btn.disabled = false;
                setDMAIChatProgressBar(0, false);
            });
        return;
    }

    /* ── Non-streaming fallback (browser / no desktopApp) ── */
    var stopProgress = startAILoadingProgress({
        label: 'Thinking…',
        updateStatus: function(p, lbl) { setDMAIChatStatus(lbl + ' ' + p + '%'); },
        updateBar: function(p) { setDMAIChatProgressBar(p, true); }
    });

    function onSuccess(reply) {
        stopProgress(true);
        setTimeout(function() {
            setDMAIChatProgressBar(0, false);
            setDMAIChatStatus('Reply from ' + model + '.');
        }, 480);
        var raw = (reply != null && typeof reply === 'string') ? reply : String(reply || '').trim();
        dmAIChatParseAndRunCommands(raw);
        var displayReply = raw.replace(/\s*\[(GEN_NPC|OPEN_NPC|GEN_QUEST|GEN_QUEST_BOSS|OPEN_QUEST|GEN_STORY|GEN_LOCATION|OPEN_PARTY|OPEN_LIVE_TOOLS|GEN_MAP)\s*[^\]]*\]\s*(\r?\n)?/gi, '').trim();
        if (!displayReply) displayReply = raw || '(No reply — try again or check Options → AI.)';
        appendDMAIChatMessage('assistant', displayReply);
    }
    function onError(msg) {
        stopProgress(false);
        var isTimeout = /timed out|aborted/i.test(String(msg));
        setTimeout(function() {
            setDMAIChatProgressBar(0, false);
            setDMAIChatStatus(isTimeout ? 'Timed out.' : 'Error – check Ollama is running.');
        }, 480);
        var text = (msg && String(msg).trim()) || 'AI request failed';
        var display = isTimeout ? text : ('Could not reach AI: ' + text + '. Make sure Ollama is running (ollama serve) and you have a model (e.g. ollama pull llama2).');
        appendDMAIChatMessage('assistant', display);
        if (!isTimeout) appendDMAIChatDownloadButton(model);
    }

    if (window.desktopApp && typeof window.desktopApp.ollamaGenerate === 'function') {
        var desktopPayload = { baseUrl: baseUrl, model: model, prompt: text, system: systemPrompt };
        if (ollamaOptions && Object.keys(ollamaOptions).length) desktopPayload.options = ollamaOptions;
        window.desktopApp.ollamaGenerate(desktopPayload)
            .then(function(result) {
                if (result && result.ok) {
                    var reply = (result.response != null) ? String(result.response).trim() : ((result.message && result.message.content) ? String(result.message.content).trim() : '');
                    onSuccess(reply);
                } else {
                    onError((result && result.error) ? result.error : 'AI request failed');
                }
            })
            .catch(function(err) {
                onError((err && err.message) ? err.message : String(err));
            })
            .finally(function() {
                if (btn) btn.disabled = false;
            });
        return;
    }

    var body = { model: model, system: systemPrompt, prompt: text, stream: false };
    if (ollamaOptions && Object.keys(ollamaOptions).length) body.options = ollamaOptions;
    fetch(baseUrl + '/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    }).then(function(r) {
        if (!r.ok) throw new Error('AI returned ' + r.status);
        return r.json();
    }).then(function(data) {
        var reply = (data && data.response != null) ? String(data.response).trim() : ((data && data.message && data.message.content != null) ? String(data.message.content).trim() : '');
        onSuccess(reply);
    }).catch(function(err) {
        var msg = (err && err.message) ? err.message : String(err);
        onError(msg);
    }).finally(function() {
        if (btn) btn.disabled = false;
    });
}

function dmToolSwitch(tab) {
    ['round','encounter','rules','backup'].forEach(function(t) {
        var btn = document.getElementById('dmToolTabBtn_' + t);
        var pnl = document.getElementById('dmToolTab_' + t);
        var on = t === tab;
        if (btn) {
            btn.style.background = on ? 'rgba(218,165,32,0.18)' : 'rgba(255,255,255,0.05)';
            btn.style.borderColor = on ? 'rgba(218,165,32,0.35)' : 'rgba(218,165,32,0.2)';
            btn.style.color = on ? '#fff3c0' : 'rgba(255,255,255,0.75)';
        }
        if (pnl) pnl.style.display = on ? 'block' : 'none';
    });
    if (tab === 'backup' && typeof dmSessionChecklistRender === 'function') dmSessionChecklistRender();
}

function dmRenderRoundTracker() {
    _dmLoadLiveTools();
    var rd = document.getElementById('dmRoundDisplay');
    var td = document.getElementById('dmTurnDisplay');
    var list = document.getElementById('dmTurnOrderList');
    var notes = document.getElementById('dmRoundNotes');
    if (rd) rd.textContent = String(_dmLiveTools.round || 1);
    var current = (_dmLiveTools.order || [])[(_dmLiveTools.turnIndex || 0)] || null;
    if (td) td.textContent = current ? ((current.name || 'Unknown') + (current.init != null ? (' (Init ' + current.init + ')') : '')) : '—';
    if (notes) notes.value = _dmLiveTools.notes || '';
    if (list) {
        var order = _dmLiveTools.order || [];
        if (!order.length) {
            list.innerHTML = '<div style="color:rgba(255,255,255,0.35);font-family:\'Crimson Text\',serif;font-style:italic;padding:10px;">No turn order set yet. Click <strong>Use Initiative Panel</strong> or <strong>Use Party + NPCs</strong>.</div>';
        } else {
            list.innerHTML = order.map(function(e, idx) {
                var active = idx === (_dmLiveTools.turnIndex || 0);
                return ''
                    + '<div onclick="dmSetTurn(' + idx + ')" style="padding:8px 10px;border-radius:10px;border:1px solid ' + (active ? 'rgba(46,204,113,0.55)' : 'rgba(255,255,255,0.12)') + ';background:' + (active ? 'rgba(46,204,113,0.12)' : 'rgba(255,255,255,0.05)') + ';cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px;">'
                    +   '<div style="min-width:0;">'
                    +     '<div style="font-family:\'Cinzel\',serif;font-weight:900;color:' + (active ? '#a0ffc0' : 'rgba(255,255,255,0.85)') + ';font-size:0.82em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (e.name || 'Unknown') + '</div>'
                    +     '<div style="font-family:\'Crimson Text\',serif;color:rgba(255,255,255,0.5);font-size:0.85em;">' + (e.type || '') + '</div>'
                    +   '</div>'
                    +   '<div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">'
                    +     (e.init != null ? '<span style="font-family:\'Cinzel\',serif;font-weight:900;color:#fff3c0;border:1px solid rgba(218,165,32,0.35);background:rgba(218,165,32,0.12);padding:3px 8px;border-radius:10px;font-size:0.75em;">' + e.init + '</span>' : '')
                    +   '</div>'
                    + '</div>';
            }).join('');
        }
    }
}

function dmSetTurn(idx) {
    _dmLoadLiveTools();
    _dmLiveTools.turnIndex = Math.max(0, Math.min((_dmLiveTools.order||[]).length-1, idx));
    _dmSaveLiveTools();
    dmRenderRoundTracker();
}
function dmRoundReset() {
    _dmLoadLiveTools();
    _dmLiveTools.round = 1;
    _dmLiveTools.turnIndex = 0;
    _dmSaveLiveTools();
    dmRenderRoundTracker();
}
function dmRoundAdvance() {
    _dmLoadLiveTools();
    _dmLiveTools.round = (_dmLiveTools.round || 1) + 1;
    _dmSaveLiveTools();
    dmRenderRoundTracker();
}
function dmNextTurn() {
    _dmLoadLiveTools();
    var n = (_dmLiveTools.order || []).length;
    if (!n) return;
    var next = (_dmLiveTools.turnIndex || 0) + 1;
    if (next >= n) {
        _dmLiveTools.turnIndex = 0;
        _dmLiveTools.round = (_dmLiveTools.round || 1) + 1;
    } else {
        _dmLiveTools.turnIndex = next;
    }
    _dmSaveLiveTools();
    dmRenderRoundTracker();
}
function dmPrevTurn() {
    _dmLoadLiveTools();
    var n = (_dmLiveTools.order || []).length;
    if (!n) return;
    var prev = (_dmLiveTools.turnIndex || 0) - 1;
    if (prev < 0) {
        _dmLiveTools.turnIndex = n - 1;
        _dmLiveTools.round = Math.max(1, (_dmLiveTools.round || 1) - 1);
    } else {
        _dmLiveTools.turnIndex = prev;
    }
    _dmSaveLiveTools();
    dmRenderRoundTracker();
}
function dmSaveRoundNotes() {
    _dmLoadLiveTools();
    var notes = document.getElementById('dmRoundNotes');
    _dmLiveTools.notes = notes ? notes.value : (_dmLiveTools.notes || '');
    _dmSaveLiveTools();
    if (typeof showToast === 'function') showToast('Round notes saved', 'success');
}
function dmClearTurnOrder() {
    _dmLoadLiveTools();
    _dmLiveTools.order = [];
    _dmLiveTools.turnIndex = 0;
    _dmSaveLiveTools();
    dmRenderRoundTracker();
}

function dmBuildTurnOrderFromPartyAndNPCs() {
    _dmLoadLiveTools();
    var order = [];
    var party = window._party || [];
    party.forEach(function(p) {
        order.push({ type: 'player', id: p.id, name: p.name || 'Player', init: (p.init != null ? p.init : null) });
    });
    var npcs = window.generatedNPCs || [];
    npcs.forEach(function(n) {
        order.push({ type: 'npc', id: n.id, name: n.name || 'NPC', init: (n.initiative != null ? n.initiative : null) });
    });
    order.sort(function(a,b) {
        var ai = (a.init == null ? -999 : a.init);
        var bi = (b.init == null ? -999 : b.init);
        return bi - ai;
    });
    _dmLiveTools.order = order;
    _dmLiveTools.turnIndex = 0;
    _dmSaveLiveTools();
    dmRenderRoundTracker();
}

function dmBuildTurnOrderFromInitiative() {
    _dmLoadLiveTools();
    var list = document.getElementById('initiativeOrderList');
    if (!list) { if (typeof showToast === 'function') showToast('Initiative panel not found', 'warning'); return; }
    var items = list.querySelectorAll('.initiative-order-entry');
    if (!items || !items.length) { if (typeof showToast === 'function') showToast('No initiative entries found. Add players with "Add Players to Initiative" and enter initiative rolls.', 'warning'); return; }
    var order = [];
    items.forEach(function(it) {
        var nmEl = it.querySelector('.init-name');
        var nm = (nmEl ? nmEl.textContent : it.textContent) || '';
        nm = (nm||'').trim().replace(/^[^\w\s]*\s*/, '');
        var scoreEl = it.querySelector('.init-score');
        var inputEl = it.querySelector('input.player-init-input, input[type="number"]');
        var initTxt = scoreEl ? scoreEl.textContent : (inputEl ? inputEl.value : '');
        var init = parseInt((initTxt||'').replace(/[^0-9\-]/g,''), 10);
        if (!nm) nm = 'Unknown';
        order.push({ type: 'init', id: it.getAttribute('data-player-id') || null, name: nm, init: (isNaN(init) || init < 1 ? null : init) });
    });
    _dmLiveTools.order = order;
    _dmLiveTools.turnIndex = 0;
    _dmSaveLiveTools();
    dmRenderRoundTracker();
}

function dmRenderQuickConditions() {
    var el = document.getElementById('dmQuickConditions');
    if (!el) return;
    var all = (window.DB && DB.conditions && Array.isArray(DB.conditions)) ? DB.conditions : [
        'Blinded','Charmed','Deafened','Exhaustion','Frightened','Grappled','Incapacitated','Invisible','Paralyzed','Petrified','Poisoned','Prone','Restrained','Stunned','Unconscious'
    ];
    el.innerHTML = all.map(function(c) {
        return '<button onclick="dmCopyText(\'' + String(c).replace(/'/g,"\\'") + '\')" style="padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.85);cursor:pointer;font-family:\'Cinzel\',serif;font-weight:900;font-size:0.72em;">' + c + '</button>';
    }).join('');
}
function dmCopyText(txt) {
    try {
        navigator.clipboard.writeText(txt);
        if (typeof showToast === 'function') showToast('Copied: ' + txt, 'success');
    } catch(e) {
        if (typeof showToast === 'function') showToast('Copy failed', 'warning');
    }
}

function dmRenderSkillPrompts() {
    var el = document.getElementById('dmSkillPromptList');
    var out = document.getElementById('dmSkillGuideOutput');
    if (!el || !out) return;
    var skills = [
        { key:'Acrobatics', ability:'DEX', use:'Balance on unstable surfaces, tumble through tight combat spaces, slip binds or grapples.' },
        { key:'Animal Handling', ability:'WIS', use:'Calm mounts/beasts, read animal agitation, direct trained creatures under stress.' },
        { key:'Arcana', ability:'INT', use:'Identify spells, glyphs, magical hazards, planar phenomena, and ritual structures.' },
        { key:'Athletics', ability:'STR', use:'Climb, swim, jump gaps, force doors/chains, hold position against push or drag.' },
        { key:'Deception', ability:'CHA', use:'Lie convincingly, sell false intent, stage distractions, conceal motives.' },
        { key:'History', ability:'INT', use:'Recall lore, dynasties, wars, old treaties, and setting-specific context.' },
        { key:'Insight', ability:'WIS', use:'Read intent, detect pressure points, spot hidden fear, guilt, or manipulation.' },
        { key:'Intimidation', ability:'CHA', use:'Compel compliance through threat, dominance, or strategic pressure.' },
        { key:'Investigation', ability:'INT', use:'Search methodically, connect clue logic, infer mechanisms, identify tampering.' },
        { key:'Medicine', ability:'WIS', use:'Stabilize wounded, assess cause of injury, identify poison/disease symptoms.' },
        { key:'Nature', ability:'INT', use:'Understand terrain, weather, flora/fauna risks, and natural hazard behavior.' },
        { key:'Perception', ability:'WIS', use:'Notice hidden enemies, tracks, movement, sounds, and suspicious details.' },
        { key:'Performance', ability:'CHA', use:'Distract crowds, command attention, influence mood through presence/showmanship.' },
        { key:'Persuasion', ability:'CHA', use:'Negotiate terms, secure cooperation, de-escalate conflict diplomatically.' },
        { key:'Religion', ability:'INT', use:'Interpret doctrine, divine rites, holy symbols, and religious power structures.' },
        { key:'Sleight of Hand', ability:'DEX', use:'Palm objects, pick pockets, conceal item movement without notice.' },
        { key:'Stealth', ability:'DEX', use:'Move quietly, stay unseen, approach positions before initiative begins.' },
        { key:'Survival', ability:'WIS', use:'Track in the wild, navigate hostile terrain, forage, predict route dangers.' }
    ];
    window._dmSkillGuide = skills;
    el.innerHTML = skills.map(function(s) {
        return '<button onclick="dmShowSkillGuide(\'' + s.key.replace(/'/g, "\\'") + '\')" style="padding:6px 9px;border-radius:999px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);color:rgba(235,245,255,0.88);cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:800;">' + s.key + '</button>';
    }).join('');
    dmShowSkillGuide('Perception');
}

function dmShowSkillGuide(skillName) {
    var out = document.getElementById('dmSkillGuideOutput');
    if (!out) return;
    var arr = window._dmSkillGuide || [];
    var s = arr.find(function(x){ return x.key === skillName; });
    if (!s) {
        out.textContent = 'Select a skill to view guidance.';
        return;
    }
    out.innerHTML = '<strong style="font-family:\'Cinzel\',serif;color:#fff3c0;">' + s.key + ' (' + s.ability + ')</strong>'
        + '<div style="margin-top:4px;">Use when: ' + s.use + '</div>';
}

var DM_SESSION_CHECKLIST_ITEMS = [
    { id: 'notes', label: 'Notes ready' },
    { id: 'npcs', label: 'NPCs loaded' },
    { id: 'map', label: 'Map open' },
    { id: 'init', label: 'Initiative set' }
];
function dmSessionChecklistLoad() {
    try {
        var raw = localStorage.getItem('dm_session_checklist');
        return raw ? JSON.parse(raw) : null;
    } catch(e) { return null; }
}
function dmSessionChecklistSave(state) {
    try { localStorage.setItem('dm_session_checklist', JSON.stringify(state)); } catch(e) {}
}
function dmSessionChecklistRender() {
    var container = document.getElementById('dmSessionChecklist');
    if (!container) return;
    var state = dmSessionChecklistLoad();
    if (!state || !Array.isArray(state)) state = DM_SESSION_CHECKLIST_ITEMS.map(function(x) { return { id: x.id, label: x.label, checked: false }; });
    var byId = {};
    state.forEach(function(s) { byId[s.id] = s.checked; });
    container.innerHTML = DM_SESSION_CHECKLIST_ITEMS.map(function(item) {
        var checked = !!byId[item.id];
        return '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:rgba(255,255,255,0.9);"><input type="checkbox" ' + (checked ? 'checked' : '') + ' onchange="dmSessionChecklistToggle(\'' + item.id + '\', this.checked)"> ' + item.label + '</label>';
    }).join('');
}
function dmSessionChecklistToggle(id, checked) {
    var state = dmSessionChecklistLoad();
    if (!state || !Array.isArray(state)) state = DM_SESSION_CHECKLIST_ITEMS.map(function(x) { return { id: x.id, label: x.label, checked: false }; });
    var byId = {};
    state.forEach(function(s) { byId[s.id] = s; });
    if (!byId[id]) byId[id] = { id: id, label: id, checked: false };
    byId[id].checked = !!checked;
    dmSessionChecklistSave(Object.keys(byId).map(function(k) { return byId[k]; }));
}
function dmSessionChecklistReset() {
    dmSessionChecklistSave(DM_SESSION_CHECKLIST_ITEMS.map(function(x) { return { id: x.id, label: x.label, checked: false }; }));
    dmSessionChecklistRender();
    if (typeof showToast === 'function') showToast('Checklist reset', 'success');
}

function dmBackupExport() {
    var out = document.getElementById('dmBackupText');
    if (!out) return;
    var keys = [
        'dm_current_campaign',
        'npcgen_npcs',
        'npcgen_party',
        'npcgen_nemesis',
        'sw_savedStories',
        'sw_savedLocs',
        'sw_savedQuests',
        'sw_savedBounties',
        'dm_quest_npc_log',
        'dm_spell_favorites',
        'dm_changelog'
    ];
    var payload = { version: 1, exportedAt: new Date().toISOString(), data: {} };
    keys.forEach(function(k) {
        var v = null;
        try { v = localStorage.getItem(k); } catch(e) { v = null; }
        if (v != null) payload.data[k] = v;
    });
    out.value = JSON.stringify(payload, null, 2);
    if (typeof showToast === 'function') showToast('Backup exported', 'success');
}

function dmBackupImport() {
    var out = document.getElementById('dmBackupText');
    if (!out) return;
    var txt = out.value || '';
    if (!txt.trim()) { if (typeof showToast === 'function') showToast('Paste backup JSON first', 'warning'); return; }
    var payload;
    try { payload = JSON.parse(txt); } catch(e) { if (typeof showToast === 'function') showToast('Invalid JSON', 'warning'); return; }
    if (!payload || typeof payload !== 'object' || !payload.data) { if (typeof showToast === 'function') showToast('Backup format not recognized', 'warning'); return; }
    if (!confirm('Import this backup? This will overwrite existing local data for included keys.')) return;
    Object.keys(payload.data).forEach(function(k) {
        try { localStorage.setItem(k, payload.data[k]); } catch(e){}
    });
    try {
        if (typeof loadSavedNPCs === 'function') loadSavedNPCs();
    } catch(e) {}
    try {
        if (typeof renderPartyTracker === 'function') renderPartyTracker();
        if (typeof renderHeaderPlayerCards === 'function') renderHeaderPlayerCards();
        if (typeof renderHeaderPartyHealth === 'function') renderHeaderPartyHealth();
    } catch(e) {}
    try {
        if (typeof swRenderSavedStories === 'function') swRenderSavedStories();
        if (typeof swRenderSavedLocs === 'function') swRenderSavedLocs();
        if (typeof swRenderSavedQuests === 'function') swRenderSavedQuests();
        if (typeof swRenderSavedBounties === 'function') swRenderSavedBounties();
    } catch(e) {}
    if (typeof showToast === 'function') showToast('Backup imported', 'success');
}

function dmBackupCopy() {
    var out = document.getElementById('dmBackupText');
    if (!out) return;
    out.select();
    try { document.execCommand('copy'); } catch(e) {}
    if (typeof showToast === 'function') showToast('Copied backup JSON', 'success');
}

function dmBackupDownload() {
    var out = document.getElementById('dmBackupText');
    if (!out) return;
    if (!out.value.trim()) dmBackupExport();
    var txt = out.value || '';
    var blob = new Blob([txt], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'dm-helper-backup-' + new Date().toISOString().slice(0,10) + '.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){
        URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }, 120);
}

function dmExportFullCampaignToFile() {
    var campaignName = (typeof dmGetCurrentCampaignName === 'function' ? dmGetCurrentCampaignName() : '') || 'Unnamed Campaign';
    var payload = {
        version: 2,
        fullCampaign: true,
        exportedAt: new Date().toISOString(),
        campaign: {
            id: (_currentCampaign && _currentCampaign.id) || 'camp_' + Date.now(),
            name: campaignName,
            date: (_currentCampaign && _currentCampaign.date) || new Date().toLocaleDateString(),
            created: (_currentCampaign && _currentCampaign.created) || Date.now(),
            lastPlayed: new Date().toISOString(),
            npcs: (function(){ try { return JSON.parse(localStorage.getItem('npcgen_npcs') || '[]'); } catch(e){ return []; } })(),
            quests: (function(){ try { return JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e){ return []; } })(),
            party: (function(){ try { return JSON.parse(localStorage.getItem('npcgen_party') || '[]'); } catch(e){ return []; } })(),
            notes: localStorage.getItem('dm_notes') || '',
            quickNotes: localStorage.getItem('dm_quick_notes') || '',
            nemesis: (function(){ try { return JSON.parse(localStorage.getItem('npcgen_nemesis') || '{}'); } catch(e){ return {}; } })(),
            sessionNotes: (function(){ try { return JSON.parse(localStorage.getItem('dm_saved_notes') || '[]'); } catch(e){ return []; } })(),
            killed: (function(){ try { return JSON.parse(localStorage.getItem('npcgen_killed') || '[]'); } catch(e){ return []; } })(),
            vault: (function(){ try { return JSON.parse(localStorage.getItem('dm_vault') || '[]'); } catch(e){ return []; } })(),
            activeQuest: (function(){ try { return JSON.parse(localStorage.getItem('dm_active_quest') || 'null'); } catch(e){ return null; } })(),
            activeRevenge: (function(){ try { return JSON.parse(localStorage.getItem('dm_active_revenge') || 'null'); } catch(e){ return null; } })(),
            savedRevengeQuests: (function(){ try { return JSON.parse(localStorage.getItem('dm_saved_revenge_quests') || '[]'); } catch(e){ return []; } })(),
            locations: (function(){ try { return JSON.parse(localStorage.getItem('dm_locations') || '[]'); } catch(e){ return []; } })(),
            swStories: (function(){ try { return JSON.parse(localStorage.getItem('dm_sw_stories') || '[]'); } catch(e){ return []; } })(),
            swLocs: (function(){ try { return JSON.parse(localStorage.getItem('dm_sw_locs') || '[]'); } catch(e){ return []; } })(),
            liveTools: (function(){ try { return JSON.parse(localStorage.getItem('dm_live_tools') || 'null'); } catch(e){ return null; } })(),
            tags: (function(){ try { return JSON.parse(localStorage.getItem('npcgen_tags') || '[]'); } catch(e){ return []; } })(),
            sessionNotesText: localStorage.getItem('npcgen_session_notes') || '',
            notesV2: (function(){ try { return JSON.parse(localStorage.getItem('npcgen_notes_v2') || '[]'); } catch(e){ return []; } })()
        },
        savedCampaigns: (function(){ try { return JSON.parse(localStorage.getItem('dm_saved_campaigns') || '[]'); } catch(e){ return []; } })(),
        appSettings: (function(){ try { return localStorage.getItem(DM_APP_SETTINGS_KEY); } catch(e){ return null; } })(),
        spellFavorites: (function(){ try { return localStorage.getItem('dm_spell_favorites'); } catch(e){ return null; } })()
    };
    var blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'dm-campaign-' + (campaignName.replace(/[^a-z0-9_-]/gi, '_').slice(0, 40) || 'export') + '-' + new Date().toISOString().slice(0,10) + '.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){ URL.revokeObjectURL(url); document.body.removeChild(a); }, 120);
    if (typeof showToast === 'function') showToast('Campaign exported to file', 'success');
}

function dmImportFullCampaignFromFile(inputEl) {
    if (!inputEl || !inputEl.files || !inputEl.files[0]) return;
    var f = inputEl.files[0];
    var reader = new FileReader();
    reader.onload = function() {
        var payload;
        try { payload = JSON.parse(reader.result); } catch(e) { if (typeof showToast === 'function') showToast('Invalid JSON file', 'warning'); inputEl.value = ''; return; }
        if (!payload || !payload.fullCampaign || !payload.campaign) { if (typeof showToast === 'function') showToast('Not a valid full campaign file', 'warning'); inputEl.value = ''; return; }
        if (!confirm('Load this campaign file? Current session data will be replaced.')) { inputEl.value = ''; return; }
        var c = payload.campaign;
        try {
            if (c.npcs != null) localStorage.setItem('npcgen_npcs', JSON.stringify(c.npcs));
            if (c.quests != null) localStorage.setItem('npcgen_quests', JSON.stringify(c.quests));
            if (c.party != null) localStorage.setItem('npcgen_party', JSON.stringify(c.party));
            if (c.notes != null) localStorage.setItem('dm_notes', String(c.notes));
            if (c.quickNotes != null) localStorage.setItem('dm_quick_notes', String(c.quickNotes));
            if (c.nemesis != null) localStorage.setItem('npcgen_nemesis', JSON.stringify(c.nemesis));
            if (c.sessionNotes != null) localStorage.setItem('dm_saved_notes', JSON.stringify(c.sessionNotes));
            if (c.killed != null) localStorage.setItem('npcgen_killed', JSON.stringify(c.killed));
            if (c.vault != null) localStorage.setItem('dm_vault', JSON.stringify(c.vault));
            if (c.activeQuest != null) localStorage.setItem('dm_active_quest', JSON.stringify(c.activeQuest));
            if (c.activeRevenge != null) localStorage.setItem('dm_active_revenge', JSON.stringify(c.activeRevenge));
            if (c.savedRevengeQuests != null) localStorage.setItem('dm_saved_revenge_quests', JSON.stringify(c.savedRevengeQuests));
            if (c.locations != null) localStorage.setItem('dm_locations', JSON.stringify(c.locations));
            if (c.swStories != null) localStorage.setItem('dm_sw_stories', JSON.stringify(c.swStories));
            if (c.swLocs != null) localStorage.setItem('dm_sw_locs', JSON.stringify(c.swLocs));
            if (c.liveTools != null) localStorage.setItem('dm_live_tools', JSON.stringify(c.liveTools));
            if (c.tags != null) localStorage.setItem('npcgen_tags', JSON.stringify(c.tags));
            if (c.sessionNotesText != null) localStorage.setItem('npcgen_session_notes', String(c.sessionNotesText));
            if (c.notesV2 != null) localStorage.setItem('npcgen_notes_v2', JSON.stringify(c.notesV2));
            if (payload.savedCampaigns != null) localStorage.setItem('dm_saved_campaigns', JSON.stringify(payload.savedCampaigns));
            _currentCampaign = { id: c.id, name: c.name, date: c.date, created: c.created };
            localStorage.setItem('dm_current_campaign', JSON.stringify(_currentCampaign));
            if (payload.appSettings != null) try { localStorage.setItem(DM_APP_SETTINGS_KEY, payload.appSettings); } catch(e){}
            if (payload.spellFavorites != null) try { localStorage.setItem('dm_spell_favorites', payload.spellFavorites); } catch(e){}
        } catch(e) { if (typeof showToast === 'function') showToast('Import failed: ' + e.message, 'warning'); inputEl.value = ''; return; }
        try {
            if (typeof _party !== 'undefined') _party = JSON.parse(localStorage.getItem('npcgen_party') || '[]');
            if (typeof window.generatedNPCs !== 'undefined') window.generatedNPCs = JSON.parse(localStorage.getItem('npcgen_npcs') || '[]');
            if (typeof _killedNPCsLog !== 'undefined') _killedNPCsLog = JSON.parse(localStorage.getItem('npcgen_killed') || '[]');
            if (typeof _savedQuests !== 'undefined') _savedQuests = JSON.parse(localStorage.getItem('npcgen_quests') || '[]');
            if (typeof _activeRevenge !== 'undefined') _activeRevenge = JSON.parse(localStorage.getItem('dm_active_revenge') || 'null');
            if (typeof _savedRevengeQuests !== 'undefined') _savedRevengeQuests = JSON.parse(localStorage.getItem('dm_saved_revenge_quests') || '[]');
            if (typeof _savedLocations !== 'undefined') _savedLocations = JSON.parse(localStorage.getItem('dm_locations') || '[]');
            if (typeof _swSavedStories !== 'undefined') _swSavedStories = JSON.parse(localStorage.getItem('dm_sw_stories') || '[]');
            if (typeof _swSavedLocs !== 'undefined') _swSavedLocs = JSON.parse(localStorage.getItem('dm_sw_locs') || '[]');
            if (typeof _notes !== 'undefined') _notes = JSON.parse(localStorage.getItem('npcgen_notes_v2') || '[]');
        } catch(e2) {}
        if (typeof renderPartyTracker === 'function') renderPartyTracker();
        if (typeof renderAllNPCs === 'function') renderAllNPCs();
        if (typeof updateInitiativeOrderPanel === 'function') updateInitiativeOrderPanel();
        if (typeof _refreshNotesDropdown === 'function') _refreshNotesDropdown();
        if (typeof swRenderSavedStories === 'function') swRenderSavedStories();
        if (typeof swRenderSavedLocs === 'function') swRenderSavedLocs();
        if (typeof swRenderSavedQuests === 'function') swRenderSavedQuests();
        var badge = document.getElementById('campaignBadgeName');
        if (badge) badge.textContent = c.name || 'Campaign';
        var campBadge = document.getElementById('campaignBadge');
        if (campBadge) campBadge.classList.add('visible');
        if (typeof showToast === 'function') showToast('Campaign loaded from file', 'success');
        inputEl.value = '';
    };
    reader.readAsText(f);
}

/* ─── UNIVERSAL CONTENT POPUP ────────────────────────────────── */
window.openContentPopup = function(title, htmlContent, opts) {
    opts = opts || {};
    var modal = document.getElementById('universalContentPopup');
    if (!modal) return;
    var titleEl  = document.getElementById('ucpTitle');
    var bodyEl   = document.getElementById('ucpBody');
    var activeBtn = document.getElementById('ucpMakeActiveBtn');
    var saveBtn   = document.getElementById('ucpSaveBtn');
    if (titleEl) titleEl.textContent = title || '';
    if (bodyEl)  bodyEl.innerHTML = htmlContent || '<em style="color:rgba(255,255,255,0.4);">No content to display.</em>';
    if (activeBtn) {
        if (opts.onMakeActive) {
            activeBtn.style.display = 'inline-block';
            activeBtn.textContent = opts.activeLabel || '⚡ Set Active';
            activeBtn.disabled = false;
            activeBtn.onclick = function() { opts.onMakeActive(); activeBtn.textContent = '✅ Done!'; activeBtn.disabled = true; };
        } else { activeBtn.style.display = 'none'; }
    }
    if (saveBtn) {
        if (opts.onSave) {
            saveBtn.style.display = 'inline-block';
            saveBtn.textContent = opts.saveLabel || '💾 Save';
            saveBtn.disabled = false;
            saveBtn.onclick = function() { opts.onSave(); saveBtn.textContent = '✅ Saved!'; saveBtn.disabled = true; };
        } else { saveBtn.style.display = 'none'; }
    }
    modal.style.zIndex = '19999';
    modal.style.display = 'flex';
};

window.closeContentPopup = function() {
    var modal = document.getElementById('universalContentPopup');
    if (modal) modal.style.display = 'none';
};

function _swSanitizePopupHtml(html) {
    var wrap = document.createElement('div');
    wrap.innerHTML = html || '';
    wrap.querySelectorAll('button').forEach(function(btn){ btn.remove(); });
    return wrap.innerHTML || '<em style="color:rgba(255,255,255,0.45);">No details available.</em>';
}

window.sqOpenQuestDetails = function(qid) {
    var qs = [];
    try { qs = JSON.parse(localStorage.getItem('npcgen_quests') || '[]'); } catch(e){}
    var q = qs.find(function(x){ return x.id === qid; });
    if (!q) return;
    openContentPopup('⚡ ' + (q.title || 'Quest'), _swSanitizePopupHtml(q.html), {
        onMakeActive: function() { sqSetActive(q.id); closeContentPopup(); },
        activeLabel: '⚡ Set Active Quest'
    });
};

window.swOpenActiveStoryDetails = function(sid) {
    var s = (window._swSavedStories || []).find(function(x){ return x.id === sid; });
    if (!s) return;
    var content = (s.chapters || []).map(function(c){ return c.html || ''; }).join('');
    openContentPopup('📖 ' + (s.title || 'Story'), _swSanitizePopupHtml(content), {
        onMakeActive: function() { setActiveStory(sid); closeContentPopup(); },
        activeLabel: '📖 Set Active Story'
    });
};

window.swOpenActiveBountyDetails = function(id) {
    var bounties = [];
    try { bounties = JSON.parse(localStorage.getItem('sw_savedBounties') || '[]'); } catch(e){}
    var b = bounties.find(function(x){ return x.id === id; });
    if (!b) return;
    var html = _swSanitizePopupHtml(b.html)
        + '<div style="margin-top:10px;font-family:\'Cinzel\',serif;font-size:0.74em;color:rgba(255,220,170,0.7);">Saved: ' + (b.date || '') + ' · CR ' + (b.cr || '?') + '</div>';
    openContentPopup('📌 ' + (b.name || 'Bounty'), html, {
        onMakeActive: function() { setActiveBountyById(id); closeContentPopup(); },
        activeLabel: '📌 Set Active Bounty'
    });
};

window.swOpenActiveLocationDetails = function(id) {
    var loc = (window._swSavedLocs || []).find(function(x){ return x.id === id; });
    if (!loc) return;
    var html = _swSanitizePopupHtml(loc.html)
        + '<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">'
        + '<button onclick="setActiveLocationById(\'' + loc.id + '\');closeContentPopup();" style="padding:7px 12px;background:linear-gradient(145deg,#1a3a6a,#2a5ab0);color:#d0e8ff;border:1px solid rgba(100,160,255,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;">📍 Set Active</button>'
        + '<button onclick="window._swLastLoc=(window._swSavedLocs||[]).find(function(x){return x.id===\'' + loc.id + '\';})||window._swLastLoc;swGenerateLocationBattleMap();swOpenLocationBattleMapPopup();" style="padding:7px 12px;background:linear-gradient(145deg,#1f6f4a,#2e8b57);color:#d8ffe8;border:1px solid rgba(90,220,150,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;">🗺 Open Battlemap</button>'
        + '</div>';
    openContentPopup('📍 ' + (loc.name || 'Location'), html, {
        onMakeActive: function() { setActiveLocationById(id); closeContentPopup(); },
        activeLabel: '📍 Set Active Location'
    });
};

/* ─── Saved locations list — click to popup ─────────────────── */
window._renderSavedLocationsList = function() {
    var el = document.getElementById('savedLocationsList');
    if (!el) return;
    var locs = window._savedLocations || [];
    if (!locs.length) {
        el.innerHTML = '<div style="color:rgba(100,180,100,0.4);font-size:0.75em;text-align:center;padding:6px;font-style:italic;">No saved locations yet.</div>';
        return;
    }
    el.innerHTML = locs.slice(0,10).map(function(loc) {
        return '<div data-locid="' + loc.id + '" '
            + 'style="display:flex;align-items:center;justify-content:space-between;padding:5px 8px;background:rgba(100,180,100,0.08);border:1px solid rgba(100,180,100,0.25);border-radius:5px;margin-bottom:4px;cursor:pointer;transition:background 0.15s;" '
            + 'onmouseover="this.style.background=\'rgba(100,180,100,0.18)\'" onmouseout="this.style.background=\'rgba(100,180,100,0.08)\'">'
            + '<div style="flex:1;min-width:0;" onclick="(function(){var l=window._savedLocations&&window._savedLocations.find(function(x){return x.id===\'' + loc.id + '\';});if(l&&l.html)openContentPopup(\'📍 \'+(l.icon||\'🏘\')+\' \'+l.name,l.html,{onMakeActive:function(){window._activeLocation=l;showToast(l.name+\' set active!\',\'success\');},activeLabel:\'📍 Set Active\'});})()">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.73em;font-weight:700;color:#c8ffc8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (loc.icon || '🏘') + ' ' + (loc.name || 'Location') + '</div>'
            + '<div style="font-size:0.65em;color:rgba(200,255,200,0.45);">' + (loc.type || '').replace(/_/g,' ') + ' · ' + (loc.date || '') + '</div>'
            + '</div>'
            + '<button onclick="event.stopPropagation();(function(){window._savedLocations=window._savedLocations.filter(function(l){return l.id!==\'' + loc.id + '\';});if(typeof _saveLocations===\'function\')_saveLocations();_renderSavedLocationsList();showToast(\'Deleted\',\'success\');})()" '
            + 'style="background:none;border:1px solid rgba(139,0,0,0.4);color:rgba(240,128,128,0.6);padding:1px 6px;border-radius:3px;cursor:pointer;font-size:0.7em;flex-shrink:0;margin-left:4px;">✕</button>'
            + '</div>';
    }).join('');
};

/* Patch saved stories click to popup */
(function() {
    var _orig = window._swRenderSavedList;
    window._swRenderSavedList = function() {
        if (_orig) _orig.apply(this, arguments);
        setTimeout(function() {
            var list = document.getElementById('swSavedStoriesList');
            if (!list) return;
            var items = list.querySelectorAll('[data-sid]');
            items.forEach(function(item) {
                if (item._popupPatched) return;
                item._popupPatched = true;
                item.addEventListener('click', function(e) {
                    if (e.target.tagName === 'BUTTON') return;
                    var sid = item.dataset.sid;
                    var s = window._swSavedStories && window._swSavedStories.find(function(x){ return x.id === sid; });
                    if (!s) return;
                    var content = (s.chapters || []).map(function(c){ return c.html || ''; }).join('');
                    openContentPopup('📖 ' + (s.title || 'Story'), content, {
                        onMakeActive: function() {
                            if (typeof swLoadStory === 'function') swLoadStory(sid);
                            if (!window._swStoryLinked && typeof swToggleStoryLink === 'function') swToggleStoryLink();
                        },
                        activeLabel: '🔗 Load & Link'
                    });
                });
            });
        }, 120);
    };
})();

/* ══════════════════════════════════════════════════════════════
   ── ACTIVE STORY PICKER (Story Tab Dropdown) ──────────────────
   ══════════════════════════════════════════════════════════════ */

var _swActiveStory = null;

function toggleActiveStoryDropdown() {
    if (typeof window.toggleActiveStoryDropdown === 'function' && window.toggleActiveStoryDropdown !== toggleActiveStoryDropdown) {
        window.toggleActiveStoryDropdown();
        return;
    }
}

function _renderActiveStoryList() {
    /* Delegate to portal version if available (defined later in the file) */
    if (typeof window._renderActiveStoryList === 'function' && window._renderActiveStoryList !== _renderActiveStoryList) {
        window._renderActiveStoryList();
        return;
    }
    /* Fallback: just update the header label */
    var labelEl = document.getElementById('activeStoryHeaderLabel');
    if (labelEl) labelEl.textContent = _swActiveStory ? '📖 ' + (_swActiveStory.title || 'Story').substring(0, 20) : 'Active Story';
}

function setActiveStory(sid) {
    var s = _swSavedStories.find(function(x) { return x.id === sid; });
    if (!s) return;
    _swActiveStory = s;
    _swCurrentStory = s;
    var outEl = document.getElementById('swStoryOutput');
    if (outEl) { outEl.style.display = 'block'; outEl.innerHTML = (s.chapters || []).map(function(c) { return c.html || ''; }).join(''); }
    ['swEvolveBtn','swAddSceneBtn','swClearStoryBtn'].forEach(function(id) {
        var el = document.getElementById(id); if (el) el.style.display = 'inline-block';
    });
    var row2 = document.getElementById('swStoryActionRow2'); if (row2) row2.style.display = 'flex';
    var dd = document.getElementById('activeStoryDropdown'); if (dd) dd.style.display = 'none';
    if (typeof showToast === 'function') showToast('📖 Active story set: ' + (s.title || 'Story'), 'success');
    swUpdateStoryLinkBars();
    setTimeout(function() { if (window._renderActiveStoryList) window._renderActiveStoryList(); }, 30);
}

function clearActiveStory() {
    _swActiveStory = null;
    var dd = document.getElementById('activeStoryDropdown'); if (dd) dd.style.display = 'none';
    if (typeof showToast === 'function') showToast('Active story cleared', 'success');
    setTimeout(function() { if (window._renderActiveStoryList) window._renderActiveStoryList(); }, 30);
}

/* Patch swSaveStory to refresh picker */
(function() {
    var _orig = window.swSaveStory;
    window.swSaveStory = function() {
        if (_orig) _orig.apply(this, arguments);
        setTimeout(_renderActiveStoryList, 100);
    };
})();
/* Patch swDeleteStory to refresh picker */
(function() {
    var _orig = window.swDeleteStory;
    window.swDeleteStory = function() {
        if (_orig) _orig.apply(this, arguments);
        setTimeout(_renderActiveStoryList, 100);
    };
})();

/* ══════════════════════════════════════════════════════════════
   ── BOUNTY GENERATOR (Story & World Generator Tab) ────────────
   ══════════════════════════════════════════════════════════════ */

var _SW_BOUNTY_CRIMINALS = [
    {name:'Mira "Shadowhand" Voss', crime:'Masterminds heists across three kingdoms; has never been identified at a scene', threat:'Extremely High', skills:['Stealth','Deception','Acrobatics'], wants:'capture'},
    {name:'Gorrath the Desecrator', crime:'Razed a temple of Pelor; stole the Holy Sunstaff; 14 clergy dead', threat:'LEGENDARY', skills:['Heavy Arms','Undead Command','Intimidation'], wants:'dead'},
    {name:'The Pale Merchant', crime:'Trafficking in cursed artifacts; multiple towns afflicted with magical plagues', threat:'High', skills:['Arcana','Persuasion','Disguise'], wants:'capture'},
    {name:'Serin Ashvale', crime:'Poisoned a noble family\'s water supply; 6 dead, entire household afflicted', threat:'Moderate', skills:['Alchemy','Stealth','Medicine'], wants:'capture'},
    {name:'Brak One-Eye', crime:'Piracy on the Serpent Sea; sunk four merchant vessels, enslaved survivors', threat:'High', skills:['Navigation','Combat','Intimidation'], wants:'dead or alive'},
    {name:'Thessaly Wraithborn', crime:'Necromancer raising dead in the Westmarch Graveyard; undead attacking nearby farmsteads', threat:'Extremely High', skills:['Necromancy','Ritual Magic','Undead Minions'], wants:'dead'},
    {name:'Calyx the Forger', crime:'Has been printing false noble writs; three innocent men executed on false charges', threat:'Moderate', skills:['Forgery','Deception','Arcana'], wants:'capture'},
    {name:'The Red Jester', crime:'Serial killer targeting city watch captains across the Westlands; 9 victims', threat:'High', skills:['Performance','Poison','Escape Artist'], wants:'capture'},
    {name:'Vorn Steelcrusher', crime:'Mercenary commander selling services to enemy state; defector and traitor', threat:'High', skills:['Combat','Tactics','Leadership'], wants:'dead'},
    {name:'Lirien the Undying', crime:'Has evaded execution twice; unknown resurrection method; trail of murders', threat:'LEGENDARY', skills:['Sorcery','Resurrection','Corruption'], wants:'destroy means of return'},
];

var _SW_BOUNTY_CRIMES = [
    'Armed robbery of the royal courier service',
    'Assassination of a ranking guild officer',
    'Arson — destroyed a merchant district warehouse',
    'Extortion of three separate noble households',
    'Kidnapping of a prominent alchemist\'s apprentice',
    'Theft of magical artifacts from the Mage\'s Collegium',
    'Smuggling of banned substances through the city gates',
    'Fraud — impersonated a ranking city official',
    'Desecration of a temple and theft of holy relics',
    'Poaching in the King\'s Forest (multiple offenses)',
    'Jailbreak — freed six convicted criminals',
    'Horse theft and resale across county lines',
    'Counterfeiting gold coins bearing the King\'s seal',
    'Murder of a witness before a trial of the High Court',
    'Infiltrating and selling secrets of the Merchant\'s Guild',
];

var _SW_BOUNTY_DISTINGUISHING = [
    'A long diagonal scar across the left cheek',
    'Missing the tip of the right index finger',
    'Unusual violet eyes that seem to glow faintly in darkness',
    'A brand on the neck marking a former slave',
    'Always wears a distinctive red cloak regardless of weather',
    'Tattooed serpent coiling up the left arm',
    'Walks with a pronounced limp favoring the right leg',
    'Speaks with an accent from the Far Eastern Reaches',
    'Never seen without a peculiar carved bone amulet',
    'Hair prematurely silver-white despite young apparent age',
    'An unusual arcane sigil visible on the back of the left hand',
    'Blind in one eye — wears a dark lens over it',
];

var _SW_BOUNTY_WARNINGS = [
    'Subject is known to use disguise magic — do not trust appearances',
    'Extremely dangerous in close quarters — approach only with crossbows ready',
    'Has known allies in this city — assume you are being watched',
    'Subject has evaded capture three times before — underestimation is fatal',
    'Uses poisons on all weapons — even minor wounds are life-threatening',
    'Do not negotiate or enter conversation — subject is a master manipulator',
    'Travels with a trained animal companion — neutralize it first',
    'Casts fear magic when cornered — establish countermeasures',
];

function swApplyMassiveBountyPack() {
    if (window._swMassiveBountyPackApplied) return;
    window._swMassiveBountyPackApplied = true;

    _swExtendUniqueArray(_SW_BOUNTY_CRIMINALS, [
        {name:'Captain Sable Rook', crime:'Hijacked three military payroll convoys and redistributed funds to insurgent cells', threat:'High', skills:['Tactics','Mounted Combat','Counter-tracking'], wants:'capture'},
        {name:'Mother Vell, the Candle Widow', crime:'Runs a child kidnapping ring disguised as a refuge mission', threat:'Extremely High', skills:['Deception','Charm Magic','Networked Informants'], wants:'alive'},
        {name:'Jorek Flintwake', crime:'Demolitions saboteur responsible for bridge collapses that killed trade caravans', threat:'High', skills:['Alchemy','Engineering','Escape'], wants:'dead or alive'},
        {name:'The Ink Saint', crime:'Forged succession decrees that triggered two border skirmishes', threat:'Moderate', skills:['Forgery','Law Lore','Disguise'], wants:'capture'},
        {name:'Rathos Chainpriest', crime:'Leads forced labor raids in frontier towns for an unknown benefactor', threat:'LEGENDARY', skills:['Command','Divine Magic','Intimidation'], wants:'dead'}
    ]);

    _swExtendUniqueArray(_SW_BOUNTY_CRIMES, [
        'Seized tax grain stores and sold rations back at triple price during famine week',
        'Organized forced disappearances of witnesses before magistrate hearings',
        'Contracted arsonists to burn debt records in three district halls',
        'Led jailbreak for political prisoners while framing rival factions',
        'Extorted frontier villages with forged military requisition orders',
        'Sold naval patrol schedules to privateer captains for profit',
        'Murdered emissaries under truce flag and forged enemy responsibility',
        'Kidnapped temple novices to fuel blood-ward rituals',
        'Counterfeited plague cure permits and blocked legitimate aid caravans',
        'Engineered guild elections through bribery, blackmail, and targeted killings',
        'Ran a smuggling ring that moved contraband through orphanages and charity wagons; at least two children died in transit.',
        'Assassinated three magistrates and left evidence implicating a neighbouring realm, nearly starting a war.',
        'Systematically poisoned wells in a border district to drive land prices down before buying the deeds.',
        'Stole military dispatches and sold them to both sides of a conflict; battle plans were compromised for months.',
        'Used charm magic to coerce sworn testimony in seven trials; four innocent people were executed as a result.',
        'Organised a slave ring that targeted refugees and sold them to labour camps under false contracts.',
        'Burned a library containing the only copies of treaties that defined the realm\'s borders; boundary disputes followed.',
        'Hired mercenaries to pose as bandits and raid caravans, then sold "protection" to the same merchants.',
        'Forged a royal succession decree and had the legitimate heir imprisoned; ruled by proxy for two years before exposure.',
        'Drained a sacred spring to power a ritual that blighted crops across three counties; famine and unrest followed.'
    ]);

    _swExtendUniqueArray(_SW_BOUNTY_DISTINGUISHING, [
        'Carries a lacquered prayer wheel that rattles though no beads are inside',
        'A silver chain grafted beneath the skin at the jawline',
        'Burn pattern on both palms in mirrored sigils',
        'Wears one armored gauntlet with tiny court seals engraved inside',
        'A voice that drops to a whisper when speaking proper names',
        'Never casts a shadow directly behind them, only to one side',
        'Smell of cedar smoke and copper follows them even in rain',
        'Distinctive laugh that ends abruptly as if listening for something'
    ]);

    _swExtendUniqueArray(_SW_BOUNTY_WARNINGS, [
        'Target carries legal immunity papers signed by a corrupt magistrate — verify before engagement',
        'Expect false surrender; target has detonated decoys during prior captures',
        'Known to seed witnesses with contradictory stories to poison investigations',
        'Do not hold in standard cells; accomplices inside city watch may attempt extraction',
        'Target uses children as couriers and lookouts — nonlethal containment strongly advised',
        'Keeps a fail-safe ledger with blackmail names; if triggered, multiple officials will flee',
        'Target has a bonded creature or familiar that will seek revenge if the target is killed; locate and neutralise it first.',
        'Multiple bounty notices exist for the same target under different names; confirm identity before payment.',
        'Target is believed to have a dead man\'s switch: documents or agents that will activate if they are captured or killed.',
        'Do not accept food or drink from anyone connected to the target; previous hunters were poisoned at handoff.',
        'Target has impersonated authority figures before; demand a code phrase or seal that only the real issuer knows.',
        'Engaging in populated areas will cause collateral casualties; the client will reduce or void payment if civilians are harmed.'
    ]);
}

swApplyMassiveBountyPack();

var _SW_BOUNTY_CR_TO_LEVEL = {
    '0': [1,2], '0.125': [1,2], '0.25': [1,3], '0.5': [1,4],
    '1': [1,4], '2': [2,5], '3': [3,6], '4': [4,7],
    '5': [5,8], '6': [5,9], '7': [6,10], '8': [7,11],
    '9': [8,11], '10': [9,12], '11': [9,13], '12': [10,14],
    '13': [11,14], '14': [11,15], '15': [12,16], '16': [13,17],
    '17': [14,17], '18': [15,18], '19': [15,19], '20': [16,20],
    '21': [17,20], '22': [18,20], '23': [19,20], '24': [19,20],
    '25': [20,20], 'boss': [15,20]
};

var _SW_BOUNTY_CR_GOLD = {
    '0': '5 gp', '0.125': '15 gp', '0.25': '25 gp', '0.5': '50 gp',
    '1': '100 gp', '2': '200 gp', '3': '350 gp', '4': '500 gp',
    '5': '750 gp', '6': '1,000 gp', '7': '1,200 gp', '8': '1,500 gp',
    '9': '2,000 gp', '10': '2,500 gp', '11': '3,000 gp', '12': '4,000 gp',
    '13': '5,000 gp', '14': '6,000 gp', '15': '8,000 gp', '16': '10,000 gp',
    '17': '12,000 gp', '18': '15,000 gp', '19': '18,000 gp', '20': '20,000 gp',
    '21': '25,000 gp', '22': '30,000 gp', '23': '35,000 gp', '24': '40,000 gp',
    '25': '50,000 gp', 'boss': '30,000 gp'
};

function _swBountyPick(arr) { return arr[Math.floor(_swRand() * arr.length)]; }

function swGenerateBounties(forceMode) {
    var crSel   = document.getElementById('swBountyCR');
    var qtySel  = document.getElementById('swBountyQty');
    var typeSel = document.getElementById('swBountyType');

    var crVal   = (crSel  && crSel.value  !== '') ? crSel.value  : null;
    var qtyVal  = (qtySel && qtySel.value !== '') ? parseInt(qtySel.value) : null;
    var typeVal = (typeSel && typeSel.value !== '') ? typeSel.value : null;

    /* Force modes override controls */
    if (forceMode === 'random') { crVal = null; qtyVal = null; typeVal = null; }
    if (forceMode === 'boss')   { crVal = 'boss'; forceMode = null; }

    _swBeginDeterministic('bounty|' + (crVal || 'random') + '|' + (qtyVal != null ? qtyVal : 'random') + '|' + (typeVal || 'random') + '|' + (forceMode || 'none'));

    /* Determine quantity (random 1-4 if not set) */
    var count = qtyVal !== null ? qtyVal : (Math.floor(_swRand() * 4) + 1);

    window._swLastBountyCards = [];
    var cards = [];
    for (var i = 0; i < count; i++) {
        cards.push(_swBuildBountyCard(crVal, typeVal, i));
    }
    /* Small chance one bounty is a revenge-on-the-party bounty (from a revenge quest) */
    var revengeChance = 0.12;
    if (count >= 1 && _swRand() < revengeChance) {
        var replaceIdx = Math.floor(_swRand() * count);
        cards[replaceIdx] = _swBuildRevengeBountyCard(replaceIdx);
        if (typeof showToast === 'function') showToast('One of the bounties is a revenge bounty on the party!', 'success');
    }

    var outEl = document.getElementById('swBountyOutput');
    if (!outEl) return;
    outEl.style.display = 'flex';
    outEl.innerHTML = cards.join('');
    if (typeof showToast === 'function') showToast('Generated ' + count + ' bounty' + (count !== 1 ? 's' : '') + '!', 'success');
}

function _swBuildBountyCard(crVal, typeVal, idx) {
    var crKeys = Object.keys(_SW_BOUNTY_CR_TO_LEVEL);
    var cr = crVal || _swBountyPick(crKeys);
    var lvRange = _SW_BOUNTY_CR_TO_LEVEL[cr] || [1,4];
    var gold = _SW_BOUNTY_CR_GOLD[cr] || '100 gp';
    var isBoss = (cr === 'boss' || parseFloat(cr) >= 17);

    var bountyType = typeVal || _swBountyPick(['capture','kill','dead_or_alive','capture_or_kill','retrieve','escort','investigation']);
    var typeLabel  = {
        capture:'Wanted: Alive',
        kill:'Kill Order',
        dead_or_alive:'Dead or Alive',
        capture_or_kill:'Capture or Kill',
        retrieve:'Retrieve & Return',
        escort:'Protect & Escort',
        investigation:'Bring to Justice'
    }[bountyType] || 'Wanted';
    var typeBg     = {
        capture:'#1a6b3a',
        kill:'#8b0000',
        dead_or_alive:'#6a0000',
        capture_or_kill:'#8a5500',
        retrieve:'#1a3a6a',
        escort:'#4a3a00',
        investigation:'#3a0060'
    }[bountyType] || '#8b0000';

    var statusLabel = {
        capture: 'ALIVE ONLY',
        kill: 'DEAD ONLY',
        dead_or_alive: 'DEAD OR ALIVE',
        capture_or_kill: 'CAPTURE PREFERRED',
        retrieve: 'RETURN REQUIRED',
        escort: 'PROTECT THE CLIENT',
        investigation: 'BRING EVIDENCE'
    }[bountyType] || 'WANTED';
    var statusNote = {
        capture: 'Target must be delivered breathing. Excessive injury reduces payout and may void reward.',
        kill: 'Proof of death required. Capture is not authorized; do not attempt transport.',
        dead_or_alive: 'Either outcome accepted. Alive capture grants a higher payout if the target can be questioned.',
        capture_or_kill: 'Primary objective is capture. Dead is acceptable only if the target resists with lethal force.',
        retrieve: 'Return the marked item intact. Do not attune to, sell, or destroy it.',
        escort: 'The client is the priority. Abandoning the client voids the contract.',
        investigation: 'Bring witnesses, documents, or the target for questioning. Lethal force is last resort.'
    }[bountyType] || 'The issuing authority reserves the right to deny payment if terms are violated.';

    /* Pick or generate a name */
    var criminals = _SW_BOUNTY_CRIMINALS;
    var usedCriminal = criminals[idx % criminals.length];
    var name = usedCriminal.name;
    /* For extra bounties beyond the list, generate a random name */
    if (idx >= criminals.length) {
        var firstNames = ['Aldric','Brynn','Cassia','Dorek','Elara','Fenn','Gritta','Harkon','Isolde','Jorath'];
        var lastNames  = ['the Burned','of the Veil','Redmane','Blackwood','the Hollow','Ashcroft','Duskwarden','Nightfall'];
        name = _swBountyPick(firstNames) + ' ' + _swBountyPick(lastNames);
    }
    var crime     = _swBountyPick(_SW_BOUNTY_CRIMES);
    var marks     = _swBountyPick(_SW_BOUNTY_DISTINGUISHING);
    var warning   = _swBountyPick(_SW_BOUNTY_WARNINGS);
    var lastSeenArr = [
        'Last seen near the river gate at dusk, speaking with a cloaked courier.',
        'Last seen leaving a cheap inn under an assumed name.',
        'Last seen boarding a night barge with sealed crates.',
        'Last seen in the market crowd during a public execution.',
        'Last seen in the old ruins outside town where lanterns burned blue.',
        'Last seen at a shrine, leaving offerings that smelled of brimstone.',
        'Last seen entering the sewers via a collapsed storm drain.',
        'Last seen at the docks; witnesses report disguised guards escorting them.',
        'Last seen at a private auction where only sealed bids were accepted; the target left with a locked strongbox.',
        'Last seen meeting a city watch sergeant in a closed courtyard; the sergeant has since requested transfer.',
        'Last seen in the company of a known torturer who was thought to have died years ago.',
        'Last seen leaving a healer\'s house at dawn; the healer refuses to speak to authorities.'
    ];
    var rumorArr = [
        'Rumor: the target has a patron among the nobles who will obstruct the investigation.',
        'Rumor: the target carries a cursed charm that bends weak minds.',
        'Rumor: the target never travels alone—two lookouts always shadow them.',
        'Rumor: the target has a safehouse inside a legitimate business.',
        'Rumor: the target has bribed a magistrate to delay warrants.',
        'Rumor: the target is being hunted by someone else—expect an ambush at the handoff.',
        'Rumor: the target is protected by a minor fiend bound by contract.',
        'Rumor: the target has an identical double to confuse pursuers.',
        'Rumor: the target has already paid off two previous bounty hunters to fake their own death and report failure.',
        'Rumor: the target\'s true identity is a disgraced official who was supposed to have been executed.',
        'Rumor: capturing the target alive will trigger a dead man\'s switch that releases incriminating documents.',
        'Rumor: the target is terminally ill and may be seeking a final confrontation rather than escape.'
    ];
    var assocArr = [
        'Known associates: a fence called “Copper-Eye”, two caravan guards, and a temple scribe with debts.',
        'Known associates: a masked arcanist, a gang of dock thugs, and a courier who never speaks.',
        'Known associates: a failed knight, a poisoner, and a priest who preaches forgiveness too loudly.',
        'Known associates: a mercenary trio (the Grey Blades) and a local healer paid to look away.',
        'Known associates: an alchemist, a bookmaker, and a bard who spreads misinformation.',
        'Known associates: a disgraced magistrate\'s clerk, a former torturer turned informant, and a noble\'s cast-off bastard who runs messages.',
        'Known associates: a ship\'s captain who no longer docks in official harbours, a locksmith, and a forger who works only at night.',
        'Known associates: a temple acolyte who leaks confession summaries, a guard sergeant, and a beggar who controls the street children.'
    ];
    var jurisdictionArr = [
        'Jurisdiction: City Watch / Magistrate’s Office · Writ sealed with red wax.',
        'Jurisdiction: The Crown’s Inquisitors · Payment authorized by royal signet.',
        'Jurisdiction: Merchant Guild Security · Private contract filed under charter law.',
        'Jurisdiction: Temple Militant · Reward payable upon proof at the shrine.',
        'Jurisdiction: Border Wardens · Authority extends outside city limits.'
    ];
    var proofArr = [
        'Proof required: signet ring, branded mark, or a witness statement from a sworn official.',
        'Proof required: head or distinctive tattooed skin; false claims are punishable by hanging.',
        'Proof required: the target alive in irons, plus a sworn confession from the arresting party.',
        'Proof required: captured item, intact and unaltered, delivered to the quartermaster.',
        'Proof required: written testimony and two corroborating sources.'
    ];
    var lastSeen = _swBountyPick(lastSeenArr);
    var rumor = _swBountyPick(rumorArr);
    var associates = _swBountyPick(assocArr);
    var jurisdiction = _swBountyPick(jurisdictionArr);
    var proof = _swBountyPick(proofArr);
    var threatLabel = isBoss ? 'LEGENDARY THREAT' : (parseFloat(cr) >= 10 ? 'Extremely High' : parseFloat(cr) >= 6 ? 'High' : parseFloat(cr) >= 3 ? 'Moderate' : 'Low');
    var threatColor = isBoss ? '#ffd700' : (parseFloat(cr) >= 10 ? '#e74c3c' : parseFloat(cr) >= 6 ? '#e67e22' : parseFloat(cr) >= 3 ? '#f1c40f' : '#27ae60');
    var manhuntBriefing = _swNarrativeParagraph(
        'Field briefing: the target is not merely dangerous; they are embedded in routines that protect them.',
        [
            'Assume misinformation has been seeded deliberately, including false sightings meant to exhaust pursuers and split teams.',
            'The first encounter may be a probe rather than a fight, designed to test methods, spell use, and willingness to negotiate.',
            'Collateral pressure is expected: bystanders, officials, or rival hunters may interfere once the bounty becomes public.'
        ],
        2
    );
    var bountySceneHooks = [
        'Street lead: a witness offers accurate directions but demands immediate protection for their family.',
        'Ambush beat: a rival hunting party stages a fake arrest to claim payment before the party can verify identity.',
        'Social beat: the target appears under legal protection at a public ceremony where violence would trigger a crackdown.',
        'Pursuit beat: a decoy runs while the real target circles back to seize evidence from the party\'s packs.',
        'Twist beat: a corrupt official attempts to void the contract unless bribed or publicly exposed.'
    ];
    var hooksText = '• ' + _swBountyPick(bountySceneHooks) + '<br>• ' + _swBountyPick(bountySceneHooks) + '<br>• ' + _swBountyPick(bountySceneHooks);
    var bountyCoherence = swAnalyzeNarrativeCoherence('bounty', {
        name: name,
        crime: crime,
        warning: warning,
        textBlocks: [crime, marks, warning, statusLabel, statusNote, lastSeen, rumor, associates, jurisdiction, proof, manhuntBriefing, hooksText]
    });
    var bountyCoherenceHtml = swRenderCoherencePanel(bountyCoherence, '#ffd39a');
    var bountyPrep = swBuildSessionPrep('bounty', { name: name, objective: typeLabel, twist: warning });
    var bountyPrepHtml = swRenderSessionPrepPanel(bountyPrep, '#ffd7a8');

    var crDisplay = cr === '0.125' ? '1/8' : cr === '0.25' ? '1/4' : cr === '0.5' ? '1/2' : cr === 'boss' ? 'BOSS' : cr;

    var posterBg = isBoss
        ? 'linear-gradient(145deg,#1a001a,#2a0040,#3a0000)'
        : 'linear-gradient(145deg,#1a0a00,#2a1500,#1a0800)';
    var posterBorder = isBoss ? '#daa520' : '#b8860b';

    /* Store card data for Set Active */
    var cardIdx = (window._swLastBountyCards || []).length;
    if (!window._swLastBountyCards) window._swLastBountyCards = [];
    var cardHtml = '<div data-bounty-idx="' + cardIdx + '" style="background:' + posterBg + ';border:2px solid ' + posterBorder + ';border-radius:10px;overflow:hidden;font-family:\'Crimson Text\',serif;">'
        /* Activate bar — always on top */
        + '<div style="background:rgba(0,0,0,0.5);border-bottom:1px solid rgba(100,160,255,0.35);padding:8px 12px;display:flex;align-items:center;gap:8px;">'
        + '<button onclick="swActivateBounty(' + cardIdx + ')" style="padding:6px 16px;background:linear-gradient(145deg,#6a3a00,#a05800);color:#ffe8c0;border:1px solid rgba(218,165,32,0.7);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.74em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 8px rgba(180,100,0,0.4);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#8a5000,#c07000)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#6a3a00,#a05800)\'">📌 Set as Active Bounty</button>'
        + '<button onclick="swGenerateVillainFromBounty(' + cardIdx + ')" style="padding:6px 14px;background:linear-gradient(145deg,#5a0000,#8b0000);color:#ffd0d0;border:1px solid rgba(200,50,50,0.7);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.74em;font-weight:700;letter-spacing:0.5px;box-shadow:0 2px 8px rgba(139,0,0,0.4);transition:all 0.15s;" onmouseover="this.style.background=\'linear-gradient(145deg,#7a0000,#aa0000)\'" onmouseout="this.style.background=\'linear-gradient(145deg,#5a0000,#8b0000)\'">🎯 Generate Wanted NPC</button>'
        + '<button onclick="swSaveBountyOnly(' + cardIdx + ')" style="padding:6px 12px;background:rgba(184,134,11,0.2);color:#daa520;border:1px solid rgba(184,134,11,0.5);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.74em;font-weight:700;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(184,134,11,0.4)\'" onmouseout="this.style.background=\'rgba(184,134,11,0.2)\'">💾 Save</button>'
        + '<button onclick="swPrintBountyCard(' + cardIdx + ')" style="padding:6px 12px;background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.55);border:1px solid rgba(255,255,255,0.2);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.74em;font-weight:700;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(255,255,255,0.14)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.07)\'">🖨 Print</button>'
        + '<button onclick="swDeleteBountyCard(' + cardIdx + ', this)" style="padding:6px 10px;background:rgba(139,0,0,0.25);color:rgba(255,120,120,0.8);border:1px solid rgba(139,0,0,0.45);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.74em;font-weight:700;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(180,0,0,0.4)\'" onmouseout="this.style.background=\'rgba(139,0,0,0.25)\'">✕</button>'
        + '</div>'
        /* Type/threat header bar */
        + '<div style="background:linear-gradient(135deg,' + typeBg + ',' + typeBg + 'aa);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid ' + posterBorder + '66;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.82em;font-weight:700;color:#fff8dc;letter-spacing:2px;text-transform:uppercase;">📌 ' + typeLabel + '</div>'
        + '<div style="display:flex;gap:6px;align-items:center;">'
        + '<span style="background:rgba(0,0,0,0.4);border:1px solid ' + posterBorder + ';color:' + posterBorder + ';padding:2px 10px;border-radius:10px;font-family:\'Cinzel\',serif;font-size:0.72em;font-weight:700;">CR ' + crDisplay + '</span>'
        + '<span style="background:rgba(0,0,0,0.4);border:1px solid ' + threatColor + ';color:' + threatColor + ';padding:2px 10px;border-radius:10px;font-size:0.72em;font-weight:700;">' + threatLabel + '</span>'
        + '</div></div>'
        /* Body */
        + '<div style="padding:14px 16px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:1.12em;font-weight:800;color:' + (isBoss ? '#ffd700' : '#fff8dc') + ';margin-bottom:2px;text-shadow:1px 1px 3px rgba(0,0,0,0.8);">' + name + (isBoss ? ' ✦' : '') + '</div>'
        + '<div style="font-size:0.78em;color:rgba(255,255,255,0.4);margin-bottom:12px;">Lvl ' + lvRange[0] + '–' + lvRange[1] + ' Party Recommended</div>'

        + '<div style="display:flex;flex-direction:column;gap:8px;">'
        + '<div style="background:rgba(139,0,0,0.15);border-left:3px solid #8b0000;padding:7px 10px;border-radius:0 5px 5px 0;font-size:0.88em;color:rgba(255,200,200,0.9);"><span style="font-family:\'Cinzel\',serif;font-size:0.72em;color:#c0392b;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;">Crime</span>' + crime + '</div>'
        + '<div style="background:rgba(184,134,11,0.1);border-left:3px solid #b8860b;padding:7px 10px;border-radius:0 5px 5px 0;font-size:0.88em;color:rgba(255,240,180,0.85);"><span style="font-family:\'Cinzel\',serif;font-size:0.72em;color:#b8860b;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;">Distinguishing Marks</span>' + marks + '</div>'
        + '<div style="background:rgba(231,76,60,0.08);border-left:3px solid #e74c3c;padding:7px 10px;border-radius:0 5px 5px 0;font-size:0.88em;color:rgba(255,160,160,0.9);"><span style="font-family:\'Cinzel\',serif;font-size:0.72em;color:#c0392b;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;">⚠ Warning</span>' + warning + '</div>'
        + '<div style="background:rgba(0,0,0,0.18);border-left:3px solid ' + posterBorder + ';padding:7px 10px;border-radius:0 5px 5px 0;font-size:0.88em;color:rgba(255,255,255,0.8);"><span style="font-family:\'Cinzel\',serif;font-size:0.72em;color:' + posterBorder + ';text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;">Status</span><strong>' + statusLabel + '</strong> — ' + statusNote + '</div>'
        + '<div style="background:rgba(0,0,0,0.12);border:1px solid rgba(255,255,255,0.10);border-radius:6px;padding:10px;margin-top:2px;">'
        +   '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(255,248,220,0.75);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Investigation Notes</div>'
        +   '<div style="font-size:0.88em;color:rgba(255,255,255,0.75);line-height:1.55;">'
        +       '<div style="margin-bottom:6px;"><span style="color:rgba(255,248,220,0.7);font-weight:700;">Last seen:</span> ' + lastSeen + '</div>'
        +       '<div style="margin-bottom:6px;"><span style="color:rgba(255,248,220,0.7);font-weight:700;">Known associates:</span> ' + associates + '</div>'
        +       '<div style="margin-bottom:6px;"><span style="color:rgba(255,248,220,0.7);font-weight:700;">Rumor:</span> ' + rumor + '</div>'
        +       '<div style="margin-bottom:6px;"><span style="color:rgba(255,248,220,0.7);font-weight:700;">Jurisdiction:</span> ' + jurisdiction + '</div>'
        +       '<div><span style="color:rgba(255,248,220,0.7);font-weight:700;">Proof:</span> ' + proof + '</div>'
        +   '</div>'
        + '</div>'
        + '<div style="background:rgba(16,8,2,0.28);border:1px solid rgba(218,165,32,0.22);border-radius:6px;padding:10px;margin-top:8px;">'
        +   '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(255,220,150,0.85);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">📜 Manhunt Briefing</div>'
        +   '<div style="font-size:0.9em;color:rgba(255,240,205,0.84);line-height:1.6;">' + manhuntBriefing + '</div>'
        + '</div>'
        + '<div style="background:rgba(28,12,6,0.25);border:1px solid rgba(210,120,80,0.22);border-radius:6px;padding:10px;margin-top:8px;">'
        +   '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(255,170,130,0.88);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">🧭 Encounter Hooks</div>'
        +   '<div style="font-size:0.88em;color:rgba(255,220,205,0.82);line-height:1.58;">' + hooksText + '</div>'
        + '</div>'
        + '</div>'

        + '<div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08);">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:1.1em;font-weight:700;color:#daa520;">💰 ' + gold + '</div>'
        + '<div style="font-size:0.75em;color:rgba(255,255,255,0.35);">Posted by: City Watch · Guild · Crown</div>'
        + '</div>'
        + bountyCoherenceHtml
        + bountyPrepHtml

        + '</div></div>';

    window._swLastBountyCards.push({ name: name, cr: crDisplay, html: cardHtml, isBoss: isBoss, coherence: bountyCoherence, prep: bountyPrep });
    return cardHtml;
}

function _swBuildRevengeBountyCard(cardIdx) {
    var killedLog = (typeof _killedNPCsLog !== 'undefined' && Array.isArray(_killedNPCsLog)) ? _killedNPCsLog : [];
    var activeRevenge = (typeof _activeRevenge !== 'undefined') ? _activeRevenge : null;
    var fallenName = null;
    if (activeRevenge && activeRevenge.revengeKilledEntry && activeRevenge.revengeKilledEntry.npcName) fallenName = activeRevenge.revengeKilledEntry.npcName;
    if (!fallenName && killedLog.length) fallenName = killedLog[Math.floor(_swRand() * killedLog.length)].npcName;
    var targetName = fallenName ? ('Those Who Killed ' + fallenName) : 'The Party';
    var crime = fallenName
        ? ('Contract issued in retaliation for the death of ' + fallenName + '. The client seeks vengeance; the bounty targets the adventurers believed responsible.')
        : 'Contract issued by parties unknown. The bounty targets a group of adventurers; the client has not disclosed the reason.';
    var typeLabel = 'Dead or Alive';
    var typeBg = '#6a0000';
    var statusLabel = 'DEAD OR ALIVE';
    var statusNote = 'Either outcome accepted. The client may prefer one or more alive for questioning or public justice.';
    var cr = '5';
    var lvRange = _SW_BOUNTY_CR_TO_LEVEL[cr] || [5, 8];
    var gold = _SW_BOUNTY_CR_GOLD[cr] || '500 gp';
    var lastSeen = _swBountyPick([
        'Last seen in the same region where the incident occurred; locals may have noted their passage.',
        'Last seen departing the scene; descriptions may match the party.',
        'Last reported in a tavern or guild hall where they were overheard discussing the event.'
    ]);
    var rumor = 'Rumor: the client has hired other hunters; the party may be walking into an ambush.';
    var associates = 'Known associates: the client and any who seek the same vengeance; expect coordinated pursuit.';
    var jurisdiction = 'Jurisdiction: Private contract · Payment upon proof; the client may require a meeting.';
    var proof = 'Proof required: signet, distinctive gear, or a witness who can identify the targets.';
    var warning = 'Caution: the targets are experienced adventurers. Assume they are armed, magically capable, and may have allies.';
    var marks = 'Group of adventurers; composition and appearance may match the party.';
    var manhuntBriefing = 'This is a revenge contract. The client wants the party brought in or eliminated. Assume the party will be unaware until the bounty is in play—use that for tension, not necessarily a fair fight.';
    var hooksText = '• A stranger in town is asking about the party\'s whereabouts.<br>• Another bounty hunter attempts to claim the prize first.<br>• The client appears in person to raise the stakes or add conditions.';
    var bountyCoherence = swAnalyzeNarrativeCoherence('bounty', { name: targetName, crime: crime, warning: warning, textBlocks: [crime, marks, warning, statusLabel, statusNote, lastSeen, rumor, associates, jurisdiction, proof, manhuntBriefing, hooksText] });
    var bountyCoherenceHtml = swRenderCoherencePanel(bountyCoherence, '#ffd39a');
    var bountyPrep = swBuildSessionPrep('bounty', { name: targetName, objective: typeLabel, twist: warning });
    var bountyPrepHtml = swRenderSessionPrepPanel(bountyPrep, '#ffd7a8');
    var posterBg = 'linear-gradient(145deg,#1a0000,#2a0a00,#1a0800)';
    var posterBorder = '#8b0000';
    var threatLabel = 'Revenge Target';
    var threatColor = '#cc4444';
    var cardHtml = '<div data-bounty-idx="' + cardIdx + '" data-revenge-bounty="1" style="background:' + posterBg + ';border:2px solid ' + posterBorder + ';border-radius:10px;overflow:hidden;font-family:\'Crimson Text\',serif;">'
        + '<div style="background:rgba(0,0,0,0.5);border-bottom:1px solid rgba(139,0,0,0.5);padding:8px 12px;display:flex;align-items:center;gap:8px;">'
        + '<span style="font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;color:#ff8080;text-transform:uppercase;letter-spacing:1px;">☠ Revenge Bounty</span>'
        + '<button onclick="swActivateBounty(' + cardIdx + ')" style="padding:6px 16px;background:linear-gradient(145deg,#6a3a00,#a05800);color:#ffe8c0;border:1px solid rgba(218,165,32,0.7);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.74em;font-weight:700;">📌 Set as Active Bounty</button>'
        + '<button onclick="swSaveBountyOnly(' + cardIdx + ')" style="padding:6px 12px;background:rgba(184,134,11,0.2);color:#daa520;border:1px solid rgba(184,134,11,0.5);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.74em;font-weight:700;">💾 Save</button>'
        + '<button onclick="swPrintBountyCard(' + cardIdx + ')" style="padding:6px 12px;background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.55);border:1px solid rgba(255,255,255,0.2);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.74em;font-weight:700;">🖨 Print</button>'
        + '<button onclick="swDeleteBountyCard(' + cardIdx + ', this)" style="padding:6px 10px;background:rgba(139,0,0,0.25);color:rgba(255,120,120,0.8);border:1px solid rgba(139,0,0,0.45);border-radius:5px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.74em;font-weight:700;">✕</button>'
        + '</div>'
        + '<div style="background:linear-gradient(135deg,' + typeBg + ',' + typeBg + 'aa);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid ' + posterBorder + '66;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.82em;font-weight:700;color:#fff8dc;letter-spacing:2px;text-transform:uppercase;">📌 ' + typeLabel + '</div>'
        + '<div style="display:flex;gap:6px;align-items:center;">'
        + '<span style="background:rgba(0,0,0,0.4);border:1px solid ' + posterBorder + ';color:' + posterBorder + ';padding:2px 10px;border-radius:10px;font-family:\'Cinzel\',serif;font-size:0.72em;font-weight:700;">CR 5</span>'
        + '<span style="background:rgba(0,0,0,0.4);border:1px solid ' + threatColor + ';color:' + threatColor + ';padding:2px 10px;border-radius:10px;font-size:0.72em;font-weight:700;">' + threatLabel + '</span>'
        + '</div></div>'
        + '<div style="padding:14px 16px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:1.12em;font-weight:800;color:#fff8dc;margin-bottom:2px;text-shadow:1px 1px 3px rgba(0,0,0,0.8);">' + targetName + '</div>'
        + '<div style="font-size:0.78em;color:rgba(255,255,255,0.4);margin-bottom:12px;">Lvl ' + lvRange[0] + '–' + lvRange[1] + ' Party Recommended · Bounty on the adventurers</div>'
        + '<div style="display:flex;flex-direction:column;gap:8px;">'
        + '<div style="background:rgba(139,0,0,0.15);border-left:3px solid #8b0000;padding:7px 10px;border-radius:0 5px 5px 0;font-size:0.88em;color:rgba(255,200,200,0.9);"><span style="font-family:\'Cinzel\',serif;font-size:0.72em;color:#c0392b;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;">Crime</span>' + crime + '</div>'
        + '<div style="background:rgba(184,134,11,0.1);border-left:3px solid #b8860b;padding:7px 10px;border-radius:0 5px 5px 0;font-size:0.88em;color:rgba(255,240,180,0.85);"><span style="font-family:\'Cinzel\',serif;font-size:0.72em;color:#b8860b;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;">Distinguishing Marks</span>' + marks + '</div>'
        + '<div style="background:rgba(231,76,60,0.08);border-left:3px solid #e74c3c;padding:7px 10px;border-radius:0 5px 5px 0;font-size:0.88em;color:rgba(255,160,160,0.9);"><span style="font-family:\'Cinzel\',serif;font-size:0.72em;color:#c0392b;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;">⚠ Warning</span>' + warning + '</div>'
        + '<div style="background:rgba(0,0,0,0.18);border-left:3px solid ' + posterBorder + ';padding:7px 10px;border-radius:0 5px 5px 0;font-size:0.88em;color:rgba(255,255,255,0.8);"><span style="font-family:\'Cinzel\',serif;font-size:0.72em;color:' + posterBorder + ';text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;">Status</span><strong>' + statusLabel + '</strong> — ' + statusNote + '</div>'
        + '<div style="background:rgba(0,0,0,0.12);border:1px solid rgba(255,255,255,0.10);border-radius:6px;padding:10px;margin-top:2px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(255,248,220,0.75);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Investigation Notes</div>'
        + '<div style="font-size:0.88em;color:rgba(255,255,255,0.75);line-height:1.55;">'
        + '<div style="margin-bottom:6px;"><span style="color:rgba(255,248,220,0.7);font-weight:700;">Last seen:</span> ' + lastSeen + '</div>'
        + '<div style="margin-bottom:6px;"><span style="color:rgba(255,248,220,0.7);font-weight:700;">Known associates:</span> ' + associates + '</div>'
        + '<div style="margin-bottom:6px;"><span style="color:rgba(255,248,220,0.7);font-weight:700;">Rumor:</span> ' + rumor + '</div>'
        + '<div><span style="color:rgba(255,248,220,0.7);font-weight:700;">Jurisdiction:</span> ' + jurisdiction + '</div>'
        + '</div></div>'
        + '<div style="background:rgba(16,8,2,0.28);border:1px solid rgba(218,165,32,0.22);border-radius:6px;padding:10px;margin-top:8px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(255,220,150,0.85);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">📜 Manhunt Briefing</div>'
        + '<div style="font-size:0.9em;color:rgba(255,240,205,0.84);line-height:1.6;">' + manhuntBriefing + '</div>'
        + '</div>'
        + '<div style="background:rgba(28,12,6,0.25);border:1px solid rgba(210,120,80,0.22);border-radius:6px;padding:10px;margin-top:8px;">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:0.72em;color:rgba(255,170,130,0.88);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">🧭 Encounter Hooks</div>'
        + '<div style="font-size:0.88em;color:rgba(255,220,205,0.82);line-height:1.58;">' + hooksText + '</div>'
        + '</div>'
        + '</div>'
        + '<div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08);">'
        + '<div style="font-family:\'Cinzel\',serif;font-size:1.1em;font-weight:700;color:#daa520;">💰 ' + gold + '</div>'
        + '<div style="font-size:0.75em;color:rgba(255,255,255,0.35);">Posted by: Private contract (revenge)</div>'
        + '</div>'
        + bountyCoherenceHtml
        + bountyPrepHtml
        + '</div></div>';
    if (!window._swLastBountyCards) window._swLastBountyCards = [];
    window._swLastBountyCards[cardIdx] = { name: targetName, cr: '5', html: cardHtml, isBoss: false, coherence: bountyCoherence, prep: bountyPrep };
    return cardHtml;
}

/* ── Activate Location as Active Quest entry ── */
function swActivateLocation() {
    if (!_swLastLoc) { if(typeof showToast==='function') showToast('Generate a location first!','success'); return; }
    /* Save it first if not saved */
    swSaveLocation();
    /* Store as active location */
    window._activeLocation = _swLastLoc;
    if(typeof showToast==='function') showToast('📍 Active location: ' + (_swLastLoc.name||'Location'), 'success');
}

/* ── Save a bounty as a quest entry ── */
function swSaveBountyAsQuest(bountyData) {
    try {
        var qs = JSON.parse(localStorage.getItem('npcgen_quests')||'[]');
        var entry = {
            id: 'q_bounty_' + Date.now(),
            title: '📌 Bounty: ' + (bountyData.name || 'Unknown'),
            type: 'bounty',
            diff: bountyData.cr ? 'CR ' + bountyData.cr : 'unknown',
            date: new Date().toLocaleDateString(),
            isBounty: true,
            isMain: false,
            storyTitle: '',
            html: bountyData.html || ''
        };
        qs.push(entry);
        localStorage.setItem('npcgen_quests', JSON.stringify(qs));
        if(typeof _refreshSavedQuestsSidebar==='function') _refreshSavedQuestsSidebar();
        return entry;
    } catch(e){ return null; }
}

function swSaveBountyToSavedList(bountyData) {
    if (!bountyData) return null;
    var bounties = [];
    try { bounties = JSON.parse(localStorage.getItem('sw_savedBounties') || '[]'); } catch(e){}
    var entry = {
        id: 'bounty_' + Date.now(),
        name: bountyData.name,
        cr: bountyData.cr,
        isBoss: !!bountyData.isBoss,
        date: new Date().toLocaleDateString(),
        html: bountyData.html
    };
    var existing = bounties.findIndex(function(x){ return x.name === entry.name; });
    if (existing >= 0) {
        entry.id = bounties[existing].id || entry.id;
        bounties[existing] = entry;
    } else {
        bounties.push(entry);
    }
    if (bounties.length > 30) bounties = bounties.slice(-30);
    try { localStorage.setItem('sw_savedBounties', JSON.stringify(bounties)); } catch(e){ return null; }
    return entry;
}

function swActivateBounty(idx) {
    var cards = window._swLastBountyCards || [];
    var b = cards[idx];
    if (!b) { if(typeof showToast==='function') showToast('Bounty not found','warning'); return; }
    var saved = swSaveBountyToSavedList(b);
    if (!saved) { if(typeof showToast==='function') showToast('Failed to save bounty','warning'); return; }

    window._activeBounty = saved;
    if (typeof _saveActiveBounty === 'function') _saveActiveBounty();
    if (typeof _updateActiveBountyUI === 'function') _updateActiveBountyUI();

    var entry = swSaveBountyAsQuest(b);
    if (entry) {
        _activeQuest = entry;
        if(typeof _saveActiveQuest==='function') _saveActiveQuest();
        if(typeof _updateActiveQuestBanner==='function') _updateActiveQuestBanner();
    }
    if (typeof swRenderSavedBounties === 'function') swRenderSavedBounties();
    if (typeof _renderActiveBountyList === 'function') _renderActiveBountyList();
    if(typeof showToast==='function') showToast('⚡ Bounty activated and synced', 'success');
}

function swSaveBountyOnly(idx) {
    var cards = window._swLastBountyCards || [];
    var b = cards[idx];
    if (!b) { if(typeof showToast==='function') showToast('Bounty not found','warning'); return; }
    var saved = swSaveBountyToSavedList(b);
    if (!saved) { if(typeof showToast==='function') showToast('Failed to save bounty','warning'); return; }
    if (typeof showToast==='function') showToast('📌 Bounty saved: ' + (b.name||'Bounty'), 'success');
    swRenderSavedBounties();
    if (typeof _renderActiveBountyList === 'function') _renderActiveBountyList();
}

function swRenderSavedBounties() {
    var section = document.getElementById('swSavedBountiesSection');
    var list = document.getElementById('swSavedBountiesList');
    if (!list) return;
    var bounties = [];
    try { bounties = JSON.parse(localStorage.getItem('sw_savedBounties') || '[]'); } catch(e) {}
    if (!bounties.length) { if (section) section.style.display = 'none'; return; }
    if (section) section.style.display = 'block';
    list.innerHTML = bounties.slice().reverse().slice(0, 10).map(function(b) {
        return '<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:5px;border:1px solid rgba(218,165,32,0.25);background:rgba(218,165,32,0.07);margin-bottom:4px;" onmouseover="this.style.background=\'rgba(218,165,32,0.18)\'" onmouseout="this.style.background=\'rgba(218,165,32,0.07)\'">'
            + '<div style="flex:1;min-width:0;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.75em;color:#ffe88a;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+(b.isBoss?'💀 ':' 📌 ')+(b.name||'Unnamed Bounty')+'</div>'
            + '<div style="font-size:0.68em;color:rgba(218,165,32,0.5);">CR '+(b.cr||'?')+' · '+(b.date||'')+'</div>'
            + '</div>'
            + '<button onclick="event.stopPropagation();swDeleteBounty(\'' + b.id + '\')" style="background:none;border:1px solid rgba(139,0,0,0.5);color:rgba(240,128,128,0.7);padding:2px 8px;border-radius:4px;cursor:pointer;font-size:0.75em;flex-shrink:0;margin-left:6px;">✕</button>'
            + '</div>';
    }).join('');
}

function swDeleteBounty(id) {
    try {
        var bounties = JSON.parse(localStorage.getItem('sw_savedBounties') || '[]');
        var beforeBounties = JSON.parse(JSON.stringify(bounties || []));
        bounties = bounties.filter(function(b){ return b.id !== id; });
        localStorage.setItem('sw_savedBounties', JSON.stringify(bounties));
        swRenderSavedBounties();
        if (typeof _renderActiveBountyList === 'function') _renderActiveBountyList();
        dmPushUndoAction('Delete bounty', function() {
            localStorage.setItem('sw_savedBounties', JSON.stringify(beforeBounties || []));
            swRenderSavedBounties();
            if (typeof _renderActiveBountyList === 'function') _renderActiveBountyList();
        });
        if (typeof showToast === 'function') showToast('Bounty deleted', 'success');
    } catch(e) {}
}

/* Patch _updateActiveQuestBanner to also refresh story tab bar */
(function() {
    var _orig = window._updateActiveQuestBanner;
    window._updateActiveQuestBanner = function() {
        if (_orig) _orig.apply(this, arguments);
        /* Update story tab inline bar */
        var bar  = document.getElementById('swStoryActiveQuestBar');
        var name = document.getElementById('swStoryActiveQuestName');
        if (!bar) return;
        if (window._activeQuest) {
            bar.style.display = 'flex';
            if (name) name.textContent = (_activeQuest.isMain ? '📖 ' : '') + (_activeQuest.title || 'Unnamed Quest');
        } else {
            bar.style.display = 'none';
        }
    };
})();

/* ─── INIT ────────────────────────────────────────────────────── */
setTimeout(function() {
    renderHeaderPlayerCards();
    if (typeof swSwitchTab === 'function') swSwitchTab('story');
    if (typeof swInitSeedUI === 'function') swInitSeedUI();
}, 900);

</script>

<!-- ══ UNIVERSAL CONTENT POPUP MODAL ══ -->
<div id="universalContentPopup" style="display:none;position:fixed;inset:0;z-index:19999;background:rgba(0,0,0,0.92);backdrop-filter:blur(6px);align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;">
    <div style="background:linear-gradient(145deg,#1a1a2e,#16213e);border:2px solid var(--gold);border-radius:12px;width:760px;max-width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.8);margin:auto;">
        <div style="background:linear-gradient(135deg,#1a0a2e,#2d0a4e,#3a0000);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;border-radius:10px 10px 0 0;border-bottom:2px solid rgba(184,134,11,0.4);">
            <div id="ucpTitle" style="font-family:'Cinzel',serif;font-size:1.05em;font-weight:700;color:#fff8dc;letter-spacing:2px;text-transform:uppercase;"></div>
            <button onclick="closeContentPopup()" style="background:none;border:1px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.7);padding:4px 12px;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;">✕ Close</button>
        </div>
        <div style="display:flex;gap:8px;padding:10px 20px;background:rgba(0,0,0,0.3);border-bottom:1px solid rgba(184,134,11,0.2);flex-wrap:wrap;">
            <button id="ucpMakeActiveBtn" style="display:none;padding:7px 16px;background:linear-gradient(145deg,#1a3a6a,#2a4a8a);color:#d0e8ff;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;">⚡ Set Active</button>
            <button id="ucpSaveBtn" style="display:none;padding:7px 16px;background:linear-gradient(145deg,var(--gold),#966f0a);color:white;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;">💾 Save</button>
            <button onclick="closeContentPopup()" style="padding:7px 16px;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.15);border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;">Close</button>
        </div>
        <div id="ucpBody" style="padding:20px;max-height:70vh;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--gold) #1a1a2e;"></div>
    </div>
</div>

<!-- ══ PORTAL DROPDOWNS (fixed position, always on top) ══ -->
<div id="activeQuestDropdown" style="display:none;position:fixed;min-width:340px;max-width:420px;background:rgba(4,6,18,0.99);border:1px solid rgba(100,160,255,0.7);border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,0.9),0 0 0 1px rgba(100,160,255,0.15);padding:10px 12px;z-index:99999;">
    <div style="font-family:'Cinzel',serif;font-size:0.68em;color:#6090c0;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:8px;">⚡ Active Quests</div>
    <div id="activeQuestList" style="max-height:320px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(100,160,255,0.4) transparent;"></div>
</div>

<div id="activeBountyDropdown" style="display:none;position:fixed;min-width:320px;max-width:420px;background:rgba(18,10,0,0.99);border:1px solid rgba(218,165,32,0.7);border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,0.9),0 0 0 1px rgba(218,165,32,0.1);padding:0;z-index:99999;overflow:hidden;">
    <div style="background:linear-gradient(135deg,rgba(100,55,0,0.6),rgba(60,30,0,0.8));padding:10px 14px;border-bottom:1px solid rgba(218,165,32,0.25);display:flex;align-items:center;justify-content:space-between;">
        <div style="font-family:'Cinzel',serif;font-size:0.68em;color:#daa520;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;">📌 Active Bounties</div>
        <button onclick="document.getElementById('activeBountyDropdown').style.display='none'" style="background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;font-size:1em;padding:0;line-height:1;">✕</button>
    </div>
    <div style="padding:10px 12px;">
        <div id="activeBountyCurrentDisplay" style="font-family:'Crimson Text',serif;font-size:0.95em;color:#ffe8a0;font-style:italic;margin-bottom:8px;padding:8px 10px;background:rgba(218,165,32,0.1);border:1px solid rgba(218,165,32,0.2);border-radius:6px;">No active bounty set</div>
        <button onclick="clearActiveBounty()" id="activeBountyClearBtn" style="display:none;padding:4px 12px;background:rgba(139,0,0,0.45);color:#ffb0b0;border:1px solid rgba(220,20,60,0.6);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.68em;font-weight:700;margin-bottom:8px;">✕ Clear Active Bounty</button>
        <div style="font-family:'Cinzel',serif;font-size:0.62em;color:rgba(218,165,32,0.6);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Saved Bounties — click to set active</div>
        <div id="activeBountyList" style="max-height:240px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(218,165,32,0.4) transparent;">
            <div style="color:rgba(255,255,255,0.28);font-size:0.78em;text-align:center;padding:14px;font-style:italic;">No saved bounties yet.<br>Generate &amp; save bounties first.</div>
        </div>
    </div>
</div>

<div id="activeLocationDropdown" style="display:none;position:fixed;min-width:320px;max-width:420px;background:rgba(0,14,4,0.99);border:1px solid rgba(100,200,100,0.65);border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,0.95),0 0 0 1px rgba(100,200,100,0.1);padding:0;z-index:99999;overflow:hidden;">
    <div style="background:linear-gradient(135deg,rgba(0,60,20,0.6),rgba(0,40,10,0.8));padding:10px 14px;border-bottom:1px solid rgba(100,200,100,0.25);display:flex;align-items:center;justify-content:space-between;">
        <div style="font-family:'Cinzel',serif;font-size:0.68em;color:#80e880;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;">📍 Active Locations</div>
        <button onclick="document.getElementById('activeLocationDropdown').style.display='none'" style="background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;font-size:1em;padding:0;line-height:1;">✕</button>
    </div>
    <div style="padding:10px 12px;">
        <div id="activeLocationCurrentDisplay" style="font-family:'Crimson Text',serif;font-size:0.95em;color:#c8ffc8;font-style:italic;margin-bottom:8px;padding:8px 10px;background:rgba(100,180,100,0.1);border:1px solid rgba(100,180,100,0.2);border-radius:6px;">No active location set</div>
        <button onclick="clearActiveLocation()" id="activeLocationClearBtn" style="display:none;padding:4px 12px;background:rgba(139,0,0,0.45);color:#ffb0b0;border:1px solid rgba(220,20,60,0.6);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.68em;font-weight:700;margin-bottom:8px;">✕ Clear Active Location</button>
        <div style="font-family:'Cinzel',serif;font-size:0.62em;color:rgba(100,200,100,0.6);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Saved Locations — click to set active</div>
        <div id="activeLocationList" style="max-height:240px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(100,200,100,0.4) transparent;">
            <div style="color:rgba(255,255,255,0.28);font-size:0.78em;text-align:center;padding:14px;font-style:italic;">No saved locations yet.<br>Generate &amp; save a location first.</div>
        </div>
    </div>
</div>

<div id="activeRevengeDropdown" style="display:none;position:fixed;min-width:320px;max-width:420px;background:rgba(18,0,0,0.99);border:1px solid rgba(220,80,80,0.7);border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,0.9),0 0 0 1px rgba(139,0,0,0.2);padding:0;z-index:99999;overflow:hidden;">
    <div style="background:linear-gradient(135deg,rgba(80,0,0,0.7),rgba(40,0,0,0.9));padding:10px 14px;border-bottom:1px solid rgba(220,80,80,0.3);display:flex;align-items:center;justify-content:space-between;">
        <div style="font-family:'Cinzel',serif;font-size:0.68em;color:#f08080;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;">☠ Active Revenge</div>
        <button onclick="document.getElementById('activeRevengeDropdown').style.display='none'" style="background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;font-size:1em;padding:0;line-height:1;">✕</button>
    </div>
    <div style="padding:10px 12px;">
        <div id="activeRevengeCurrentDisplay" style="font-family:'Crimson Text',serif;font-size:0.95em;color:#ffcccc;font-style:italic;margin-bottom:8px;padding:8px 10px;background:rgba(139,0,0,0.15);border:1px solid rgba(220,80,80,0.3);border-radius:6px;">No active revenge set</div>
        <button onclick="clearActiveRevenge()" id="activeRevengeClearBtn" style="display:none;padding:4px 12px;background:rgba(139,0,0,0.45);color:#ffb0b0;border:1px solid rgba(220,20,60,0.6);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.68em;font-weight:700;margin-bottom:8px;">✕ Clear Active Revenge</button>
        <div style="font-family:'Cinzel',serif;font-size:0.62em;color:rgba(255,150,150,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Saved Revenge Quests — click to load &amp; set active</div>
        <div id="activeRevengeList" style="max-height:240px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(220,80,80,0.4) transparent;"></div>
    </div>
</div>

<div id="activeStoryDropdown" style="display:none;position:fixed;min-width:340px;max-width:440px;background:rgba(8,6,22,0.98);border:1px solid rgba(160,100,255,0.65);border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,0.95),0 0 0 1px rgba(160,100,255,0.1);padding:0;z-index:99999;overflow:hidden;">
    <!-- Header -->
    <div style="background:linear-gradient(135deg,rgba(80,30,160,0.6),rgba(40,10,80,0.8));padding:10px 14px;border-bottom:1px solid rgba(160,100,255,0.25);display:flex;align-items:center;justify-content:space-between;">
        <div style="font-family:'Cinzel',serif;font-size:0.68em;color:#c0a0ff;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;">📖 Active Story</div>
        <button onclick="document.getElementById('activeStoryDropdown').style.display='none'" style="background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;font-size:1em;padding:0;line-height:1;">✕</button>
    </div>
    <!-- Active story display -->
    <div id="activeStoryCurrentPanel" style="padding:12px 14px;border-bottom:1px solid rgba(160,100,255,0.15);">
        <div id="activeStoryCurrentDisplay" style="font-family:'Crimson Text',serif;font-size:1em;color:#fff8dc;font-style:italic;margin-bottom:6px;">No story active</div>
        <div id="activeStoryCurrentMeta" style="font-size:0.72em;color:rgba(200,160,255,0.5);font-family:'Cinzel',serif;margin-bottom:8px;"></div>
        <button onclick="clearActiveStory()" id="activeStoryClearBtn" style="display:none;padding:4px 12px;background:rgba(139,0,0,0.45);color:#ffb0b0;border:1px solid rgba(220,20,60,0.6);border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.68em;font-weight:700;">✕ Clear Active Story</button>
    </div>
    <!-- Saved stories list -->
    <div style="padding:8px 10px;">
        <div style="font-family:'Cinzel',serif;font-size:0.62em;color:rgba(160,100,255,0.6);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;padding:0 2px;">Saved Stories — click to set active</div>
        <div id="activeStoryList" style="max-height:240px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(160,100,255,0.4) transparent;"></div>
    </div>
</div>

<script>
/* ══ PORTAL DROPDOWN POSITIONING ══ */

function _positionDropdownBelowBtn(dropdown, triggerBtn) {
    if (!dropdown || !triggerBtn) return;
    var rect = triggerBtn.getBoundingClientRect();
    var ddW  = dropdown.offsetWidth || 340;
    var left = rect.right - ddW;
    if (left < 8) left = 8;
    if (left + ddW > window.innerWidth - 8) left = window.innerWidth - ddW - 8;
    var top = rect.bottom + 6;
    var ddH = dropdown.offsetHeight || 400;
    if (top + ddH > window.innerHeight - 10) {
        top = rect.top - ddH - 6;
        if (top < 10) top = rect.bottom + 6;
    }
    dropdown.style.top  = top + 'px';
    dropdown.style.left = left + 'px';
}

/* ── Active Quest dropdown ── */
window.toggleActiveQuestDropdown = function() {
    var dd  = document.getElementById('activeQuestDropdown');
    var btn = document.getElementById('activeQuestTriggerBtn');
    if (!dd) return;
    if (dd.style.display !== 'none') { dd.style.display = 'none'; return; }
    dd.style.display = 'block';
    _positionDropdownBelowBtn(dd, btn);
    _renderActiveQuestList();
    setTimeout(function() {
        function _aqClose(e) {
            if (!dd.contains(e.target) && e.target !== btn && !(btn && btn.contains(e.target))) {
                dd.style.display = 'none';
                document.removeEventListener('click', _aqClose);
            }
        }
        document.addEventListener('click', _aqClose);
    }, 60);
};

/* ── Active Story dropdown ── */
window.toggleActiveStoryDropdown = function() {
    var dd  = document.getElementById('activeStoryDropdown');
    var btn = document.getElementById('activeStoryTriggerBtn');
    if (!dd) return;
    if (dd.style.display !== 'none') { dd.style.display = 'none'; return; }
    dd.style.display = 'block';
    _positionDropdownBelowBtn(dd, btn);
    _renderActiveStoryList();
    setTimeout(function() {
        function _asClose(e) {
            if (!dd.contains(e.target) && e.target !== btn && !(btn && btn.contains(e.target))) {
                dd.style.display = 'none';
                document.removeEventListener('click', _asClose);
            }
        }
        document.addEventListener('click', _asClose);
    }, 60);
};

/* ── Render active story dropdown content ── */
window._renderActiveStoryList = function() {
    var listEl   = document.getElementById('activeStoryList');
    var currEl   = document.getElementById('activeStoryCurrentDisplay');
    var metaEl   = document.getElementById('activeStoryCurrentMeta');
    var clearBtn = document.getElementById('activeStoryClearBtn');
    var labelEl  = document.getElementById('activeStoryHeaderLabel');

    var active = window._swActiveStory || null;

    /* Update header button label */
    if (labelEl) {
        labelEl.textContent = active ? '📖 ' + (active.title || 'Story').substring(0, 20) : 'Active Story';
    }

    /* Update current display panel */
    if (currEl) currEl.textContent = active ? (active.title || 'Untitled Story') : 'No active story — select one below';
    if (currEl) {
        currEl.style.cursor = active ? 'pointer' : 'default';
        currEl.onclick = active ? function(){ swOpenActiveStoryDetails(active.id); } : null;
    }
    if (metaEl && active) {
        metaEl.textContent = [(active.genre || '').replace(/_/g,' '), (active.chapters || []).length + ' chapters', active.created || ''].filter(Boolean).join(' · ');
    } else if (metaEl) {
        metaEl.textContent = '';
    }
    if (clearBtn) clearBtn.style.display = active ? 'inline-block' : 'none';

    if (!listEl) return;

    var stories = window._swSavedStories || [];
    if (!stories.length) {
        listEl.innerHTML = '<div style="color:rgba(255,255,255,0.28);font-size:0.78em;text-align:center;padding:14px;font-style:italic;">No saved stories yet.<br>Generate &amp; save a story first.</div>';
        return;
    }

    listEl.innerHTML = stories.map(function(s) {
        var isAct = active && active.id === s.id;
        return '<div onclick="swOpenActiveStoryDetails(\'' + s.id + '\')" '
            + 'style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:7px;cursor:pointer;border:1px solid ' + (isAct ? 'rgba(160,100,255,0.7)' : 'rgba(255,255,255,0.06)') + ';background:' + (isAct ? 'rgba(100,50,200,0.3)' : 'rgba(255,255,255,0.03)') + ';margin-bottom:5px;transition:all 0.15s;" '
            + 'onmouseover="this.style.background=\'rgba(100,50,180,0.2)\'" onmouseout="this.style.background=\'' + (isAct ? 'rgba(100,50,200,0.3)' : 'rgba(255,255,255,0.03)') + '\'">'
            + '<div style="flex:1;min-width:0;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.76em;font-weight:700;color:' + (isAct ? '#d0a0ff' : '#fff8dc') + ';white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (isAct ? '📖 ' : '') + (s.title || 'Untitled').substring(0, 34) + '</div>'
            + '<div style="font-size:0.63em;color:rgba(200,160,255,0.42);margin-top:2px;">' + (s.genre || '').replace(/_/g, ' ') + ' · ' + (s.chapters || []).length + ' chapters · ' + (s.created || '') + '</div>'
            + '</div>'
            + (isAct
                ? '<span style="color:#a060ff;font-size:0.65em;font-family:\'Cinzel\',serif;flex-shrink:0;background:rgba(100,50,200,0.3);padding:2px 7px;border-radius:4px;border:1px solid rgba(160,100,255,0.5);">ACTIVE</span>'
                : '<span style="color:rgba(160,100,255,0.5);font-size:0.65em;font-family:\'Cinzel\',serif;flex-shrink:0;">Set →</span>')
            + '</div>';
    }).join('');
};

/* ── Patch clearActiveStory to update header btn ── */
(function() {
    var _origClear = window.clearActiveStory;
    window.clearActiveStory = function() {
        if (_origClear) _origClear.apply(this, arguments);
        window._renderActiveStoryList();
        var dd = document.getElementById('activeStoryDropdown');
        if (dd) dd.style.display = 'none';
    };
})();

/* ── Patch setActiveStory to update header btn ── */
(function() {
    var _origSet = window.setActiveStory;
    window.setActiveStory = function(sid) {
        if (_origSet) _origSet.apply(this, arguments);
        setTimeout(function() { window._renderActiveStoryList(); }, 50);
    };
})();

/* ── Init header label on load ── */
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() { if (window._renderActiveStoryList) window._renderActiveStoryList(); }, 200);
});

/* ══ VILLAIN GENERATION FROM STORY / BOUNTY ══ */

function swGenerateVillainsFromStory() {
    var story = window._swCurrentStory;
    var count = story ? 2 : 1;
    if (typeof showToast === 'function') showToast('☠ Generating ' + count + ' villain' + (count > 1 ? 's' : '') + '…', 'success');

    var bossCb = document.getElementById('bossMode');
    var prevBoss = bossCb ? bossCb.checked : false;
    if (bossCb) bossCb.checked = true;

    var newNPCs = [];
    for (var i = 0; i < count; i++) {
        var npc = createNPC(true);
        if (story) {
            npc.dmNotes = '☠ Villain for story: "' + (story.title || 'Current Story') + '"'
                + (story.antagonist ? '\nAntagonist archetype: ' + story.antagonist : '')
                + (story.goal ? '\nOpposing goal: ' + story.goal : '');
        }
        newNPCs.push(npc);
    }
    if (bossCb) bossCb.checked = prevBoss;

    swBridgeGenNPCs(newNPCs, count + ' Story Villain' + (count > 1 ? 's' : ''));

    /* Log to Quest NPC tab */
    setTimeout(function() {
        newNPCs.forEach(function(npc) {
            if (typeof _addToQuestNPCLog === 'function') _addToQuestNPCLog(npc, 'story', story ? (story.title || 'Story') : 'Story', true, story || null);
        });
    }, 500);
}

function swGenerateVillainFromBounty(cardIdx) {
    var cards = window._swLastBountyCards || [];
    var card  = cards[cardIdx];
    if (!card) { if (typeof showToast === 'function') showToast('No bounty card found', 'warning'); return; }

    if (typeof showToast === 'function') showToast('🎯 Generating wanted NPC for bounty…', 'success');

    var bossCb = document.getElementById('bossMode');
    var prevBoss = bossCb ? bossCb.checked : false;
    if (bossCb) bossCb.checked = true;

    var npc = createNPC(true);
    npc.dmNotes = '🎯 Bounty Target NPC'
        + (card.name ? '\nBounty name: ' + card.name : '')
        + (card.crime ? '\nCrime: ' + card.crime : '')
        + (card.cr    ? '\nCR: ' + card.cr : '');

    if (bossCb) bossCb.checked = prevBoss;

    swBridgeGenNPCs([npc], 'Bounty Target' + (card.name ? ' — ' + card.name : ''));

    /* Log to Quest NPC tab */
    setTimeout(function() {
        if (typeof _addToQuestNPCLog === 'function') _addToQuestNPCLog(npc, 'bounty', card.name || 'Bounty', true, null);
    }, 500);
}


/* Close portals on scroll/resize */
window.addEventListener('scroll', function() {
    ['activeQuestDropdown','activeStoryDropdown','activeBountyDropdown','activeLocationDropdown','activeRevengeDropdown'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el && el.style.display !== 'none') el.style.display = 'none';
    });
}, true);
window.addEventListener('resize', function() {
    ['activeQuestDropdown','activeStoryDropdown','activeBountyDropdown','activeLocationDropdown','activeRevengeDropdown'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
});

/* ══ ACTIVE BOUNTY STATE ══ */
window._activeBounty = null;
(function() {
    try { window._activeBounty = JSON.parse(localStorage.getItem('sw_activeBounty') || 'null'); } catch(e){}
})();

function _saveActiveBounty() {
    try { localStorage.setItem('sw_activeBounty', JSON.stringify(window._activeBounty)); } catch(e){}
}

function clearActiveBounty() {
    window._activeBounty = null;
    _saveActiveBounty();
    _updateActiveBountyUI();
    var dd = document.getElementById('activeBountyDropdown');
    if (dd) dd.style.display = 'none';
    if (typeof showToast === 'function') showToast('Active bounty cleared', 'success');
}

function _updateActiveBountyUI() {
    var ind = document.getElementById('activeBountyIndicator');
    var clearBtn = document.getElementById('activeBountyClearBtn');
    var display = document.getElementById('activeBountyCurrentDisplay');
    if (ind) ind.textContent = window._activeBounty ? ' ◆ ' : '';
    if (clearBtn) clearBtn.style.display = window._activeBounty ? 'inline-block' : 'none';
    if (display) display.textContent = window._activeBounty ? ('📌 ' + (window._activeBounty.name || 'Bounty') + ' (CR ' + (window._activeBounty.cr || '?') + ')') : 'No active bounty set';
    if (display) {
        display.style.cursor = window._activeBounty ? 'pointer' : 'default';
        display.onclick = window._activeBounty ? function(){ swOpenActiveBountyDetails(window._activeBounty.id); } : null;
    }
}

function _renderActiveBountyList() {
    var listEl = document.getElementById('activeBountyList');
    if (!listEl) return;
    // Load saved bounties from localStorage
    var bounties = [];
    try { bounties = JSON.parse(localStorage.getItem('sw_savedBounties') || '[]'); } catch(e){}
    if (!bounties.length) {
        listEl.innerHTML = '<div style="color:rgba(255,255,255,0.28);font-size:0.78em;text-align:center;padding:14px;font-style:italic;">No saved bounties yet.<br>Generate &amp; save bounties first.</div>';
        return;
    }
    listEl.innerHTML = bounties.map(function(b, i) {
        var isAct = window._activeBounty && window._activeBounty.id === b.id;
        return '<div onclick="swOpenActiveBountyDetails(\'' + b.id + '\')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:7px;cursor:pointer;border:1px solid ' + (isAct ? 'rgba(218,165,32,0.7)' : 'rgba(255,255,255,0.06)') + ';background:' + (isAct ? 'rgba(120,80,0,0.35)' : 'rgba(255,255,255,0.03)') + ';margin-bottom:5px;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(120,80,0,0.2)\'" onmouseout="this.style.background=\'' + (isAct ? 'rgba(120,80,0,0.35)' : 'rgba(255,255,255,0.03)') + '\'">'
            + '<div style="flex:1;min-width:0;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.76em;font-weight:700;color:' + (isAct ? '#ffe060' : '#fff8dc') + ';white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (isAct ? '📌 ' : '') + (b.name || 'Unknown').substring(0, 34) + '</div>'
            + '<div style="font-size:0.63em;color:rgba(218,165,32,0.5);margin-top:2px;">CR ' + (b.cr || '?') + ' · ' + (b.date || '') + '</div>'
            + '</div>'
            + (isAct ? '<span style="color:#daa520;font-size:0.65em;font-family:\'Cinzel\',serif;flex-shrink:0;background:rgba(120,80,0,0.4);padding:2px 7px;border-radius:4px;border:1px solid rgba(218,165,32,0.5);">ACTIVE</span>' : '<span style="color:rgba(218,165,32,0.5);font-size:0.65em;font-family:\'Cinzel\',serif;flex-shrink:0;">Set →</span>')
            + '</div>';
    }).join('');
}

function setActiveBountyById(id) {
    var bounties = [];
    try { bounties = JSON.parse(localStorage.getItem('sw_savedBounties') || '[]'); } catch(e){}
    var b = bounties.find(function(x){ return x.id === id; });
    if (!b) return;
    window._activeBounty = b;
    _saveActiveBounty();
    _updateActiveBountyUI();
    _renderActiveBountyList();
    if (typeof showToast === 'function') showToast('📌 Active bounty: ' + (b.name || 'Bounty'), 'success');
}

window.toggleActiveBountyDropdown = function() {
    var dd  = document.getElementById('activeBountyDropdown');
    var btn = document.getElementById('activeBountyTriggerBtn');
    if (!dd) return;
    if (dd.style.display !== 'none') { dd.style.display = 'none'; return; }
    dd.style.display = 'block';
    _positionDropdownBelowBtn(dd, btn);
    _updateActiveBountyUI();
    _renderActiveBountyList();
    setTimeout(function() {
        function _abClose(e) {
            if (!dd.contains(e.target) && e.target !== btn && !(btn && btn.contains(e.target))) {
                dd.style.display = 'none';
                document.removeEventListener('click', _abClose);
            }
        }
        document.addEventListener('click', _abClose);
    }, 60);
};

/* ══ ACTIVE LOCATION STATE ══ */
window._activeLocationSaved = null;
(function() {
    try { window._activeLocationSaved = JSON.parse(localStorage.getItem('sw_activeLocation') || 'null'); } catch(e){}
})();

function _saveActiveLocation() {
    try { localStorage.setItem('sw_activeLocation', JSON.stringify(window._activeLocationSaved)); } catch(e){}
}

function clearActiveLocation() {
    window._activeLocationSaved = null;
    _saveActiveLocation();
    _updateActiveLocationUI();
    var dd = document.getElementById('activeLocationDropdown');
    if (dd) dd.style.display = 'none';
    if (typeof showToast === 'function') showToast('Active location cleared', 'success');
}

function _updateActiveLocationUI() {
    var ind = document.getElementById('activeLocationIndicator');
    var clearBtn = document.getElementById('activeLocationClearBtn');
    var display = document.getElementById('activeLocationCurrentDisplay');
    if (ind) ind.textContent = window._activeLocationSaved ? ' ◆ ' : '';
    if (clearBtn) clearBtn.style.display = window._activeLocationSaved ? 'inline-block' : 'none';
    if (display) display.textContent = window._activeLocationSaved ? ((window._activeLocationSaved.icon || '📍') + ' ' + (window._activeLocationSaved.name || 'Location')) : 'No active location set';
    if (display) {
        display.style.cursor = window._activeLocationSaved ? 'pointer' : 'default';
        display.onclick = window._activeLocationSaved ? function(){ swOpenActiveLocationDetails(window._activeLocationSaved.id); } : null;
    }
}

function _renderActiveLocationList() {
    var listEl = document.getElementById('activeLocationList');
    if (!listEl) return;
    var locs = window._swSavedLocs || [];
    if (!locs.length) {
        listEl.innerHTML = '<div style="color:rgba(255,255,255,0.28);font-size:0.78em;text-align:center;padding:14px;font-style:italic;">No saved locations yet.<br>Generate &amp; save a location first.</div>';
        return;
    }
    listEl.innerHTML = locs.map(function(l) {
        var isAct = window._activeLocationSaved && window._activeLocationSaved.id === l.id;
        return '<div onclick="swOpenActiveLocationDetails(\'' + l.id + '\')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:7px;cursor:pointer;border:1px solid ' + (isAct ? 'rgba(100,200,100,0.7)' : 'rgba(255,255,255,0.06)') + ';background:' + (isAct ? 'rgba(0,80,30,0.35)' : 'rgba(255,255,255,0.03)') + ';margin-bottom:5px;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(0,80,30,0.2)\'" onmouseout="this.style.background=\'' + (isAct ? 'rgba(0,80,30,0.35)' : 'rgba(255,255,255,0.03)') + '\'">'
            + '<div style="flex:1;min-width:0;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.76em;font-weight:700;color:' + (isAct ? '#a0ffa0' : '#c8ffc8') + ';white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (isAct ? '📍 ' : (l.icon || '🏛') + ' ') + (l.name || 'Location').substring(0, 34) + '</div>'
            + '<div style="font-size:0.63em;color:rgba(100,200,100,0.5);margin-top:2px;">' + (l.type || '').replace(/_/g,' ') + ' · ' + (l.date || '') + '</div>'
            + '</div>'
            + (isAct ? '<span style="color:#60d860;font-size:0.65em;font-family:\'Cinzel\',serif;flex-shrink:0;background:rgba(0,80,30,0.4);padding:2px 7px;border-radius:4px;border:1px solid rgba(100,200,100,0.5);">ACTIVE</span>' : '<span style="color:rgba(100,200,100,0.5);font-size:0.65em;font-family:\'Cinzel\',serif;flex-shrink:0;">Set →</span>')
            + '</div>';
    }).join('');
}

function setActiveLocationById(id) {
    var locs = window._swSavedLocs || [];
    var l = locs.find(function(x){ return x.id === id; });
    if (!l) return;
    window._swLastLoc = l;
    window._activeLocationSaved = l;
    _saveActiveLocation();
    _updateActiveLocationUI();
    _renderActiveLocationList();
    if (typeof showToast === 'function') showToast('📍 Active location: ' + (l.name || 'Location'), 'success');
}

window.toggleActiveLocationDropdown = function() {
    var dd  = document.getElementById('activeLocationDropdown');
    var btn = document.getElementById('activeLocationTriggerBtn');
    if (!dd) return;
    if (dd.style.display !== 'none') { dd.style.display = 'none'; return; }
    dd.style.display = 'block';
    _positionDropdownBelowBtn(dd, btn);
    _updateActiveLocationUI();
    _renderActiveLocationList();
    setTimeout(function() {
        function _alClose(e) {
            if (!dd.contains(e.target) && e.target !== btn && !(btn && btn.contains(e.target))) {
                dd.style.display = 'none';
                document.removeEventListener('click', _alClose);
            }
        }
        document.addEventListener('click', _alClose);
    }, 60);
};

/* ══ UPDATE swActivateBounty to use new bounty system ══ */
var _origSwActivateBounty = window.swActivateBounty;
window.swActivateBounty = function(idx) {
    if (_origSwActivateBounty) _origSwActivateBounty.call(this, idx);
};

/* ══ UPDATE swActivateLocation to use new location system ══ */
var _origSwActivateLocation = window.swActivateLocation;
window.swActivateLocation = function() {
    if (_origSwActivateLocation) _origSwActivateLocation.apply(this, arguments);
    if (window._swLastLoc) {
        window._activeLocationSaved = window._swLastLoc;
        _saveActiveLocation();
        _updateActiveLocationUI();
    }
};

/* Also save bounty when swSaveBountyOnly is called */
var _origSaveBountyOnly = window.swSaveBountyOnly;
window.swSaveBountyOnly = function(idx) {
    if (_origSaveBountyOnly) _origSaveBountyOnly.apply(this, arguments);
    if (typeof swRenderSavedBounties === 'function') swRenderSavedBounties();
};

/* ══ NPC POPUP MODAL ══ */
function _showNPCPopup(title, subtitle) {
    var modal = document.getElementById('npcGeneratorPopup');
    if (!modal) return;
    var titleEl = document.getElementById('ngpTitle');
    var subtitleEl = document.getElementById('ngpSubtitle');
    var bodyEl = document.getElementById('ngpBody');
    if (titleEl) titleEl.textContent = title;
    if (subtitleEl) subtitleEl.textContent = subtitle || '';
    if (bodyEl) bodyEl.innerHTML = '<div style="color:rgba(255,255,255,0.4);text-align:center;padding:40px;font-style:italic;font-size:1.1em;">⚔ Forging characters…</div>';
    modal.style.display = 'flex';
}
function _closeNPCPopup() {
    var modal = document.getElementById('npcGeneratorPopup');
    if (modal) modal.style.display = 'none';
}
function _populateNPCPopup() {
    var bodyEl = document.getElementById('ngpBody');
    if (!bodyEl) return;
    var displayArea = document.getElementById('displayArea');
    if (!displayArea) { bodyEl.innerHTML = '<div style="color:rgba(255,80,80,0.7);text-align:center;padding:30px;">Could not retrieve NPC data.</div>'; return; }
    // Grab all active NPC cards
    var cards = displayArea.querySelectorAll('.npc-card.active');
    if (!cards.length) { bodyEl.innerHTML = '<div style="color:rgba(255,80,80,0.7);text-align:center;padding:30px;">No NPC cards found. Check the NPC tab.</div>'; return; }
    var html = '';
    cards.forEach(function(c) { html += '<div style="margin-bottom:22px;">' + c.outerHTML + '</div>'; });
    bodyEl.innerHTML = html;
    // Make all inner cards visible (they may be display:none from clone)
    bodyEl.querySelectorAll('.npc-card').forEach(function(c){ c.style.display='block'; });
}

/* ══ GENERATE QUEST NPCs ══ */
function swGenerateQuestNPCs() {
    var quest = window._swLastQuest;
    var isMain = !!(window._swStoryLinked || (quest && quest.isMain));
    var bossCount    = isMain ? 1 : 0;
    var regularCount = 2;
    var questTitle   = quest ? (quest.title || 'Quest') : 'Quest';

    if (typeof showToast === 'function') showToast('👥 Generating Quest NPCs…', 'success');

    var bossCb = document.getElementById('bossMode');
    var raceSel = document.getElementById('raceSel');
    var classSel = document.getElementById('classSel');
    var lvlSel = document.getElementById('lvlSel');
    var prevBoss = bossCb ? bossCb.checked : false;
    var prevRace = raceSel ? raceSel.value : '';
    var prevClass = classSel ? classSel.value : '';
    var prevLvl = lvlSel ? lvlSel.value : '';
    var newNPCs = [];

    for (var b = 0; b < bossCount; b++) {
        if (bossCb) bossCb.checked = true;
        var bNPC = createNPC(true);
        bNPC.dmNotes = '⚔ Quest Boss for: "' + questTitle + '"';
        newNPCs.push(bNPC);
    }
    if (bossCb) bossCb.checked = false;
    for (var r = 0; r < regularCount; r++) {
        var rNPC = createNPC(false);
        rNPC.dmNotes = '📋 Quest NPC for: "' + questTitle + '"';
        newNPCs.push(rNPC);
    }
    if (bossCb) bossCb.checked = prevBoss;

    swBridgeGenNPCs(newNPCs, (bossCount + regularCount) + ' Quest NPCs');

    setTimeout(function() {
        var storyCtx = window._swCurrentStory || null;
        newNPCs.forEach(function(npc) {
            if (typeof _addToQuestNPCLog === 'function') _addToQuestNPCLog(npc, 'quest', questTitle, npc.isBoss, storyCtx);
        });
    }, 500);
}

/* ══ GENERATE LOCATION NPCs ══ */

var _locNPCProfiles = {
    tavern:           { count: [5,9], bossChance: 0.15, label: 'tavern staff, regulars, and travelers', classes:['Bard','Rogue','Fighter','Cleric'], races:['Human','Halfling','Dwarf'], roles:['Barkeep','Server','Patron','Card Shark','Mercenary'] },
    blacksmith:       { count: [2,4], bossChance: 0.08, label: 'smiths, apprentices, and customers', classes:['Fighter','Artificer','Ranger'], races:['Dwarf','Human','Half-Orc'], roles:['Master Smith','Apprentice','Courier','Guard'] },
    general_store:    { count: [3,6], bossChance: 0.1, label: 'shopkeepers, traders, and locals', classes:['Rogue','Bard','Cleric'], races:['Human','Halfling','Gnome'], roles:['Owner','Accountant','Traveler','Local Buyer'] },
    temple:           { count: [4,9], bossChance: 0.2, label: 'priests, devotees, and caretakers', classes:['Cleric','Paladin','Monk'], races:['Human','Elf','Aasimar'], roles:['High Priest','Acolyte','Pilgrim','Confessor'] },
    guild_hall:       { count: [5,10], bossChance: 0.22, label: 'guild members and envoys', classes:['Rogue','Fighter','Bard','Wizard'], races:['Human','Dwarf','Elf'], roles:['Guildmaster','Quartermaster','Contractor','Courier'] },
    market:           { count: [8,14], bossChance: 0.12, label: 'traders, buyers, and cutpurses', classes:['Rogue','Bard','Ranger'], races:['Human','Halfling','Tiefling'], roles:['Vendor','Porter','Pickpocket','Broker','Guard'] },
    library:          { count: [3,7], bossChance: 0.14, label: 'scholars, archivists, and seekers', classes:['Wizard','Cleric','Bard'], races:['Elf','Gnome','Human'], roles:['Archivist','Scribe','Researcher','Visitor'] },
    dungeon_entrance: { count: [4,8], bossChance: 0.45, label: 'guards, delvers, and denizens', classes:['Fighter','Ranger','Rogue','Warlock'], races:['Human','Dwarf','Half-Orc'], roles:['Gate Guard','Scout','Treasure Hunter','Cultist'] },
    noble_manor:      { count: [6,11], bossChance: 0.34, label: 'nobles, retainers, and household staff', classes:['Bard','Fighter','Rogue','Wizard'], races:['Human','Elf','Half-Elf'], roles:['Steward','Bodyguard','Noble','Servant'] },
    thieves_den:      { count: [5,10], bossChance: 0.4, label: 'rogues, fences, and informants', classes:['Rogue','Warlock','Bard'], races:['Human','Tiefling','Half-Elf'], roles:['Fence','Lookout','Enforcer','Informant'] },
    barracks:         { count: [8,14], bossChance: 0.25, label: 'soldiers, officers, and support', classes:['Fighter','Paladin','Ranger'], races:['Human','Dwarf','Half-Orc'], roles:['Sergeant','Recruit','Quartermaster','Medic'] },
    magic_shop:       { count: [3,6], bossChance: 0.32, label: 'mages, assistants, and rare buyers', classes:['Wizard','Sorcerer','Warlock','Bard'], races:['Elf','Gnome','Human'], roles:['Arcanist','Assistant','Collector','Bodyguard'] },
    docks:            { count: [6,12], bossChance: 0.18, label: 'sailors, laborers, and smugglers', classes:['Fighter','Rogue','Ranger'], races:['Human','Half-Orc','Dwarf'], roles:['Dockworker','Bosun','Smuggler','Harbormaster'] },
    graveyard:        { count: [2,5], bossChance: 0.35, label: 'keepers, mourners, and night visitors', classes:['Cleric','Warlock','Rogue'], races:['Human','Elf','Tiefling'], roles:['Groundskeeper','Mourner','Graverobber','Watcher'] },
    forest_clearing:  { count: [3,7], bossChance: 0.26, label: 'rangers, hunters, and wanderers', classes:['Ranger','Druid','Rogue'], races:['Elf','Human','Half-Elf'], roles:['Scout','Hunter','Hermit','Guide'] },
    cave:             { count: [3,8], bossChance: 0.5, label: 'denizens, outcasts, and raiders', classes:['Rogue','Warlock','Fighter','Barbarian'], races:['Half-Orc','Dwarf','Goblin'], roles:['Raider','Lookout','Exile','Cult Adept'] },
    ruins:            { count: [3,7], bossChance: 0.4, label: 'scavengers, wardens, and opportunists', classes:['Rogue','Wizard','Ranger','Cleric'], races:['Human','Elf','Tiefling'], roles:['Relic Hunter','Guide','Warden','Scholar'] }
};

function swGenerateLocationNPCs() {
    var loc     = window._swLastLoc;
    var locType = loc ? loc.type : null;
    var profile = (locType && _locNPCProfiles[locType]) || { count: [3,6], bossChance: 0.2, label: 'locals', classes:['Fighter','Rogue','Cleric'], races:['Human','Elf','Dwarf'], roles:['Local','Visitor','Worker'] };
    var min = profile.count[0], max = profile.count[1];
    var count = min + Math.floor(Math.random() * (max - min + 1));
    var locLabel = loc ? (loc.name || loc.type || 'location') : 'location';

    if (typeof showToast === 'function') showToast('👥 Generating ' + count + ' NPCs for ' + locLabel + '…', 'success');

    var bossCb = document.getElementById('bossMode');
    var raceSel = document.getElementById('raceSel');
    var classSel = document.getElementById('classSel');
    var lvlSel = document.getElementById('lvlSel');
    var prevBoss = bossCb ? bossCb.checked : false;
    var prevRace = raceSel ? raceSel.value : '';
    var prevClass = classSel ? classSel.value : '';
    var prevLvl = lvlSel ? lvlSel.value : '';
    var newNPCs = [];

    for (var i = 0; i < count; i++) {
        var isBoss = (i === 0 && Math.random() < profile.bossChance);
        var role = _swPick(profile.roles || ['Local']);
        if (classSel && Array.isArray(profile.classes) && profile.classes.length) classSel.value = _swPick(profile.classes) || '';
        if (raceSel && Array.isArray(profile.races) && profile.races.length) raceSel.value = _swPick(profile.races) || '';
        if (lvlSel) {
            var lv = isBoss ? (8 + Math.floor(Math.random() * 8)) : (1 + Math.floor(Math.random() * 7));
            lvlSel.value = String(lv);
        }
        if (bossCb) bossCb.checked = isBoss;
        var npc = createNPC(isBoss);
        npc.dmNotes = '📍 ' + (isBoss ? 'Notable figure' : 'Local') + ' at ' + locLabel
            + (loc && loc.type ? ' (' + loc.type.replace(/_/g,' ') + ')' : '')
            + '\nRole Group: ' + profile.label
            + '\nAssigned Role: ' + role;
        newNPCs.push(npc);
    }
    if (bossCb) bossCb.checked = prevBoss;
    if (raceSel) raceSel.value = prevRace;
    if (classSel) classSel.value = prevClass;
    if (lvlSel) lvlSel.value = prevLvl;

    swBridgeGenNPCs(newNPCs, count + ' Location NPCs');

    setTimeout(function() {
        newNPCs.forEach(function(npc) {
            if (typeof _addToQuestNPCLog === 'function') _addToQuestNPCLog(npc, 'location', locLabel, npc.isBoss, window._swCurrentStory || null);
        });
    }, 500);
}

function swGenerateLocationBattleMap() {
    if (!window._swLastLoc) {
        if (typeof showToast === 'function') showToast('Generate or load a location first', 'warning');
        return;
    }

    var outEl = document.getElementById('swLocOutput');
    if (!outEl) return;

    var mapArea = document.getElementById('swLocBattleMapArea');
    if (!mapArea) {
        mapArea = document.createElement('div');
        mapArea.id = 'swLocBattleMapArea';
        mapArea.style.marginTop = '14px';
        mapArea.innerHTML = '<div class="battlemap-section">'
            + '<div class="battlemap-header">Location Battle Map</div>'
            + '<div class="battlemap-canvas-wrap">'
            + '<canvas id="swLocMapCanvas" class="battlemap-canvas" width="640" height="480" onclick="swOpenLocationBattleMapPopup()" style="cursor:zoom-in;"></canvas>'
            + '</div>'
            + '<div id="swLocMapLegend" class="battlemap-legend"></div>'
            + '<button class="battlemap-btn" onclick="swGenerateLocationBattleMap()">Regenerate Map</button>'
            + '<button class="battlemap-btn" style="background:linear-gradient(145deg,#1a3a6a,#2a5ab0);" onclick="swPrintLocationBattleMap()">🖨 Print Battlemap</button>'
            + '<button class="battlemap-btn" style="background:linear-gradient(145deg,#1a3a6a,#2a5ab0);" onclick="swOpenLocationBattleMapPopup()">🔍 Open Map Popup</button>'
            + '</div>';
        outEl.appendChild(mapArea);
    }

    mapArea.style.display = 'block';
    var canvas = document.getElementById('swLocMapCanvas');
    if (!canvas) return;

    var locType = String(window._swLastLoc.type || '').toLowerCase();
    var themeKey = 'dungeon';
    if (locType === 'tavern') themeKey = 'tavern';
    else if (locType === 'temple') themeKey = 'temple';
    else if (locType === 'forest_clearing') themeKey = 'wilderness';
    else if (locType === 'docks') themeKey = 'sea';
    else if (locType === 'market' || locType === 'guild_hall' || locType === 'noble_manor' || locType === 'general_store' || locType === 'barracks') themeKey = 'city';
    else if (locType === 'cave') themeKey = 'cave';
    else if (locType === 'magic_shop') themeKey = 'planar';

    var theme = _MAP_THEMES[themeKey] || _getMapThemeFromQuest((window._swLastLoc.name || '') + ' ' + locType);
    var legend = _drawBattleMap(canvas, theme, window._swLastLoc.name || 'Location', false);
    var legendEl = document.getElementById('swLocMapLegend');
    if (legendEl && legend) {
        legendEl.innerHTML = legend.map(function(l) {
            return '<div class="battlemap-legend-item">'
                + '<div class="battlemap-legend-swatch" style="background:' + l.color + ';"></div>'
                + '<span>' + l.label + '</span>'
                + '</div>';
        }).join('');
    }

    try {
        window._swLastLocBattleMap = {
            title: window._swLastLoc.name || 'Location',
            dataUrl: canvas.toDataURL('image/png'),
            legend: legend || []
        };
    } catch(e) {}

    if (typeof showToast === 'function') showToast('Location battlemap generated!', 'success');
}

function swOpenLocationBattleMapPopup() {
    if (!window._swLastLocBattleMap || !window._swLastLocBattleMap.dataUrl) {
        swGenerateLocationBattleMap();
    }
    var map = window._swLastLocBattleMap;
    if (!map || !map.dataUrl) return;
    var legendHtml = (map.legend || []).map(function(l) {
        return '<div class="battlemap-legend-item" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);">'
            + '<div class="battlemap-legend-swatch" style="background:' + l.color + ';"></div>'
            + '<span>' + l.label + '</span>'
            + '</div>';
    }).join('');

    var body = '<div style="margin-bottom:10px;">'
        + '<img src="' + map.dataUrl + '" alt="Location Battlemap" style="width:100%;max-width:100%;border:2px solid rgba(184,134,11,0.4);border-radius:8px;display:block;cursor:zoom-in;" onclick="window.open(\'' + map.dataUrl + '\', \'_blank\')">'
        + '</div>'
        + '<div class="battlemap-legend" style="margin-bottom:10px;">' + legendHtml + '</div>'
        + '<div style="display:flex;gap:8px;flex-wrap:wrap;">'
        + '<button onclick="swGenerateLocationBattleMap();setTimeout(swOpenLocationBattleMapPopup,80);" style="padding:7px 12px;background:linear-gradient(145deg,#1f6f4a,#2e8b57);color:#d8ffe8;border:1px solid rgba(90,220,150,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;">🔄 Regenerate</button>'
        + '<button onclick="swPrintLocationBattleMap()" style="padding:7px 12px;background:linear-gradient(145deg,#1a3a6a,#2a5ab0);color:#d0e8ff;border:1px solid rgba(100,160,255,0.65);border-radius:6px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.78em;font-weight:700;">🖨 Print Battlemap</button>'
        + '</div>';

    openContentPopup('🗺 Battlemap — ' + (map.title || 'Location'), body, {});
}

function swPrintLocationBattleMap() {
    var map = window._swLastLocBattleMap;
    if (!map || !map.dataUrl) { if (typeof showToast === 'function') showToast('No location battlemap to print', 'warning'); return; }
    var win = window.open('', '_blank', 'width=900,height=700');
    if (!win) { if (typeof showToast === 'function') showToast('Popup blocked — allow popups to print', 'warning'); return; }
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Location Battlemap</title><style>'
        + 'body{margin:0;padding:18px;background:#111;color:#eee;font-family:serif;}img{width:100%;height:auto;border:2px solid #666;border-radius:8px;}h2{margin:0 0 12px 0;font-size:20px;}@media print{body{background:white;color:black;}img{border:1px solid #888;}}'
        + '</style></head><body><h2>🗺 ' + (map.title || 'Location Battlemap') + '</h2><img src="' + map.dataUrl + '" alt="Battlemap"></body></html>';
    win.document.write(html);
    win.document.close();
    setTimeout(function(){ win.focus(); win.print(); }, 500);
}

/* Init bounty/location UI on load */
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        _updateActiveBountyUI();
        _updateActiveLocationUI();
        swRenderSavedQuests();
        swRenderSavedBounties();
        swRenderQuestNPCsPanel();
    }, 300);
});

/* ══════════════════════════════════════════════════════════════
   HOOK INTO NPC GENERATION FUNCTIONS TO LOG QUEST CONTEXT
   (Quest and Location NPC logging is now built into swGenerateQuestNPCs
    and swGenerateLocationNPCs directly. Only revenge and story hooks remain.)
   ══════════════════════════════════════════════════════════════ */

/* ══════════════════════════════════════════════════════════════
   QUEST GENERATED NPC LOG SYSTEM
   Tracks all NPCs generated from quests, bounties, stories & locations
   with narrative context and dialog about their role in the story.
   ══════════════════════════════════════════════════════════════ */

var _questNPCLog = [];
try { _questNPCLog = JSON.parse(localStorage.getItem('dm_quest_npc_log') || '[]'); } catch(e) {}
var _swQuestNPCFilter = 'all';

function _saveQuestNPCLog() {
    try { localStorage.setItem('dm_quest_npc_log', JSON.stringify(_questNPCLog)); } catch(e){}
}

/* NPC narrative context generators */
var _npcQuestRoles = {
    quest: {
        boss: [
            'The primary antagonist driving this quest forward. Their motivations run deeper than the surface conflict — they believe they are justified.',
            'A powerful figure standing between the party and their goal. Defeating them ends this chapter, but their allies will remember.',
            'The architect of the threat the quest is built around. They have been preparing for this confrontation longer than the quest has existed.',
            'A veteran enemy who has survived encounters like this before. They will not underestimate the party a second time.'
        ],
        regular: [
            'A key figure in the quest who knows something the party needs — whether they will share it is another matter.',
            'An operative connected to the quest\'s central conflict. Their loyalty to their cause is genuine and should not be underestimated.',
            'Someone whose fate is tied to the quest\'s outcome. They have a personal stake in how this ends.',
            'A supporting character who complicates the quest\'s straightforward path. Nothing about their involvement is accidental.',
            'An NPC whose actions during this quest will have consequences beyond its resolution — for good or ill.',
            'A contact, obstacle, or witness whose role in the quest\'s story is still being determined by events.'
        ]
    },
    bounty: {
        boss: [
            'The primary bounty target — dangerous, resourceful, and aware they are being hunted. They have planned for this.',
            'A high-value target whose capture or elimination is the bounty\'s stated objective. The client has reasons they have not fully disclosed.',
            'The named subject of this bounty. Whatever they did to earn this price on their head, they are not going quietly.'
        ],
        regular: [
            'An associate of the bounty target — potentially an informant, ally, or unwilling accomplice.',
            'A witness or contact connected to the bounty\'s background. They know more than they\'ve been asked.',
            'Part of the network surrounding the bounty target. Their loyalty is for sale if the price is right.',
            'A complication attached to this bounty. The client did not mention them, which is itself informative.'
        ]
    },
    story: {
        boss: [
            'A major figure in the story\'s central conflict — powerful, driven, and deeply embedded in the narrative\'s core tension.',
            'The story\'s primary antagonist force given a face. Their goals and the story\'s themes are intertwined.',
            'A villain whose existence defines the story\'s stakes. Defeating them resolves one thread while pulling at several others.'
        ],
        regular: [
            'A character whose presence advances the story\'s plot in ways both obvious and subtle.',
            'Tied to the story\'s themes and setting in ways that will become clearer as the narrative develops.',
            'A named figure in the story\'s world whose choices will shape how this chapter ends.',
            'Part of the story\'s living world — their motivations exist independent of the party\'s arrival.',
            'A character the story has placed here for a reason. That reason may not be immediately apparent.',
            'Someone the story\'s events have brought to this point. The party\'s arrival changes what happens next.'
        ]
    },
    location: {
        boss: [
            'The dominant power in this location — their authority here is absolute, or was until recently.',
            'The figure this place revolves around, whether as protector, tyrant, or something more ambiguous.',
            'A powerful presence that defines what this location is. Understanding them means understanding the place.'
        ],
        regular: [
            'A regular of this location whose knowledge of it exceeds what they let on.',
            'Part of the fabric of this place — they have been here long enough to see things change.',
            'Someone who belongs here in a way the party does not, which is both a barrier and a resource.',
            'A fixture of this location whose cooperation (or opposition) will shape how the party moves through it.',
            'A person this place has made. Their character reflects where they are and what they do here.',
            'Present for reasons that seem mundane but may not be. Their connection to the location runs deeper than their role suggests.'
        ]
    }
};

function _getNPCStoryDialog(npc, sourceType, sourceName, isBoss, storyContext) {
    var rolePool = (_npcQuestRoles[sourceType] || _npcQuestRoles.quest)[isBoss ? 'boss' : 'regular'];
    var role = rolePool[Math.floor(Math.random() * rolePool.length)];

    var dialogs = {
        quest: [
            '"I didn\'t choose this fight. The quest brought it to my door."',
            '"There are two sides to every quest. I\'m on the other one."',
            '"Whatever the party was told about this quest — ask yourself who told them."',
            '"This ends when it ends. Not before."'
        ],
        bounty: [
            '"A price on my head means someone is afraid of what I know."',
            '"Bounties are just formalized disagreements between people with money and people without it."',
            '"The client who posted this bounty has their own reasons. I suggest you find out what they are."',
            '"I\'ve been hunted before. The hunters rarely understand the full picture."'
        ],
        story: [
            '"Every story needs someone to play this part. I\'m playing it."',
            '"The world was set in motion before the party arrived. I\'ve been here since the beginning."',
            '"I have my own story. The party is a chapter in it, not the other way around."',
            '"What happens here will matter later. I\'m certain of that, if nothing else."'
        ],
        location: [
            '"This place made me what I am. I know it better than I know myself."',
            '"Outsiders always think they understand a place after an hour. They don\'t."',
            '"I\'ve been here long enough to know what doesn\'t belong. Including, sometimes, myself."',
            '"Every location has a character. Mine is the person who fits here."'
        ]
    };

    var dialogPool = dialogs[sourceType] || dialogs.quest;
    var dialog = dialogPool[Math.floor(Math.random() * dialogPool.length)];

    var storyNote = '';
    if (storyContext && storyContext.title) {
        storyNote = ' Connected to the active story: <em>' + storyContext.title + '</em>.';
    }

    return { role: role, dialog: dialog, storyNote: storyNote };
}

function _addToQuestNPCLog(npc, sourceType, sourceName, isBoss, storyContext) {
    var context = _getNPCStoryDialog(npc, sourceType, sourceName, isBoss, storyContext);
    var entry = {
        id: 'qn_' + Date.now() + '_' + Math.floor(Math.random()*9999),
        npcId: npc.id || null,
        npcName: npc.name,
        npcRace: npc.race || 'Unknown',
        npcClass: npc.class || 'Unknown',
        npcLevel: npc.level || 1,
        isBoss: isBoss || false,
        sourceType: sourceType,   // 'quest' | 'bounty' | 'story' | 'location'
        sourceName: sourceName,
        role: context.role,
        dialog: context.dialog,
        storyNote: context.storyNote,
        date: new Date().toLocaleDateString(),
        npcSnapshot: npc   /* store full NPC object so View NPC works properly */
    };
    _questNPCLog.unshift(entry);
    // Keep last 60
    if (_questNPCLog.length > 60) _questNPCLog = _questNPCLog.slice(0, 60);
    _saveQuestNPCLog();
    swRenderQuestNPCsPanel();

    // Update badge count on tab
    var tabBtn = document.getElementById('swTab_questnpcs');
    if (tabBtn) {
        var count = _questNPCLog.length;
        tabBtn.textContent = '👥 Quest NPCs (' + count + ')';
    }
}

function swRenderQuestNPCsPanel() {
    var panel = document.getElementById('swQuestNPCsPanel');
    if (!panel) return;

    var list = _swQuestNPCFilter === 'all'
        ? _questNPCLog
        : _questNPCLog.filter(function(e){ return e.sourceType === _swQuestNPCFilter; });

    // Update tab badge
    var tabBtn = document.getElementById('swTab_questnpcs');
    if (tabBtn && _questNPCLog.length > 0) {
        tabBtn.textContent = '👥 Quest NPCs (' + _questNPCLog.length + ')';
    }

    if (!list.length) {
        panel.innerHTML = '<div style="color:rgba(255,255,255,0.25);font-style:italic;text-align:center;padding:30px;font-size:0.85em;">No quest NPCs ' + (_swQuestNPCFilter !== 'all' ? 'of type "' + _swQuestNPCFilter + '" ' : '') + 'generated yet.</div>';
        return;
    }

    var sourceColors = { quest:'#ff6060', bounty:'#daa520', story:'#a060ff', location:'#60c860' };
    var sourceIcons  = { quest:'⚔', bounty:'📌', story:'📖', location:'🏘' };

    panel.innerHTML = list.map(function(e) {
        var col = sourceColors[e.sourceType] || '#aaa';
        var icon = sourceIcons[e.sourceType] || '👤';
        var bossLabel = e.isBoss ? '<span style="background:#4a0080;color:#ffd700;padding:1px 6px;border-radius:4px;font-size:0.72em;font-weight:700;margin-left:4px;">BOSS</span>' : '';
        return '<div style="background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.08);border-left:3px solid ' + col + ';border-radius:6px;overflow:hidden;">'
            // Header row
            + '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(0,0,0,0.2);cursor:pointer;gap:8px;" onclick="swToggleQuestNPCEntry(\'' + e.id + '\')">'
            + '<div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">'
            + '<span style="font-size:1em;flex-shrink:0;">' + icon + '</span>'
            + '<div style="min-width:0;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.88em;font-weight:700;color:#fff8dc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + e.npcName + bossLabel + '</div>'
            + '<div style="font-size:0.72em;color:rgba(255,255,255,0.4);margin-top:2px;">' + e.npcRace + ' ' + e.npcClass + ' Lvl ' + e.npcLevel + ' · <span style="color:' + col + ';font-weight:700;text-transform:uppercase;">' + e.sourceType + '</span> · ' + (e.sourceName || 'Unknown Source') + '</div>'
            + '</div>'
            + '</div>'
            + '<div style="display:flex;gap:5px;flex-shrink:0;">'
            + '<button onclick="swViewQuestNPCFull(\'' + e.id + '\')" style="padding:3px 8px;background:rgba(184,134,11,0.3);color:#daa520;border:1px solid rgba(184,134,11,0.5);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;" title="Open NPC card in generator">👁 View NPC</button>'
            + '<button onclick="swDeleteQuestNPC(\'' + e.id + '\')" style="padding:3px 8px;background:rgba(80,0,0,0.4);color:rgba(255,120,120,0.8);border:1px solid rgba(139,0,0,0.4);border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;" title="Remove from log">✕</button>'
            + '</div>'
            + '</div>'
            // Expandable context body
            + '<div id="sqn_body_' + e.id + '" style="display:none;padding:12px 14px;border-top:1px solid rgba(255,255,255,0.06);">'
            + '<div style="background:rgba(184,134,11,0.08);border-left:3px solid ' + col + ';border-radius:0 4px 4px 0;padding:8px 12px;margin-bottom:10px;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;color:' + col + ';text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">📌 Role in ' + (e.sourceName || e.sourceType) + '</div>'
            + '<div style="font-size:0.85em;color:rgba(255,255,255,0.75);line-height:1.6;">' + e.role + (e.storyNote ? '<br><span style="color:rgba(160,100,255,0.8);font-style:italic;font-size:0.9em;">' + e.storyNote + '</span>' : '') + '</div>'
            + '</div>'
            + '<div style="background:rgba(0,0,0,0.25);border-radius:4px;padding:8px 12px;margin-bottom:10px;">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;color:rgba(255,248,220,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">💬 Characteristic Voice</div>'
            + '<div style="font-size:0.9em;color:rgba(255,248,200,0.85);font-style:italic;line-height:1.6;">' + e.dialog + '</div>'
            + '</div>'
            + '<div style="font-size:0.72em;color:rgba(255,255,255,0.25);text-align:right;">' + e.date + '</div>'
            + '</div>'
            + '</div>';
    }).join('');
}

function swToggleQuestNPCEntry(id) {
    var body = document.getElementById('sqn_body_' + id);
    if (body) body.style.display = (body.style.display === 'none') ? 'block' : 'none';
}

function swDeleteQuestNPC(id) {
    var idx = _questNPCLog.findIndex(function(e){ return e.id === id; });
    if (idx === -1) return;
    _questNPCLog.splice(idx, 1);
    _saveQuestNPCLog();
    swRenderQuestNPCsPanel();
}

function swClearQuestNPCLog() {
    if (!_questNPCLog.length) return;
    if (!confirm('Clear all quest NPC records? This cannot be undone.')) return;
    _questNPCLog = [];
    _saveQuestNPCLog();
    swRenderQuestNPCsPanel();
    var tabBtn = document.getElementById('swTab_questnpcs');
    if (tabBtn) tabBtn.textContent = '👥 Quest NPCs';
}

function swQuestNPCsFilter(type) {
    _swQuestNPCFilter = type;
    // Update filter button styles
    ['all','quest','bounty','story','location'].forEach(function(t) {
        var btn = document.getElementById('swQNFilter_' + t);
        if (!btn) return;
        if (t === type) {
            btn.style.opacity = '1';
            btn.style.boxShadow = '0 0 8px rgba(255,200,100,0.3)';
        } else {
            btn.style.opacity = '0.5';
            btn.style.boxShadow = 'none';
        }
    });
    swRenderQuestNPCsPanel();
}

/* View Quest NPC — restores the full NPC card in the generator display */
function swViewQuestNPCFull(id) {
    var entry = _questNPCLog.find(function(e){ return e.id === id; });
    if (!entry) return;

    var npc = entry.npcSnapshot;
    if (!npc || typeof npc.name === 'undefined') {
        if (typeof showToast === 'function') showToast('NPC data not available — try generating a new NPC', 'warning');
        return;
    }

    /* Give it a fresh unique id so it doesn't collide with anything */
    var viewNPC = Object.assign({}, npc, {
        id: 'view_' + Date.now(),
        dmNotes: (npc.dmNotes || '') + '\n\n📋 From Quest Log — ' + entry.sourceType.toUpperCase() + ': ' + (entry.sourceName || '') + '\nRole: ' + entry.role
    });

    /* Ensure required fields exist for renderNPC */
    if (!viewNPC.conditions) viewNPC.conditions = [];
    if (!viewNPC.spells) viewNPC.spells = viewNPC.spellList || [];
    if (!viewNPC.attacks) viewNPC.attacks = [];
    if (!viewNPC.inventory) viewNPC.inventory = [];
    if (viewNPC.isCombat === undefined) viewNPC.isCombat = false;
    if (viewNPC.initiative === undefined) viewNPC.initiative = null;
    if (viewNPC.legendaryResistances === undefined) viewNPC.legendaryResistances = viewNPC.isBoss ? 3 : 0;
    if (viewNPC.legendaryResistancesUsed === undefined) viewNPC.legendaryResistancesUsed = 0;
    if (viewNPC.legendaryActions === undefined) viewNPC.legendaryActions = viewNPC.isBoss ? 3 : 0;
    if (viewNPC.legendaryActionsUsed === undefined) viewNPC.legendaryActionsUsed = 0;
    if (!viewNPC.stats && (viewNPC.str !== undefined)) {
        viewNPC.stats = { STR: viewNPC.str, DEX: viewNPC.dex, CON: viewNPC.con, INT: viewNPC.int, WIS: viewNPC.wis, CHA: viewNPC.cha };
    }
    if (!viewNPC.hpMax) viewNPC.hpMax = viewNPC.hp || viewNPC.hpCurr || ((viewNPC.level || 1) * 8);
    if (!viewNPC.hpCurr) viewNPC.hpCurr = viewNPC.hpMax;

    swBridgeGenNPCs([viewNPC], entry.npcName + ' (Quest Log)');
}

function swClearStoryOutput() {
    if (!confirm('Clear the current story output?')) return;
    var outEl = document.getElementById('swStoryOutput');
    if (outEl) { outEl.style.display = 'none'; outEl.innerHTML = ''; }
    window._swCurrentStory = null;
    ['swEvolveBtn','swAddSceneBtn','swClearStoryBtn'].forEach(function(id){ var el=document.getElementById(id); if(el) el.style.display='none'; });
    var row2 = document.getElementById('swStoryActionRow2'); if(row2) row2.style.display='none';
    if (typeof showToast === 'function') showToast('Story cleared', 'success');
}

function swClearLocOutput() {
    if (!confirm('Clear the current location output?')) return;
    var outEl = document.getElementById('swLocOutput');
    if (outEl) { outEl.style.display = 'none'; outEl.innerHTML = ''; }
    window._swLastLoc = null;
    if (typeof showToast === 'function') showToast('Location cleared', 'success');
}

function swDeleteBountyCard(cardIdx, btnEl) {
    var cards = window._swLastBountyCards || [];
    var card = cards[cardIdx];
    var name = card ? (card.name || 'this bounty') : 'this bounty';
    if (!confirm('Remove bounty card for ' + name + '?')) return;

    /* Remove the exact clicked card first (most reliable). */
    var outEl = document.getElementById('swBountyOutput');
    var removed = false;
    if (btnEl) {
        var node = btnEl;
        while (node && node !== outEl) {
            if (node.getAttribute && node.getAttribute('data-bounty-idx') !== null) {
                node.remove();
                removed = true;
                break;
            }
            node = node.parentNode;
        }
    }

    /* Fallback by index selector if needed. */
    if (outEl) {
        if (!removed) {
            var selector = '[data-bounty-idx="' + cardIdx + '"]';
            var exactCardEl = outEl.querySelector(selector);
            if (exactCardEl) {
                exactCardEl.remove();
                removed = true;
            }
        }

        if (!removed) {
            var children = Array.from(outEl.children);
            if (children.length) {
                children[children.length - 1].remove();
                removed = true;
            }
        }

        if (!outEl.children.length) outEl.style.display = 'none';
    }

    /* Null out from array to preserve existing button indices for remaining cards */
    if (cards[cardIdx]) cards[cardIdx] = null;
    if (typeof showToast === 'function') showToast(removed ? 'Bounty card removed' : 'No bounty card found to remove', removed ? 'success' : 'warning');
}

function swPrintOutput(elementId) {
    var el = document.getElementById(elementId);
    if (!el) return;

    /* Clone the content and strip sticky bars so they don't appear in print */
    var clone = el.cloneNode(true);
    /* Remove sticky action bars */
    clone.querySelectorAll('[style*="sticky"]').forEach(function(bar){ bar.remove(); });
    /* Remove buttons */
    clone.querySelectorAll('button').forEach(function(btn){ btn.remove(); });

    var printHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">'
        + '<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">'
        + '<style>'
        + 'body { background: #1a1a2e; color: #e8dfc8; font-family: "Crimson Text", serif; margin: 0; padding: 20px; }'
        + '* { box-sizing: border-box; }'
        + '.print-header { font-family: "Cinzel", serif; color: #daa520; font-size: 1.1em; font-weight: 700; border-bottom: 2px solid #b8860b; padding-bottom: 8px; margin-bottom: 16px; letter-spacing: 2px; text-transform: uppercase; }'
        + '@media print { body { background: white !important; color: black !important; } * { color: black !important; background: transparent !important; border-color: #aaa !important; box-shadow: none !important; } }'
        + '</style>'
        + '</head><body>'
        + '<div class="print-header">✦ DM Helper — Printed Output</div>'
        + clone.innerHTML
        + '</body></html>';

    var win = window.open('', '_blank', 'width=900,height=700');
    if (!win) { if (typeof showToast === 'function') showToast('Popup blocked — allow popups to print', 'warning'); return; }
    win.document.write(printHtml);
    win.document.close();
    setTimeout(function(){ win.focus(); win.print(); }, 600);
}

function swPrintBountyCard(cardIdx) {
    var cards = window._swLastBountyCards || [];
    var card = cards[cardIdx];
    if (!card || !card.html) return;

    var printHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">'
        + '<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">'
        + '<style>'
        + 'body { background: #1a0800; color: #e8dfc8; font-family: "Crimson Text", serif; margin: 0; padding: 20px; }'
        + '* { box-sizing: border-box; }'
        + 'button { display: none !important; }'
        + '@media print { body { background: white !important; color: black !important; } * { color: black !important; background: transparent !important; border-color: #aaa !important; box-shadow: none !important; } }'
        + '</style>'
        + '</head><body>'
        + card.html
        + '</body></html>';

    var win = window.open('', '_blank', 'width=700,height=600');
    if (!win) { if (typeof showToast === 'function') showToast('Popup blocked — allow popups to print', 'warning'); return; }
    win.document.write(printHtml);
    win.document.close();
    setTimeout(function(){ win.focus(); win.print(); }, 600);
}

/* Story-linked NPC generation: when story link is active and NPCs are created,
   tag them with the story context and log them */
(function() {
    var _origCreateNPC = null;
    var _swStoryNPCInterceptEnabled = false;

    function _swBuildStoryLinkedQuestBlock(npc) {
        var s = window._swCurrentStory || null;
        if (!s) return '';
        var activeQuest = window._activeQuest || null;
        var activeLoc   = window._activeLocation || null;

        var antagonist = (s.antagonist || 'the story\'s antagonist');
        var goal = (s.goal || 'the story\'s central goal');
        var plot = (s.plot || 'the story\'s unfolding conflict');

        var tieArr = [
            'This NPC is a hinge-point in the current chapter: they can open one path and close another.',
            'This NPC knows something true but incomplete. What they omit is as important as what they say.',
            'This NPC is connected to the antagonist by history, debt, blood, or fear — and they\'re tired of it.',
            'This NPC is a lever the party can pull, but pulling it makes noise in the world.',
            'This NPC wants to help, but their help comes with terms the party may dislike.'
        ];
        var objectiveArr = [
            'Extract a name, place, or schedule from them without revealing what the party already suspects.',
            'Gain their cooperation for one scene: an introduction, a key, a distraction, or a map.',
            'Discover what they\'re hiding (a letter, an item, a relationship) before the antagonist retrieves it.',
            'Protect them from an immediate threat so they can deliver the information they promised.',
            'Turn them: convince them to betray the antagonist at a specific time and place.'
        ];
        var stakesArr = [
            'If the party fails, the antagonist gains time and the next location becomes harder to approach.',
            'If the party pushes too hard, this NPC shuts down or disappears — and the trail goes cold.',
            'Success creates a consequence: a rival faction notices the party\'s move and demands a cut.',
            'The party will have to choose between speed and secrecy; they cannot have both.',
            'The NPC\'s survival may depend on whether the party can leave no witnesses.'
        ];
        var rewardArr = [
            'Reward: a concrete lead (names + route + timing) and a token that proves legitimacy in the next scene.',
            'Reward: access — a door opens, a guard looks away, or an official record can be read without scrutiny.',
            'Reward: leverage — blackmail, proof, or a confession that can move a powerful person.',
            'Reward: gear — a single-use item, key, passphrase, or component needed for the next objective.',
            'Reward: safety — temporary protection from an organization that would otherwise hunt the party.'
        ];

        var activeLinkLine = '';
        if (activeQuest && (activeQuest.title || activeQuest.name)) {
            activeLinkLine = '<div style="margin-top:6px;"><strong>Related to Active Quest:</strong> ' + (activeQuest.title || activeQuest.name) + '</div>';
        }
        if (activeLoc && activeLoc.name) {
            activeLinkLine += '<div style="margin-top:4px;"><strong>Related to Active Location:</strong> ' + activeLoc.name + '</div>';
        }

        var tie = tieArr[Math.floor(Math.random() * tieArr.length)];
        var obj = objectiveArr[Math.floor(Math.random() * objectiveArr.length)];
        var stakes = stakesArr[Math.floor(Math.random() * stakesArr.length)];
        var reward = rewardArr[Math.floor(Math.random() * rewardArr.length)];

        return ''
            + '<div style="margin-bottom:10px;"><strong>Story:</strong> <em>' + (s.title || 'Active Story') + '</em></div>'
            + '<div style="margin-bottom:10px;"><strong>Why this NPC matters:</strong> ' + tie + '</div>'
            + '<div style="margin-bottom:10px;"><strong>Objective:</strong> ' + obj + '</div>'
            + '<div style="margin-bottom:10px;"><strong>Stakes:</strong> ' + stakes + '</div>'
            + '<div style="margin-bottom:10px;"><strong>Story connection:</strong> This scene points back to <em>' + antagonist + '</em> and pushes toward <em>' + goal + '</em>. The wider pressure is: ' + plot + '.</div>'
            + '<div style="margin-bottom:10px;"><strong>Reward:</strong> ' + reward + '</div>'
            + '<div style="padding:8px 10px;background:rgba(0,0,0,0.06);border:1px solid rgba(160,100,255,0.18);border-radius:6px;">'
            +   '<div style="font-family:\'Cinzel\',serif;font-size:0.7em;color:rgba(120,60,220,0.85);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">DM Notes</div>'
            +   '<div style="line-height:1.6;">Use this NPC to offer a choice: trust, threaten, trade, or protect. If the party befriends them, the antagonist retaliates indirectly. If the party harms them, the world becomes colder and more cautious.</div>'
            +   activeLinkLine
            + '</div>';
    }

    function _checkStoryLinkIntercept() {
        if (window._swStoryLinked && window._swCurrentStory && !_swStoryNPCInterceptEnabled) {
            if (typeof window.createNPC === 'function' && !window.createNPC._storyWrapped) {
                var _realCreate = window.createNPC;
                window.createNPC = function() {
                    var npc = _realCreate.apply(this, arguments);
                    if (npc && window._swStoryLinked && window._swCurrentStory) {
                        npc._storyLinked = true;
                        npc._storyTitle = window._swCurrentStory.title || 'Active Story';
                        npc._storyQuestHtml = _swBuildStoryLinkedQuestBlock(npc);
                        if (npc.quest && npc.quest.desc) {
                            npc.quest.desc = npc.quest.desc + ' This NPC was generated while Story Link was enabled and is connected to the active story: "' + (window._swCurrentStory.title || 'Active Story') + '".';
                        }
                        // Add to quest NPC log as a story-linked NPC
                        _addToQuestNPCLog(npc, 'story', window._swCurrentStory.title || 'Story', npc.isBoss, window._swCurrentStory);
                    }
                    return npc;
                };
                window.createNPC._storyWrapped = true;
                _swStoryNPCInterceptEnabled = true;
            }
        }
    }

    // Check periodically for story link activation
    setInterval(_checkStoryLinkIntercept, 2000);
})();

/* Hook: when swGenerateQuest produces NPCs via the existing generateRevengeQuestFromKilled override,
   ensure any generated revenge NPCs are also logged */
(function() {
    var _origGenRevengeNPCs = window._generateRevengeNPCs;
    window._generateRevengeNPCs = function(deadEntry) {
        if (_origGenRevengeNPCs) _origGenRevengeNPCs.apply(this, arguments);
        // Log revenge NPCs after generation
        setTimeout(function() {
            if (typeof window.generatedNPCs !== 'undefined' && window.generatedNPCs.length) {
                var title = deadEntry ? '☠ Revenge for ' + deadEntry.npcName : '☠ Revenge Quest';
                window.generatedNPCs.forEach(function(npc) {
                    if (npc._revengeNPC) {
                        _addToQuestNPCLog(npc, 'quest', title, npc.isBoss, null);
                    }
                });
            }
        }, 700);
    };
})();

/* Also add story context dialog to NPC cards when story link is active and NPC is generated */
(function() {
    function _injectStoryContextToCard(npcId) {
        if (!window._swStoryLinked || !window._swCurrentStory) return;
        var card = document.getElementById('card-' + npcId);
        if (!card || card.querySelector('.sw-story-context-badge')) return;
        var badge = document.createElement('div');
        badge.className = 'sw-story-context-badge';
        badge.style.cssText = 'background:rgba(100,0,180,0.15);border:1px solid rgba(160,100,255,0.4);border-radius:5px;padding:6px 10px;margin-top:10px;font-size:0.82em;font-family:\'Crimson Text\',serif;color:rgba(200,160,255,0.85);line-height:1.5;';
        badge.innerHTML = '<span style="font-family:\'Cinzel\',serif;font-size:0.7em;font-weight:700;color:#a060ff;text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:3px;">🔗 Story Linked</span>Generated as part of: <em>' + (window._swCurrentStory.title || 'Active Story') + '</em>';
        // Try to insert after quest section or at end of card
        var questSec = card.querySelector('.quest-section');
        if (questSec) questSec.insertAdjacentElement('afterend', badge);
        else card.appendChild(badge);
    }

    // Hook into renderAllNPCs to inject badges when story link is active
    var _origRenderAll = null;
    function _hookRenderAll() {
        if (typeof window.renderAllNPCs === 'function' && !window.renderAllNPCs._storyBadgeWrapped) {
            var _real = window.renderAllNPCs;
            window.renderAllNPCs = function() {
                _real.apply(this, arguments);
                if (window._swStoryLinked && window._swCurrentStory && typeof window.generatedNPCs !== 'undefined') {
                    setTimeout(function() {
                        window.generatedNPCs.forEach(function(n) { _injectStoryContextToCard(n.id); });
                    }, 200);
                }
            };
            window.renderAllNPCs._storyBadgeWrapped = true;
        }
    }
    setTimeout(_hookRenderAll, 1500);
})();

/* ══════════════════════════════════════════════════════════════
   PERFORMANCE HOTFIX: coalesce party rerenders into one frame
   ══════════════════════════════════════════════════════════════ */
window._partyUIRefreshRaf = 0;

window.renderPartyTracker = function() {
    var el = document.getElementById('partyMemberList');
    if (!el) return;
    if (!_party.length) {
        el.innerHTML = '<div style="color:rgba(184,134,11,0.45);font-size:0.83em;text-align:center;padding:12px 6px;line-height:1.5;">No players added.<br>Click <strong>+ Add Player</strong> to begin.</div>';
        return;
    }
    var partyHTML = _party.map(function(p) {
        var pct = Math.max(0, Math.min(100, Math.round(((p.hpCurr || 0) / (p.hpMax || 1)) * 100)));
        var barColor = pct <= 25 ? '#c0392b' : pct <= 50 ? '#e67e22' : '#27ae60';
        var fillCls = pct <= 25 ? 'critical' : pct <= 50 ? 'hurt' : '';
        var nemCount = (p.nemeses || []).length;
        var condStr = (p.conditions || []).length ? ' &nbsp;·&nbsp; <span style="color:#e74c3c;">' + p.conditions.join(', ') + '</span>' : '';
        var huntedStr = (p.isHunted && p.isHunted.length)
            ? '<div class="hunted-badge">☠ HUNTED — ' + p.isHunted.slice(0, 2).map(function(n){ return 'Allies of ' + n; }).join(', ') + (p.isHunted.length > 2 ? ' + more' : '') + '</div>'
            : '';
        return '<div class="party-member-row" title="Click to edit">'
            + '<div style="flex:1;min-width:0;cursor:pointer;" onclick="openPlayerSheet(\'' + p.id + '\')">'
            + '<div class="party-member-name">'
            + (p.name || 'Unnamed')
            + '<span style="font-weight:400;font-size:0.78em;color:var(--gold-light);">' + (p.cls || '') + ' ' + (p.level || 1) + '</span>'
            + (p.insp ? '<span style="color:#ffd700;font-size:0.78em;margin-left:4px;" title="Inspiration">&#9733;</span>' : '')
            + (nemCount ? '<span class="nemesis-badge-inline" title="' + nemCount + ' nemesis relationship(s)">NEMESIS x' + nemCount + '</span>' : '')
            + '</div>'
            + huntedStr
            + '<div class="party-hp-bar"><div class="party-hp-fill ' + fillCls + '" style="width:' + pct + '%;background:' + barColor + ';"></div></div>'
            + '<div style="font-size:0.72em;color:rgba(255,255,255,0.5);margin-top:2px;">'
            + '<span style="color:' + barColor + ';font-weight:700;">' + (p.hpCurr || 0) + '/' + (p.hpMax || 0) + ' HP</span>'
            + '&nbsp;·&nbsp; AC ' + (p.ac || 10) + condStr
            + '</div></div>'
            + '<div class="party-hp-controls" onclick="event.stopPropagation()">'
            + '<button style="padding:2px 7px;background:linear-gradient(145deg,var(--gold),#966f0a);color:white;border:none;border-radius:4px;cursor:pointer;font-family:\'Cinzel\',serif;font-size:0.65em;font-weight:700;white-space:nowrap;margin-bottom:3px;" onclick="openPlayerSheet(\'' + p.id + '\')">✏ Edit</button>'
            + '<div style="display:flex;gap:2px;">'
            + '<button class="party-hp-btn minus" onclick="quickHP(\'' + p.id + '\',-1)">&#8722;</button>'
            + '<button class="party-hp-btn plus" onclick="quickHP(\'' + p.id + '\',+1)">+</button>'
            + '<button class="party-hp-btn" onclick="removePartyMember(\'' + p.id + '\')" title="Remove player" style="background:var(--red);color:white;font-size:0.85em;padding:0 6px;margin-left:2px;">✕</button>'
            + '</div></div></div>';
    }).join('');
    el.innerHTML = '<div class="party-group-header">The Party &mdash; ' + _party.length + ' member' + (_party.length !== 1 ? 's' : '') + '</div>' + partyHTML;
};

window.refreshPartyUI = function() {
    if (typeof window.renderPartyTracker === 'function') window.renderPartyTracker();
    if (typeof window.lpRefreshParty === 'function') window.lpRefreshParty();
    if (typeof window.renderPartyHealthOverview === 'function') window.renderPartyHealthOverview();
    if (typeof window.renderHeaderPartyHealth === 'function') window.renderHeaderPartyHealth();
};

window.schedulePartyUIRefresh = function() {
    if (window._partyUIRefreshRaf) return;
    window._partyUIRefreshRaf = window.requestAnimationFrame(function() {
        window._partyUIRefreshRaf = 0;
        window.refreshPartyUI();
    });
};

window.quickHP = function(pid, dir) {
    var p = (_party || []).find(function(m){ return m.id === pid; });
    if (!p) return;
    p.hpCurr = Math.max(0, Math.min(p.hpMax || 1, (p.hpCurr || 0) + dir));
    _saveParty();
    window.schedulePartyUIRefresh();
};

/* Quick player info sheet from header name click */
window._playerQuickInfoPid = '';

window._pqEscapeHtml = function(v) {
    return String(v == null ? '' : v)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');
};

window.openPlayerQuickInfo = function(pid) {
    var p = (_party || []).find(function(m){ return m.id === pid; });
    if (!p) return;
    window._playerQuickInfoPid = pid;
    var modal = document.getElementById('playerQuickInfoModal');
    if (!modal) return;

    var hp = p.hpCurr || 0;
    var max = p.hpMax || 0;
    var ac = p.ac || 10;
    var cls = p.cls || 'Unknown Class';
    var lvl = p.level || 1;
    var race = p.race || 'Unknown Race';
    var spells = (Array.isArray(p.knownSpells) ? p.knownSpells : [])
        .map(function(s){ return (s && typeof s === 'object') ? (s.name || '') : String(s || ''); })
        .map(function(s){ return String(s).trim(); })
        .filter(Boolean);

    var titleEl = document.getElementById('pqInfoTitle');
    var subEl = document.getElementById('pqInfoSubtitle');
    var statsEl = document.getElementById('pqInfoStats');
    var listEl = document.getElementById('pqSpellList');
    var detailEl = document.getElementById('pqSpellDetail');

    if (titleEl) titleEl.textContent = p.name || 'Player';
    if (subEl) subEl.textContent = race + ' ' + cls + ' ' + lvl;
    if (statsEl) {
        statsEl.innerHTML = '<div style="display:flex;gap:10px;flex-wrap:wrap;">'
            + '<span style="padding:4px 10px;border-radius:999px;background:rgba(52,152,219,0.15);border:1px solid rgba(52,152,219,0.45);">AC ' + ac + '</span>'
            + '<span style="padding:4px 10px;border-radius:999px;background:rgba(39,174,96,0.15);border:1px solid rgba(39,174,96,0.45);">HP ' + hp + '/' + max + '</span>'
            + '<span style="padding:4px 10px;border-radius:999px;background:rgba(184,134,11,0.15);border:1px solid rgba(184,134,11,0.45);">Spells ' + spells.length + '</span>'
            + '</div>';
    }

    if (listEl) {
        if (!spells.length) {
            listEl.innerHTML = '<div style="color:rgba(255,255,255,0.5);font-style:italic;">No known spells saved for this player.</div>';
        } else {
            listEl.innerHTML = spells.map(function(name){
                var safeName = window._pqEscapeHtml(name);
                return '<button onclick="showPlayerQuickSpellDetail(decodeURIComponent(\'' + encodeURIComponent(name) + '\'))" '
                    + 'style="text-align:left;padding:7px 10px;background:rgba(52,152,219,0.1);border:1px solid rgba(52,152,219,0.35);color:#d6ebff;border-radius:6px;cursor:pointer;font-family:\'Crimson Text\',serif;font-size:0.95em;">'
                    + safeName
                    + '</button>';
            }).join('');
        }
    }

    if (detailEl) {
        detailEl.innerHTML = '<div style="color:rgba(255,255,255,0.55);font-style:italic;">Click a spell to view details.</div>';
    }

    modal.style.display = 'flex';
};

window.showPlayerQuickSpellDetail = function(spellName) {
    var detailEl = document.getElementById('pqSpellDetail');
    if (!detailEl) return;
    var name = String(spellName || '').trim();
    if (!name) return;

    var spells = (typeof _allSpells !== 'undefined' && Array.isArray(_allSpells)) ? _allSpells : (window._allSpells || []);
    var sp = spells.find(function(s){ return String((s && s.name) || '').toLowerCase() === name.toLowerCase(); }) || null;
    if (!sp) {
        detailEl.innerHTML = '<div style="font-family:\'Cinzel\',serif;color:#cfe6ff;font-weight:700;">' + window._pqEscapeHtml(name) + '</div>'
            + '<div style="color:rgba(255,255,255,0.6);margin-top:5px;">Spell details not found in loaded spell database.</div>';
        return;
    }

    var lvl = (typeof sp.level === 'number') ? sp.level : null;
    var lvlTxt = (lvl === 0) ? 'Cantrip' : (lvl != null ? ('Level ' + lvl) : 'Unknown level');
    var meta = [lvlTxt, sp.school || '', sp.castingTime || sp.casting_time || '', sp.range || '', sp.duration || '']
        .filter(Boolean)
        .join(' · ');
    var desc = sp.description || sp.desc || 'No description available.';

    detailEl.innerHTML = '<div style="font-family:\'Cinzel\',serif;color:#d6ebff;font-size:1.02em;font-weight:800;letter-spacing:0.4px;">' + window._pqEscapeHtml(sp.name || name) + '</div>'
        + '<div style="color:rgba(255,255,255,0.6);font-size:0.9em;margin-top:4px;">' + window._pqEscapeHtml(meta) + '</div>'
        + '<div style="color:rgba(255,255,255,0.82);line-height:1.6;margin-top:8px;">' + window._pqEscapeHtml(desc) + '</div>';
};

window.closePlayerQuickInfo = function() {
    var modal = document.getElementById('playerQuickInfoModal');
    if (!modal) return;
    modal.style.display = 'none';
};

/* Override header mini-cards so player name opens quick info sheet */
window.renderHeaderPlayerCards = function() {
    var el = document.getElementById('headerPlayerCards');
    if (!el) return;
    var party = window._party || [];
    if (!party.length) { el.innerHTML = ''; return; }
    el.innerHTML = party.map(function(p, idx) {
        var hp = p.hpCurr || 0;
        var maxhp = p.hpMax || 1;
        var ac = p.ac || 10;
        var pct = Math.max(0, Math.min(100, Math.round((hp / maxhp) * 100)));
        var col = pct <= 25 ? '#c0392b' : pct <= 50 ? '#e67e22' : '#27ae60';
        var bg = pct <= 25 ? 'rgba(139,0,0,0.25)' : pct <= 50 ? 'rgba(230,126,34,0.18)' : 'rgba(39,174,96,0.15)';
        var cls = p.cls || '';
        var lvl = p.level || 1;
        var conds = (p.conditions || []).length;
        var knownSpells = (Array.isArray(p.knownSpells) ? p.knownSpells : []).length;
        var insp = p.insp ? ' ★' : '';
        var pid = p.id;
        var safeName = (p.name || '?');

        return ''
            + '<div onclick="openPlayerSheet(\'' + pid + '\')" '
            + 'class="dm-reveal-item" '
            + 'title="Edit ' + safeName + '" '
            + 'style="animation-delay:' + (idx * 45) + 'ms;background:' + bg + ';border:1px solid ' + col + ';border-radius:7px;padding:5px 10px;cursor:pointer;min-width:88px;max-width:132px;transition:transform 0.15s,box-shadow 0.15s;flex-shrink:0;" '
            + 'onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 5px 14px rgba(0,0,0,0.45)\'" '
            + 'onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\'">'
            + '<div style="font-family:\'Cinzel\',serif;font-size:0.66em;font-weight:700;color:#fff8dc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'
            + '<button onclick="event.stopPropagation();openPlayerQuickInfo(\'' + pid + '\')" '
            + 'style="background:none;border:none;color:#fff8dc;cursor:pointer;font-family:\'Cinzel\',serif;font-size:1em;font-weight:800;padding:0;text-decoration:underline;text-underline-offset:2px;">'
            + safeName + insp
            + '</button>'
            + ' <span style="font-weight:700;color:rgba(255,255,255,0.55);">(AC ' + ac + ', ' + hp + '/' + maxhp + ')</span></div>'
            + '<div style="font-size:0.58em;color:rgba(255,255,255,0.48);margin-bottom:3px;">'
            + cls + (lvl ? ' ' + lvl : '')
            + (conds ? ' · <span style="color:#e74c3c;">' + conds + ' cond.</span>' : '')
            + '</div>'
            + '<div style="background:rgba(0,0,0,0.35);border-radius:3px;height:5px;overflow:hidden;margin-bottom:3px;">'
            + '<div style="height:100%;width:' + pct + '%;background:' + col + ';border-radius:3px;transition:width 0.4s;"></div>'
            + '</div>'
            + '<div style="display:flex;justify-content:space-between;align-items:center;">'
            + '<span style="font-size:0.62em;color:' + col + ';font-weight:700;">' + hp + '/' + maxhp + ' HP</span>'
            + '<div style="display:flex;gap:2px;" onclick="event.stopPropagation()">'
            + '<button onclick="quickHP(\'' + pid + '\',-1)" style="width:17px;height:17px;background:#c0392b;color:white;border:none;border-radius:3px;cursor:pointer;font-size:0.75em;font-weight:700;line-height:1;padding:0;">−</button>'
            + '<button onclick="quickHP(\'' + pid + '\',+1)" style="width:17px;height:17px;background:#27ae60;color:white;border:none;border-radius:3px;cursor:pointer;font-size:0.75em;font-weight:700;line-height:1;padding:0;">+</button>'
            + '</div></div>'
            + (knownSpells ? '<div style="font-size:0.57em;color:rgba(120,190,255,0.85);margin-top:2px;">✦ ' + knownSpells + ' spell' + (knownSpells !== 1 ? 's' : '') + '</div>' : '')
            + '</div>';
    }).join('');
};

window.dmApplyStaggerReveal = function(containerId, childSelector, stepMs) {
    var host = document.getElementById(containerId);
    if (!host) return;
    var items = host.querySelectorAll(childSelector || ':scope > *');
    if (!items || !items.length) return;
    var step = Math.max(20, Number(stepMs || 45));
    Array.prototype.forEach.call(items, function(el, idx) {
        el.classList.add('dm-reveal-item');
        el.style.animationDelay = (idx * step) + 'ms';
    });
};

window.dmModalEntrance = function(modalId) {
    var modal = document.getElementById(modalId);
    if (!modal || modal.style.display === 'none') return;
    var shell = modal.firstElementChild;
    if (!shell) return;
    shell.classList.remove('dm-reveal-item');
    void shell.offsetWidth;
    shell.classList.add('dm-reveal-item');
};

(function() {
    var _openPartyModal = window.openPartyModal;
    if (_openPartyModal) {
        window.openPartyModal = function() {
            _openPartyModal.apply(this, arguments);
            window.dmModalEntrance('partyModal');
            window.dmApplyStaggerReveal('partyMembersList', ':scope > *', 35);
        };
    }

    var _openLiveDMTools = window.openLiveDMTools;
    if (_openLiveDMTools) {
        window.openLiveDMTools = function() {
            _openLiveDMTools.apply(this, arguments);
            window.dmModalEntrance('liveDMToolsModal');
            window.dmApplyStaggerReveal('dmTurnOrderList', ':scope > *', 30);
        };
    }

    var _hbOpenManager = window.hbOpenManager;
    if (_hbOpenManager) {
        window.hbOpenManager = function() {
            _hbOpenManager.apply(this, arguments);
            window.dmModalEntrance('homebrewModal');
        };
    }

    var _dmRenderRoundTracker = window.dmRenderRoundTracker;
    if (_dmRenderRoundTracker) {
        window.dmRenderRoundTracker = function() {
            _dmRenderRoundTracker.apply(this, arguments);
            window.dmApplyStaggerReveal('dmTurnOrderList', ':scope > *', 24);
        };
    }
})();

/* Desktop-quality QoL helpers */
(function() {
    window._dmDesktopBuildInfo = null;

    function _isTypingTarget(el) {
        if (!el) return false;
        var tag = (el.tagName || '').toLowerCase();
        return tag === 'input' || tag === 'textarea' || el.isContentEditable;
    }

    window.addEventListener('keydown', function(e) {
        if (_isTypingTarget(document.activeElement)) return;

        /* Ctrl/Cmd + S => Save Campaign */
        if ((e.ctrlKey || e.metaKey) && String(e.key || '').toLowerCase() === 's') {
            e.preventDefault();
            if (typeof saveCurrentCampaign === 'function') saveCurrentCampaign();
            return;
        }

        /* Ctrl/Cmd + P => Open Players modal (app action, not browser print) */
        if ((e.ctrlKey || e.metaKey) && String(e.key || '').toLowerCase() === 'p') {
            e.preventDefault();
            if (typeof openPartyModal === 'function') openPartyModal();
            return;
        }

        /* Esc closes quick player info first */
        if (e.key === 'Escape') {
            var sm = document.getElementById('spellModal');
            if (sm && sm.classList.contains('active')) {
                if (typeof closeSpellModal === 'function') closeSpellModal();
                return;
            }

            var q = document.getElementById('playerQuickInfoModal');
            if (q && q.style.display === 'flex') {
                if (typeof closePlayerQuickInfo === 'function') closePlayerQuickInfo();
            }
        }
    }, true);

    /* If running in desktop wrapper, append app version to title and header badge. */
    if (window.desktopApp && typeof window.desktopApp.getVersion === 'function') {
        window.desktopApp.getVersion().then(function(v) {
            if (v) {
                document.title = 'DND DM Helper v' + v;
                var verEl = document.getElementById('dmHeaderVersion');
                if (verEl) verEl.textContent = 'v' + v;
            }
        }).catch(function(){});
    }

    if (window.desktopApp && typeof window.desktopApp.getBuildInfo === 'function') {
        window.desktopApp.getBuildInfo().then(function(info) {
            if (info && typeof info === 'object') window._dmDesktopBuildInfo = info;
        }).catch(function(){});
    }
})();

window.toggleDmHelpPanel = function() {
    var panel = document.getElementById('dmHelpPanel');
    if (!panel) return;
    var isOpen = panel.style.display === 'flex';
    panel.style.display = isOpen ? 'none' : 'flex';
    if (!isOpen) {
        var q = document.getElementById('dmHelpSearchInput');
        if (q) { q.value = ''; dmHelpFilter(); }
    }
};

window.closeDmHelpPanel = function() {
    var panel = document.getElementById('dmHelpPanel');
    if (panel) panel.style.display = 'none';
};

window.dmHelpFilter = function() {
    var q = (document.getElementById('dmHelpSearchInput') || {}).value;
    var term = (q || '').trim().toLowerCase();
    var sections = document.querySelectorAll('#dmHelpPanelBody .dm-help-section');
    sections.forEach(function(section) {
        var dataHelp = (section.getAttribute('data-help') || '').toLowerCase();
        var text = (section.innerText || section.textContent || '').toLowerCase();
        var show = !term || dataHelp.indexOf(term) !== -1 || text.indexOf(term) !== -1;
        section.style.display = show ? 'block' : 'none';
    });
};
</script>

<!-- ══ NPC GENERATOR POPUP MODAL ══ -->
<div id="npcGeneratorPopup" style="display:none;position:fixed;inset:0;z-index:20000;background:rgba(0,0,0,0.94);backdrop-filter:blur(8px);align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;">
    <div style="background:linear-gradient(145deg,#0f0f1f,#1a1a2e);border:2px solid var(--gold);border-radius:14px;width:900px;max-width:100%;box-shadow:0 20px 80px rgba(0,0,0,0.9),0 0 0 1px rgba(184,134,11,0.2);margin:auto;">
        <!-- Header -->
        <div style="background:linear-gradient(135deg,#1a0a0a,#2d0a0a,#3a0000);padding:16px 22px;display:flex;align-items:center;justify-content:space-between;border-radius:12px 12px 0 0;border-bottom:2px solid rgba(184,134,11,0.4);">
            <div>
                <div id="ngpTitle" style="font-family:'Cinzel',serif;font-size:1.1em;font-weight:700;color:#fff8dc;letter-spacing:2px;text-transform:uppercase;"></div>
                <div id="ngpSubtitle" style="font-family:'Crimson Text',serif;font-size:0.85em;color:rgba(255,200,120,0.6);margin-top:3px;font-style:italic;"></div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
                <button onclick="(function(){if(typeof switchMode==='function')switchMode('npc');_closeNPCPopup();})()" style="padding:7px 16px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff8dc;border:none;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;letter-spacing:0.5px;">⚔ Go to NPC Tab</button>
                <button onclick="_closeNPCPopup()" style="background:none;border:1px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.7);padding:6px 14px;border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.8em;">✕ Close</button>
            </div>
        </div>
        <!-- Body -->
        <div id="ngpBody" style="padding:22px;max-height:75vh;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--gold) #0f0f1f;display:flex;flex-direction:column;gap:20px;"></div>
    </div>
</div>

<div id="playerQuickInfoModal" onclick="if(event.target===this)closePlayerQuickInfo()" style="display:none;position:fixed;inset:0;z-index:22000;background:rgba(0,0,0,0.86);backdrop-filter:blur(5px);align-items:center;justify-content:center;padding:14px;">
    <div style="width:100%;max-width:760px;background:linear-gradient(145deg,#101a2d,#0b1422);border:2px solid rgba(184,134,11,0.55);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.75);overflow:hidden;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:linear-gradient(145deg,#13243f,#1b355e);border-bottom:1px solid rgba(184,134,11,0.35);">
            <div>
                <div id="pqInfoTitle" style="font-family:'Cinzel',serif;color:#fff8dc;font-size:1em;font-weight:800;letter-spacing:0.8px;"></div>
                <div id="pqInfoSubtitle" style="font-family:'Crimson Text',serif;color:rgba(255,255,255,0.65);font-size:0.9em;"></div>
            </div>
            <button onclick="closePlayerQuickInfo()" style="background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.3);color:#fff8dc;padding:5px 12px;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;">✕</button>
        </div>
        <div style="padding:14px;display:grid;grid-template-columns:1fr 1.25fr;gap:12px;">
            <div style="display:flex;flex-direction:column;gap:10px;">
                <div id="pqInfoStats" style="font-family:'Crimson Text',serif;color:#d6ebff;"></div>
                <div style="font-family:'Cinzel',serif;color:#9ecbff;font-size:0.78em;font-weight:800;letter-spacing:0.8px;text-transform:uppercase;">Known Spells</div>
                <div id="pqSpellList" style="display:flex;flex-direction:column;gap:7px;max-height:320px;overflow-y:auto;padding-right:4px;"></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <div style="font-family:'Cinzel',serif;color:#9ecbff;font-size:0.78em;font-weight:800;letter-spacing:0.8px;text-transform:uppercase;">Spell Details</div>
                <div id="pqSpellDetail" style="min-height:220px;background:rgba(0,0,0,0.24);border:1px solid rgba(52,152,219,0.3);border-radius:8px;padding:10px 12px;font-family:'Crimson Text',serif;"></div>
            </div>
        </div>
    </div>
</div>

<div style="position:fixed;left:12px;bottom:12px;z-index:24000;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
    <button type="button" onclick="openDMAIChat()" title="DM Assistant – ask rules, rulings, live play help" style="padding:8px 12px;background:linear-gradient(145deg,rgba(80,40,140,0.9),rgba(60,20,100,0.9));border:1px solid rgba(160,100,255,0.65);border-radius:8px;color:#e0c0ff;font-family:'Cinzel',serif;font-size:0.74em;font-weight:700;letter-spacing:0.8px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.45);">🤖 DM Assistant</button>
    <button id="dmHelpDockBtn" onclick="toggleDmHelpPanel()" style="padding:8px 12px;background:linear-gradient(145deg,#1b2d4a,#23406a);border:1px solid rgba(140,190,255,0.65);border-radius:8px;color:#d8ecff;font-family:'Cinzel',serif;font-size:0.74em;font-weight:700;letter-spacing:0.8px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.45);">❓ Help</button>
</div>
<div id="dmHelpPanel" style="display:none;position:fixed;left:12px;bottom:52px;z-index:24001;width:min(420px,92vw);max-width:420px;background:linear-gradient(145deg,#0d1a2e,#10233a);border:1px solid rgba(140,190,255,0.55);border-radius:10px;box-shadow:0 16px 36px rgba(0,0,0,0.55);overflow:hidden;flex-direction:column;max-height:85vh;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;background:rgba(0,0,0,0.28);border-bottom:1px solid rgba(140,190,255,0.3);flex-shrink:0;">
        <div style="font-family:'Cinzel',serif;color:#d8ecff;font-size:0.74em;font-weight:700;letter-spacing:1px;text-transform:uppercase;">DM Helper Guide</div>
        <button onclick="closeDmHelpPanel()" style="padding:3px 8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.25);border-radius:6px;color:#e8f2ff;font-family:'Cinzel',serif;font-size:0.64em;font-weight:700;cursor:pointer;">Close</button>
    </div>
    <div style="padding:8px 10px;border-bottom:1px solid rgba(140,190,255,0.2);flex-shrink:0;">
        <input type="text" id="dmHelpSearchInput" placeholder="Search help…" style="width:100%;padding:8px 10px;background:rgba(0,0,0,0.35);border:1px solid rgba(140,190,255,0.4);border-radius:6px;color:#e8f2ff;font-family:'Crimson Text',serif;font-size:0.88em;box-sizing:border-box;" oninput="dmHelpFilter()">
    </div>
    <div id="dmHelpPanelBody" style="padding:10px 12px;max-height:60vh;overflow-y:auto;overflow-x:hidden;font-family:'Crimson Text',serif;color:rgba(225,240,255,0.9);line-height:1.55;font-size:0.9em;">
        <div class="dm-help-section" data-help="bottom left ai help">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Bottom left</div>
            <div class="dm-help-text"><strong>DM Assistant</strong> — Click to open the AI chat panel (pops out above). Ask rules, rulings, or how to handle situations during play. Requires Ollama (Options → AI).</div>
            <div class="dm-help-text"><strong>Session timer</strong> — Set minutes, Start/Pause, Reset. Use <strong>Set</strong> to set the display to the minutes you entered.</div>
            <div class="dm-help-text"><strong>Help</strong> — This guide. Search above or scroll to find features.</div>
        </div>
        <div class="dm-help-section" data-help="players party">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Players (Party)</div>
            <div class="dm-help-text">Click <strong>Players</strong> in the header to open the party modal. Add/remove players, set HP, AC, max HP. Party health bars show in the header. Use <strong>Add Players to Initiative</strong> to add them to turn order.</div>
        </div>
        <div class="dm-help-section" data-help="npc generator">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">NPC Generator</div>
            <div class="dm-help-text">Build NPCs by race, class, level, quantity. Optional Boss (Legendary) mode. Track HP and conditions, run combat actions from tabs. Generated NPCs can be added to initiative.</div>
        </div>
        <div class="dm-help-section" data-help="story world quest location bounty revenge">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Story &amp; World Generator</div>
            <div class="dm-help-text"><strong>Story</strong> — Pick One-shot or Campaign, then generate a story (dropdowns) or use <strong>Generate story with AI</strong> with a prompt. Save and set as active story.</div>
            <div class="dm-help-text"><strong>Quests</strong> — Generate normal or boss quests; link to your active story. Save and load quests.</div>
            <div class="dm-help-text"><strong>Bounties</strong> — Generate bounty quests.</div>
            <div class="dm-help-text"><strong>Revenge Quest</strong> — Generate quests from killed NPCs.</div>
            <div class="dm-help-text"><strong>Locations</strong> — Generate locations; populate with NPCs.</div>
            <div class="dm-help-text"><strong>Quest NPCs</strong> — NPCs tied to quests, bounties, stories.</div>
        </div>
        <div class="dm-help-section" data-help="initiative turn order">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Initiative</div>
            <div class="dm-help-text">Add players (from party) and NPCs to initiative. Type or edit initiative numbers; order auto-sorts high to low. Use from Initiative panel or Live DM Tools.</div>
        </div>
        <div class="dm-help-section" data-help="live dm tools round encounter rules">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Live DM Tools</div>
            <div class="dm-help-text">Open from header <strong>Live DM Tools</strong>. <strong>Round tracker</strong> — advance turn/round, see order. <strong>Encounter</strong> — build encounters. <strong>Rules</strong> — quick reference. <strong>Backup</strong> — export/backup data.</div>
        </div>
        <div class="dm-help-section" data-help="main menu options">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Main Menu &amp; Options</div>
            <div class="dm-help-text"><strong>Main Menu</strong> — Return to start screen (save campaign first if needed).</div>
            <div class="dm-help-text"><strong>Options</strong> — Display (Dark/Light theme), AI (Ollama URL, model, install Ollama), About (version, updates).</div>
        </div>
        <div class="dm-help-section" data-help="homebrew import">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Import Homebrew</div>
            <div class="dm-help-text">Import homebrew content with preview and diagnostics before applying. Use from header.</div>
        </div>
        <div class="dm-help-section" data-help="campaign save load">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Campaign</div>
            <div class="dm-help-text">Campaign badge in header shows current campaign. <strong>Save</strong> to store state. Load/save campaigns from Main Menu or campaign flow.</div>
        </div>
        <div class="dm-help-section" data-help="ai ollama story generate">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">AI (Ollama)</div>
            <div class="dm-help-text">DM Assistant chat and Story generation use local Ollama. In <strong>Options → AI</strong> set the endpoint (default http://127.0.0.1:11434), install Ollama, and pull a model (e.g. llama2).</div>
        </div>
        <div class="dm-help-section" data-help="session notes">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Session Notes</div>
            <div class="dm-help-text">Session notes popout (if enabled) lets you keep notes during play.</div>
        </div>
        <div class="dm-help-section" data-help="print">
            <div class="dm-help-h2" style="color:#9ecbff;font-weight:700;margin:10px 0 6px;font-size:1em;">Print</div>
            <div class="dm-help-text">Many screens (story, quests, etc.) have a Print button to print the current output.</div>
        </div>
    </div>
</div>

<!-- ══ IN-GAME UPDATE BANNER ══ -->
<div id="inGameUpdateBanner" style="display:none;position:fixed;top:38px;right:16px;z-index:25000;width:360px;max-width:90vw;background:linear-gradient(145deg,#0d1a2e,#122240);border:2px solid rgba(46,204,113,0.6);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.7),0 0 20px rgba(46,204,113,0.1);overflow:hidden;animation:igUpdateSlideIn 0.4s ease-out;">
    <style>
        @keyframes igUpdateSlideIn { from { opacity:0; transform:translateX(60px); } to { opacity:1; transform:translateX(0); } }
        @keyframes igUpdatePulse { 0%,100% { box-shadow:0 0 8px rgba(46,204,113,0.3); } 50% { box-shadow:0 0 16px rgba(46,204,113,0.6); } }
    </style>
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:linear-gradient(135deg,rgba(46,204,113,0.2),rgba(46,120,200,0.15));border-bottom:1px solid rgba(46,204,113,0.3);">
        <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:1.2em;">⚔</span>
            <span style="font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;color:#a0e8a0;letter-spacing:1px;text-transform:uppercase;">Update Available</span>
        </div>
        <button onclick="dismissInGameUpdate()" style="background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:1.1em;padding:2px 6px;line-height:1;" title="Dismiss">✕</button>
    </div>
    <div style="padding:12px 14px;">
        <div id="igUpdateInfo" style="font-family:'Crimson Text',serif;font-size:0.9em;color:rgba(255,255,255,0.85);margin-bottom:10px;line-height:1.4;"></div>
        <div id="igUpdateActions" style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" id="igDownloadBtn" onclick="igStartDownload()" style="flex:1;padding:8px 14px;background:linear-gradient(145deg,rgba(46,120,200,0.4),rgba(46,80,180,0.5));border:1px solid rgba(100,160,255,0.5);color:#a0c8ff;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;letter-spacing:0.5px;animation:igUpdatePulse 2s infinite;">Download Now</button>
            <button type="button" id="igLaterBtn" onclick="dismissInGameUpdate()" style="padding:8px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.55);border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.78em;font-weight:700;">Later</button>
        </div>
        <div id="igUpdateProgress" style="display:none;margin-top:10px;">
            <div style="height:6px;background:rgba(0,0,0,0.4);border-radius:3px;overflow:hidden;">
                <div id="igProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#2e8b57,#3cb371);border-radius:3px;transition:width 0.3s;"></div>
            </div>
            <div id="igProgressText" style="font-family:'Crimson Text',serif;font-size:0.78em;color:rgba(255,255,255,0.55);margin-top:4px;"></div>
        </div>
        <div id="igRestartWrap" style="display:none;margin-top:10px;">
            <button type="button" onclick="igRestartInstall()" style="width:100%;padding:10px 14px;background:linear-gradient(145deg,rgba(46,204,113,0.35),rgba(46,180,100,0.45));border:1px solid rgba(80,220,120,0.6);color:#b8ffc0;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.82em;font-weight:700;letter-spacing:0.5px;animation:igUpdatePulse 2s infinite;">⚡ Restart & Install</button>
        </div>
    </div>
</div>

<script>
/* ═══════════════════════════════════════
   IN-GAME UPDATE BANNER — Logic
   ═══════════════════════════════════════ */
var _igUpdateVersion = '';

function showInGameUpdateBanner(version) {
    _igUpdateVersion = version || '';
    var banner = document.getElementById('inGameUpdateBanner');
    var info = document.getElementById('igUpdateInfo');
    var actions = document.getElementById('igUpdateActions');
    var progress = document.getElementById('igUpdateProgress');
    var restartWrap = document.getElementById('igRestartWrap');
    if (!banner) return;
    if (info) info.innerHTML = 'Version <strong style="color:#80e080;">' + version + '</strong> is ready. Download and install without leaving the app.';
    if (actions) actions.style.display = 'flex';
    if (progress) progress.style.display = 'none';
    if (restartWrap) restartWrap.style.display = 'none';
    var dlBtn = document.getElementById('igDownloadBtn');
    if (dlBtn) { dlBtn.disabled = false; dlBtn.style.animation = 'igUpdatePulse 2s infinite'; }
    banner.style.display = 'block';
}

function dismissInGameUpdate() {
    var banner = document.getElementById('inGameUpdateBanner');
    if (banner) banner.style.display = 'none';
}

function igStartDownload() {
    if (!window.desktopApp || typeof window.desktopApp.downloadUpdate !== 'function') return;
    var dlBtn = document.getElementById('igDownloadBtn');
    var laterBtn = document.getElementById('igLaterBtn');
    var progress = document.getElementById('igUpdateProgress');
    var bar = document.getElementById('igProgressBar');
    var text = document.getElementById('igProgressText');
    if (dlBtn) { dlBtn.disabled = true; dlBtn.textContent = 'Downloading…'; dlBtn.style.animation = 'none'; }
    if (laterBtn) laterBtn.style.display = 'none';
    if (progress) progress.style.display = 'block';
    if (bar) bar.style.width = '0%';
    if (text) text.textContent = 'Starting download…';
    window.desktopApp.downloadUpdate();
}

function igOnDownloadProgress(percent, bytesPerSecond) {
    var bar = document.getElementById('igProgressBar');
    var text = document.getElementById('igProgressText');
    var pct = Math.min(100, Math.round(percent || 0));
    if (bar) bar.style.width = pct + '%';
    if (text) {
        var speed = bytesPerSecond > 0 ? (bytesPerSecond / 1024 / 1024).toFixed(1) + ' MB/s' : '';
        text.textContent = 'Downloading… ' + pct + '%' + (speed ? ' · ' + speed : '');
    }
}

function igOnDownloaded() {
    var actions = document.getElementById('igUpdateActions');
    var progress = document.getElementById('igUpdateProgress');
    var bar = document.getElementById('igProgressBar');
    var text = document.getElementById('igProgressText');
    var restartWrap = document.getElementById('igRestartWrap');
    if (actions) actions.style.display = 'none';
    if (bar) bar.style.width = '100%';
    if (text) text.textContent = 'Download complete!';
    if (restartWrap) restartWrap.style.display = 'block';
}

function igRestartInstall() {
    if (window.desktopApp && typeof window.desktopApp.quitAndInstall === 'function') {
        window.desktopApp.quitAndInstall();
    }
}
</script>

<script>
/* ═══════════════════════════════════════
   WHAT'S NEW — Changelog & Version Check
   ═══════════════════════════════════════ */
var APP_CHANGELOG = {
    "1.0.2": [
        "Fixed update system - releases now publish correctly",
        "Added in-game update banner"
    ],
    "1.0.1": [
        "Bug fixes and improvements"
    ],
    "1.0.1": [
        "Auto-update now correctly checks GitHub for new releases",
        "Homebrew items now appear in NPC loot generation",
        "Added What's New popup after updates"
    ],
    "1.0.0": [
        "Initial release of Real DND DM Helper",
        "Full NPC generation with race, class, level, and boss mode",
        "Story & World generator with AI support (Ollama)",
        "Live DM Tools: initiative tracker, encounter builder, round tracker",
        "Homebrew import system with preview and diagnostics",
        "Shopkeeper generation with 18 shop types",
        "Bounty board system",
        "Campaign save/load",
        "Player party tracking with HP and conditions"
    ]
};

function getWhatsNewHTML(version) {
    var entries = APP_CHANGELOG[version];
    if (!entries || !entries.length) {
        return '<p style="color:rgba(255,255,255,0.6);font-style:italic;">No detailed changelog for this version.</p>';
    }
    var html = '<ul style="margin:0;padding-left:20px;list-style:none;">';
    for (var i = 0; i < entries.length; i++) {
        html += '<li style="margin-bottom:10px;padding-left:8px;position:relative;">'
              + '<span style="position:absolute;left:-14px;color:var(--gold);">&#9830;</span>'
              + entries[i]
              + '</li>';
    }
    html += '</ul>';
    return html;
}

function showWhatsNew(version) {
    var modal = document.getElementById('whatsNewModal');
    var verEl = document.getElementById('whatsNewVersion');
    var bodyEl = document.getElementById('whatsNewBody');
    if (!modal || !bodyEl) return;
    if (verEl) verEl.textContent = 'Version ' + version;
    bodyEl.innerHTML = getWhatsNewHTML(version);
    modal.style.display = 'flex';
}

function closeWhatsNew() {
    var modal = document.getElementById('whatsNewModal');
    if (modal) modal.style.display = 'none';
}

function checkWhatsNew() {
    if (!window.desktopApp || typeof window.desktopApp.getVersion !== 'function') return;
    window.desktopApp.getVersion().then(function(currentVersion) {
        if (!currentVersion) return;
        var lastSeenVersion = localStorage.getItem('dm_last_seen_version') || '';
        if (lastSeenVersion !== currentVersion) {
            localStorage.setItem('dm_last_seen_version', currentVersion);
            if (lastSeenVersion) {
                setTimeout(function() { showWhatsNew(currentVersion); }, 1500);
            }
        }
    }).catch(function(){});
}

checkWhatsNew();
</script>

<!-- ══ WHAT'S NEW POPUP ══ -->
<div id="whatsNewModal" onclick="if(event.target===this)closeWhatsNew()" style="display:none;position:fixed;inset:0;z-index:30000;background:rgba(0,0,0,0.92);backdrop-filter:blur(10px);align-items:center;justify-content:center;padding:20px;">
    <div style="width:560px;max-width:95vw;max-height:85vh;background:linear-gradient(145deg,#0f0f1f,#1a1a2e);border:2px solid var(--gold);border-radius:14px;box-shadow:0 20px 80px rgba(0,0,0,0.9),0 0 40px rgba(184,134,11,0.15);display:flex;flex-direction:column;overflow:hidden;">
        <div style="background:linear-gradient(135deg,#1a0a2e,#2d1050,#1a0a2e);padding:20px 24px;border-bottom:2px solid rgba(184,134,11,0.4);text-align:center;">
            <div style="font-family:'Cinzel',serif;font-size:1.3em;font-weight:700;color:#fff8dc;letter-spacing:3px;text-transform:uppercase;">What's New</div>
            <div id="whatsNewVersion" style="font-family:'Crimson Text',serif;font-size:0.95em;color:rgba(255,200,120,0.7);margin-top:4px;"></div>
        </div>
        <div id="whatsNewBody" style="padding:20px 24px;overflow-y:auto;flex:1;scrollbar-width:thin;scrollbar-color:var(--gold) #0f0f1f;font-family:'Crimson Text',serif;color:rgba(255,255,255,0.88);line-height:1.65;font-size:0.95em;"></div>
        <div style="padding:14px 24px;border-top:1px solid rgba(184,134,11,0.3);text-align:center;">
            <button onclick="closeWhatsNew()" style="padding:10px 36px;background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff8dc;border:none;border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:0.9em;font-weight:700;letter-spacing:1px;box-shadow:0 4px 12px rgba(0,0,0,0.4);">Continue</button>
        </div>
    </div>
</div>

</body></html>
